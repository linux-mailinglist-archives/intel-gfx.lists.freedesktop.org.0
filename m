Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id A3DE4C22F8
	for <lists+intel-gfx@lfdr.de>; Mon, 30 Sep 2019 16:16:06 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id BE2BE6E44D;
	Mon, 30 Sep 2019 14:16:03 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 6A1EB6E44D
 for <intel-gfx@lists.freedesktop.org>; Mon, 30 Sep 2019 14:16:02 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18668164-1500050 
 for multiple; Mon, 30 Sep 2019 15:15:28 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 30 Sep 2019 15:15:22 +0100
Message-Id: <20190930141522.9319-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20190930113106.27596-1-chris@chris-wilson.co.uk>
References: <20190930113106.27596-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v3] drm/i915/selftests: Exercise context
 switching in parallel
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

V2UgY3VycmVudGx5IHRlc3QgY29udGV4dCBzd2l0Y2hpbmcgb24gZWFjaCBlbmdpbmUgYXMgYSBi
YXNpYyBzdHJlc3MKdGVzdCAoanVzdCB2ZXJpZnlpbmcgdGhhdCBub3RoaW5nIGV4cGxvZGVzIGlm
IHdlIGV4ZWN1dGUgMiByZXF1ZXN0cyBmcm9tCmRpZmZlcmVudCBjb250ZXh0cyBzZXF1ZW50aWFs
bHkpLiBXaGF0IHdlIGhhdmUgbm90IHRlc3RlZCBpcyB3aGF0CmhhcHBlbnMgaWYgd2UgdHJ5IGFu
ZCBkbyBzbyBvbiBhbGwgYXZhaWxhYmxlIGVuZ2luZXMgc2ltdWx0YW5lb3VzbHksCnB1dHRpbmcg
b3VyIFNXIGFuZCB0aGUgSFcgdW5kZXIgdGhlIG1heGltYWwgc3RyZXNzLgoKdjI6IENsb25lIHRo
ZSBzZXQgb2YgZW5naW5lcyBmcm9tIHRoZSBmaXJzdCBjb250ZXh0IGludG8gdGhlIHNlY29uZGFy
eQpjb250ZXh0cy4KClNpZ25lZC1vZmYtYnk6IENocmlzIFdpbHNvbiA8Y2hyaXNAY2hyaXMtd2ls
c29uLmNvLnVrPgpDYzogTWlrYSBLdW9wcGFsYSA8bWlrYS5rdW9wcGFsYUBsaW51eC5pbnRlbC5j
b20+CkNjOiBUdnJ0a28gVXJzdWxpbiA8dHZydGtvLnVyc3VsaW5AaW50ZWwuY29tPgotLS0KIC4u
Li9kcm0vaTkxNS9nZW0vc2VsZnRlc3RzL2k5MTVfZ2VtX2NvbnRleHQuYyB8IDIzOCArKysrKysr
KysrKysrKysrKysKIDEgZmlsZSBjaGFuZ2VkLCAyMzggaW5zZXJ0aW9ucygrKQoKZGlmZiAtLWdp
dCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMvaTkxNV9nZW1fY29udGV4dC5j
IGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL3NlbGZ0ZXN0cy9pOTE1X2dlbV9jb250ZXh0LmMK
aW5kZXggZGMyNWJjYzNlMzcyLi5jMjIxZWQ1MzYyMGYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMvaTkxNV9nZW1fY29udGV4dC5jCisrKyBiL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMvaTkxNV9nZW1fY29udGV4dC5jCkBAIC0xNTYsNiAr
MTU2LDI0MyBAQCBzdGF0aWMgaW50IGxpdmVfbm9wX3N3aXRjaCh2b2lkICphcmcpCiAJcmV0dXJu
IGVycjsKIH0KIAorc3RydWN0IHBhcmFsbGVsX3N3aXRjaCB7CisJc3RydWN0IHRhc2tfc3RydWN0
ICp0c2s7CisJc3RydWN0IGludGVsX2NvbnRleHQgKmNlWzJdOworfTsKKworc3RhdGljIGludCBf
X2xpdmVfcGFyYWxsZWxfc3dpdGNoMSh2b2lkICpkYXRhKQoreworCXN0cnVjdCBwYXJhbGxlbF9z
d2l0Y2ggKmFyZyA9IGRhdGE7CisJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUgPSBhcmct
PmNlWzBdLT5lbmdpbmUtPmk5MTU7CisJSUdUX1RJTUVPVVQoZW5kX3RpbWUpOworCXVuc2lnbmVk
IGxvbmcgY291bnQ7CisKKwljb3VudCA9IDA7CisJZG8geworCQlzdHJ1Y3QgaTkxNV9yZXF1ZXN0
ICpycTsKKwkJaW50IGVycjsKKworCQltdXRleF9sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4
KTsKKwkJcnEgPSBpOTE1X3JlcXVlc3RfY3JlYXRlKGFyZy0+Y2VbMF0pOworCQlpZiAoSVNfRVJS
KHJxKSkgeworCQkJbXV0ZXhfdW5sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKKwkJCXJl
dHVybiBQVFJfRVJSKHJxKTsKKwkJfQorCisJCWk5MTVfcmVxdWVzdF9hZGQocnEpOworCQltdXRl
eF91bmxvY2soJmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOworCisJCW11dGV4X2xvY2soJmk5MTUt
PmRybS5zdHJ1Y3RfbXV0ZXgpOworCQlycSA9IGk5MTVfcmVxdWVzdF9jcmVhdGUoYXJnLT5jZVsx
XSk7CisJCWlmIChJU19FUlIocnEpKSB7CisJCQltdXRleF91bmxvY2soJmk5MTUtPmRybS5zdHJ1
Y3RfbXV0ZXgpOworCQkJcmV0dXJuIFBUUl9FUlIocnEpOworCQl9CisKKwkJaTkxNV9yZXF1ZXN0
X2dldChycSk7CisJCWk5MTVfcmVxdWVzdF9hZGQocnEpOworCQltdXRleF91bmxvY2soJmk5MTUt
PmRybS5zdHJ1Y3RfbXV0ZXgpOworCisJCWVyciA9IDA7CisJCWlmIChpOTE1X3JlcXVlc3Rfd2Fp
dChycSwgMCwgSFogLyA1KSA8IDApCisJCQllcnIgPSAtRVRJTUU7CisJCWk5MTVfcmVxdWVzdF9w
dXQocnEpOworCQlpZiAoZXJyKQorCQkJcmV0dXJuIGVycjsKKworCQljb3VudCsrOworCX0gd2hp
bGUgKCFfX2lndF90aW1lb3V0KGVuZF90aW1lLCBOVUxMKSk7CisKKwlwcl9pbmZvKCIlczogJWx1
IHN3aXRjaGVzIChzeW5jKVxuIiwgYXJnLT5jZVswXS0+ZW5naW5lLT5uYW1lLCBjb3VudCk7CisJ
cmV0dXJuIDA7Cit9CisKK3N0YXRpYyBpbnQgX19saXZlX3BhcmFsbGVsX3N3aXRjaE4odm9pZCAq
ZGF0YSkKK3sKKwlzdHJ1Y3QgcGFyYWxsZWxfc3dpdGNoICphcmcgPSBkYXRhOworCXN0cnVjdCBk
cm1faTkxNV9wcml2YXRlICppOTE1ID0gYXJnLT5jZVswXS0+ZW5naW5lLT5pOTE1OworCUlHVF9U
SU1FT1VUKGVuZF90aW1lKTsKKwl1bnNpZ25lZCBsb25nIGNvdW50OworCisJY291bnQgPSAwOwor
CWRvIHsKKwkJc3RydWN0IGk5MTVfcmVxdWVzdCAqcnE7CisKKwkJbXV0ZXhfbG9jaygmaTkxNS0+
ZHJtLnN0cnVjdF9tdXRleCk7CisJCXJxID0gaTkxNV9yZXF1ZXN0X2NyZWF0ZShhcmctPmNlWzBd
KTsKKwkJaWYgKElTX0VSUihycSkpIHsKKwkJCW11dGV4X3VubG9jaygmaTkxNS0+ZHJtLnN0cnVj
dF9tdXRleCk7CisJCQlyZXR1cm4gUFRSX0VSUihycSk7CisJCX0KKworCQlpOTE1X3JlcXVlc3Rf
YWRkKHJxKTsKKwkJbXV0ZXhfdW5sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKKworCQlt
dXRleF9sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKKwkJcnEgPSBpOTE1X3JlcXVlc3Rf
Y3JlYXRlKGFyZy0+Y2VbMV0pOworCQlpZiAoSVNfRVJSKHJxKSkgeworCQkJbXV0ZXhfdW5sb2Nr
KCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKKwkJCXJldHVybiBQVFJfRVJSKHJxKTsKKwkJfQor
CisJCWk5MTVfcmVxdWVzdF9hZGQocnEpOworCQltdXRleF91bmxvY2soJmk5MTUtPmRybS5zdHJ1
Y3RfbXV0ZXgpOworCisJCWNvdW50Kys7CisJfSB3aGlsZSAoIV9faWd0X3RpbWVvdXQoZW5kX3Rp
bWUsIE5VTEwpKTsKKworCXByX2luZm8oIiVzOiAlbHUgc3dpdGNoZXMgKG1hbnkpXG4iLCBhcmct
PmNlWzBdLT5lbmdpbmUtPm5hbWUsIGNvdW50KTsKKwlyZXR1cm4gMDsKK30KKworc3RhdGljIGlu
dCBsaXZlX3BhcmFsbGVsX3N3aXRjaCh2b2lkICphcmcpCit7CisJc3RydWN0IGRybV9pOTE1X3By
aXZhdGUgKmk5MTUgPSBhcmc7CisJc3RhdGljIGludCAoKiBjb25zdCBmdW5jW10pKHZvaWQgKmFy
ZykgPSB7CisJCV9fbGl2ZV9wYXJhbGxlbF9zd2l0Y2gxLAorCQlfX2xpdmVfcGFyYWxsZWxfc3dp
dGNoTiwKKwkJTlVMTCwKKwl9OworCXN0cnVjdCBpOTE1X2dlbV9lbmdpbmVzICplbmdpbmVzOwor
CXN0cnVjdCBpOTE1X2dlbV9lbmdpbmVzX2l0ZXIgaXQ7CisJaW50ICgqIGNvbnN0ICpmbikodm9p
ZCAqYXJnKTsKKwlzdHJ1Y3QgcGFyYWxsZWxfc3dpdGNoICpkYXRhOworCXN0cnVjdCBpOTE1X2dl
bV9jb250ZXh0ICpjdHg7CisJc3RydWN0IGludGVsX2NvbnRleHQgKmNlOworCXN0cnVjdCBkcm1f
ZmlsZSAqZmlsZTsKKwlpbnQgbiwgbSwgY291bnQ7CisJaW50IGVyciA9IDA7CisKKwkvKgorCSAq
IENoZWNrIHdlIGNhbiBwcm9jZXNzIHN3aXRjaGVzIG9uIGFsbCBlbmdpbmVzIHNpbXVsdGFuZW91
c2x5LgorCSAqLworCisJaWYgKCFEUklWRVJfQ0FQUyhpOTE1KS0+aGFzX2xvZ2ljYWxfY29udGV4
dHMpCisJCXJldHVybiAwOworCisJZmlsZSA9IG1vY2tfZmlsZShpOTE1KTsKKwlpZiAoSVNfRVJS
KGZpbGUpKQorCQlyZXR1cm4gUFRSX0VSUihmaWxlKTsKKworCW11dGV4X2xvY2soJmk5MTUtPmRy
bS5zdHJ1Y3RfbXV0ZXgpOworCisJY3R4ID0gbGl2ZV9jb250ZXh0KGk5MTUsIGZpbGUpOworCWlm
IChJU19FUlIoY3R4KSkgeworCQllcnIgPSBQVFJfRVJSKGN0eCk7CisJCWdvdG8gb3V0X2xvY2tl
ZDsKKwl9CisKKwllbmdpbmVzID0gaTkxNV9nZW1fY29udGV4dF9sb2NrX2VuZ2luZXMoY3R4KTsK
Kwljb3VudCA9IGVuZ2luZXMtPm51bV9lbmdpbmVzOworCisJZGF0YSA9IGtjYWxsb2MoY291bnQs
IHNpemVvZigqZGF0YSksIEdGUF9LRVJORUwpOworCWlmICghZGF0YSkgeworCQlpOTE1X2dlbV9j
b250ZXh0X3VubG9ja19lbmdpbmVzKGN0eCk7CisJCWVyciA9IC1FTk9NRU07CisJCWdvdG8gb3V0
X2xvY2tlZDsKKwl9CisKKwltID0gMDsgLyogVXNlIHRoZSBmaXJzdCBjb250ZXh0IGFzIG91ciB0
ZW1wbGF0ZSBmb3IgdGhlIGVuZ2luZXMgKi8KKwlmb3JfZWFjaF9nZW1fZW5naW5lKGNlLCBlbmdp
bmVzLCBpdCkgeworCQllcnIgPSBpbnRlbF9jb250ZXh0X3BpbihjZSk7CisJCWlmIChlcnIpIHsK
KwkJCWk5MTVfZ2VtX2NvbnRleHRfdW5sb2NrX2VuZ2luZXMoY3R4KTsKKwkJCWdvdG8gb3V0X2xv
Y2tlZDsKKwkJfQorCQlkYXRhW20rK10uY2VbMF0gPSBpbnRlbF9jb250ZXh0X2dldChjZSk7CisJ
fQorCWk5MTVfZ2VtX2NvbnRleHRfdW5sb2NrX2VuZ2luZXMoY3R4KTsKKworCS8qIENsb25lIHRo
ZSBzYW1lIHNldCBvZiBlbmdpbmVzIGluIHRoZSBvdGhlciBjb250ZXh0cyAqLworCWZvciAobiA9
IDE7IG4gPCBBUlJBWV9TSVpFKGRhdGEtPmNlKTsgbisrKSB7CisJCWN0eCA9IGxpdmVfY29udGV4
dChpOTE1LCBmaWxlKTsKKwkJaWYgKElTX0VSUihjdHgpKSB7CisJCQllcnIgPSBQVFJfRVJSKGN0
eCk7CisJCQlnb3RvIG91dF9sb2NrZWQ7CisJCX0KKworCQlmb3IgKG0gPSAwOyBtIDwgY291bnQ7
IG0rKykgeworCQkJaWYgKCFkYXRhW21dLmNlWzBdKQorCQkJCWNvbnRpbnVlOworCisJCQljZSA9
IGludGVsX2NvbnRleHRfY3JlYXRlKGN0eCwgZGF0YVttXS5jZVswXS0+ZW5naW5lKTsKKwkJCWlm
IChJU19FUlIoY2UpKQorCQkJCWdvdG8gb3V0X2xvY2tlZDsKKworCQkJZXJyID0gaW50ZWxfY29u
dGV4dF9waW4oY2UpOworCQkJaWYgKGVycikgeworCQkJCWludGVsX2NvbnRleHRfcHV0KGNlKTsK
KwkJCQlnb3RvIG91dF9sb2NrZWQ7CisJCQl9CisKKwkJCWRhdGFbbV0uY2Vbbl0gPSBjZTsKKwkJ
fQorCX0KKworCW11dGV4X3VubG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CisKKwlmb3Ig
KGZuID0gZnVuYzsgIWVyciAmJiAqZm47IGZuKyspIHsKKwkJc3RydWN0IGlndF9saXZlX3Rlc3Qg
dDsKKwkJaW50IG47CisKKwkJbXV0ZXhfbG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CisJ
CWVyciA9IGlndF9saXZlX3Rlc3RfYmVnaW4oJnQsIGk5MTUsIF9fZnVuY19fLCAiIik7CisJCW11
dGV4X3VubG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CisJCWlmIChlcnIpCisJCQlicmVh
azsKKworCQlmb3IgKG4gPSAwOyBuIDwgY291bnQ7IG4rKykgeworCQkJaWYgKGRhdGFbbl0uY2Vb
MF0gPT0gTlVMTCkKKwkJCQljb250aW51ZTsKKworCQkJZGF0YVtuXS50c2sgPSBrdGhyZWFkX3J1
bigqZm4sICZkYXRhW25dLAorCQkJCQkJICAiaWd0L3BhcmFsbGVsOiVzIiwKKwkJCQkJCSAgZGF0
YVtuXS5jZVswXS0+ZW5naW5lLT5uYW1lKTsKKwkJCWlmIChJU19FUlIoZGF0YVtuXS50c2spKSB7
CisJCQkJZXJyID0gUFRSX0VSUihkYXRhW25dLnRzayk7CisJCQkJYnJlYWs7CisJCQl9CisJCQln
ZXRfdGFza19zdHJ1Y3QoZGF0YVtuXS50c2spOworCQl9CisKKwkJZm9yIChuID0gMDsgbiA8IGNv
dW50OyBuKyspIHsKKwkJCWludCBzdGF0dXM7CisKKwkJCWlmIChJU19FUlJfT1JfTlVMTChkYXRh
W25dLnRzaykpCisJCQkJY29udGludWU7CisKKwkJCXN0YXR1cyA9IGt0aHJlYWRfc3RvcChkYXRh
W25dLnRzayk7CisJCQlpZiAoc3RhdHVzICYmICFlcnIpCisJCQkJZXJyID0gc3RhdHVzOworCisJ
CQlwdXRfdGFza19zdHJ1Y3QoZGF0YVtuXS50c2spOworCQkJZGF0YVtuXS50c2sgPSBOVUxMOwor
CQl9CisKKwkJbXV0ZXhfbG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CisJCWlmIChpZ3Rf
bGl2ZV90ZXN0X2VuZCgmdCkpCisJCQllcnIgPSAtRUlPOworCQltdXRleF91bmxvY2soJmk5MTUt
PmRybS5zdHJ1Y3RfbXV0ZXgpOworCX0KKworCW11dGV4X2xvY2soJmk5MTUtPmRybS5zdHJ1Y3Rf
bXV0ZXgpOworb3V0X2xvY2tlZDoKKwlmb3IgKG4gPSAwOyBuIDwgY291bnQ7IG4rKykgeworCQlm
b3IgKG0gPSAwOyBtIDwgQVJSQVlfU0laRShkYXRhLT5jZSk7IG0rKykgeworCQkJaWYgKCFkYXRh
W25dLmNlW21dKQorCQkJCWNvbnRpbnVlOworCisJCQlpbnRlbF9jb250ZXh0X3VucGluKGRhdGFb
bl0uY2VbbV0pOworCQkJaW50ZWxfY29udGV4dF9wdXQoZGF0YVtuXS5jZVttXSk7CisJCX0KKwl9
CisJbXV0ZXhfdW5sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKKwlrZnJlZShkYXRhKTsK
Kwltb2NrX2ZpbGVfZnJlZShpOTE1LCBmaWxlKTsKKwlyZXR1cm4gZXJyOworfQorCiBzdGF0aWMg
dW5zaWduZWQgbG9uZyByZWFsX3BhZ2VfY291bnQoc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3Qg
Km9iaikKIHsKIAlyZXR1cm4gaHVnZV9nZW1fb2JqZWN0X3BoeXNfc2l6ZShvYmopID4+IFBBR0Vf
U0hJRlQ7CkBAIC0xNjgxLDYgKzE5MTgsNyBAQCBpbnQgaTkxNV9nZW1fY29udGV4dF9saXZlX3Nl
bGZ0ZXN0cyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKIHsKIAlzdGF0aWMgY29uc3Qg
c3RydWN0IGk5MTVfc3VidGVzdCB0ZXN0c1tdID0gewogCQlTVUJURVNUKGxpdmVfbm9wX3N3aXRj
aCksCisJCVNVQlRFU1QobGl2ZV9wYXJhbGxlbF9zd2l0Y2gpLAogCQlTVUJURVNUKGlndF9jdHhf
ZXhlYyksCiAJCVNVQlRFU1QoaWd0X2N0eF9yZWFkb25seSksCiAJCVNVQlRFU1QoaWd0X2N0eF9z
c2V1KSwKLS0gCjIuMjMuMAoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0
b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50
ZWwtZ2Z4

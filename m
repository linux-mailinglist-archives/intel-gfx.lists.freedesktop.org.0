Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id C241E74BAA
	for <lists+intel-gfx@lfdr.de>; Thu, 25 Jul 2019 12:34:22 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id E54FA6E6D5;
	Thu, 25 Jul 2019 10:34:20 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mga07.intel.com (mga07.intel.com [134.134.136.100])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 8E9306E6D5
 for <intel-gfx@lists.freedesktop.org>; Thu, 25 Jul 2019 10:34:19 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga006.jf.intel.com ([10.7.209.51])
 by orsmga105.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 25 Jul 2019 03:34:19 -0700
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.64,306,1559545200"; d="scan'208";a="175171031"
Received: from roszkopf-mobl.ger.corp.intel.com (HELO
 delly.ger.corp.intel.com) ([10.249.32.173])
 by orsmga006.jf.intel.com with ESMTP; 25 Jul 2019 03:34:10 -0700
From: Lionel Landwerlin <lionel.g.landwerlin@intel.com>
To: intel-gfx@lists.freedesktop.org
Date: Thu, 25 Jul 2019 13:33:26 +0300
Message-Id: <20190725103327.27010-9-lionel.g.landwerlin@intel.com>
X-Mailer: git-send-email 2.22.0
In-Reply-To: <20190725103327.27010-1-lionel.g.landwerlin@intel.com>
References: <20190725103327.27010-1-lionel.g.landwerlin@intel.com>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v10 8/9] drm/i915/perf: execute OA configuration
 from command stream
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

V2UgaGF2ZW4ndCBydW4gaW50byBpc3N1ZXMgd2l0aCBwcm9ncmFtbWluZyB0aGUgZ2xvYmFsIE9B
L05PQQpyZWdpc3RlcnMgY29uZmlndXJhdGlvbiBmcm9tIENQVSBzbyBmYXIsIGJ1dCBIVyBlbmdp
bmVlcnMgYWN0dWFsbHkKcmVjb21tZW5kIGRvaW5nIHRoaXMgZnJvbSB0aGUgY29tbWFuZCBzdHJl
YW1lci4gT24gVEdMIGluIHBhcnRpY3VsYXIKb25lIG9mIHRoZSBjbG9jayBkb21haW4gaW4gd2hp
Y2ggc29tZSBvZiB0aGF0IHByb2dyYW1taW5nIGdvZXMgbWlnaHQKbm90IGJlIHBvd2VyZWQgd2hl
biB3ZSBwb2tlIHRoaW5ncyBmcm9tIHRoZSBDUFUuCgpTaW5jZSB3ZSBoYXZlIGEgY29tbWFuZCBi
dWZmZXIgcHJlcGFyZWQgZm9yIHRoZSBleGVjYnVmZmVyIHNpZGUgb2YKdGhpbmdzLCB3ZSBjYW4g
cmV1c2UgdGhhdCBhcHByb2FjaCBoZXJlIHRvby4KClRoaXMgYWxzbyBhbGxvd3MgdXMgdG8gc2ln
bmlmaWNhbnRseSByZWR1Y2UgdGhlIGFtb3VudCBvZiB0aW1lIHdlIGhvbGQKdGhlIG1haW4gbG9j
ay4KCnYyOiBEcm9wIHRoZSBnbG9iYWwgbG9jayBhcyBtdWNoIGFzIHBvc3NpYmxlCgp2MzogVGFr
ZSBnbG9iYWwgbG9jayB0byBwaW4gZ2xvYmFsCgp2NDogQ3JlYXRlIGk5MTUgcmVxdWVzdCBpbiBl
bWl0X29hX2NvbmZpZygpIHRvIGF2b2lkIGRlYWRsb2NrcyAoTGlvbmVsKQoKU2lnbmVkLW9mZi1i
eTogTGlvbmVsIExhbmR3ZXJsaW4gPGxpb25lbC5nLmxhbmR3ZXJsaW5AaW50ZWwuY29tPgotLS0K
IGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZHJ2LmggIHwgICA3ICsrCiBkcml2ZXJzL2dwdS9k
cm0vaTkxNS9pOTE1X3BlcmYuYyB8IDIwNCArKysrKysrKysrKysrKysrKysrLS0tLS0tLS0tLS0t
CiAyIGZpbGVzIGNoYW5nZWQsIDEzNCBpbnNlcnRpb25zKCspLCA3NyBkZWxldGlvbnMoLSkKCmRp
ZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2Rydi5oIGIvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvaTkxNV9kcnYuaAppbmRleCBhYmFmZmVjYWQ0N2MuLjViMGJhNWRkZjZkYiAxMDA2
NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYuaAorKysgYi9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9pOTE1X2Rydi5oCkBAIC0xMjA3LDYgKzEyMDcsMTMgQEAgc3RydWN0IGk5MTVf
cGVyZl9zdHJlYW0gewogCSAqLwogCWludGVsX3dha2VyZWZfdCB3YWtlcmVmOwogCisJLyoqCisJ
ICogQGluaXRpYWxfY29uZmlnX3JxOiBGaXJzdCByZXF1ZXN0IHJ1biBhdCB0aGUgb3BlbmluZyBv
ZiB0aGUgaTkxNQorCSAqIHBlcmYgc3RyZWFtIHRvIGNvbmZpZ3VyZSB0aGUgSFcuIFNob3VsZCBi
ZSBOVUxMIGFmdGVyIHRoZSBwZXJmCisJICogc3RyZWFtIGhhcyBiZWVuIG9wZW5lZCBzdWNjZXNz
ZnVsbHkuCisJICovCisJc3RydWN0IGk5MTVfcmVxdWVzdCAqaW5pdGlhbF9jb25maWdfcnE7CisK
IAkvKioKIAkgKiBAc2FtcGxlX2ZsYWdzOiBGbGFncyByZXByZXNlbnRpbmcgdGhlIGBEUk1fSTkx
NV9QRVJGX1BST1BfU0FNUExFXypgCiAJICogcHJvcGVydGllcyBnaXZlbiB3aGVuIG9wZW5pbmcg
YSBzdHJlYW0sIHJlcHJlc2VudGluZyB0aGUgY29udGVudHMKZGlmZiAtLWdpdCBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2k5MTVfcGVyZi5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wZXJm
LmMKaW5kZXggMTNhNDJjYTkxYWM1Li4xNDdhZTYyZmU5NTcgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2k5MTVfcGVyZi5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVf
cGVyZi5jCkBAIC0zOTAsNiArMzkwLDE5IEBAIHZvaWQgaTkxNV9vYV9jb25maWdfcmVsZWFzZShz
dHJ1Y3Qga3JlZiAqcmVmKQogCWtmcmVlKG9hX2NvbmZpZyk7CiB9CiAKK3N0YXRpYyB2b2lkIGk5
MTVfb2FfY29uZmlnX2Rpc3Bvc2VfYnVmZmVycyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkx
NSkKK3sKKwlzdHJ1Y3QgaTkxNV9vYV9jb25maWcgKm9hX2NvbmZpZywgKm5leHQ7CisKKwltdXRl
eF9sb2NrKCZpOTE1LT5wZXJmLm1ldHJpY3NfbG9jayk7CisJbGlzdF9mb3JfZWFjaF9lbnRyeV9z
YWZlKG9hX2NvbmZpZywgbmV4dCwgJmk5MTUtPnBlcmYubWV0cmljc19idWZmZXJzLCB2bWFfbGlu
aykgeworCQlsaXN0X2RlbCgmb2FfY29uZmlnLT52bWFfbGluayk7CisJCWk5MTVfZ2VtX29iamVj
dF9wdXQob2FfY29uZmlnLT5vYmopOworCQlvYV9jb25maWctPm9iaiA9IE5VTEw7CisJfQorCW11
dGV4X3VubG9jaygmaTkxNS0+cGVyZi5tZXRyaWNzX2xvY2spOworfQorCiBzdGF0aWMgdTMyICp3
cml0ZV9jc19taV9scmkodTMyICpjcywgY29uc3Qgc3RydWN0IGk5MTVfb2FfcmVnICpyZWdfZGF0
YSwgdTMyIG5fcmVncykKIHsKIAl1MzIgaTsKQEAgLTE0NDcsNiArMTQ2MCwxNCBAQCBzdGF0aWMg
dm9pZCBvYV9wdXRfcmVuZGVyX2N0eF9pZChzdHJ1Y3QgaTkxNV9wZXJmX3N0cmVhbSAqc3RyZWFt
KQogCX0KIH0KIAorc3RhdGljIHZvaWQgZnJlZV9ub2Ffd2FpdChzdHJ1Y3QgZHJtX2k5MTVfcHJp
dmF0ZSAqaTkxNSkKK3sKKwltdXRleF9sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKKwlp
OTE1X3ZtYV91bnBpbl9hbmRfcmVsZWFzZSgmaTkxNS0+cGVyZi5vYS5ub2Ffd2FpdCwKKwkJCQkg
ICBJOTE1X1ZNQV9SRUxFQVNFX01BUCk7CisJbXV0ZXhfdW5sb2NrKCZpOTE1LT5kcm0uc3RydWN0
X211dGV4KTsKK30KKwogc3RhdGljIHZvaWQKIGZyZWVfb2FfYnVmZmVyKHN0cnVjdCBkcm1faTkx
NV9wcml2YXRlICppOTE1KQogewpAQCAtMTQ3MSwxMSArMTQ5MiwxMSBAQCBzdGF0aWMgdm9pZCBp
OTE1X29hX3N0cmVhbV9kZXN0cm95KHN0cnVjdCBpOTE1X3BlcmZfc3RyZWFtICpzdHJlYW0pCiAJ
ICogdGhlIG1ldHJpYyBzZXQgb24gZ2VuOCsuCiAJICovCiAJbXV0ZXhfbG9jaygmZGV2X3ByaXYt
PmRybS5zdHJ1Y3RfbXV0ZXgpOwotCWRldl9wcml2LT5wZXJmLm9hLmV4Y2x1c2l2ZV9zdHJlYW0g
PSBOVUxMOwogCWRldl9wcml2LT5wZXJmLm9hLm9wcy5kaXNhYmxlX21ldHJpY19zZXQoZGV2X3By
aXYpOwotCWk5MTVfdm1hX3VucGluX2FuZF9yZWxlYXNlKCZkZXZfcHJpdi0+cGVyZi5vYS5ub2Ff
d2FpdCwgMCk7CisJZGV2X3ByaXYtPnBlcmYub2EuZXhjbHVzaXZlX3N0cmVhbSA9IE5VTEw7CiAJ
bXV0ZXhfdW5sb2NrKCZkZXZfcHJpdi0+ZHJtLnN0cnVjdF9tdXRleCk7CiAKKwlmcmVlX25vYV93
YWl0KGRldl9wcml2KTsKIAlmcmVlX29hX2J1ZmZlcihkZXZfcHJpdik7CiAKIAlpbnRlbF91bmNv
cmVfZm9yY2V3YWtlX3B1dCgmZGV2X3ByaXYtPnVuY29yZSwgRk9SQ0VXQUtFX0FMTCk7CkBAIC0x
NzAzLDYgKzE3MjQsMTAgQEAgc3RhdGljIGludCBhbGxvY19ub2Ffd2FpdChzdHJ1Y3QgZHJtX2k5
MTVfcHJpdmF0ZSAqaTkxNSkKIAkJcmV0dXJuIFBUUl9FUlIoYm8pOwogCX0KIAorCXJldCA9IGk5
MTVfbXV0ZXhfbG9ja19pbnRlcnJ1cHRpYmxlKCZpOTE1LT5kcm0pOworCWlmIChyZXQpCisJCWdv
dG8gZXJyX3VucmVmOworCiAJLyoKIAkgKiBXZSBwaW4gaW4gR0dUVCBiZWNhdXNlIHdlIGp1bXAg
aW50byB0aGlzIGJ1ZmZlciBub3cgYmVjYXVzZQogCSAqIG11bHRpcGxlIE9BIGNvbmZpZyBCT3Mg
d2lsbCBoYXZlIGEganVtcCB0byB0aGlzIGFkZHJlc3MgYW5kIGl0CkBAIC0xNzEwLDEwICsxNzM1
LDEzIEBAIHN0YXRpYyBpbnQgYWxsb2Nfbm9hX3dhaXQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUg
Kmk5MTUpCiAJICovCiAJdm1hID0gaTkxNV9nZW1fb2JqZWN0X2dndHRfcGluKGJvLCBOVUxMLCAw
LCA0MDk2LCAwKTsKIAlpZiAoSVNfRVJSKHZtYSkpIHsKKwkJbXV0ZXhfdW5sb2NrKCZpOTE1LT5k
cm0uc3RydWN0X211dGV4KTsKIAkJcmV0ID0gUFRSX0VSUih2bWEpOwogCQlnb3RvIGVycl91bnJl
ZjsKIAl9CiAKKwltdXRleF91bmxvY2soJmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOworCiAJYmF0
Y2ggPSBjcyA9IGk5MTVfZ2VtX29iamVjdF9waW5fbWFwKGJvLCBJOTE1X01BUF9XQik7CiAJaWYg
KElTX0VSUihiYXRjaCkpIHsKIAkJcmV0ID0gUFRSX0VSUihiYXRjaCk7CkBAIC0xODQ3LDcgKzE4
NzUsMTEgQEAgc3RhdGljIGludCBhbGxvY19ub2Ffd2FpdChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0
ZSAqaTkxNSkKIAlyZXR1cm4gMDsKIAogZXJyX3VucGluOgotCV9faTkxNV92bWFfdW5waW4odm1h
KTsKKwltdXRleF9sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKKwlpOTE1X3ZtYV91bnBp
bl9hbmRfcmVsZWFzZSgmaTkxNS0+cGVyZi5vYS5ub2Ffd2FpdCwgMCk7CisJbXV0ZXhfdW5sb2Nr
KCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKKworCXJldHVybiByZXQ7CiAKIGVycl91bnJlZjoK
IAlpOTE1X2dlbV9vYmplY3RfcHV0KGJvKTsKQEAgLTE4NTUsNTAgKzE4ODcsNzEgQEAgc3RhdGlj
IGludCBhbGxvY19ub2Ffd2FpdChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKIAlyZXR1
cm4gcmV0OwogfQogCi1zdGF0aWMgdm9pZCBjb25maWdfb2FfcmVncyhzdHJ1Y3QgZHJtX2k5MTVf
cHJpdmF0ZSAqZGV2X3ByaXYsCi0JCQkgICBjb25zdCBzdHJ1Y3QgaTkxNV9vYV9yZWcgKnJlZ3Ms
Ci0JCQkgICB1MzIgbl9yZWdzKQorc3RhdGljIGludCBlbWl0X29hX2NvbmZpZyhzdHJ1Y3QgZHJt
X2k5MTVfcHJpdmF0ZSAqaTkxNSwKKwkJCSAgc3RydWN0IGk5MTVfcGVyZl9zdHJlYW0gKnN0cmVh
bSkKIHsKLQl1MzIgaTsKKwlzdHJ1Y3QgaTkxNV9vYV9jb25maWcgKm9hX2NvbmZpZyA9IHN0cmVh
bS0+b2FfY29uZmlnOworCXN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxOworCXN0cnVjdCBpOTE1X3Zt
YSAqdm1hOworCXUzMiAqY3M7CisJaW50IGVycjsKIAotCWZvciAoaSA9IDA7IGkgPCBuX3JlZ3M7
IGkrKykgewotCQljb25zdCBzdHJ1Y3QgaTkxNV9vYV9yZWcgKnJlZyA9IHJlZ3MgKyBpOworCWxv
Y2tkZXBfYXNzZXJ0X2hlbGQoJmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOwogCi0JCUk5MTVfV1JJ
VEUocmVnLT5hZGRyLCByZWctPnZhbHVlKTsKKwlycSA9IGk5MTVfcmVxdWVzdF9jcmVhdGUoaTkx
NS0+ZW5naW5lW1JDUzBdLT5rZXJuZWxfY29udGV4dCk7CisJaWYgKElTX0VSUihycSkpCisJCXJl
dHVybiBQVFJfRVJSKHJxKTsKKworCWVyciA9IGk5MTVfYWN0aXZlX3JlcXVlc3Rfc2V0KCZpOTE1
LT5lbmdpbmVbUkNTMF0tPmxhc3Rfb2FfY29uZmlnLAorCQkJCSAgICAgIHJxKTsKKwlpZiAoZXJy
KQorCQlnb3RvIGVycl9hZGRfcmVxdWVzdDsKKworCXZtYSA9IGk5MTVfdm1hX2luc3RhbmNlKG9h
X2NvbmZpZy0+b2JqLCAmaTkxNS0+Z2d0dC52bSwgTlVMTCk7CisJaWYgKHVubGlrZWx5KElTX0VS
Uih2bWEpKSkgeworCQllcnIgPSBQVFJfRVJSKHZtYSk7CisJCWdvdG8gZXJyX2FkZF9yZXF1ZXN0
OwogCX0KLX0KIAotc3RhdGljIHZvaWQgZGVsYXlfYWZ0ZXJfbXV4KHZvaWQpCi17Ci0JLyoKLQkg
KiBJdCBhcHBhcmVudGx5IHRha2VzIGEgZmFpcmx5IGxvbmcgdGltZSBmb3IgYSBuZXcgTVVYCi0J
ICogY29uZmlndXJhdGlvbiB0byBiZSBiZSBhcHBsaWVkIGFmdGVyIHRoZXNlIHJlZ2lzdGVyIHdy
aXRlcy4KLQkgKiBUaGlzIGRlbGF5IGR1cmF0aW9uIHdhcyBkZXJpdmVkIGVtcGlyaWNhbGx5IGJh
c2VkIG9uIHRoZQotCSAqIHJlbmRlcl9iYXNpYyBjb25maWcgYnV0IGhvcGVmdWxseSBpdCBjb3Zl
cnMgdGhlIG1heGltdW0KLQkgKiBjb25maWd1cmF0aW9uIGxhdGVuY3kuCi0JICoKLQkgKiBBcyBh
IGZhbGxiYWNrLCB0aGUgY2hlY2tzIGluIF9hcHBlbmRfb2FfcmVwb3J0cygpIHRvIHNraXAKLQkg
KiBpbnZhbGlkIE9BIHJlcG9ydHMgZG8gYWxzbyBzZWVtIHRvIHdvcmsgdG8gZGlzY2FyZCByZXBv
cnRzCi0JICogZ2VuZXJhdGVkIGJlZm9yZSB0aGlzIGNvbmZpZyBoYXMgY29tcGxldGVkIC0gYWxi
ZWl0IG5vdAotCSAqIHNpbGVudGx5LgotCSAqCi0JICogVW5mb3J0dW5hdGVseSB0aGlzIGlzIGVz
c2VudGlhbGx5IGEgbWFnaWMgbnVtYmVyLCBzaW5jZSB3ZQotCSAqIGRvbid0IGN1cnJlbnRseSBr
bm93IG9mIGEgcmVsaWFibGUgbWVjaGFuaXNtIGZvciBwcmVkaWN0aW5nCi0JICogaG93IGxvbmcg
dGhlIE1VWCBjb25maWcgd2lsbCB0YWtlIHRvIGFwcGx5IGFuZCBiZXNpZGVzCi0JICogc2VlaW5n
IGludmFsaWQgcmVwb3J0cyB3ZSBkb24ndCBrbm93IG9mIGEgcmVsaWFibGUgd2F5IHRvCi0JICog
ZXhwbGljaXRseSBjaGVjayB0aGF0IHRoZSBNVVggY29uZmlnIGhhcyBsYW5kZWQuCi0JICoKLQkg
KiBJdCdzIGV2ZW4gcG9zc2libGUgd2UndmUgbWlzcyBjaGFyYWN0ZXJpemVkIHRoZSB1bmRlcmx5
aW5nCi0JICogcHJvYmxlbSAtIGl0IGp1c3Qgc2VlbXMgbGlrZSB0aGUgc2ltcGxlc3QgZXhwbGFu
YXRpb24gd2h5Ci0JICogYSBkZWxheSBhdCB0aGlzIGxvY2F0aW9uIHdvdWxkIG1pdGlnYXRlIGFu
eSBpbnZhbGlkIHJlcG9ydHMuCi0JICovCi0JdXNsZWVwX3JhbmdlKDE1MDAwLCAyMDAwMCk7CisJ
ZXJyID0gaTkxNV92bWFfcGluKHZtYSwgMCwgMCwgUElOX0dMT0JBTCk7CisJaWYgKGVycikKKwkJ
Z290byBlcnJfYWRkX3JlcXVlc3Q7CisKKwllcnIgPSBpOTE1X3ZtYV9tb3ZlX3RvX2FjdGl2ZSh2
bWEsIHJxLCAwKTsKKwlpZiAoZXJyKQorCQlnb3RvIGVycl92bWFfdW5waW47CisKKwljcyA9IGlu
dGVsX3JpbmdfYmVnaW4ocnEsIElOVEVMX0dFTihpOTE1KSA+PSA4ID8gNCA6IDIpOworCWlmIChJ
U19FUlIoY3MpKSB7CisJCWVyciA9IFBUUl9FUlIoY3MpOworCQlnb3RvIGVycl92bWFfdW5waW47
CisJfQorCisJaWYgKElOVEVMX0dFTihpOTE1KSA+IDgpIHsKKwkJKmNzKysgPSBNSV9CQVRDSF9C
VUZGRVJfU1RBUlRfR0VOODsKKwkJKmNzKysgPSBsb3dlcl8zMl9iaXRzKHZtYS0+bm9kZS5zdGFy
dCk7CisJCSpjcysrID0gdXBwZXJfMzJfYml0cyh2bWEtPm5vZGUuc3RhcnQpOworCQkqY3MrKyA9
IE1JX05PT1A7CisJfSBlbHNlIHsKKwkJKmNzKysgPSBNSV9CQVRDSF9CVUZGRVJfU1RBUlQ7CisJ
CSpjcysrID0gdm1hLT5ub2RlLnN0YXJ0OworCX0KKworCWludGVsX3JpbmdfYWR2YW5jZShycSwg
Y3MpOworCisJc3RyZWFtLT5pbml0aWFsX2NvbmZpZ19ycSA9IGk5MTVfcmVxdWVzdF9nZXQocnEp
OworCitlcnJfdm1hX3VucGluOgorCWk5MTVfdm1hX3VucGluKHZtYSk7CitlcnJfYWRkX3JlcXVl
c3Q6CisJaTkxNV9yZXF1ZXN0X2FkZChycSk7CisKKwlyZXR1cm4gZXJyOwogfQogCiBzdGF0aWMg
aW50IGhzd19lbmFibGVfbWV0cmljX3NldChzdHJ1Y3QgaTkxNV9wZXJmX3N0cmVhbSAqc3RyZWFt
KQogewogCXN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiA9IHN0cmVhbS0+ZGV2X3By
aXY7Ci0JY29uc3Qgc3RydWN0IGk5MTVfb2FfY29uZmlnICpvYV9jb25maWcgPSBzdHJlYW0tPm9h
X2NvbmZpZzsKIAogCS8qCiAJICogUFJNOgpAQCAtMTkxNSwxMyArMTk2OCw3IEBAIHN0YXRpYyBp
bnQgaHN3X2VuYWJsZV9tZXRyaWNfc2V0KHN0cnVjdCBpOTE1X3BlcmZfc3RyZWFtICpzdHJlYW0p
CiAJSTkxNV9XUklURShHRU42X1VDR0NUTDEsIChJOTE1X1JFQUQoR0VONl9VQ0dDVEwxKSB8CiAJ
CQkJICBHRU42X0NTVU5JVF9DTE9DS19HQVRFX0RJU0FCTEUpKTsKIAotCWNvbmZpZ19vYV9yZWdz
KGRldl9wcml2LCBvYV9jb25maWctPm11eF9yZWdzLCBvYV9jb25maWctPm11eF9yZWdzX2xlbik7
Ci0JZGVsYXlfYWZ0ZXJfbXV4KCk7Ci0KLQljb25maWdfb2FfcmVncyhkZXZfcHJpdiwgb2FfY29u
ZmlnLT5iX2NvdW50ZXJfcmVncywKLQkJICAgICAgIG9hX2NvbmZpZy0+Yl9jb3VudGVyX3JlZ3Nf
bGVuKTsKLQotCXJldHVybiAwOworCXJldHVybiBlbWl0X29hX2NvbmZpZyhkZXZfcHJpdiwgc3Ry
ZWFtKTsKIH0KIAogc3RhdGljIHZvaWQgaHN3X2Rpc2FibGVfbWV0cmljX3NldChzdHJ1Y3QgZHJt
X2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYpCkBAIC0yMjY4LDEzICsyMzE1LDcgQEAgc3RhdGljIGlu
dCBnZW44X2VuYWJsZV9tZXRyaWNfc2V0KHN0cnVjdCBpOTE1X3BlcmZfc3RyZWFtICpzdHJlYW0p
CiAJaWYgKHJldCkKIAkJcmV0dXJuIHJldDsKIAotCWNvbmZpZ19vYV9yZWdzKGRldl9wcml2LCBv
YV9jb25maWctPm11eF9yZWdzLCBvYV9jb25maWctPm11eF9yZWdzX2xlbik7Ci0JZGVsYXlfYWZ0
ZXJfbXV4KCk7Ci0KLQljb25maWdfb2FfcmVncyhkZXZfcHJpdiwgb2FfY29uZmlnLT5iX2NvdW50
ZXJfcmVncywKLQkJICAgICAgIG9hX2NvbmZpZy0+Yl9jb3VudGVyX3JlZ3NfbGVuKTsKLQotCXJl
dHVybiAwOworCXJldHVybiBlbWl0X29hX2NvbmZpZyhkZXZfcHJpdiwgc3RyZWFtKTsKIH0KIAog
c3RhdGljIHZvaWQgZ2VuOF9kaXNhYmxlX21ldHJpY19zZXQoc3RydWN0IGRybV9pOTE1X3ByaXZh
dGUgKmRldl9wcml2KQpAQCAtMjQ0NSw3ICsyNDg2LDkgQEAgc3RhdGljIGludCBpOTE1X29hX3N0
cmVhbV9pbml0KHN0cnVjdCBpOTE1X3BlcmZfc3RyZWFtICpzdHJlYW0sCiAJCQkgICAgICAgc3Ry
dWN0IHBlcmZfb3Blbl9wcm9wZXJ0aWVzICpwcm9wcykKIHsKIAlzdHJ1Y3QgZHJtX2k5MTVfcHJp
dmF0ZSAqZGV2X3ByaXYgPSBzdHJlYW0tPmRldl9wcml2OworCXN0cnVjdCBkcm1faTkxNV9nZW1f
b2JqZWN0ICpvYmo7CiAJaW50IGZvcm1hdF9zaXplOworCWxvbmcgdGltZW91dDsKIAlpbnQgcmV0
OwogCiAJLyogSWYgdGhlIHN5c2ZzIG1ldHJpY3MvIGRpcmVjdG9yeSB3YXNuJ3QgcmVnaXN0ZXJl
ZCBmb3Igc29tZQpAQCAtMjUyOSwxMyArMjU3Miw2IEBAIHN0YXRpYyBpbnQgaTkxNV9vYV9zdHJl
YW1faW5pdChzdHJ1Y3QgaTkxNV9wZXJmX3N0cmVhbSAqc3RyZWFtLAogCQl9CiAJfQogCi0JcmV0
ID0gaTkxNV9wZXJmX2dldF9vYV9jb25maWcoZGV2X3ByaXYsIHByb3BzLT5tZXRyaWNzX3NldCwK
LQkJCQkgICAgICAmc3RyZWFtLT5vYV9jb25maWcsIE5VTEwpOwotCWlmIChyZXQpIHsKLQkJRFJN
X0RFQlVHKCJJbnZhbGlkIE9BIGNvbmZpZyBpZD0laVxuIiwgcHJvcHMtPm1ldHJpY3Nfc2V0KTsK
LQkJZ290byBlcnJfY29uZmlnOwotCX0KLQogCXJldCA9IGFsbG9jX25vYV93YWl0KGRldl9wcml2
KTsKIAlpZiAocmV0KSB7CiAJCURSTV9ERUJVRygiVW5hYmxlIHRvIGFsbG9jYXRlIE5PQSB3YWl0
IGJhdGNoIGJ1ZmZlclxuIik7CkBAIC0yNTYxLDQ3ICsyNTk3LDY4IEBAIHN0YXRpYyBpbnQgaTkx
NV9vYV9zdHJlYW1faW5pdChzdHJ1Y3QgaTkxNV9wZXJmX3N0cmVhbSAqc3RyZWFtLAogCWlmIChy
ZXQpCiAJCWdvdG8gZXJyX29hX2J1Zl9hbGxvYzsKIAorCXJldCA9IGk5MTVfcGVyZl9nZXRfb2Ff
Y29uZmlnKGRldl9wcml2LCBwcm9wcy0+bWV0cmljc19zZXQsCisJCQkJICAgICAgJnN0cmVhbS0+
b2FfY29uZmlnLCAmb2JqKTsKKwlpZiAocmV0KSB7CisJCURSTV9ERUJVRygiSW52YWxpZCBPQSBj
b25maWcgaWQ9JWlcbiIsIHByb3BzLT5tZXRyaWNzX3NldCk7CisJCWdvdG8gZXJyX2NvbmZpZzsK
Kwl9CisKKwkvKgorCSAqIFdlIGp1c3QgbmVlZCB0aGUgYnVmZmVyIHRvIGJlIGNyZWF0ZWQsIGJ1
dCBub3Qgb3VyIG93biByZWZlcmVuY2Ugb24KKwkgKiBpdCBhcyB0aGUgb2FfY29uZmlnIGFscmVh
ZHkgaGFzIG9uZS4KKwkgKi8KKwlpOTE1X2dlbV9vYmplY3RfcHV0KG9iaik7CisKKwlzdHJlYW0t
Pm9wcyA9ICZpOTE1X29hX3N0cmVhbV9vcHM7CisKIAlyZXQgPSBpOTE1X211dGV4X2xvY2tfaW50
ZXJydXB0aWJsZSgmZGV2X3ByaXYtPmRybSk7CiAJaWYgKHJldCkKIAkJZ290byBlcnJfbG9jazsK
IAotCXN0cmVhbS0+b3BzID0gJmk5MTVfb2Ffc3RyZWFtX29wczsKIAlkZXZfcHJpdi0+cGVyZi5v
YS5leGNsdXNpdmVfc3RyZWFtID0gc3RyZWFtOwogCiAJcmV0ID0gZGV2X3ByaXYtPnBlcmYub2Eu
b3BzLmVuYWJsZV9tZXRyaWNfc2V0KHN0cmVhbSk7CisJbXV0ZXhfdW5sb2NrKCZkZXZfcHJpdi0+
ZHJtLnN0cnVjdF9tdXRleCk7CiAJaWYgKHJldCkgewogCQlEUk1fREVCVUcoIlVuYWJsZSB0byBl
bmFibGUgbWV0cmljIHNldFxuIik7CiAJCWdvdG8gZXJyX2VuYWJsZTsKIAl9CiAKLQlEUk1fREVC
VUcoIm9wZW5pbmcgc3RyZWFtIG9hIGNvbmZpZyB1dWlkPSVzXG4iLCBzdHJlYW0tPm9hX2NvbmZp
Zy0+dXVpZCk7CisJdGltZW91dCA9IGk5MTVfcmVxdWVzdF93YWl0KHN0cmVhbS0+aW5pdGlhbF9j
b25maWdfcnEsCisJCQkJICAgIEk5MTVfV0FJVF9JTlRFUlJVUFRJQkxFLAorCQkJCSAgICBNQVhf
U0NIRURVTEVfVElNRU9VVCk7CisJaTkxNV9yZXF1ZXN0X3B1dChzdHJlYW0tPmluaXRpYWxfY29u
ZmlnX3JxKTsKKwlzdHJlYW0tPmluaXRpYWxfY29uZmlnX3JxID0gTlVMTDsKIAotCW11dGV4X3Vu
bG9jaygmZGV2X3ByaXYtPmRybS5zdHJ1Y3RfbXV0ZXgpOworCXJldCA9IHRpbWVvdXQgPCAwID8g
dGltZW91dCA6IDA7CisJaWYgKHJldCkKKwkJZ290byBlcnJfZW5hYmxlOworCisJRFJNX0RFQlVH
KCJvcGVuaW5nIHN0cmVhbSBvYSBjb25maWcgdXVpZD0lc1xuIiwgc3RyZWFtLT5vYV9jb25maWct
PnV1aWQpOwogCiAJcmV0dXJuIDA7CiAKIGVycl9lbmFibGU6CisJbXV0ZXhfbG9jaygmZGV2X3By
aXYtPmRybS5zdHJ1Y3RfbXV0ZXgpOwogCWRldl9wcml2LT5wZXJmLm9hLmV4Y2x1c2l2ZV9zdHJl
YW0gPSBOVUxMOwogCWRldl9wcml2LT5wZXJmLm9hLm9wcy5kaXNhYmxlX21ldHJpY19zZXQoZGV2
X3ByaXYpOwogCW11dGV4X3VubG9jaygmZGV2X3ByaXYtPmRybS5zdHJ1Y3RfbXV0ZXgpOwogCiBl
cnJfbG9jazoKKwlpOTE1X29hX2NvbmZpZ19wdXQoc3RyZWFtLT5vYV9jb25maWcpOworCWk5MTVf
b2FfY29uZmlnX2Rpc3Bvc2VfYnVmZmVycyhkZXZfcHJpdik7CisKK2Vycl9jb25maWc6CiAJZnJl
ZV9vYV9idWZmZXIoZGV2X3ByaXYpOwogCiBlcnJfb2FfYnVmX2FsbG9jOgotCWk5MTVfb2FfY29u
ZmlnX3B1dChzdHJlYW0tPm9hX2NvbmZpZyk7Ci0KIAlpbnRlbF91bmNvcmVfZm9yY2V3YWtlX3B1
dCgmZGV2X3ByaXYtPnVuY29yZSwgRk9SQ0VXQUtFX0FMTCk7CiAJaW50ZWxfcnVudGltZV9wbV9w
dXQoJmRldl9wcml2LT5ydW50aW1lX3BtLCBzdHJlYW0tPndha2VyZWYpOwogCi0JbXV0ZXhfbG9j
aygmZGV2X3ByaXYtPmRybS5zdHJ1Y3RfbXV0ZXgpOwotCWk5MTVfdm1hX3VucGluX2FuZF9yZWxl
YXNlKCZkZXZfcHJpdi0+cGVyZi5vYS5ub2Ffd2FpdCwgMCk7Ci0JbXV0ZXhfdW5sb2NrKCZkZXZf
cHJpdi0+ZHJtLnN0cnVjdF9tdXRleCk7CisJZnJlZV9ub2Ffd2FpdChkZXZfcHJpdik7CiAKIGVy
cl9ub2Ffd2FpdF9hbGxvYzoKLQlpOTE1X29hX2NvbmZpZ19wdXQoc3RyZWFtLT5vYV9jb25maWcp
OwotCi1lcnJfY29uZmlnOgogCWlmIChzdHJlYW0tPmN0eCkKIAkJb2FfcHV0X3JlbmRlcl9jdHhf
aWQoc3RyZWFtKTsKIApAQCAtMjk2MywyMCArMzAyMCwxMyBAQCBzdGF0aWMgaW50IGk5MTVfcGVy
Zl9yZWxlYXNlKHN0cnVjdCBpbm9kZSAqaW5vZGUsIHN0cnVjdCBmaWxlICpmaWxlKQogewogCXN0
cnVjdCBpOTE1X3BlcmZfc3RyZWFtICpzdHJlYW0gPSBmaWxlLT5wcml2YXRlX2RhdGE7CiAJc3Ry
dWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2ID0gc3RyZWFtLT5kZXZfcHJpdjsKLQlzdHJ1
Y3QgaTkxNV9vYV9jb25maWcgKm9hX2NvbmZpZywgKm5leHQ7CiAKIAltdXRleF9sb2NrKCZkZXZf
cHJpdi0+cGVyZi5sb2NrKTsKIAogCWk5MTVfcGVyZl9kZXN0cm95X2xvY2tlZChzdHJlYW0pOwog
CiAJLyogRGlzcG9zZSBvZiBhbGwgb2EgY29uZmlnIGJhdGNoIGJ1ZmZlcnMuICovCi0JbXV0ZXhf
bG9jaygmZGV2X3ByaXYtPnBlcmYubWV0cmljc19sb2NrKTsKLQlsaXN0X2Zvcl9lYWNoX2VudHJ5
X3NhZmUob2FfY29uZmlnLCBuZXh0LCAmZGV2X3ByaXYtPnBlcmYubWV0cmljc19idWZmZXJzLCB2
bWFfbGluaykgewotCQlsaXN0X2RlbCgmb2FfY29uZmlnLT52bWFfbGluayk7Ci0JCWk5MTVfZ2Vt
X29iamVjdF9wdXQob2FfY29uZmlnLT5vYmopOwotCQlvYV9jb25maWctPm9iaiA9IE5VTEw7Ci0J
fQotCW11dGV4X3VubG9jaygmZGV2X3ByaXYtPnBlcmYubWV0cmljc19sb2NrKTsKKwlpOTE1X29h
X2NvbmZpZ19kaXNwb3NlX2J1ZmZlcnMoZGV2X3ByaXYpOwogCiAJbXV0ZXhfdW5sb2NrKCZkZXZf
cHJpdi0+cGVyZi5sb2NrKTsKIAotLSAKMi4yMi4wCgpfX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fXwpJbnRlbC1nZnggbWFpbGluZyBsaXN0CkludGVsLWdmeEBs
aXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1h
bi9saXN0aW5mby9pbnRlbC1nZng=

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id A841A76124
	for <lists+intel-gfx@lfdr.de>; Fri, 26 Jul 2019 10:46:36 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 946B36E8AC;
	Fri, 26 Jul 2019 08:46:32 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 3575E6E8A7
 for <intel-gfx@lists.freedesktop.org>; Fri, 26 Jul 2019 08:46:29 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17621091-1500050 
 for multiple; Fri, 26 Jul 2019 09:46:17 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Fri, 26 Jul 2019 09:46:02 +0100
Message-Id: <20190726084613.22129-16-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.22.0
In-Reply-To: <20190726084613.22129-1-chris@chris-wilson.co.uk>
References: <20190726084613.22129-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 16/27] drm/i915: Only include active engines in
 the capture state
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

U2tpcCBwcmludGluZyBvdXQgaWRsZSBlbmdpbmVzIHRoYXQgZGlkIG5vdCBjb250cmlidXRlIHRv
IHRoZSBHUFUgaGFuZy4KQXMgdGhlIG51bWJlciBvZiBlbmdpbmVzIGdldHMgZXZlciBsYXJnZXIs
IHdlIGhhdmUgaW5jcmVhc2luZyBub2lzZSBpbgp0aGUgZXJyb3Igc3RhdGUgd2hlcmUgdHlwaWNh
bGx5IHRoZXJlIGlzIG9ubHkgb25lIGd1aWx0eSByZXF1ZXN0IG9uIG9uZQplbmdpbmUgdGhhdCB3
ZSBuZWVkIHRvIGluc3BlY3QuCgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNocmlzQGNo
cmlzLXdpbHNvbi5jby51az4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dwdV9lcnJv
ci5jIHwgMjM0ICsrKysrKysrKysrLS0tLS0tLS0tLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkx
NS9pOTE1X2dwdV9lcnJvci5oIHwgICA3ICstCiAyIGZpbGVzIGNoYW5nZWQsIDEwMiBpbnNlcnRp
b25zKCspLCAxMzkgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvaTkxNV9ncHVfZXJyb3IuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ3B1X2Vycm9y
LmMKaW5kZXggZWZmMTBjYTVhNzg4Li4xNzgxMDBiMGQwNWMgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2k5MTVfZ3B1X2Vycm9yLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUv
aTkxNV9ncHVfZXJyb3IuYwpAQCAtNDksMjcgKzQ5LDYgQEAKICNkZWZpbmUgQUxMT1dfRkFJTCAo
R0ZQX0tFUk5FTCB8IF9fR0ZQX1JFVFJZX01BWUZBSUwgfCBfX0dGUF9OT1dBUk4pCiAjZGVmaW5l
IEFUT01JQ19NQVlGQUlMIChHRlBfQVRPTUlDIHwgX19HRlBfTk9XQVJOKQogCi1zdGF0aWMgaW5s
aW5lIGNvbnN0IHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKgotZW5naW5lX2xvb2t1cChjb25zdCBz
dHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSwgdW5zaWduZWQgaW50IGlkKQotewotCWlmIChp
ZCA+PSBJOTE1X05VTV9FTkdJTkVTKQotCQlyZXR1cm4gTlVMTDsKLQotCXJldHVybiBpOTE1LT5l
bmdpbmVbaWRdOwotfQotCi1zdGF0aWMgaW5saW5lIGNvbnN0IGNoYXIgKgotX19lbmdpbmVfbmFt
ZShjb25zdCBzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUpCi17Ci0JcmV0dXJuIGVuZ2lu
ZSA/IGVuZ2luZS0+bmFtZSA6ICIiOwotfQotCi1zdGF0aWMgY29uc3QgY2hhciAqCi1lbmdpbmVf
bmFtZShjb25zdCBzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSwgdW5zaWduZWQgaW50IGlk
KQotewotCXJldHVybiBfX2VuZ2luZV9uYW1lKGVuZ2luZV9sb29rdXAoaTkxNSwgaWQpKTsKLX0K
LQogc3RhdGljIHZvaWQgX19zZ19zZXRfYnVmKHN0cnVjdCBzY2F0dGVybGlzdCAqc2csCiAJCQkg
dm9pZCAqYWRkciwgdW5zaWduZWQgaW50IGxlbiwgbG9mZl90IGl0KQogewpAQCAtNDQ3LDcgKzQy
Niw3IEBAIHN0YXRpYyB2b2lkIGVycm9yX3ByaW50X2luc3Rkb25lKHN0cnVjdCBkcm1faTkxNV9l
cnJvcl9zdGF0ZV9idWYgKm0sCiAJZXJyX3ByaW50ZihtLCAiICBJTlNURE9ORTogMHglMDh4XG4i
LAogCQkgICBlZS0+aW5zdGRvbmUuaW5zdGRvbmUpOwogCi0JaWYgKGVlLT5lbmdpbmVfaWQgIT0g
UkNTMCB8fCBJTlRFTF9HRU4obS0+aTkxNSkgPD0gMykKKwlpZiAoZWUtPmVuZ2luZS0+Y2xhc3Mg
IT0gUkVOREVSX0NMQVNTIHx8IElOVEVMX0dFTihtLT5pOTE1KSA8PSAzKQogCQlyZXR1cm47CiAK
IAllcnJfcHJpbnRmKG0sICIgIFNDX0lOU1RET05FOiAweCUwOHhcbiIsCkBAIC01MDEsOCArNDgw
LDcgQEAgc3RhdGljIHZvaWQgZXJyb3JfcHJpbnRfZW5naW5lKHN0cnVjdCBkcm1faTkxNV9lcnJv
cl9zdGF0ZV9idWYgKm0sCiB7CiAJaW50IG47CiAKLQllcnJfcHJpbnRmKG0sICIlcyBjb21tYW5k
IHN0cmVhbTpcbiIsCi0JCSAgIGVuZ2luZV9uYW1lKG0tPmk5MTUsIGVlLT5lbmdpbmVfaWQpKTsK
KwllcnJfcHJpbnRmKG0sICIlcyBjb21tYW5kIHN0cmVhbTpcbiIsIGVlLT5lbmdpbmUtPm5hbWUp
OwogCWVycl9wcmludGYobSwgIiAgSURMRT86ICVzXG4iLCB5ZXNubyhlZS0+aWRsZSkpOwogCWVy
cl9wcmludGYobSwgIiAgU1RBUlQ6IDB4JTA4eFxuIiwgZWUtPnN0YXJ0KTsKIAllcnJfcHJpbnRm
KG0sICIgIEhFQUQ6ICAweCUwOHggWzB4JTA4eF1cbiIsIGVlLT5oZWFkLCBlZS0+cnFfaGVhZCk7
CkBAIC01NzQsOSArNTUyLDkgQEAgdm9pZCBpOTE1X2Vycm9yX3ByaW50ZihzdHJ1Y3QgZHJtX2k5
MTVfZXJyb3Jfc3RhdGVfYnVmICplLCBjb25zdCBjaGFyICpmLCAuLi4pCiB9CiAKIHN0YXRpYyB2
b2lkIHByaW50X2Vycm9yX29iaihzdHJ1Y3QgZHJtX2k5MTVfZXJyb3Jfc3RhdGVfYnVmICptLAot
CQkJICAgIHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSwKKwkJCSAgICBjb25zdCBzdHJ1
Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUsCiAJCQkgICAgY29uc3QgY2hhciAqbmFtZSwKLQkJ
CSAgICBzdHJ1Y3QgZHJtX2k5MTVfZXJyb3Jfb2JqZWN0ICpvYmopCisJCQkgICAgY29uc3Qgc3Ry
dWN0IGRybV9pOTE1X2Vycm9yX29iamVjdCAqb2JqKQogewogCWNoYXIgb3V0W0FTQ0lJODVfQlVG
U1pdOwogCWludCBwYWdlOwpAQCAtNjczLDcgKzY1MSw3IEBAIHN0YXRpYyB2b2lkIGVycl9mcmVl
X3NnbChzdHJ1Y3Qgc2NhdHRlcmxpc3QgKnNnbCkKIHN0YXRpYyB2b2lkIF9fZXJyX3ByaW50X3Rv
X3NnbChzdHJ1Y3QgZHJtX2k5MTVfZXJyb3Jfc3RhdGVfYnVmICptLAogCQkJICAgICAgIHN0cnVj
dCBpOTE1X2dwdV9zdGF0ZSAqZXJyb3IpCiB7Ci0Jc3RydWN0IGRybV9pOTE1X2Vycm9yX29iamVj
dCAqb2JqOworCWNvbnN0IHN0cnVjdCBkcm1faTkxNV9lcnJvcl9lbmdpbmUgKmVlOwogCXN0cnVj
dCB0aW1lc3BlYzY0IHRzOwogCWludCBpLCBqOwogCkBAIC02OTQsMTUgKzY3MiwxMiBAQCBzdGF0
aWMgdm9pZCBfX2Vycl9wcmludF90b19zZ2woc3RydWN0IGRybV9pOTE1X2Vycm9yX3N0YXRlX2J1
ZiAqbSwKIAllcnJfcHJpbnRmKG0sICJDYXB0dXJlOiAlbHUgamlmZmllczsgJWQgbXMgYWdvXG4i
LAogCQkgICBlcnJvci0+Y2FwdHVyZSwgamlmZmllc190b19tc2VjcyhqaWZmaWVzIC0gZXJyb3It
PmNhcHR1cmUpKTsKIAotCWZvciAoaSA9IDA7IGkgPCBBUlJBWV9TSVpFKGVycm9yLT5lbmdpbmUp
OyBpKyspIHsKLQkJaWYgKCFlcnJvci0+ZW5naW5lW2ldLmNvbnRleHQucGlkKQotCQkJY29udGlu
dWU7Ci0KKwlmb3IgKGVlID0gZXJyb3ItPmVuZ2luZTsgZWU7IGVlID0gZWUtPm5leHQpCiAJCWVy
cl9wcmludGYobSwgIkFjdGl2ZSBwcm9jZXNzIChvbiByaW5nICVzKTogJXMgWyVkXVxuIiwKLQkJ
CSAgIGVuZ2luZV9uYW1lKG0tPmk5MTUsIGkpLAotCQkJICAgZXJyb3ItPmVuZ2luZVtpXS5jb250
ZXh0LmNvbW0sCi0JCQkgICBlcnJvci0+ZW5naW5lW2ldLmNvbnRleHQucGlkKTsKLQl9CisJCQkg
ICBlZS0+ZW5naW5lLT5uYW1lLAorCQkJICAgZWUtPmNvbnRleHQuY29tbSwKKwkJCSAgIGVlLT5j
b250ZXh0LnBpZCk7CisKIAllcnJfcHJpbnRmKG0sICJSZXNldCBjb3VudDogJXVcbiIsIGVycm9y
LT5yZXNldF9jb3VudCk7CiAJZXJyX3ByaW50ZihtLCAiU3VzcGVuZCBjb3VudDogJXVcbiIsIGVy
cm9yLT5zdXNwZW5kX2NvdW50KTsKIAllcnJfcHJpbnRmKG0sICJQbGF0Zm9ybTogJXNcbiIsIGlu
dGVsX3BsYXRmb3JtX25hbWUoZXJyb3ItPmRldmljZV9pbmZvLnBsYXRmb3JtKSk7CkBAIC03NTEs
MTkgKzcyNiwxNSBAQCBzdGF0aWMgdm9pZCBfX2Vycl9wcmludF90b19zZ2woc3RydWN0IGRybV9p
OTE1X2Vycm9yX3N0YXRlX2J1ZiAqbSwKIAlpZiAoSVNfR0VOKG0tPmk5MTUsIDcpKQogCQllcnJf
cHJpbnRmKG0sICJFUlJfSU5UOiAweCUwOHhcbiIsIGVycm9yLT5lcnJfaW50KTsKIAotCWZvciAo
aSA9IDA7IGkgPCBBUlJBWV9TSVpFKGVycm9yLT5lbmdpbmUpOyBpKyspIHsKLQkJaWYgKGVycm9y
LT5lbmdpbmVbaV0uZW5naW5lX2lkICE9IC0xKQotCQkJZXJyb3JfcHJpbnRfZW5naW5lKG0sCi0J
CQkJCSAgICZlcnJvci0+ZW5naW5lW2ldLAotCQkJCQkgICBlcnJvci0+Y2FwdHVyZSk7Ci0JfQor
CWZvciAoZWUgPSBlcnJvci0+ZW5naW5lOyBlZTsgZWUgPSBlZS0+bmV4dCkKKwkJZXJyb3JfcHJp
bnRfZW5naW5lKG0sIGVlLCBlcnJvci0+Y2FwdHVyZSk7CiAKLQlmb3IgKGkgPSAwOyBpIDwgQVJS
QVlfU0laRShlcnJvci0+ZW5naW5lKTsgaSsrKSB7Ci0JCWNvbnN0IHN0cnVjdCBkcm1faTkxNV9l
cnJvcl9lbmdpbmUgKmVlID0gJmVycm9yLT5lbmdpbmVbaV07CisJZm9yIChlZSA9IGVycm9yLT5l
bmdpbmU7IGVlOyBlZSA9IGVlLT5uZXh0KSB7CisJCWNvbnN0IHN0cnVjdCBkcm1faTkxNV9lcnJv
cl9vYmplY3QgKm9iajsKIAogCQlvYmogPSBlZS0+YmF0Y2hidWZmZXI7CiAJCWlmIChvYmopIHsK
LQkJCWVycl9wdXRzKG0sIG0tPmk5MTUtPmVuZ2luZVtpXS0+bmFtZSk7CisJCQllcnJfcHV0cyht
LCBlZS0+ZW5naW5lLT5uYW1lKTsKIAkJCWlmIChlZS0+Y29udGV4dC5waWQpCiAJCQkJZXJyX3By
aW50ZihtLCAiIChzdWJtaXR0ZWQgYnkgJXMgWyVkXSkiLAogCQkJCQkgICBlZS0+Y29udGV4dC5j
b21tLApAQCAtNzcxLDE2ICs3NDIsMTUgQEAgc3RhdGljIHZvaWQgX19lcnJfcHJpbnRfdG9fc2ds
KHN0cnVjdCBkcm1faTkxNV9lcnJvcl9zdGF0ZV9idWYgKm0sCiAJCQllcnJfcHJpbnRmKG0sICIg
LS0tIGd0dF9vZmZzZXQgPSAweCUwOHggJTA4eFxuIiwKIAkJCQkgICB1cHBlcl8zMl9iaXRzKG9i
ai0+Z3R0X29mZnNldCksCiAJCQkJICAgbG93ZXJfMzJfYml0cyhvYmotPmd0dF9vZmZzZXQpKTsK
LQkJCXByaW50X2Vycm9yX29iaihtLCBtLT5pOTE1LT5lbmdpbmVbaV0sIE5VTEwsIG9iaik7CisJ
CQlwcmludF9lcnJvcl9vYmoobSwgZWUtPmVuZ2luZSwgTlVMTCwgb2JqKTsKIAkJfQogCiAJCWZv
ciAoaiA9IDA7IGogPCBlZS0+dXNlcl9ib19jb3VudDsgaisrKQotCQkJcHJpbnRfZXJyb3Jfb2Jq
KG0sIG0tPmk5MTUtPmVuZ2luZVtpXSwKLQkJCQkJInVzZXIiLCBlZS0+dXNlcl9ib1tqXSk7CisJ
CQlwcmludF9lcnJvcl9vYmoobSwgZWUtPmVuZ2luZSwgInVzZXIiLCBlZS0+dXNlcl9ib1tqXSk7
CiAKIAkJaWYgKGVlLT5udW1fcmVxdWVzdHMpIHsKIAkJCWVycl9wcmludGYobSwgIiVzIC0tLSAl
ZCByZXF1ZXN0c1xuIiwKLQkJCQkgICBtLT5pOTE1LT5lbmdpbmVbaV0tPm5hbWUsCisJCQkJICAg
ZWUtPmVuZ2luZS0+bmFtZSwKIAkJCQkgICBlZS0+bnVtX3JlcXVlc3RzKTsKIAkJCWZvciAoaiA9
IDA7IGogPCBlZS0+bnVtX3JlcXVlc3RzOyBqKyspCiAJCQkJZXJyb3JfcHJpbnRfcmVxdWVzdCht
LCAiICIsCkBAIC03ODgsMjIgKzc1OCwxMyBAQCBzdGF0aWMgdm9pZCBfX2Vycl9wcmludF90b19z
Z2woc3RydWN0IGRybV9pOTE1X2Vycm9yX3N0YXRlX2J1ZiAqbSwKIAkJCQkJCSAgICBlcnJvci0+
Y2FwdHVyZSk7CiAJCX0KIAotCQlwcmludF9lcnJvcl9vYmoobSwgbS0+aTkxNS0+ZW5naW5lW2ld
LAotCQkJCSJyaW5nYnVmZmVyIiwgZWUtPnJpbmdidWZmZXIpOwotCi0JCXByaW50X2Vycm9yX29i
aihtLCBtLT5pOTE1LT5lbmdpbmVbaV0sCi0JCQkJIkhXIFN0YXR1cyIsIGVlLT5od3NfcGFnZSk7
Ci0KLQkJcHJpbnRfZXJyb3Jfb2JqKG0sIG0tPmk5MTUtPmVuZ2luZVtpXSwKLQkJCQkiSFcgY29u
dGV4dCIsIGVlLT5jdHgpOwotCi0JCXByaW50X2Vycm9yX29iaihtLCBtLT5pOTE1LT5lbmdpbmVb
aV0sCi0JCQkJIldBIGNvbnRleHQiLCBlZS0+d2FfY3R4KTsKLQotCQlwcmludF9lcnJvcl9vYmoo
bSwgbS0+aTkxNS0+ZW5naW5lW2ldLAorCQlwcmludF9lcnJvcl9vYmoobSwgZWUtPmVuZ2luZSwg
InJpbmdidWZmZXIiLCBlZS0+cmluZ2J1ZmZlcik7CisJCXByaW50X2Vycm9yX29iaihtLCBlZS0+
ZW5naW5lLCAiSFcgU3RhdHVzIiwgZWUtPmh3c19wYWdlKTsKKwkJcHJpbnRfZXJyb3Jfb2JqKG0s
IGVlLT5lbmdpbmUsICJIVyBjb250ZXh0IiwgZWUtPmN0eCk7CisJCXByaW50X2Vycm9yX29iaiht
LCBlZS0+ZW5naW5lLCAiV0EgY29udGV4dCIsIGVlLT53YV9jdHgpOworCQlwcmludF9lcnJvcl9v
YmoobSwgZWUtPmVuZ2luZSwKIAkJCQkiV0EgYmF0Y2hidWZmZXIiLCBlZS0+d2FfYmF0Y2hidWZm
ZXIpOwotCi0JCXByaW50X2Vycm9yX29iaihtLCBtLT5pOTE1LT5lbmdpbmVbaV0sCisJCXByaW50
X2Vycm9yX29iaihtLCBlZS0+ZW5naW5lLAogCQkJCSJOVUxMIGNvbnRleHQiLCBlZS0+ZGVmYXVs
dF9zdGF0ZSk7CiAJfQogCkBAIC05NTIsMTMgKzkxMywxNSBAQCB2b2lkIF9faTkxNV9ncHVfc3Rh
dGVfZnJlZShzdHJ1Y3Qga3JlZiAqZXJyb3JfcmVmKQogewogCXN0cnVjdCBpOTE1X2dwdV9zdGF0
ZSAqZXJyb3IgPQogCQljb250YWluZXJfb2YoZXJyb3JfcmVmLCB0eXBlb2YoKmVycm9yKSwgcmVm
KTsKLQlsb25nIGksIGo7CisJbG9uZyBpOwogCi0JZm9yIChpID0gMDsgaSA8IEFSUkFZX1NJWkUo
ZXJyb3ItPmVuZ2luZSk7IGkrKykgewotCQlzdHJ1Y3QgZHJtX2k5MTVfZXJyb3JfZW5naW5lICpl
ZSA9ICZlcnJvci0+ZW5naW5lW2ldOworCXdoaWxlIChlcnJvci0+ZW5naW5lKSB7CisJCXN0cnVj
dCBkcm1faTkxNV9lcnJvcl9lbmdpbmUgKmVlID0gZXJyb3ItPmVuZ2luZTsKIAotCQlmb3IgKGog
PSAwOyBqIDwgZWUtPnVzZXJfYm9fY291bnQ7IGorKykKLQkJCWk5MTVfZXJyb3Jfb2JqZWN0X2Zy
ZWUoZWUtPnVzZXJfYm9bal0pOworCQllcnJvci0+ZW5naW5lID0gZWUtPm5leHQ7CisKKwkJZm9y
IChpID0gMDsgaSA8IGVlLT51c2VyX2JvX2NvdW50OyBpKyspCisJCQlpOTE1X2Vycm9yX29iamVj
dF9mcmVlKGVlLT51c2VyX2JvW2ldKTsKIAkJa2ZyZWUoZWUtPnVzZXJfYm8pOwogCiAJCWk5MTVf
ZXJyb3Jfb2JqZWN0X2ZyZWUoZWUtPmJhdGNoYnVmZmVyKTsKQEAgLTk2OSw2ICs5MzIsNyBAQCB2
b2lkIF9faTkxNV9ncHVfc3RhdGVfZnJlZShzdHJ1Y3Qga3JlZiAqZXJyb3JfcmVmKQogCQlpOTE1
X2Vycm9yX29iamVjdF9mcmVlKGVlLT53YV9jdHgpOwogCiAJCWtmcmVlKGVlLT5yZXF1ZXN0cyk7
CisJCWtmcmVlKGVlKTsKIAl9CiAKIAlrZnJlZShlcnJvci0+b3ZlcmxheSk7CkBAIC0xMDUwLDIz
ICsxMDE0LDE3IEBAIGk5MTVfZXJyb3Jfb2JqZWN0X2NyZWF0ZShzdHJ1Y3QgZHJtX2k5MTVfcHJp
dmF0ZSAqaTkxNSwKICAqCiAgKiBJdCdzIG9ubHkgYSBzbWFsbCBzdGVwIGJldHRlciB0aGFuIGEg
cmFuZG9tIG51bWJlciBpbiBpdHMgY3VycmVudCBmb3JtLgogICovCi1zdGF0aWMgdTMyIGk5MTVf
ZXJyb3JfZ2VuZXJhdGVfY29kZShzdHJ1Y3QgaTkxNV9ncHVfc3RhdGUgKmVycm9yLAotCQkJCSAg
ICBpbnRlbF9lbmdpbmVfbWFza190IGVuZ2luZV9tYXNrKQorc3RhdGljIHUzMiBpOTE1X2Vycm9y
X2dlbmVyYXRlX2NvZGUoc3RydWN0IGk5MTVfZ3B1X3N0YXRlICplcnJvcikKIHsKKwljb25zdCBz
dHJ1Y3QgZHJtX2k5MTVfZXJyb3JfZW5naW5lICplZSA9IGVycm9yLT5lbmdpbmU7CisKIAkvKgog
CSAqIElQRUhSIHdvdWxkIGJlIGFuIGlkZWFsIHdheSB0byBkZXRlY3QgZXJyb3JzLCBhcyBpdCdz
IHRoZSBncm9zcwogCSAqIG1lYXN1cmUgb2YgInRoZSBjb21tYW5kIHRoYXQgaHVuZy4iIEhvd2V2
ZXIsIGhhcyBzb21lIHZlcnkgY29tbW9uCiAJICogc3luY2hyb25pemF0aW9uIGNvbW1hbmRzIHdo
aWNoIGFsbW9zdCBhbHdheXMgYXBwZWFyIGluIHRoZSBjYXNlCiAJICogc3RyaWN0bHkgYSBjbGll
bnQgYnVnLiBVc2UgaW5zdGRvbmUgdG8gZGlmZmVyZW50aWF0ZSB0aG9zZSBzb21lLgogCSAqLwot
CWlmIChlbmdpbmVfbWFzaykgewotCQlzdHJ1Y3QgZHJtX2k5MTVfZXJyb3JfZW5naW5lICplZSA9
Ci0JCQkmZXJyb3ItPmVuZ2luZVtmZnMoZW5naW5lX21hc2spXTsKLQotCQlyZXR1cm4gZWUtPmlw
ZWhyIF4gZWUtPmluc3Rkb25lLmluc3Rkb25lOwotCX0KLQotCXJldHVybiAwOworCXJldHVybiBl
ZSA/IGVlLT5pcGVociBeIGVlLT5pbnN0ZG9uZS5pbnN0ZG9uZSA6IDA7CiB9CiAKIHN0YXRpYyB2
b2lkIGdlbV9yZWNvcmRfZmVuY2VzKHN0cnVjdCBpOTE1X2dwdV9zdGF0ZSAqZXJyb3IpCkBAIC0x
Mjc0LDkgKzEyMzIsMTEgQEAgc3RhdGljIHZvaWQgZXJyb3JfcmVjb3JkX2VuZ2luZV9leGVjbGlz
dHMoY29uc3Qgc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lLAogCWVlLT5udW1fcG9ydHMg
PSBuOwogfQogCi1zdGF0aWMgdm9pZCByZWNvcmRfY29udGV4dChzdHJ1Y3QgZHJtX2k5MTVfZXJy
b3JfY29udGV4dCAqZSwKLQkJCSAgIHN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICpjdHgpCitzdGF0
aWMgYm9vbCByZWNvcmRfY29udGV4dChzdHJ1Y3QgZHJtX2k5MTVfZXJyb3JfY29udGV4dCAqZSwK
KwkJCSAgIGNvbnN0IHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxKQogeworCWNvbnN0IHN0cnVjdCBp
OTE1X2dlbV9jb250ZXh0ICpjdHggPSBycS0+Z2VtX2NvbnRleHQ7CisKIAlpZiAoY3R4LT5waWQp
IHsKIAkJc3RydWN0IHRhc2tfc3RydWN0ICp0YXNrOwogCkBAIC0xMjkzLDYgKzEyNTMsOCBAQCBz
dGF0aWMgdm9pZCByZWNvcmRfY29udGV4dChzdHJ1Y3QgZHJtX2k5MTVfZXJyb3JfY29udGV4dCAq
ZSwKIAllLT5zY2hlZF9hdHRyID0gY3R4LT5zY2hlZDsKIAllLT5ndWlsdHkgPSBhdG9taWNfcmVh
ZCgmY3R4LT5ndWlsdHlfY291bnQpOwogCWUtPmFjdGl2ZSA9IGF0b21pY19yZWFkKCZjdHgtPmFj
dGl2ZV9jb3VudCk7CisKKwlyZXR1cm4gaTkxNV9nZW1fY29udGV4dF9ub19lcnJvcl9jYXB0dXJl
KGN0eCk7CiB9CiAKIHN0cnVjdCBjYXB0dXJlX3ZtYSB7CkBAIC0xMzg3LDc0ICsxMzQ5LDY3IEBA
IHN0YXRpYyB2b2lkCiBnZW1fcmVjb3JkX3JpbmdzKHN0cnVjdCBpOTE1X2dwdV9zdGF0ZSAqZXJy
b3IsIHN0cnVjdCBjb21wcmVzcyAqY29tcHJlc3MpCiB7CiAJc3RydWN0IGRybV9pOTE1X3ByaXZh
dGUgKmk5MTUgPSBlcnJvci0+aTkxNTsKLQlpbnQgaTsKKwlzdHJ1Y3QgaW50ZWxfZW5naW5lX2Nz
ICplbmdpbmU7CisJc3RydWN0IGRybV9pOTE1X2Vycm9yX2VuZ2luZSAqZWU7CisKKwllZSA9IGt6
YWxsb2Moc2l6ZW9mKCplZSksIEdGUF9LRVJORUwpOworCWlmICghZWUpCisJCXJldHVybjsKIAot
CWZvciAoaSA9IDA7IGkgPCBJOTE1X05VTV9FTkdJTkVTOyBpKyspIHsKLQkJc3RydWN0IGludGVs
X2VuZ2luZV9jcyAqZW5naW5lID0gaTkxNS0+ZW5naW5lW2ldOwotCQlzdHJ1Y3QgZHJtX2k5MTVf
ZXJyb3JfZW5naW5lICplZSA9ICZlcnJvci0+ZW5naW5lW2ldOworCWZvcl9lYWNoX3VzZXJfZW5n
aW5lKGVuZ2luZSwgaTkxNSkgewogCQlzdHJ1Y3QgY2FwdHVyZV92bWEgKmNhcHR1cmUgPSBOVUxM
OwogCQlzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpyZXF1ZXN0OwogCQl1bnNpZ25lZCBsb25nIGZsYWdz
OwogCi0JCWVlLT5lbmdpbmVfaWQgPSAtMTsKLQotCQlpZiAoIWVuZ2luZSkKLQkJCWNvbnRpbnVl
OwotCi0JCWVlLT5lbmdpbmVfaWQgPSBpOwotCiAJCS8qIFJlZmlsbCBvdXIgcGFnZSBwb29sIGJl
Zm9yZSBlbnRlcmluZyBhdG9taWMgc2VjdGlvbiAqLwogCQlwb29sX3JlZmlsbCgmY29tcHJlc3Mt
PnBvb2wsIEFMTE9XX0ZBSUwpOwogCi0JCWVycm9yX3JlY29yZF9lbmdpbmVfcmVnaXN0ZXJzKGVy
cm9yLCBlbmdpbmUsIGVlKTsKLQkJZXJyb3JfcmVjb3JkX2VuZ2luZV9leGVjbGlzdHMoZW5naW5l
LCBlZSk7Ci0KIAkJc3Bpbl9sb2NrX2lycXNhdmUoJmVuZ2luZS0+YWN0aXZlLmxvY2ssIGZsYWdz
KTsKIAkJcmVxdWVzdCA9IGludGVsX2VuZ2luZV9maW5kX2FjdGl2ZV9yZXF1ZXN0KGVuZ2luZSk7
Ci0JCWlmIChyZXF1ZXN0KSB7Ci0JCQlzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4ID0gcmVx
dWVzdC0+Z2VtX2NvbnRleHQ7Ci0JCQlzdHJ1Y3QgaW50ZWxfcmluZyAqcmluZyA9IHJlcXVlc3Qt
PnJpbmc7Ci0KLQkJCXJlY29yZF9jb250ZXh0KCZlZS0+Y29udGV4dCwgY3R4KTsKLQotCQkJLyoK
LQkJCSAqIFdlIG5lZWQgdG8gY29weSB0aGVzZSB0byBhbiBhbm9ueW1vdXMgYnVmZmVyCi0JCQkg
KiBhcyB0aGUgc2ltcGxlc3QgbWV0aG9kIHRvIGF2b2lkIGJlaW5nIG92ZXJ3cml0dGVuCi0JCQkg
KiBieSB1c2Vyc3BhY2UuCi0JCQkgKi8KLQkJCWNhcHR1cmUgPSBjYXB0dXJlX3ZtYShjYXB0dXJl
LAotCQkJCQkgICAgICByZXF1ZXN0LT5iYXRjaCwKLQkJCQkJICAgICAgJmVlLT5iYXRjaGJ1ZmZl
cik7CisJCWlmICghcmVxdWVzdCkgeworCQkJc3Bpbl91bmxvY2tfaXJxcmVzdG9yZSgmZW5naW5l
LT5hY3RpdmUubG9jaywgZmxhZ3MpOworCQkJY29udGludWU7CisJCX0KIAotCQkJaWYgKEhBU19C
Uk9LRU5fQ1NfVExCKGk5MTUpKQotCQkJCWNhcHR1cmUgPSBjYXB0dXJlX3ZtYShjYXB0dXJlLAot
CQkJCQkJICAgICAgZW5naW5lLT5ndC0+c2NyYXRjaCwKLQkJCQkJCSAgICAgICZlZS0+d2FfYmF0
Y2hidWZmZXIpOworCQllcnJvci0+c2ltdWxhdGVkIHw9IHJlY29yZF9jb250ZXh0KCZlZS0+Y29u
dGV4dCwgcmVxdWVzdCk7CiAKLQkJCWNhcHR1cmUgPSByZXF1ZXN0X3JlY29yZF91c2VyX2JvKHJl
cXVlc3QsIGVlLCBjYXB0dXJlKTsKKwkJLyoKKwkJICogV2UgbmVlZCB0byBjb3B5IHRoZXNlIHRv
IGFuIGFub255bW91cyBidWZmZXIKKwkJICogYXMgdGhlIHNpbXBsZXN0IG1ldGhvZCB0byBhdm9p
ZCBiZWluZyBvdmVyd3JpdHRlbgorCQkgKiBieSB1c2Vyc3BhY2UuCisJCSAqLworCQljYXB0dXJl
ID0gY2FwdHVyZV92bWEoY2FwdHVyZSwKKwkJCQkgICAgICByZXF1ZXN0LT5iYXRjaCwKKwkJCQkg
ICAgICAmZWUtPmJhdGNoYnVmZmVyKTsKIAorCQlpZiAoSEFTX0JST0tFTl9DU19UTEIoaTkxNSkp
CiAJCQljYXB0dXJlID0gY2FwdHVyZV92bWEoY2FwdHVyZSwKLQkJCQkJICAgICAgcmVxdWVzdC0+
aHdfY29udGV4dC0+c3RhdGUsCi0JCQkJCSAgICAgICZlZS0+Y3R4KTsKKwkJCQkJICAgICAgZW5n
aW5lLT5ndC0+c2NyYXRjaCwKKwkJCQkJICAgICAgJmVlLT53YV9iYXRjaGJ1ZmZlcik7CiAKLQkJ
CWNhcHR1cmUgPSBjYXB0dXJlX3ZtYShjYXB0dXJlLAotCQkJCQkgICAgICByaW5nLT52bWEsCi0J
CQkJCSAgICAgICZlZS0+cmluZ2J1ZmZlcik7CisJCWNhcHR1cmUgPSByZXF1ZXN0X3JlY29yZF91
c2VyX2JvKHJlcXVlc3QsIGVlLCBjYXB0dXJlKTsKIAotCQkJZXJyb3ItPnNpbXVsYXRlZCB8PQot
CQkJCWk5MTVfZ2VtX2NvbnRleHRfbm9fZXJyb3JfY2FwdHVyZShjdHgpOworCQljYXB0dXJlID0g
Y2FwdHVyZV92bWEoY2FwdHVyZSwKKwkJCQkgICAgICByZXF1ZXN0LT5od19jb250ZXh0LT5zdGF0
ZSwKKwkJCQkgICAgICAmZWUtPmN0eCk7CiAKLQkJCWVlLT5ycV9oZWFkID0gcmVxdWVzdC0+aGVh
ZDsKLQkJCWVlLT5ycV9wb3N0ID0gcmVxdWVzdC0+cG9zdGZpeDsKLQkJCWVlLT5ycV90YWlsID0g
cmVxdWVzdC0+dGFpbDsKKwkJY2FwdHVyZSA9IGNhcHR1cmVfdm1hKGNhcHR1cmUsCisJCQkJICAg
ICAgcmVxdWVzdC0+cmluZy0+dm1hLAorCQkJCSAgICAgICZlZS0+cmluZ2J1ZmZlcik7CiAKLQkJ
CWVlLT5jcHVfcmluZ19oZWFkID0gcmluZy0+aGVhZDsKLQkJCWVlLT5jcHVfcmluZ190YWlsID0g
cmluZy0+dGFpbDsKKwkJZWUtPmNwdV9yaW5nX2hlYWQgPSByZXF1ZXN0LT5yaW5nLT5oZWFkOwor
CQllZS0+Y3B1X3JpbmdfdGFpbCA9IHJlcXVlc3QtPnJpbmctPnRhaWw7CiAKLQkJCWVuZ2luZV9y
ZWNvcmRfcmVxdWVzdHMoZW5naW5lLCByZXF1ZXN0LCBlZSk7Ci0JCX0KKwkJZWUtPnJxX2hlYWQg
PSByZXF1ZXN0LT5oZWFkOworCQllZS0+cnFfcG9zdCA9IHJlcXVlc3QtPnBvc3RmaXg7CisJCWVl
LT5ycV90YWlsID0gcmVxdWVzdC0+dGFpbDsKKworCQllbmdpbmVfcmVjb3JkX3JlcXVlc3RzKGVu
Z2luZSwgcmVxdWVzdCwgZWUpOwogCQlzcGluX3VubG9ja19pcnFyZXN0b3JlKCZlbmdpbmUtPmFj
dGl2ZS5sb2NrLCBmbGFncyk7CiAKKwkJZXJyb3JfcmVjb3JkX2VuZ2luZV9yZWdpc3RlcnMoZXJy
b3IsIGVuZ2luZSwgZWUpOworCQllcnJvcl9yZWNvcmRfZW5naW5lX2V4ZWNsaXN0cyhlbmdpbmUs
IGVlKTsKKwogCQl3aGlsZSAoY2FwdHVyZSkgewogCQkJc3RydWN0IGNhcHR1cmVfdm1hICp0aGlz
ID0gY2FwdHVyZTsKIAkJCXN0cnVjdCBpOTE1X3ZtYSAqdm1hID0gKnRoaXMtPnNsb3Q7CkBAIC0x
NDgxLDcgKzE0MzYsMTggQEAgZ2VtX3JlY29yZF9yaW5ncyhzdHJ1Y3QgaTkxNV9ncHVfc3RhdGUg
KmVycm9yLCBzdHJ1Y3QgY29tcHJlc3MgKmNvbXByZXNzKQogCiAJCWVlLT5kZWZhdWx0X3N0YXRl
ID0KIAkJCWNhcHR1cmVfb2JqZWN0KGk5MTUsIGVuZ2luZS0+ZGVmYXVsdF9zdGF0ZSwgY29tcHJl
c3MpOworCisJCWVlLT5lbmdpbmUgPSBlbmdpbmU7CisKKwkJZWUtPm5leHQgPSBlcnJvci0+ZW5n
aW5lOworCQllcnJvci0+ZW5naW5lID0gZWU7CisKKwkJZWUgPSBremFsbG9jKHNpemVvZigqZWUp
LCBHRlBfS0VSTkVMKTsKKwkJaWYgKCFlZSkKKwkJCXJldHVybjsKIAl9CisKKwlrZnJlZShlZSk7
CiB9CiAKIHN0YXRpYyB2b2lkCkBAIC0xNjEwLDI0ICsxNTc2LDE4IEBAIGVycm9yX21zZyhzdHJ1
Y3QgaTkxNV9ncHVfc3RhdGUgKmVycm9yLAogCSAgaW50ZWxfZW5naW5lX21hc2tfdCBlbmdpbmVz
LCBjb25zdCBjaGFyICptc2cpCiB7CiAJaW50IGxlbjsKLQlpbnQgaTsKLQotCWZvciAoaSA9IDA7
IGkgPCBBUlJBWV9TSVpFKGVycm9yLT5lbmdpbmUpOyBpKyspCi0JCWlmICghZXJyb3ItPmVuZ2lu
ZVtpXS5jb250ZXh0LnBpZCkKLQkJCWVuZ2luZXMgJj0gfkJJVChpKTsKIAogCWxlbiA9IHNjbnBy
aW50ZihlcnJvci0+ZXJyb3JfbXNnLCBzaXplb2YoZXJyb3ItPmVycm9yX21zZyksCiAJCQkiR1BV
IEhBTkc6IGVjb2RlICVkOiV4OjB4JTA4eCIsCiAJCQlJTlRFTF9HRU4oZXJyb3ItPmk5MTUpLCBl
bmdpbmVzLAotCQkJaTkxNV9lcnJvcl9nZW5lcmF0ZV9jb2RlKGVycm9yLCBlbmdpbmVzKSk7Ci0J
aWYgKGVuZ2luZXMpIHsKKwkJCWk5MTVfZXJyb3JfZ2VuZXJhdGVfY29kZShlcnJvcikpOworCWlm
IChlcnJvci0+ZW5naW5lKSB7CiAJCS8qIEp1c3Qgc2hvdyB0aGUgZmlyc3QgZXhlY3V0aW5nIHBy
b2Nlc3MsIG1vcmUgaXMgY29uZnVzaW5nICovCi0JCWkgPSBfX2ZmcyhlbmdpbmVzKTsKIAkJbGVu
ICs9IHNjbnByaW50ZihlcnJvci0+ZXJyb3JfbXNnICsgbGVuLAogCQkJCSBzaXplb2YoZXJyb3It
PmVycm9yX21zZykgLSBsZW4sCiAJCQkJICIsIGluICVzIFslZF0iLAotCQkJCSBlcnJvci0+ZW5n
aW5lW2ldLmNvbnRleHQuY29tbSwKLQkJCQkgZXJyb3ItPmVuZ2luZVtpXS5jb250ZXh0LnBpZCk7
CisJCQkJIGVycm9yLT5lbmdpbmUtPmNvbnRleHQuY29tbSwKKwkJCQkgZXJyb3ItPmVuZ2luZS0+
Y29udGV4dC5waWQpOwogCX0KIAlpZiAobXNnKQogCQlsZW4gKz0gc2NucHJpbnRmKGVycm9yLT5l
cnJvcl9tc2cgKyBsZW4sCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dw
dV9lcnJvci5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9ncHVfZXJyb3IuaAppbmRleCBj
NGJhMjk3Y2E4NjIuLjBlZDA2MWVlMzM3OCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvaTkxNV9ncHVfZXJyb3IuaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dwdV9l
cnJvci5oCkBAIC04MCw3ICs4MCw4IEBAIHN0cnVjdCBpOTE1X2dwdV9zdGF0ZSB7CiAJc3RydWN0
IGludGVsX2Rpc3BsYXlfZXJyb3Jfc3RhdGUgKmRpc3BsYXk7CiAKIAlzdHJ1Y3QgZHJtX2k5MTVf
ZXJyb3JfZW5naW5lIHsKLQkJaW50IGVuZ2luZV9pZDsKKwkJY29uc3Qgc3RydWN0IGludGVsX2Vu
Z2luZV9jcyAqZW5naW5lOworCiAJCS8qIFNvZnR3YXJlIHRyYWNrZWQgc3RhdGUgKi8KIAkJYm9v
bCBpZGxlOwogCQlpbnQgbnVtX3JlcXVlc3RzOwpAQCAtMTU2LDcgKzE1Nyw5IEBAIHN0cnVjdCBp
OTE1X2dwdV9zdGF0ZSB7CiAJCQkJdTMyIHBwX2Rpcl9iYXNlOwogCQkJfTsKIAkJfSB2bV9pbmZv
OwotCX0gZW5naW5lW0k5MTVfTlVNX0VOR0lORVNdOworCisJCXN0cnVjdCBkcm1faTkxNV9lcnJv
cl9lbmdpbmUgKm5leHQ7CisJfSAqZW5naW5lOwogCiAJc3RydWN0IHNjYXR0ZXJsaXN0ICpzZ2ws
ICpmaXQ7CiB9OwotLSAKMi4yMi4wCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fXwpJbnRlbC1nZnggbWFpbGluZyBsaXN0CkludGVsLWdmeEBsaXN0cy5mcmVl
ZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5m
by9pbnRlbC1nZng=

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 2CE77AD780
	for <lists+intel-gfx@lfdr.de>; Mon,  9 Sep 2019 13:00:25 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 7737E89B7B;
	Mon,  9 Sep 2019 11:00:23 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id A5C0089AB9
 for <intel-gfx@lists.freedesktop.org>; Mon,  9 Sep 2019 11:00:19 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18424995-1500050 
 for multiple; Mon, 09 Sep 2019 12:00:14 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon,  9 Sep 2019 12:00:07 +0100
Message-Id: <20190909110011.8958-3-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20190909110011.8958-1-chris@chris-wilson.co.uk>
References: <20190909110011.8958-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 2/6] drm/i915/selftests: Tighten the timeout
 testing for partial mmaps
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

Q3VycmVudGx5LCBpZiB0aGVyZSBpcyB0aW1lIHJlbWFpbmluZyBiZWZvcmUgdGhlIHN0YXJ0IG9m
IHRoZSBsb29wLCB3ZQpkbyBvbmUgZnVsbCBpdGVyYXRpb24gb3ZlciBtYW55IHBvc3NpYmxlIGRp
ZmZlcmVudCBjaHVua3Mgd2l0aGluIHRoZQpvYmplY3QuIEEgZnVsbCBsb29wIG1heSB0YWtlIDUw
K3MgKGRlcGVuZGluZyBvbiBzcGVlZCBvZiBpbmRpcmVjdCBHVFQKbW1hcGluZ3MpIGFuZCB3ZSB0
cnkgc2VwYXJhdGVseSB3aXRoIExJTkVBUiwgWCBhbmQgWSAtLSBhdCB3aGljaCBwb2ludAppZ3Qg
dGltZXMgb3V0LiBJZiB3ZSBjaGVjayBtb3JlIGZyZXF1ZW50bHksIHdlIHdpbGwgaW50ZXJydXB0
IHRoZSBsb29wCnVwb24gb3VyIHRpbWVvdXQgLS0gaXQgaXMgaGFyZCB0byBhcmd1ZSB0aGF0IHNp
Z25pZmljYW50bHkgcmVkdWNlcyB0aGUKdGVzdCBjb3ZlcmFnZSBkZXNwaXRlIHRoZSBkcmFtYXRp
YyBjb250cmFjdGlvbiBpbiBydW50aW1lLiBJbiBwcmFjdGljYWwKdGVybXMsIHRoZSBjb3ZlcmFn
ZSB3ZSBzaG91bGQgcHJpb3JpdGlzZSBpcyB1c2luZyBkaWZmZXJlbnQgZmVuY2UKc2V0dXBzLCBm
b3JjaW5nIHZlcmlmaWNhdGlvbiBvZiB0aGUgdGlsZSByb3cgY29tcHV0YXRpb25zIG92ZXIgdGhl
CmN1cnJlbnQgcHJlZmVyZW5jZSBvZiBjaGVja2luZyBleHRyYWN0aW5nIGNodW5rcy4gVGhvdWdo
IHRoZSBleGhhdXN0aXZlCnNlYXJjaCBpcyBncmVhdCBnaXZlbiBhbiBpbmZpbml0ZSB0aW1lb3V0
LCB0byBpbXByb3ZlIG91ciBjdXJyZW50CmNvdmVyYWdlLCB3ZSBhbHNvIGFkZCBhIHJhbmRvbWlz
ZWQgc21va2V0ZXN0IG9mIHBhcnRpYWwgbW1hcHMuCgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxz
b24gPGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KLS0tCiAuLi4vZHJtL2k5MTUvZ2VtL3NlbGZ0
ZXN0cy9pOTE1X2dlbV9tbWFuLmMgICAgfCAyNTMgKysrKysrKysrKysrKysrLS0tCiAxIGZpbGUg
Y2hhbmdlZCwgMjIyIGluc2VydGlvbnMoKyksIDMxIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBh
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMvaTkxNV9nZW1fbW1hbi5jIGIvZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ2VtL3NlbGZ0ZXN0cy9pOTE1X2dlbV9tbWFuLmMKaW5kZXggMWQy
N2JhYmZmMGNlLi42ODU3MjZjODU5OTEgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2dlbS9zZWxmdGVzdHMvaTkxNV9nZW1fbW1hbi5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2dlbS9zZWxmdGVzdHMvaTkxNV9nZW1fbW1hbi5jCkBAIC0xMCw2ICsxMCw3IEBACiAjaW5jbHVk
ZSAiZ3QvaW50ZWxfZ3RfcG0uaCIKICNpbmNsdWRlICJodWdlX2dlbV9vYmplY3QuaCIKICNpbmNs
dWRlICJpOTE1X3NlbGZ0ZXN0LmgiCisjaW5jbHVkZSAic2VsZnRlc3RzL2k5MTVfcmFuZG9tLmgi
CiAjaW5jbHVkZSAic2VsZnRlc3RzL2lndF9mbHVzaF90ZXN0LmgiCiAKIHN0cnVjdCB0aWxlIHsK
QEAgLTc1LDYgKzc2LDk2IEBAIHN0YXRpYyB1NjQgdGlsZWRfb2Zmc2V0KGNvbnN0IHN0cnVjdCB0
aWxlICp0aWxlLCB1NjQgdikKIH0KIAogc3RhdGljIGludCBjaGVja19wYXJ0aWFsX21hcHBpbmco
c3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiwKKwkJCQkgY29uc3Qgc3RydWN0IHRpbGUg
KnRpbGUsCisJCQkJIHN0cnVjdCBybmRfc3RhdGUgKnBybmcpCit7CisJY29uc3QgdW5zaWduZWQg
bG9uZyBucGFnZXMgPSBvYmotPmJhc2Uuc2l6ZSAvIFBBR0VfU0laRTsKKwlzdHJ1Y3QgaTkxNV9n
Z3R0X3ZpZXcgdmlldzsKKwlzdHJ1Y3QgaTkxNV92bWEgKnZtYTsKKwl1bnNpZ25lZCBsb25nIHBh
Z2U7CisJdTMyIF9faW9tZW0gKmlvOworCXN0cnVjdCBwYWdlICpwOworCXVuc2lnbmVkIGludCBu
OworCXU2NCBvZmZzZXQ7CisJdTMyICpjcHU7CisJaW50IGVycjsKKworCWVyciA9IGk5MTVfZ2Vt
X29iamVjdF9zZXRfdGlsaW5nKG9iaiwgdGlsZS0+dGlsaW5nLCB0aWxlLT5zdHJpZGUpOworCWlm
IChlcnIpIHsKKwkJcHJfZXJyKCJGYWlsZWQgdG8gc2V0IHRpbGluZyBtb2RlPSV1LCBzdHJpZGU9
JXUsIGVycj0lZFxuIiwKKwkJICAgICAgIHRpbGUtPnRpbGluZywgdGlsZS0+c3RyaWRlLCBlcnIp
OworCQlyZXR1cm4gZXJyOworCX0KKworCUdFTV9CVUdfT04oaTkxNV9nZW1fb2JqZWN0X2dldF90
aWxpbmcob2JqKSAhPSB0aWxlLT50aWxpbmcpOworCUdFTV9CVUdfT04oaTkxNV9nZW1fb2JqZWN0
X2dldF9zdHJpZGUob2JqKSAhPSB0aWxlLT5zdHJpZGUpOworCisJaTkxNV9nZW1fb2JqZWN0X2xv
Y2sob2JqKTsKKwllcnIgPSBpOTE1X2dlbV9vYmplY3Rfc2V0X3RvX2d0dF9kb21haW4ob2JqLCB0
cnVlKTsKKwlpOTE1X2dlbV9vYmplY3RfdW5sb2NrKG9iaik7CisJaWYgKGVycikgeworCQlwcl9l
cnIoIkZhaWxlZCB0byBmbHVzaCB0byBHVFQgd3JpdGUgZG9tYWluOyBlcnI9JWRcbiIsIGVycik7
CisJCXJldHVybiBlcnI7CisJfQorCisJcGFnZSA9IGk5MTVfcHJhbmRvbV91MzJfbWF4X3N0YXRl
KG5wYWdlcywgcHJuZyk7CisJdmlldyA9IGNvbXB1dGVfcGFydGlhbF92aWV3KG9iaiwgcGFnZSwg
TUlOX0NIVU5LX1BBR0VTKTsKKworCXZtYSA9IGk5MTVfZ2VtX29iamVjdF9nZ3R0X3BpbihvYmos
ICZ2aWV3LCAwLCAwLCBQSU5fTUFQUEFCTEUpOworCWlmIChJU19FUlIodm1hKSkgeworCQlwcl9l
cnIoIkZhaWxlZCB0byBwaW4gcGFydGlhbCB2aWV3OiBvZmZzZXQ9JWx1OyBlcnI9JWRcbiIsCisJ
CSAgICAgICBwYWdlLCAoaW50KVBUUl9FUlIodm1hKSk7CisJCXJldHVybiBQVFJfRVJSKHZtYSk7
CisJfQorCisJbiA9IHBhZ2UgLSB2aWV3LnBhcnRpYWwub2Zmc2V0OworCUdFTV9CVUdfT04obiA+
PSB2aWV3LnBhcnRpYWwuc2l6ZSk7CisKKwlpbyA9IGk5MTVfdm1hX3Bpbl9pb21hcCh2bWEpOwor
CWk5MTVfdm1hX3VucGluKHZtYSk7CisJaWYgKElTX0VSUihpbykpIHsKKwkJcHJfZXJyKCJGYWls
ZWQgdG8gaW9tYXAgcGFydGlhbCB2aWV3OiBvZmZzZXQ9JWx1OyBlcnI9JWRcbiIsCisJCSAgICAg
ICBwYWdlLCAoaW50KVBUUl9FUlIoaW8pKTsKKwkJZXJyID0gUFRSX0VSUihpbyk7CisJCWdvdG8g
b3V0OworCX0KKworCWlvd3JpdGUzMihwYWdlLCBpbyArIG4gKiBQQUdFX1NJWkUgLyBzaXplb2Yo
KmlvKSk7CisJaTkxNV92bWFfdW5waW5faW9tYXAodm1hKTsKKworCW9mZnNldCA9IHRpbGVkX29m
ZnNldCh0aWxlLCBwYWdlIDw8IFBBR0VfU0hJRlQpOworCWlmIChvZmZzZXQgPj0gb2JqLT5iYXNl
LnNpemUpCisJCWdvdG8gb3V0OworCisJaW50ZWxfZ3RfZmx1c2hfZ2d0dF93cml0ZXMoJnRvX2k5
MTUob2JqLT5iYXNlLmRldiktPmd0KTsKKworCXAgPSBpOTE1X2dlbV9vYmplY3RfZ2V0X3BhZ2Uo
b2JqLCBvZmZzZXQgPj4gUEFHRV9TSElGVCk7CisJY3B1ID0ga21hcChwKSArIG9mZnNldF9pbl9w
YWdlKG9mZnNldCk7CisJZHJtX2NsZmx1c2hfdmlydF9yYW5nZShjcHUsIHNpemVvZigqY3B1KSk7
CisJaWYgKCpjcHUgIT0gKHUzMilwYWdlKSB7CisJCXByX2VycigiUGFydGlhbCB2aWV3IGZvciAl
bHUgWyV1XSAob2Zmc2V0PSVsbHUsIHNpemU9JXUgWyVsbHUsIHJvdyBzaXplICV1XSwgZmVuY2U9
JWQsIHRpbGluZz0lZCwgc3RyaWRlPSVkKSBtaXNhbGlnbm1lbnQsIGV4cGVjdGVkIHdyaXRlIHRv
IHBhZ2UgKCVsbHUgKyAldSBbMHglbGx4XSkgb2YgMHgleCwgZm91bmQgMHgleFxuIiwKKwkJICAg
ICAgIHBhZ2UsIG4sCisJCSAgICAgICB2aWV3LnBhcnRpYWwub2Zmc2V0LAorCQkgICAgICAgdmll
dy5wYXJ0aWFsLnNpemUsCisJCSAgICAgICB2bWEtPnNpemUgPj4gUEFHRV9TSElGVCwKKwkJICAg
ICAgIHRpbGUtPnRpbGluZyA/IHRpbGVfcm93X3BhZ2VzKG9iaikgOiAwLAorCQkgICAgICAgdm1h
LT5mZW5jZSA/IHZtYS0+ZmVuY2UtPmlkIDogLTEsIHRpbGUtPnRpbGluZywgdGlsZS0+c3RyaWRl
LAorCQkgICAgICAgb2Zmc2V0ID4+IFBBR0VfU0hJRlQsCisJCSAgICAgICAodW5zaWduZWQgaW50
KW9mZnNldF9pbl9wYWdlKG9mZnNldCksCisJCSAgICAgICBvZmZzZXQsCisJCSAgICAgICAodTMy
KXBhZ2UsICpjcHUpOworCQllcnIgPSAtRUlOVkFMOworCX0KKwkqY3B1ID0gMDsKKwlkcm1fY2xm
bHVzaF92aXJ0X3JhbmdlKGNwdSwgc2l6ZW9mKCpjcHUpKTsKKwlrdW5tYXAocCk7CisKK291dDoK
KwlpOTE1X3ZtYV9kZXN0cm95KHZtYSk7CisJcmV0dXJuIGVycjsKK30KKworc3RhdGljIGludCBj
aGVja19wYXJ0aWFsX21hcHBpbmdzKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmosCiAJ
CQkJIGNvbnN0IHN0cnVjdCB0aWxlICp0aWxlLAogCQkJCSB1bnNpZ25lZCBsb25nIGVuZF90aW1l
KQogewpAQCAtODQsMTEgKzE3NSw2IEBAIHN0YXRpYyBpbnQgY2hlY2tfcGFydGlhbF9tYXBwaW5n
KHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmosCiAJdW5zaWduZWQgbG9uZyBwYWdlOwog
CWludCBlcnI7CiAKLQlpZiAoaWd0X3RpbWVvdXQoZW5kX3RpbWUsCi0JCQkiJXM6IHRpbWVkIG91
dCBiZWZvcmUgdGlsaW5nPSVkIHN0cmlkZT0lZFxuIiwKLQkJCV9fZnVuY19fLCB0aWxlLT50aWxp
bmcsIHRpbGUtPnN0cmlkZSkpCi0JCXJldHVybiAtRUlOVFI7Ci0KIAllcnIgPSBpOTE1X2dlbV9v
YmplY3Rfc2V0X3RpbGluZyhvYmosIHRpbGUtPnRpbGluZywgdGlsZS0+c3RyaWRlKTsKIAlpZiAo
ZXJyKSB7CiAJCXByX2VycigiRmFpbGVkIHRvIHNldCB0aWxpbmcgbW9kZT0ldSwgc3RyaWRlPSV1
LCBlcnI9JWRcbiIsCkBAIC0xNzAsMTEgKzI1Niw0MiBAQCBzdGF0aWMgaW50IGNoZWNrX3BhcnRp
YWxfbWFwcGluZyhzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqLAogCQkJcmV0dXJuIGVy
cjsKIAogCQlpOTE1X3ZtYV9kZXN0cm95KHZtYSk7CisKKwkJaWYgKGlndF90aW1lb3V0KGVuZF90
aW1lLAorCQkJCSIlczogdGltZWQgb3V0IGFmdGVyIHRpbGluZz0lZCBzdHJpZGU9JWRcbiIsCisJ
CQkJX19mdW5jX18sIHRpbGUtPnRpbGluZywgdGlsZS0+c3RyaWRlKSkKKwkJCXJldHVybiAtRUlO
VFI7CiAJfQogCiAJcmV0dXJuIDA7CiB9CiAKK3N0YXRpYyB1bnNpZ25lZCBpbnQKK3NldHVwX3Rp
bGVfc2l6ZShzdHJ1Y3QgdGlsZSAqdGlsZSwgc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUp
Cit7CisJaWYgKElOVEVMX0dFTihpOTE1KSA8PSAyKSB7CisJCXRpbGUtPmhlaWdodCA9IDE2Owor
CQl0aWxlLT53aWR0aCA9IDEyODsKKwkJdGlsZS0+c2l6ZSA9IDExOworCX0gZWxzZSBpZiAodGls
ZS0+dGlsaW5nID09IEk5MTVfVElMSU5HX1kgJiYKKwkJICAgSEFTXzEyOF9CWVRFX1lfVElMSU5H
KGk5MTUpKSB7CisJCXRpbGUtPmhlaWdodCA9IDMyOworCQl0aWxlLT53aWR0aCA9IDEyODsKKwkJ
dGlsZS0+c2l6ZSA9IDEyOworCX0gZWxzZSB7CisJCXRpbGUtPmhlaWdodCA9IDg7CisJCXRpbGUt
PndpZHRoID0gNTEyOworCQl0aWxlLT5zaXplID0gMTI7CisJfQorCisJaWYgKElOVEVMX0dFTihp
OTE1KSA8IDQpCisJCXJldHVybiA4MTkyIC8gdGlsZS0+d2lkdGg7CisJZWxzZSBpZiAoSU5URUxf
R0VOKGk5MTUpIDwgNykKKwkJcmV0dXJuIDEyOCAqIEk5NjVfRkVOQ0VfTUFYX1BJVENIX1ZBTCAv
IHRpbGUtPndpZHRoOworCWVsc2UKKwkJcmV0dXJuIDEyOCAqIEdFTjdfRkVOQ0VfTUFYX1BJVENI
X1ZBTCAvIHRpbGUtPndpZHRoOworfQorCiBzdGF0aWMgaW50IGlndF9wYXJ0aWFsX3RpbGluZyh2
b2lkICphcmcpCiB7CiAJY29uc3QgdW5zaWduZWQgaW50IG5yZWFsID0gMSA8PCAxMjsgLyogbGFy
Z2VzdCB0aWxlIHJvdyB4MiAqLwpAQCAtMjE5LDcgKzMzNiw3IEBAIHN0YXRpYyBpbnQgaWd0X3Bh
cnRpYWxfdGlsaW5nKHZvaWQgKmFyZykKIAkJdGlsZS5zd2l6emxlID0gSTkxNV9CSVRfNl9TV0la
WkxFX05PTkU7CiAJCXRpbGUudGlsaW5nID0gSTkxNV9USUxJTkdfTk9ORTsKIAotCQllcnIgPSBj
aGVja19wYXJ0aWFsX21hcHBpbmcob2JqLCAmdGlsZSwgZW5kKTsKKwkJZXJyID0gY2hlY2tfcGFy
dGlhbF9tYXBwaW5ncyhvYmosICZ0aWxlLCBlbmQpOwogCQlpZiAoZXJyICYmIGVyciAhPSAtRUlO
VFIpCiAJCQlnb3RvIG91dF91bmxvY2s7CiAJfQpAQCAtMjUzLDMxICszNzAsMTEgQEAgc3RhdGlj
IGludCBpZ3RfcGFydGlhbF90aWxpbmcodm9pZCAqYXJnKQogCQkgICAgdGlsZS5zd2l6emxlID09
IEk5MTVfQklUXzZfU1dJWlpMRV85XzEwXzE3KQogCQkJY29udGludWU7CiAKLQkJaWYgKElOVEVM
X0dFTihpOTE1KSA8PSAyKSB7Ci0JCQl0aWxlLmhlaWdodCA9IDE2OwotCQkJdGlsZS53aWR0aCA9
IDEyODsKLQkJCXRpbGUuc2l6ZSA9IDExOwotCQl9IGVsc2UgaWYgKHRpbGUudGlsaW5nID09IEk5
MTVfVElMSU5HX1kgJiYKLQkJCSAgIEhBU18xMjhfQllURV9ZX1RJTElORyhpOTE1KSkgewotCQkJ
dGlsZS5oZWlnaHQgPSAzMjsKLQkJCXRpbGUud2lkdGggPSAxMjg7Ci0JCQl0aWxlLnNpemUgPSAx
MjsKLQkJfSBlbHNlIHsKLQkJCXRpbGUuaGVpZ2h0ID0gODsKLQkJCXRpbGUud2lkdGggPSA1MTI7
Ci0JCQl0aWxlLnNpemUgPSAxMjsKLQkJfQotCi0JCWlmIChJTlRFTF9HRU4oaTkxNSkgPCA0KQot
CQkJbWF4X3BpdGNoID0gODE5MiAvIHRpbGUud2lkdGg7Ci0JCWVsc2UgaWYgKElOVEVMX0dFTihp
OTE1KSA8IDcpCi0JCQltYXhfcGl0Y2ggPSAxMjggKiBJOTY1X0ZFTkNFX01BWF9QSVRDSF9WQUwg
LyB0aWxlLndpZHRoOwotCQllbHNlCi0JCQltYXhfcGl0Y2ggPSAxMjggKiBHRU43X0ZFTkNFX01B
WF9QSVRDSF9WQUwgLyB0aWxlLndpZHRoOworCQltYXhfcGl0Y2ggPSBzZXR1cF90aWxlX3NpemUo
JnRpbGUsIGk5MTUpOwogCiAJCWZvciAocGl0Y2ggPSBtYXhfcGl0Y2g7IHBpdGNoOyBwaXRjaCA+
Pj0gMSkgewogCQkJdGlsZS5zdHJpZGUgPSB0aWxlLndpZHRoICogcGl0Y2g7Ci0JCQllcnIgPSBj
aGVja19wYXJ0aWFsX21hcHBpbmcob2JqLCAmdGlsZSwgZW5kKTsKKwkJCWVyciA9IGNoZWNrX3Bh
cnRpYWxfbWFwcGluZ3Mob2JqLCAmdGlsZSwgZW5kKTsKIAkJCWlmIChlcnIgPT0gLUVJTlRSKQog
CQkJCWdvdG8gbmV4dF90aWxpbmc7CiAJCQlpZiAoZXJyKQpAQCAtMjg1LDcgKzM4Miw3IEBAIHN0
YXRpYyBpbnQgaWd0X3BhcnRpYWxfdGlsaW5nKHZvaWQgKmFyZykKIAogCQkJaWYgKHBpdGNoID4g
MiAmJiBJTlRFTF9HRU4oaTkxNSkgPj0gNCkgewogCQkJCXRpbGUuc3RyaWRlID0gdGlsZS53aWR0
aCAqIChwaXRjaCAtIDEpOwotCQkJCWVyciA9IGNoZWNrX3BhcnRpYWxfbWFwcGluZyhvYmosICZ0
aWxlLCBlbmQpOworCQkJCWVyciA9IGNoZWNrX3BhcnRpYWxfbWFwcGluZ3Mob2JqLCAmdGlsZSwg
ZW5kKTsKIAkJCQlpZiAoZXJyID09IC1FSU5UUikKIAkJCQkJZ290byBuZXh0X3RpbGluZzsKIAkJ
CQlpZiAoZXJyKQpAQCAtMjk0LDcgKzM5MSw3IEBAIHN0YXRpYyBpbnQgaWd0X3BhcnRpYWxfdGls
aW5nKHZvaWQgKmFyZykKIAogCQkJaWYgKHBpdGNoIDwgbWF4X3BpdGNoICYmIElOVEVMX0dFTihp
OTE1KSA+PSA0KSB7CiAJCQkJdGlsZS5zdHJpZGUgPSB0aWxlLndpZHRoICogKHBpdGNoICsgMSk7
Ci0JCQkJZXJyID0gY2hlY2tfcGFydGlhbF9tYXBwaW5nKG9iaiwgJnRpbGUsIGVuZCk7CisJCQkJ
ZXJyID0gY2hlY2tfcGFydGlhbF9tYXBwaW5ncyhvYmosICZ0aWxlLCBlbmQpOwogCQkJCWlmIChl
cnIgPT0gLUVJTlRSKQogCQkJCQlnb3RvIG5leHRfdGlsaW5nOwogCQkJCWlmIChlcnIpCkBAIC0z
MDUsNyArNDAyLDcgQEAgc3RhdGljIGludCBpZ3RfcGFydGlhbF90aWxpbmcodm9pZCAqYXJnKQog
CQlpZiAoSU5URUxfR0VOKGk5MTUpID49IDQpIHsKIAkJCWZvcl9lYWNoX3ByaW1lX251bWJlcihw
aXRjaCwgbWF4X3BpdGNoKSB7CiAJCQkJdGlsZS5zdHJpZGUgPSB0aWxlLndpZHRoICogcGl0Y2g7
Ci0JCQkJZXJyID0gY2hlY2tfcGFydGlhbF9tYXBwaW5nKG9iaiwgJnRpbGUsIGVuZCk7CisJCQkJ
ZXJyID0gY2hlY2tfcGFydGlhbF9tYXBwaW5ncyhvYmosICZ0aWxlLCBlbmQpOwogCQkJCWlmIChl
cnIgPT0gLUVJTlRSKQogCQkJCQlnb3RvIG5leHRfdGlsaW5nOwogCQkJCWlmIChlcnIpCkBAIC0z
MjUsNiArNDIyLDk5IEBAIG5leHRfdGlsaW5nOiA7CiAJcmV0dXJuIGVycjsKIH0KIAorc3RhdGlj
IGludCBpZ3Rfc21va2VfdGlsaW5nKHZvaWQgKmFyZykKK3sKKwljb25zdCB1bnNpZ25lZCBpbnQg
bnJlYWwgPSAxIDw8IDEyOyAvKiBsYXJnZXN0IHRpbGUgcm93IHgyICovCisJc3RydWN0IGRybV9p
OTE1X3ByaXZhdGUgKmk5MTUgPSBhcmc7CisJc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9i
ajsKKwlpbnRlbF93YWtlcmVmX3Qgd2FrZXJlZjsKKwlJOTE1X1JORF9TVEFURShwcm5nKTsKKwl1
bnNpZ25lZCBsb25nIGNvdW50OworCUlHVF9USU1FT1VUKGVuZCk7CisJaW50IGVycjsKKworCS8q
CisJICogaWd0X3BhcnRpYWxfdGlsaW5nKCkgZG9lcyBhbiBleGhhc3RpdmUgY2hlY2sgb2YgcGFy
dGlhbCB0aWxpbmcKKwkgKiBjaHVua2luZywgYnV0IHdpbGwgdW5kb3VidGFibHkgcnVuIG91dCBv
ZiB0aW1lLiBIZXJlLCB3ZSBkbyBhCisJICogcmFuZG9taXNlZCBzZWFyY2ggYW5kIGhvcGUgb3Zl
ciBtYW55IHJ1bnMgb2YgMXMgd2l0aCBkaWZmZXJlbnQKKwkgKiBzZWVkcyB3ZSB3aWxsIGRvIGEg
dGhvcm91Z2ggY2hlY2suCisJICoKKwkgKiBSZW1lbWJlciB0byBsb29rIGF0IHRoZSBzdF9zZWVk
IGlmIHdlIHNlZSBhIGZsaXAtZmxvcCBpbiBCQVQhCisJICovCisKKwlpZiAoaTkxNS0+cXVpcmtz
ICYgUVVJUktfUElOX1NXSVpaTEVEX1BBR0VTKQorCQlyZXR1cm4gMDsKKworCW9iaiA9IGh1Z2Vf
Z2VtX29iamVjdChpOTE1LAorCQkJICAgICAgbnJlYWwgPDwgUEFHRV9TSElGVCwKKwkJCSAgICAg
ICgxICsgbmV4dF9wcmltZV9udW1iZXIoaTkxNS0+Z2d0dC52bS50b3RhbCA+PiBQQUdFX1NISUZU
KSkgPDwgUEFHRV9TSElGVCk7CisJaWYgKElTX0VSUihvYmopKQorCQlyZXR1cm4gUFRSX0VSUihv
YmopOworCisJZXJyID0gaTkxNV9nZW1fb2JqZWN0X3Bpbl9wYWdlcyhvYmopOworCWlmIChlcnIp
IHsKKwkJcHJfZXJyKCJGYWlsZWQgdG8gYWxsb2NhdGUgJXUgcGFnZXMgKCVsdSB0b3RhbCksIGVy
cj0lZFxuIiwKKwkJICAgICAgIG5yZWFsLCBvYmotPmJhc2Uuc2l6ZSAvIFBBR0VfU0laRSwgZXJy
KTsKKwkJZ290byBvdXQ7CisJfQorCisJbXV0ZXhfbG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9tdXRl
eCk7CisJd2FrZXJlZiA9IGludGVsX3J1bnRpbWVfcG1fZ2V0KCZpOTE1LT5ydW50aW1lX3BtKTsK
KworCWNvdW50ID0gMDsKKwlkbyB7CisJCXN0cnVjdCB0aWxlIHRpbGU7CisKKwkJdGlsZS50aWxp
bmcgPQorCQkJaTkxNV9wcmFuZG9tX3UzMl9tYXhfc3RhdGUoSTkxNV9USUxJTkdfWSArIDEsICZw
cm5nKTsKKwkJc3dpdGNoICh0aWxlLnRpbGluZykgeworCQljYXNlIEk5MTVfVElMSU5HX05PTkU6
CisJCQl0aWxlLmhlaWdodCA9IDE7CisJCQl0aWxlLndpZHRoID0gMTsKKwkJCXRpbGUuc2l6ZSA9
IDA7CisJCQl0aWxlLnN0cmlkZSA9IDA7CisJCQl0aWxlLnN3aXp6bGUgPSBJOTE1X0JJVF82X1NX
SVpaTEVfTk9ORTsKKwkJCWJyZWFrOworCisJCWNhc2UgSTkxNV9USUxJTkdfWDoKKwkJCXRpbGUu
c3dpenpsZSA9IGk5MTUtPm1tLmJpdF82X3N3aXp6bGVfeDsKKwkJCWJyZWFrOworCQljYXNlIEk5
MTVfVElMSU5HX1k6CisJCQl0aWxlLnN3aXp6bGUgPSBpOTE1LT5tbS5iaXRfNl9zd2l6emxlX3k7
CisJCQlicmVhazsKKwkJfQorCisJCWlmICh0aWxlLnN3aXp6bGUgPT0gSTkxNV9CSVRfNl9TV0la
WkxFXzlfMTcgfHwKKwkJICAgIHRpbGUuc3dpenpsZSA9PSBJOTE1X0JJVF82X1NXSVpaTEVfOV8x
MF8xNykKKwkJCWNvbnRpbnVlOworCisJCWlmICh0aWxlLnRpbGluZyAhPSBJOTE1X1RJTElOR19O
T05FKSB7CisJCQl1bnNpZ25lZCBpbnQgbWF4X3BpdGNoID0gc2V0dXBfdGlsZV9zaXplKCZ0aWxl
LCBpOTE1KTsKKworCQkJdGlsZS5zdHJpZGUgPQorCQkJCWk5MTVfcHJhbmRvbV91MzJfbWF4X3N0
YXRlKG1heF9waXRjaCwgJnBybmcpOworCQkJdGlsZS5zdHJpZGUgPSAoMSArIHRpbGUuc3RyaWRl
KSAqIHRpbGUud2lkdGg7CisJCQlpZiAoSU5URUxfR0VOKGk5MTUpIDwgNCkKKwkJCQl0aWxlLnN0
cmlkZSA9IHJvdW5kZG93bl9wb3dfb2ZfdHdvKHRpbGUuc3RyaWRlKTsKKwkJfQorCisJCWVyciA9
IGNoZWNrX3BhcnRpYWxfbWFwcGluZyhvYmosICZ0aWxlLCAmcHJuZyk7CisJCWlmIChlcnIpCisJ
CQlicmVhazsKKworCQljb3VudCsrOworCX0gd2hpbGUgKCFfX2lndF90aW1lb3V0KGVuZCwgTlVM
TCkpOworCisJcHJfaW5mbygiJXM6IENvbXBsZXRlZCAlbHUgdHJpYWxzXG4iLCBfX2Z1bmNfXywg
Y291bnQpOworCisJaW50ZWxfcnVudGltZV9wbV9wdXQoJmk5MTUtPnJ1bnRpbWVfcG0sIHdha2Vy
ZWYpOworCW11dGV4X3VubG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CisJaTkxNV9nZW1f
b2JqZWN0X3VucGluX3BhZ2VzKG9iaik7CitvdXQ6CisJaTkxNV9nZW1fb2JqZWN0X3B1dChvYmop
OworCXJldHVybiBlcnI7Cit9CisKIHN0YXRpYyBpbnQgbWFrZV9vYmpfYnVzeShzdHJ1Y3QgZHJt
X2k5MTVfZ2VtX29iamVjdCAqb2JqKQogewogCXN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1
ID0gdG9faTkxNShvYmotPmJhc2UuZGV2KTsKQEAgLTUxNSw2ICs3MDUsNyBAQCBpbnQgaTkxNV9n
ZW1fbW1hbl9saXZlX3NlbGZ0ZXN0cyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKIHsK
IAlzdGF0aWMgY29uc3Qgc3RydWN0IGk5MTVfc3VidGVzdCB0ZXN0c1tdID0gewogCQlTVUJURVNU
KGlndF9wYXJ0aWFsX3RpbGluZyksCisJCVNVQlRFU1QoaWd0X3Ntb2tlX3RpbGluZyksCiAJCVNV
QlRFU1QoaWd0X21tYXBfb2Zmc2V0X2V4aGF1c3Rpb24pLAogCX07CiAKLS0gCjIuMjMuMAoKX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1h
aWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMu
ZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 8C59FB0DDC
	for <lists+intel-gfx@lfdr.de>; Thu, 12 Sep 2019 13:32:53 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id E0FDD6ECD0;
	Thu, 12 Sep 2019 11:32:51 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 866A86ECD0
 for <intel-gfx@lists.freedesktop.org>; Thu, 12 Sep 2019 11:32:50 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18463199-1500050 
 for multiple; Thu, 12 Sep 2019 12:32:41 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Thu, 12 Sep 2019 12:32:33 +0100
Message-Id: <20190912113233.14910-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20190911163815.11430-1-chris@chris-wilson.co.uk>
References: <20190911163815.11430-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v7] drm/i915/pmu: Use GT parked for estimating
 RC6 while asleep
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

QXMgd2UgdHJhY2sgd2hlbiB3ZSBwdXQgdGhlIEdUIGRldmljZSB0byBzbGVlcCB1cG9uIGlkbGlu
Zywgd2UgY2FuIHVzZQp0aGF0IGNhbGxiYWNrIHRvIHNhbXBsZSB0aGUgY3VycmVudCByYzYgY291
bnRlcnMgYW5kIHJlY29yZCB0aGUKdGltZXN0YW1wIGZvciBlc3RpbWF0aW5nIHNhbXBsZXMgYWZ0
ZXIgdGhhdCBwb2ludCB3aGlsZSBhc2xlZXAuCgp2MjogU3RpY2sgdG8gdXNpbmcga3RpbWVfdAp2
MzogVHJhY2sgdXNlcl93YWtlcmVmcyB0aGF0IGludGVyZmVyZSB3aXRoIHRoZSBuZXcKaW50ZWxf
Z3RfcG1fd2FpdF9mb3JfaWRsZQp2NDogTm8gbmVlZCBmb3IgcGFya2VkL3VucGFya2VkIGVzdGlt
YXRpb24gaWYgIUNPTkZJR19QTQp2NTogS2VlcCB0aW1lciBwYXJrL3VucGFyayBsb2dpYyBhcyB3
YXMKdjY6IFJlZmFjdG9yIGR1cGxpY2F0ZWQgZXN0aW1hdGUvdXBkYXRlIHJjNiBsb2dpYwp2Nzog
UHVsbCBpbnRlbF9nZXRfcG1fZ2V0X2lmX2F3YWtlKCkgb3V0IGZyb20gdGhlIHBtdS0+bG9jay4K
CkJ1Z3ppbGxhOiBodHRwczovL2J1Z3MuZnJlZWRlc2t0b3Aub3JnL3Nob3dfYnVnLmNnaT9pZD0x
MDUwMTAKU2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28u
dWs+CkNjOiBUdnJ0a28gVXJzdWxpbiA8dHZydGtvLnVyc3VsaW5AaW50ZWwuY29tPgotLS0KIGRy
aXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9wbS5jICAgfCAgMjIgKysKIGRyaXZlcnMv
Z3B1L2RybS9pOTE1L2d0L2ludGVsX2d0X3R5cGVzLmggfCAgIDEgKwogZHJpdmVycy9ncHUvZHJt
L2k5MTUvaTkxNV9kZWJ1Z2ZzLmMgICAgICB8ICAyMiArLQogZHJpdmVycy9ncHUvZHJtL2k5MTUv
aTkxNV9wbXUuYyAgICAgICAgICB8IDI0NCArKysrKysrKysrKysrLS0tLS0tLS0tLQogZHJpdmVy
cy9ncHUvZHJtL2k5MTUvaTkxNV9wbXUuaCAgICAgICAgICB8ICAgNCArLQogNSBmaWxlcyBjaGFu
Z2VkLCAxNzEgaW5zZXJ0aW9ucygrKSwgMTIyIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9wbS5jIGIvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ2VtL2k5MTVfZ2VtX3BtLmMKaW5kZXggM2JkNzY0MTA0ZDQxLi5hMTFhZDRkOTE0Y2EgMTAw
NjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9wbS5jCisrKyBiL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9wbS5jCkBAIC0xNDEsNiArMTQxLDI0IEBA
IGJvb2wgaTkxNV9nZW1fbG9hZF9wb3dlcl9jb250ZXh0KHN0cnVjdCBkcm1faTkxNV9wcml2YXRl
ICppOTE1KQogCXJldHVybiBzd2l0Y2hfdG9fa2VybmVsX2NvbnRleHRfc3luYygmaTkxNS0+Z3Qp
OwogfQogCitzdGF0aWMgdm9pZCB1c2VyX2ZvcmNld2FrZShzdHJ1Y3QgaW50ZWxfZ3QgKmd0LCBi
b29sIHN1c3BlbmQpCit7CisJaW50IGNvdW50ID0gYXRvbWljX3JlYWQoJmd0LT51c2VyX3dha2Vy
ZWYpOworCisJLyogSW5zaWRlIHN1c3BlbmQvcmVzdW1lIHNvIHNpbmdsZSB0aHJlYWRlZCwgbm8g
cmFjZXMgdG8gd29ycnkgYWJvdXQuICovCisJaWYgKGxpa2VseSghY291bnQpKQorCQlyZXR1cm47
CisKKwlpbnRlbF9ndF9wbV9nZXQoZ3QpOworCWlmIChzdXNwZW5kKSB7CisJCUdFTV9CVUdfT04o
Y291bnQgPiBhdG9taWNfcmVhZCgmZ3QtPndha2VyZWYuY291bnQpKTsKKwkJYXRvbWljX3N1Yihj
b3VudCwgJmd0LT53YWtlcmVmLmNvdW50KTsKKwl9IGVsc2UgeworCQlhdG9taWNfYWRkKGNvdW50
LCAmZ3QtPndha2VyZWYuY291bnQpOworCX0KKwlpbnRlbF9ndF9wbV9wdXQoZ3QpOworfQorCiB2
b2lkIGk5MTVfZ2VtX3N1c3BlbmQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCiB7CiAJ
R0VNX1RSQUNFKCJcbiIpOwpAQCAtMTQ4LDYgKzE2Niw4IEBAIHZvaWQgaTkxNV9nZW1fc3VzcGVu
ZChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKIAlpbnRlbF93YWtlcmVmX2F1dG8oJmk5
MTUtPmdndHQudXNlcmZhdWx0X3dha2VyZWYsIDApOwogCWZsdXNoX3dvcmtxdWV1ZShpOTE1LT53
cSk7CiAKKwl1c2VyX2ZvcmNld2FrZSgmaTkxNS0+Z3QsIHRydWUpOworCiAJbXV0ZXhfbG9jaygm
aTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CiAKIAkvKgpAQCAtMjU5LDYgKzI3OSw4IEBAIHZvaWQg
aTkxNV9nZW1fcmVzdW1lKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQogCWlmICghaTkx
NV9nZW1fbG9hZF9wb3dlcl9jb250ZXh0KGk5MTUpKQogCQlnb3RvIGVycl93ZWRnZWQ7CiAKKwl1
c2VyX2ZvcmNld2FrZSgmaTkxNS0+Z3QsIGZhbHNlKTsKKwogb3V0X3VubG9jazoKIAlpbnRlbF91
bmNvcmVfZm9yY2V3YWtlX3B1dCgmaTkxNS0+dW5jb3JlLCBGT1JDRVdBS0VfQUxMKTsKIAltdXRl
eF91bmxvY2soJmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9n
cHUvZHJtL2k5MTUvZ3QvaW50ZWxfZ3RfdHlwZXMuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0
L2ludGVsX2d0X3R5cGVzLmgKaW5kZXggZGMyOTVjMTk2ZDExLi4zMDM5Y2VmNjRiMTEgMTAwNjQ0
Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2d0X3R5cGVzLmgKKysrIGIvZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZ3RfdHlwZXMuaApAQCAtNTAsNiArNTAsNyBAQCBz
dHJ1Y3QgaW50ZWxfZ3QgewogCX0gdGltZWxpbmVzOwogCiAJc3RydWN0IGludGVsX3dha2VyZWYg
d2FrZXJlZjsKKwlhdG9taWNfdCB1c2VyX3dha2VyZWY7CiAKIAlzdHJ1Y3QgbGlzdF9oZWFkIGNs
b3NlZF92bWE7CiAJc3BpbmxvY2tfdCBjbG9zZWRfbG9jazsgLyogZ3VhcmRzIHRoZSBsaXN0IG9m
IGNsb3NlZF92bWEgKi8KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZGVi
dWdmcy5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kZWJ1Z2ZzLmMKaW5kZXggZTU4MzUz
MzdmMDIyLi5mM2FlNTI1Yjc3YzAgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5
MTVfZGVidWdmcy5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZGVidWdmcy5jCkBA
IC0zOTk1LDEzICszOTk1LDEyIEBAIHN0YXRpYyBpbnQgaTkxNV9zc2V1X3N0YXR1cyhzdHJ1Y3Qg
c2VxX2ZpbGUgKm0sIHZvaWQgKnVudXNlZCkKIHN0YXRpYyBpbnQgaTkxNV9mb3JjZXdha2Vfb3Bl
bihzdHJ1Y3QgaW5vZGUgKmlub2RlLCBzdHJ1Y3QgZmlsZSAqZmlsZSkKIHsKIAlzdHJ1Y3QgZHJt
X2k5MTVfcHJpdmF0ZSAqaTkxNSA9IGlub2RlLT5pX3ByaXZhdGU7CisJc3RydWN0IGludGVsX2d0
ICpndCA9ICZpOTE1LT5ndDsKIAotCWlmIChJTlRFTF9HRU4oaTkxNSkgPCA2KQotCQlyZXR1cm4g
MDsKLQotCWZpbGUtPnByaXZhdGVfZGF0YSA9Ci0JCSh2b2lkICopKHVpbnRwdHJfdClpbnRlbF9y
dW50aW1lX3BtX2dldCgmaTkxNS0+cnVudGltZV9wbSk7Ci0JaW50ZWxfdW5jb3JlX2ZvcmNld2Fr
ZV91c2VyX2dldCgmaTkxNS0+dW5jb3JlKTsKKwlhdG9taWNfaW5jKCZndC0+dXNlcl93YWtlcmVm
KTsKKwlpbnRlbF9ndF9wbV9nZXQoZ3QpOworCWlmIChJTlRFTF9HRU4oaTkxNSkgPj0gNikKKwkJ
aW50ZWxfdW5jb3JlX2ZvcmNld2FrZV91c2VyX2dldChndC0+dW5jb3JlKTsKIAogCXJldHVybiAw
OwogfQpAQCAtNDAwOSwxMyArNDAwOCwxMiBAQCBzdGF0aWMgaW50IGk5MTVfZm9yY2V3YWtlX29w
ZW4oc3RydWN0IGlub2RlICppbm9kZSwgc3RydWN0IGZpbGUgKmZpbGUpCiBzdGF0aWMgaW50IGk5
MTVfZm9yY2V3YWtlX3JlbGVhc2Uoc3RydWN0IGlub2RlICppbm9kZSwgc3RydWN0IGZpbGUgKmZp
bGUpCiB7CiAJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUgPSBpbm9kZS0+aV9wcml2YXRl
OworCXN0cnVjdCBpbnRlbF9ndCAqZ3QgPSAmaTkxNS0+Z3Q7CiAKLQlpZiAoSU5URUxfR0VOKGk5
MTUpIDwgNikKLQkJcmV0dXJuIDA7Ci0KLQlpbnRlbF91bmNvcmVfZm9yY2V3YWtlX3VzZXJfcHV0
KCZpOTE1LT51bmNvcmUpOwotCWludGVsX3J1bnRpbWVfcG1fcHV0KCZpOTE1LT5ydW50aW1lX3Bt
LAotCQkJICAgICAoaW50ZWxfd2FrZXJlZl90KSh1aW50cHRyX3QpZmlsZS0+cHJpdmF0ZV9kYXRh
KTsKKwlpZiAoSU5URUxfR0VOKGk5MTUpID49IDYpCisJCWludGVsX3VuY29yZV9mb3JjZXdha2Vf
dXNlcl9wdXQoJmk5MTUtPnVuY29yZSk7CisJaW50ZWxfZ3RfcG1fcHV0KGd0KTsKKwlhdG9taWNf
ZGVjKCZndC0+dXNlcl93YWtlcmVmKTsKIAogCXJldHVybiAwOwogfQpkaWZmIC0tZ2l0IGEvZHJp
dmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wbXUuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVf
cG11LmMKaW5kZXggOGUyNTFlNzE5MzkwLi5lNjM2NDliODY5MTUgMTAwNjQ0Ci0tLSBhL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L2k5MTVfcG11LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkx
NV9wbXUuYwpAQCAtMTE2LDIyICsxMTYsMTI0IEBAIHN0YXRpYyBib29sIHBtdV9uZWVkc190aW1l
cihzdHJ1Y3QgaTkxNV9wbXUgKnBtdSwgYm9vbCBncHVfYWN0aXZlKQogCXJldHVybiBlbmFibGU7
CiB9CiAKLXZvaWQgaTkxNV9wbXVfZ3RfcGFya2VkKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpp
OTE1KQorc3RhdGljIHU2NCBfX2dldF9yYzYoY29uc3Qgc3RydWN0IGludGVsX2d0ICpndCkKIHsK
KwlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSA9IGd0LT5pOTE1OworCXU2NCB2YWw7CisK
Kwl2YWwgPSBpbnRlbF9yYzZfcmVzaWRlbmN5X25zKGk5MTUsCisJCQkJICAgICBJU19WQUxMRVlW
SUVXKGk5MTUpID8KKwkJCQkgICAgIFZMVl9HVF9SRU5ERVJfUkM2IDoKKwkJCQkgICAgIEdFTjZf
R1RfR0ZYX1JDNik7CisKKwlpZiAoSEFTX1JDNnAoaTkxNSkpCisJCXZhbCArPSBpbnRlbF9yYzZf
cmVzaWRlbmN5X25zKGk5MTUsIEdFTjZfR1RfR0ZYX1JDNnApOworCisJaWYgKEhBU19SQzZwcChp
OTE1KSkKKwkJdmFsICs9IGludGVsX3JjNl9yZXNpZGVuY3lfbnMoaTkxNSwgR0VONl9HVF9HRlhf
UkM2cHApOworCisJcmV0dXJuIHZhbDsKK30KKworI2lmIElTX0VOQUJMRUQoQ09ORklHX1BNKQor
CitzdGF0aWMgaW5saW5lIHM2NCBrdGltZV9zaW5jZShjb25zdCBrdGltZV90IGt0KQoreworCXJl
dHVybiBrdGltZV90b19ucyhrdGltZV9zdWIoa3RpbWVfZ2V0KCksIGt0KSk7Cit9CisKK3N0YXRp
YyB1NjQgX19wbXVfZXN0aW1hdGVfcmM2KHN0cnVjdCBpOTE1X3BtdSAqcG11KQoreworCXU2NCB2
YWw7CisKKwl2YWwgPSBrdGltZV9zaW5jZShwbXUtPnNsZWVwX2xhc3QpOworCXZhbCArPSBwbXUt
PnNhbXBsZVtfX0k5MTVfU0FNUExFX1JDNl0uY3VyOworCisJcG11LT5zYW1wbGVbX19JOTE1X1NB
TVBMRV9SQzZfRVNUSU1BVEVEXS5jdXIgPSB2YWw7CisKKwlyZXR1cm4gdmFsOworfQorCitzdGF0
aWMgdTY0IF9fcG11X3VwZGF0ZV9yYzYoc3RydWN0IGk5MTVfcG11ICpwbXUsIHU2NCB2YWwpCit7
CisJaWYgKHZhbCA+PSBwbXUtPnNhbXBsZVtfX0k5MTVfU0FNUExFX1JDNl9FU1RJTUFURURdLmN1
cikgeworCQlwbXUtPnNhbXBsZVtfX0k5MTVfU0FNUExFX1JDNl9FU1RJTUFURURdLmN1ciA9IDA7
CisJCXBtdS0+c2FtcGxlW19fSTkxNV9TQU1QTEVfUkM2XS5jdXIgPSB2YWw7CisJfSBlbHNlIHsK
KwkJdmFsID0gcG11LT5zYW1wbGVbX19JOTE1X1NBTVBMRV9SQzZfRVNUSU1BVEVEXS5jdXI7CisJ
fQorCisJcmV0dXJuIHZhbDsKK30KKworc3RhdGljIHU2NCBnZXRfcmM2KHN0cnVjdCBpbnRlbF9n
dCAqZ3QpCit7CisJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUgPSBndC0+aTkxNTsKIAlz
dHJ1Y3QgaTkxNV9wbXUgKnBtdSA9ICZpOTE1LT5wbXU7CisJdW5zaWduZWQgbG9uZyBmbGFnczsK
Kwl1NjQgdmFsOwogCi0JaWYgKCFwbXUtPmJhc2UuZXZlbnRfaW5pdCkKLQkJcmV0dXJuOworCXZh
bCA9IDA7CisJaWYgKGludGVsX2d0X3BtX2dldF9pZl9hd2FrZShndCkpIHsKKwkJdmFsID0gX19n
ZXRfcmM2KGd0KTsKKwkJaW50ZWxfZ3RfcG1fcHV0KGd0KTsKKwl9CiAKLQlzcGluX2xvY2tfaXJx
KCZwbXUtPmxvY2spOwotCS8qCi0JICogU2lnbmFsIHNhbXBsaW5nIHRpbWVyIHRvIHN0b3AgaWYg
b25seSBlbmdpbmUgZXZlbnRzIGFyZSBlbmFibGVkIGFuZAotCSAqIEdQVSB3ZW50IGlkbGUuCi0J
ICovCi0JcG11LT50aW1lcl9lbmFibGVkID0gcG11X25lZWRzX3RpbWVyKHBtdSwgZmFsc2UpOwot
CXNwaW5fdW5sb2NrX2lycSgmcG11LT5sb2NrKTsKKwlzcGluX2xvY2tfaXJxc2F2ZSgmcG11LT5s
b2NrLCBmbGFncyk7CisKKwlpZiAodmFsKQorCQkvKgorCQkgKiBJZiB3ZSBhcmUgY29taW5nIGJh
Y2sgZnJvbSBiZWluZyBydW50aW1lIHN1c3BlbmRlZCB3ZSBtdXN0CisJCSAqIGJlIGNhcmVmdWwg
bm90IHRvIHJlcG9ydCBhIGxhcmdlciB2YWx1ZSB0aGFuIHJldHVybmVkCisJCSAqIHByZXZpb3Vz
bHkuCisJCSAqLworCQl2YWwgPSBfX3BtdV91cGRhdGVfcmM2KHBtdSwgdmFsKTsKKwllbHNlCisJ
CS8qCisJCSAqIFdlIHdlcmUgcnVudGltZSBzdXNwZW5kZWQuCisJCSAqCisJCSAqIFJlcG9ydCB0
aGUgZGVsdGEgZnJvbSB3aGVuIHRoZSBkZXZpY2Ugd2FzIHN1c3BlbmRlZCB0byBub3csCisJCSAq
IG9uIHRvcCBvZiB0aGUgbGFzdCBrbm93biByZWFsIHZhbHVlLCBhcyB0aGUgYXBwcm94aW1hdGVk
IFJDNgorCQkgKiBjb3VudGVyIHZhbHVlLgorCQkgKi8KKwkJdmFsID0gX19wbXVfZXN0aW1hdGVf
cmM2KHBtdSk7CisKKwlzcGluX3VubG9ja19pcnFyZXN0b3JlKCZwbXUtPmxvY2ssIGZsYWdzKTsK
KworCXJldHVybiB2YWw7Cit9CisKK3N0YXRpYyB2b2lkIHBhcmtfcmM2KHN0cnVjdCBkcm1faTkx
NV9wcml2YXRlICppOTE1KQoreworCXN0cnVjdCBpOTE1X3BtdSAqcG11ID0gJmk5MTUtPnBtdTsK
KworCWlmIChwbXUtPmVuYWJsZSAmIGNvbmZpZ19lbmFibGVkX21hc2soSTkxNV9QTVVfUkM2X1JF
U0lERU5DWSkpCisJCV9fcG11X3VwZGF0ZV9yYzYocG11LCBfX2dldF9yYzYoJmk5MTUtPmd0KSk7
CisKKwlwbXUtPnNsZWVwX2xhc3QgPSBrdGltZV9nZXQoKTsKK30KKworc3RhdGljIHZvaWQgdW5w
YXJrX3JjNihzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKK3sKKwlzdHJ1Y3QgaTkxNV9w
bXUgKnBtdSA9ICZpOTE1LT5wbXU7CisKKwkvKiBFc3RpbWF0ZSBob3cgbG9uZyB3ZSBzbGVwdCBh
bmQgYWNjdW11bGF0ZSB0aGF0IGludG8gcmM2IGNvdW50ZXJzICovCisJaWYgKHBtdS0+ZW5hYmxl
ICYgY29uZmlnX2VuYWJsZWRfbWFzayhJOTE1X1BNVV9SQzZfUkVTSURFTkNZKSkKKwkJX19wbXVf
ZXN0aW1hdGVfcmM2KHBtdSk7Cit9CisKKyNlbHNlCisKK3N0YXRpYyB1NjQgZ2V0X3JjNihzdHJ1
Y3QgaW50ZWxfZ3QgKmd0KQoreworCXJldHVybiBfX2dldF9yYzYoZ3QpOwogfQogCitzdGF0aWMg
dm9pZCBwYXJrX3JjNihzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkge307CitzdGF0aWMg
dm9pZCB1bnBhcmtfcmM2KHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KSB7fTsKKworI2Vu
ZGlmCisKIHN0YXRpYyB2b2lkIF9faTkxNV9wbXVfbWF5YmVfc3RhcnRfdGltZXIoc3RydWN0IGk5
MTVfcG11ICpwbXUpCiB7CiAJaWYgKCFwbXUtPnRpbWVyX2VuYWJsZWQgJiYgcG11X25lZWRzX3Rp
bWVyKHBtdSwgdHJ1ZSkpIHsKQEAgLTE0Myw2ICsyNDUsMjYgQEAgc3RhdGljIHZvaWQgX19pOTE1
X3BtdV9tYXliZV9zdGFydF90aW1lcihzdHJ1Y3QgaTkxNV9wbXUgKnBtdSkKIAl9CiB9CiAKK3Zv
aWQgaTkxNV9wbXVfZ3RfcGFya2VkKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQorewor
CXN0cnVjdCBpOTE1X3BtdSAqcG11ID0gJmk5MTUtPnBtdTsKKworCWlmICghcG11LT5iYXNlLmV2
ZW50X2luaXQpCisJCXJldHVybjsKKworCXNwaW5fbG9ja19pcnEoJnBtdS0+bG9jayk7CisKKwlw
YXJrX3JjNihpOTE1KTsKKworCS8qCisJICogU2lnbmFsIHNhbXBsaW5nIHRpbWVyIHRvIHN0b3Ag
aWYgb25seSBlbmdpbmUgZXZlbnRzIGFyZSBlbmFibGVkIGFuZAorCSAqIEdQVSB3ZW50IGlkbGUu
CisJICovCisJcG11LT50aW1lcl9lbmFibGVkID0gcG11X25lZWRzX3RpbWVyKHBtdSwgZmFsc2Up
OworCisJc3Bpbl91bmxvY2tfaXJxKCZwbXUtPmxvY2spOworfQorCiB2b2lkIGk5MTVfcG11X2d0
X3VucGFya2VkKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQogewogCXN0cnVjdCBpOTE1
X3BtdSAqcG11ID0gJmk5MTUtPnBtdTsKQEAgLTE1MSwxMCArMjczLDE0IEBAIHZvaWQgaTkxNV9w
bXVfZ3RfdW5wYXJrZWQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCiAJCXJldHVybjsK
IAogCXNwaW5fbG9ja19pcnEoJnBtdS0+bG9jayk7CisKIAkvKgogCSAqIFJlLWVuYWJsZSBzYW1w
bGluZyB0aW1lciB3aGVuIEdQVSBnb2VzIGFjdGl2ZS4KIAkgKi8KIAlfX2k5MTVfcG11X21heWJl
X3N0YXJ0X3RpbWVyKHBtdSk7CisKKwl1bnBhcmtfcmM2KGk5MTUpOworCiAJc3Bpbl91bmxvY2tf
aXJxKCZwbXUtPmxvY2spOwogfQogCkBAIC00MjYsMTA0ICs1NTIsNiBAQCBzdGF0aWMgaW50IGk5
MTVfcG11X2V2ZW50X2luaXQoc3RydWN0IHBlcmZfZXZlbnQgKmV2ZW50KQogCXJldHVybiAwOwog
fQogCi1zdGF0aWMgdTY0IF9fZ2V0X3JjNihzdHJ1Y3QgaW50ZWxfZ3QgKmd0KQotewotCXN0cnVj
dCBkcm1faTkxNV9wcml2YXRlICppOTE1ID0gZ3QtPmk5MTU7Ci0JdTY0IHZhbDsKLQotCXZhbCA9
IGludGVsX3JjNl9yZXNpZGVuY3lfbnMoaTkxNSwKLQkJCQkgICAgIElTX1ZBTExFWVZJRVcoaTkx
NSkgPwotCQkJCSAgICAgVkxWX0dUX1JFTkRFUl9SQzYgOgotCQkJCSAgICAgR0VONl9HVF9HRlhf
UkM2KTsKLQotCWlmIChIQVNfUkM2cChpOTE1KSkKLQkJdmFsICs9IGludGVsX3JjNl9yZXNpZGVu
Y3lfbnMoaTkxNSwgR0VONl9HVF9HRlhfUkM2cCk7Ci0KLQlpZiAoSEFTX1JDNnBwKGk5MTUpKQot
CQl2YWwgKz0gaW50ZWxfcmM2X3Jlc2lkZW5jeV9ucyhpOTE1LCBHRU42X0dUX0dGWF9SQzZwcCk7
Ci0KLQlyZXR1cm4gdmFsOwotfQotCi1zdGF0aWMgdTY0IGdldF9yYzYoc3RydWN0IGludGVsX2d0
ICpndCkKLXsKLSNpZiBJU19FTkFCTEVEKENPTkZJR19QTSkKLQlzdHJ1Y3QgZHJtX2k5MTVfcHJp
dmF0ZSAqaTkxNSA9IGd0LT5pOTE1OwotCXN0cnVjdCBpbnRlbF9ydW50aW1lX3BtICpycG0gPSAm
aTkxNS0+cnVudGltZV9wbTsKLQlzdHJ1Y3QgaTkxNV9wbXUgKnBtdSA9ICZpOTE1LT5wbXU7Ci0J
aW50ZWxfd2FrZXJlZl90IHdha2VyZWY7Ci0JdW5zaWduZWQgbG9uZyBmbGFnczsKLQl1NjQgdmFs
OwotCi0Jd2FrZXJlZiA9IGludGVsX3J1bnRpbWVfcG1fZ2V0X2lmX2luX3VzZShycG0pOwotCWlm
ICh3YWtlcmVmKSB7Ci0JCXZhbCA9IF9fZ2V0X3JjNihndCk7Ci0JCWludGVsX3J1bnRpbWVfcG1f
cHV0KHJwbSwgd2FrZXJlZik7Ci0KLQkJLyoKLQkJICogSWYgd2UgYXJlIGNvbWluZyBiYWNrIGZy
b20gYmVpbmcgcnVudGltZSBzdXNwZW5kZWQgd2UgbXVzdAotCQkgKiBiZSBjYXJlZnVsIG5vdCB0
byByZXBvcnQgYSBsYXJnZXIgdmFsdWUgdGhhbiByZXR1cm5lZAotCQkgKiBwcmV2aW91c2x5Lgot
CQkgKi8KLQotCQlzcGluX2xvY2tfaXJxc2F2ZSgmcG11LT5sb2NrLCBmbGFncyk7Ci0KLQkJaWYg
KHZhbCA+PSBwbXUtPnNhbXBsZVtfX0k5MTVfU0FNUExFX1JDNl9FU1RJTUFURURdLmN1cikgewot
CQkJcG11LT5zYW1wbGVbX19JOTE1X1NBTVBMRV9SQzZfRVNUSU1BVEVEXS5jdXIgPSAwOwotCQkJ
cG11LT5zYW1wbGVbX19JOTE1X1NBTVBMRV9SQzZdLmN1ciA9IHZhbDsKLQkJfSBlbHNlIHsKLQkJ
CXZhbCA9IHBtdS0+c2FtcGxlW19fSTkxNV9TQU1QTEVfUkM2X0VTVElNQVRFRF0uY3VyOwotCQl9
Ci0KLQkJc3Bpbl91bmxvY2tfaXJxcmVzdG9yZSgmcG11LT5sb2NrLCBmbGFncyk7Ci0JfSBlbHNl
IHsKLQkJc3RydWN0IGRldmljZSAqa2RldiA9IHJwbS0+a2RldjsKLQotCQkvKgotCQkgKiBXZSBh
cmUgcnVudGltZSBzdXNwZW5kZWQuCi0JCSAqCi0JCSAqIFJlcG9ydCB0aGUgZGVsdGEgZnJvbSB3
aGVuIHRoZSBkZXZpY2Ugd2FzIHN1c3BlbmRlZCB0byBub3csCi0JCSAqIG9uIHRvcCBvZiB0aGUg
bGFzdCBrbm93biByZWFsIHZhbHVlLCBhcyB0aGUgYXBwcm94aW1hdGVkIFJDNgotCQkgKiBjb3Vu
dGVyIHZhbHVlLgotCQkgKi8KLQkJc3Bpbl9sb2NrX2lycXNhdmUoJnBtdS0+bG9jaywgZmxhZ3Mp
OwotCi0JCS8qCi0JCSAqIEFmdGVyIHRoZSBhYm92ZSBicmFuY2ggaW50ZWxfcnVudGltZV9wbV9n
ZXRfaWZfaW5fdXNlIGZhaWxlZAotCQkgKiB0byBnZXQgdGhlIHJ1bnRpbWUgUE0gcmVmZXJlbmNl
IHdlIGNhbm5vdCBhc3N1bWUgd2UgYXJlIGluCi0JCSAqIHJ1bnRpbWUgc3VzcGVuZCBzaW5jZSB3
ZSBjYW4gZWl0aGVyOiBhKSByYWNlIHdpdGggY29taW5nIG91dAotCQkgKiBvZiBpdCBiZWZvcmUg
d2UgdG9vayB0aGUgcG93ZXIubG9jaywgb3IgYikgdGhlcmUgYXJlIG90aGVyCi0JCSAqIHN0YXRl
cyB0aGFuIHN1c3BlbmRlZCB3aGljaCBjYW4gYnJpbmcgdXMgaGVyZS4KLQkJICoKLQkJICogV2Ug
bmVlZCB0byBkb3VibGUtY2hlY2sgdGhhdCB3ZSBhcmUgaW5kZWVkIGN1cnJlbnRseSBydW50aW1l
Ci0JCSAqIHN1c3BlbmRlZCBhbmQgaWYgbm90IHdlIGNhbm5vdCBkbyBiZXR0ZXIgdGhhbiByZXBv
cnQgdGhlIGxhc3QKLQkJICoga25vd24gUkM2IHZhbHVlLgotCQkgKi8KLQkJaWYgKHBtX3J1bnRp
bWVfc3RhdHVzX3N1c3BlbmRlZChrZGV2KSkgewotCQkJdmFsID0gcG1fcnVudGltZV9zdXNwZW5k
ZWRfdGltZShrZGV2KTsKLQotCQkJaWYgKCFwbXUtPnNhbXBsZVtfX0k5MTVfU0FNUExFX1JDNl9F
U1RJTUFURURdLmN1cikKLQkJCQlwbXUtPnN1c3BlbmRlZF90aW1lX2xhc3QgPSB2YWw7Ci0KLQkJ
CXZhbCAtPSBwbXUtPnN1c3BlbmRlZF90aW1lX2xhc3Q7Ci0JCQl2YWwgKz0gcG11LT5zYW1wbGVb
X19JOTE1X1NBTVBMRV9SQzZdLmN1cjsKLQotCQkJcG11LT5zYW1wbGVbX19JOTE1X1NBTVBMRV9S
QzZfRVNUSU1BVEVEXS5jdXIgPSB2YWw7Ci0JCX0gZWxzZSBpZiAocG11LT5zYW1wbGVbX19JOTE1
X1NBTVBMRV9SQzZfRVNUSU1BVEVEXS5jdXIpIHsKLQkJCXZhbCA9IHBtdS0+c2FtcGxlW19fSTkx
NV9TQU1QTEVfUkM2X0VTVElNQVRFRF0uY3VyOwotCQl9IGVsc2UgewotCQkJdmFsID0gcG11LT5z
YW1wbGVbX19JOTE1X1NBTVBMRV9SQzZdLmN1cjsKLQkJfQotCi0JCXNwaW5fdW5sb2NrX2lycXJl
c3RvcmUoJnBtdS0+bG9jaywgZmxhZ3MpOwotCX0KLQotCXJldHVybiB2YWw7Ci0jZWxzZQotCXJl
dHVybiBfX2dldF9yYzYoZ3QpOwotI2VuZGlmCi19Ci0KIHN0YXRpYyB1NjQgX19pOTE1X3BtdV9l
dmVudF9yZWFkKHN0cnVjdCBwZXJmX2V2ZW50ICpldmVudCkKIHsKIAlzdHJ1Y3QgZHJtX2k5MTVf
cHJpdmF0ZSAqaTkxNSA9CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3Bt
dS5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wbXUuaAppbmRleCA0ZmM0ZjI0NzgzMDEu
LjA2N2RiYmYzYmRmZiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wbXUu
aAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3BtdS5oCkBAIC05Nyw5ICs5Nyw5IEBA
IHN0cnVjdCBpOTE1X3BtdSB7CiAJICovCiAJc3RydWN0IGk5MTVfcG11X3NhbXBsZSBzYW1wbGVb
X19JOTE1X05VTV9QTVVfU0FNUExFUlNdOwogCS8qKgotCSAqIEBzdXNwZW5kZWRfdGltZV9sYXN0
OiBDYWNoZWQgc3VzcGVuZCB0aW1lIGZyb20gUE0gY29yZS4KKwkgKiBAc2xlZXBfbGFzdDogTGFz
dCB0aW1lIEdUIHBhcmtlZCBmb3IgUkM2IGVzdGltYXRpb24uCiAJICovCi0JdTY0IHN1c3BlbmRl
ZF90aW1lX2xhc3Q7CisJa3RpbWVfdCBzbGVlcF9sYXN0OwogCS8qKgogCSAqIEBpOTE1X2F0dHI6
IE1lbW9yeSBibG9jayBob2xkaW5nIGRldmljZSBhdHRyaWJ1dGVzLgogCSAqLwotLSAKMi4yMy4w
CgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpJbnRlbC1n
ZnggbWFpbGluZyBsaXN0CkludGVsLWdmeEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9s
aXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9pbnRlbC1nZng=

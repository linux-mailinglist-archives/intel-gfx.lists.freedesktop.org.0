Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id BEF1E3C783F
	for <lists+intel-gfx@lfdr.de>; Tue, 13 Jul 2021 22:52:17 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 3B9BC6E145;
	Tue, 13 Jul 2021 20:52:06 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mail-wr1-x436.google.com (mail-wr1-x436.google.com
 [IPv6:2a00:1450:4864:20::436])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 4F4C26E135
 for <intel-gfx@lists.freedesktop.org>; Tue, 13 Jul 2021 20:52:04 +0000 (UTC)
Received: by mail-wr1-x436.google.com with SMTP id l7so375529wrv.7
 for <intel-gfx@lists.freedesktop.org>; Tue, 13 Jul 2021 13:52:04 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=ffwll.ch; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=d6vJ0OGqZpiT3A29ZkFJz5TvBIp+kuZrjC4J70b6PHg=;
 b=bRvq/W4ZyQGYHWuXW4hitq0pL0SqSO2A9+z8n/yci6J/+yDJ69AcjsoI9+BhX7z8aj
 XxkPVbTlVJtWTO+OeTkv7/SvzSc5RifWAv0meupC87ztJ5cY5VKiR5nCGtpk/v4TZ0YH
 5X9Zdspu31luew+g4+a+5UfyWS1Ew5f037Hss=
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=d6vJ0OGqZpiT3A29ZkFJz5TvBIp+kuZrjC4J70b6PHg=;
 b=uXIWS681wMpJ1JojXsFLnLyQIlTd7FS0HOd42BNPaxBgVOXjov74/wpE9nOrutcsid
 s161agHR8mpzLw2IcIndG3QTTPVMvO3w1LplM7kMHXF9LQAWaJsy5sZxLbfAkDIsyDny
 ueoNR1i2Q9RqgdUCiOGGdcqDPP+Ce9Ln/rQ/wp4Ch6Fv9GBYMZliPlLwGqCA45ewVWjv
 /8yMp7qTcJgoAZV/hPZxxRUM0Sqie1QAnR0q8tprkjqnov879mLO4tqAJSTukO7Xgb5O
 n7rjkithAmBEOCyDjBspCmCOjHqLg0Rs0XV4U16CTlfFNX2JVzCTWaLkYtJEflwPQj09
 tnkg==
X-Gm-Message-State: AOAM530wauk3/wwlu2qaNWM5B3QjJ3no/9iAlKaJmDJT8jmk/jOJCaro
 zMNxL7J+gnwrNnhGAPzK6yopvhIg7k/26Q==
X-Google-Smtp-Source: ABdhPJxW24ROEfIpznobZZbLSHG718drYGtMxOUayTai3FVE4gyWNsrJG5a8Evca0+k1DfKvySFPzw==
X-Received: by 2002:adf:fc50:: with SMTP id e16mr8313365wrs.31.1626209522993; 
 Tue, 13 Jul 2021 13:52:02 -0700 (PDT)
Received: from phenom.ffwll.local ([2a02:168:57f4:0:efd0:b9e5:5ae6:c2fa])
 by smtp.gmail.com with ESMTPSA id j10sm18642249wrt.35.2021.07.13.13.52.02
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Tue, 13 Jul 2021 13:52:02 -0700 (PDT)
From: Daniel Vetter <daniel.vetter@ffwll.ch>
To: Intel Graphics Development <intel-gfx@lists.freedesktop.org>
Date: Tue, 13 Jul 2021 22:51:53 +0200
Message-Id: <20210713205153.1896059-5-daniel.vetter@ffwll.ch>
X-Mailer: git-send-email 2.32.0
In-Reply-To: <20210713205153.1896059-1-daniel.vetter@ffwll.ch>
References: <20210713205153.1896059-1-daniel.vetter@ffwll.ch>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v4 4/4] drm/vgem: use shmem helpers
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Daniel Vetter <daniel.vetter@ffwll.ch>,
 DRI Development <dri-devel@lists.freedesktop.org>,
 Sumit Semwal <sumit.semwal@linaro.org>, Melissa Wen <melissa.srw@gmail.com>,
 John Stultz <john.stultz@linaro.org>, Thomas Zimmermann <tzimmermann@suse.de>,
 Daniel Vetter <daniel.vetter@intel.com>,
 Chris Wilson <chris@chris-wilson.co.uk>,
 =?UTF-8?q?Christian=20K=C3=B6nig?= <christian.koenig@amd.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

QXNpZGUgZnJvbSBkZWxldGluZyBsb3RzIG9mIGNvZGUgdGhlIHJlYWwgbW90aXZhdGlvbiBoZXJl
IGlzIHRvIHN3aXRjaAp0aGUgbW1hcCBvdmVyIHRvIFZNX1BGTk1BUCwgdG8gYmUgbW9yZSBjb25z
aXN0ZW50IHdpdGggd2hhdCByZWFsIGdwdQpkcml2ZXJzIGRvLiBUaGV5J3JlIGFsbCBWTV9QRk5N
UCwgd2hpY2ggbWVhbnMgZ2V0X3VzZXJfcGFnZXMgZG9lc24ndAp3b3JrLCBhbmQgZXZlbiBpZiB5
b3UgdHJ5IGFuZCB0aGVyZSdzIGEgc3RydWN0IHBhZ2UgYmVoaW5kIHRoYXQsCnRvdWNoaW5nIGl0
IGFuZCBtdWNraW5nIGFyb3VuZCB3aXRoIGl0cyByZWZjb3VudCBjYW4gdXBzZXQgZHJpdmVycwpy
ZWFsIGJhZC4KCnYyOiBSZXZpZXcgZnJvbSBUaG9tYXM6Ci0gc29ydCAjaW5jbHVkZQotIGRyb3Ag
bW9yZSBkZWFkIGNvZGUgdGhhdCBJIGRpZG4ndCBzcG90IHNvbWVob3cKCnYzOiBzZWxlY3QgRFJN
X0dFTV9TSE1FTV9IRUxQRVIgdG8gbWFrZSBpdCBidWlsZCAoaW50ZWwtZ2Z4LWNpKQoKdjQ6IEkg
Z290IHRyaWNrZWQgYnkgMGNmMmVmNDZjNmMwICgiZHJtL3NobWVtLWhlbHBlcjogVXNlIGNhY2hl
ZAptYXBwaW5ncyBieSBkZWZhdWx0IiksIGFuZCB3ZSBuZWVkIFdDIGluIHZnZW0gYmVjYXVzZSB2
Z2VtIGRvZXNuJ3QKaGF2ZSBleHBsaWNpdCBiZWdpbi9lbmQgY3B1IGFjY2VzcyBpb2N0bHMuCgpB
bHNvIGFkZCBhIGNvbW1lbnQgd2h5IGV4YWN0bHkgdmdlbSBoYXMgdG8gdXNlIHdjLgoKdjU6IERv
bid0IHNldCBvYmotPmJhc2UuZnVuY3MsIGl0IHdpbGwgZGVmYXVsdCB0byBkcm1fZ2VtX3NobWVt
X2Z1bmNzCihUaG9tYXMpCgp2NjogdmdlbSBhbHNvIG5lZWRzIGFuIE1NVSBmb3IgcmVtYXBwaW5n
CgpDYzogVGhvbWFzIFppbW1lcm1hbm4gPHR6aW1tZXJtYW5uQHN1c2UuZGU+CkFja2VkLWJ5OiBU
aG9tYXMgWmltbWVybWFubiA8dHppbW1lcm1hbm5Ac3VzZS5kZT4KQ2M6IEpvaG4gU3R1bHR6IDxq
b2huLnN0dWx0ekBsaW5hcm8ub3JnPgpDYzogU3VtaXQgU2Vtd2FsIDxzdW1pdC5zZW13YWxAbGlu
YXJvLm9yZz4KQ2M6ICJDaHJpc3RpYW4gS8O2bmlnIiA8Y2hyaXN0aWFuLmtvZW5pZ0BhbWQuY29t
PgpTaWduZWQtb2ZmLWJ5OiBEYW5pZWwgVmV0dGVyIDxkYW5pZWwudmV0dGVyQGludGVsLmNvbT4K
Q2M6IE1lbGlzc2EgV2VuIDxtZWxpc3NhLnNyd0BnbWFpbC5jb20+CkNjOiBDaHJpcyBXaWxzb24g
PGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vS2NvbmZpZyAg
ICAgICAgIHwgICA1ICstCiBkcml2ZXJzL2dwdS9kcm0vdmdlbS92Z2VtX2Rydi5jIHwgMzE1ICsr
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAyIGZpbGVzIGNoYW5nZWQsIDE1IGluc2Vy
dGlvbnMoKyksIDMwNSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0v
S2NvbmZpZyBiL2RyaXZlcnMvZ3B1L2RybS9LY29uZmlnCmluZGV4IDMxNGVlZmEzOTg5Mi4uMjhm
N2QyMDA2ZThiIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vS2NvbmZpZworKysgYi9kcml2
ZXJzL2dwdS9kcm0vS2NvbmZpZwpAQCAtMjcyLDcgKzI3Miw4IEBAIHNvdXJjZSAiZHJpdmVycy9n
cHUvZHJtL2ttYi9LY29uZmlnIgogCiBjb25maWcgRFJNX1ZHRU0KIAl0cmlzdGF0ZSAiVmlydHVh
bCBHRU0gcHJvdmlkZXIiCi0JZGVwZW5kcyBvbiBEUk0KKwlkZXBlbmRzIG9uIERSTSAmJiBNTVUK
KwlzZWxlY3QgRFJNX0dFTV9TSE1FTV9IRUxQRVIKIAloZWxwCiAJICBDaG9vc2UgdGhpcyBvcHRp
b24gdG8gZ2V0IGEgdmlydHVhbCBncmFwaGljcyBtZW1vcnkgbWFuYWdlciwKIAkgIGFzIHVzZWQg
YnkgTWVzYSdzIHNvZnR3YXJlIHJlbmRlcmVyIGZvciBlbmhhbmNlZCBwZXJmb3JtYW5jZS4KQEAg
LTI4MCw3ICsyODEsNyBAQCBjb25maWcgRFJNX1ZHRU0KIAogY29uZmlnIERSTV9WS01TCiAJdHJp
c3RhdGUgIlZpcnR1YWwgS01TIChFWFBFUklNRU5UQUwpIgotCWRlcGVuZHMgb24gRFJNCisJZGVw
ZW5kcyBvbiBEUk0gJiYgTU1VCiAJc2VsZWN0IERSTV9LTVNfSEVMUEVSCiAJc2VsZWN0IERSTV9H
RU1fU0hNRU1fSEVMUEVSCiAJc2VsZWN0IENSQzMyCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9k
cm0vdmdlbS92Z2VtX2Rydi5jIGIvZHJpdmVycy9ncHUvZHJtL3ZnZW0vdmdlbV9kcnYuYwppbmRl
eCBiZjM4YTdlMzE5ZDEuLmJhNDEwYmE2YjdmNyAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJt
L3ZnZW0vdmdlbV9kcnYuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vdmdlbS92Z2VtX2Rydi5jCkBA
IC0zOCw2ICszOCw3IEBACiAKICNpbmNsdWRlIDxkcm0vZHJtX2Rydi5oPgogI2luY2x1ZGUgPGRy
bS9kcm1fZmlsZS5oPgorI2luY2x1ZGUgPGRybS9kcm1fZ2VtX3NobWVtX2hlbHBlci5oPgogI2lu
Y2x1ZGUgPGRybS9kcm1faW9jdGwuaD4KICNpbmNsdWRlIDxkcm0vZHJtX21hbmFnZWQuaD4KICNp
bmNsdWRlIDxkcm0vZHJtX3ByaW1lLmg+CkBAIC01MCw4NyArNTEsMTEgQEAKICNkZWZpbmUgRFJJ
VkVSX01BSk9SCTEKICNkZWZpbmUgRFJJVkVSX01JTk9SCTAKIAotc3RhdGljIGNvbnN0IHN0cnVj
dCBkcm1fZ2VtX29iamVjdF9mdW5jcyB2Z2VtX2dlbV9vYmplY3RfZnVuY3M7Ci0KIHN0YXRpYyBz
dHJ1Y3QgdmdlbV9kZXZpY2UgewogCXN0cnVjdCBkcm1fZGV2aWNlIGRybTsKIAlzdHJ1Y3QgcGxh
dGZvcm1fZGV2aWNlICpwbGF0Zm9ybTsKIH0gKnZnZW1fZGV2aWNlOwogCi1zdGF0aWMgdm9pZCB2
Z2VtX2dlbV9mcmVlX29iamVjdChzdHJ1Y3QgZHJtX2dlbV9vYmplY3QgKm9iaikKLXsKLQlzdHJ1
Y3QgZHJtX3ZnZW1fZ2VtX29iamVjdCAqdmdlbV9vYmogPSB0b192Z2VtX2JvKG9iaik7Ci0KLQlr
dmZyZWUodmdlbV9vYmotPnBhZ2VzKTsKLQltdXRleF9kZXN0cm95KCZ2Z2VtX29iai0+cGFnZXNf
bG9jayk7Ci0KLQlpZiAob2JqLT5pbXBvcnRfYXR0YWNoKQotCQlkcm1fcHJpbWVfZ2VtX2Rlc3Ry
b3kob2JqLCB2Z2VtX29iai0+dGFibGUpOwotCi0JZHJtX2dlbV9vYmplY3RfcmVsZWFzZShvYmop
OwotCWtmcmVlKHZnZW1fb2JqKTsKLX0KLQotc3RhdGljIHZtX2ZhdWx0X3QgdmdlbV9nZW1fZmF1
bHQoc3RydWN0IHZtX2ZhdWx0ICp2bWYpCi17Ci0Jc3RydWN0IHZtX2FyZWFfc3RydWN0ICp2bWEg
PSB2bWYtPnZtYTsKLQlzdHJ1Y3QgZHJtX3ZnZW1fZ2VtX29iamVjdCAqb2JqID0gdm1hLT52bV9w
cml2YXRlX2RhdGE7Ci0JLyogV2UgZG9uJ3QgdXNlIHZtZi0+cGdvZmYgc2luY2UgdGhhdCBoYXMg
dGhlIGZha2Ugb2Zmc2V0ICovCi0JdW5zaWduZWQgbG9uZyB2YWRkciA9IHZtZi0+YWRkcmVzczsK
LQl2bV9mYXVsdF90IHJldCA9IFZNX0ZBVUxUX1NJR0JVUzsKLQlsb2ZmX3QgbnVtX3BhZ2VzOwot
CXBnb2ZmX3QgcGFnZV9vZmZzZXQ7Ci0JcGFnZV9vZmZzZXQgPSAodmFkZHIgLSB2bWEtPnZtX3N0
YXJ0KSA+PiBQQUdFX1NISUZUOwotCi0JbnVtX3BhZ2VzID0gRElWX1JPVU5EX1VQKG9iai0+YmFz
ZS5zaXplLCBQQUdFX1NJWkUpOwotCi0JaWYgKHBhZ2Vfb2Zmc2V0ID49IG51bV9wYWdlcykKLQkJ
cmV0dXJuIFZNX0ZBVUxUX1NJR0JVUzsKLQotCW11dGV4X2xvY2soJm9iai0+cGFnZXNfbG9jayk7
Ci0JaWYgKG9iai0+cGFnZXMpIHsKLQkJZ2V0X3BhZ2Uob2JqLT5wYWdlc1twYWdlX29mZnNldF0p
OwotCQl2bWYtPnBhZ2UgPSBvYmotPnBhZ2VzW3BhZ2Vfb2Zmc2V0XTsKLQkJcmV0ID0gMDsKLQl9
Ci0JbXV0ZXhfdW5sb2NrKCZvYmotPnBhZ2VzX2xvY2spOwotCWlmIChyZXQpIHsKLQkJc3RydWN0
IHBhZ2UgKnBhZ2U7Ci0KLQkJcGFnZSA9IHNobWVtX3JlYWRfbWFwcGluZ19wYWdlKAotCQkJCQlm
aWxlX2lub2RlKG9iai0+YmFzZS5maWxwKS0+aV9tYXBwaW5nLAotCQkJCQlwYWdlX29mZnNldCk7
Ci0JCWlmICghSVNfRVJSKHBhZ2UpKSB7Ci0JCQl2bWYtPnBhZ2UgPSBwYWdlOwotCQkJcmV0ID0g
MDsKLQkJfSBlbHNlIHN3aXRjaCAoUFRSX0VSUihwYWdlKSkgewotCQkJY2FzZSAtRU5PU1BDOgot
CQkJY2FzZSAtRU5PTUVNOgotCQkJCXJldCA9IFZNX0ZBVUxUX09PTTsKLQkJCQlicmVhazsKLQkJ
CWNhc2UgLUVCVVNZOgotCQkJCXJldCA9IFZNX0ZBVUxUX1JFVFJZOwotCQkJCWJyZWFrOwotCQkJ
Y2FzZSAtRUZBVUxUOgotCQkJY2FzZSAtRUlOVkFMOgotCQkJCXJldCA9IFZNX0ZBVUxUX1NJR0JV
UzsKLQkJCQlicmVhazsKLQkJCWRlZmF1bHQ6Ci0JCQkJV0FSTl9PTihQVFJfRVJSKHBhZ2UpKTsK
LQkJCQlyZXQgPSBWTV9GQVVMVF9TSUdCVVM7Ci0JCQkJYnJlYWs7Ci0JCX0KLQotCX0KLQlyZXR1
cm4gcmV0OwotfQotCi1zdGF0aWMgY29uc3Qgc3RydWN0IHZtX29wZXJhdGlvbnNfc3RydWN0IHZn
ZW1fZ2VtX3ZtX29wcyA9IHsKLQkuZmF1bHQgPSB2Z2VtX2dlbV9mYXVsdCwKLQkub3BlbiA9IGRy
bV9nZW1fdm1fb3BlbiwKLQkuY2xvc2UgPSBkcm1fZ2VtX3ZtX2Nsb3NlLAotfTsKLQogc3RhdGlj
IGludCB2Z2VtX29wZW4oc3RydWN0IGRybV9kZXZpY2UgKmRldiwgc3RydWN0IGRybV9maWxlICpm
aWxlKQogewogCXN0cnVjdCB2Z2VtX2ZpbGUgKnZmaWxlOwpAQCAtMTU5LDgxICs4NCw2IEBAIHN0
YXRpYyB2b2lkIHZnZW1fcG9zdGNsb3NlKHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsIHN0cnVjdCBk
cm1fZmlsZSAqZmlsZSkKIAlrZnJlZSh2ZmlsZSk7CiB9CiAKLXN0YXRpYyBzdHJ1Y3QgZHJtX3Zn
ZW1fZ2VtX29iamVjdCAqX192Z2VtX2dlbV9jcmVhdGUoc3RydWN0IGRybV9kZXZpY2UgKmRldiwK
LQkJCQkJCXVuc2lnbmVkIGxvbmcgc2l6ZSkKLXsKLQlzdHJ1Y3QgZHJtX3ZnZW1fZ2VtX29iamVj
dCAqb2JqOwotCWludCByZXQ7Ci0KLQlvYmogPSBremFsbG9jKHNpemVvZigqb2JqKSwgR0ZQX0tF
Uk5FTCk7Ci0JaWYgKCFvYmopCi0JCXJldHVybiBFUlJfUFRSKC1FTk9NRU0pOwotCi0Jb2JqLT5i
YXNlLmZ1bmNzID0gJnZnZW1fZ2VtX29iamVjdF9mdW5jczsKLQotCXJldCA9IGRybV9nZW1fb2Jq
ZWN0X2luaXQoZGV2LCAmb2JqLT5iYXNlLCByb3VuZHVwKHNpemUsIFBBR0VfU0laRSkpOwotCWlm
IChyZXQpIHsKLQkJa2ZyZWUob2JqKTsKLQkJcmV0dXJuIEVSUl9QVFIocmV0KTsKLQl9Ci0KLQlt
dXRleF9pbml0KCZvYmotPnBhZ2VzX2xvY2spOwotCi0JcmV0dXJuIG9iajsKLX0KLQotc3RhdGlj
IHZvaWQgX192Z2VtX2dlbV9kZXN0cm95KHN0cnVjdCBkcm1fdmdlbV9nZW1fb2JqZWN0ICpvYmop
Ci17Ci0JZHJtX2dlbV9vYmplY3RfcmVsZWFzZSgmb2JqLT5iYXNlKTsKLQlrZnJlZShvYmopOwot
fQotCi1zdGF0aWMgc3RydWN0IGRybV9nZW1fb2JqZWN0ICp2Z2VtX2dlbV9jcmVhdGUoc3RydWN0
IGRybV9kZXZpY2UgKmRldiwKLQkJCQkJICAgICAgc3RydWN0IGRybV9maWxlICpmaWxlLAotCQkJ
CQkgICAgICB1bnNpZ25lZCBpbnQgKmhhbmRsZSwKLQkJCQkJICAgICAgdW5zaWduZWQgbG9uZyBz
aXplKQotewotCXN0cnVjdCBkcm1fdmdlbV9nZW1fb2JqZWN0ICpvYmo7Ci0JaW50IHJldDsKLQot
CW9iaiA9IF9fdmdlbV9nZW1fY3JlYXRlKGRldiwgc2l6ZSk7Ci0JaWYgKElTX0VSUihvYmopKQot
CQlyZXR1cm4gRVJSX0NBU1Qob2JqKTsKLQotCXJldCA9IGRybV9nZW1faGFuZGxlX2NyZWF0ZShm
aWxlLCAmb2JqLT5iYXNlLCBoYW5kbGUpOwotCWlmIChyZXQpIHsKLQkJZHJtX2dlbV9vYmplY3Rf
cHV0KCZvYmotPmJhc2UpOwotCQlyZXR1cm4gRVJSX1BUUihyZXQpOwotCX0KLQotCXJldHVybiAm
b2JqLT5iYXNlOwotfQotCi1zdGF0aWMgaW50IHZnZW1fZ2VtX2R1bWJfY3JlYXRlKHN0cnVjdCBk
cm1fZmlsZSAqZmlsZSwgc3RydWN0IGRybV9kZXZpY2UgKmRldiwKLQkJCQlzdHJ1Y3QgZHJtX21v
ZGVfY3JlYXRlX2R1bWIgKmFyZ3MpCi17Ci0Jc3RydWN0IGRybV9nZW1fb2JqZWN0ICpnZW1fb2Jq
ZWN0OwotCXU2NCBwaXRjaCwgc2l6ZTsKLQotCXBpdGNoID0gYXJncy0+d2lkdGggKiBESVZfUk9V
TkRfVVAoYXJncy0+YnBwLCA4KTsKLQlzaXplID0gYXJncy0+aGVpZ2h0ICogcGl0Y2g7Ci0JaWYg
KHNpemUgPT0gMCkKLQkJcmV0dXJuIC1FSU5WQUw7Ci0KLQlnZW1fb2JqZWN0ID0gdmdlbV9nZW1f
Y3JlYXRlKGRldiwgZmlsZSwgJmFyZ3MtPmhhbmRsZSwgc2l6ZSk7Ci0JaWYgKElTX0VSUihnZW1f
b2JqZWN0KSkKLQkJcmV0dXJuIFBUUl9FUlIoZ2VtX29iamVjdCk7Ci0KLQlhcmdzLT5zaXplID0g
Z2VtX29iamVjdC0+c2l6ZTsKLQlhcmdzLT5waXRjaCA9IHBpdGNoOwotCi0JZHJtX2dlbV9vYmpl
Y3RfcHV0KGdlbV9vYmplY3QpOwotCi0JRFJNX0RFQlVHKCJDcmVhdGVkIG9iamVjdCBvZiBzaXpl
ICVsbHVcbiIsIGFyZ3MtPnNpemUpOwotCi0JcmV0dXJuIDA7Ci19Ci0KIHN0YXRpYyBzdHJ1Y3Qg
ZHJtX2lvY3RsX2Rlc2MgdmdlbV9pb2N0bHNbXSA9IHsKIAlEUk1fSU9DVExfREVGX0RSVihWR0VN
X0ZFTkNFX0FUVEFDSCwgdmdlbV9mZW5jZV9hdHRhY2hfaW9jdGwsIERSTV9SRU5ERVJfQUxMT1cp
LAogCURSTV9JT0NUTF9ERUZfRFJWKFZHRU1fRkVOQ0VfU0lHTkFMLCB2Z2VtX2ZlbmNlX3NpZ25h
bF9pb2N0bCwgRFJNX1JFTkRFUl9BTExPVyksCkBAIC0yNjYsMTU5ICsxMTYsMjMgQEAgc3RhdGlj
IGNvbnN0IHN0cnVjdCBmaWxlX29wZXJhdGlvbnMgdmdlbV9kcml2ZXJfZm9wcyA9IHsKIAkucmVs
ZWFzZQk9IGRybV9yZWxlYXNlLAogfTsKIAotc3RhdGljIHN0cnVjdCBwYWdlICoqdmdlbV9waW5f
cGFnZXMoc3RydWN0IGRybV92Z2VtX2dlbV9vYmplY3QgKmJvKQotewotCW11dGV4X2xvY2soJmJv
LT5wYWdlc19sb2NrKTsKLQlpZiAoYm8tPnBhZ2VzX3Bpbl9jb3VudCsrID09IDApIHsKLQkJc3Ry
dWN0IHBhZ2UgKipwYWdlczsKLQotCQlwYWdlcyA9IGRybV9nZW1fZ2V0X3BhZ2VzKCZiby0+YmFz
ZSk7Ci0JCWlmIChJU19FUlIocGFnZXMpKSB7Ci0JCQliby0+cGFnZXNfcGluX2NvdW50LS07Ci0J
CQltdXRleF91bmxvY2soJmJvLT5wYWdlc19sb2NrKTsKLQkJCXJldHVybiBwYWdlczsKLQkJfQot
Ci0JCWJvLT5wYWdlcyA9IHBhZ2VzOwotCX0KLQltdXRleF91bmxvY2soJmJvLT5wYWdlc19sb2Nr
KTsKLQotCXJldHVybiBiby0+cGFnZXM7Ci19Ci0KLXN0YXRpYyB2b2lkIHZnZW1fdW5waW5fcGFn
ZXMoc3RydWN0IGRybV92Z2VtX2dlbV9vYmplY3QgKmJvKQorc3RhdGljIHN0cnVjdCBkcm1fZ2Vt
X29iamVjdCAqdmdlbV9nZW1fY3JlYXRlX29iamVjdChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LCBz
aXplX3Qgc2l6ZSkKIHsKLQltdXRleF9sb2NrKCZiby0+cGFnZXNfbG9jayk7Ci0JaWYgKC0tYm8t
PnBhZ2VzX3Bpbl9jb3VudCA9PSAwKSB7Ci0JCWRybV9nZW1fcHV0X3BhZ2VzKCZiby0+YmFzZSwg
Ym8tPnBhZ2VzLCB0cnVlLCB0cnVlKTsKLQkJYm8tPnBhZ2VzID0gTlVMTDsKLQl9Ci0JbXV0ZXhf
dW5sb2NrKCZiby0+cGFnZXNfbG9jayk7Ci19CisJc3RydWN0IGRybV9nZW1fc2htZW1fb2JqZWN0
ICpvYmo7CiAKLXN0YXRpYyBpbnQgdmdlbV9wcmltZV9waW4oc3RydWN0IGRybV9nZW1fb2JqZWN0
ICpvYmopCi17Ci0Jc3RydWN0IGRybV92Z2VtX2dlbV9vYmplY3QgKmJvID0gdG9fdmdlbV9ibyhv
YmopOwotCWxvbmcgbl9wYWdlcyA9IG9iai0+c2l6ZSA+PiBQQUdFX1NISUZUOwotCXN0cnVjdCBw
YWdlICoqcGFnZXM7Ci0KLQlwYWdlcyA9IHZnZW1fcGluX3BhZ2VzKGJvKTsKLQlpZiAoSVNfRVJS
KHBhZ2VzKSkKLQkJcmV0dXJuIFBUUl9FUlIocGFnZXMpOworCW9iaiA9IGt6YWxsb2Moc2l6ZW9m
KCpvYmopLCBHRlBfS0VSTkVMKTsKKwlpZiAoIW9iaikKKwkJcmV0dXJuIE5VTEw7CiAKLQkvKiBG
bHVzaCB0aGUgb2JqZWN0IGZyb20gdGhlIENQVSBjYWNoZSBzbyB0aGF0IGltcG9ydGVycyBjYW4g
cmVseQotCSAqIG9uIGNvaGVyZW50IGluZGlyZWN0IGFjY2VzcyB2aWEgdGhlIGV4cG9ydGVkIGRt
YS1hZGRyZXNzLgorCS8qCisJICogdmdlbSBkb2Vzbid0IGhhdmUgYW55IGJlZ2luL2VuZCBjcHUg
YWNjZXNzIGlvY3RscywgdGhlcmVmb3JlIG11c3QgdXNlCisJICogY29oZXJlbnQgbWVtb3J5IG9y
IGRtYS1idWYgc2hhcmluZyBqdXN0IHdvbnQgd29yay4KIAkgKi8KLQlkcm1fY2xmbHVzaF9wYWdl
cyhwYWdlcywgbl9wYWdlcyk7Ci0KLQlyZXR1cm4gMDsKLX0KLQotc3RhdGljIHZvaWQgdmdlbV9w
cmltZV91bnBpbihzdHJ1Y3QgZHJtX2dlbV9vYmplY3QgKm9iaikKLXsKLQlzdHJ1Y3QgZHJtX3Zn
ZW1fZ2VtX29iamVjdCAqYm8gPSB0b192Z2VtX2JvKG9iaik7Ci0KLQl2Z2VtX3VucGluX3BhZ2Vz
KGJvKTsKLX0KLQotc3RhdGljIHN0cnVjdCBzZ190YWJsZSAqdmdlbV9wcmltZV9nZXRfc2dfdGFi
bGUoc3RydWN0IGRybV9nZW1fb2JqZWN0ICpvYmopCi17Ci0Jc3RydWN0IGRybV92Z2VtX2dlbV9v
YmplY3QgKmJvID0gdG9fdmdlbV9ibyhvYmopOwotCi0JcmV0dXJuIGRybV9wcmltZV9wYWdlc190
b19zZyhvYmotPmRldiwgYm8tPnBhZ2VzLCBiby0+YmFzZS5zaXplID4+IFBBR0VfU0hJRlQpOwot
fQotCi1zdGF0aWMgc3RydWN0IGRybV9nZW1fb2JqZWN0KiB2Z2VtX3ByaW1lX2ltcG9ydChzdHJ1
Y3QgZHJtX2RldmljZSAqZGV2LAotCQkJCQkJc3RydWN0IGRtYV9idWYgKmRtYV9idWYpCi17Ci0J
c3RydWN0IHZnZW1fZGV2aWNlICp2Z2VtID0gY29udGFpbmVyX29mKGRldiwgdHlwZW9mKCp2Z2Vt
KSwgZHJtKTsKLQotCXJldHVybiBkcm1fZ2VtX3ByaW1lX2ltcG9ydF9kZXYoZGV2LCBkbWFfYnVm
LCAmdmdlbS0+cGxhdGZvcm0tPmRldik7Ci19Ci0KLXN0YXRpYyBzdHJ1Y3QgZHJtX2dlbV9vYmpl
Y3QgKnZnZW1fcHJpbWVfaW1wb3J0X3NnX3RhYmxlKHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsCi0J
CQlzdHJ1Y3QgZG1hX2J1Zl9hdHRhY2htZW50ICphdHRhY2gsIHN0cnVjdCBzZ190YWJsZSAqc2cp
Ci17Ci0Jc3RydWN0IGRybV92Z2VtX2dlbV9vYmplY3QgKm9iajsKLQlpbnQgbnBhZ2VzOwotCi0J
b2JqID0gX192Z2VtX2dlbV9jcmVhdGUoZGV2LCBhdHRhY2gtPmRtYWJ1Zi0+c2l6ZSk7Ci0JaWYg
KElTX0VSUihvYmopKQotCQlyZXR1cm4gRVJSX0NBU1Qob2JqKTsKLQotCW5wYWdlcyA9IFBBR0Vf
QUxJR04oYXR0YWNoLT5kbWFidWYtPnNpemUpIC8gUEFHRV9TSVpFOwotCi0Jb2JqLT50YWJsZSA9
IHNnOwotCW9iai0+cGFnZXMgPSBrdm1hbGxvY19hcnJheShucGFnZXMsIHNpemVvZihzdHJ1Y3Qg
cGFnZSAqKSwgR0ZQX0tFUk5FTCk7Ci0JaWYgKCFvYmotPnBhZ2VzKSB7Ci0JCV9fdmdlbV9nZW1f
ZGVzdHJveShvYmopOwotCQlyZXR1cm4gRVJSX1BUUigtRU5PTUVNKTsKLQl9CisJb2JqLT5tYXBf
d2MgPSB0cnVlOwogCi0Jb2JqLT5wYWdlc19waW5fY291bnQrKzsgLyogcGVybWEtcGlubmVkICov
Ci0JZHJtX3ByaW1lX3NnX3RvX3BhZ2VfYXJyYXkob2JqLT50YWJsZSwgb2JqLT5wYWdlcywgbnBh
Z2VzKTsKIAlyZXR1cm4gJm9iai0+YmFzZTsKIH0KIAotc3RhdGljIGludCB2Z2VtX3ByaW1lX3Zt
YXAoc3RydWN0IGRybV9nZW1fb2JqZWN0ICpvYmosIHN0cnVjdCBkbWFfYnVmX21hcCAqbWFwKQot
ewotCXN0cnVjdCBkcm1fdmdlbV9nZW1fb2JqZWN0ICpibyA9IHRvX3ZnZW1fYm8ob2JqKTsKLQls
b25nIG5fcGFnZXMgPSBvYmotPnNpemUgPj4gUEFHRV9TSElGVDsKLQlzdHJ1Y3QgcGFnZSAqKnBh
Z2VzOwotCXZvaWQgKnZhZGRyOwotCi0JcGFnZXMgPSB2Z2VtX3Bpbl9wYWdlcyhibyk7Ci0JaWYg
KElTX0VSUihwYWdlcykpCi0JCXJldHVybiBQVFJfRVJSKHBhZ2VzKTsKLQotCXZhZGRyID0gdm1h
cChwYWdlcywgbl9wYWdlcywgMCwgcGdwcm90X3dyaXRlY29tYmluZShQQUdFX0tFUk5FTCkpOwot
CWlmICghdmFkZHIpCi0JCXJldHVybiAtRU5PTUVNOwotCWRtYV9idWZfbWFwX3NldF92YWRkciht
YXAsIHZhZGRyKTsKLQotCXJldHVybiAwOwotfQotCi1zdGF0aWMgdm9pZCB2Z2VtX3ByaW1lX3Z1
bm1hcChzdHJ1Y3QgZHJtX2dlbV9vYmplY3QgKm9iaiwgc3RydWN0IGRtYV9idWZfbWFwICptYXAp
Ci17Ci0Jc3RydWN0IGRybV92Z2VtX2dlbV9vYmplY3QgKmJvID0gdG9fdmdlbV9ibyhvYmopOwot
Ci0JdnVubWFwKG1hcC0+dmFkZHIpOwotCXZnZW1fdW5waW5fcGFnZXMoYm8pOwotfQotCi1zdGF0
aWMgaW50IHZnZW1fcHJpbWVfbW1hcChzdHJ1Y3QgZHJtX2dlbV9vYmplY3QgKm9iaiwKLQkJCSAg
IHN0cnVjdCB2bV9hcmVhX3N0cnVjdCAqdm1hKQotewotCWludCByZXQ7Ci0KLQlpZiAob2JqLT5z
aXplIDwgdm1hLT52bV9lbmQgLSB2bWEtPnZtX3N0YXJ0KQotCQlyZXR1cm4gLUVJTlZBTDsKLQot
CWlmICghb2JqLT5maWxwKQotCQlyZXR1cm4gLUVOT0RFVjsKLQotCXJldCA9IGNhbGxfbW1hcChv
YmotPmZpbHAsIHZtYSk7Ci0JaWYgKHJldCkKLQkJcmV0dXJuIHJldDsKLQotCXZtYV9zZXRfZmls
ZSh2bWEsIG9iai0+ZmlscCk7Ci0Jdm1hLT52bV9mbGFncyB8PSBWTV9ET05URVhQQU5EIHwgVk1f
RE9OVERVTVA7Ci0Jdm1hLT52bV9wYWdlX3Byb3QgPSBwZ3Byb3Rfd3JpdGVjb21iaW5lKHZtX2dl
dF9wYWdlX3Byb3Qodm1hLT52bV9mbGFncykpOwotCi0JcmV0dXJuIDA7Ci19Ci0KLXN0YXRpYyBj
b25zdCBzdHJ1Y3QgZHJtX2dlbV9vYmplY3RfZnVuY3MgdmdlbV9nZW1fb2JqZWN0X2Z1bmNzID0g
ewotCS5mcmVlID0gdmdlbV9nZW1fZnJlZV9vYmplY3QsCi0JLnBpbiA9IHZnZW1fcHJpbWVfcGlu
LAotCS51bnBpbiA9IHZnZW1fcHJpbWVfdW5waW4sCi0JLmdldF9zZ190YWJsZSA9IHZnZW1fcHJp
bWVfZ2V0X3NnX3RhYmxlLAotCS52bWFwID0gdmdlbV9wcmltZV92bWFwLAotCS52dW5tYXAgPSB2
Z2VtX3ByaW1lX3Z1bm1hcCwKLQkudm1fb3BzID0gJnZnZW1fZ2VtX3ZtX29wcywKLX07Ci0KIHN0
YXRpYyBjb25zdCBzdHJ1Y3QgZHJtX2RyaXZlciB2Z2VtX2RyaXZlciA9IHsKIAkuZHJpdmVyX2Zl
YXR1cmVzCQk9IERSSVZFUl9HRU0gfCBEUklWRVJfUkVOREVSLAogCS5vcGVuCQkJCT0gdmdlbV9v
cGVuLApAQCAtNDI3LDEzICsxNDEsOCBAQCBzdGF0aWMgY29uc3Qgc3RydWN0IGRybV9kcml2ZXIg
dmdlbV9kcml2ZXIgPSB7CiAJLm51bV9pb2N0bHMgCQkJPSBBUlJBWV9TSVpFKHZnZW1faW9jdGxz
KSwKIAkuZm9wcwkJCQk9ICZ2Z2VtX2RyaXZlcl9mb3BzLAogCi0JLmR1bWJfY3JlYXRlCQkJPSB2
Z2VtX2dlbV9kdW1iX2NyZWF0ZSwKLQotCS5wcmltZV9oYW5kbGVfdG9fZmQgPSBkcm1fZ2VtX3By
aW1lX2hhbmRsZV90b19mZCwKLQkucHJpbWVfZmRfdG9faGFuZGxlID0gZHJtX2dlbV9wcmltZV9m
ZF90b19oYW5kbGUsCi0JLmdlbV9wcmltZV9pbXBvcnQgPSB2Z2VtX3ByaW1lX2ltcG9ydCwKLQku
Z2VtX3ByaW1lX2ltcG9ydF9zZ190YWJsZSA9IHZnZW1fcHJpbWVfaW1wb3J0X3NnX3RhYmxlLAot
CS5nZW1fcHJpbWVfbW1hcCA9IHZnZW1fcHJpbWVfbW1hcCwKKwlEUk1fR0VNX1NITUVNX0RSSVZF
Ul9PUFMsCisJLmdlbV9jcmVhdGVfb2JqZWN0CQk9IHZnZW1fZ2VtX2NyZWF0ZV9vYmplY3QsCiAK
IAkubmFtZQk9IERSSVZFUl9OQU1FLAogCS5kZXNjCT0gRFJJVkVSX0RFU0MsCi0tIAoyLjMyLjAK
Cl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCkludGVsLWdm
eCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xp
c3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWdmeAo=

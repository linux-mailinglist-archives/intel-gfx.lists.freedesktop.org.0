Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 246729011B
	for <lists+intel-gfx@lfdr.de>; Fri, 16 Aug 2019 14:10:07 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 146E66E331;
	Fri, 16 Aug 2019 12:10:05 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id C11376E32F
 for <intel-gfx@lists.freedesktop.org>; Fri, 16 Aug 2019 12:10:03 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18162467-1500050 
 for <intel-gfx@lists.freedesktop.org>; Fri, 16 Aug 2019 13:10:01 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Fri, 16 Aug 2019 13:09:59 +0100
Message-Id: <20190816121000.8507-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0.rc1
MIME-Version: 1.0
Subject: [Intel-gfx] [CI 1/2] drm/i915/gt: Mark context->active_count as
 protected by timeline->mutex
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

V2UgdXNlIHRpbWVsaW5lLT5tdXRleCB0byBwcm90ZWN0IG1vZGlmaWNhdGlvbnMgdG8KY29udGV4
dC0+YWN0aXZlX2NvdW50LCBhbmQgdGhlIGFzc29jaWF0ZWQgZW5hYmxlL2Rpc2FibGUgY2FsbGJh
Y2tzLgpEdWUgdG8gY29tcGxpY2F0aW9ucyB3aXRoIGVuZ2luZS1wbSBiYXJyaWVyIHRoZXJlIGlz
IGEgcGF0aCB3aGVyZSB3ZSB1c2VkCmEgInN1cGVybG9jayIgdG8gcHJvdmlkZSBzZXJpYWxpc2Vk
IHByb3RlY3QgYW5kIHNvIGNvdWxkIG5vdAp1bmNvbmRpdGlvbmFsbHkgYXNzZXJ0IHdpdGggbG9j
a2RlcCB0aGF0IGl0IHdhcyBhbHdheXMgaGVsZC4gSG93ZXZlciwKd2UgY2FuIG1hcmsgdGhlIG11
dGV4IGFzIHRha2VuIChub3RpbmcgdGhhdCB3ZSBtYXkgYmUgbmVzdGVkIHVuZGVybmVhdGgKb3Vy
c2VsdmVzKSB3aGljaCBtZWFucyB3ZSBjYW4gYmUgcmVhc3N1cmVkIHRoZSByaWdodCB0aW1lbGlu
ZS0+bXV0ZXggaXMKYWx3YXlzIHRyZWF0ZWQgYXMgaGVsZCBhbmQgbGV0IGxvY2tkZXAgcm9hbSBm
cmVlLgoKU2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28u
dWs+CkNjOiBUdnJ0a28gVXJzdWxpbiA8dHZydGtvLnVyc3VsaW5AaW50ZWwuY29tPgpSZXZpZXdl
ZC1ieTogTWlrYSBLdW9wcGFsYSA8bWlrYS5rdW9wcGFsYUBsaW51eC5pbnRlbC5jb20+Ci0tLQog
ZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfY29udGV4dC5oICAgICAgIHwgIDMgKysrCiBk
cml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9jb250ZXh0X3R5cGVzLmggfCAgMiArLQogZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZW5naW5lX3BtLmMgICAgIHwgMTQgKysrKysrKysr
KysrKysKIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX3RpbWVsaW5lLmMgICAgICB8ICA0
ICsrKysKIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcmVxdWVzdC5jICAgICAgICAgICB8ICAz
ICsrLQogNSBmaWxlcyBjaGFuZ2VkLCAyNCBpbnNlcnRpb25zKCspLCAyIGRlbGV0aW9ucygtKQoK
ZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2NvbnRleHQuaCBiL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2NvbnRleHQuaAppbmRleCAwNTNhMTMwN2VjYjQu
LmRkNzQyYWMyZmJkYiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxf
Y29udGV4dC5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2NvbnRleHQuaApA
QCAtODksMTcgKzg5LDIwIEBAIHZvaWQgaW50ZWxfY29udGV4dF9leGl0X2VuZ2luZShzdHJ1Y3Qg
aW50ZWxfY29udGV4dCAqY2UpOwogCiBzdGF0aWMgaW5saW5lIHZvaWQgaW50ZWxfY29udGV4dF9l
bnRlcihzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UpCiB7CisJbG9ja2RlcF9hc3NlcnRfaGVsZCgm
Y2UtPnRpbWVsaW5lLT5tdXRleCk7CiAJaWYgKCFjZS0+YWN0aXZlX2NvdW50KyspCiAJCWNlLT5v
cHMtPmVudGVyKGNlKTsKIH0KIAogc3RhdGljIGlubGluZSB2b2lkIGludGVsX2NvbnRleHRfbWFy
a19hY3RpdmUoc3RydWN0IGludGVsX2NvbnRleHQgKmNlKQogeworCWxvY2tkZXBfYXNzZXJ0X2hl
bGQoJmNlLT50aW1lbGluZS0+bXV0ZXgpOwogCSsrY2UtPmFjdGl2ZV9jb3VudDsKIH0KIAogc3Rh
dGljIGlubGluZSB2b2lkIGludGVsX2NvbnRleHRfZXhpdChzdHJ1Y3QgaW50ZWxfY29udGV4dCAq
Y2UpCiB7CisJbG9ja2RlcF9hc3NlcnRfaGVsZCgmY2UtPnRpbWVsaW5lLT5tdXRleCk7CiAJR0VN
X0JVR19PTighY2UtPmFjdGl2ZV9jb3VudCk7CiAJaWYgKCEtLWNlLT5hY3RpdmVfY291bnQpCiAJ
CWNlLT5vcHMtPmV4aXQoY2UpOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Qv
aW50ZWxfY29udGV4dF90eXBlcy5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfY29u
dGV4dF90eXBlcy5oCmluZGV4IGE2MzJiMjBlYzRkOC4uNjE2ZjNmOWE2ODI1IDEwMDY0NAotLS0g
YS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9jb250ZXh0X3R5cGVzLmgKKysrIGIvZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfY29udGV4dF90eXBlcy5oCkBAIC02MSw3ICs2MSw3
IEBAIHN0cnVjdCBpbnRlbF9jb250ZXh0IHsKIAl1MzIgKmxyY19yZWdfc3RhdGU7CiAJdTY0IGxy
Y19kZXNjOwogCi0JdW5zaWduZWQgaW50IGFjdGl2ZV9jb3VudDsgLyogbm90aW9uYWxseSBwcm90
ZWN0ZWQgYnkgdGltZWxpbmUtPm11dGV4ICovCisJdW5zaWduZWQgaW50IGFjdGl2ZV9jb3VudDsg
LyogcHJvdGVjdGVkIGJ5IHRpbWVsaW5lLT5tdXRleCAqLwogCiAJYXRvbWljX3QgcGluX2NvdW50
OwogCXN0cnVjdCBtdXRleCBwaW5fbXV0ZXg7IC8qIGd1YXJkcyBwaW5uaW5nIGFuZCBhc3NvY2lh
dGVkIG9uLWdwdWluZyAqLwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50
ZWxfZW5naW5lX3BtLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfcG0u
YwppbmRleCBmM2YwMTA5ZjllMjIuLjVmMDNmN2RjYWQ3MiAxMDA2NDQKLS0tIGEvZHJpdmVycy9n
cHUvZHJtL2k5MTUvZ3QvaW50ZWxfZW5naW5lX3BtLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ3QvaW50ZWxfZW5naW5lX3BtLmMKQEAgLTM3LDYgKzM3LDE2IEBAIHN0YXRpYyBpbnQgX19l
bmdpbmVfdW5wYXJrKHN0cnVjdCBpbnRlbF93YWtlcmVmICp3ZikKIAlyZXR1cm4gMDsKIH0KIAor
c3RhdGljIGlubGluZSB2b2lkIF9fdGltZWxpbmVfbWFya19sb2NrKHN0cnVjdCBpbnRlbF9jb250
ZXh0ICpjZSkKK3sKKwltdXRleF9hY3F1aXJlKCZjZS0+dGltZWxpbmUtPm11dGV4LmRlcF9tYXAs
IDIsIDAsIF9USElTX0lQXyk7Cit9CisKK3N0YXRpYyBpbmxpbmUgdm9pZCBfX3RpbWVsaW5lX21h
cmtfdW5sb2NrKHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSkKK3sKKwltdXRleF9yZWxlYXNlKCZj
ZS0+dGltZWxpbmUtPm11dGV4LmRlcF9tYXAsIDAsIF9USElTX0lQXyk7Cit9CisKIHN0YXRpYyBi
b29sIHN3aXRjaF90b19rZXJuZWxfY29udGV4dChzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdp
bmUpCiB7CiAJc3RydWN0IGk5MTVfcmVxdWVzdCAqcnE7CkBAIC02MSw2ICs3MSw4IEBAIHN0YXRp
YyBib29sIHN3aXRjaF90b19rZXJuZWxfY29udGV4dChzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICpl
bmdpbmUpCiAJICogcmV0aXJpbmcgdGhlIGxhc3QgcmVxdWVzdCwgdGh1cyBhbGwgcmluZ3Mgc2hv
dWxkIGJlIGVtcHR5IGFuZAogCSAqIGFsbCB0aW1lbGluZXMgaWRsZS4KIAkgKi8KKwlfX3RpbWVs
aW5lX21hcmtfbG9jayhlbmdpbmUtPmtlcm5lbF9jb250ZXh0KTsKKwogCXJxID0gX19pOTE1X3Jl
cXVlc3RfY3JlYXRlKGVuZ2luZS0+a2VybmVsX2NvbnRleHQsIEdGUF9OT1dBSVQpOwogCWlmIChJ
U19FUlIocnEpKQogCQkvKiBDb250ZXh0IHN3aXRjaCBmYWlsZWQsIGhvcGUgZm9yIHRoZSBiZXN0
ISBNYXliZSByZXNldD8gKi8KQEAgLTgwLDYgKzkyLDggQEAgc3RhdGljIGJvb2wgc3dpdGNoX3Rv
X2tlcm5lbF9jb250ZXh0KHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKIAlfX2ludGVs
X3dha2VyZWZfZGVmZXJfcGFyaygmZW5naW5lLT53YWtlcmVmKTsKIAlfX2k5MTVfcmVxdWVzdF9x
dWV1ZShycSwgTlVMTCk7CiAKKwlfX3RpbWVsaW5lX21hcmtfdW5sb2NrKGVuZ2luZS0+a2VybmVs
X2NvbnRleHQpOworCiAJcmV0dXJuIGZhbHNlOwogfQogCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9ndC9pbnRlbF90aW1lbGluZS5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Qv
aW50ZWxfdGltZWxpbmUuYwppbmRleCA3YjQ3NmNkNTVkYWMuLmVhZmQ5NGQ1ZTIxMSAxMDA2NDQK
LS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfdGltZWxpbmUuYworKysgYi9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF90aW1lbGluZS5jCkBAIC0zMzgsNiArMzM4LDggQEAg
dm9pZCBpbnRlbF90aW1lbGluZV9lbnRlcihzdHJ1Y3QgaW50ZWxfdGltZWxpbmUgKnRsKQogewog
CXN0cnVjdCBpbnRlbF9ndF90aW1lbGluZXMgKnRpbWVsaW5lcyA9ICZ0bC0+Z3QtPnRpbWVsaW5l
czsKIAorCWxvY2tkZXBfYXNzZXJ0X2hlbGQoJnRsLT5tdXRleCk7CisKIAlHRU1fQlVHX09OKCFh
dG9taWNfcmVhZCgmdGwtPnBpbl9jb3VudCkpOwogCWlmICh0bC0+YWN0aXZlX2NvdW50KyspCiAJ
CXJldHVybjsKQEAgLTM1Miw2ICszNTQsOCBAQCB2b2lkIGludGVsX3RpbWVsaW5lX2V4aXQoc3Ry
dWN0IGludGVsX3RpbWVsaW5lICp0bCkKIHsKIAlzdHJ1Y3QgaW50ZWxfZ3RfdGltZWxpbmVzICp0
aW1lbGluZXMgPSAmdGwtPmd0LT50aW1lbGluZXM7CiAKKwlsb2NrZGVwX2Fzc2VydF9oZWxkKCZ0
bC0+bXV0ZXgpOworCiAJR0VNX0JVR19PTighdGwtPmFjdGl2ZV9jb3VudCk7CiAJaWYgKC0tdGwt
PmFjdGl2ZV9jb3VudCkKIAkJcmV0dXJuOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvaTkxNV9yZXF1ZXN0LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3JlcXVlc3QuYwpp
bmRleCAxNzRjN2ZkZDAyZmYuLjdlZGNkMGZlZjVjNiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvaTkxNV9yZXF1ZXN0LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9y
ZXF1ZXN0LmMKQEAgLTEwODcsNyArMTA4Nyw4IEBAIF9faTkxNV9yZXF1ZXN0X2FkZF90b190aW1l
bGluZShzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSkKIAkgKiBwcmVjbHVkZXMgb3B0aW1pc2luZyB0
byB1c2Ugc2VtYXBob3JlcyBzZXJpYWxpc2F0aW9uIG9mIGEgc2luZ2xlCiAJICogdGltZWxpbmUg
YWNyb3NzIGVuZ2luZXMuCiAJICovCi0JcHJldiA9IHJjdV9kZXJlZmVyZW5jZV9wcm90ZWN0ZWQo
dGltZWxpbmUtPmxhc3RfcmVxdWVzdC5yZXF1ZXN0LCAxKTsKKwlwcmV2ID0gcmN1X2RlcmVmZXJl
bmNlX3Byb3RlY3RlZCh0aW1lbGluZS0+bGFzdF9yZXF1ZXN0LnJlcXVlc3QsCisJCQkJCSBsb2Nr
ZGVwX2lzX2hlbGQoJnRpbWVsaW5lLT5tdXRleCkpOwogCWlmIChwcmV2ICYmICFpOTE1X3JlcXVl
c3RfY29tcGxldGVkKHByZXYpKSB7CiAJCWlmIChpc19wb3dlcl9vZl8yKHByZXYtPmVuZ2luZS0+
bWFzayB8IHJxLT5lbmdpbmUtPm1hc2spKQogCQkJaTkxNV9zd19mZW5jZV9hd2FpdF9zd19mZW5j
ZSgmcnEtPnN1Ym1pdCwKLS0gCjIuMjMuMC5yYzEKCl9fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxp
c3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFu
L2xpc3RpbmZvL2ludGVsLWdmeA==

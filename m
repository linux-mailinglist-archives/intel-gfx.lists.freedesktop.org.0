Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 9E0CD8E0E3
	for <lists+intel-gfx@lfdr.de>; Thu, 15 Aug 2019 00:37:37 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 40CFF89AD2;
	Wed, 14 Aug 2019 22:37:35 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 2DBDE89AD2;
 Wed, 14 Aug 2019 22:37:34 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18129508-1500050 
 for multiple; Wed, 14 Aug 2019 23:37:28 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Wed, 14 Aug 2019 23:37:26 +0100
Message-Id: <20190814223726.31338-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0.rc1
In-Reply-To: <20190814222549.31154-1-chris@chris-wilson.co.uk>
References: <20190814222549.31154-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH i-g-t] i915/gem_userptr_blit: Shoot down a
 shared mmap_gtt(userptr)
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: igt-dev@lists.freedesktop.org, Daniel Vetter <daniel.vetter@ffwll.ch>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

RXN0YWJsaXNoIGEgdXNlcnB0ciBhbmQgaW5oZXJpdCBpdCB0byBtYW55IGNoaWxkcmVuIHdpdGgg
ZnJlc2ggbW0uIEludG8KZWFjaCBjaGlsZCBtbSwgbW1hcF9ndHQgdGhlIHVzZXJwdHIgaGFuZGxl
IHNvIHRoYXQgdGhleSBhcmUgbWFueQpkaWZmZXJlbnQgdm1hIGluIHRoZSBpX21hcHBpbmcgdHJl
ZSBwb2ludGluZyBiYWNrIHRvIHRoZSB1c2VycHRyLiBUaGVuCnByb2NlZWQgdG8gbXVubWFwIHRo
YXQgYW5kIGZvcmNlIHVzIHRvIHJldm9rZSBhbGwgdGhlIG1tYXBzLgoKRGFuaWVsIGRpc2NvdmVy
ZWQgdGhhdCBmcm9tIHRoZSB1bm1hcCBpbiB0aGUgcGFyZW50LCB3ZSB3aWxsIGNhbGwKaTkxNV92
bWFfcmV2b2tlX21tYXBzKCkgb24gYWxsIHRoZSBjaGlsZCBtYXBwaW5ncywgd2hpY2ggaW4gdHVy
biBzaG91bGQKY2FsbCBtbXVfbm90aWZpZXJfaW52YWxpZGF0ZV9yYW5nZSAtLSBvc3RlbnNpYmx5
IHJlY3Vyc2luZyBmcm9tIHRoZQpvdXRlciBtbXVfbm90aWZpZXJfaW52YWxpZGF0ZV9yYW5nZSBv
ZiB0aGUgbXVuYW1wLgoKdjI6IEludm9rZSB1c2VycHRyIGluIGVhY2ggY2hpbGQgZm9yIG1vcmUg
bW11LW5vdGlmaWVycwoKU2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13
aWxzb24uY28udWs+CkNjOiBEYW5pZWwgVmV0dGVyIDxkYW5pZWwudmV0dGVyQGZmd2xsLmNoPgot
LS0KIHRlc3RzL2k5MTUvZ2VtX3VzZXJwdHJfYmxpdHMuYyB8IDg2ICsrKysrKysrKysrKysrKysr
KysrKysrKysrKysrKysrKysKIDEgZmlsZSBjaGFuZ2VkLCA4NiBpbnNlcnRpb25zKCspCgpkaWZm
IC0tZ2l0IGEvdGVzdHMvaTkxNS9nZW1fdXNlcnB0cl9ibGl0cy5jIGIvdGVzdHMvaTkxNS9nZW1f
dXNlcnB0cl9ibGl0cy5jCmluZGV4IDVmNzc3MGM5My4uZjA4NjE2MTQ2IDEwMDY0NAotLS0gYS90
ZXN0cy9pOTE1L2dlbV91c2VycHRyX2JsaXRzLmMKKysrIGIvdGVzdHMvaTkxNS9nZW1fdXNlcnB0
cl9ibGl0cy5jCkBAIC0xNjEzLDYgKzE2MTMsODkgQEAgc3RhdGljIHZvaWQgdGVzdF91bm1hcChp
bnQgZmQsIGludCBleHBlY3RlZCkKIAkJZ2VtX2Nsb3NlKGZkLCBib1tpXSk7CiB9CiAKK3N0YXRp
YyBpbnQgY291bnRfc2lnYnVzKHZvaWQgKnB0ciwgc2l6ZV90IGxlbikKK3sKKwlzdHJ1Y3Qgc2ln
YWN0aW9uIHNpZ2FjdCwgb3JpZ19zaWdhY3Q7CisKKwltZW1zZXQoJnNpZ2FjdCwgMCwgc2l6ZW9m
KHNpZ2FjdCkpOworCXNpZ2FjdC5zYV9zaWdhY3Rpb24gPSBzaWdidXM7CisJc2lnYWN0LnNhX2Zs
YWdzID0gU0FfU0lHSU5GTzsKKwlpZ3RfYXNzZXJ0KHNpZ2FjdGlvbihTSUdCVVMsICZzaWdhY3Qs
ICZvcmlnX3NpZ2FjdCkgPT0gMCk7CisKKwlzaWdidXNfc3RhcnQgPSAodW5zaWduZWQgbG9uZylw
dHI7CisJc2lnYnVzX2NudCA9IDA7CisJbWVtc2V0KHB0ciwgMCwgbGVuKTsKKworCXNpZ2FjdGlv
bihTSUdCVVMsICZvcmlnX3NpZ2FjdCwgTlVMTCk7CisJcmV0dXJuIHNpZ2J1c19jbnQ7Cit9CisK
K3N0YXRpYyB2b2lkIHRlc3RfdW5tYXBfc2hhcmVkKGludCBpOTE1KQoreworCWNvbnN0IGludCBu
dW1fY2hpbGQgPSA2NDsKKwlzdHJ1Y3QgeworCQl2b2lkICpiYXNlOworCQl1aW50MzJfdCAqZ3R0
OworCQl1aW50MzJfdCBibzsKKwl9IHRbMl07CisKKwlpZ3RfcmVxdWlyZShnZW1faGFzX2xsYyhp
OTE1KSk7CisKKwlmb3IgKGludCBpID0gMDsgaSA8IEFSUkFZX1NJWkUodCk7IGkrKykgeworCQl0
W2ldLmJhc2UgPSBtbWFwKE5VTEwsIHNpemVvZihsaW5lYXIpLCBQUk9UX1JFQUQgfCBQUk9UX1dS
SVRFLAorCQkJICAgICAgIE1BUF9BTk9OWU1PVVMgfCBNQVBfUFJJVkFURSwgLTEsIDApOworCQlp
Z3RfYXNzZXJ0KHRbaV0uYmFzZSAhPSBNQVBfRkFJTEVEKTsKKwkJaWd0X3JlcXVpcmUoX19nZW1f
dXNlcnB0cihpOTE1LCB0W2ldLmJhc2UsIHNpemVvZihsaW5lYXIpLAorCQkJCQkgIDAsIHVzZXJw
dHJfZmxhZ3MsICZ0W2ldLmJvKSA9PSAwKTsKKworCQl0W2ldLmd0dCA9IGdlbV9tbWFwX19ndHQo
aTkxNSwgdFtpXS5ibywKKwkJCQkJIHNpemVvZihsaW5lYXIpLCBQUk9UX1dSSVRFKTsKKwkJKnRb
aV0uZ3R0ID0gaTsKKwl9CisKKwlpZ3RfZm9yayhjaGlsZCwgbnVtX2NoaWxkKSB7CisJCXVpbnQz
Ml90ICpwdHI7CisKKwkJLyogRmlyc3QgYXR0YWNoIG91ciBvd24gdXNlciBwb2ludGVyIHRvIHBy
ZXAgdGhlIG1tdSBub3RpZmllciAqLworCQlwdHIgPSBtbWFwKE5VTEwsIHNpemVvZihsaW5lYXIp
LCBQUk9UX1JFQUQgfCBQUk9UX1dSSVRFLAorCQkJICAgTUFQX0FOT05ZTU9VUyB8IE1BUF9QUklW
QVRFLCAtMSwgMCk7CisJCWlndF9hc3NlcnQocHRyICE9IE1BUF9GQUlMRUQpOworCQlpZ3RfcmVx
dWlyZShfX2dlbV91c2VycHRyKGk5MTUsIHB0ciwgc2l6ZW9mKGxpbmVhciksCisJCQkJCSAgMCwg
dXNlcnB0cl9mbGFncywgcHRyKSA9PSAwKTsKKworCQlwdHIgPSBnZW1fbW1hcF9fZ3R0KGk5MTUs
IHRbMF0uYm8sIHNpemVvZihsaW5lYXIpLCBQUk9UX1dSSVRFKTsKKwkJcHRyW2NoaWxkXSA9IDE7
CisKKwkJcHRyID0gZ2VtX21tYXBfX2d0dChpOTE1LCB0WzFdLmJvLCBzaXplb2YobGluZWFyKSwg
UFJPVF9XUklURSk7CisJCXdoaWxlIChSRUFEX09OQ0UoKnB0cikgPT0gMSkKKwkJCXVzbGVlcCgx
MCAqIDEwMDApOworCisJCXB0ciA9IGdlbV9tbWFwX19ndHQoaTkxNSwgdFswXS5ibywgc2l6ZW9m
KGxpbmVhciksIFBST1RfV1JJVEUpOworCQlpZ3RfYXNzZXJ0KGNvdW50X3NpZ2J1cyhwdHIsIDEp
ID4gMCk7CisJfQorCisJLyogYnVzeSB3YWl0IGZvciBhbGwgY2hpbGRyZW4gdG8gaW5zdGFudGlh
dGUgdGhlaXIgbW1hcCAqLworCWZvciAoaW50IGNoaWxkID0gMDsgY2hpbGQgPCBudW1fY2hpbGQ7
IGNoaWxkKyspIHsKKwkJd2hpbGUgKFJFQURfT05DRSh0WzBdLmd0dFtjaGlsZF0pID09IDApCisJ
CQk7CisJfQorCisJLyogc2hvb3QgaXQgZG93biEgKi8KKwltdW5tYXAodFswXS5iYXNlLCBzaXpl
b2YobGluZWFyKSk7CisKKwkvKiBjaGVjayBvdXIgYWltIHdhcyB0cnVlICovCisJaWd0X2Fzc2Vy
dChjb3VudF9zaWdidXModFswXS5ndHQsIDEpID4gMCk7CisKKwkqdFsxXS5ndHQgPSAwOworCWln
dF93YWl0Y2hpbGRyZW4oKTsKKworCWZvciAoaW50IGkgPSAwOyBpIDwgQVJSQVlfU0laRSh0KTsg
aSsrKSB7CisJCWdlbV9jbG9zZShpOTE1LCB0W2ldLmJvKTsKKwkJbXVubWFwKHRbaV0uZ3R0LCBz
aXplb2YobGluZWFyKSk7CisJCW11bm1hcCh0W2ldLmJhc2UsIHNpemVvZihsaW5lYXIpKTsKKwl9
Cit9CisKIHN0YXRpYyB2b2lkIHRlc3RfdW5tYXBfYWZ0ZXJfY2xvc2UoaW50IGZkKQogewogCWNo
YXIgKnB0ciwgKmJvX3B0cjsKQEAgLTIwMDYsNiArMjA4OSw5IEBAIGlndF9tYWluX2FyZ3MoImM6
IiwgTlVMTCwgaGVscF9zdHIsIG9wdF9oYW5kbGVyLCBOVUxMKQogCQlpZ3Rfc3VidGVzdCgic3lu
Yy11bm1hcC1hZnRlci1jbG9zZSIpCiAJCQl0ZXN0X3VubWFwX2FmdGVyX2Nsb3NlKGZkKTsKIAor
CQlpZ3Rfc3VidGVzdCgic3luYy11bm1hcC1zaGFyZWQiKQorCQkJdGVzdF91bm1hcF9zaGFyZWQo
ZmQpOworCiAJCWlndF9zdWJ0ZXN0KCJzdHJlc3MtbW0iKQogCQkJdGVzdF9zdHJlc3NfbW0oZmQp
OwogCQlpZ3Rfc3VidGVzdCgic3RyZXNzLXB1cmdlIikKLS0gCjIuMjMuMC5yYzEKCl9fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCkludGVsLWdmeCBtYWlsaW5n
IGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVk
ZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWdmeA==

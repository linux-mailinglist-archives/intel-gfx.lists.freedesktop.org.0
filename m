Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id E0C3772044
	for <lists+intel-gfx@lfdr.de>; Tue, 23 Jul 2019 21:58:28 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 327456E31E;
	Tue, 23 Jul 2019 19:58:26 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id D71386E3AC
 for <intel-gfx@lists.freedesktop.org>; Tue, 23 Jul 2019 19:58:24 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17542625-1500050 
 for multiple; Tue, 23 Jul 2019 19:38:46 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Tue, 23 Jul 2019 19:38:40 +0100
Message-Id: <20190723183842.20372-21-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.22.0
In-Reply-To: <20190723183842.20372-1-chris@chris-wilson.co.uk>
References: <20190723183842.20372-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 21/23] drm/i915/overlay: Switch to using
 i915_active tracking
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

UmVtb3ZlIHRoZSByYXcgaTkxNV9hY3RpdmVfcmVxdWVzdCB0cmFja2luZyBpbiBmYXZvdXIgb2Yg
dGhlIGhpZ2hlcgpsZXZlbCBpOTE1X2FjdGl2ZSB0cmFja2luZyBmb3IgdGhlIHNvbGUgcHVycG9z
ZSBvZiBtYWtpbmcgdGhlIGxvY2tsZXNzCnRyYW5zaXRpb24gZWFzaWVyIGluIGxhdGVyIHBhdGNo
ZXMuCgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNocmlzQGNocmlzLXdpbHNvbi5jby51
az4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9kaXNwbGF5L2ludGVsX292ZXJsYXkuYyB8IDEy
OSArKysrKysrKystLS0tLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2FjdGl2ZS5o
ICAgICAgICAgICB8ICAxOSAtLS0KIDIgZmlsZXMgY2hhbmdlZCwgNjQgaW5zZXJ0aW9ucygrKSwg
ODQgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZGlzcGxh
eS9pbnRlbF9vdmVybGF5LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9kaXNwbGF5L2ludGVsX292
ZXJsYXkuYwppbmRleCAwNzkyOTcyNmI3ODAuLjliM2Y0ZjY2NDRmMyAxMDA2NDQKLS0tIGEvZHJp
dmVycy9ncHUvZHJtL2k5MTUvZGlzcGxheS9pbnRlbF9vdmVybGF5LmMKKysrIGIvZHJpdmVycy9n
cHUvZHJtL2k5MTUvZGlzcGxheS9pbnRlbF9vdmVybGF5LmMKQEAgLTE5MSw3ICsxOTEsOCBAQCBz
dHJ1Y3QgaW50ZWxfb3ZlcmxheSB7CiAJc3RydWN0IG92ZXJsYXlfcmVnaXN0ZXJzIF9faW9tZW0g
KnJlZ3M7CiAJdTMyIGZsaXBfYWRkcjsKIAkvKiBmbGlwIGhhbmRsaW5nICovCi0Jc3RydWN0IGk5
MTVfYWN0aXZlX3JlcXVlc3QgbGFzdF9mbGlwOworCXN0cnVjdCBpOTE1X2FjdGl2ZSBsYXN0X2Zs
aXA7CisJdm9pZCAoKmZsaXBfY29tcGxldGUpKHN0cnVjdCBpbnRlbF9vdmVybGF5ICpvdmwpOwog
fTsKIAogc3RhdGljIHZvaWQgaTgzMF9vdmVybGF5X2Nsb2NrX2dhdGluZyhzdHJ1Y3QgZHJtX2k5
MTVfcHJpdmF0ZSAqZGV2X3ByaXYsCkBAIC0yMTcsMzAgKzIxOCwyNSBAQCBzdGF0aWMgdm9pZCBp
ODMwX292ZXJsYXlfY2xvY2tfZ2F0aW5nKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJp
diwKIAkJCQkgIFBDSV9ERVZGTigwLCAwKSwgSTgzMF9DTE9DS19HQVRFLCB2YWwpOwogfQogCi1z
dGF0aWMgdm9pZCBpbnRlbF9vdmVybGF5X3N1Ym1pdF9yZXF1ZXN0KHN0cnVjdCBpbnRlbF9vdmVy
bGF5ICpvdmVybGF5LAotCQkJCQkgc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEsCi0JCQkJCSBpOTE1
X2FjdGl2ZV9yZXRpcmVfZm4gcmV0aXJlKQorc3RhdGljIHN0cnVjdCBpOTE1X3JlcXVlc3QgKgor
YWxsb2NfcmVxdWVzdChzdHJ1Y3QgaW50ZWxfb3ZlcmxheSAqb3ZlcmxheSwgdm9pZCAoKmZuKShz
dHJ1Y3QgaW50ZWxfb3ZlcmxheSAqKSkKIHsKLQlHRU1fQlVHX09OKGk5MTVfYWN0aXZlX3JlcXVl
c3RfcGVlaygmb3ZlcmxheS0+bGFzdF9mbGlwLAotCQkJCQkgICAgJm92ZXJsYXktPmk5MTUtPmRy
bS5zdHJ1Y3RfbXV0ZXgpKTsKLQlpOTE1X2FjdGl2ZV9yZXF1ZXN0X3NldF9yZXRpcmVfZm4oJm92
ZXJsYXktPmxhc3RfZmxpcCwgcmV0aXJlLAotCQkJCQkgICZvdmVybGF5LT5pOTE1LT5kcm0uc3Ry
dWN0X211dGV4KTsKLQlfX2k5MTVfYWN0aXZlX3JlcXVlc3Rfc2V0KCZvdmVybGF5LT5sYXN0X2Zs
aXAsIHJxKTsKLQlpOTE1X3JlcXVlc3RfYWRkKHJxKTsKLX0KKwlzdHJ1Y3QgaTkxNV9yZXF1ZXN0
ICpycTsKKwlpbnQgZXJyOwogCi1zdGF0aWMgaW50IGludGVsX292ZXJsYXlfZG9fd2FpdF9yZXF1
ZXN0KHN0cnVjdCBpbnRlbF9vdmVybGF5ICpvdmVybGF5LAotCQkJCQkgc3RydWN0IGk5MTVfcmVx
dWVzdCAqcnEsCi0JCQkJCSBpOTE1X2FjdGl2ZV9yZXRpcmVfZm4gcmV0aXJlKQotewotCWludGVs
X292ZXJsYXlfc3VibWl0X3JlcXVlc3Qob3ZlcmxheSwgcnEsIHJldGlyZSk7Ci0JcmV0dXJuIGk5
MTVfYWN0aXZlX3JlcXVlc3RfcmV0aXJlKCZvdmVybGF5LT5sYXN0X2ZsaXAsCi0JCQkJCSAgJm92
ZXJsYXktPmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOwotfQorCW92ZXJsYXktPmZsaXBfY29tcGxl
dGUgPSBmbjsKIAotc3RhdGljIHN0cnVjdCBpOTE1X3JlcXVlc3QgKmFsbG9jX3JlcXVlc3Qoc3Ry
dWN0IGludGVsX292ZXJsYXkgKm92ZXJsYXkpCi17Ci0JcmV0dXJuIGk5MTVfcmVxdWVzdF9jcmVh
dGUob3ZlcmxheS0+Y29udGV4dCk7CisJcnEgPSBpOTE1X3JlcXVlc3RfY3JlYXRlKG92ZXJsYXkt
PmNvbnRleHQpOworCWlmIChJU19FUlIocnEpKQorCQlyZXR1cm4gcnE7CisKKwllcnIgPSBpOTE1
X2FjdGl2ZV9yZWYoJm92ZXJsYXktPmxhc3RfZmxpcCwgcnEtPmZlbmNlLmNvbnRleHQsIHJxKTsK
KwlpZiAoZXJyKSB7CisJCWk5MTVfcmVxdWVzdF9hZGQocnEpOworCQlyZXR1cm4gRVJSX1BUUihl
cnIpOworCX0KKworCXJldHVybiBycTsKIH0KIAogLyogb3ZlcmxheSBuZWVkcyB0byBiZSBkaXNh
YmxlIGluIE9DTUQgcmVnICovCkBAIC0yNTIsNyArMjQ4LDcgQEAgc3RhdGljIGludCBpbnRlbF9v
dmVybGF5X29uKHN0cnVjdCBpbnRlbF9vdmVybGF5ICpvdmVybGF5KQogCiAJV0FSTl9PTihvdmVy
bGF5LT5hY3RpdmUpOwogCi0JcnEgPSBhbGxvY19yZXF1ZXN0KG92ZXJsYXkpOworCXJxID0gYWxs
b2NfcmVxdWVzdChvdmVybGF5LCBOVUxMKTsKIAlpZiAoSVNfRVJSKHJxKSkKIAkJcmV0dXJuIFBU
Ul9FUlIocnEpOwogCkBAIC0yNzMsNyArMjY5LDkgQEAgc3RhdGljIGludCBpbnRlbF9vdmVybGF5
X29uKHN0cnVjdCBpbnRlbF9vdmVybGF5ICpvdmVybGF5KQogCSpjcysrID0gTUlfTk9PUDsKIAlp
bnRlbF9yaW5nX2FkdmFuY2UocnEsIGNzKTsKIAotCXJldHVybiBpbnRlbF9vdmVybGF5X2RvX3dh
aXRfcmVxdWVzdChvdmVybGF5LCBycSwgTlVMTCk7CisJaTkxNV9yZXF1ZXN0X2FkZChycSk7CisK
KwlyZXR1cm4gaTkxNV9hY3RpdmVfd2FpdCgmb3ZlcmxheS0+bGFzdF9mbGlwKTsKIH0KIAogc3Rh
dGljIHZvaWQgaW50ZWxfb3ZlcmxheV9mbGlwX3ByZXBhcmUoc3RydWN0IGludGVsX292ZXJsYXkg
Km92ZXJsYXksCkBAIC0zMTcsNyArMzE1LDcgQEAgc3RhdGljIGludCBpbnRlbF9vdmVybGF5X2Nv
bnRpbnVlKHN0cnVjdCBpbnRlbF9vdmVybGF5ICpvdmVybGF5LAogCWlmICh0bXAgJiAoMSA8PCAx
NykpCiAJCURSTV9ERUJVRygib3ZlcmxheSB1bmRlcnJ1biwgRE9WU1RBOiAleFxuIiwgdG1wKTsK
IAotCXJxID0gYWxsb2NfcmVxdWVzdChvdmVybGF5KTsKKwlycSA9IGFsbG9jX3JlcXVlc3Qob3Zl
cmxheSwgTlVMTCk7CiAJaWYgKElTX0VSUihycSkpCiAJCXJldHVybiBQVFJfRVJSKHJxKTsKIApA
QCAtMzMyLDggKzMzMCw3IEBAIHN0YXRpYyBpbnQgaW50ZWxfb3ZlcmxheV9jb250aW51ZShzdHJ1
Y3QgaW50ZWxfb3ZlcmxheSAqb3ZlcmxheSwKIAlpbnRlbF9yaW5nX2FkdmFuY2UocnEsIGNzKTsK
IAogCWludGVsX292ZXJsYXlfZmxpcF9wcmVwYXJlKG92ZXJsYXksIHZtYSk7Ci0KLQlpbnRlbF9v
dmVybGF5X3N1Ym1pdF9yZXF1ZXN0KG92ZXJsYXksIHJxLCBOVUxMKTsKKwlpOTE1X3JlcXVlc3Rf
YWRkKHJxKTsKIAogCXJldHVybiAwOwogfQpAQCAtMzU0LDIwICszNTEsMTMgQEAgc3RhdGljIHZv
aWQgaW50ZWxfb3ZlcmxheV9yZWxlYXNlX29sZF92bWEoc3RydWN0IGludGVsX292ZXJsYXkgKm92
ZXJsYXkpCiB9CiAKIHN0YXRpYyB2b2lkCi1pbnRlbF9vdmVybGF5X3JlbGVhc2Vfb2xkX3ZpZF90
YWlsKHN0cnVjdCBpOTE1X2FjdGl2ZV9yZXF1ZXN0ICphY3RpdmUsCi0JCQkJICAgc3RydWN0IGk5
MTVfcmVxdWVzdCAqcnEpCitpbnRlbF9vdmVybGF5X3JlbGVhc2Vfb2xkX3ZpZF90YWlsKHN0cnVj
dCBpbnRlbF9vdmVybGF5ICpvdmVybGF5KQogewotCXN0cnVjdCBpbnRlbF9vdmVybGF5ICpvdmVy
bGF5ID0KLQkJY29udGFpbmVyX29mKGFjdGl2ZSwgdHlwZW9mKCpvdmVybGF5KSwgbGFzdF9mbGlw
KTsKLQogCWludGVsX292ZXJsYXlfcmVsZWFzZV9vbGRfdm1hKG92ZXJsYXkpOwogfQogCi1zdGF0
aWMgdm9pZCBpbnRlbF9vdmVybGF5X29mZl90YWlsKHN0cnVjdCBpOTE1X2FjdGl2ZV9yZXF1ZXN0
ICphY3RpdmUsCi0JCQkJICAgc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEpCitzdGF0aWMgdm9pZCBp
bnRlbF9vdmVybGF5X29mZl90YWlsKHN0cnVjdCBpbnRlbF9vdmVybGF5ICpvdmVybGF5KQogewot
CXN0cnVjdCBpbnRlbF9vdmVybGF5ICpvdmVybGF5ID0KLQkJY29udGFpbmVyX29mKGFjdGl2ZSwg
dHlwZW9mKCpvdmVybGF5KSwgbGFzdF9mbGlwKTsKIAlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAq
ZGV2X3ByaXYgPSBvdmVybGF5LT5pOTE1OwogCiAJaW50ZWxfb3ZlcmxheV9yZWxlYXNlX29sZF92
bWEob3ZlcmxheSk7CkBAIC0zODAsNiArMzcwLDE2IEBAIHN0YXRpYyB2b2lkIGludGVsX292ZXJs
YXlfb2ZmX3RhaWwoc3RydWN0IGk5MTVfYWN0aXZlX3JlcXVlc3QgKmFjdGl2ZSwKIAkJaTgzMF9v
dmVybGF5X2Nsb2NrX2dhdGluZyhkZXZfcHJpdiwgdHJ1ZSk7CiB9CiAKK3N0YXRpYyB2b2lkCitp
bnRlbF9vdmVybGF5X2xhc3RfZmxpcF9yZXRpcmUoc3RydWN0IGk5MTVfYWN0aXZlICphY3RpdmUp
Cit7CisJc3RydWN0IGludGVsX292ZXJsYXkgKm92ZXJsYXkgPQorCQljb250YWluZXJfb2YoYWN0
aXZlLCB0eXBlb2YoKm92ZXJsYXkpLCBsYXN0X2ZsaXApOworCisJaWYgKG92ZXJsYXktPmZsaXBf
Y29tcGxldGUpCisJCW92ZXJsYXktPmZsaXBfY29tcGxldGUob3ZlcmxheSk7Cit9CisKIC8qIG92
ZXJsYXkgbmVlZHMgdG8gYmUgZGlzYWJsZWQgaW4gT0NNRCByZWcgKi8KIHN0YXRpYyBpbnQgaW50
ZWxfb3ZlcmxheV9vZmYoc3RydWN0IGludGVsX292ZXJsYXkgKm92ZXJsYXkpCiB7CkBAIC0zOTQs
NyArMzk0LDcgQEAgc3RhdGljIGludCBpbnRlbF9vdmVybGF5X29mZihzdHJ1Y3QgaW50ZWxfb3Zl
cmxheSAqb3ZlcmxheSkKIAkgKiBvZiB0aGUgaHcuIERvIGl0IGluIGJvdGggY2FzZXMgKi8KIAlm
bGlwX2FkZHIgfD0gT0ZDX1VQREFURTsKIAotCXJxID0gYWxsb2NfcmVxdWVzdChvdmVybGF5KTsK
KwlycSA9IGFsbG9jX3JlcXVlc3Qob3ZlcmxheSwgaW50ZWxfb3ZlcmxheV9vZmZfdGFpbCk7CiAJ
aWYgKElTX0VSUihycSkpCiAJCXJldHVybiBQVFJfRVJSKHJxKTsKIApAQCAtNDE3LDE3ICs0MTcs
MTYgQEAgc3RhdGljIGludCBpbnRlbF9vdmVybGF5X29mZihzdHJ1Y3QgaW50ZWxfb3ZlcmxheSAq
b3ZlcmxheSkKIAlpbnRlbF9yaW5nX2FkdmFuY2UocnEsIGNzKTsKIAogCWludGVsX292ZXJsYXlf
ZmxpcF9wcmVwYXJlKG92ZXJsYXksIE5VTEwpOworCWk5MTVfcmVxdWVzdF9hZGQocnEpOwogCi0J
cmV0dXJuIGludGVsX292ZXJsYXlfZG9fd2FpdF9yZXF1ZXN0KG92ZXJsYXksIHJxLAotCQkJCQkg
ICAgIGludGVsX292ZXJsYXlfb2ZmX3RhaWwpOworCXJldHVybiBpOTE1X2FjdGl2ZV93YWl0KCZv
dmVybGF5LT5sYXN0X2ZsaXApOwogfQogCiAvKiByZWNvdmVyIGZyb20gYW4gaW50ZXJydXB0aW9u
IGR1ZSB0byBhIHNpZ25hbAogICogV2UgaGF2ZSB0byBiZSBjYXJlZnVsIG5vdCB0byByZXBlYXQg
d29yayBmb3JldmVyIGFuIG1ha2UgZm9yd2FyZCBwcm9nZXNzLiAqLwogc3RhdGljIGludCBpbnRl
bF9vdmVybGF5X3JlY292ZXJfZnJvbV9pbnRlcnJ1cHQoc3RydWN0IGludGVsX292ZXJsYXkgKm92
ZXJsYXkpCiB7Ci0JcmV0dXJuIGk5MTVfYWN0aXZlX3JlcXVlc3RfcmV0aXJlKCZvdmVybGF5LT5s
YXN0X2ZsaXAsCi0JCQkJCSAgJm92ZXJsYXktPmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOworCXJl
dHVybiBpOTE1X2FjdGl2ZV93YWl0KCZvdmVybGF5LT5sYXN0X2ZsaXApOwogfQogCiAvKiBXYWl0
IGZvciBwZW5kaW5nIG92ZXJsYXkgZmxpcCBhbmQgcmVsZWFzZSBvbGQgZnJhbWUuCkBAIC00Mzcs
NDMgKzQzNiw0MCBAQCBzdGF0aWMgaW50IGludGVsX292ZXJsYXlfcmVjb3Zlcl9mcm9tX2ludGVy
cnVwdChzdHJ1Y3QgaW50ZWxfb3ZlcmxheSAqb3ZlcmxheSkKIHN0YXRpYyBpbnQgaW50ZWxfb3Zl
cmxheV9yZWxlYXNlX29sZF92aWQoc3RydWN0IGludGVsX292ZXJsYXkgKm92ZXJsYXkpCiB7CiAJ
c3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2ID0gb3ZlcmxheS0+aTkxNTsKKwlzdHJ1
Y3QgaTkxNV9yZXF1ZXN0ICpycTsKIAl1MzIgKmNzOwotCWludCByZXQ7CiAKIAlsb2NrZGVwX2Fz
c2VydF9oZWxkKCZkZXZfcHJpdi0+ZHJtLnN0cnVjdF9tdXRleCk7CiAKLQkvKiBPbmx5IHdhaXQg
aWYgdGhlcmUgaXMgYWN0dWFsbHkgYW4gb2xkIGZyYW1lIHRvIHJlbGVhc2UgdG8KKwkvKgorCSAq
IE9ubHkgd2FpdCBpZiB0aGVyZSBpcyBhY3R1YWxseSBhbiBvbGQgZnJhbWUgdG8gcmVsZWFzZSB0
bwogCSAqIGd1YXJhbnRlZSBmb3J3YXJkIHByb2dyZXNzLgogCSAqLwogCWlmICghb3ZlcmxheS0+
b2xkX3ZtYSkKIAkJcmV0dXJuIDA7CiAKLQlpZiAoSTkxNV9SRUFEKEdFTjJfSVNSKSAmIEk5MTVf
T1ZFUkxBWV9QTEFORV9GTElQX1BFTkRJTkdfSU5URVJSVVBUKSB7Ci0JCS8qIHN5bmNocm9ub3Vz
IHNsb3dwYXRoICovCi0JCXN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxOworCWlmICghKEk5MTVfUkVB
RChHRU4yX0lTUikgJiBJOTE1X09WRVJMQVlfUExBTkVfRkxJUF9QRU5ESU5HX0lOVEVSUlVQVCkp
IHsKKwkJaW50ZWxfb3ZlcmxheV9yZWxlYXNlX29sZF92aWRfdGFpbChvdmVybGF5KTsKKwkJcmV0
dXJuIDA7CisJfQogCi0JCXJxID0gYWxsb2NfcmVxdWVzdChvdmVybGF5KTsKLQkJaWYgKElTX0VS
UihycSkpCi0JCQlyZXR1cm4gUFRSX0VSUihycSk7CisJcnEgPSBhbGxvY19yZXF1ZXN0KG92ZXJs
YXksIGludGVsX292ZXJsYXlfcmVsZWFzZV9vbGRfdmlkX3RhaWwpOworCWlmIChJU19FUlIocnEp
KQorCQlyZXR1cm4gUFRSX0VSUihycSk7CiAKLQkJY3MgPSBpbnRlbF9yaW5nX2JlZ2luKHJxLCAy
KTsKLQkJaWYgKElTX0VSUihjcykpIHsKLQkJCWk5MTVfcmVxdWVzdF9hZGQocnEpOwotCQkJcmV0
dXJuIFBUUl9FUlIoY3MpOwotCQl9CisJY3MgPSBpbnRlbF9yaW5nX2JlZ2luKHJxLCAyKTsKKwlp
ZiAoSVNfRVJSKGNzKSkgeworCQlpOTE1X3JlcXVlc3RfYWRkKHJxKTsKKwkJcmV0dXJuIFBUUl9F
UlIoY3MpOworCX0KIAotCQkqY3MrKyA9IE1JX1dBSVRfRk9SX0VWRU5UIHwgTUlfV0FJVF9GT1Jf
T1ZFUkxBWV9GTElQOwotCQkqY3MrKyA9IE1JX05PT1A7Ci0JCWludGVsX3JpbmdfYWR2YW5jZShy
cSwgY3MpOworCSpjcysrID0gTUlfV0FJVF9GT1JfRVZFTlQgfCBNSV9XQUlUX0ZPUl9PVkVSTEFZ
X0ZMSVA7CisJKmNzKysgPSBNSV9OT09QOworCWludGVsX3JpbmdfYWR2YW5jZShycSwgY3MpOwog
Ci0JCXJldCA9IGludGVsX292ZXJsYXlfZG9fd2FpdF9yZXF1ZXN0KG92ZXJsYXksIHJxLAotCQkJ
CQkJICAgIGludGVsX292ZXJsYXlfcmVsZWFzZV9vbGRfdmlkX3RhaWwpOwotCQlpZiAocmV0KQot
CQkJcmV0dXJuIHJldDsKLQl9IGVsc2UKLQkJaW50ZWxfb3ZlcmxheV9yZWxlYXNlX29sZF92aWRf
dGFpbCgmb3ZlcmxheS0+bGFzdF9mbGlwLCBOVUxMKTsKKwlpOTE1X3JlcXVlc3RfYWRkKHJxKTsK
IAotCXJldHVybiAwOworCXJldHVybiBpOTE1X2FjdGl2ZV93YWl0KCZvdmVybGF5LT5sYXN0X2Zs
aXApOwogfQogCiB2b2lkIGludGVsX292ZXJsYXlfcmVzZXQoc3RydWN0IGRybV9pOTE1X3ByaXZh
dGUgKmRldl9wcml2KQpAQCAtMTM3NSw3ICsxMzcxLDkgQEAgdm9pZCBpbnRlbF9vdmVybGF5X3Nl
dHVwKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdikKIAlvdmVybGF5LT5jb250cmFz
dCA9IDc1OwogCW92ZXJsYXktPnNhdHVyYXRpb24gPSAxNDY7CiAKLQlJTklUX0FDVElWRV9SRVFV
RVNUKCZvdmVybGF5LT5sYXN0X2ZsaXApOworCWk5MTVfYWN0aXZlX2luaXQoZGV2X3ByaXYsCisJ
CQkgJm92ZXJsYXktPmxhc3RfZmxpcCwKKwkJCSBOVUxMLCBpbnRlbF9vdmVybGF5X2xhc3RfZmxp
cF9yZXRpcmUpOwogCiAJcmV0ID0gZ2V0X3JlZ2lzdGVycyhvdmVybGF5LCBPVkVSTEFZX05FRURT
X1BIWVNJQ0FMKGRldl9wcml2KSk7CiAJaWYgKHJldCkKQEAgLTE0MDksNiArMTQwNyw3IEBAIHZv
aWQgaW50ZWxfb3ZlcmxheV9jbGVhbnVwKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJp
dikKIAlXQVJOX09OKG92ZXJsYXktPmFjdGl2ZSk7CiAKIAlpOTE1X2dlbV9vYmplY3RfcHV0KG92
ZXJsYXktPnJlZ19ibyk7CisJaTkxNV9hY3RpdmVfZmluaSgmb3ZlcmxheS0+bGFzdF9mbGlwKTsK
IAogCWtmcmVlKG92ZXJsYXkpOwogfQpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUv
aTkxNV9hY3RpdmUuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfYWN0aXZlLmgKaW5kZXgg
MTM0MTY2ZDMxMjUxLi45MTFhODMzODAwN2EgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2k5MTVfYWN0aXZlLmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9hY3RpdmUu
aApAQCAtODksMjUgKzg5LDYgQEAgaW50IF9fbXVzdF9jaGVjawogaTkxNV9hY3RpdmVfcmVxdWVz
dF9zZXQoc3RydWN0IGk5MTVfYWN0aXZlX3JlcXVlc3QgKmFjdGl2ZSwKIAkJCXN0cnVjdCBpOTE1
X3JlcXVlc3QgKnJxKTsKIAotLyoqCi0gKiBpOTE1X2FjdGl2ZV9yZXF1ZXN0X3NldF9yZXRpcmVf
Zm4gLSB1cGRhdGVzIHRoZSByZXRpcmVtZW50IGNhbGxiYWNrCi0gKiBAYWN0aXZlIC0gdGhlIGFj
dGl2ZSB0cmFja2VyCi0gKiBAZm4gLSB0aGUgcm91dGluZSBjYWxsZWQgd2hlbiB0aGUgcmVxdWVz
dCBpcyByZXRpcmVkCi0gKiBAbXV0ZXggLSBzdHJ1Y3RfbXV0ZXggdXNlZCB0byBndWFyZCByZXRp
cmVtZW50cwotICoKLSAqIGk5MTVfYWN0aXZlX3JlcXVlc3Rfc2V0X3JldGlyZV9mbigpIHVwZGF0
ZXMgdGhlIGZ1bmN0aW9uIHBvaW50ZXIgdGhhdAotICogaXMgY2FsbGVkIHdoZW4gdGhlIGZpbmFs
IHJlcXVlc3QgYXNzb2NpYXRlZCB3aXRoIHRoZSBAYWN0aXZlIHRyYWNrZXIKLSAqIGlzIHJldGly
ZWQuCi0gKi8KLXN0YXRpYyBpbmxpbmUgdm9pZAotaTkxNV9hY3RpdmVfcmVxdWVzdF9zZXRfcmV0
aXJlX2ZuKHN0cnVjdCBpOTE1X2FjdGl2ZV9yZXF1ZXN0ICphY3RpdmUsCi0JCQkJICBpOTE1X2Fj
dGl2ZV9yZXRpcmVfZm4gZm4sCi0JCQkJICBzdHJ1Y3QgbXV0ZXggKm11dGV4KQotewotCWxvY2tk
ZXBfYXNzZXJ0X2hlbGQobXV0ZXgpOwotCWFjdGl2ZS0+cmV0aXJlID0gZm4gPzogaTkxNV9hY3Rp
dmVfcmV0aXJlX25vb3A7Ci19Ci0KIC8qKgogICogaTkxNV9hY3RpdmVfcmVxdWVzdF9yYXcgLSBy
ZXR1cm4gdGhlIGFjdGl2ZSByZXF1ZXN0CiAgKiBAYWN0aXZlIC0gdGhlIGFjdGl2ZSB0cmFja2Vy
Ci0tIAoyLjIyLjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9y
ZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWdm
eA==

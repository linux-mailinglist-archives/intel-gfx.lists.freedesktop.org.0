Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id B9ADAF9AE2
	for <lists+intel-gfx@lfdr.de>; Tue, 12 Nov 2019 21:39:02 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 07A4D6E51C;
	Tue, 12 Nov 2019 20:39:01 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id B16996E51C
 for <intel-gfx@lists.freedesktop.org>; Tue, 12 Nov 2019 20:38:59 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 19179224-1500050 
 for multiple; Tue, 12 Nov 2019 20:38:33 +0000
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Tue, 12 Nov 2019 20:38:31 +0000
Message-Id: <20191112203831.23738-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.24.0
In-Reply-To: <20191112135454.21062-1-chris@chris-wilson.co.uk>
References: <20191112135454.21062-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH] drm/i915: Flush all user surfaces prior to
 first use
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Daniel Vetter <daniel.vetter@ffwll.ch>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

U2luY2UgdXNlcnNwYWNlIGhhcyB0aGUgYWJpbGl0eSB0byBieXBhc3MgdGhlIENQVSBjYWNoZSBm
cm9tIHdpdGhpbiBpdHMKdW5wcml2aWxlZ2VkIGNvbW1hbmQgc3RyZWFtLCB3ZSBoYXZlIHRvIGZs
dXNoIHRoZSBDUFUgY2FjaGUgdG8gbWVtb3J5CmluIG9yZGVyIHRvIG92ZXJ3cml0ZSB0aGUgcHJl
dmlvdXMgY29udGVudHMgb24gY3JlYXRpb24uIFdlIGVuZm9yY2UgdGhpcwphdCB0aGUgYm91bmRh
cnkgcG9pbnRzIChnZXQvcHV0IHBhZ2VzKSB0byBlbnN1cmUgdGhhdCBiZWZvcmUgcmVjeWNsaW5n
CnN5c3RlbSBwYWdlcyB3ZSBhcmUgYWx3YXlzIGNhY2hlIGNvaGVyZW50LgoKdjM6IFdlIG5vdyBh
bHdheXMgY2xmbHVzaCBvbiBhY3F1aXNpdGlvbiBhbmQgcmVsZWFzZSBvZiBzeXN0ZW0gcGFnZXMs
CmFuZCBpbmNsdWRlIGEgY2xmbHVzaCBjb3VudGluZyBzZWxmdGVzdCB0byBtYWtlIHN1cmUgd2Ug
ZG8uIFRoaXMgYWxzbwpzdWNjaW5jdGx5IGNvdmVycyBzd2FwLWluL3N3YXAtb3V0LgoKU2lnbmVk
LW9mZi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28udWs+CkNjOiBKb29u
YXMgTGFodGluZW4gPGpvb25hcy5sYWh0aW5lbkBsaW51eC5pbnRlbC5jb20+CkNjOiBWaWxsZSBT
eXJqw6Rsw6QgPHZpbGxlLnN5cmphbGFAbGludXguaW50ZWwuY29tPgpDYzogRnJhbmNpc2NvIEpl
cmV6IDxjdXJyb2plcmV6QHJpc2V1cC5uZXQ+CkNjOiBEYW5pZWwgVmV0dGVyIDxkYW5pZWwudmV0
dGVyQGZmd2xsLmNoPgotLS0KUmVtZW1iZXIgdGhlIGRpZmZlcmVuY2UgaW4gY2xmbHVzaCBiZWhh
dmlvdXIgYmV0d2VlbiBsbGMgYW5kICFsbGMuCi0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2Vt
L2k5MTVfZ2VtX2NsZmx1c2guYyAgIHwgICA4ICsrCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0v
aTkxNV9nZW1fY2xmbHVzaC5oICAgfCAgIDYgKwogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5
MTVfZ2VtX3BhZ2VzLmMgICAgIHwgICA3ICstCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkx
NV9nZW1fc2htZW0uYyAgICAgfCAgMjIgKysrLQogLi4uL2k5MTUvZ2VtL3NlbGZ0ZXN0cy9pOTE1
X2dlbV9jb2hlcmVuY3kuYyAgIHwgMTEzICsrKysrKysrKysrKysrKysrKwogZHJpdmVycy9ncHUv
ZHJtL2k5MTUvaTkxNV9kcnYuaCAgICAgICAgICAgICAgIHwgICAyICsKIDYgZmlsZXMgY2hhbmdl
ZCwgMTUzIGluc2VydGlvbnMoKyksIDUgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NsZmx1c2guYyBiL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2dlbS9pOTE1X2dlbV9jbGZsdXNoLmMKaW5kZXggYjlmNTA0YmEzYjMyLi5lMjQzNGUxN2Zm
YzEgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jbGZsdXNo
LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NsZmx1c2guYwpAQCAt
MTYsMTEgKzE2LDE5IEBAIHN0cnVjdCBjbGZsdXNoIHsKIAlzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29i
amVjdCAqb2JqOwogfTsKIAorI2lmIElTX0VOQUJMRUQoQ09ORklHX0RSTV9JOTE1X1NFTEZURVNU
KQordm9pZCBzdF9jbGZsdXNoX2luYyhzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqKQor
eworCWF0b21pY19pbmMoJnRvX2k5MTUob2JqLT5iYXNlLmRldiktPmdlbS5jbGZsdXNoZXMpOwor
fQorI2VuZGlmCisKIHN0YXRpYyB2b2lkIF9fZG9fY2xmbHVzaChzdHJ1Y3QgZHJtX2k5MTVfZ2Vt
X29iamVjdCAqb2JqKQogewogCUdFTV9CVUdfT04oIWk5MTVfZ2VtX29iamVjdF9oYXNfcGFnZXMo
b2JqKSk7CiAJZHJtX2NsZmx1c2hfc2cob2JqLT5tbS5wYWdlcyk7CiAJaW50ZWxfZnJvbnRidWZm
ZXJfZmx1c2gob2JqLT5mcm9udGJ1ZmZlciwgT1JJR0lOX0NQVSk7CisJc3RfY2xmbHVzaF9pbmMo
b2JqKTsKIH0KIAogc3RhdGljIGludCBjbGZsdXNoX3dvcmsoc3RydWN0IGRtYV9mZW5jZV93b3Jr
ICpiYXNlKQpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2Ns
Zmx1c2guaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jbGZsdXNoLmgKaW5k
ZXggZTZjMzgyOTczMTI5Li43NDM0ZDg3OGE1NTMgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2dlbS9pOTE1X2dlbV9jbGZsdXNoLmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUv
Z2VtL2k5MTVfZ2VtX2NsZmx1c2guaApAQCAtMTcsNCArMTcsMTAgQEAgYm9vbCBpOTE1X2dlbV9j
bGZsdXNoX29iamVjdChzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqLAogI2RlZmluZSBJ
OTE1X0NMRkxVU0hfRk9SQ0UgQklUKDApCiAjZGVmaW5lIEk5MTVfQ0xGTFVTSF9TWU5DIEJJVCgx
KQogCisjaWYgSVNfRU5BQkxFRChDT05GSUdfRFJNX0k5MTVfU0VMRlRFU1QpCit2b2lkIHN0X2Ns
Zmx1c2hfaW5jKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmopOworI2Vsc2UKK3N0YXRp
YyBpbmxpbmUgdm9pZCBzdF9jbGZsdXNoX2luYyhzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAq
b2JqKSB7IH0KKyNlbmRpZgorCiAjZW5kaWYgLyogX19JOTE1X0dFTV9DTEZMVVNIX0hfXyAqLwpk
aWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3BhZ2VzLmMgYi9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fcGFnZXMuYwppbmRleCBmNDAyYzJjNDE1
YzIuLjhiY2Y5YjY1ZDY2MSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5
MTVfZ2VtX3BhZ2VzLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3Bh
Z2VzLmMKQEAgLTUsOSArNSwxMCBAQAogICovCiAKICNpbmNsdWRlICJpOTE1X2Rydi5oIgorI2lu
Y2x1ZGUgImk5MTVfZ2VtX2NsZmx1c2guaCIKKyNpbmNsdWRlICJpOTE1X2dlbV9sbWVtLmgiCiAj
aW5jbHVkZSAiaTkxNV9nZW1fb2JqZWN0LmgiCiAjaW5jbHVkZSAiaTkxNV9zY2F0dGVybGlzdC5o
IgotI2luY2x1ZGUgImk5MTVfZ2VtX2xtZW0uaCIKIAogdm9pZCBfX2k5MTVfZ2VtX29iamVjdF9z
ZXRfcGFnZXMoc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiwKIAkJCQkgc3RydWN0IHNn
X3RhYmxlICpwYWdlcywKQEAgLTI1LDggKzI2LDEwIEBAIHZvaWQgX19pOTE1X2dlbV9vYmplY3Rf
c2V0X3BhZ2VzKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmosCiAJLyogTWFrZSB0aGUg
cGFnZXMgY29oZXJlbnQgd2l0aCB0aGUgR1BVIChmbHVzaGluZyBhbnkgc3dhcGluKS4gKi8KIAlp
ZiAob2JqLT5jYWNoZV9kaXJ0eSkgewogCQlvYmotPndyaXRlX2RvbWFpbiA9IDA7Ci0JCWlmIChp
OTE1X2dlbV9vYmplY3RfaGFzX3N0cnVjdF9wYWdlKG9iaikpCisJCWlmIChpOTE1X2dlbV9vYmpl
Y3RfaGFzX3N0cnVjdF9wYWdlKG9iaikpIHsKIAkJCWRybV9jbGZsdXNoX3NnKHBhZ2VzKTsKKwkJ
CXN0X2NsZmx1c2hfaW5jKG9iaik7CisJCX0KIAkJb2JqLT5jYWNoZV9kaXJ0eSA9IGZhbHNlOwog
CX0KIApkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3NobWVt
LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fc2htZW0uYwppbmRleCA0ZDY5
YzNmYzM0MzkuLjlkYjUzYTRkMWIyZSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUv
Z2VtL2k5MTVfZ2VtX3NobWVtLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVf
Z2VtX3NobWVtLmMKQEAgLTEwLDYgKzEwLDcgQEAKICNpbmNsdWRlICJnZW0vaTkxNV9nZW1fcmVn
aW9uLmgiCiAjaW5jbHVkZSAiaTkxNV9kcnYuaCIKICNpbmNsdWRlICJpOTE1X2dlbWZzLmgiCisj
aW5jbHVkZSAiaTkxNV9nZW1fY2xmbHVzaC5oIgogI2luY2x1ZGUgImk5MTVfZ2VtX29iamVjdC5o
IgogI2luY2x1ZGUgImk5MTVfc2NhdHRlcmxpc3QuaCIKICNpbmNsdWRlICJpOTE1X3RyYWNlLmgi
CkBAIC0xODMsNiArMTg0LDE1IEBAIHN0YXRpYyBpbnQgc2htZW1fZ2V0X3BhZ2VzKHN0cnVjdCBk
cm1faTkxNV9nZW1fb2JqZWN0ICpvYmopCiAJaWYgKGk5MTVfZ2VtX29iamVjdF9uZWVkc19iaXQx
N19zd2l6emxlKG9iaikpCiAJCWk5MTVfZ2VtX29iamVjdF9kb19iaXRfMTdfc3dpenpsZShvYmos
IHN0KTsKIAorCS8qCisJICogU2luY2UgdXNlcnNwYWNlIGhhcyB0aGUgYWJpbGl0eSB0byBieXBh
c3MgdGhlIENQVSBjYWNoZSBmcm9tIHdpdGhpbgorCSAqIGl0cyB1bnByaXZpbGVnZWQgY29tbWFu
ZCBzdHJlYW0sIHdlIGhhdmUgdG8gZmx1c2ggdGhlIENQVSBjYWNoZSB0bworCSAqIG1lbW9yeSBp
biBvcmRlciB0byBvdmVyd3JpdGUgdGhlIHByZXZpb3VzIGNvbnRlbnRzIG9uIGNyZWF0aW9uLCBz
bworCSAqIHRoYXQgdXNlcnNwYWNlIGNhbm5vdCBzbm9vcCBvbiB0aGUgb2xkIHN5c3RlbSBwYWdl
cyBqdXN0IGhhbmRlZCB0bworCSAqIHVzLgorCSAqLworCW9iai0+Y2FjaGVfZGlydHkgPSB0cnVl
OyAvKiBGb3IgZHJtX2NsZmx1c2hfc2coKSBpbnNpZGUgc2V0X3BhZ2VzICovCisKIAlfX2k5MTVf
Z2VtX29iamVjdF9zZXRfcGFnZXMob2JqLCBzdCwgc2dfcGFnZV9zaXplcyk7CiAKIAlyZXR1cm4g
MDsKQEAgLTI4NSwxMCArMjk1LDE2IEBAIF9faTkxNV9nZW1fb2JqZWN0X3JlbGVhc2Vfc2htZW0o
c3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiwKIAlpZiAob2JqLT5tbS5tYWR2ID09IEk5
MTVfTUFEVl9ET05UTkVFRCkKIAkJb2JqLT5tbS5kaXJ0eSA9IGZhbHNlOwogCi0JaWYgKG5lZWRz
X2NsZmx1c2ggJiYKLQkgICAgKG9iai0+cmVhZF9kb21haW5zICYgSTkxNV9HRU1fRE9NQUlOX0NQ
VSkgPT0gMCAmJgotCSAgICAhKG9iai0+Y2FjaGVfY29oZXJlbnQgJiBJOTE1X0JPX0NBQ0hFX0NP
SEVSRU5UX0ZPUl9SRUFEKSkKKwkvKgorCSAqIFVubGVzcyB3ZSBrbm93IGZvciBjZXJ0YWluIHRo
YXQgdGhlIG1haW4gbWVtb3J5IGNvbnRlbnRzIGFyZQorCSAqIGNvaGVyZW50IHdpdGggdGhlIENQ
VSBjYWNoZSwgZmx1c2ggdGhlIENQVSBjYWNoZS4gVGhpcyBlbnN1cmVzCisJICogdGhhdCB1c2Vy
c3BhY2UgdGhhdCBoYXMgYnlwYXNzZWQgdGhlIENQVSBjYWNoZSB0byB3cml0ZSBpbnRvCisJICog
bWFpbiBtZW1vcnkgZG9lcyBub3QgbGVhayB0aGUgY29udGVudHMgb2YgaXRzIENQVSBjYWNoZS4K
KwkgKi8KKwlpZiAob2JqLT53cml0ZV9kb21haW4gIT0gSTkxNV9HRU1fRE9NQUlOX0NQVSkgewog
CQlkcm1fY2xmbHVzaF9zZyhwYWdlcyk7CisJCXN0X2NsZmx1c2hfaW5jKG9iaik7CisJfQogCiAJ
X19zdGFydF9jcHVfd3JpdGUob2JqKTsKIH0KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2dlbS9zZWxmdGVzdHMvaTkxNV9nZW1fY29oZXJlbmN5LmMgYi9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9nZW0vc2VsZnRlc3RzL2k5MTVfZ2VtX2NvaGVyZW5jeS5jCmluZGV4IDJiMjlmNmI0ZTFk
ZC4uMjBjNzZhOGY4MWZkIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vc2Vs
ZnRlc3RzL2k5MTVfZ2VtX2NvaGVyZW5jeS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dl
bS9zZWxmdGVzdHMvaTkxNV9nZW1fY29oZXJlbmN5LmMKQEAgLTYsNiArNiw4IEBACiAKICNpbmNs
dWRlIDxsaW51eC9wcmltZV9udW1iZXJzLmg+CiAKKyNpbmNsdWRlICJnZW0vaTkxNV9nZW1fY2xm
bHVzaC5oIgorI2luY2x1ZGUgImdlbS9pOTE1X2dlbV9vYmplY3QuaCIKICNpbmNsdWRlICJndC9p
bnRlbF9ndC5oIgogI2luY2x1ZGUgImd0L2ludGVsX2d0X3BtLmgiCiAjaW5jbHVkZSAiZ3QvaW50
ZWxfcmluZy5oIgpAQCAtMjk3LDYgKzI5OSwxMTYgQEAgcmFuZG9tX2VuZ2luZShzdHJ1Y3QgZHJt
X2k5MTVfcHJpdmF0ZSAqaTkxNSwgc3RydWN0IHJuZF9zdGF0ZSAqcHJuZykKIAlyZXR1cm4gTlVM
TDsKIH0KIAorc3RhdGljIGludCBjaGVja2VkX2NsZmx1c2goc3RydWN0IGRybV9pOTE1X2dlbV9v
YmplY3QgKm9iaiwKKwkJCSAgIHVuc2lnbmVkIGludCBmbGFncywKKwkJCSAgIGludCBleHBlY3Rl
ZCkKK3sKKwlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSA9IHRvX2k5MTUob2JqLT5iYXNl
LmRldik7CisJdW5zaWduZWQgaW50IGNsZmx1c2hlcyA9IGF0b21pY19yZWFkKCZpOTE1LT5nZW0u
Y2xmbHVzaGVzKTsKKwlpbnQgZXJyID0gMDsKKworCWk5MTVfZ2VtX29iamVjdF9sb2NrKG9iaik7
CisKKwlpOTE1X2dlbV9jbGZsdXNoX29iamVjdChvYmosIGZsYWdzKTsKKworCWlmIChvYmotPmNh
Y2hlX2RpcnR5KSB7CisJCXByX2VycigiY2xmbHVzaCBkaWQgbm90IGNsZWFyIG9iai0+Y2FjaGVf
ZGlydHkhXG4iKTsKKwkJZXJyID0gLUVJTlZBTDsKKwkJZ290byB1bmxvY2s7CisJfQorCisJaWYg
KGF0b21pY19yZWFkKCZpOTE1LT5nZW0uY2xmbHVzaGVzKSAhPSBjbGZsdXNoZXMgKyBleHBlY3Rl
ZCkgeworCQlwcl9lcnIoImNsZmx1c2ggY291bnRlciBkaWQgbm90IG1hdGNoIVxuIik7CisJCWVy
ciA9IC1FSU5WQUw7CisJCWdvdG8gdW5sb2NrOworCX0KKwordW5sb2NrOgorCWk5MTVfZ2VtX29i
amVjdF91bmxvY2sob2JqKTsKKwlyZXR1cm4gZXJyOworfQorCitzdGF0aWMgaW50IGlndF9nZW1f
Y2xmbHVzaCh2b2lkICphcmcpCit7CisJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUgPSBh
cmc7CisJc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iajsKKwl1bnNpZ25lZCBpbnQgY2xm
bHVzaGVzOworCWludCBlcnIgPSAwOworCisJLyoKKwkgKiBCZWZvcmUgdGhlIGRhdGEgaXMgdmlz
aWJsZSB0byB0aGUgR1BVLCB3ZSBzb21ldGltZXMgaGF2ZSB0bworCSAqIGZsdXNoIHRoZSBDUFUg
Y2FjaGUuIEZvciBleGFtcGxlLCBvbmx5IHdpdGggdGhlIGludHJvZHVjdGlvbgorCSAqIG9mIExM
QyB3aXRoIFNhbmR5YnJpZGUgY291bGQgdGhlIEdQVSBhbmQgQ1BVIGNhY2hlcyBiZSBmdWxseQor
CSAqIGNvaGVyZW50LiBIb3dldmVyLCB0aGUgZGlzcGxheSBlbmdpbmUgKHNjYW5vdXQpIGhhcyBk
aWZmZXJlbnQKKwkgKiBjb2hlcmVuY3kgd2l0aCB0aGUgR1BVIHRoZW4gdGhlIENQVSwgYW5kIGV2
ZW4gaWYgdGhlIENQVS9HUFUKKwkgKiBjb3VsZCB0YWxrIHRvIGVhY2ggb3RoZXIgd2Ugd291bGQg
c3RpbGwgbmVlZCB0byBmbHVzaCB0aGUgQ1BVCisJICogY2FjaGVzIGZvciBzY2Fub3V0LiBGaW5h
bGx5LCB1c2Vyc3BhY2UgY2FuIGJ5cGFzcyB0aGUgY2FjaGUKKwkgKiBzbm9vcGluZyBhbHRvZ2V0
aGVyIGZyb20gaW5zaWRlIGl0cyB1bnByaXZpbGVnZWQgYmF0Y2ggYnVmZXJzLgorCSAqCisJICog
V2UgdXNlIGRybV9jbGZsdXNoXyooKSB0byBjbGVhciB0aGUgQ1BVIGNhY2hlbGluZXMgb24gc3Vj
aAorCSAqIHRyYW5zaXRpb25zLCBzbyB3ZSBjYW4gYXNzZXJ0IHRoYXQgd2Ugd2lsbCBkbyBzbyBi
eSBzZXR0aW5nCisJICogdXAgdGhlIGRpcnR5IHN0YXRlIGFuZCBsb29raW5nIGF0IG91ciBjbGZs
dXNoIGNvdW50ZXIKKwkgKi8KKworCS8qCisJICogQ3JlYXRpbmcgYSBzaG1lbSBvYmplY3QgZnJv
bSBzeXN0ZW0gcGFnZXMsIHdlIG11c3QgYXNzdW1lCisJICogdGhlIENQVSBjYWNoZSBpcyBkaXJ0
eS4gVGhhdCBpcyB0aGUgbWFpbiBtZW1vcnkgY2FuIGhhdmUKKwkgKiBkaWZmZXJlbnQgKHN0YWxl
KSBjb250ZW50IHRoYW4gdGhlIENQVSwgYXMgdGhlIGtlcm5lbAorCSAqIGV4cGVjdHMgYWxsIHJl
YWRzIHRvIGNvbWUgZnJvbSB0aGUgQ1BVIGNhY2hlLiBBcyB3ZSBrbm93IHRoZSBHUFUKKwkgKiBt
YXkgaWdub3JlIHRoZSBDUFUgY2FjaGUgYW5kIHJlYWQgZnJvbSBtZW1vcnkgaW5zdGVhZCwgd2Ug
bXVzdAorCSAqIGFzc3VtZSB0aGUgd29yc3QuCisJICovCisJb2JqID0gaTkxNV9nZW1fb2JqZWN0
X2NyZWF0ZV9zaG1lbShpOTE1LCA0MDk2KTsKKwlpZiAoSVNfRVJSKG9iaikpCisJCXJldHVybiBQ
VFJfRVJSKG9iaik7CisKKwkvKiBXZSBhbHdheXMgY2xmbHVzaCBvbiBhY3F1aXNpdGlvbiBvZiB0
aGUgYmFja2luZyBzdG9yYWdlICovCisJY2xmbHVzaGVzID0gYXRvbWljX3JlYWQoJmk5MTUtPmdl
bS5jbGZsdXNoZXMpOworCWVyciA9IGk5MTVfZ2VtX29iamVjdF9waW5fcGFnZXMob2JqKTsKKwlp
ZiAoZXJyKQorCQlnb3RvIGVycjsKKworCWlmIChhdG9taWNfcmVhZCgmaTkxNS0+Z2VtLmNsZmx1
c2hlcykgPT0gY2xmbHVzaGVzKSB7CisJCXByX2Vycigibm8gY2xmbHVzaCByZWNvcmRlZCBmb3Ig
cGFnZSBhY3F1aXNpdGlvblxuIik7CisJCWVyciA9IC1FSU5WQUw7CisJCWdvdG8gZXJyOworCX0K
KwlpZiAob2JqLT5jYWNoZV9kaXJ0eSkgeworCQlwcl9lcnIoImZyZXNoIHBhZ2VzLCBidXQgQ1BV
IGNhY2hlIGlzIGRpcnR5IVxuIik7CisJCWVyciA9IC1FSU5WQUw7CisJCWdvdG8gZXJyOworCX0K
KworCS8qIEFuIF91bmZvcmNlZF8gY2xmbHVzaCBpcyBpZ25vcmVkIG9uIGxsYyAqLworCWVyciA9
IGNoZWNrZWRfY2xmbHVzaChvYmosIEk5MTVfQ0xGTFVTSF9TWU5DLCAhSEFTX0xMQyhpOTE1KSk7
CisJaWYgKGVycikgeworCQlwcl9lcnIoInJlZHVuZGFudCBjbGZsdXNoIGZhaWxlZCFcbiIpOwor
CQlnb3RvIGVycjsKKwl9CisKKwkvKiBCdXQgYSBfZm9yY2VkXyBjbGZsdXNoIGlzIG9iZXllZCwg
ZXZlbiBpZiB3ZSB0aGluayBpdHMgY2xlYW4gKi8KKwllcnIgPSBjaGVja2VkX2NsZmx1c2gob2Jq
LCBJOTE1X0NMRkxVU0hfU1lOQyB8IEk5MTVfQ0xGTFVTSF9GT1JDRSwgMSk7CisJaWYgKGVycikg
eworCQlwcl9lcnIoImZvcmNlZCBjbGZsdXNoIGZhaWxlZCFcbiIpOworCQlnb3RvIGVycjsKKwl9
CisKKwkvKiBSZWxlYXNpbmcgYSBzaG1lbSBvYmplY3QgbXVzdCBmbHVzaCAoaW4gY2FzZSBvZiB1
c2VyIGJ5cGFzcykgKi8KKwljbGZsdXNoZXMgPSBhdG9taWNfcmVhZCgmaTkxNS0+Z2VtLmNsZmx1
c2hlcyk7CisJaTkxNV9nZW1fb2JqZWN0X3B1dChvYmopOworCWk5MTVfZ2VtX2RyYWluX2ZyZWVk
X29iamVjdHMoaTkxNSk7CisJaWYgKGF0b21pY19yZWFkKCZpOTE1LT5nZW0uY2xmbHVzaGVzKSA9
PSBjbGZsdXNoZXMpIHsKKwkJcHJfZXJyKCJjbGZsdXNoIG5vdCByZWNvcmRlZCBmb3IgcmVsZWFz
aW5nIGRpcnR5IHVuY2FjaGVkIG9iamVjdFxuIik7CisJCWVyciA9IC1FSU5WQUw7CisJfQorCisJ
Z290byBvdXQ7CitlcnI6CisJaTkxNV9nZW1fb2JqZWN0X3B1dChvYmopOworb3V0OgorCXJldHVy
biBlcnI7Cit9CisKIHN0YXRpYyBpbnQgaWd0X2dlbV9jb2hlcmVuY3kodm9pZCAqYXJnKQogewog
CWNvbnN0IHVuc2lnbmVkIGludCBuY2FjaGVsaW5lcyA9IFBBR0VfU0laRS82NDsKQEAgLTQxNSw2
ICs1MjcsNyBAQCBzdGF0aWMgaW50IGlndF9nZW1fY29oZXJlbmN5KHZvaWQgKmFyZykKIGludCBp
OTE1X2dlbV9jb2hlcmVuY3lfbGl2ZV9zZWxmdGVzdHMoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUg
Kmk5MTUpCiB7CiAJc3RhdGljIGNvbnN0IHN0cnVjdCBpOTE1X3N1YnRlc3QgdGVzdHNbXSA9IHsK
KwkJU1VCVEVTVChpZ3RfZ2VtX2NsZmx1c2gpLAogCQlTVUJURVNUKGlndF9nZW1fY29oZXJlbmN5
KSwKIAl9OwogCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2Rydi5oIGIv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYuaAppbmRleCA1MDgwOWZmZGM2YjIuLjBlYmQ0
M2I3OTgxMyAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYuaAorKysg
Yi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2Rydi5oCkBAIC0xMjU0LDYgKzEyNTQsOCBAQCBz
dHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSB7CiAJCQlzdHJ1Y3QgbGxpc3RfaGVhZCBmcmVlX2xpc3Q7
CiAJCQlzdHJ1Y3Qgd29ya19zdHJ1Y3QgZnJlZV93b3JrOwogCQl9IGNvbnRleHRzOworCisJCUk5
MTVfU0VMRlRFU1RfREVDTEFSRShhdG9taWNfdCBjbGZsdXNoZXM7KQogCX0gZ2VtOwogCiAJdTgg
cGNoX3NzY191c2U7Ci0tIAoyLjI0LjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZy
ZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3Rp
bmZvL2ludGVsLWdmeA==

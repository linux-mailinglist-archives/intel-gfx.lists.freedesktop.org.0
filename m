Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 5EAD65D0B3
	for <lists+intel-gfx@lfdr.de>; Tue,  2 Jul 2019 15:32:09 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id AABCC89D40;
	Tue,  2 Jul 2019 13:32:07 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 2D78289D40
 for <intel-gfx@lists.freedesktop.org>; Tue,  2 Jul 2019 13:32:06 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17100346-1500050 
 for multiple; Tue, 02 Jul 2019 14:31:57 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Tue,  2 Jul 2019 14:31:55 +0100
Message-Id: <20190702133155.7523-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190702132506.8309-1-chris@chris-wilson.co.uk>
References: <20190702132506.8309-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH] drm/i915/gem: Free pages before rcu-freeing the
 object
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Matthew Auld <matthew.auld@intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

QXMgd2UgaGF2ZSBkcm9wcGVkIHRoZSBmaW5hbCByZWZlcmVuY2UgdG8gdGhlIG9iamVjdCwgd2Ug
ZG8gbm90IG5lZWQgdG8Kd2FpdCB1bnRpbCBhZnRlciB0aGUgcmN1IGdyYWNlIHBlcmlvZCB0byBk
cm9wIGl0cyBwYWdlcy4gV2Ugc3RpbGwgcmVxdWlyZQpzdHJ1Y3RfbXV0ZXggdG8gY29tcGxldGVs
eSB1bmJpbmQgdGhlIG9iamVjdCB0byByZWxlYXNlIHRoZSBwYWdlcywgc28gd2UKc3RpbGwgbmVl
ZCBhIGZyZWUtd29ya2VyIHRvIG1hbmFnZSB0aGF0IGZyb20gcHJvY2VzcyBjb250ZXh0LiBCeQpz
Y2hlZHVsaW5nIHRoZSByZWxlYXNlIG9mIHBhZ2VzIGJlZm9yZSB3YWl0aW5nIGZvciB0aGUgcmN1
IHNob3VsZCBtZWFuCnRoYXQgd2UgYXJlIG5vdCB0cmFwcGluZyB0aG9zZSBwYWdlcyBmcm9tIGJl
eW9uZCB0aGUgcmVhY2ggb2YgdGhlCnNocmlua2VyLgoKdjI6IFBhc3MgYWxvbmcgdGhlIHJlcXVl
c3QgdG8gc2tpcCBpZiB0aGUgdm1hIGlzIGJ1c3kgdG8gdGhlIHVuZGVybHlpbmcKdW5iaW5kIHJv
dXRpbmUsIHRvIGF2b2lkIGNoZWNraW5nIHRoZSByZXNlcnZhdGlvbiB1bmRlcm5lYXRoIHRoZQpp
OTE1LT5tbS5vYmpfbG9jayB3aGljaCBtYXkgYmUgdXNlZCBmcm9tIGluc2lkZSBpcnEgY29udGV4
dC4KCnYzOiBGbGlwIHRoZSBiaXQgZm9yIHVuYmluZGluZyB3aGlsZSBhY3RpdmUsIGZvciBsYXRl
ciBjb252ZW5pZW5jZS4KCkJ1Z3ppbGxhOiBodHRwczovL2J1Z3MuZnJlZWRlc2t0b3Aub3JnL3No
b3dfYnVnLmNnaT9pZD0xMTEwMzUKRml4ZXM6IGE5MzYxNWY5MDBiZCAoImRybS9pOTE1OiBUaHJv
dyBhd2F5IHRoZSBhY3RpdmUgb2JqZWN0IHJldGlyZW1lbnQgY29tcGxleGl0eSIpClNpZ25lZC1v
ZmYtYnk6IENocmlzIFdpbHNvbiA8Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPgpDYzogTWF0dGhl
dyBBdWxkIDxtYXR0aGV3LmF1bGRAaW50ZWwuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1
L2dlbS9pOTE1X2dlbV9vYmplY3QuYyAgIHwgODIgKysrKysrKysrLS0tLS0tLS0tLS0KIGRyaXZl
cnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9waHlzLmMgICAgIHwgIDIgKy0KIGRyaXZlcnMv
Z3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9zaHJpbmtlci5jIHwgMTggKysrLS0KIGRyaXZlcnMv
Z3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV91c2VycHRyLmMgIHwgIDMgKy0KIGRyaXZlcnMvZ3B1
L2RybS9pOTE1L2k5MTVfZHJ2LmggICAgICAgICAgICAgIHwgMTUgKystLQogZHJpdmVycy9ncHUv
ZHJtL2k5MTUvaTkxNV9nZW0uYyAgICAgICAgICAgICAgfCAgOCArLQogNiBmaWxlcyBjaGFuZ2Vk
LCA2NyBpbnNlcnRpb25zKCspLCA2MSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fb2JqZWN0LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9nZW0vaTkxNV9nZW1fb2JqZWN0LmMKaW5kZXggNDMxOTRmYmNiYzJlLi5kM2U5NmYwOWM2Yjcg
MTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9vYmplY3QuYwor
KysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fb2JqZWN0LmMKQEAgLTE0Niw2
ICsxNDYsMTggQEAgdm9pZCBpOTE1X2dlbV9jbG9zZV9vYmplY3Qoc3RydWN0IGRybV9nZW1fb2Jq
ZWN0ICpnZW0sIHN0cnVjdCBkcm1fZmlsZSAqZmlsZSkKIAl9CiB9CiAKK3N0YXRpYyB2b2lkIF9f
aTkxNV9nZW1fZnJlZV9vYmplY3RfcmN1KHN0cnVjdCByY3VfaGVhZCAqaGVhZCkKK3sKKwlzdHJ1
Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqID0KKwkJY29udGFpbmVyX29mKGhlYWQsIHR5cGVv
Zigqb2JqKSwgcmN1KTsKKwlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSA9IHRvX2k5MTUo
b2JqLT5iYXNlLmRldik7CisKKwlpOTE1X2dlbV9vYmplY3RfZnJlZShvYmopOworCisJR0VNX0JV
R19PTighYXRvbWljX3JlYWQoJmk5MTUtPm1tLmZyZWVfY291bnQpKTsKKwlhdG9taWNfZGVjKCZp
OTE1LT5tbS5mcmVlX2NvdW50KTsKK30KKwogc3RhdGljIHZvaWQgX19pOTE1X2dlbV9mcmVlX29i
amVjdHMoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUsCiAJCQkJICAgIHN0cnVjdCBsbGlz
dF9ub2RlICpmcmVlZCkKIHsKQEAgLTE2OCwyMiArMTgwLDYgQEAgc3RhdGljIHZvaWQgX19pOTE1
X2dlbV9mcmVlX29iamVjdHMoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUsCiAJCUdFTV9C
VUdfT04oIWxpc3RfZW1wdHkoJm9iai0+dm1hLmxpc3QpKTsKIAkJR0VNX0JVR19PTighUkJfRU1Q
VFlfUk9PVCgmb2JqLT52bWEudHJlZSkpOwogCi0JCS8qCi0JCSAqIFRoaXMgc2VyaWFsaXplcyBm
cmVlaW5nIHdpdGggdGhlIHNocmlua2VyLiBTaW5jZSB0aGUgZnJlZQotCQkgKiBpcyBkZWxheWVk
LCBmaXJzdCBieSBSQ1UgdGhlbiBieSB0aGUgd29ya3F1ZXVlLCB3ZSB3YW50IHRoZQotCQkgKiBz
aHJpbmtlciB0byBiZSBhYmxlIHRvIGZyZWUgcGFnZXMgb2YgdW5yZWZlcmVuY2VkIG9iamVjdHMs
Ci0JCSAqIG9yIGVsc2Ugd2UgbWF5IG9vbSB3aGlsc3QgdGhlcmUgYXJlIHBsZW50eSBvZiBkZWZl
cnJlZAotCQkgKiBmcmVlZCBvYmplY3RzLgotCQkgKi8KLQkJaWYgKGk5MTVfZ2VtX29iamVjdF9o
YXNfcGFnZXMob2JqKSAmJgotCQkgICAgaTkxNV9nZW1fb2JqZWN0X2lzX3Nocmlua2FibGUob2Jq
KSkgewotCQkJdW5zaWduZWQgbG9uZyBmbGFnczsKLQotCQkJc3Bpbl9sb2NrX2lycXNhdmUoJmk5
MTUtPm1tLm9ial9sb2NrLCBmbGFncyk7Ci0JCQlsaXN0X2RlbF9pbml0KCZvYmotPm1tLmxpbmsp
OwotCQkJc3Bpbl91bmxvY2tfaXJxcmVzdG9yZSgmaTkxNS0+bW0ub2JqX2xvY2ssIGZsYWdzKTsK
LQkJfQotCiAJCW11dGV4X3VubG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CiAKIAkJR0VN
X0JVR19PTihhdG9taWNfcmVhZCgmb2JqLT5iaW5kX2NvdW50KSk7CkBAIC0xOTcsMTkgKzE5Mywx
NSBAQCBzdGF0aWMgdm9pZCBfX2k5MTVfZ2VtX2ZyZWVfb2JqZWN0cyhzdHJ1Y3QgZHJtX2k5MTVf
cHJpdmF0ZSAqaTkxNSwKIAkJYXRvbWljX3NldCgmb2JqLT5tbS5wYWdlc19waW5fY291bnQsIDAp
OwogCQlfX2k5MTVfZ2VtX29iamVjdF9wdXRfcGFnZXMob2JqLCBJOTE1X01NX05PUk1BTCk7CiAJ
CUdFTV9CVUdfT04oaTkxNV9nZW1fb2JqZWN0X2hhc19wYWdlcyhvYmopKTsKKwkJYml0bWFwX2Zy
ZWUob2JqLT5iaXRfMTcpOwogCiAJCWlmIChvYmotPmJhc2UuaW1wb3J0X2F0dGFjaCkKIAkJCWRy
bV9wcmltZV9nZW1fZGVzdHJveSgmb2JqLT5iYXNlLCBOVUxMKTsKIAogCQlkcm1fZ2VtX29iamVj
dF9yZWxlYXNlKCZvYmotPmJhc2UpOwogCi0JCWJpdG1hcF9mcmVlKG9iai0+Yml0XzE3KTsKLQkJ
aTkxNV9nZW1fb2JqZWN0X2ZyZWUob2JqKTsKLQotCQlHRU1fQlVHX09OKCFhdG9taWNfcmVhZCgm
aTkxNS0+bW0uZnJlZV9jb3VudCkpOwotCQlhdG9taWNfZGVjKCZpOTE1LT5tbS5mcmVlX2NvdW50
KTsKLQotCQljb25kX3Jlc2NoZWQoKTsKKwkJLyogQnV0IGtlZXAgdGhlIHBvaW50ZXIgYWxpdmUg
Zm9yIFJDVS1wcm90ZWN0ZWQgbG9va3VwcyAqLworCQljYWxsX3JjdSgmb2JqLT5yY3UsIF9faTkx
NV9nZW1fZnJlZV9vYmplY3RfcmN1KTsKIAl9CiAJaW50ZWxfcnVudGltZV9wbV9wdXQoJmk5MTUt
PnJ1bnRpbWVfcG0sIHdha2VyZWYpOwogfQpAQCAtMjYwLDE4ICsyNTIsMzQgQEAgc3RhdGljIHZv
aWQgX19pOTE1X2dlbV9mcmVlX3dvcmsoc3RydWN0IHdvcmtfc3RydWN0ICp3b3JrKQogCXNwaW5f
dW5sb2NrKCZpOTE1LT5tbS5mcmVlX2xvY2spOwogfQogCi1zdGF0aWMgdm9pZCBfX2k5MTVfZ2Vt
X2ZyZWVfb2JqZWN0X3JjdShzdHJ1Y3QgcmN1X2hlYWQgKmhlYWQpCit2b2lkIGk5MTVfZ2VtX2Zy
ZWVfb2JqZWN0KHN0cnVjdCBkcm1fZ2VtX29iamVjdCAqZ2VtX29iaikKIHsKLQlzdHJ1Y3QgZHJt
X2k5MTVfZ2VtX29iamVjdCAqb2JqID0KLQkJY29udGFpbmVyX29mKGhlYWQsIHR5cGVvZigqb2Jq
KSwgcmN1KTsKKwlzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqID0gdG9faW50ZWxfYm8o
Z2VtX29iaik7CiAJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUgPSB0b19pOTE1KG9iai0+
YmFzZS5kZXYpOwogCiAJLyoKLQkgKiBXZSByZXVzZSBvYmotPnJjdSBmb3IgdGhlIGZyZWVkIGxp
c3QsIHNvIHdlIGhhZCBiZXR0ZXIgbm90IHRyZWF0Ci0JICogaXQgbGlrZSBhIHJjdV9oZWFkIGZy
b20gdGhpcyBwb2ludCBmb3J3YXJkcy4gQW5kIHdlIGV4cGVjdCBhbGwKLQkgKiBvYmplY3RzIHRv
IGJlIGZyZWVkIHZpYSB0aGlzIHBhdGguCisJICogQmVmb3JlIHdlIGZyZWUgdGhlIG9iamVjdCwg
bWFrZSBzdXJlIGFueSBwdXJlIFJDVS1vbmx5CisJICogcmVhZC1zaWRlIGNyaXRpY2FsIHNlY3Rp
b25zIGFyZSBjb21wbGV0ZSwgZS5nLgorCSAqIGk5MTVfZ2VtX2J1c3lfaW9jdGwoKS4gRm9yIHRo
ZSBjb3JyZXNwb25kaW5nIHN5bmNocm9uaXplZAorCSAqIGxvb2t1cCBzZWUgaTkxNV9nZW1fb2Jq
ZWN0X2xvb2t1cF9yY3UoKS4KIAkgKi8KLQlkZXN0cm95X3JjdV9oZWFkKCZvYmotPnJjdSk7CisJ
YXRvbWljX2luYygmaTkxNS0+bW0uZnJlZV9jb3VudCk7CisKKwkvKgorCSAqIFRoaXMgc2VyaWFs
aXplcyBmcmVlaW5nIHdpdGggdGhlIHNocmlua2VyLiBTaW5jZSB0aGUgZnJlZQorCSAqIGlzIGRl
bGF5ZWQsIGZpcnN0IGJ5IFJDVSB0aGVuIGJ5IHRoZSB3b3JrcXVldWUsIHdlIHdhbnQgdGhlCisJ
ICogc2hyaW5rZXIgdG8gYmUgYWJsZSB0byBmcmVlIHBhZ2VzIG9mIHVucmVmZXJlbmNlZCBvYmpl
Y3RzLAorCSAqIG9yIGVsc2Ugd2UgbWF5IG9vbSB3aGlsc3QgdGhlcmUgYXJlIHBsZW50eSBvZiBk
ZWZlcnJlZAorCSAqIGZyZWVkIG9iamVjdHMuCisJICovCisJaWYgKGk5MTVfZ2VtX29iamVjdF9o
YXNfcGFnZXMob2JqKSAmJgorCSAgICBpOTE1X2dlbV9vYmplY3RfaXNfc2hyaW5rYWJsZShvYmop
KSB7CisJCXVuc2lnbmVkIGxvbmcgZmxhZ3M7CisKKwkJc3Bpbl9sb2NrX2lycXNhdmUoJmk5MTUt
Pm1tLm9ial9sb2NrLCBmbGFncyk7CisJCWxpc3RfZGVsX2luaXQoJm9iai0+bW0ubGluayk7CisJ
CXNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJmk5MTUtPm1tLm9ial9sb2NrLCBmbGFncyk7CisJfQog
CiAJLyoKIAkgKiBTaW5jZSB3ZSByZXF1aXJlIGJsb2NraW5nIG9uIHN0cnVjdF9tdXRleCB0byB1
bmJpbmQgdGhlIGZyZWVkCkBAIC0yODcsMjAgKzI5NSw2IEBAIHN0YXRpYyB2b2lkIF9faTkxNV9n
ZW1fZnJlZV9vYmplY3RfcmN1KHN0cnVjdCByY3VfaGVhZCAqaGVhZCkKIAkJcXVldWVfd29yayhp
OTE1LT53cSwgJmk5MTUtPm1tLmZyZWVfd29yayk7CiB9CiAKLXZvaWQgaTkxNV9nZW1fZnJlZV9v
YmplY3Qoc3RydWN0IGRybV9nZW1fb2JqZWN0ICpnZW1fb2JqKQotewotCXN0cnVjdCBkcm1faTkx
NV9nZW1fb2JqZWN0ICpvYmogPSB0b19pbnRlbF9ibyhnZW1fb2JqKTsKLQotCS8qCi0JICogQmVm
b3JlIHdlIGZyZWUgdGhlIG9iamVjdCwgbWFrZSBzdXJlIGFueSBwdXJlIFJDVS1vbmx5Ci0JICog
cmVhZC1zaWRlIGNyaXRpY2FsIHNlY3Rpb25zIGFyZSBjb21wbGV0ZSwgZS5nLgotCSAqIGk5MTVf
Z2VtX2J1c3lfaW9jdGwoKS4gRm9yIHRoZSBjb3JyZXNwb25kaW5nIHN5bmNocm9uaXplZAotCSAq
IGxvb2t1cCBzZWUgaTkxNV9nZW1fb2JqZWN0X2xvb2t1cF9yY3UoKS4KLQkgKi8KLQlhdG9taWNf
aW5jKCZ0b19pOTE1KG9iai0+YmFzZS5kZXYpLT5tbS5mcmVlX2NvdW50KTsKLQljYWxsX3JjdSgm
b2JqLT5yY3UsIF9faTkxNV9nZW1fZnJlZV9vYmplY3RfcmN1KTsKLX0KLQogc3RhdGljIGlubGlu
ZSBlbnVtIGZiX29wX29yaWdpbgogZmJfd3JpdGVfb3JpZ2luKHN0cnVjdCBkcm1faTkxNV9nZW1f
b2JqZWN0ICpvYmosIHVuc2lnbmVkIGludCBkb21haW4pCiB7CmRpZmYgLS1naXQgYS9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fcGh5cy5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUv
Z2VtL2k5MTVfZ2VtX3BoeXMuYwppbmRleCA3YjkwMGVlNGVkOGQuLmI5ZmFiMjJhZGE2ZiAxMDA2
NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3BoeXMuYworKysgYi9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fcGh5cy5jCkBAIC0xNTksNyArMTU5LDcg
QEAgaW50IGk5MTVfZ2VtX29iamVjdF9hdHRhY2hfcGh5cyhzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29i
amVjdCAqb2JqLCBpbnQgYWxpZ24pCiAJaWYgKG9iai0+b3BzICE9ICZpOTE1X2dlbV9zaG1lbV9v
cHMpCiAJCXJldHVybiAtRUlOVkFMOwogCi0JZXJyID0gaTkxNV9nZW1fb2JqZWN0X3VuYmluZChv
YmopOworCWVyciA9IGk5MTVfZ2VtX29iamVjdF91bmJpbmQob2JqLCBJOTE1X0dFTV9PQkpFQ1Rf
VU5CSU5EX0FDVElWRSk7CiAJaWYgKGVycikKIAkJcmV0dXJuIGVycjsKIApkaWZmIC0tZ2l0IGEv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3Nocmlua2VyLmMgYi9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fc2hyaW5rZXIuYwppbmRleCBkOTlmMWE2MDBiOTYuLjNm
NGM2YmRjYzNjMyAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2Vt
X3Nocmlua2VyLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3Nocmlu
a2VyLmMKQEAgLTg4LDEwICs4OCwxOCBAQCBzdGF0aWMgYm9vbCBjYW5fcmVsZWFzZV9wYWdlcyhz
dHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqKQogCXJldHVybiBzd2FwX2F2YWlsYWJsZSgp
IHx8IG9iai0+bW0ubWFkdiA9PSBJOTE1X01BRFZfRE9OVE5FRUQ7CiB9CiAKLXN0YXRpYyBib29s
IHVuc2FmZV9kcm9wX3BhZ2VzKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmopCitzdGF0
aWMgYm9vbCB1bnNhZmVfZHJvcF9wYWdlcyhzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2Jq
LAorCQkJICAgICAgdW5zaWduZWQgbG9uZyBzaHJpbmspCiB7Ci0JaWYgKGk5MTVfZ2VtX29iamVj
dF91bmJpbmQob2JqKSA9PSAwKQorCXVuc2lnbmVkIGxvbmcgZmxhZ3M7CisKKwlmbGFncyA9IDA7
CisJaWYgKHNocmluayAmIEk5MTVfU0hSSU5LX0FDVElWRSkKKwkJZmxhZ3MgPSBJOTE1X0dFTV9P
QkpFQ1RfVU5CSU5EX0FDVElWRTsKKworCWlmIChpOTE1X2dlbV9vYmplY3RfdW5iaW5kKG9iaiwg
ZmxhZ3MpID09IDApCiAJCV9faTkxNV9nZW1fb2JqZWN0X3B1dF9wYWdlcyhvYmosIEk5MTVfTU1f
U0hSSU5LRVIpOworCiAJcmV0dXJuICFpOTE1X2dlbV9vYmplY3RfaGFzX3BhZ2VzKG9iaik7CiB9
CiAKQEAgLTIyOSw5ICsyMzcsNyBAQCBpOTE1X2dlbV9zaHJpbmsoc3RydWN0IGRybV9pOTE1X3By
aXZhdGUgKmk5MTUsCiAJCQkJY29udGludWU7CiAKIAkJCWlmICghKHNocmluayAmIEk5MTVfU0hS
SU5LX0FDVElWRSkgJiYKLQkJCSAgICAoaTkxNV9nZW1fb2JqZWN0X2lzX2ZyYW1lYnVmZmVyKG9i
aikgfHwKLQkJCSAgICAgIXJlc2VydmF0aW9uX29iamVjdF90ZXN0X3NpZ25hbGVkX3JjdShvYmot
PmJhc2UucmVzdiwKLQkJCQkJCQkJICAgdHJ1ZSkpKQorCQkJICAgIGk5MTVfZ2VtX29iamVjdF9p
c19mcmFtZWJ1ZmZlcihvYmopKQogCQkJCWNvbnRpbnVlOwogCiAJCQlpZiAoIShzaHJpbmsgJiBJ
OTE1X1NIUklOS19CT1VORCkgJiYKQEAgLTI0Niw3ICsyNTIsNyBAQCBpOTE1X2dlbV9zaHJpbmso
c3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUsCiAKIAkJCXNwaW5fdW5sb2NrX2lycXJlc3Rv
cmUoJmk5MTUtPm1tLm9ial9sb2NrLCBmbGFncyk7CiAKLQkJCWlmICh1bnNhZmVfZHJvcF9wYWdl
cyhvYmopKSB7CisJCQlpZiAodW5zYWZlX2Ryb3BfcGFnZXMob2JqLCBzaHJpbmspKSB7CiAJCQkJ
LyogTWF5IGFycml2ZSBmcm9tIGdldF9wYWdlcyBvbiBhbm90aGVyIGJvICovCiAJCQkJbXV0ZXhf
bG9ja19uZXN0ZWQoJm9iai0+bW0ubG9jaywKIAkJCQkJCSAgSTkxNV9NTV9TSFJJTktFUik7CmRp
ZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fdXNlcnB0ci5jIGIv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3VzZXJwdHIuYwppbmRleCA1MjhiNjE2
NzgzMzQuLjE2Y2NlYzdmYjdkYSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2Vt
L2k5MTVfZ2VtX3VzZXJwdHIuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9n
ZW1fdXNlcnB0ci5jCkBAIC0xNTAsNyArMTUwLDggQEAgdXNlcnB0cl9tbl9pbnZhbGlkYXRlX3Jh
bmdlX3N0YXJ0KHN0cnVjdCBtbXVfbm90aWZpZXIgKl9tbiwKIAkJCX0KIAkJfQogCi0JCXJldCA9
IGk5MTVfZ2VtX29iamVjdF91bmJpbmQob2JqKTsKKwkJcmV0ID0gaTkxNV9nZW1fb2JqZWN0X3Vu
YmluZChvYmosCisJCQkJCSAgICAgSTkxNV9HRU1fT0JKRUNUX1VOQklORF9BQ1RJVkUpOwogCQlp
ZiAocmV0ID09IDApCiAJCQlyZXQgPSBfX2k5MTVfZ2VtX29iamVjdF9wdXRfcGFnZXMob2JqLCBJ
OTE1X01NX1NIUklOS0VSKTsKIAkJaTkxNV9nZW1fb2JqZWN0X3B1dChvYmopOwpkaWZmIC0tZ2l0
IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2k5MTVfZHJ2LmgKaW5kZXggMDJkZDlmOWYzYTg5Li45N2YwOGE5ODBkZWYgMTAwNjQ0Ci0tLSBh
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZHJ2LmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5
MTUvaTkxNV9kcnYuaApAQCAtMjQ0NiwxOCArMjQ0NiwxNyBAQCBpbnQgaTkxNV9nZW1fZnJlZXpl
X2xhdGUoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2KTsKIAogc3RhdGljIGlubGlu
ZSB2b2lkIGk5MTVfZ2VtX2RyYWluX2ZyZWVkX29iamVjdHMoc3RydWN0IGRybV9pOTE1X3ByaXZh
dGUgKmk5MTUpCiB7Ci0JaWYgKCFhdG9taWNfcmVhZCgmaTkxNS0+bW0uZnJlZV9jb3VudCkpCi0J
CXJldHVybjsKLQotCS8qIEEgc2luZ2xlIHBhc3Mgc2hvdWxkIHN1ZmZpY2UgdG8gcmVsZWFzZSBh
bGwgdGhlIGZyZWVkIG9iamVjdHMgKGFsb25nCisJLyoKKwkgKiBBIHNpbmdsZSBwYXNzIHNob3Vs
ZCBzdWZmaWNlIHRvIHJlbGVhc2UgYWxsIHRoZSBmcmVlZCBvYmplY3RzIChhbG9uZwogCSAqIG1v
c3QgY2FsbCBwYXRocykgLCBidXQgYmUgYSBsaXR0bGUgbW9yZSBwYXJhbm9pZCBpbiB0aGF0IGZy
ZWVpbmcKIAkgKiB0aGUgb2JqZWN0cyBkb2VzIHRha2UgYSBsaXR0bGUgYW1vdW50IG9mIHRpbWUs
IGR1cmluZyB3aGljaCB0aGUgcmN1CiAJICogY2FsbGJhY2tzIGNvdWxkIGhhdmUgYWRkZWQgbmV3
IG9iamVjdHMgaW50byB0aGUgZnJlZWQgbGlzdCwgYW5kCiAJICogYXJtZWQgdGhlIHdvcmsgYWdh
aW4uCiAJICovCi0JZG8geworCXdoaWxlIChhdG9taWNfcmVhZCgmaTkxNS0+bW0uZnJlZV9jb3Vu
dCkpIHsKKwkJZmx1c2hfd29yaygmaTkxNS0+bW0uZnJlZV93b3JrKTsKIAkJcmN1X2JhcnJpZXIo
KTsKLQl9IHdoaWxlIChmbHVzaF93b3JrKCZpOTE1LT5tbS5mcmVlX3dvcmspKTsKKwl9CiB9CiAK
IHN0YXRpYyBpbmxpbmUgdm9pZCBpOTE1X2dlbV9kcmFpbl93b3JrcXVldWUoc3RydWN0IGRybV9p
OTE1X3ByaXZhdGUgKmk5MTUpCkBAIC0yNDg4LDcgKzI0ODcsOSBAQCBpOTE1X2dlbV9vYmplY3Rf
Z2d0dF9waW4oc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiwKIAkJCSB1NjQgYWxpZ25t
ZW50LAogCQkJIHU2NCBmbGFncyk7CiAKLWludCBpOTE1X2dlbV9vYmplY3RfdW5iaW5kKHN0cnVj
dCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmopOworaW50IGk5MTVfZ2VtX29iamVjdF91bmJpbmQo
c3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiwKKwkJCSAgIHVuc2lnbmVkIGxvbmcgZmxh
Z3MpOworI2RlZmluZSBJOTE1X0dFTV9PQkpFQ1RfVU5CSU5EX0FDVElWRSBCSVQoMCkKIAogdm9p
ZCBpOTE1X2dlbV9ydW50aW1lX3N1c3BlbmQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9w
cml2KTsKIApkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW0uYyBiL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtLmMKaW5kZXggYjdmMjkwYjc3ZjhmLi43YWRlNDJi
OGVjOTkgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtLmMKKysrIGIv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW0uYwpAQCAtMTAxLDcgKzEwMSw4IEBAIGk5MTVf
Z2VtX2dldF9hcGVydHVyZV9pb2N0bChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LCB2b2lkICpkYXRh
LAogCXJldHVybiAwOwogfQogCi1pbnQgaTkxNV9nZW1fb2JqZWN0X3VuYmluZChzdHJ1Y3QgZHJt
X2k5MTVfZ2VtX29iamVjdCAqb2JqKQoraW50IGk5MTVfZ2VtX29iamVjdF91bmJpbmQoc3RydWN0
IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiwKKwkJCSAgIHVuc2lnbmVkIGxvbmcgZmxhZ3MpCiB7
CiAJc3RydWN0IGk5MTVfdm1hICp2bWE7CiAJTElTVF9IRUFEKHN0aWxsX2luX2xpc3QpOwpAQCAt
MTE2LDcgKzExNywxMCBAQCBpbnQgaTkxNV9nZW1fb2JqZWN0X3VuYmluZChzdHJ1Y3QgZHJtX2k5
MTVfZ2VtX29iamVjdCAqb2JqKQogCQlsaXN0X21vdmVfdGFpbCgmdm1hLT5vYmpfbGluaywgJnN0
aWxsX2luX2xpc3QpOwogCQlzcGluX3VubG9jaygmb2JqLT52bWEubG9jayk7CiAKLQkJcmV0ID0g
aTkxNV92bWFfdW5iaW5kKHZtYSk7CisJCXJldCA9IC1FQlVTWTsKKwkJaWYgKGZsYWdzICYgSTkx
NV9HRU1fT0JKRUNUX1VOQklORF9BQ1RJVkUgfHwKKwkJICAgICFpOTE1X3ZtYV9pc19hY3RpdmUo
dm1hKSkKKwkJCXJldCA9IGk5MTVfdm1hX3VuYmluZCh2bWEpOwogCiAJCXNwaW5fbG9jaygmb2Jq
LT52bWEubG9jayk7CiAJfQotLSAKMi4yMC4xCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fXwpJbnRlbC1nZnggbWFpbGluZyBsaXN0CkludGVsLWdmeEBsaXN0
cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9s
aXN0aW5mby9pbnRlbC1nZng=

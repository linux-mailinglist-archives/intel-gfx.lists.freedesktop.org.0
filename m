Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id C44058A043
	for <lists+intel-gfx@lfdr.de>; Mon, 12 Aug 2019 15:58:59 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 3A0976E52A;
	Mon, 12 Aug 2019 13:58:58 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id E9EBC6E029
 for <intel-gfx@lists.freedesktop.org>; Mon, 12 Aug 2019 13:58:51 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17969933-1500050 
 for multiple; Mon, 12 Aug 2019 14:39:20 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 12 Aug 2019 14:39:15 +0100
Message-Id: <20190812133915.18824-18-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0.rc1
In-Reply-To: <20190812133915.18824-1-chris@chris-wilson.co.uk>
References: <20190812133915.18824-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 18/18] drm/i915: Push the use-semaphore marker
 onto the intel_context
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SW5zdGVhZCBvZiBydW1tYWdpbmcgdGhyb3VnaCB0aGUgaW50ZWxfY29udGV4dCB0byBwZWVrIGF0
IHRoZSBHRU0KY29udGV4dCBpbiB0aGUgbWlkZGxlIG9mIHJlcXVlc3Qgc3VibWlzc2lvbiB0byBk
ZWNpZGUgd2hldGhlciB0byB1c2UKc2VtYXBob3Jlcywgc3RvcmUgdGhhdCBpbmZvcm1hdGlvbiBv
biB0aGUgaW50ZWxfY29udGV4dCBpdHNlbGYuCgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24g
PGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0v
aTkxNV9nZW1fY29udGV4dC5jICAgfCA1MiArKysrKysrKysrKysrLS0tLS0tCiBkcml2ZXJzL2dw
dS9kcm0vaTkxNS9ndC9pbnRlbF9jb250ZXh0LmMgICAgICAgfCAgMyArKwogZHJpdmVycy9ncHUv
ZHJtL2k5MTUvZ3QvaW50ZWxfY29udGV4dC5oICAgICAgIHwgMTUgKysrKysrCiBkcml2ZXJzL2dw
dS9kcm0vaTkxNS9ndC9pbnRlbF9jb250ZXh0X3R5cGVzLmggfCAgNSArLQogZHJpdmVycy9ncHUv
ZHJtL2k5MTUvaTkxNV9yZXF1ZXN0LmMgICAgICAgICAgIHwgIDggKystCiA1IGZpbGVzIGNoYW5n
ZWQsIDU5IGluc2VydGlvbnMoKyksIDI0IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jb250ZXh0LmMgYi9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9nZW0vaTkxNV9nZW1fY29udGV4dC5jCmluZGV4IDFkN2U5YzMyYzJiYi4uMTg4OTM1Yjgw
NjNmIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fY29udGV4
dC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jb250ZXh0LmMKQEAg
LTE2MDMsNiArMTYwMyw0MCBAQCBnZXRfZW5naW5lcyhzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAq
Y3R4LAogCXJldHVybiBlcnI7CiB9CiAKK3N0YXRpYyB2b2lkIF9fYXBwbHlfcHJpb3JpdHkoc3Ry
dWN0IGludGVsX2NvbnRleHQgKmNlLCB2b2lkICphcmcpCit7CisJc3RydWN0IGk5MTVfZ2VtX2Nv
bnRleHQgKmN0eCA9IGFyZzsKKworCWlmIChpbnRlbF9jb250ZXh0X3VzZV9zZW1hcGhvcmVzKGNl
KSAmJgorCSAgICBjdHgtPnNjaGVkLnByaW9yaXR5IDwgSTkxNV9QUklPUklUWV9OT1JNQUwpCisJ
CWludGVsX2NvbnRleHRfY2xlYXJfdXNlX3NlbWFwaG9yZXMoY2UpOworfQorCitzdGF0aWMgaW50
IHNldF9wcmlvcml0eShzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4LAorCQkJY29uc3Qgc3Ry
dWN0IGRybV9pOTE1X2dlbV9jb250ZXh0X3BhcmFtICphcmdzKQoreworCXM2NCBwcmlvcml0eSA9
IGFyZ3MtPnZhbHVlOworCisJaWYgKGFyZ3MtPnNpemUpCisJCXJldHVybiAtRUlOVkFMOworCisJ
aWYgKCEoY3R4LT5pOTE1LT5jYXBzLnNjaGVkdWxlciAmIEk5MTVfU0NIRURVTEVSX0NBUF9QUklP
UklUWSkpCisJCXJldHVybiAtRU5PREVWOworCisJaWYgKHByaW9yaXR5ID4gSTkxNV9DT05URVhU
X01BWF9VU0VSX1BSSU9SSVRZIHx8CisJICAgIHByaW9yaXR5IDwgSTkxNV9DT05URVhUX01JTl9V
U0VSX1BSSU9SSVRZKQorCQlyZXR1cm4gLUVJTlZBTDsKKworCWlmIChwcmlvcml0eSA+IEk5MTVf
Q09OVEVYVF9ERUZBVUxUX1BSSU9SSVRZICYmCisJICAgICFjYXBhYmxlKENBUF9TWVNfTklDRSkp
CisJCXJldHVybiAtRVBFUk07CisKKwljdHgtPnNjaGVkLnByaW9yaXR5ID0gSTkxNV9VU0VSX1BS
SU9SSVRZKHByaW9yaXR5KTsKKwljb250ZXh0X2FwcGx5X2FsbChjdHgsIF9fYXBwbHlfcHJpb3Jp
dHksIE5VTEwpOworCisJcmV0dXJuIDA7Cit9CisKIHN0YXRpYyBpbnQgY3R4X3NldHBhcmFtKHN0
cnVjdCBkcm1faTkxNV9maWxlX3ByaXZhdGUgKmZwcml2LAogCQkJc3RydWN0IGk5MTVfZ2VtX2Nv
bnRleHQgKmN0eCwKIAkJCXN0cnVjdCBkcm1faTkxNV9nZW1fY29udGV4dF9wYXJhbSAqYXJncykK
QEAgLTE2NDksMjMgKzE2ODMsNyBAQCBzdGF0aWMgaW50IGN0eF9zZXRwYXJhbShzdHJ1Y3QgZHJt
X2k5MTVfZmlsZV9wcml2YXRlICpmcHJpdiwKIAkJYnJlYWs7CiAKIAljYXNlIEk5MTVfQ09OVEVY
VF9QQVJBTV9QUklPUklUWToKLQkJewotCQkJczY0IHByaW9yaXR5ID0gYXJncy0+dmFsdWU7Ci0K
LQkJCWlmIChhcmdzLT5zaXplKQotCQkJCXJldCA9IC1FSU5WQUw7Ci0JCQllbHNlIGlmICghKGN0
eC0+aTkxNS0+Y2Fwcy5zY2hlZHVsZXIgJiBJOTE1X1NDSEVEVUxFUl9DQVBfUFJJT1JJVFkpKQot
CQkJCXJldCA9IC1FTk9ERVY7Ci0JCQllbHNlIGlmIChwcmlvcml0eSA+IEk5MTVfQ09OVEVYVF9N
QVhfVVNFUl9QUklPUklUWSB8fAotCQkJCSBwcmlvcml0eSA8IEk5MTVfQ09OVEVYVF9NSU5fVVNF
Ul9QUklPUklUWSkKLQkJCQlyZXQgPSAtRUlOVkFMOwotCQkJZWxzZSBpZiAocHJpb3JpdHkgPiBJ
OTE1X0NPTlRFWFRfREVGQVVMVF9QUklPUklUWSAmJgotCQkJCSAhY2FwYWJsZShDQVBfU1lTX05J
Q0UpKQotCQkJCXJldCA9IC1FUEVSTTsKLQkJCWVsc2UKLQkJCQljdHgtPnNjaGVkLnByaW9yaXR5
ID0KLQkJCQkJSTkxNV9VU0VSX1BSSU9SSVRZKHByaW9yaXR5KTsKLQkJfQorCQlyZXQgPSBzZXRf
cHJpb3JpdHkoY3R4LCBhcmdzKTsKIAkJYnJlYWs7CiAKIAljYXNlIEk5MTVfQ09OVEVYVF9QQVJB
TV9TU0VVOgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfY29udGV4
dC5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfY29udGV4dC5jCmluZGV4IDQwZTYx
MTg0ZjI0Zi4uYmRlNWQwOTE3OTAzIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9n
dC9pbnRlbF9jb250ZXh0LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfY29u
dGV4dC5jCkBAIC0yMjcsNiArMjI3LDkgQEAgaW50ZWxfY29udGV4dF9pbml0KHN0cnVjdCBpbnRl
bF9jb250ZXh0ICpjZSwKIAljZS0+dm0gPSBpOTE1X3ZtX2dldChjdHgtPnZtID86ICZlbmdpbmUt
Pmd0LT5nZ3R0LT52bSk7CiAJaWYgKGN0eC0+dGltZWxpbmUpCiAJCWNlLT50aW1lbGluZSA9IGlu
dGVsX3RpbWVsaW5lX2dldChjdHgtPnRpbWVsaW5lKTsKKwlpZiAoY3R4LT5zY2hlZC5wcmlvcml0
eSA+PSBJOTE1X1BSSU9SSVRZX05PUk1BTCAmJgorCSAgICBpbnRlbF9lbmdpbmVfaGFzX3NlbWFw
aG9yZXMoZW5naW5lKSkKKwkJX19zZXRfYml0KENPTlRFWFRfVVNFX1NFTUFQSE9SRVMsICZjZS0+
ZmxhZ3MpOwogCiAJY2UtPmVuZ2luZSA9IGVuZ2luZTsKIAljZS0+b3BzID0gZW5naW5lLT5jb3Bz
OwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfY29udGV4dC5oIGIv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfY29udGV4dC5oCmluZGV4IGZlMDNiMWVlYWI2
My4uN2ZkY2E2ZmU3YTcwIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRl
bF9jb250ZXh0LmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfY29udGV4dC5o
CkBAIC0xNTQsNiArMTU0LDIxIEBAIHN0YXRpYyBpbmxpbmUgc3RydWN0IGludGVsX3JpbmcgKl9f
aW50ZWxfY29udGV4dF9yaW5nX3NpemUodTY0IHN6KQogCXJldHVybiB1NjRfdG9fcHRyKHN0cnVj
dCBpbnRlbF9yaW5nLCBzeik7CiB9CiAKK3N0YXRpYyBpbmxpbmUgYm9vbCBpbnRlbF9jb250ZXh0
X3VzZV9zZW1hcGhvcmVzKGNvbnN0IHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSkKK3sKKwlyZXR1
cm4gdGVzdF9iaXQoQ09OVEVYVF9VU0VfU0VNQVBIT1JFUywgJmNlLT5mbGFncyk7Cit9CisKK3N0
YXRpYyBpbmxpbmUgdm9pZCBpbnRlbF9jb250ZXh0X3NldF91c2Vfc2VtYXBob3JlcyhzdHJ1Y3Qg
aW50ZWxfY29udGV4dCAqY2UpCit7CisJc2V0X2JpdChDT05URVhUX1VTRV9TRU1BUEhPUkVTLCAm
Y2UtPmZsYWdzKTsKK30KKworc3RhdGljIGlubGluZSB2b2lkIGludGVsX2NvbnRleHRfY2xlYXJf
dXNlX3NlbWFwaG9yZXMoc3RydWN0IGludGVsX2NvbnRleHQgKmNlKQoreworCWNsZWFyX2JpdChD
T05URVhUX1VTRV9TRU1BUEhPUkVTLCAmY2UtPmZsYWdzKTsKK30KKwogc3RhdGljIGlubGluZSBi
b29sIGludGVsX2NvbnRleHRfaXNfYmFubmVkKGNvbnN0IHN0cnVjdCBpbnRlbF9jb250ZXh0ICpj
ZSkKIHsKIAlyZXR1cm4gdGVzdF9iaXQoQ09OVEVYVF9CQU5ORUQsICZjZS0+ZmxhZ3MpOwpkaWZm
IC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfY29udGV4dF90eXBlcy5oIGIv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfY29udGV4dF90eXBlcy5oCmluZGV4IDljOGM2
ZGNkMGYwNy4uMjc4NjgwODMzMTQ2IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9n
dC9pbnRlbF9jb250ZXh0X3R5cGVzLmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50
ZWxfY29udGV4dF90eXBlcy5oCkBAIC01NSw4ICs1NSw5IEBAIHN0cnVjdCBpbnRlbF9jb250ZXh0
IHsKIAogCXVuc2lnbmVkIGxvbmcgZmxhZ3M7CiAjZGVmaW5lIENPTlRFWFRfQUxMT0NfQklUCQkw
Ci0jZGVmaW5lIENPTlRFWFRfQkFOTkVECQkJMQotI2RlZmluZSBDT05URVhUX0ZPUkNFX1NJTkdM
RV9TVUJNSVNTSU9OCTIKKyNkZWZpbmUgQ09OVEVYVF9VU0VfU0VNQVBIT1JFUwkJMQorI2RlZmlu
ZSBDT05URVhUX0JBTk5FRAkJCTIKKyNkZWZpbmUgQ09OVEVYVF9GT1JDRV9TSU5HTEVfU1VCTUlT
U0lPTgkzCiAKIAl1MzIgKmxyY19yZWdfc3RhdGU7CiAJdTY0IGxyY19kZXNjOwpkaWZmIC0tZ2l0
IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9yZXF1ZXN0LmMgYi9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9pOTE1X3JlcXVlc3QuYwppbmRleCBjNmFjNmI5MTI1OTUuLmY3MGYxODg2MDdkYSAxMDA2
NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9yZXF1ZXN0LmMKKysrIGIvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvaTkxNV9yZXF1ZXN0LmMKQEAgLTg0NywxOCArODQ3LDE2IEBAIGk5MTVf
cmVxdWVzdF9hd2FpdF9yZXF1ZXN0KHN0cnVjdCBpOTE1X3JlcXVlc3QgKnRvLCBzdHJ1Y3QgaTkx
NV9yZXF1ZXN0ICpmcm9tKQogCQkJcmV0dXJuIHJldDsKIAl9CiAKLQlpZiAodG8tPmVuZ2luZSA9
PSBmcm9tLT5lbmdpbmUpIHsKKwlpZiAodG8tPmVuZ2luZSA9PSBmcm9tLT5lbmdpbmUpCiAJCXJl
dCA9IGk5MTVfc3dfZmVuY2VfYXdhaXRfc3dfZmVuY2VfZ2ZwKCZ0by0+c3VibWl0LAogCQkJCQkJ
ICAgICAgICZmcm9tLT5zdWJtaXQsCiAJCQkJCQkgICAgICAgSTkxNV9GRU5DRV9HRlApOwotCX0g
ZWxzZSBpZiAoaW50ZWxfZW5naW5lX2hhc19zZW1hcGhvcmVzKHRvLT5lbmdpbmUpICYmCi0JCSAg
IHRvLT5jb250ZXh0LT5nZW1fY29udGV4dC0+c2NoZWQucHJpb3JpdHkgPj0gSTkxNV9QUklPUklU
WV9OT1JNQUwpIHsKKwllbHNlIGlmIChpbnRlbF9jb250ZXh0X3VzZV9zZW1hcGhvcmVzKHRvLT5j
b250ZXh0KSkKIAkJcmV0ID0gZW1pdF9zZW1hcGhvcmVfd2FpdCh0bywgZnJvbSwgSTkxNV9GRU5D
RV9HRlApOwotCX0gZWxzZSB7CisJZWxzZQogCQlyZXQgPSBpOTE1X3N3X2ZlbmNlX2F3YWl0X2Rt
YV9mZW5jZSgmdG8tPnN1Ym1pdCwKIAkJCQkJCSAgICAmZnJvbS0+ZmVuY2UsIDAsCiAJCQkJCQkg
ICAgSTkxNV9GRU5DRV9HRlApOwotCX0KIAlpZiAocmV0IDwgMCkKIAkJcmV0dXJuIHJldDsKIAot
LSAKMi4yMy4wLnJjMQoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Au
b3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwt
Z2Z4

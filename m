Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id DBE54104182
	for <lists+intel-gfx@lfdr.de>; Wed, 20 Nov 2019 17:55:23 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id BE2CC6E83D;
	Wed, 20 Nov 2019 16:55:21 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id B73746E83D
 for <intel-gfx@lists.freedesktop.org>; Wed, 20 Nov 2019 16:55:19 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 19274724-1500050 
 for <intel-gfx@lists.freedesktop.org>; Wed, 20 Nov 2019 16:55:16 +0000
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Wed, 20 Nov 2019 16:55:13 +0000
Message-Id: <20191120165514.3955081-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.24.0
MIME-Version: 1.0
Subject: [Intel-gfx] [CI 1/2] drm/i915/gt: Close race between engine_park
 and intel_gt_retire_requests
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

VGhlIGdlbmVyYWwgY29uY2VwdCB3YXMgdGhhdCBpbnRlbF90aW1lbGluZS5hY3RpdmVfY291bnQg
d2FzIGxvY2tlZCBieQp0aGUgaW50ZWxfdGltZWxpbmUubXV0ZXguIFRoZSBleGNlcHRpb24gd2Fz
IGZvciBwb3dlciBtYW5hZ2VtZW50LCB3aGVyZQp0aGUgZW5naW5lLT5rZXJuZWxfY29udGV4dC0+
dGltZWxpbmUgY291bGQgYmUgbWFuaXB1bGF0ZWQgdW5kZXIgdGhlCmdsb2JhbCB3YWtlcmVmLm11
dGV4LgoKVGhpcyB3YXMgcXVpdGUgc29saWQsIGFzIHdlIGFsd2F5cyBtYW5pcHVsYXRlZCB0aGUg
dGltZWxpbmUgb25seSB3aGlsZQp3ZSBoZWxkIGFuIGVuZ2luZSB3YWtlcmVmLgoKQW5kIHRoZW4g
d2Ugc3RhcnRlZCByZXRpcmluZyByZXF1ZXN0cyBvdXRzaWRlIG9mIHN0cnVjdF9tdXRleCwgb25s
eQp1c2luZyB0aGUgdGltZWxpbmVzLmFjdGl2ZV9saXN0IGFuZCB0aGUgdGltZWxpbmUtPm11dGV4
LiBUaGVyZSB3ZQpzdGFydGVkIG1hbmlwdWxhdGluZyBpbnRlbF90aW1lbGluZS5hY3RpdmVfY291
bnQgb3V0c2lkZSBvZiBhbiBlbmdpbmUKd2FrZXJlZiwgYW5kIHNvIGludHJvZHVjZWQgYSByYWNl
IGJldHdlZW4gX19lbmdpbmVfcGFyaygpIGFuZAppbnRlbF9ndF9yZXRpcmVfcmVxdWVzdHMoKSwg
YSByYWNlIHRoYXQgY291bGQgcmVzdWx0IGluIHRoZQplbmdpbmUtPmtlcm5lbF9jb250ZXh0IG5v
dCBiZWluZyBhZGRlZCB0byB0aGUgYWN0aXZlIHRpbWVsaW5lcyBhbmQgc28KbG9zaW5nIHJlcXVl
c3RzLCB3aGljaCBjYXVzZWQgdXMgdG8ga2VlcCB0aGUgc3lzdGVtIHBlcm1hbmVudGx5IHBvd2Vy
ZWQKdXAgW2FuZCB1bmxvYWRhYmxlXS4KClRoZSByYWNlIHdvdWxkIGJlIGVhc3kgdG8gY2xvc2Ug
aWYgd2UgY291bGQgdGFrZSB0aGUgZW5naW5lIHdha2VyZWYgZm9yCnRoZSB0aW1lbGluZSBiZWZv
cmUgd2UgcmV0aXJlIC0tIGV4Y2VwdCB0aW1lbGluZXMgYXJlIG5vdCBib3VuZCB0byBhbnkKZW5n
aW5lIGFuZCBzbyB3ZSB3b3VsZCBuZWVkIHRvIGtlZXAgYWxsIGFjdGl2ZSBlbmdpbmVzIGF3YWtl
LiBUaGUKYWx0ZXJuYXRpdmUgaXMgdG8gZ3VhcmQgaW50ZWxfdGltZWxpbmVfZW50ZXIvaW50ZWxf
dGltZWxpbmVfZXhpdCBmb3IgdXNlCm91dHNpZGUgb2YgdGhlIHRpbWVsaW5lLT5tdXRleC4KCkZp
eGVzOiBlNWRhZGZmNGIwOTMgKCJkcm0vaTkxNTogUHJvdGVjdCByZXF1ZXN0IHJldGlyZW1lbnQg
d2l0aCB0aW1lbGluZS0+bXV0ZXgiKQpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNocmlz
QGNocmlzLXdpbHNvbi5jby51az4KQ2M6IE1hdHRoZXcgQXVsZCA8bWF0dGhldy5hdWxkQGludGVs
LmNvbT4KQ2M6IFR2cnRrbyBVcnN1bGluIDx0dnJ0a28udXJzdWxpbkBpbnRlbC5jb20+ClJldmll
d2VkLWJ5OiBUdnJ0a28gVXJzdWxpbiA8dHZydGtvLnVyc3VsaW5AaW50ZWwuY29tPgotLS0KIGRy
aXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2d0X3JlcXVlc3RzLmMgICB8ICA4ICsrLS0tCiBk
cml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF90aW1lbGluZS5jICAgICAgfCAzNCArKysrKysr
KysrKysrKystLS0tCiAuLi4vZ3B1L2RybS9pOTE1L2d0L2ludGVsX3RpbWVsaW5lX3R5cGVzLmgg
ICAgfCAgMiArLQogMyBmaWxlcyBjaGFuZ2VkLCAzMiBpbnNlcnRpb25zKCspLCAxMiBkZWxldGlv
bnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9ndF9yZXF1
ZXN0cy5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZ3RfcmVxdWVzdHMuYwppbmRl
eCAyNTI5MWUyYWYyMWUuLjFhMDA1ZGE4YzU4OCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJt
L2k5MTUvZ3QvaW50ZWxfZ3RfcmVxdWVzdHMuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9n
dC9pbnRlbF9ndF9yZXF1ZXN0cy5jCkBAIC00OSw4ICs0OSw4IEBAIGxvbmcgaW50ZWxfZ3RfcmV0
aXJlX3JlcXVlc3RzX3RpbWVvdXQoc3RydWN0IGludGVsX2d0ICpndCwgbG9uZyB0aW1lb3V0KQog
CQkJY29udGludWU7CiAKIAkJaW50ZWxfdGltZWxpbmVfZ2V0KHRsKTsKLQkJR0VNX0JVR19PTigh
dGwtPmFjdGl2ZV9jb3VudCk7Ci0JCXRsLT5hY3RpdmVfY291bnQrKzsgLyogcGluIHRoZSBsaXN0
IGVsZW1lbnQgKi8KKwkJR0VNX0JVR19PTighYXRvbWljX3JlYWQoJnRsLT5hY3RpdmVfY291bnQp
KTsKKwkJYXRvbWljX2luYygmdGwtPmFjdGl2ZV9jb3VudCk7IC8qIHBpbiB0aGUgbGlzdCBlbGVt
ZW50ICovCiAJCXNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJnRpbWVsaW5lcy0+bG9jaywgZmxhZ3Mp
OwogCiAJCWlmICh0aW1lb3V0ID4gMCkgewpAQCAtNzEsMTQgKzcxLDE0IEBAIGxvbmcgaW50ZWxf
Z3RfcmV0aXJlX3JlcXVlc3RzX3RpbWVvdXQoc3RydWN0IGludGVsX2d0ICpndCwgbG9uZyB0aW1l
b3V0KQogCiAJCS8qIFJlc3VtZSBpdGVyYXRpb24gYWZ0ZXIgZHJvcHBpbmcgbG9jayAqLwogCQls
aXN0X3NhZmVfcmVzZXRfbmV4dCh0bCwgdG4sIGxpbmspOwotCQlpZiAoIS0tdGwtPmFjdGl2ZV9j
b3VudCkKKwkJaWYgKGF0b21pY19kZWNfYW5kX3Rlc3QoJnRsLT5hY3RpdmVfY291bnQpKQogCQkJ
bGlzdF9kZWwoJnRsLT5saW5rKTsKIAogCQltdXRleF91bmxvY2soJnRsLT5tdXRleCk7CiAKIAkJ
LyogRGVmZXIgdGhlIGZpbmFsIHJlbGVhc2UgdG8gYWZ0ZXIgdGhlIHNwaW5sb2NrICovCiAJCWlm
IChyZWZjb3VudF9kZWNfYW5kX3Rlc3QoJnRsLT5rcmVmLnJlZmNvdW50KSkgewotCQkJR0VNX0JV
R19PTih0bC0+YWN0aXZlX2NvdW50KTsKKwkJCUdFTV9CVUdfT04oYXRvbWljX3JlYWQoJnRsLT5h
Y3RpdmVfY291bnQpKTsKIAkJCWxpc3RfYWRkKCZ0bC0+bGluaywgJmZyZWUpOwogCQl9CiAJfQpk
aWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfdGltZWxpbmUuYyBiL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX3RpbWVsaW5lLmMKaW5kZXggMGUyNzc4MzVhYWQw
Li5iMzVmMTI3Mjk5ODMgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVs
X3RpbWVsaW5lLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfdGltZWxpbmUu
YwpAQCAtMzM0LDE1ICszMzQsMzMgQEAgdm9pZCBpbnRlbF90aW1lbGluZV9lbnRlcihzdHJ1Y3Qg
aW50ZWxfdGltZWxpbmUgKnRsKQogCXN0cnVjdCBpbnRlbF9ndF90aW1lbGluZXMgKnRpbWVsaW5l
cyA9ICZ0bC0+Z3QtPnRpbWVsaW5lczsKIAl1bnNpZ25lZCBsb25nIGZsYWdzOwogCisJLyoKKwkg
KiBQcmV0ZW5kIHdlIGFyZSBzZXJpYWxpc2VkIGJ5IHRoZSB0aW1lbGluZS0+bXV0ZXguCisJICoK
KwkgKiBXaGlsZSBnZW5lcmFsbHkgdHJ1ZSwgdGhlcmUgYXJlIGEgZmV3IGV4Y2VwdGlvbnMgdG8g
dGhlIHJ1bGUKKwkgKiBmb3IgdGhlIGVuZ2luZS0+a2VybmVsX2NvbnRleHQgYmVpbmcgdXNlZCB0
byBtYW5hZ2UgcG93ZXIKKwkgKiB0cmFuc2l0aW9ucy4gQXMgdGhlIGVuZ2luZV9wYXJrIG1heSBi
ZSBjYWxsZWQgZnJvbSB1bmRlciBhbnkKKwkgKiB0aW1lbGluZSwgaXQgdXNlcyB0aGUgcG93ZXIg
bXV0ZXggYXMgYSBnbG9iYWwgc2VyaWFsaXNhdGlvbgorCSAqIGxvY2sgdG8gcHJldmVudCBhbnkg
b3RoZXIgcmVxdWVzdCBlbnRlcmluZyBpdHMgdGltZWxpbmUuCisJICoKKwkgKiBUaGUgcnVsZSBp
cyBnZW5lcmFsbHkgdGwtPm11dGV4LCBvdGhlcndpc2UgZW5naW5lLT53YWtlcmVmLm11dGV4Lgor
CSAqCisJICogSG93ZXZlciwgaW50ZWxfZ3RfcmV0aXJlX3JlcXVlc3QoKSBkb2VzIG5vdCBrbm93
IHdoaWNoIGVuZ2luZQorCSAqIGl0IGlzIHJldGlyaW5nIGFsb25nIGFuZCBzbyBjYW5ub3QgcGFy
dGFrZSBpbiB0aGUgZW5naW5lLXBtCisJICogYmFycmllciwgYW5kIHRoZXJlIHdlIHVzZSB0aGUg
dGwtPmFjdGl2ZV9jb3VudCBhcyBhIG1lYW5zIHRvCisJICogcGluIHRoZSB0aW1lbGluZSBpbiB0
aGUgYWN0aXZlX2xpc3Qgd2hpbGUgdGhlIGxvY2tzIGFyZSBkcm9wcGVkLgorCSAqIEVyZ28sIGFz
IHRoYXQgaXMgb3V0c2lkZSBvZiB0aGUgZW5naW5lLXBtIGJhcnJpZXIsIHdlIG5lZWQgdG8KKwkg
KiB1c2UgYXRvbWljIHRvIG1hbmlwdWxhdGUgdGwtPmFjdGl2ZV9jb3VudC4KKwkgKi8KIAlsb2Nr
ZGVwX2Fzc2VydF9oZWxkKCZ0bC0+bXV0ZXgpOwotCiAJR0VNX0JVR19PTighYXRvbWljX3JlYWQo
JnRsLT5waW5fY291bnQpKTsKLQlpZiAodGwtPmFjdGl2ZV9jb3VudCsrKQorCisJaWYgKGF0b21p
Y19hZGRfdW5sZXNzKCZ0bC0+YWN0aXZlX2NvdW50LCAxLCAwKSkKIAkJcmV0dXJuOwotCUdFTV9C
VUdfT04oIXRsLT5hY3RpdmVfY291bnQpOyAvKiBvdmVyZmxvdz8gKi8KIAogCXNwaW5fbG9ja19p
cnFzYXZlKCZ0aW1lbGluZXMtPmxvY2ssIGZsYWdzKTsKLQlsaXN0X2FkZF90YWlsKCZ0bC0+bGlu
aywgJnRpbWVsaW5lcy0+YWN0aXZlX2xpc3QpOworCWlmICghYXRvbWljX2ZldGNoX2luYygmdGwt
PmFjdGl2ZV9jb3VudCkpCisJCWxpc3RfYWRkX3RhaWwoJnRsLT5saW5rLCAmdGltZWxpbmVzLT5h
Y3RpdmVfbGlzdCk7CiAJc3Bpbl91bmxvY2tfaXJxcmVzdG9yZSgmdGltZWxpbmVzLT5sb2NrLCBm
bGFncyk7CiB9CiAKQEAgLTM1MSwxNCArMzY5LDE2IEBAIHZvaWQgaW50ZWxfdGltZWxpbmVfZXhp
dChzdHJ1Y3QgaW50ZWxfdGltZWxpbmUgKnRsKQogCXN0cnVjdCBpbnRlbF9ndF90aW1lbGluZXMg
KnRpbWVsaW5lcyA9ICZ0bC0+Z3QtPnRpbWVsaW5lczsKIAl1bnNpZ25lZCBsb25nIGZsYWdzOwog
CisJLyogU2VlIGludGVsX3RpbWVsaW5lX2VudGVyKCkgKi8KIAlsb2NrZGVwX2Fzc2VydF9oZWxk
KCZ0bC0+bXV0ZXgpOwogCi0JR0VNX0JVR19PTighdGwtPmFjdGl2ZV9jb3VudCk7Ci0JaWYgKC0t
dGwtPmFjdGl2ZV9jb3VudCkKKwlHRU1fQlVHX09OKCFhdG9taWNfcmVhZCgmdGwtPmFjdGl2ZV9j
b3VudCkpOworCWlmIChhdG9taWNfYWRkX3VubGVzcygmdGwtPmFjdGl2ZV9jb3VudCwgLTEsIDEp
KQogCQlyZXR1cm47CiAKIAlzcGluX2xvY2tfaXJxc2F2ZSgmdGltZWxpbmVzLT5sb2NrLCBmbGFn
cyk7Ci0JbGlzdF9kZWwoJnRsLT5saW5rKTsKKwlpZiAoYXRvbWljX2RlY19hbmRfdGVzdCgmdGwt
PmFjdGl2ZV9jb3VudCkpCisJCWxpc3RfZGVsKCZ0bC0+bGluayk7CiAJc3Bpbl91bmxvY2tfaXJx
cmVzdG9yZSgmdGltZWxpbmVzLT5sb2NrLCBmbGFncyk7CiAKIAkvKgpkaWZmIC0tZ2l0IGEvZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfdGltZWxpbmVfdHlwZXMuaCBiL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L2d0L2ludGVsX3RpbWVsaW5lX3R5cGVzLmgKaW5kZXggOThkOWVlMTY2Mzc5Li41
MjQ0NjE1ZWQxY2IgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX3Rp
bWVsaW5lX3R5cGVzLmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfdGltZWxp
bmVfdHlwZXMuaApAQCAtNDIsNyArNDIsNyBAQCBzdHJ1Y3QgaW50ZWxfdGltZWxpbmUgewogCSAq
IGZyb20gdGhlIGludGVsX2NvbnRleHQgY2FsbGVyIHBsdXMgaW50ZXJuYWwgYXRvbWljaXR5Lgog
CSAqLwogCWF0b21pY190IHBpbl9jb3VudDsKLQl1bnNpZ25lZCBpbnQgYWN0aXZlX2NvdW50Owor
CWF0b21pY190IGFjdGl2ZV9jb3VudDsKIAogCWNvbnN0IHUzMiAqaHdzcF9zZXFubzsKIAlzdHJ1
Y3QgaTkxNV92bWEgKmh3c3BfZ2d0dDsKLS0gCjIuMjQuMAoKX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1n
ZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21h
aWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

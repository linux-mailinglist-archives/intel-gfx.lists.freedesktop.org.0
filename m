Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 072E7E33AA
	for <lists+intel-gfx@lfdr.de>; Thu, 24 Oct 2019 15:14:06 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 2119B6E3F3;
	Thu, 24 Oct 2019 13:14:04 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 8BB136E3F2
 for <intel-gfx@lists.freedesktop.org>; Thu, 24 Oct 2019 13:13:59 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18949964-1500050 
 for multiple; Thu, 24 Oct 2019 14:13:46 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Thu, 24 Oct 2019 14:13:40 +0100
Message-Id: <20191024131343.16194-2-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.24.0.rc0
In-Reply-To: <20191024131343.16194-1-chris@chris-wilson.co.uk>
References: <20191024131343.16194-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [RFC 2/5] drm/i915: Push the use-semaphore marker onto
 the intel_context
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SW5zdGVhZCBvZiBydW1tYWdpbmcgdGhyb3VnaCB0aGUgaW50ZWxfY29udGV4dCB0byBwZWVrIGF0
IHRoZSBHRU0KY29udGV4dCBpbiB0aGUgbWlkZGxlIG9mIHJlcXVlc3Qgc3VibWlzc2lvbiB0byBk
ZWNpZGUgd2hldGhlciB0byB1c2UKc2VtYXBob3Jlcywgc3RvcmUgdGhhdCBpbmZvcm1hdGlvbiBv
biB0aGUgaW50ZWxfY29udGV4dCBpdHNlbGYuCgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24g
PGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0v
aTkxNV9nZW1fY29udGV4dC5jICAgfCA1MiArKysrKysrKysrKysrLS0tLS0tCiBkcml2ZXJzL2dw
dS9kcm0vaTkxNS9ndC9pbnRlbF9jb250ZXh0LmMgICAgICAgfCAgMyArKwogZHJpdmVycy9ncHUv
ZHJtL2k5MTUvZ3QvaW50ZWxfY29udGV4dC5oICAgICAgIHwgMTUgKysrKysrCiBkcml2ZXJzL2dw
dS9kcm0vaTkxNS9ndC9pbnRlbF9jb250ZXh0X3R5cGVzLmggfCAgNyArLS0KIGRyaXZlcnMvZ3B1
L2RybS9pOTE1L2k5MTVfcmVxdWVzdC5jICAgICAgICAgICB8ICA4ICsrLQogNSBmaWxlcyBjaGFu
Z2VkLCA2MCBpbnNlcnRpb25zKCspLCAyNSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fY29udGV4dC5jIGIvZHJpdmVycy9ncHUvZHJt
L2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRleHQuYwppbmRleCBlZmE0ZjdjNzYyYzMuLmYzNGRjNDQw
YjM3ZSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRl
eHQuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fY29udGV4dC5jCkBA
IC0xNzM4LDYgKzE3MzgsNDAgQEAgZ2V0X2VuZ2luZXMoc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQg
KmN0eCwKIAlyZXR1cm4gZXJyOwogfQogCitzdGF0aWMgdm9pZCBfX2FwcGx5X3ByaW9yaXR5KHN0
cnVjdCBpbnRlbF9jb250ZXh0ICpjZSwgdm9pZCAqYXJnKQoreworCXN0cnVjdCBpOTE1X2dlbV9j
b250ZXh0ICpjdHggPSBhcmc7CisKKwlpZiAoaW50ZWxfY29udGV4dF91c2Vfc2VtYXBob3Jlcyhj
ZSkgJiYKKwkgICAgY3R4LT5zY2hlZC5wcmlvcml0eSA8IEk5MTVfUFJJT1JJVFlfTk9STUFMKQor
CQlpbnRlbF9jb250ZXh0X2NsZWFyX3VzZV9zZW1hcGhvcmVzKGNlKTsKK30KKworc3RhdGljIGlu
dCBzZXRfcHJpb3JpdHkoc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCwKKwkJCWNvbnN0IHN0
cnVjdCBkcm1faTkxNV9nZW1fY29udGV4dF9wYXJhbSAqYXJncykKK3sKKwlzNjQgcHJpb3JpdHkg
PSBhcmdzLT52YWx1ZTsKKworCWlmIChhcmdzLT5zaXplKQorCQlyZXR1cm4gLUVJTlZBTDsKKwor
CWlmICghKGN0eC0+aTkxNS0+Y2Fwcy5zY2hlZHVsZXIgJiBJOTE1X1NDSEVEVUxFUl9DQVBfUFJJ
T1JJVFkpKQorCQlyZXR1cm4gLUVOT0RFVjsKKworCWlmIChwcmlvcml0eSA+IEk5MTVfQ09OVEVY
VF9NQVhfVVNFUl9QUklPUklUWSB8fAorCSAgICBwcmlvcml0eSA8IEk5MTVfQ09OVEVYVF9NSU5f
VVNFUl9QUklPUklUWSkKKwkJcmV0dXJuIC1FSU5WQUw7CisKKwlpZiAocHJpb3JpdHkgPiBJOTE1
X0NPTlRFWFRfREVGQVVMVF9QUklPUklUWSAmJgorCSAgICAhY2FwYWJsZShDQVBfU1lTX05JQ0Up
KQorCQlyZXR1cm4gLUVQRVJNOworCisJY3R4LT5zY2hlZC5wcmlvcml0eSA9IEk5MTVfVVNFUl9Q
UklPUklUWShwcmlvcml0eSk7CisJY29udGV4dF9hcHBseV9hbGwoY3R4LCBfX2FwcGx5X3ByaW9y
aXR5LCBjdHgpOworCisJcmV0dXJuIDA7Cit9CisKIHN0YXRpYyBpbnQgY3R4X3NldHBhcmFtKHN0
cnVjdCBkcm1faTkxNV9maWxlX3ByaXZhdGUgKmZwcml2LAogCQkJc3RydWN0IGk5MTVfZ2VtX2Nv
bnRleHQgKmN0eCwKIAkJCXN0cnVjdCBkcm1faTkxNV9nZW1fY29udGV4dF9wYXJhbSAqYXJncykK
QEAgLTE3ODQsMjMgKzE4MTgsNyBAQCBzdGF0aWMgaW50IGN0eF9zZXRwYXJhbShzdHJ1Y3QgZHJt
X2k5MTVfZmlsZV9wcml2YXRlICpmcHJpdiwKIAkJYnJlYWs7CiAKIAljYXNlIEk5MTVfQ09OVEVY
VF9QQVJBTV9QUklPUklUWToKLQkJewotCQkJczY0IHByaW9yaXR5ID0gYXJncy0+dmFsdWU7Ci0K
LQkJCWlmIChhcmdzLT5zaXplKQotCQkJCXJldCA9IC1FSU5WQUw7Ci0JCQllbHNlIGlmICghKGN0
eC0+aTkxNS0+Y2Fwcy5zY2hlZHVsZXIgJiBJOTE1X1NDSEVEVUxFUl9DQVBfUFJJT1JJVFkpKQot
CQkJCXJldCA9IC1FTk9ERVY7Ci0JCQllbHNlIGlmIChwcmlvcml0eSA+IEk5MTVfQ09OVEVYVF9N
QVhfVVNFUl9QUklPUklUWSB8fAotCQkJCSBwcmlvcml0eSA8IEk5MTVfQ09OVEVYVF9NSU5fVVNF
Ul9QUklPUklUWSkKLQkJCQlyZXQgPSAtRUlOVkFMOwotCQkJZWxzZSBpZiAocHJpb3JpdHkgPiBJ
OTE1X0NPTlRFWFRfREVGQVVMVF9QUklPUklUWSAmJgotCQkJCSAhY2FwYWJsZShDQVBfU1lTX05J
Q0UpKQotCQkJCXJldCA9IC1FUEVSTTsKLQkJCWVsc2UKLQkJCQljdHgtPnNjaGVkLnByaW9yaXR5
ID0KLQkJCQkJSTkxNV9VU0VSX1BSSU9SSVRZKHByaW9yaXR5KTsKLQkJfQorCQlyZXQgPSBzZXRf
cHJpb3JpdHkoY3R4LCBhcmdzKTsKIAkJYnJlYWs7CiAKIAljYXNlIEk5MTVfQ09OVEVYVF9QQVJB
TV9TU0VVOgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfY29udGV4
dC5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfY29udGV4dC5jCmluZGV4IDYyNWY3
NWY3ODI1ZC4uNzA3NWQwM2Y1MDhmIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9n
dC9pbnRlbF9jb250ZXh0LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfY29u
dGV4dC5jCkBAIC0yMzgsNiArMjM4LDkgQEAgaW50ZWxfY29udGV4dF9pbml0KHN0cnVjdCBpbnRl
bF9jb250ZXh0ICpjZSwKIAlyY3VfcmVhZF91bmxvY2soKTsKIAlpZiAoY3R4LT50aW1lbGluZSkK
IAkJY2UtPnRpbWVsaW5lID0gaW50ZWxfdGltZWxpbmVfZ2V0KGN0eC0+dGltZWxpbmUpOworCWlm
IChjdHgtPnNjaGVkLnByaW9yaXR5ID49IEk5MTVfUFJJT1JJVFlfTk9STUFMICYmCisJICAgIGlu
dGVsX2VuZ2luZV9oYXNfc2VtYXBob3JlcyhlbmdpbmUpKQorCQlfX3NldF9iaXQoQ09OVEVYVF9V
U0VfU0VNQVBIT1JFUywgJmNlLT5mbGFncyk7CiAKIAljZS0+ZW5naW5lID0gZW5naW5lOwogCWNl
LT5vcHMgPSBlbmdpbmUtPmNvcHM7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9n
dC9pbnRlbF9jb250ZXh0LmggYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9jb250ZXh0
LmgKaW5kZXggMWU2MDczNDNkMjU2Li5kN2I2NjdhMjZlMDggMTAwNjQ0Ci0tLSBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2d0L2ludGVsX2NvbnRleHQuaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9ndC9pbnRlbF9jb250ZXh0LmgKQEAgLTE1NSw2ICsxNTUsMjEgQEAgc3RhdGljIGlubGluZSBz
dHJ1Y3QgaW50ZWxfcmluZyAqX19pbnRlbF9jb250ZXh0X3Jpbmdfc2l6ZSh1NjQgc3opCiAJcmV0
dXJuIHU2NF90b19wdHIoc3RydWN0IGludGVsX3JpbmcsIHN6KTsKIH0KIAorc3RhdGljIGlubGlu
ZSBib29sIGludGVsX2NvbnRleHRfdXNlX3NlbWFwaG9yZXMoY29uc3Qgc3RydWN0IGludGVsX2Nv
bnRleHQgKmNlKQoreworCXJldHVybiB0ZXN0X2JpdChDT05URVhUX1VTRV9TRU1BUEhPUkVTLCAm
Y2UtPmZsYWdzKTsKK30KKworc3RhdGljIGlubGluZSB2b2lkIGludGVsX2NvbnRleHRfc2V0X3Vz
ZV9zZW1hcGhvcmVzKHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSkKK3sKKwlzZXRfYml0KENPTlRF
WFRfVVNFX1NFTUFQSE9SRVMsICZjZS0+ZmxhZ3MpOworfQorCitzdGF0aWMgaW5saW5lIHZvaWQg
aW50ZWxfY29udGV4dF9jbGVhcl91c2Vfc2VtYXBob3JlcyhzdHJ1Y3QgaW50ZWxfY29udGV4dCAq
Y2UpCit7CisJY2xlYXJfYml0KENPTlRFWFRfVVNFX1NFTUFQSE9SRVMsICZjZS0+ZmxhZ3MpOwor
fQorCiBzdGF0aWMgaW5saW5lIGJvb2wgaW50ZWxfY29udGV4dF9pc19iYW5uZWQoY29uc3Qgc3Ry
dWN0IGludGVsX2NvbnRleHQgKmNlKQogewogCXJldHVybiB0ZXN0X2JpdChDT05URVhUX0JBTk5F
RCwgJmNlLT5mbGFncyk7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRl
bF9jb250ZXh0X3R5cGVzLmggYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9jb250ZXh0
X3R5cGVzLmgKaW5kZXggMDI1MWVkYzhmNTY4Li4yNjRjMWVmZGU3NzIgMTAwNjQ0Ci0tLSBhL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2NvbnRleHRfdHlwZXMuaAorKysgYi9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9jb250ZXh0X3R5cGVzLmgKQEAgLTU1LDkgKzU1LDEwIEBA
IHN0cnVjdCBpbnRlbF9jb250ZXh0IHsKIAogCXVuc2lnbmVkIGxvbmcgZmxhZ3M7CiAjZGVmaW5l
IENPTlRFWFRfQUxMT0NfQklUCQkwCi0jZGVmaW5lIENPTlRFWFRfQkFOTkVECQkJMQotI2RlZmlu
ZSBDT05URVhUX0ZPUkNFX1NJTkdMRV9TVUJNSVNTSU9OCTIKLSNkZWZpbmUgQ09OVEVYVF9OT1BS
RUVNUFQJCTMKKyNkZWZpbmUgQ09OVEVYVF9VU0VfU0VNQVBIT1JFUwkJMQorI2RlZmluZSBDT05U
RVhUX0JBTk5FRAkJCTIKKyNkZWZpbmUgQ09OVEVYVF9GT1JDRV9TSU5HTEVfU1VCTUlTU0lPTgkz
CisjZGVmaW5lIENPTlRFWFRfTk9QUkVFTVBUCQk0CiAKIAl1MzIgKmxyY19yZWdfc3RhdGU7CiAJ
dTY0IGxyY19kZXNjOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9yZXF1
ZXN0LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3JlcXVlc3QuYwppbmRleCBiOWZjMzFj
ZWEzNjcuLmNiZGJkZDg1NDdlMSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkx
NV9yZXF1ZXN0LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9yZXF1ZXN0LmMKQEAg
LTg5MiwxOCArODkyLDE2IEBAIGk5MTVfcmVxdWVzdF9hd2FpdF9yZXF1ZXN0KHN0cnVjdCBpOTE1
X3JlcXVlc3QgKnRvLCBzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpmcm9tKQogCQkJcmV0dXJuIHJldDsK
IAl9CiAKLQlpZiAodG8tPmVuZ2luZSA9PSBmcm9tLT5lbmdpbmUpIHsKKwlpZiAodG8tPmVuZ2lu
ZSA9PSBmcm9tLT5lbmdpbmUpCiAJCXJldCA9IGk5MTVfc3dfZmVuY2VfYXdhaXRfc3dfZmVuY2Vf
Z2ZwKCZ0by0+c3VibWl0LAogCQkJCQkJICAgICAgICZmcm9tLT5zdWJtaXQsCiAJCQkJCQkgICAg
ICAgSTkxNV9GRU5DRV9HRlApOwotCX0gZWxzZSBpZiAoaW50ZWxfZW5naW5lX2hhc19zZW1hcGhv
cmVzKHRvLT5lbmdpbmUpICYmCi0JCSAgIHRvLT5jb250ZXh0LT5nZW1fY29udGV4dC0+c2NoZWQu
cHJpb3JpdHkgPj0gSTkxNV9QUklPUklUWV9OT1JNQUwpIHsKKwllbHNlIGlmIChpbnRlbF9jb250
ZXh0X3VzZV9zZW1hcGhvcmVzKHRvLT5jb250ZXh0KSkKIAkJcmV0ID0gZW1pdF9zZW1hcGhvcmVf
d2FpdCh0bywgZnJvbSwgSTkxNV9GRU5DRV9HRlApOwotCX0gZWxzZSB7CisJZWxzZQogCQlyZXQg
PSBpOTE1X3N3X2ZlbmNlX2F3YWl0X2RtYV9mZW5jZSgmdG8tPnN1Ym1pdCwKIAkJCQkJCSAgICAm
ZnJvbS0+ZmVuY2UsIDAsCiAJCQkJCQkgICAgSTkxNV9GRU5DRV9HRlApOwotCX0KIAlpZiAocmV0
IDwgMCkKIAkJcmV0dXJuIHJldDsKIAotLSAKMi4yNC4wLnJjMAoKX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRl
bC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3Jn
L21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

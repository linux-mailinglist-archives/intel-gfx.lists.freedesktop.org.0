Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id B9D6245553
	for <lists+intel-gfx@lfdr.de>; Fri, 14 Jun 2019 09:10:54 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 15C42893A4;
	Fri, 14 Jun 2019 07:10:46 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 4868988F1E
 for <intel-gfx@lists.freedesktop.org>; Fri, 14 Jun 2019 07:10:41 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 16897514-1500050 
 for multiple; Fri, 14 Jun 2019 08:10:28 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Fri, 14 Jun 2019 08:09:55 +0100
Message-Id: <20190614071023.17929-12-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190614071023.17929-1-chris@chris-wilson.co.uk>
References: <20190614071023.17929-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 11/39] drm/i915/execlists: Force preemption
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SWYgdGhlIHByZWVtcHRlZCBjb250ZXh0IHRha2VzIHRvbyBsb25nIHRvIHJlbGlucXVpc2ggY29u
dHJvbCwgZS5nLiBpdAppcyBzdHVjayBpbnNpZGUgYSBzaGFkZXIgd2l0aCBhcmJpdHJhdGlvbiBk
aXNhYmxlZCwgZXZpY3QgdGhhdCBjb250ZXh0CndpdGggYW4gZW5naW5lIHJlc2V0LiBUaGlzIGVu
c3VyZXMgdGhhdCBwcmVlbXB0aW9ucyBhcmUgcmVhc29uYWJseQpyZXNwb25zaXZlLCBwcm92aWRp
bmcgYSB0aWdodGVyIFFvUyBmb3IgdGhlIG1vcmUgaW1wb3J0YW50IGNvbnRleHQgYXQKdGhlIGNv
c3Qgb2YgZmxhZ2dpbmcgdW5yZXNwb25zaXZlIGNvbnRleHRzIG1vcmUgZnJlcXVlbnRseSAoaS5l
LiBpbnN0ZWFkCm9mIHVzaW5nIGFuIH4xMHMgaGFuZ2NoZWNrLCB3ZSBub3cgZXZpY3QgYXQgfjEw
bXMpLiAgVGhlIGNoYWxsZW5nZSBvZgpsaWVzIGluIHBpY2tpbmcgYSB0aW1lb3V0IHRoYXQgY2Fu
IGJlIHJlYXNvbmFibHkgc2VydmljZWQgYnkgSFcgZm9yCnR5cGljYWwgd29ya2xvYWRzLCBiYWxh
bmNpbmcgdGhlIGV4aXN0aW5nIGNsaWVudHMgYWdhaW5zdCB0aGUgbmVlZHMgZm9yCnJlc3BvbnNp
dmVuZXNzLgoKU2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24u
Y28udWs+CkNjOiBNaWthIEt1b3BwYWxhIDxtaWthLmt1b3BwYWxhQGxpbnV4LmludGVsLmNvbT4K
Q2M6IFR2cnRrbyBVcnN1bGluIDx0dnJ0a28udXJzdWxpbkBpbnRlbC5jb20+Ci0tLQogZHJpdmVy
cy9ncHUvZHJtL2k5MTUvS2NvbmZpZy5wcm9maWxlIHwgMTIgKysrKysrCiBkcml2ZXJzL2dwdS9k
cm0vaTkxNS9ndC9pbnRlbF9scmMuYyAgfCA1NiArKysrKysrKysrKysrKysrKysrKysrKysrKy0t
CiAyIGZpbGVzIGNoYW5nZWQsIDY1IGluc2VydGlvbnMoKyksIDMgZGVsZXRpb25zKC0pCgpkaWZm
IC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvS2NvbmZpZy5wcm9maWxlIGIvZHJpdmVycy9n
cHUvZHJtL2k5MTUvS2NvbmZpZy5wcm9maWxlCmluZGV4IDQ4ZGY4ODg5YTg4YS4uODI3M2QzYmFh
ZmU0IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9LY29uZmlnLnByb2ZpbGUKKysr
IGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvS2NvbmZpZy5wcm9maWxlCkBAIC0yNSwzICsyNSwxNSBA
QCBjb25maWcgRFJNX0k5MTVfU1BJTl9SRVFVRVNUCiAJICBNYXkgYmUgMCB0byBkaXNhYmxlIHRo
ZSBpbml0aWFsIHNwaW4uIEluIHByYWN0aWNlLCB3ZSBlc3RpbWF0ZQogCSAgdGhlIGNvc3Qgb2Yg
ZW5hYmxpbmcgdGhlIGludGVycnVwdCAoaWYgY3VycmVudGx5IGRpc2FibGVkKSB0byBiZQogCSAg
YSBmZXcgbWljcm9zZWNvbmRzLgorCitjb25maWcgRFJNX0k5MTVfUFJFRU1QVF9USU1FT1VUCisJ
aW50ICJQcmVlbXB0IHRpbWVvdXQgKG1zKSIKKwlkZWZhdWx0IDEwICMgbWlsbGlzZWNvbmRzCisJ
aGVscAorCSAgSG93IGxvbmcgdG8gd2FpdCAoaW4gbWlsbGlzZWNvbmRzKSBmb3IgYSBwcmVlbXB0
aW9uIGV2ZW50IHRvIG9jY3VyCisJICB3aGVuIHN1Ym1pdHRpbmcgYSBuZXcgY29udGV4dCB2aWEg
ZXhlY2xpc3RzLiBJZiB0aGUgY3VycmVudCBjb250ZXh0CisJICBkb2VzIG5vdCBoaXQgYW4gYXJi
aXRyYXRpb24gcG9pbnQgYW5kIHlpZWxkIHRvIEhXIGJlZm9yZSB0aGUgdGltZXIKKwkgIGV4cGly
ZXMsIHRoZSBIVyB3aWxsIGJlIHJlc2V0IHRvIGFsbG93IHRoZSBtb3JlIGltcG9ydGFudCBjb250
ZXh0CisJICB0byBleGVjdXRlLgorCisJICBNYXkgYmUgMCB0byBkaXNhYmxlIHRoZSB0aW1lb3V0
LgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjLmMgYi9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9scmMuYwppbmRleCBjZWEwOGQ2NjVlZjUuLjA1NjNm
ZTgzOThjNSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjLmMK
KysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjLmMKQEAgLTg4Nyw2ICs4ODcs
MTUgQEAgZW5hYmxlX3RpbWVzbGljZShzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUpCiAJ
cmV0dXJuIGxhc3QgJiYgbmVlZF90aW1lc2xpY2UoZW5naW5lLCBsYXN0KTsKIH0KIAorc3RhdGlj
IHVuc2lnbmVkIGxvbmcgcHJlZW1wdF9leHBpcmVzKHZvaWQpCit7CisJdW5zaWduZWQgbG9uZyB0
aW1lb3V0ID0KKwkJbXNlY3NfdG9famlmZmllc190aW1lb3V0KENPTkZJR19EUk1fSTkxNV9QUkVF
TVBUX1RJTUVPVVQpOworCisJYmFycmllcigpOworCXJldHVybiBqaWZmaWVzICsgdGltZW91dDsK
K30KKwogc3RhdGljIHZvaWQgZXhlY2xpc3RzX2RlcXVldWUoc3RydWN0IGludGVsX2VuZ2luZV9j
cyAqZW5naW5lKQogewogCXN0cnVjdCBpbnRlbF9lbmdpbmVfZXhlY2xpc3RzICogY29uc3QgZXhl
Y2xpc3RzID0gJmVuZ2luZS0+ZXhlY2xpc3RzOwpAQCAtMTIxOCw2ICsxMjI3LDkgQEAgc3RhdGlj
IHZvaWQgZXhlY2xpc3RzX2RlcXVldWUoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lKQog
CQkqcG9ydCA9IGV4ZWNsaXN0c19zY2hlZHVsZV9pbihsYXN0LCBwb3J0IC0gZXhlY2xpc3RzLT5w
ZW5kaW5nKTsKIAkJbWVtc2V0KHBvcnQgKyAxLCAwLCAobGFzdF9wb3J0IC0gcG9ydCkgKiBzaXpl
b2YoKnBvcnQpKTsKIAkJZXhlY2xpc3RzX3N1Ym1pdF9wb3J0cyhlbmdpbmUpOworCisJCWlmIChD
T05GSUdfRFJNX0k5MTVfUFJFRU1QVF9USU1FT1VUKQorCQkJbW9kX3RpbWVyKCZleGVjbGlzdHMt
PnRpbWVyLCBwcmVlbXB0X2V4cGlyZXMoKSk7CiAJfQogfQogCkBAIC0xMzczLDEzICsxMzg1LDQ4
IEBAIHN0YXRpYyB2b2lkIHByb2Nlc3NfY3NiKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2lu
ZSkKIAlpbnZhbGlkYXRlX2NzYl9lbnRyaWVzKCZidWZbMF0sICZidWZbbnVtX2VudHJpZXMgLSAx
XSk7CiB9CiAKLXN0YXRpYyB2b2lkIF9fZXhlY2xpc3RzX3N1Ym1pc3Npb25fdGFza2xldChzdHJ1
Y3QgaW50ZWxfZW5naW5lX2NzICpjb25zdCBlbmdpbmUpCitzdGF0aWMgYm9vbCBfX2V4ZWNsaXN0
c19zdWJtaXNzaW9uX3Rhc2tsZXQoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqY29uc3QgZW5naW5l
KQogewogCWxvY2tkZXBfYXNzZXJ0X2hlbGQoJmVuZ2luZS0+YWN0aXZlLmxvY2spOwogCiAJcHJv
Y2Vzc19jc2IoZW5naW5lKTsKLQlpZiAoIWVuZ2luZS0+ZXhlY2xpc3RzLnBlbmRpbmdbMF0pCisJ
aWYgKCFlbmdpbmUtPmV4ZWNsaXN0cy5wZW5kaW5nWzBdKSB7CiAJCWV4ZWNsaXN0c19kZXF1ZXVl
KGVuZ2luZSk7CisJCXJldHVybiB0cnVlOworCX0KKworCXJldHVybiBmYWxzZTsKK30KKworc3Rh
dGljIHZvaWQgcHJlZW1wdF9yZXNldChzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUpCit7
CisJY29uc3QgdW5zaWduZWQgaW50IGJpdCA9IEk5MTVfUkVTRVRfRU5HSU5FICsgZW5naW5lLT5p
ZDsKKwl1bnNpZ25lZCBsb25nICpsb2NrID0gJmVuZ2luZS0+aTkxNS0+Z3B1X2Vycm9yLmZsYWdz
OworCisJaWYgKHRlc3RfYW5kX3NldF9iaXQoYml0LCBsb2NrKSkKKwkJcmV0dXJuOworCisJdGFz
a2xldF9kaXNhYmxlX25vc3luYygmZW5naW5lLT5leGVjbGlzdHMudGFza2xldCk7CisJc3Bpbl91
bmxvY2soJmVuZ2luZS0+YWN0aXZlLmxvY2spOworCisJaTkxNV9yZXNldF9lbmdpbmUoZW5naW5l
LCAicHJlZW1wdGlvbiB0aW1lIG91dCIpOworCisJc3Bpbl9sb2NrKCZlbmdpbmUtPmFjdGl2ZS5s
b2NrKTsKKwl0YXNrbGV0X2VuYWJsZSgmZW5naW5lLT5leGVjbGlzdHMudGFza2xldCk7CisKKwlj
bGVhcl9iaXQoYml0LCBsb2NrKTsKKwl3YWtlX3VwX2JpdChsb2NrLCBiaXQpOworfQorCitzdGF0
aWMgYm9vbCBwcmVlbXB0X3RpbWVvdXQoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqY29uc3QgZW5n
aW5lKQoreworCWlmICghQ09ORklHX0RSTV9JOTE1X1BSRUVNUFRfVElNRU9VVCkKKwkJcmV0dXJu
IGZhbHNlOworCisJaWYgKCFpbnRlbF9lbmdpbmVfaGFzX3ByZWVtcHRpb24oZW5naW5lKSkKKwkJ
cmV0dXJuIGZhbHNlOworCisJcmV0dXJuICF0aW1lcl9wZW5kaW5nKCZlbmdpbmUtPmV4ZWNsaXN0
cy50aW1lcik7CiB9CiAKIC8qCkBAIC0xMzkyLDcgKzE0MzksMTAgQEAgc3RhdGljIHZvaWQgZXhl
Y2xpc3RzX3N1Ym1pc3Npb25fdGFza2xldCh1bnNpZ25lZCBsb25nIGRhdGEpCiAJdW5zaWduZWQg
bG9uZyBmbGFnczsKIAogCXNwaW5fbG9ja19pcnFzYXZlKCZlbmdpbmUtPmFjdGl2ZS5sb2NrLCBm
bGFncyk7Ci0JX19leGVjbGlzdHNfc3VibWlzc2lvbl90YXNrbGV0KGVuZ2luZSk7CisKKwlpZiAo
IV9fZXhlY2xpc3RzX3N1Ym1pc3Npb25fdGFza2xldChlbmdpbmUpICYmIHByZWVtcHRfdGltZW91
dChlbmdpbmUpKQorCQlwcmVlbXB0X3Jlc2V0KGVuZ2luZSk7CisKIAlzcGluX3VubG9ja19pcnFy
ZXN0b3JlKCZlbmdpbmUtPmFjdGl2ZS5sb2NrLCBmbGFncyk7CiB9CiAKLS0gCjIuMjAuMQoKX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1h
aWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMu
ZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

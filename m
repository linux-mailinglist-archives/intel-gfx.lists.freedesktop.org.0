Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id AB7EBD5E37
	for <lists+intel-gfx@lfdr.de>; Mon, 14 Oct 2019 11:08:39 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 1C6726E1A3;
	Mon, 14 Oct 2019 09:08:34 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 0A9016E17A
 for <intel-gfx@lists.freedesktop.org>; Mon, 14 Oct 2019 09:08:21 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18828693-1500050 
 for multiple; Mon, 14 Oct 2019 10:08:01 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 14 Oct 2019 10:07:54 +0100
Message-Id: <20191014090757.32111-12-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20191014090757.32111-1-chris@chris-wilson.co.uk>
References: <20191014090757.32111-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 12/15] drm/i915/gem: Cancel non-persistent
 contexts on close
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

Tm9ybWFsbHksIHdlIHJlbHkgb24gb3VyIGhhbmdjaGVjayB0byBwcmV2ZW50IHBlcnNpc3RlbnQg
YmF0Y2hlcyBmcm9tCmhvZ2dpbmcgdGhlIEdQVS4gSG93ZXZlciwgaWYgdGhlIHVzZXIgZGlzYWJs
ZXMgaGFuZ2NoZWNrLCB0aGlzIG1lY2hhbmlzbQpicmVha3MgZG93bi4gRGVzcGl0ZSBvdXIgaW5z
aXN0ZW5jZSB0aGF0IHRoaXMgaXMgdW5zYWZlLCB0aGUgdXNlcnMgYXJlCmVxdWFsbHkgaW5zaXN0
ZW50IHRoYXQgdGhleSB3YW50IHRvIHVzZSBlbmRsZXNzIGJhdGNoZXMgYW5kIHdpbGwgZGlzYWJs
ZQp0aGUgaGFuZ2NoZWNrIG1lY2hhbmlzbS4gV2UgYXJlIGxvb2tpbmcgYXQgcGVyaGFwcyByZXBs
YWNpbmcgaGFuZ2NoZWNrCndpdGggYSBzb2Z0ZXIgbWVjaGFuaXNtLCB0aGF0IHNlbmRzIGEgcHVs
c2UgZG93biB0aGUgZW5naW5lIHRvIGNoZWNrIGlmCml0IGlzIHdlbGwuIFdlIGNhbiB1c2UgdGhl
IHNhbWUgcHJlZW1wdGl2ZSBwdWxzZSB0byBmbHVzaCBhbiBhY3RpdmUKcGVyc2lzdGVudCBjb250
ZXh0IG9mZiB0aGUgR1BVIHVwb24gY29udGV4dCBjbG9zZSwgcHJldmVudGluZyByZXNvdXJjZXMK
YmVpbmcgbG9zdCBhbmQgdW5raWxsYWJsZSByZXF1ZXN0cyByZW1haW5pbmcgb24gdGhlIEdQVSBh
ZnRlciBwcm9jZXNzCnRlcm1pbmF0aW9uLiBUbyBhdm9pZCBjaGFuZ2luZyB0aGUgQUJJIGFuZCBh
Y2NpZGVudGFsbHkgYnJlYWtpbmcKZXhpc3RpbmcgdXNlcnNwYWNlLCB3ZSBtYWtlIHRoZSBwZXJz
aXN0ZW5jZSBvZiBhIGNvbnRleHQgZXhwbGljaXQgYW5kCmVuYWJsZSBpdCBieSBkZWZhdWx0ICht
YXRjaGluZyBjdXJyZW50IEFCSSkuIFVzZXJzcGFjZSBjYW4gb3B0IG91dCBvZgpwZXJzaXN0ZW50
IG1vZGUgKGZvcmNpbmcgcmVxdWVzdHMgdG8gYmUgY2FuY2VsbGVkIHdoZW4gdGhlIGNvbnRleHQg
aXMKY2xvc2VkIGJ5IHByb2Nlc3MgdGVybWluYXRpb24gb3IgZXhwbGljaXRseSkgYnkgYSBjb250
ZXh0IHBhcmFtZXRlci4gVG8KZmFjaWxpdGF0ZSBleGlzdGluZyB1c2UtY2FzZXMgb2YgZGlzYWJs
aW5nIGhhbmdjaGVjaywgaWYgdGhlIG1vZHBhcmFtIGlzCmRpc2FibGVkIChpOTE1LmVuYWJsZV9o
YW5nY2hlY2s9MCksIHdlIGRpc2FibGUgcGVyc2lzdGVuY2UgbW9kZSBieQpkZWZhdWx0LiAgKE5v
dGUsIG9uZSBvZiB0aGUgb3V0Y29tZXMgZm9yIHN1cHBvcnRpbmcgZW5kbGVzcyBtb2RlIHdpbGwg
YmUKdGhlIHJlbW92YWwgb2YgaGFuZ2NoZWNraW5nLCBhdCB3aGljaCBwb2ludCBvcHRpbmcgaW50
byBwZXJzaXN0ZW50IG1vZGUKd2lsbCBiZSBtYW5kYXRvcnksIG9yIG1heWJlIHRoZSBkZWZhdWx0
IHBlcmhhcHMgY29udHJvbGxlZCBieSBjZ3JvdXBzLikKCnYyOiBDaGVjayBmb3IgaGFuZ2NoZWNr
aW5nIGF0IGNvbnRleHQgdGVybWluYXRpb24sIHNvIHRoYXQgd2UgYXJlIG5vdApsZWZ0IHdpdGgg
dW5keWluZyBjb250ZXh0cyBmcm9tIGEgY3JhZnR5IHVzZXIuCnYzOiBGb3JjZSBjb250ZXh0IHRl
cm1pbmF0aW9uIGV2ZW4gaWYgZm9yY2VkLXByZWVtcHRpb24gaXMgZGlzYWJsZWQuCgpUZXN0Y2Fz
ZTogaWd0L2dlbV9jdHhfcGVyc2lzdGVuY2UKU2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxj
aHJpc0BjaHJpcy13aWxzb24uY28udWs+CkNjOiBKb29uYXMgTGFodGluZW4gPGpvb25hcy5sYWh0
aW5lbkBsaW51eC5pbnRlbC5jb20+CkNjOiBNaWNoYcWCIFdpbmlhcnNraSA8bWljaGFsLndpbmlh
cnNraUBpbnRlbC5jb20+CkNjOiBKb24gQmxvb21maWVsZCA8am9uLmJsb29tZmllbGRAaW50ZWwu
Y29tPgpSZXZpZXdlZC1ieTogSm9uIEJsb29tZmllbGQgPGpvbi5ibG9vbWZpZWxkQGludGVsLmNv
bT4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fY29udGV4dC5jICAgfCAx
ODIgKysrKysrKysrKysrKysrKysrCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1f
Y29udGV4dC5oICAgfCAgMTUgKysKIC4uLi9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRl
eHRfdHlwZXMuaCB8ICAgMSArCiAuLi4vZ3B1L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMvbW9ja19j
b250ZXh0LmMgfCAgIDIgKwogaW5jbHVkZS91YXBpL2RybS9pOTE1X2RybS5oICAgICAgICAgICAg
ICAgICAgIHwgIDE1ICsrCiA1IGZpbGVzIGNoYW5nZWQsIDIxNSBpbnNlcnRpb25zKCspCgpkaWZm
IC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRleHQuYyBiL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jb250ZXh0LmMKaW5kZXggNWQ4MjIxYzdi
YTgzLi43MGI3MjQ1NmUyYzQgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9p
OTE1X2dlbV9jb250ZXh0LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2Vt
X2NvbnRleHQuYwpAQCAtNzAsNiArNzAsNyBAQAogI2luY2x1ZGUgPGRybS9pOTE1X2RybS5oPgog
CiAjaW5jbHVkZSAiZ3QvaW50ZWxfbHJjX3JlZy5oIgorI2luY2x1ZGUgImd0L2ludGVsX2VuZ2lu
ZV9oZWFydGJlYXQuaCIKICNpbmNsdWRlICJndC9pbnRlbF9lbmdpbmVfdXNlci5oIgogCiAjaW5j
bHVkZSAiaTkxNV9nZW1fY29udGV4dC5oIgpAQCAtMjY5LDYgKzI3MCwxMjggQEAgdm9pZCBpOTE1
X2dlbV9jb250ZXh0X3JlbGVhc2Uoc3RydWN0IGtyZWYgKnJlZikKIAkJc2NoZWR1bGVfd29yaygm
Z2MtPmZyZWVfd29yayk7CiB9CiAKK3N0YXRpYyBpbmxpbmUgc3RydWN0IGk5MTVfZ2VtX2VuZ2lu
ZXMgKgorX19jb250ZXh0X2VuZ2luZXNfc3RhdGljKGNvbnN0IHN0cnVjdCBpOTE1X2dlbV9jb250
ZXh0ICpjdHgpCit7CisJcmV0dXJuIHJjdV9kZXJlZmVyZW5jZV9wcm90ZWN0ZWQoY3R4LT5lbmdp
bmVzLCB0cnVlKTsKK30KKworc3RhdGljIGJvb2wgX19yZXNldF9lbmdpbmUoc3RydWN0IGludGVs
X2VuZ2luZV9jcyAqZW5naW5lKQoreworCXN0cnVjdCBpbnRlbF9ndCAqZ3QgPSBlbmdpbmUtPmd0
OworCWJvb2wgc3VjY2VzcyA9IGZhbHNlOworCisJaWYgKCFpbnRlbF9oYXNfcmVzZXRfZW5naW5l
KGd0KSkKKwkJcmV0dXJuIGZhbHNlOworCisJaWYgKCF0ZXN0X2FuZF9zZXRfYml0KEk5MTVfUkVT
RVRfRU5HSU5FICsgZW5naW5lLT5pZCwKKwkJCSAgICAgICZndC0+cmVzZXQuZmxhZ3MpKSB7CisJ
CXN1Y2Nlc3MgPSBpbnRlbF9lbmdpbmVfcmVzZXQoZW5naW5lLCBOVUxMKSA9PSAwOworCQljbGVh
cl9hbmRfd2FrZV91cF9iaXQoSTkxNV9SRVNFVF9FTkdJTkUgKyBlbmdpbmUtPmlkLAorCQkJCSAg
ICAgICZndC0+cmVzZXQuZmxhZ3MpOworCX0KKworCXJldHVybiBzdWNjZXNzOworfQorCitzdGF0
aWMgdm9pZCBfX3Jlc2V0X2NvbnRleHQoc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCwKKwkJ
CSAgICBzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUpCit7CisJaW50ZWxfZ3RfaGFuZGxl
X2Vycm9yKGVuZ2luZS0+Z3QsIGVuZ2luZS0+bWFzaywgMCwKKwkJCSAgICAgICJjb250ZXh0IGNs
b3N1cmUgaW4gJXMiLCBjdHgtPm5hbWUpOworfQorCitzdGF0aWMgYm9vbCBfX2NhbmNlbF9lbmdp
bmUoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lKQoreworCS8qCisJICogU2VuZCBhICJo
aWdoIHByaW9yaXR5IHB1bHNlIiBkb3duIHRoZSBlbmdpbmUgdG8gY2F1c2UgdGhlCisJICogY3Vy
cmVudCByZXF1ZXN0IHRvIGJlIG1vbWVudGFyaWx5IHByZWVtcHRlZC4gKElmIGl0IGZhaWxzIHRv
CisJICogYmUgcHJlZW1wdGVkLCBpdCB3aWxsIGJlIHJlc2V0KS4gQXMgd2UgaGF2ZSBtYXJrZWQg
b3VyIGNvbnRleHQKKwkgKiBhcyBiYW5uZWQsIGFueSBpbmNvbXBsZXRlIHJlcXVlc3QsIGluY2x1
ZGluZyBhbnkgcnVubmluZywgd2lsbAorCSAqIGJlIHNraXBwZWQgZm9sbG93aW5nIHRoZSBwcmVl
bXB0aW9uLgorCSAqLworCWlmIChDT05GSUdfRFJNX0k5MTVfUFJFRU1QVF9USU1FT1VUICYmICFp
bnRlbF9lbmdpbmVfcHVsc2UoZW5naW5lKSkKKwkJcmV0dXJuIHRydWU7CisKKwkvKiBJZiB3ZSBh
cmUgdW5hYmxlIHRvIHNlbmQgYSBwdWxzZSwgdHJ5IHJlc3NldGluZyB0aGlzIGVuZ2luZS4gKi8K
KwlyZXR1cm4gX19yZXNldF9lbmdpbmUoZW5naW5lKTsKK30KKworc3RhdGljIHN0cnVjdCBpbnRl
bF9lbmdpbmVfY3MgKgorYWN0aXZlX2VuZ2luZShzdHJ1Y3QgZG1hX2ZlbmNlICpmZW5jZSwgc3Ry
dWN0IGludGVsX2NvbnRleHQgKmNlKQoreworCXN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxID0gdG9f
cmVxdWVzdChmZW5jZSk7CisJc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lLCAqbG9ja2Vk
OworCisJLyoKKwkgKiBTZXJpYWxpc2Ugd2l0aCBfX2k5MTVfcmVxdWVzdF9zdWJtaXQoKSBzbyB0
aGF0IGl0IHNlZXMKKwkgKiBpcy1iYW5uZWQ/LCBvciB3ZSBrbm93IHRoZSByZXF1ZXN0IGlzIGFs
cmVhZHkgaW5mbGlnaHQuCisJICovCisJbG9ja2VkID0gUkVBRF9PTkNFKHJxLT5lbmdpbmUpOwor
CXNwaW5fbG9ja19pcnEoJmxvY2tlZC0+YWN0aXZlLmxvY2spOworCXdoaWxlICh1bmxpa2VseShs
b2NrZWQgIT0gKGVuZ2luZSA9IFJFQURfT05DRShycS0+ZW5naW5lKSkpKSB7CisJCXNwaW5fdW5s
b2NrKCZsb2NrZWQtPmFjdGl2ZS5sb2NrKTsKKwkJc3Bpbl9sb2NrKCZlbmdpbmUtPmFjdGl2ZS5s
b2NrKTsKKwkJbG9ja2VkID0gZW5naW5lOworCX0KKworCWVuZ2luZSA9IE5VTEw7CisJaWYgKGk5
MTVfcmVxdWVzdF9pc19hY3RpdmUocnEpICYmICFycS0+ZmVuY2UuZXJyb3IpCisJCWVuZ2luZSA9
IHJxLT5lbmdpbmU7CisKKwlzcGluX3VubG9ja19pcnEoJmxvY2tlZC0+YWN0aXZlLmxvY2spOwor
CisJcmV0dXJuIGVuZ2luZTsKK30KKworc3RhdGljIHZvaWQga2lsbF9jb250ZXh0KHN0cnVjdCBp
OTE1X2dlbV9jb250ZXh0ICpjdHgpCit7CisJc3RydWN0IGk5MTVfZ2VtX2VuZ2luZXNfaXRlciBp
dDsKKwlzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2U7CisKKwkvKgorCSAqIElmIHdlIGFyZSBhbHJl
YWR5IGJhbm5lZCwgaXQgd2FzIGR1ZSB0byBhIGd1aWx0eSByZXF1ZXN0IGNhdXNpbmcKKwkgKiBh
IHJlc2V0IGFuZCB0aGUgZW50aXJlIGNvbnRleHQgYmVpbmcgZXZpY3RlZCBmcm9tIHRoZSBHUFUu
CisJICovCisJaWYgKGk5MTVfZ2VtX2NvbnRleHRfaXNfYmFubmVkKGN0eCkpCisJCXJldHVybjsK
KworCWk5MTVfZ2VtX2NvbnRleHRfc2V0X2Jhbm5lZChjdHgpOworCisJLyoKKwkgKiBNYXAgdGhl
IHVzZXIncyBlbmdpbmUgYmFjayB0byB0aGUgYWN0dWFsIGVuZ2luZXM7IG9uZSB2aXJ0dWFsCisJ
ICogZW5naW5lIHdpbGwgYmUgbWFwcGVkIHRvIG11bHRpcGxlIGVuZ2luZXMsIGFuZCB1c2luZyBj
dHgtPmVuZ2luZVtdCisJICogdGhlIHNhbWUgZW5naW5lIG1heSBiZSBoYXZlIG11bHRpcGxlIGlu
c3RhbmNlcyBpbiB0aGUgdXNlcidzIG1hcC4KKwkgKiBIb3dldmVyLCB3ZSBvbmx5IGNhcmUgYWJv
dXQgcGVuZGluZyByZXF1ZXN0cywgc28gb25seSBpbmNsdWRlCisJICogZW5naW5lcyBvbiB3aGlj
aCB0aGVyZSBhcmUgaW5jb21wbGV0ZSByZXF1ZXN0cy4KKwkgKi8KKwlmb3JfZWFjaF9nZW1fZW5n
aW5lKGNlLCBfX2NvbnRleHRfZW5naW5lc19zdGF0aWMoY3R4KSwgaXQpIHsKKwkJc3RydWN0IGlu
dGVsX2VuZ2luZV9jcyAqZW5naW5lOworCQlzdHJ1Y3QgZG1hX2ZlbmNlICpmZW5jZTsKKworCQlp
ZiAoIWNlLT50aW1lbGluZSkKKwkJCWNvbnRpbnVlOworCisJCWZlbmNlID0gaTkxNV9hY3RpdmVf
ZmVuY2VfZ2V0KCZjZS0+dGltZWxpbmUtPmxhc3RfcmVxdWVzdCk7CisJCWlmICghZmVuY2UpCisJ
CQljb250aW51ZTsKKworCQkvKiBDaGVjayB3aXRoIHRoZSBiYWNrZW5kIGlmIHRoZSByZXF1ZXN0
IGlzIHN0aWxsIGluZmxpZ2h0ICovCisJCWVuZ2luZSA9IGFjdGl2ZV9lbmdpbmUoZmVuY2UsIGNl
KTsKKworCQkvKiBGaXJzdCBhdHRlbXB0IHRvIGdyYWNlZnVsbHkgY2FuY2VsIHRoZSBjb250ZXh0
ICovCisJCWlmIChlbmdpbmUgJiYgIV9fY2FuY2VsX2VuZ2luZShlbmdpbmUpKQorCQkJLyoKKwkJ
CSAqIElmIHdlIGFyZSB1bmFibGUgdG8gc2VuZCBhIHByZWVtcHRpdmUgcHVsc2UgdG8gYnVtcAor
CQkJICogdGhlIGNvbnRleHQgZnJvbSB0aGUgR1BVLCB3ZSBoYXZlIHRvIHJlc29ydCB0byBhIGZ1
bGwKKwkJCSAqIHJlc2V0LiBXZSBob3BlIHRoZSBjb2xsYXRlcmFsIGRhbWFnZSBpcyB3b3J0aCBp
dC4KKwkJCSAqLworCQkJX19yZXNldF9jb250ZXh0KGN0eCwgZW5naW5lKTsKKworCQlkbWFfZmVu
Y2VfcHV0KGZlbmNlKTsKKwl9Cit9CisKIHN0YXRpYyB2b2lkIGNvbnRleHRfY2xvc2Uoc3RydWN0
IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCkKIHsKIAlzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2
bTsKQEAgLTI5MSw5ICs0MTQsNDcgQEAgc3RhdGljIHZvaWQgY29udGV4dF9jbG9zZShzdHJ1Y3Qg
aTkxNV9nZW1fY29udGV4dCAqY3R4KQogCWx1dF9jbG9zZShjdHgpOwogCiAJbXV0ZXhfdW5sb2Nr
KCZjdHgtPm11dGV4KTsKKworCS8qCisJICogSWYgdGhlIHVzZXIgaGFzIGRpc2FibGVkIGhhbmdj
aGVja2luZywgd2UgY2FuIG5vdCBiZSBzdXJlIHRoYXQKKwkgKiB0aGUgYmF0Y2hlcyB3aWxsIGV2
ZXIgY29tcGxldGUgYWZ0ZXIgdGhlIGNvbnRleHQgaXMgY2xvc2VkLAorCSAqIGtlZXBpbmcgdGhl
IGNvbnRleHQgYW5kIGFsbCByZXNvdXJjZXMgcGlubmVkIGZvcmV2ZXIuIFNvIGluIHRoaXMKKwkg
KiBjYXNlIHdlIG9wdCB0byBmb3JjaWJseSBraWxsIG9mZiBhbGwgcmVtYWluaW5nIHJlcXVlc3Rz
IG9uCisJICogY29udGV4dCBjbG9zZS4KKwkgKi8KKwlpZiAoIWk5MTVfZ2VtX2NvbnRleHRfaXNf
cGVyc2lzdGVudChjdHgpIHx8CisJICAgICFpOTE1X21vZHBhcmFtcy5lbmFibGVfaGFuZ2NoZWNr
KQorCQlraWxsX2NvbnRleHQoY3R4KTsKKwogCWk5MTVfZ2VtX2NvbnRleHRfcHV0KGN0eCk7CiB9
CiAKK3N0YXRpYyBpbnQgX19jb250ZXh0X3NldF9wZXJzaXN0ZW5jZShzdHJ1Y3QgaTkxNV9nZW1f
Y29udGV4dCAqY3R4LCBib29sIHN0YXRlKQoreworCWlmIChpOTE1X2dlbV9jb250ZXh0X2lzX3Bl
cnNpc3RlbnQoY3R4KSA9PSBzdGF0ZSkKKwkJcmV0dXJuIDA7CisKKwlpZiAoc3RhdGUpIHsKKwkJ
LyoKKwkJICogT25seSBjb250ZXh0cyB0aGF0IGFyZSBzaG9ydC1saXZlZCBbdGhhdCB3aWxsIGV4
cGlyZSBvciBiZQorCQkgKiByZXNldF0gYXJlIGFsbG93ZWQgdG8gc3Vydml2ZSBwYXN0IHRlcm1p
bmF0aW9uLiBXZSByZXF1aXJlCisJCSAqIGhhbmdjaGVjayB0byBlbnN1cmUgdGhhdCB0aGUgcGVy
c2lzdGVudCByZXF1ZXN0cyBhcmUgaGVhbHRoeS4KKwkJICovCisJCWlmICghaTkxNV9tb2RwYXJh
bXMuZW5hYmxlX2hhbmdjaGVjaykKKwkJCXJldHVybiAtRUlOVkFMOworCisJCWk5MTVfZ2VtX2Nv
bnRleHRfc2V0X3BlcnNpc3RlbmNlKGN0eCk7CisJfSBlbHNlIHsKKwkJLyogVG8gY2FuY2VsIGEg
Y29udGV4dCB3ZSB1c2UgInByZWVtcHQtdG8taWRsZSIgKi8KKwkJaWYgKCEoY3R4LT5pOTE1LT5j
YXBzLnNjaGVkdWxlciAmIEk5MTVfU0NIRURVTEVSX0NBUF9QUkVFTVBUSU9OKSkKKwkJCXJldHVy
biAtRU5PREVWOworCisJCWk5MTVfZ2VtX2NvbnRleHRfY2xlYXJfcGVyc2lzdGVuY2UoY3R4KTsK
Kwl9CisKKwlyZXR1cm4gMDsKK30KKwogc3RhdGljIHN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICoK
IF9fY3JlYXRlX2NvbnRleHQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCiB7CkBAIC0z
MjgsNiArNDg5LDcgQEAgX19jcmVhdGVfY29udGV4dChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAq
aTkxNSkKIAogCWk5MTVfZ2VtX2NvbnRleHRfc2V0X2Jhbm5hYmxlKGN0eCk7CiAJaTkxNV9nZW1f
Y29udGV4dF9zZXRfcmVjb3ZlcmFibGUoY3R4KTsKKwlfX2NvbnRleHRfc2V0X3BlcnNpc3RlbmNl
KGN0eCwgdHJ1ZSAvKiBjZ3JvdXAgaG9vaz8gKi8pOwogCiAJZm9yIChpID0gMDsgaSA8IEFSUkFZ
X1NJWkUoY3R4LT5oYW5nX3RpbWVzdGFtcCk7IGkrKykKIAkJY3R4LT5oYW5nX3RpbWVzdGFtcFtp
XSA9IGppZmZpZXMgLSBDT05URVhUX0ZBU1RfSEFOR19KSUZGSUVTOwpAQCAtNDg0LDYgKzY0Niw3
IEBAIGk5MTVfZ2VtX2NvbnRleHRfY3JlYXRlX2tlcm5lbChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0
ZSAqaTkxNSwgaW50IHByaW8pCiAJCXJldHVybiBjdHg7CiAKIAlpOTE1X2dlbV9jb250ZXh0X2Ns
ZWFyX2Jhbm5hYmxlKGN0eCk7CisJaTkxNV9nZW1fY29udGV4dF9zZXRfcGVyc2lzdGVuY2UoY3R4
KTsKIAljdHgtPnNjaGVkLnByaW9yaXR5ID0gSTkxNV9VU0VSX1BSSU9SSVRZKHByaW8pOwogCiAJ
R0VNX0JVR19PTighaTkxNV9nZW1fY29udGV4dF9pc19rZXJuZWwoY3R4KSk7CkBAIC0xNTk0LDYg
KzE3NTcsMTYgQEAgZ2V0X2VuZ2luZXMoc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCwKIAly
ZXR1cm4gZXJyOwogfQogCitzdGF0aWMgaW50CitzZXRfcGVyc2lzdGVuY2Uoc3RydWN0IGk5MTVf
Z2VtX2NvbnRleHQgKmN0eCwKKwkJY29uc3Qgc3RydWN0IGRybV9pOTE1X2dlbV9jb250ZXh0X3Bh
cmFtICphcmdzKQoreworCWlmIChhcmdzLT5zaXplKQorCQlyZXR1cm4gLUVJTlZBTDsKKworCXJl
dHVybiBfX2NvbnRleHRfc2V0X3BlcnNpc3RlbmNlKGN0eCwgYXJncy0+dmFsdWUpOworfQorCiBz
dGF0aWMgaW50IGN0eF9zZXRwYXJhbShzdHJ1Y3QgZHJtX2k5MTVfZmlsZV9wcml2YXRlICpmcHJp
diwKIAkJCXN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICpjdHgsCiAJCQlzdHJ1Y3QgZHJtX2k5MTVf
Z2VtX2NvbnRleHRfcGFyYW0gKmFyZ3MpCkBAIC0xNjcxLDYgKzE4NDQsMTAgQEAgc3RhdGljIGlu
dCBjdHhfc2V0cGFyYW0oc3RydWN0IGRybV9pOTE1X2ZpbGVfcHJpdmF0ZSAqZnByaXYsCiAJCXJl
dCA9IHNldF9lbmdpbmVzKGN0eCwgYXJncyk7CiAJCWJyZWFrOwogCisJY2FzZSBJOTE1X0NPTlRF
WFRfUEFSQU1fUEVSU0lTVEVOQ0U6CisJCXJldCA9IHNldF9wZXJzaXN0ZW5jZShjdHgsIGFyZ3Mp
OworCQlicmVhazsKKwogCWNhc2UgSTkxNV9DT05URVhUX1BBUkFNX0JBTl9QRVJJT0Q6CiAJZGVm
YXVsdDoKIAkJcmV0ID0gLUVJTlZBTDsKQEAgLTIxMjMsNiArMjMwMCwxMSBAQCBpbnQgaTkxNV9n
ZW1fY29udGV4dF9nZXRwYXJhbV9pb2N0bChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LCB2b2lkICpk
YXRhLAogCQlyZXQgPSBnZXRfZW5naW5lcyhjdHgsIGFyZ3MpOwogCQlicmVhazsKIAorCWNhc2Ug
STkxNV9DT05URVhUX1BBUkFNX1BFUlNJU1RFTkNFOgorCQlhcmdzLT5zaXplID0gMDsKKwkJYXJn
cy0+dmFsdWUgPSBpOTE1X2dlbV9jb250ZXh0X2lzX3BlcnNpc3RlbnQoY3R4KTsKKwkJYnJlYWs7
CisKIAljYXNlIEk5MTVfQ09OVEVYVF9QQVJBTV9CQU5fUEVSSU9EOgogCWRlZmF1bHQ6CiAJCXJl
dCA9IC1FSU5WQUw7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9n
ZW1fY29udGV4dC5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRleHQu
aAppbmRleCA5MjM0NTg2ODMwZDEuLjJlZWMwMzUzODJhMiAxMDA2NDQKLS0tIGEvZHJpdmVycy9n
cHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRleHQuaAorKysgYi9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9nZW0vaTkxNV9nZW1fY29udGV4dC5oCkBAIC03Niw2ICs3NiwyMSBAQCBzdGF0aWMgaW5s
aW5lIHZvaWQgaTkxNV9nZW1fY29udGV4dF9jbGVhcl9yZWNvdmVyYWJsZShzdHJ1Y3QgaTkxNV9n
ZW1fY29udGV4dCAqYwogCWNsZWFyX2JpdChVQ09OVEVYVF9SRUNPVkVSQUJMRSwgJmN0eC0+dXNl
cl9mbGFncyk7CiB9CiAKK3N0YXRpYyBpbmxpbmUgYm9vbCBpOTE1X2dlbV9jb250ZXh0X2lzX3Bl
cnNpc3RlbnQoY29uc3Qgc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCkKK3sKKwlyZXR1cm4g
dGVzdF9iaXQoVUNPTlRFWFRfUEVSU0lTVEVOQ0UsICZjdHgtPnVzZXJfZmxhZ3MpOworfQorCitz
dGF0aWMgaW5saW5lIHZvaWQgaTkxNV9nZW1fY29udGV4dF9zZXRfcGVyc2lzdGVuY2Uoc3RydWN0
IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCkKK3sKKwlzZXRfYml0KFVDT05URVhUX1BFUlNJU1RFTkNF
LCAmY3R4LT51c2VyX2ZsYWdzKTsKK30KKworc3RhdGljIGlubGluZSB2b2lkIGk5MTVfZ2VtX2Nv
bnRleHRfY2xlYXJfcGVyc2lzdGVuY2Uoc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCkKK3sK
KwljbGVhcl9iaXQoVUNPTlRFWFRfUEVSU0lTVEVOQ0UsICZjdHgtPnVzZXJfZmxhZ3MpOworfQor
CiBzdGF0aWMgaW5saW5lIGJvb2wgaTkxNV9nZW1fY29udGV4dF9pc19iYW5uZWQoY29uc3Qgc3Ry
dWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCkKIHsKIAlyZXR1cm4gdGVzdF9iaXQoQ09OVEVYVF9C
QU5ORUQsICZjdHgtPmZsYWdzKTsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dl
bS9pOTE1X2dlbV9jb250ZXh0X3R5cGVzLmggYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkx
NV9nZW1fY29udGV4dF90eXBlcy5oCmluZGV4IGFiOGUxMzY3ZGZjOC4uYTNlY2QxOWYyMzAzIDEw
MDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fY29udGV4dF90eXBl
cy5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jb250ZXh0X3R5cGVz
LmgKQEAgLTEzNyw2ICsxMzcsNyBAQCBzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCB7CiAjZGVmaW5l
IFVDT05URVhUX05PX0VSUk9SX0NBUFRVUkUJMQogI2RlZmluZSBVQ09OVEVYVF9CQU5OQUJMRQkJ
MgogI2RlZmluZSBVQ09OVEVYVF9SRUNPVkVSQUJMRQkJMworI2RlZmluZSBVQ09OVEVYVF9QRVJT
SVNURU5DRQkJNAogCiAJLyoqCiAJICogQGZsYWdzOiBzbWFsbCBzZXQgb2YgYm9vbGVhbnMKZGlm
ZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMvbW9ja19jb250ZXh0
LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vc2VsZnRlc3RzL21vY2tfY29udGV4dC5jCmlu
ZGV4IDc0ZGRkNjgyYzljZC4uMjliODk4NGYwZTQ3IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9nZW0vc2VsZnRlc3RzL21vY2tfY29udGV4dC5jCisrKyBiL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2dlbS9zZWxmdGVzdHMvbW9ja19jb250ZXh0LmMKQEAgLTIyLDYgKzIyLDggQEAgbW9j
a19jb250ZXh0KHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1LAogCUlOSVRfTElTVF9IRUFE
KCZjdHgtPmxpbmspOwogCWN0eC0+aTkxNSA9IGk5MTU7CiAKKwlpOTE1X2dlbV9jb250ZXh0X3Nl
dF9wZXJzaXN0ZW5jZShjdHgpOworCiAJbXV0ZXhfaW5pdCgmY3R4LT5lbmdpbmVzX211dGV4KTsK
IAllID0gZGVmYXVsdF9lbmdpbmVzKGN0eCk7CiAJaWYgKElTX0VSUihlKSkKZGlmZiAtLWdpdCBh
L2luY2x1ZGUvdWFwaS9kcm0vaTkxNV9kcm0uaCBiL2luY2x1ZGUvdWFwaS9kcm0vaTkxNV9kcm0u
aAppbmRleCAzMGM1NDIxNDQwMTYuLmViOWU3MDRkNzE3YSAxMDA2NDQKLS0tIGEvaW5jbHVkZS91
YXBpL2RybS9pOTE1X2RybS5oCisrKyBiL2luY2x1ZGUvdWFwaS9kcm0vaTkxNV9kcm0uaApAQCAt
MTU2NSw2ICsxNTY1LDIxIEBAIHN0cnVjdCBkcm1faTkxNV9nZW1fY29udGV4dF9wYXJhbSB7CiAg
KiAgIGk5MTVfY29udGV4dF9lbmdpbmVzX2JvbmQgKEk5MTVfQ09OVEVYVF9FTkdJTkVTX0VYVF9C
T05EKQogICovCiAjZGVmaW5lIEk5MTVfQ09OVEVYVF9QQVJBTV9FTkdJTkVTCTB4YQorCisvKgor
ICogSTkxNV9DT05URVhUX1BBUkFNX1BFUlNJU1RFTkNFOgorICoKKyAqIEFsbG93IHRoZSBjb250
ZXh0IGFuZCBhY3RpdmUgcmVuZGVyaW5nIHRvIHN1cnZpdmUgdGhlIHByb2Nlc3MgdW50aWwKKyAq
IGNvbXBsZXRpb24uIFBlcnNpc3RlbmNlIGFsbG93cyBmaXJlLWFuZC1mb3JnZXQgY2xpZW50cyB0
byBxdWV1ZSB1cCBhCisgKiBidW5jaCBvZiB3b3JrLCBoYW5kIHRoZSBvdXRwdXQgb3ZlciB0byBh
IGRpc3BsYXkgc2VydmVyIGFuZCB0aGUgcXVpdC4KKyAqIElmIHRoZSBjb250ZXh0IGlzIG5vdCBt
YXJrZWQgYXMgcGVyc2lzdGVudCwgdXBvbiBjbG9zaW5nIChlaXRoZXIgdmlhCisgKiBhbiBleHBs
aWNpdCBEUk1fSTkxNV9HRU1fQ09OVEVYVF9ERVNUUk9ZIG9yIGltcGxpY2l0bHkgZnJvbSBmaWxl
IGNsb3N1cmUKKyAqIG9yIHByb2Nlc3MgdGVybWluYXRpb24pLCB0aGUgY29udGV4dCBhbmQgYW55
IG91dHN0YW5kaW5nIHJlcXVlc3RzIHdpbGwgYmUKKyAqIGNhbmNlbGxlZCAoYW5kIGV4cG9ydGVk
IGZlbmNlcyBmb3IgY2FuY2VsbGVkIHJlcXVlc3RzIG1hcmtlZCBhcyAtRUlPKS4KKyAqCisgKiBC
eSBkZWZhdWx0LCBuZXcgY29udGV4dHMgYWxsb3cgcGVyc2lzdGVuY2UuCisgKi8KKyNkZWZpbmUg
STkxNV9DT05URVhUX1BBUkFNX1BFUlNJU1RFTkNFCTB4YgogLyogTXVzdCBiZSBrZXB0IGNvbXBh
Y3QgLS0gbm8gaG9sZXMgYW5kIHdlbGwgZG9jdW1lbnRlZCAqLwogCiAJX191NjQgdmFsdWU7Ci0t
IAoyLjIzLjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
CkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpo
dHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWdmeA==

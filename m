Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 439B32C3E16
	for <lists+intel-gfx@lfdr.de>; Wed, 25 Nov 2020 11:40:56 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 258506E8F9;
	Wed, 25 Nov 2020 10:40:35 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mblankhorst.nl (mblankhorst.nl
 [IPv6:2a02:2308::216:3eff:fe92:dfa3])
 by gabe.freedesktop.org (Postfix) with ESMTPS id DA5776E900
 for <intel-gfx@lists.freedesktop.org>; Wed, 25 Nov 2020 10:40:26 +0000 (UTC)
From: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
To: intel-gfx@lists.freedesktop.org
Date: Wed, 25 Nov 2020 11:39:26 +0100
Message-Id: <20201125104011.606641-19-maarten.lankhorst@linux.intel.com>
X-Mailer: git-send-email 2.29.2.222.g5d2a92d10f8
In-Reply-To: <20201125104011.606641-1-maarten.lankhorst@linux.intel.com>
References: <20201125104011.606641-1-maarten.lankhorst@linux.intel.com>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v5 18/63] drm/i915: Populate logical context
 during first pin.
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: =?UTF-8?q?Thomas=20Hellstr=C3=B6m?= <thomas.hellstrom@linux.intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

VGhpcyBhbGxvd3MgdXMgdG8gcmVtb3ZlIHBpbl9tYXAgZnJvbSBzdGF0ZSBhbGxvY2F0aW9uLCB3
aGljaCBzYXZlcwp1cyBhIGZldyByZXRyeSBsb29wcy4gV2Ugd29uJ3QgbmVlZCB0aGlzIHVudGls
IGZpcnN0IHBpbiwgYW55d2F5LgoKU2lnbmVkLW9mZi1ieTogTWFhcnRlbiBMYW5raG9yc3QgPG1h
YXJ0ZW4ubGFua2hvcnN0QGxpbnV4LmludGVsLmNvbT4KUmV2aWV3ZWQtYnk6IFRob21hcyBIZWxs
c3Ryw7ZtIDx0aG9tYXMuaGVsbHN0cm9tQGxpbnV4LmludGVsLmNvbT4KLS0tCiBkcml2ZXJzL2dw
dS9kcm0vaTkxNS9ndC9pbnRlbF9jb250ZXh0X3R5cGVzLmggfCAgMTMgKystCiBkcml2ZXJzL2dw
dS9kcm0vaTkxNS9ndC9pbnRlbF9scmMuYyAgICAgICAgICAgfCAxMDcgKysrKysrKysrLS0tLS0t
LS0tCiAyIGZpbGVzIGNoYW5nZWQsIDYyIGluc2VydGlvbnMoKyksIDU4IGRlbGV0aW9ucygtKQoK
ZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2NvbnRleHRfdHlwZXMu
aCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2NvbnRleHRfdHlwZXMuaAppbmRleCA1
NTJjYjU3YTJlOGMuLmJlYmY1Mjg2ODU2MyAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ3QvaW50ZWxfY29udGV4dF90eXBlcy5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0
L2ludGVsX2NvbnRleHRfdHlwZXMuaApAQCAtNjQsMTIgKzY0LDEzIEBAIHN0cnVjdCBpbnRlbF9j
b250ZXh0IHsKIAl1bnNpZ25lZCBsb25nIGZsYWdzOwogI2RlZmluZSBDT05URVhUX0JBUlJJRVJf
QklUCQkwCiAjZGVmaW5lIENPTlRFWFRfQUxMT0NfQklUCQkxCi0jZGVmaW5lIENPTlRFWFRfVkFM
SURfQklUCQkyCi0jZGVmaW5lIENPTlRFWFRfQ0xPU0VEX0JJVAkJMwotI2RlZmluZSBDT05URVhU
X1VTRV9TRU1BUEhPUkVTCQk0Ci0jZGVmaW5lIENPTlRFWFRfQkFOTkVECQkJNQotI2RlZmluZSBD
T05URVhUX0ZPUkNFX1NJTkdMRV9TVUJNSVNTSU9OCTYKLSNkZWZpbmUgQ09OVEVYVF9OT1BSRUVN
UFQJCTcKKyNkZWZpbmUgQ09OVEVYVF9JTklUX0JJVAkJMgorI2RlZmluZSBDT05URVhUX1ZBTElE
X0JJVAkJMworI2RlZmluZSBDT05URVhUX0NMT1NFRF9CSVQJCTQKKyNkZWZpbmUgQ09OVEVYVF9V
U0VfU0VNQVBIT1JFUwkJNQorI2RlZmluZSBDT05URVhUX0JBTk5FRAkJCTYKKyNkZWZpbmUgQ09O
VEVYVF9GT1JDRV9TSU5HTEVfU1VCTUlTU0lPTgk3CisjZGVmaW5lIENPTlRFWFRfTk9QUkVFTVBU
CQk4CiAKIAl1MzIgKmxyY19yZWdfc3RhdGU7CiAJdW5pb24gewpkaWZmIC0tZ2l0IGEvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9p
bnRlbF9scmMuYwppbmRleCBjNWM1MGVlODM1ZGQuLjgyMWY0MTlkMzEwOCAxMDA2NDQKLS0tIGEv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjLmMKKysrIGIvZHJpdmVycy9ncHUvZHJt
L2k5MTUvZ3QvaW50ZWxfbHJjLmMKQEAgLTM1MjQsOSArMzUyNCwzOSBAQCBfX2V4ZWNsaXN0c191
cGRhdGVfcmVnX3N0YXRlKGNvbnN0IHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSwKIAl9CiB9CiAK
K3N0YXRpYyB2b2lkIHBvcHVsYXRlX2xyX2NvbnRleHQoc3RydWN0IGludGVsX2NvbnRleHQgKmNl
LAorCQkJCXN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSwKKwkJCQl2b2lkICp2YWRkcikK
K3sKKwlib29sIGluaGliaXQgPSB0cnVlOworCXN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpj
dHhfb2JqID0gY2UtPnN0YXRlLT5vYmo7CisKKwlzZXRfcmVkem9uZSh2YWRkciwgZW5naW5lKTsK
KworCWlmIChlbmdpbmUtPmRlZmF1bHRfc3RhdGUpIHsKKwkJc2htZW1fcmVhZChlbmdpbmUtPmRl
ZmF1bHRfc3RhdGUsIDAsCisJCQkgICB2YWRkciwgZW5naW5lLT5jb250ZXh0X3NpemUpOworCQlf
X3NldF9iaXQoQ09OVEVYVF9WQUxJRF9CSVQsICZjZS0+ZmxhZ3MpOworCQlpbmhpYml0ID0gZmFs
c2U7CisJfQorCisJLyogQ2xlYXIgdGhlIHBwSFdTUCAoaW5jLiBwZXItY29udGV4dCBjb3VudGVy
cykgKi8KKwltZW1zZXQodmFkZHIsIDAsIFBBR0VfU0laRSk7CisKKwkvKgorCSAqIFRoZSBzZWNv
bmQgcGFnZSBvZiB0aGUgY29udGV4dCBvYmplY3QgY29udGFpbnMgc29tZSByZWdpc3RlcnMgd2hp
Y2gKKwkgKiBtdXN0IGJlIHNldCB1cCBwcmlvciB0byB0aGUgZmlyc3QgZXhlY3V0aW9uLgorCSAq
LworCWV4ZWNsaXN0c19pbml0X3JlZ19zdGF0ZSh2YWRkciArIExSQ19TVEFURV9PRkZTRVQsCisJ
CQkJIGNlLCBlbmdpbmUsIGNlLT5yaW5nLCBpbmhpYml0KTsKKworCV9faTkxNV9nZW1fb2JqZWN0
X2ZsdXNoX21hcChjdHhfb2JqLCAwLCBlbmdpbmUtPmNvbnRleHRfc2l6ZSk7Cit9CisKIHN0YXRp
YyBpbnQKLWV4ZWNsaXN0c19jb250ZXh0X3ByZV9waW4oc3RydWN0IGludGVsX2NvbnRleHQgKmNl
LAotCQkJICBzdHJ1Y3QgaTkxNV9nZW1fd3dfY3R4ICp3dywgdm9pZCAqKnZhZGRyKQorX19leGVj
bGlzdHNfY29udGV4dF9wcmVfcGluKHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSwKKwkJCSAgICBz
dHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUsCisJCQkgICAgc3RydWN0IGk5MTVfZ2VtX3d3
X2N0eCAqd3csIHZvaWQgKip2YWRkcikKIHsKIAlHRU1fQlVHX09OKCFjZS0+c3RhdGUpOwogCUdF
TV9CVUdfT04oIWk5MTVfdm1hX2lzX3Bpbm5lZChjZS0+c3RhdGUpKTsKQEAgLTM1MzQsOCArMzU2
NCwyMCBAQCBleGVjbGlzdHNfY29udGV4dF9wcmVfcGluKHN0cnVjdCBpbnRlbF9jb250ZXh0ICpj
ZSwKIAkqdmFkZHIgPSBpOTE1X2dlbV9vYmplY3RfcGluX21hcChjZS0+c3RhdGUtPm9iaiwKIAkJ
CQkJaTkxNV9jb2hlcmVudF9tYXBfdHlwZShjZS0+ZW5naW5lLT5pOTE1KSB8CiAJCQkJCUk5MTVf
TUFQX09WRVJSSURFKTsKKwlpZiAoSVNfRVJSKCp2YWRkcikpCisJCXJldHVybiBQVFJfRVJSKCp2
YWRkcik7CisKKwlpZiAoIV9fdGVzdF9hbmRfc2V0X2JpdChDT05URVhUX0lOSVRfQklULCAmY2Ut
PmZsYWdzKSkKKwkJcG9wdWxhdGVfbHJfY29udGV4dChjZSwgZW5naW5lLCAqdmFkZHIpOworCisJ
cmV0dXJuIDA7Cit9CiAKLQlyZXR1cm4gUFRSX0VSUl9PUl9aRVJPKCp2YWRkcik7CitzdGF0aWMg
aW50CitleGVjbGlzdHNfY29udGV4dF9wcmVfcGluKHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSwK
KwkJCSAgc3RydWN0IGk5MTVfZ2VtX3d3X2N0eCAqd3csIHZvaWQgKip2YWRkcikKK3sKKwlyZXR1
cm4gX19leGVjbGlzdHNfY29udGV4dF9wcmVfcGluKGNlLCBjZS0+ZW5naW5lLCB3dywgdmFkZHIp
OwogfQogCiBzdGF0aWMgaW50CkBAIC01MzQzLDQ1ICs1Mzg1LDYgQEAgc3RhdGljIHZvaWQgZXhl
Y2xpc3RzX2luaXRfcmVnX3N0YXRlKHUzMiAqcmVncywKIAlfX3Jlc2V0X3N0b3BfcmluZyhyZWdz
LCBlbmdpbmUpOwogfQogCi1zdGF0aWMgaW50Ci1wb3B1bGF0ZV9scl9jb250ZXh0KHN0cnVjdCBp
bnRlbF9jb250ZXh0ICpjZSwKLQkJICAgIHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpjdHhf
b2JqLAotCQkgICAgc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lLAotCQkgICAgc3RydWN0
IGludGVsX3JpbmcgKnJpbmcpCi17Ci0JYm9vbCBpbmhpYml0ID0gdHJ1ZTsKLQl2b2lkICp2YWRk
cjsKLQotCXZhZGRyID0gaTkxNV9nZW1fb2JqZWN0X3Bpbl9tYXAoY3R4X29iaiwgSTkxNV9NQVBf
V0IpOwotCWlmIChJU19FUlIodmFkZHIpKSB7Ci0JCWRybV9kYmcoJmVuZ2luZS0+aTkxNS0+ZHJt
LCAiQ291bGQgbm90IG1hcCBvYmplY3QgcGFnZXMhXG4iKTsKLQkJcmV0dXJuIFBUUl9FUlIodmFk
ZHIpOwotCX0KLQotCXNldF9yZWR6b25lKHZhZGRyLCBlbmdpbmUpOwotCi0JaWYgKGVuZ2luZS0+
ZGVmYXVsdF9zdGF0ZSkgewotCQlzaG1lbV9yZWFkKGVuZ2luZS0+ZGVmYXVsdF9zdGF0ZSwgMCwK
LQkJCSAgIHZhZGRyLCBlbmdpbmUtPmNvbnRleHRfc2l6ZSk7Ci0JCV9fc2V0X2JpdChDT05URVhU
X1ZBTElEX0JJVCwgJmNlLT5mbGFncyk7Ci0JCWluaGliaXQgPSBmYWxzZTsKLQl9Ci0KLQkvKiBD
bGVhciB0aGUgcHBIV1NQIChpbmMuIHBlci1jb250ZXh0IGNvdW50ZXJzKSAqLwotCW1lbXNldCh2
YWRkciwgMCwgUEFHRV9TSVpFKTsKLQotCS8qCi0JICogVGhlIHNlY29uZCBwYWdlIG9mIHRoZSBj
b250ZXh0IG9iamVjdCBjb250YWlucyBzb21lIHJlZ2lzdGVycyB3aGljaAotCSAqIG11c3QgYmUg
c2V0IHVwIHByaW9yIHRvIHRoZSBmaXJzdCBleGVjdXRpb24uCi0JICovCi0JZXhlY2xpc3RzX2lu
aXRfcmVnX3N0YXRlKHZhZGRyICsgTFJDX1NUQVRFX09GRlNFVCwKLQkJCQkgY2UsIGVuZ2luZSwg
cmluZywgaW5oaWJpdCk7Ci0KLQlfX2k5MTVfZ2VtX29iamVjdF9mbHVzaF9tYXAoY3R4X29iaiwg
MCwgZW5naW5lLT5jb250ZXh0X3NpemUpOwotCWk5MTVfZ2VtX29iamVjdF91bnBpbl9tYXAoY3R4
X29iaik7Ci0JcmV0dXJuIDA7Ci19Ci0KIHN0YXRpYyBzdHJ1Y3QgaW50ZWxfdGltZWxpbmUgKnBp
bm5lZF90aW1lbGluZShzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UpCiB7CiAJc3RydWN0IGludGVs
X3RpbWVsaW5lICp0bCA9IGZldGNoX2FuZF96ZXJvKCZjZS0+dGltZWxpbmUpOwpAQCAtNTQ0NSwy
MCArNTQ0OCwxMSBAQCBzdGF0aWMgaW50IF9fZXhlY2xpc3RzX2NvbnRleHRfYWxsb2Moc3RydWN0
IGludGVsX2NvbnRleHQgKmNlLAogCQlnb3RvIGVycm9yX2RlcmVmX29iajsKIAl9CiAKLQlyZXQg
PSBwb3B1bGF0ZV9scl9jb250ZXh0KGNlLCBjdHhfb2JqLCBlbmdpbmUsIHJpbmcpOwotCWlmIChy
ZXQpIHsKLQkJZHJtX2RiZygmZW5naW5lLT5pOTE1LT5kcm0sCi0JCQkiRmFpbGVkIHRvIHBvcHVs
YXRlIExSQzogJWRcbiIsIHJldCk7Ci0JCWdvdG8gZXJyb3JfcmluZ19mcmVlOwotCX0KLQogCWNl
LT5yaW5nID0gcmluZzsKIAljZS0+c3RhdGUgPSB2bWE7CiAKIAlyZXR1cm4gMDsKIAotZXJyb3Jf
cmluZ19mcmVlOgotCWludGVsX3JpbmdfcHV0KHJpbmcpOwogZXJyb3JfZGVyZWZfb2JqOgogCWk5
MTVfZ2VtX29iamVjdF9wdXQoY3R4X29iaik7CiAJcmV0dXJuIHJldDsKQEAgLTU1ODIsNiArNTU3
NiwxNSBAQCBzdGF0aWMgaW50IHZpcnR1YWxfY29udGV4dF9hbGxvYyhzdHJ1Y3QgaW50ZWxfY29u
dGV4dCAqY2UpCiAJcmV0dXJuIF9fZXhlY2xpc3RzX2NvbnRleHRfYWxsb2MoY2UsIHZlLT5zaWJs
aW5nc1swXSk7CiB9CiAKK3N0YXRpYyBpbnQKK3ZpcnR1YWxfY29udGV4dF9wcmVfcGluKHN0cnVj
dCBpbnRlbF9jb250ZXh0ICpjZSwKKwkJCSAgc3RydWN0IGk5MTVfZ2VtX3d3X2N0eCAqd3csIHZv
aWQgKip2YWRkcikKK3sKKwlzdHJ1Y3QgdmlydHVhbF9lbmdpbmUgKnZlID0gY29udGFpbmVyX29m
KGNlLCB0eXBlb2YoKnZlKSwgY29udGV4dCk7CisKKwlyZXR1cm4gX19leGVjbGlzdHNfY29udGV4
dF9wcmVfcGluKGNlLCB2ZS0+c2libGluZ3NbMF0sIHd3LCB2YWRkcik7Cit9CisKIHN0YXRpYyBp
bnQgdmlydHVhbF9jb250ZXh0X3BpbihzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UsIHZvaWQgKnZh
ZGRyKQogewogCXN0cnVjdCB2aXJ0dWFsX2VuZ2luZSAqdmUgPSBjb250YWluZXJfb2YoY2UsIHR5
cGVvZigqdmUpLCBjb250ZXh0KTsKQEAgLTU2MTUsNyArNTYxOCw3IEBAIHN0YXRpYyB2b2lkIHZp
cnR1YWxfY29udGV4dF9leGl0KHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSkKIHN0YXRpYyBjb25z
dCBzdHJ1Y3QgaW50ZWxfY29udGV4dF9vcHMgdmlydHVhbF9jb250ZXh0X29wcyA9IHsKIAkuYWxs
b2MgPSB2aXJ0dWFsX2NvbnRleHRfYWxsb2MsCiAKLQkucHJlX3BpbiA9IGV4ZWNsaXN0c19jb250
ZXh0X3ByZV9waW4sCisJLnByZV9waW4gPSB2aXJ0dWFsX2NvbnRleHRfcHJlX3BpbiwKIAkucGlu
ID0gdmlydHVhbF9jb250ZXh0X3BpbiwKIAkudW5waW4gPSBleGVjbGlzdHNfY29udGV4dF91bnBp
biwKIAkucG9zdF91bnBpbiA9IGV4ZWNsaXN0c19jb250ZXh0X3Bvc3RfdW5waW4sCi0tIAoyLjI5
LjIuMjIyLmc1ZDJhOTJkMTBmOAoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRl
c2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8v
aW50ZWwtZ2Z4Cg==

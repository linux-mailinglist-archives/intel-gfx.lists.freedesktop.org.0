Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 020E5D139F
	for <lists+intel-gfx@lfdr.de>; Wed,  9 Oct 2019 18:09:28 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 997716EA04;
	Wed,  9 Oct 2019 16:09:25 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 37A906EA04
 for <intel-gfx@lists.freedesktop.org>; Wed,  9 Oct 2019 16:09:22 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18780263-1500050 
 for multiple; Wed, 09 Oct 2019 17:09:08 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Wed,  9 Oct 2019 17:09:06 +0100
Message-Id: <20191009160906.16195-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20191009100955.21477-2-chris@chris-wilson.co.uk>
References: <20191009100955.21477-2-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v2] drm/i915/gt: execlists->active is serialised
 by the tasklet
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

VGhlIGFjdGl2ZS9wZW5kaW5nIGV4ZWNsaXN0cyBpcyBubyBsb25nZXIgcHJvdGVjdGVkIGJ5IHRo
ZQplbmdpbmUtPmFjdGl2ZS5sb2NrLCBidXQgaXMgc2VyaWFsaXNlZCBieSB0aGUgdGFza2xldCBp
bnN0ZWFkLiBVcGRhdGUKdGhlIGxvY2tpbmcgYXJvdW5kIHRoZSBkZWJ1ZyBhbmQgc3RhdHMgdG8g
Zm9sbG93IHN1aXQuCgp2MjogbG9jYWxfYmhfZGlzYWJsZSgpIHRvIHByZXZlbnQgcmVjdXJzaW5n
IGludG8gdGhlIHRhc2tsZXQgaW4gY2FzZSB3ZQp0cmlnZ2VyIGEgc29mdGlycSAoVHZydGtvKQoK
Rml4ZXM6IGRmNDAzMDY5MDI5ZCAoImRybS9pOTE1L2V4ZWNsaXN0czogTGlmdCBwcm9jZXNzX2Nz
YigpIG91dCBvZiB0aGUgaXJxLW9mZiBzcGlubG9jayIpClNpZ25lZC1vZmYtYnk6IENocmlzIFdp
bHNvbiA8Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPgpDYzogTWlrYSBLdW9wcGFsYSA8bWlrYS5r
dW9wcGFsYUBsaW51eC5pbnRlbC5jb20+CkNjOiBUdnJ0a28gVXJzdWxpbiA8dHZydGtvLnVyc3Vs
aW5AaW50ZWwuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZS5o
ICAgIHwgMTQgKysrKysrKysrKysrKysKIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2Vu
Z2luZV9jcy5jIHwgMTYgKysrKysrKy0tLS0tLS0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkx
NV9nZW0uaCAgICAgICAgICAgfCAgNiArKysrKysKIDMgZmlsZXMgY2hhbmdlZCwgMjcgaW5zZXJ0
aW9ucygrKSwgOSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9ndC9pbnRlbF9lbmdpbmUuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2lu
ZS5oCmluZGV4IGQ2MjQ3NTJmMmE5Mi4uZmE3NzBkM2NhMjA4IDEwMDY0NAotLS0gYS9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmUuaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9ndC9pbnRlbF9lbmdpbmUuaApAQCAtMTM2LDYgKzEzNiwyMCBAQCBleGVjbGlzdHNfYWN0aXZl
KGNvbnN0IHN0cnVjdCBpbnRlbF9lbmdpbmVfZXhlY2xpc3RzICpleGVjbGlzdHMpCiAJcmV0dXJu
IFJFQURfT05DRSgqZXhlY2xpc3RzLT5hY3RpdmUpOwogfQogCitzdGF0aWMgaW5saW5lIHZvaWQK
K2V4ZWNsaXN0c19hY3RpdmVfbG9jayhzdHJ1Y3QgaW50ZWxfZW5naW5lX2V4ZWNsaXN0cyAqZXhl
Y2xpc3RzKQoreworCWxvY2FsX2JoX2Rpc2FibGUoKTsgLyogcHJldmVudCBsb2NhbCBzb2Z0aXJx
IGFuZCBsb2NrIHJlY3Vyc2lvbiAqLworCXRhc2tsZXRfbG9jaygmZXhlY2xpc3RzLT50YXNrbGV0
KTsKK30KKworc3RhdGljIGlubGluZSB2b2lkCitleGVjbGlzdHNfYWN0aXZlX3VubG9jayhzdHJ1
Y3QgaW50ZWxfZW5naW5lX2V4ZWNsaXN0cyAqZXhlY2xpc3RzKQoreworCXRhc2tsZXRfdW5sb2Nr
KCZleGVjbGlzdHMtPnRhc2tsZXQpOworCWxvY2FsX2JoX2VuYWJsZSgpOyAvKiByZXN0b3JlIHNv
ZnRpcnEsIGFuZCBraWNrIGtzb2Z0aXJxZCEgKi8KK30KKwogc3RydWN0IGk5MTVfcmVxdWVzdCAq
CiBleGVjbGlzdHNfdW53aW5kX2luY29tcGxldGVfcmVxdWVzdHMoc3RydWN0IGludGVsX2VuZ2lu
ZV9leGVjbGlzdHMgKmV4ZWNsaXN0cyk7CiAKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2d0L2ludGVsX2VuZ2luZV9jcy5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxf
ZW5naW5lX2NzLmMKaW5kZXggNWFhMTM3MWY2YTBmLi40NWI3MDhmYzRiNTIgMTAwNjQ0Ci0tLSBh
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZV9jcy5jCisrKyBiL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZV9jcy5jCkBAIC0xMjQ1LDkgKzEyNDUsNyBAQCBz
dGF0aWMgdm9pZCBpbnRlbF9lbmdpbmVfcHJpbnRfcmVnaXN0ZXJzKHN0cnVjdCBpbnRlbF9lbmdp
bmVfY3MgKmVuZ2luZSwKIAkJCQkJIHN0cnVjdCBkcm1fcHJpbnRlciAqbSkKIHsKIAlzdHJ1Y3Qg
ZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYgPSBlbmdpbmUtPmk5MTU7Ci0JY29uc3Qgc3RydWN0
IGludGVsX2VuZ2luZV9leGVjbGlzdHMgKiBjb25zdCBleGVjbGlzdHMgPQotCQkmZW5naW5lLT5l
eGVjbGlzdHM7Ci0JdW5zaWduZWQgbG9uZyBmbGFnczsKKwlzdHJ1Y3QgaW50ZWxfZW5naW5lX2V4
ZWNsaXN0cyAqIGNvbnN0IGV4ZWNsaXN0cyA9ICZlbmdpbmUtPmV4ZWNsaXN0czsKIAl1NjQgYWRk
cjsKIAogCWlmIChlbmdpbmUtPmlkID09IFJFTkRFUl9DTEFTUyAmJiBJU19HRU5fUkFOR0UoZGV2
X3ByaXYsIDQsIDcpKQpAQCAtMTMyOSw3ICsxMzI3LDcgQEAgc3RhdGljIHZvaWQgaW50ZWxfZW5n
aW5lX3ByaW50X3JlZ2lzdGVycyhzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUsCiAJCQkJ
ICAgaWR4LCBod3NbaWR4ICogMl0sIGh3c1tpZHggKiAyICsgMV0pOwogCQl9CiAKLQkJc3Bpbl9s
b2NrX2lycXNhdmUoJmVuZ2luZS0+YWN0aXZlLmxvY2ssIGZsYWdzKTsKKwkJZXhlY2xpc3RzX2Fj
dGl2ZV9sb2NrKGV4ZWNsaXN0cyk7CiAJCWZvciAocG9ydCA9IGV4ZWNsaXN0cy0+YWN0aXZlOyAo
cnEgPSAqcG9ydCk7IHBvcnQrKykgewogCQkJY2hhciBoZHJbODBdOwogCQkJaW50IGxlbjsKQEAg
LTEzNjcsNyArMTM2NSw3IEBAIHN0YXRpYyB2b2lkIGludGVsX2VuZ2luZV9wcmludF9yZWdpc3Rl
cnMoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lLAogCQkJaWYgKHRsKQogCQkJCWludGVs
X3RpbWVsaW5lX3B1dCh0bCk7CiAJCX0KLQkJc3Bpbl91bmxvY2tfaXJxcmVzdG9yZSgmZW5naW5l
LT5hY3RpdmUubG9jaywgZmxhZ3MpOworCQlleGVjbGlzdHNfYWN0aXZlX3VubG9jayhleGVjbGlz
dHMpOwogCX0gZWxzZSBpZiAoSU5URUxfR0VOKGRldl9wcml2KSA+IDYpIHsKIAkJZHJtX3ByaW50
ZihtLCAiXHRQUF9ESVJfQkFTRTogMHglMDh4XG4iLAogCQkJICAgRU5HSU5FX1JFQUQoZW5naW5l
LCBSSU5HX1BQX0RJUl9CQVNFKSk7CkBAIC0xNTA5LDggKzE1MDcsOCBAQCBpbnQgaW50ZWxfZW5h
YmxlX2VuZ2luZV9zdGF0cyhzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUpCiAJaWYgKCFp
bnRlbF9lbmdpbmVfc3VwcG9ydHNfc3RhdHMoZW5naW5lKSkKIAkJcmV0dXJuIC1FTk9ERVY7CiAK
LQlzcGluX2xvY2tfaXJxc2F2ZSgmZW5naW5lLT5hY3RpdmUubG9jaywgZmxhZ3MpOwotCXdyaXRl
X3NlcWxvY2soJmVuZ2luZS0+c3RhdHMubG9jayk7CisJZXhlY2xpc3RzX2FjdGl2ZV9sb2NrKGV4
ZWNsaXN0cyk7CisJd3JpdGVfc2VxbG9ja19pcnFzYXZlKCZlbmdpbmUtPnN0YXRzLmxvY2ssIGZs
YWdzKTsKIAogCWlmICh1bmxpa2VseShlbmdpbmUtPnN0YXRzLmVuYWJsZWQgPT0gfjApKSB7CiAJ
CWVyciA9IC1FQlVTWTsKQEAgLTE1MzgsOCArMTUzNiw4IEBAIGludCBpbnRlbF9lbmFibGVfZW5n
aW5lX3N0YXRzKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKIAl9CiAKIHVubG9jazoK
LQl3cml0ZV9zZXF1bmxvY2soJmVuZ2luZS0+c3RhdHMubG9jayk7Ci0Jc3Bpbl91bmxvY2tfaXJx
cmVzdG9yZSgmZW5naW5lLT5hY3RpdmUubG9jaywgZmxhZ3MpOworCXdyaXRlX3NlcXVubG9ja19p
cnFyZXN0b3JlKCZlbmdpbmUtPnN0YXRzLmxvY2ssIGZsYWdzKTsKKwlleGVjbGlzdHNfYWN0aXZl
X3VubG9jayhleGVjbGlzdHMpOwogCiAJcmV0dXJuIGVycjsKIH0KZGlmZiAtLWdpdCBhL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtLmggYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dl
bS5oCmluZGV4IDE2N2E3YjU2ZWQ1Yi4uNjc5NWYxZGFhM2Q1IDEwMDY0NAotLS0gYS9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9pOTE1X2dlbS5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVf
Z2VtLmgKQEAgLTc3LDYgKzc3LDEyIEBAIHN0cnVjdCBkcm1faTkxNV9wcml2YXRlOwogCiAjZGVm
aW5lIEk5MTVfR0VNX0lETEVfVElNRU9VVCAoSFogLyA1KQogCitzdGF0aWMgaW5saW5lIHZvaWQg
dGFza2xldF9sb2NrKHN0cnVjdCB0YXNrbGV0X3N0cnVjdCAqdCkKK3sKKwl3aGlsZSAoIXRhc2ts
ZXRfdHJ5bG9jayh0KSkKKwkJY3B1X3JlbGF4KCk7Cit9CisKIHN0YXRpYyBpbmxpbmUgdm9pZCBf
X3Rhc2tsZXRfZGlzYWJsZV9zeW5jX29uY2Uoc3RydWN0IHRhc2tsZXRfc3RydWN0ICp0KQogewog
CWlmICghYXRvbWljX2ZldGNoX2luYygmdC0+Y291bnQpKQotLSAKMi4yMy4wCgpfX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpJbnRlbC1nZnggbWFpbGluZyBs
aXN0CkludGVsLWdmeEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVz
a3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9pbnRlbC1nZng=

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id C56C5F5AE6
	for <lists+intel-gfx@lfdr.de>; Fri,  8 Nov 2019 23:30:34 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 9AEB96E0D8;
	Fri,  8 Nov 2019 22:30:32 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 248476E0D8
 for <intel-gfx@lists.freedesktop.org>; Fri,  8 Nov 2019 22:30:30 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 19135005-1500050 
 for multiple; Fri, 08 Nov 2019 22:30:25 +0000
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Fri,  8 Nov 2019 22:30:23 +0000
Message-Id: <20191108223023.8674-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.24.0
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH i-g-t] i915/gem_exec_schedule: Beware priority
 inversion from iova faults
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

Q2hlY2sgdGhhdCBpZiB0d28gY29udGV4dHMgKG9uZSBoaWdoIHByaW9yaXR5LCBvbmUgbG93KSBz
aGFyZSB0aGUgc2FtZQpidWZmZXIgdGhhdCBoYXMgdGFrZW4gYSBwYWdlIGZhdWx0IHRoYXQgd2Ug
ZG8gbm90IGNyZWF0ZSBhbiBpbXBsaWNpdApkZXBlbmRlbmN5IGJldHdlZW4gdGhlIHR3byBjb250
ZXh0cyBmb3Igc2VydmljaW5nIHRoYXQgcGFnZSBmYXVsdCBhbmQKYmluZGluZyB0aGUgdm1hLgoK
U2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28udWs+Ci0t
LQogdGVzdHMvaTkxNS9nZW1fZXhlY19zY2hlZHVsZS5jIHwgMTU0ICsrKysrKysrKysrKysrKysr
KysrKysrKysrKysrKysrLQogMSBmaWxlIGNoYW5nZWQsIDE1MSBpbnNlcnRpb25zKCspLCAzIGRl
bGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL3Rlc3RzL2k5MTUvZ2VtX2V4ZWNfc2NoZWR1bGUuYyBi
L3Rlc3RzL2k5MTUvZ2VtX2V4ZWNfc2NoZWR1bGUuYwppbmRleCAwYWY3YjRjNmQuLmE0Zjg5NGIx
OCAxMDA2NDQKLS0tIGEvdGVzdHMvaTkxNS9nZW1fZXhlY19zY2hlZHVsZS5jCisrKyBiL3Rlc3Rz
L2k5MTUvZ2VtX2V4ZWNfc2NoZWR1bGUuYwpAQCAtMTYzNywxMSArMTYzNywxNiBAQCBzdGF0aWMg
aW50IHVzZXJmYXVsdGZkKGludCBmbGFncykKIH0KIAogc3RydWN0IHVmZF90aHJlYWQgewotCXB0
aHJlYWRfdCB0aHJlYWQ7CiAJdWludDMyX3QgYmF0Y2g7CisJdWludDMyX3Qgc2NyYXRjaDsKIAl1
aW50MzJfdCAqcGFnZTsKIAl1bnNpZ25lZCBpbnQgZW5naW5lOworCXVuc2lnbmVkIGludCBmbGFn
czsKIAlpbnQgaTkxNTsKKworCXB0aHJlYWRfbXV0ZXhfdCBtdXRleDsKKwlwdGhyZWFkX2NvbmRf
dCBjb25kOworCWludCBjb3VudDsKIH07CiAKIHN0YXRpYyB1aW50MzJfdCBjcmVhdGVfdXNlcnB0
cihpbnQgaTkxNSwgdm9pZCAqcGFnZSkKQEAgLTE2ODUsNiArMTY5MCw3IEBAIHN0YXRpYyB2b2lk
IHRlc3RfcGlfdXNlcmZhdWx0KGludCBpOTE1LCB1bnNpZ25lZCBpbnQgZW5naW5lKQogCXN0cnVj
dCB1ZmZkaW9fY29weSBjb3B5OwogCXN0cnVjdCB1ZmZkX21zZyBtc2c7CiAJc3RydWN0IHVmZF90
aHJlYWQgdDsKKwlwdGhyZWFkX3QgdGhyZWFkOwogCWNoYXIgcG9pc29uWzQwOTZdOwogCWludCB1
ZmQ7CiAKQEAgLTE3MjYsNyArMTczMiw3IEBAIHN0YXRpYyB2b2lkIHRlc3RfcGlfdXNlcmZhdWx0
KGludCBpOTE1LCB1bnNpZ25lZCBpbnQgZW5naW5lKQogCWlndF9hc3NlcnQocmVnLmlvY3RscyA9
PSBVRkZEX0FQSV9SQU5HRV9JT0NUTFMpOwogCiAJLyogS2ljayBvZmYgdGhlIGxvdyBwcmlvcml0
eSBzdWJtaXNzaW9uICovCi0JaWd0X2Fzc2VydChwdGhyZWFkX2NyZWF0ZSgmdC50aHJlYWQsIE5V
TEwsIHVmZF90aHJlYWQsICZ0KSA9PSAwKTsKKwlpZ3RfYXNzZXJ0KHB0aHJlYWRfY3JlYXRlKCZ0
aHJlYWQsIE5VTEwsIHVmZF90aHJlYWQsICZ0KSA9PSAwKTsKIAogCS8qIFdhaXQgdW50aWwgdGhl
IGxvdyBwcmlvcml0eSB0aHJlYWQgaXMgYmxvY2tlZCBvbiBhIGZhdWx0ICovCiAJaWd0X2Fzc2Vy
dF9lcShyZWFkKHVmZCwgJm1zZywgc2l6ZW9mKG1zZykpLCBzaXplb2YobXNnKSk7CkBAIC0xNzcw
LDkgKzE3NzYsMTQ1IEBAIHN0YXRpYyB2b2lkIHRlc3RfcGlfdXNlcmZhdWx0KGludCBpOTE1LCB1
bnNpZ25lZCBpbnQgZW5naW5lKQogCWNvcHkubGVuID0gNDA5NjsKIAlkb19pb2N0bCh1ZmQsIFVG
RkRJT19DT1BZLCAmY29weSk7CiAKLQlwdGhyZWFkX2pvaW4odC50aHJlYWQsIE5VTEwpOworCXB0
aHJlYWRfam9pbih0aHJlYWQsIE5VTEwpOworCisJZ2VtX2Nsb3NlKGk5MTUsIHQuYmF0Y2gpOwor
CW11bm1hcCh0LnBhZ2UsIDQwOTYpOworCWNsb3NlKHVmZCk7Cit9CisKK3N0YXRpYyB2b2lkICpp
b3ZhX3RocmVhZChzdHJ1Y3QgdWZkX3RocmVhZCAqdCwgaW50IHByaW8pCit7CisJdWludDMyX3Qg
Y3R4ID0KKwkJZ2VtX2NvbnRleHRfY2xvbmUodC0+aTkxNSwgMCwKKwkJCQkgIHQtPmZsYWdzICYg
U0hBUkVEID8gSTkxNV9DT05URVhUX0NMT05FX1ZNIDogMCwKKwkJCQkgIDApOworCisJZ2VtX2Nv
bnRleHRfc2V0X3ByaW9yaXR5KHQtPmk5MTUsIGN0eCwgcHJpbyk7CisKKwlzdG9yZV9kd29yZF9w
bHVnKHQtPmk5MTUsIGN0eCwgdC0+ZW5naW5lLAorCQkJIHQtPnNjcmF0Y2gsIDAsIHByaW8sCisJ
CQkgdC0+YmF0Y2gsIDAgLyogbm8gd3JpdGUgaGF6YXJkISAqLyk7CisKKwlwdGhyZWFkX211dGV4
X2xvY2soJnQtPm11dGV4KTsKKwlpZiAoIS0tdC0+Y291bnQpCisJCXB0aHJlYWRfY29uZF9zaWdu
YWwoJnQtPmNvbmQpOworCXB0aHJlYWRfbXV0ZXhfdW5sb2NrKCZ0LT5tdXRleCk7CisKKwlnZW1f
Y29udGV4dF9kZXN0cm95KHQtPmk5MTUsIGN0eCk7CisJcmV0dXJuIE5VTEw7Cit9CisKK3N0YXRp
YyB2b2lkICppb3ZhX2xvdyh2b2lkICphcmcpCit7CisJcmV0dXJuIGlvdmFfdGhyZWFkKGFyZywg
TUlOX1BSSU8pOworfQorCitzdGF0aWMgdm9pZCAqaW92YV9oaWdoKHZvaWQgKmFyZykKK3sKKwly
ZXR1cm4gaW92YV90aHJlYWQoYXJnLCBNQVhfUFJJTyk7Cit9CisKK3N0YXRpYyB2b2lkIHRlc3Rf
cGlfaW92YShpbnQgaTkxNSwgdW5zaWduZWQgaW50IGVuZ2luZSwgdW5zaWduZWQgaW50IGZsYWdz
KQoreworCXN0cnVjdCB1ZmZkaW9fYXBpIGFwaSA9IHsgLmFwaSA9IFVGRkRfQVBJIH07CisJc3Ry
dWN0IHVmZmRpb19yZWdpc3RlciByZWc7CisJc3RydWN0IHVmZmRpb19jb3B5IGNvcHk7CisJc3Ry
dWN0IHVmZmRfbXNnIG1zZzsKKwlzdHJ1Y3QgdWZkX3RocmVhZCB0OworCWlndF9zcGluX3QgKnNw
aW47CisJcHRocmVhZF90IGhpLCBsbzsKKwljaGFyIHBvaXNvbls0MDk2XTsKKwl1aW50MzJfdCBy
ZXN1bHQ7CisJaW50IHVmZDsKKworCS8qCisJICogSW4gdGhpcyBzY2VuYXJpbywgd2UgaGF2ZSBh
IHBhaXIgb2YgY29udGVuZGluZyBjb250ZXh0cyB0aGF0CisJICogc2hhcmUgdGhlIHNhbWUgcmVz
b3VyY2UuIFRoYXQgcmVzb3VyY2UgaXMgc3R1Y2sgYmVoaW5kIGEgc2xvdworCSAqIHBhZ2UgZmF1
bHQgc3VjaCB0aGF0IG5laXRoZXIgY29udGV4dCBoYXMgaW1tZWRpYXRlIGFjY2VzcyB0byBpdC4K
KwkgKiBXaGF0IGlzIGV4cGVjdGVkIGlzIHRoYXQgYXMgc29vbiBhcyB0aGF0IHJlc291cmNlIGJl
Y29tZXMgYXZhaWxhYmxlLAorCSAqIHRoZSB0d28gY29udGV4dHMgYXJlIHF1ZXVlZCB3aXRoIHRo
ZSBoaWdoIHByaW9yaXR5IGNvbnRleHQgdGFraW5nCisJICogcHJlY2VkZW5jZS4gV2UgbmVlZCB0
byBjaGVjayB0aGF0IHdlIGRvIG5vdCBjcm9zcy1jb250YW1pbmF0ZQorCSAqIHRoZSB0d28gY29u
dGVudHMgd2l0aCB0aGUgcGFnZSBmYXVsdCBvbiB0aGUgc2hhcmVkIHJlc291cmNlCisJICogaW5p
dGlhdGVkIGJ5IHRoZSBsb3cgcHJpb3JpdHkgY29udGV4dC4gKENvbnNpZGVyIHRoYXQgdGhlIGxv
dworCSAqIHByaW9yaXR5IGNvbnRleHQgbWF5IGluc3RhbGwgYW4gZXhjbHVzaXZlIGZlbmNlIGZv
ciB0aGUgcGFnZQorCSAqIGZhdWx0LCB3aGljaCBpcyB0aGVuIHVzZWQgZm9yIHN0cmljdCBvcmRl
cmluZyBieSB0aGUgaGlnaCBwcmlvcml0eQorCSAqIGNvbnRleHQsIGNhdXNpbmcgYW4gdW53YW50
ZWQgaW1wbGljaXQgZGVwZW5kZW5jeSBiZXR3ZWVuIHRoZSB0d28KKwkgKiBhbmQgcHJvbW90aW5n
IHRoZSBsb3cgcHJpb3JpdHkgY29udGV4dCB0byBoaWdoLikKKwkgKgorCSAqIFNIQVJFRDogdGhl
IHR3byBjb250ZXh0cyBzaGFyZSBhIHZtLCBidXQgc3RpbGwgaGF2ZSBzZXBhcmF0ZQorCSAqIHRp
bWVsaW5lcyB0aGF0IHNob3VsZCBub3QgbWluZ2xlLgorCSAqLworCisJdWZkID0gdXNlcmZhdWx0
ZmQoMCk7CisJaWd0X3JlcXVpcmVfZih1ZmQgIT0gLTEsICJrZXJuZWwgc3VwcG9ydCBmb3IgdXNl
cmZhdWx0ZmRcbiIpOworCWlndF9yZXF1aXJlX2YoaW9jdGwodWZkLCBVRkZESU9fQVBJLCAmYXBp
KSA9PSAwICYmIGFwaS5hcGkgPT0gVUZGRF9BUEksCisJCSAgICAgICJ1c2VyZmF1bHRmZCBBUEkg
diVsbGQ6JWxsZFxuIiwgVUZGRF9BUEksIGFwaS5hcGkpOworCisJdC5pOTE1ID0gaTkxNTsKKwl0
LmVuZ2luZSA9IGVuZ2luZTsKKwl0LmZsYWdzID0gZmxhZ3M7CisKKwl0LmNvdW50ID0gMjsKKwlw
dGhyZWFkX2NvbmRfaW5pdCgmdC5jb25kLCBOVUxMKTsKKwlwdGhyZWFkX211dGV4X2luaXQoJnQu
bXV0ZXgsIE5VTEwpOworCisJdC5wYWdlID0gbW1hcChOVUxMLCA0MDk2LCBQUk9UX1dSSVRFLCBN
QVBfU0hBUkVEIHwgTUFQX0FOT04sIDAsIDApOworCWlndF9hc3NlcnQodC5wYWdlICE9IE1BUF9G
QUlMRUQpOworCXQuYmF0Y2ggPSBjcmVhdGVfdXNlcnB0cihpOTE1LCB0LnBhZ2UpOworCXQuc2Ny
YXRjaCA9IGdlbV9jcmVhdGUoaTkxNSwgNDA5Nik7CisKKwkvKiBSZWdpc3RlciBvdXIgZmF1bHQg
aGFuZGxlciBmb3IgdC5wYWdlICovCisJbWVtc2V0KCZyZWcsIDAsIHNpemVvZihyZWcpKTsKKwly
ZWcubW9kZSA9IFVGRkRJT19SRUdJU1RFUl9NT0RFX01JU1NJTkc7CisJcmVnLnJhbmdlLnN0YXJ0
ID0gdG9fdXNlcl9wb2ludGVyKHQucGFnZSk7CisJcmVnLnJhbmdlLmxlbiA9IDQwOTY7CisJZG9f
aW9jdGwodWZkLCBVRkZESU9fUkVHSVNURVIsICZyZWcpOworCWlndF9hc3NlcnQocmVnLmlvY3Rs
cyA9PSBVRkZEX0FQSV9SQU5HRV9JT0NUTFMpOworCisJLyogRmlsbCB0aGUgZW5naW5lIHdpdGgg
c3Bpbm5lcnM7IHRoZSBzdG9yZV9kd29yZCgpIGlzIHRvbyBxdWljayAqLworCXNwaW4gPSBpZ3Rf
c3Bpbl9uZXcoaTkxNSwgLmVuZ2luZSA9IGVuZ2luZSk7CisJZm9yIChpbnQgaSA9IDA7IGkgPCBN
QVhfRUxTUF9RTEVOOyBpKyspIHsKKwkJc3Bpbi0+ZXhlY2J1Zi5yc3ZkMSA9IGNyZWF0ZV9oaWdo
ZXN0X3ByaW9yaXR5KGk5MTUpOworCQlnZW1fZXhlY2J1ZihpOTE1LCAmc3Bpbi0+ZXhlY2J1Zik7
CisJCWdlbV9jb250ZXh0X2Rlc3Ryb3koaTkxNSwgc3Bpbi0+ZXhlY2J1Zi5yc3ZkMSk7CisJfQor
CisJLyogS2ljayBvZmYgdGhlIHN1Ym1pc3Npb24gdGhyZWFkcyAqLworCWlndF9hc3NlcnQocHRo
cmVhZF9jcmVhdGUoJmxvLCBOVUxMLCBpb3ZhX2xvdywgJnQpID09IDApOworCisJLyogV2FpdCB1
bnRpbCB0aGUgbG93IHByaW9yaXR5IHRocmVhZCBpcyBibG9ja2VkIG9uIHRoZSBmYXVsdCAqLwor
CWlndF9hc3NlcnRfZXEocmVhZCh1ZmQsICZtc2csIHNpemVvZihtc2cpKSwgc2l6ZW9mKG1zZykp
OworCWlndF9hc3NlcnRfZXEobXNnLmV2ZW50LCBVRkZEX0VWRU5UX1BBR0VGQVVMVCk7CisJaWd0
X2Fzc2VydChmcm9tX3VzZXJfcG9pbnRlcihtc2cuYXJnLnBhZ2VmYXVsdC5hZGRyZXNzKSA9PSB0
LnBhZ2UpOworCisJLyogVGhlbiByZWxlYXNlIGEgdmVyeSBzaW1pbGFyIHRocmVhZCwgYnV0IGF0
IGhpZ2ggcHJpb3JpdHkhICovCisJaWd0X2Fzc2VydChwdGhyZWFkX2NyZWF0ZSgmaGksIE5VTEws
IGlvdmFfaGlnaCwgJnQpID09IDApOworCisJLyogU2VydmljZSB0aGUgZmF1bHQ7IHJlbGVhc2lu
ZyB0aGUgbG93IHByaW9yaXR5IGNvbnRleHQgKi8KKwltZW1zZXQoJmNvcHksIDAsIHNpemVvZihj
b3B5KSk7CisJY29weS5kc3QgPSBtc2cuYXJnLnBhZ2VmYXVsdC5hZGRyZXNzOworCWNvcHkuc3Jj
ID0gdG9fdXNlcl9wb2ludGVyKG1lbXNldChwb2lzb24sIDB4YzUsIHNpemVvZihwb2lzb24pKSk7
CisJY29weS5sZW4gPSA0MDk2OworCWRvX2lvY3RsKHVmZCwgVUZGRElPX0NPUFksICZjb3B5KTsK
KworCS8qIFdhaXQgdW50aWwgYm90aCB0aHJlYWRzIGhhdmUgaGFkIGEgY2hhbmNlIHRvIHN1Ym1p
dCAqLworCXB0aHJlYWRfbXV0ZXhfbG9jaygmdC5tdXRleCk7CisJd2hpbGUgKHQuY291bnQpCisJ
CXB0aHJlYWRfY29uZF93YWl0KCZ0LmNvbmQsICZ0Lm11dGV4KTsKKwlwdGhyZWFkX211dGV4X3Vu
bG9jaygmdC5tdXRleCk7CisJaWd0X2RlYnVnZnNfZHVtcChpOTE1LCAiaTkxNV9lbmdpbmVfaW5m
byIpOworCWlndF9zcGluX2ZyZWUoaTkxNSwgc3Bpbik7CiAKKwlwdGhyZWFkX2pvaW4oaGksIE5V
TEwpOworCXB0aHJlYWRfam9pbihsbywgTlVMTCk7CiAJZ2VtX2Nsb3NlKGk5MTUsIHQuYmF0Y2gp
OworCisJZ2VtX3N5bmMoaTkxNSwgdC5zY3JhdGNoKTsgLyogd3JpdGUgaGF6YXJkIGxpZXMgKi8K
KwlnZW1fcmVhZChpOTE1LCB0LnNjcmF0Y2gsIDAsICZyZXN1bHQsIHNpemVvZihyZXN1bHQpKTsK
KwlpZ3RfYXNzZXJ0X2VxKHJlc3VsdCwgTUlOX1BSSU8pOworCWdlbV9jbG9zZShpOTE1LCB0LnNj
cmF0Y2gpOworCiAJbXVubWFwKHQucGFnZSwgNDA5Nik7CiAJY2xvc2UodWZkKTsKIH0KQEAgLTIw
MTksNiArMjE2MSwxMiBAQCBpZ3RfbWFpbgogCiAJCQkJaWd0X3N1YnRlc3RfZigicGktdXNlcmZh
dWx0LSVzIiwgZS0+bmFtZSkKIAkJCQkJdGVzdF9waV91c2VyZmF1bHQoZmQsIGViX3JpbmcoZSkp
OworCisJCQkJaWd0X3N1YnRlc3RfZigicGktZGlzdGluY3QtaW92YS0lcyIsIGUtPm5hbWUpCisJ
CQkJCXRlc3RfcGlfaW92YShmZCwgZWJfcmluZyhlKSwgMCk7CisKKwkJCQlpZ3Rfc3VidGVzdF9m
KCJwaS1zaGFyZWQtaW92YS0lcyIsIGUtPm5hbWUpCisJCQkJCXRlc3RfcGlfaW92YShmZCwgZWJf
cmluZyhlKSwgU0hBUkVEKTsKIAkJCX0KIAkJfQogCX0KLS0gCjIuMjQuMAoKX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlz
dApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0
b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 79F6C48083
	for <lists+intel-gfx@lfdr.de>; Mon, 17 Jun 2019 13:20:53 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 5450C88FFA;
	Mon, 17 Jun 2019 11:20:51 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 276DA88FFA
 for <intel-gfx@lists.freedesktop.org>; Mon, 17 Jun 2019 11:20:50 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 16926149-1500050 
 for multiple; Mon, 17 Jun 2019 12:20:36 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 17 Jun 2019 12:20:36 +0100
Message-Id: <20190617112036.9373-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v2] drm/i915/gtt: Serialise both updates to PDE
 and our shadow
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Mika Kuoppala <mika.kuoppala@intel.com>,
 Matthew Auld <matthew.auld@intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

Q3VycmVudGx5LCB3ZSBwZXJmb3JtIGEgbG9ja2VkIHVwZGF0ZSBvZiB0aGUgc2hhZG93IGVudHJ5
IHdoZW4KYWxsb2NhdGluZyBhIHBhZ2UgZGlyZWN0b3J5IGVudHJ5IHN1Y2ggdGhhdCBpZiB0d28g
Y2xpZW50cyBhcmUKY29uY3VycmVudGx5IGFsbG9jYXRpbmcgbmVpZ2hib3VyaW5nIHJhbmdlcyB3
ZSBvbmx5IGluc2VydCBvbmUgbmV3IGVudHJ5CmZvciB0aGUgcGFpciBvZiB0aGVtLiBIb3dldmVy
LCB3ZSBhbHNvIG5lZWQgdG8gc2VyaWFsaXNlIGJvdGggY2xpZW50cwp3cnQgdG8gdGhlIGFjdHVh
bCBlbnRyeSBpbiB0aGUgSFcgdGFibGUsIG9yIGVsc2Ugd2UgbWF5IGFsbG93IG9uZSBjbGllbnQK
b3IgZXZlbiBhIHRoaXJkIGNsaWVudCB0byBwcm9jZWVkIGFoZWFkIG9mIHRoZSBIVyB3cml0ZS4g
TXkgaGFuZHdhdmUKYmVmb3JlIHdhcyB0aGF0IHVuZGVyIHRoZSBfcGF0aG9sb2dpY2FsXyBjb25k
aXRpb24gd2Ugd291bGQgc2VlIHRoZQpzY3JhdGNoIGVudHJ5IGluc3RlYWQgb2YgdGhlIGV4cGVj
dGVkIGVudHJ5LCBjYXVzaW5nIGEgdGVtcG9yYXJ5CmdsaXRjaC4gVGhhdCBzdGFydmF0aW9uIGNv
bmRpdGlvbiB3aWxsIGV2ZW50dWFsbHkgc2hvdyB1cCBpbiBwcmFjdGljZSwgc28KZml4IGl0LgoK
VGhlIHJlYXNvbiBmb3IgdGhlIHByZXZpb3VzIGNoZWF0IHdhcyB0byBhdm9pZCBoYXZpbmcgdG8g
ZnJlZSB0aGUgZXh0cmEKYWxsb2NhdGlvbiB3aGlsZSB1bmRlciB0aGUgc3BpbmxvY2suIE5vdywg
d2Uga2VlcCB0aGUgZXh0cmEgZW50cnkKYWxsb2NhdGVkIHVudGlsIHRoZSBlbmQgaW5zdGVhZC4K
CnYyOiBGaXggZXJyb3IgcGF0aHMgZm9yIGdlbjYKCkZpeGVzOiAxZDFiNTQ5MGI5MWMgKCJkcm0v
aTkxNS9ndHQ6IFJlcGxhY2Ugc3RydWN0X211dGV4IHNlcmlhbGlzYXRpb24gZm9yIGFsbG9jYXRp
b24iKQpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNocmlzQGNocmlzLXdpbHNvbi5jby51
az4KQ2M6IE1hdHRoZXcgQXVsZCA8bWF0dGhldy5hdWxkQGludGVsLmNvbT4KQ2M6IE1pa2EgS3Vv
cHBhbGEgPG1pa2Eua3VvcHBhbGFAaW50ZWwuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1
L2k5MTVfZ2VtX2d0dC5jIHwgMTMwICsrKysrKysrKysrKysrKy0tLS0tLS0tLS0tLS0KIDEgZmls
ZSBjaGFuZ2VkLCA3MiBpbnNlcnRpb25zKCspLCA1OCBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQg
YS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuYyBiL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2k5MTVfZ2VtX2d0dC5jCmluZGV4IDAzOTJhNGM0YmI5Yi4uMDk4Nzc0OGQzMjdiIDEwMDY0
NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuYworKysgYi9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuYwpAQCAtMTM4Nyw4MiArMTM4Nyw4OCBAQCBzdGF0
aWMgaW50IGdlbjhfcHBndHRfYWxsb2NfcGQoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0s
CiAJCQkgICAgICAgc3RydWN0IGk5MTVfcGFnZV9kaXJlY3RvcnkgKnBkLAogCQkJICAgICAgIHU2
NCBzdGFydCwgdTY0IGxlbmd0aCkKIHsKKwlzdHJ1Y3QgaTkxNV9wYWdlX3RhYmxlICphbGxvYyA9
IE5VTEw7CiAJc3RydWN0IGk5MTVfcGFnZV90YWJsZSAqcHQ7CiAJdTY0IGZyb20gPSBzdGFydDsK
IAl1bnNpZ25lZCBpbnQgcGRlOworCWludCByZXQgPSAwOwogCiAJc3Bpbl9sb2NrKCZwZC0+bG9j
ayk7CiAJZ2VuOF9mb3JfZWFjaF9wZGUocHQsIHBkLCBzdGFydCwgbGVuZ3RoLCBwZGUpIHsKIAkJ
Y29uc3QgaW50IGNvdW50ID0gZ2VuOF9wdGVfY291bnQoc3RhcnQsIGxlbmd0aCk7CiAKIAkJaWYg
KHB0ID09IHZtLT5zY3JhdGNoX3B0KSB7Ci0JCQlzdHJ1Y3QgaTkxNV9wYWdlX3RhYmxlICpvbGQ7
Ci0KIAkJCXNwaW5fdW5sb2NrKCZwZC0+bG9jayk7CiAKLQkJCXB0ID0gYWxsb2NfcHQodm0pOwot
CQkJaWYgKElTX0VSUihwdCkpCisJCQlwdCA9IGZldGNoX2FuZF96ZXJvKCZhbGxvYyk7CisJCQlp
ZiAoIXB0KQorCQkJCXB0ID0gYWxsb2NfcHQodm0pOworCQkJaWYgKElTX0VSUihwdCkpIHsKKwkJ
CQlyZXQgPSBQVFJfRVJSKHB0KTsKIAkJCQlnb3RvIHVud2luZDsKKwkJCX0KIAogCQkJaWYgKGNv
dW50IDwgR0VOOF9QVEVTIHx8IGludGVsX3ZncHVfYWN0aXZlKHZtLT5pOTE1KSkKIAkJCQlnZW44
X2luaXRpYWxpemVfcHQodm0sIHB0KTsKIAotCQkJb2xkID0gY21weGNoZygmcGQtPnBhZ2VfdGFi
bGVbcGRlXSwgdm0tPnNjcmF0Y2hfcHQsIHB0KTsKLQkJCWlmIChvbGQgPT0gdm0tPnNjcmF0Y2hf
cHQpIHsKKwkJCXNwaW5fbG9jaygmcGQtPmxvY2spOworCQkJaWYgKHBkLT5wYWdlX3RhYmxlW3Bk
ZV0gPT0gdm0tPnNjcmF0Y2hfcHQpIHsKIAkJCQlnZW44X3BwZ3R0X3NldF9wZGUodm0sIHBkLCBw
dCwgcGRlKTsKKwkJCQlwZC0+cGFnZV90YWJsZVtwZGVdID0gcHQ7CiAJCQkJYXRvbWljX2luYygm
cGQtPnVzZWRfcGRlcyk7CiAJCQl9IGVsc2UgewotCQkJCWZyZWVfcHQodm0sIHB0KTsKLQkJCQlw
dCA9IG9sZDsKKwkJCQlhbGxvYyA9IHB0OworCQkJCXB0ID0gcGQtPnBhZ2VfdGFibGVbcGRlXTsK
IAkJCX0KLQotCQkJc3Bpbl9sb2NrKCZwZC0+bG9jayk7CiAJCX0KIAogCQlhdG9taWNfYWRkKGNv
dW50LCAmcHQtPnVzZWRfcHRlcyk7CiAJfQogCXNwaW5fdW5sb2NrKCZwZC0+bG9jayk7Ci0KLQly
ZXR1cm4gMDsKKwlnb3RvIG91dDsKIAogdW53aW5kOgogCWdlbjhfcHBndHRfY2xlYXJfcGQodm0s
IHBkLCBmcm9tLCBzdGFydCAtIGZyb20pOwotCXJldHVybiAtRU5PTUVNOworb3V0OgorCWlmIChh
bGxvYykKKwkJZnJlZV9wdCh2bSwgYWxsb2MpOworCXJldHVybiByZXQ7CiB9CiAKIHN0YXRpYyBp
bnQgZ2VuOF9wcGd0dF9hbGxvY19wZHAoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCiAJ
CQkJc3RydWN0IGk5MTVfcGFnZV9kaXJlY3RvcnlfcG9pbnRlciAqcGRwLAogCQkJCXU2NCBzdGFy
dCwgdTY0IGxlbmd0aCkKIHsKKwlzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeSAqYWxsb2MgPSBO
VUxMOwogCXN0cnVjdCBpOTE1X3BhZ2VfZGlyZWN0b3J5ICpwZDsKIAl1NjQgZnJvbSA9IHN0YXJ0
OwogCXVuc2lnbmVkIGludCBwZHBlOwotCWludCByZXQ7CisJaW50IHJldCA9IDA7CiAKIAlzcGlu
X2xvY2soJnBkcC0+bG9jayk7CiAJZ2VuOF9mb3JfZWFjaF9wZHBlKHBkLCBwZHAsIHN0YXJ0LCBs
ZW5ndGgsIHBkcGUpIHsKIAkJaWYgKHBkID09IHZtLT5zY3JhdGNoX3BkKSB7Ci0JCQlzdHJ1Y3Qg
aTkxNV9wYWdlX2RpcmVjdG9yeSAqb2xkOwotCiAJCQlzcGluX3VubG9jaygmcGRwLT5sb2NrKTsK
IAotCQkJcGQgPSBhbGxvY19wZCh2bSk7Ci0JCQlpZiAoSVNfRVJSKHBkKSkKKwkJCXBkID0gZmV0
Y2hfYW5kX3plcm8oJmFsbG9jKTsKKwkJCWlmICghcGQpCisJCQkJcGQgPSBhbGxvY19wZCh2bSk7
CisJCQlpZiAoSVNfRVJSKHBkKSkgeworCQkJCXJldCA9IFBUUl9FUlIocGQpOwogCQkJCWdvdG8g
dW53aW5kOworCQkJfQogCiAJCQlnZW44X2luaXRpYWxpemVfcGQodm0sIHBkKTsKIAotCQkJb2xk
ID0gY21weGNoZygmcGRwLT5wYWdlX2RpcmVjdG9yeVtwZHBlXSwKLQkJCQkgICAgICB2bS0+c2Ny
YXRjaF9wZCwgcGQpOwotCQkJaWYgKG9sZCA9PSB2bS0+c2NyYXRjaF9wZCkgeworCQkJc3Bpbl9s
b2NrKCZwZHAtPmxvY2spOworCQkJaWYgKHBkcC0+cGFnZV9kaXJlY3RvcnlbcGRwZV0gPT0gdm0t
PnNjcmF0Y2hfcGQpIHsKIAkJCQlnZW44X3BwZ3R0X3NldF9wZHBlKHZtLCBwZHAsIHBkLCBwZHBl
KTsKKwkJCQlwZHAtPnBhZ2VfZGlyZWN0b3J5W3BkcGVdID0gcGQ7CiAJCQkJYXRvbWljX2luYygm
cGRwLT51c2VkX3BkcGVzKTsKIAkJCX0gZWxzZSB7Ci0JCQkJZnJlZV9wZCh2bSwgcGQpOwotCQkJ
CXBkID0gb2xkOworCQkJCWFsbG9jID0gcGQ7CisJCQkJcGQgPSBwZHAtPnBhZ2VfZGlyZWN0b3J5
W3BkcGVdOwogCQkJfQotCi0JCQlzcGluX2xvY2soJnBkcC0+bG9jayk7CiAJCX0KIAkJYXRvbWlj
X2luYygmcGQtPnVzZWRfcGRlcyk7CiAJCXNwaW5fdW5sb2NrKCZwZHAtPmxvY2spOwpAQCAtMTQ3
NSw4ICsxNDgxLDcgQEAgc3RhdGljIGludCBnZW44X3BwZ3R0X2FsbG9jX3BkcChzdHJ1Y3QgaTkx
NV9hZGRyZXNzX3NwYWNlICp2bSwKIAkJYXRvbWljX2RlYygmcGQtPnVzZWRfcGRlcyk7CiAJfQog
CXNwaW5fdW5sb2NrKCZwZHAtPmxvY2spOwotCi0JcmV0dXJuIDA7CisJZ290byBvdXQ7CiAKIHVu
d2luZF9wZDoKIAlzcGluX2xvY2soJnBkcC0+bG9jayk7CkBAIC0xNDg5LDcgKzE0OTQsMTAgQEAg
c3RhdGljIGludCBnZW44X3BwZ3R0X2FsbG9jX3BkcChzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNl
ICp2bSwKIAlzcGluX3VubG9jaygmcGRwLT5sb2NrKTsKIHVud2luZDoKIAlnZW44X3BwZ3R0X2Ns
ZWFyX3BkcCh2bSwgcGRwLCBmcm9tLCBzdGFydCAtIGZyb20pOwotCXJldHVybiAtRU5PTUVNOwor
b3V0OgorCWlmIChhbGxvYykKKwkJZnJlZV9wZCh2bSwgYWxsb2MpOworCXJldHVybiByZXQ7CiB9
CiAKIHN0YXRpYyBpbnQgZ2VuOF9wcGd0dF9hbGxvY18zbHZsKHN0cnVjdCBpOTE1X2FkZHJlc3Nf
c3BhY2UgKnZtLApAQCAtMTUwNCwzMyArMTUxMiwzNSBAQCBzdGF0aWMgaW50IGdlbjhfcHBndHRf
YWxsb2NfNGx2bChzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKIHsKIAlzdHJ1Y3QgaTkx
NV9wcGd0dCAqcHBndHQgPSBpOTE1X3ZtX3RvX3BwZ3R0KHZtKTsKIAlzdHJ1Y3QgaTkxNV9wbWw0
ICpwbWw0ID0gJnBwZ3R0LT5wbWw0OworCXN0cnVjdCBpOTE1X3BhZ2VfZGlyZWN0b3J5X3BvaW50
ZXIgKmFsbG9jID0gTlVMTDsKIAlzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeV9wb2ludGVyICpw
ZHA7CiAJdTY0IGZyb20gPSBzdGFydDsKKwlpbnQgcmV0ID0gMDsKIAl1MzIgcG1sNGU7Ci0JaW50
IHJldDsKIAogCXNwaW5fbG9jaygmcG1sNC0+bG9jayk7CiAJZ2VuOF9mb3JfZWFjaF9wbWw0ZShw
ZHAsIHBtbDQsIHN0YXJ0LCBsZW5ndGgsIHBtbDRlKSB7CiAJCWlmIChwZHAgPT0gdm0tPnNjcmF0
Y2hfcGRwKSB7Ci0JCQlzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeV9wb2ludGVyICpvbGQ7Ci0K
IAkJCXNwaW5fdW5sb2NrKCZwbWw0LT5sb2NrKTsKIAotCQkJcGRwID0gYWxsb2NfcGRwKHZtKTsK
LQkJCWlmIChJU19FUlIocGRwKSkKKwkJCXBkcCA9IGZldGNoX2FuZF96ZXJvKCZhbGxvYyk7CisJ
CQlpZiAoIXBkcCkKKwkJCQlwZHAgPSBhbGxvY19wZHAodm0pOworCQkJaWYgKElTX0VSUihwZHAp
KSB7CisJCQkJcmV0ID0gUFRSX0VSUihwZHApOwogCQkJCWdvdG8gdW53aW5kOworCQkJfQogCiAJ
CQlnZW44X2luaXRpYWxpemVfcGRwKHZtLCBwZHApOwogCi0JCQlvbGQgPSBjbXB4Y2hnKCZwbWw0
LT5wZHBzW3BtbDRlXSwgdm0tPnNjcmF0Y2hfcGRwLCBwZHApOwotCQkJaWYgKG9sZCA9PSB2bS0+
c2NyYXRjaF9wZHApIHsKKwkJCXNwaW5fbG9jaygmcG1sNC0+bG9jayk7CisJCQlpZiAocG1sNC0+
cGRwc1twbWw0ZV0gPT0gdm0tPnNjcmF0Y2hfcGRwKSB7CiAJCQkJZ2VuOF9wcGd0dF9zZXRfcG1s
NGUocG1sNCwgcGRwLCBwbWw0ZSk7CisJCQkJcG1sNC0+cGRwc1twbWw0ZV0gPSBwZHA7CiAJCQl9
IGVsc2UgewotCQkJCWZyZWVfcGRwKHZtLCBwZHApOwotCQkJCXBkcCA9IG9sZDsKKwkJCQlhbGxv
YyA9IHBkcDsKKwkJCQlwZHAgPSBwbWw0LT5wZHBzW3BtbDRlXTsKIAkJCX0KLQotCQkJc3Bpbl9s
b2NrKCZwbWw0LT5sb2NrKTsKIAkJfQogCQlhdG9taWNfaW5jKCZwZHAtPnVzZWRfcGRwZXMpOwog
CQlzcGluX3VubG9jaygmcG1sNC0+bG9jayk7CkBAIC0xNTQzLDggKzE1NTMsNyBAQCBzdGF0aWMg
aW50IGdlbjhfcHBndHRfYWxsb2NfNGx2bChzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwK
IAkJYXRvbWljX2RlYygmcGRwLT51c2VkX3BkcGVzKTsKIAl9CiAJc3Bpbl91bmxvY2soJnBtbDQt
PmxvY2spOwotCi0JcmV0dXJuIDA7CisJZ290byBvdXQ7CiAKIHVud2luZF9wZHA6CiAJc3Bpbl9s
b2NrKCZwbWw0LT5sb2NrKTsKQEAgLTE1NTUsNyArMTU2NCwxMCBAQCBzdGF0aWMgaW50IGdlbjhf
cHBndHRfYWxsb2NfNGx2bChzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKIAlzcGluX3Vu
bG9jaygmcG1sNC0+bG9jayk7CiB1bndpbmQ6CiAJZ2VuOF9wcGd0dF9jbGVhcl80bHZsKHZtLCBm
cm9tLCBzdGFydCAtIGZyb20pOwotCXJldHVybiAtRU5PTUVNOworb3V0OgorCWlmIChhbGxvYykK
KwkJZnJlZV9wZHAodm0sIGFsbG9jKTsKKwlyZXR1cm4gcmV0OwogfQogCiBzdGF0aWMgaW50IGdl
bjhfcHJlYWxsb2NhdGVfdG9wX2xldmVsX3BkcChzdHJ1Y3QgaTkxNV9wcGd0dCAqcHBndHQpCkBA
IC0xODIwLDExICsxODMyLDEzIEBAIHN0YXRpYyBpbnQgZ2VuNl9hbGxvY192YV9yYW5nZShzdHJ1
Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKIAkJCSAgICAgICB1NjQgc3RhcnQsIHU2NCBsZW5n
dGgpCiB7CiAJc3RydWN0IGdlbjZfcHBndHQgKnBwZ3R0ID0gdG9fZ2VuNl9wcGd0dChpOTE1X3Zt
X3RvX3BwZ3R0KHZtKSk7CisJc3RydWN0IGk5MTVfcGFnZV90YWJsZSAqYWxsb2MgPSBOVUxMOwog
CXN0cnVjdCBpOTE1X3BhZ2VfdGFibGUgKnB0OwogCWludGVsX3dha2VyZWZfdCB3YWtlcmVmOwog
CXU2NCBmcm9tID0gc3RhcnQ7CiAJdW5zaWduZWQgaW50IHBkZTsKIAlib29sIGZsdXNoID0gZmFs
c2U7CisJaW50IHJldCA9IDA7CiAKIAl3YWtlcmVmID0gaW50ZWxfcnVudGltZV9wbV9nZXQoJnZt
LT5pOTE1LT5ydW50aW1lX3BtKTsKIApAQCAtMTgzMywxOSArMTg0NywyMCBAQCBzdGF0aWMgaW50
IGdlbjZfYWxsb2NfdmFfcmFuZ2Uoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCiAJCWNv
bnN0IHVuc2lnbmVkIGludCBjb3VudCA9IGdlbjZfcHRlX2NvdW50KHN0YXJ0LCBsZW5ndGgpOwog
CiAJCWlmIChwdCA9PSB2bS0+c2NyYXRjaF9wdCkgewotCQkJc3RydWN0IGk5MTVfcGFnZV90YWJs
ZSAqb2xkOwotCiAJCQlzcGluX3VubG9jaygmcHBndHQtPmJhc2UucGQubG9jayk7CiAKLQkJCXB0
ID0gYWxsb2NfcHQodm0pOwotCQkJaWYgKElTX0VSUihwdCkpCisJCQlwdCA9IGZldGNoX2FuZF96
ZXJvKCZhbGxvYyk7CisJCQlpZiAoIXB0KQorCQkJCXB0ID0gYWxsb2NfcHQodm0pOworCQkJaWYg
KElTX0VSUihwdCkpIHsKKwkJCQlyZXQgPSBQVFJfRVJSKHB0KTsKIAkJCQlnb3RvIHVud2luZF9v
dXQ7CisJCQl9CiAKIAkJCWdlbjZfaW5pdGlhbGl6ZV9wdCh2bSwgcHQpOwogCi0JCQlvbGQgPSBj
bXB4Y2hnKCZwcGd0dC0+YmFzZS5wZC5wYWdlX3RhYmxlW3BkZV0sCi0JCQkJICAgICAgdm0tPnNj
cmF0Y2hfcHQsIHB0KTsKLQkJCWlmIChvbGQgPT0gdm0tPnNjcmF0Y2hfcHQpIHsKKwkJCXNwaW5f
bG9jaygmcHBndHQtPmJhc2UucGQubG9jayk7CisJCQlpZiAocHBndHQtPmJhc2UucGQucGFnZV90
YWJsZVtwZGVdID09IHZtLT5zY3JhdGNoX3B0KSB7CiAJCQkJcHBndHQtPmJhc2UucGQucGFnZV90
YWJsZVtwZGVdID0gcHQ7CiAJCQkJaWYgKGk5MTVfdm1hX2lzX2JvdW5kKHBwZ3R0LT52bWEsCiAJ
CQkJCQkgICAgICBJOTE1X1ZNQV9HTE9CQUxfQklORCkpIHsKQEAgLTE4NTMsMTEgKzE4NjgsOSBA
QCBzdGF0aWMgaW50IGdlbjZfYWxsb2NfdmFfcmFuZ2Uoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFj
ZSAqdm0sCiAJCQkJCWZsdXNoID0gdHJ1ZTsKIAkJCQl9CiAJCQl9IGVsc2UgewotCQkJCWZyZWVf
cHQodm0sIHB0KTsKLQkJCQlwdCA9IG9sZDsKKwkJCQlhbGxvYyA9IHB0OworCQkJCXB0ID0gcHBn
dHQtPmJhc2UucGQucGFnZV90YWJsZVtwZGVdOwogCQkJfQotCi0JCQlzcGluX2xvY2soJnBwZ3R0
LT5iYXNlLnBkLmxvY2spOwogCQl9CiAKIAkJYXRvbWljX2FkZChjb3VudCwgJnB0LT51c2VkX3B0
ZXMpOwpAQCAtMTg2OSwxNCArMTg4MiwxNSBAQCBzdGF0aWMgaW50IGdlbjZfYWxsb2NfdmFfcmFu
Z2Uoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCiAJCWdlbjZfZ2d0dF9pbnZhbGlkYXRl
KHZtLT5pOTE1KTsKIAl9CiAKLQlpbnRlbF9ydW50aW1lX3BtX3B1dCgmdm0tPmk5MTUtPnJ1bnRp
bWVfcG0sIHdha2VyZWYpOwotCi0JcmV0dXJuIDA7CisJZ290byBvdXQ7CiAKIHVud2luZF9vdXQ6
Ci0JaW50ZWxfcnVudGltZV9wbV9wdXQoJnZtLT5pOTE1LT5ydW50aW1lX3BtLCB3YWtlcmVmKTsK
IAlnZW42X3BwZ3R0X2NsZWFyX3JhbmdlKHZtLCBmcm9tLCBzdGFydCAtIGZyb20pOwotCXJldHVy
biAtRU5PTUVNOworb3V0OgorCWlmIChhbGxvYykKKwkJZnJlZV9wdCh2bSwgYWxsb2MpOworCWlu
dGVsX3J1bnRpbWVfcG1fcHV0KCZ2bS0+aTkxNS0+cnVudGltZV9wbSwgd2FrZXJlZik7CisJcmV0
dXJuIHJldDsKIH0KIAogc3RhdGljIGludCBnZW42X3BwZ3R0X2luaXRfc2NyYXRjaChzdHJ1Y3Qg
Z2VuNl9wcGd0dCAqcHBndHQpCi0tIAoyLjIwLjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxp
c3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFu
L2xpc3RpbmZvL2ludGVsLWdmeA==

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id C3602173B4
	for <lists+intel-gfx@lfdr.de>; Wed,  8 May 2019 10:27:22 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id F3A7789805;
	Wed,  8 May 2019 08:27:20 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id C149189805
 for <intel-gfx@lists.freedesktop.org>; Wed,  8 May 2019 08:27:17 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 16485929-1500050 
 for multiple; Wed, 08 May 2019 09:07:11 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Wed,  8 May 2019 09:06:53 +0100
Message-Id: <20190508080704.24223-29-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190508080704.24223-1-chris@chris-wilson.co.uk>
References: <20190508080704.24223-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 29/40] drm/i915: Move GEM object waiting to its
 own file
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

Q29udGludWluZyB0aGUgZGVjbHV0dGVyaW5nIG9mIGk5MTVfZ2VtLmMgYnkgbW92aW5nIHRoZSBv
YmplY3Qgd2FpdApkZWNvbXBvc2l0aW9uIGludG8gaXRzIG93biBmaWxlLgoKU2lnbmVkLW9mZi1i
eTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28udWs+Ci0tLQogZHJpdmVycy9n
cHUvZHJtL2k5MTUvTWFrZWZpbGUgICAgICAgICAgICAgIHwgICAxICsKIGRyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2dlbS9pOTE1X2dlbV9vYmplY3QuaCB8ICAgOCArCiBkcml2ZXJzL2dwdS9kcm0vaTkx
NS9nZW0vaTkxNV9nZW1fd2FpdC5jICAgfCAyNzcgKysrKysrKysrKysrKysrKysrKysrCiBkcml2
ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2Rydi5oICAgICAgICAgICAgfCAgIDcgLQogZHJpdmVycy9n
cHUvZHJtL2k5MTUvaTkxNV9nZW0uYyAgICAgICAgICAgIHwgMjU0IC0tLS0tLS0tLS0tLS0tLS0t
LS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfdXRpbHMuaCAgICAgICAgICB8ICAxMCAtCiA2
IGZpbGVzIGNoYW5nZWQsIDI4NiBpbnNlcnRpb25zKCspLCAyNzEgZGVsZXRpb25zKC0pCiBjcmVh
dGUgbW9kZSAxMDA2NDQgZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3dhaXQuYwoK
ZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L01ha2VmaWxlIGIvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvTWFrZWZpbGUKaW5kZXggZTUzNDhjMzU1OTg3Li5hNGNjMmY3ZjliYzYgMTAwNjQ0
Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L01ha2VmaWxlCisrKyBiL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L01ha2VmaWxlCkBAIC0xMDUsNiArMTA1LDcgQEAgZ2VtLXkgKz0gXAogCWdlbS9pOTE1
X2dlbV9zdG9sZW4ubyBcCiAJZ2VtL2k5MTVfZ2VtX3RpbGluZy5vIFwKIAlnZW0vaTkxNV9nZW1f
dXNlcnB0ci5vIFwKKwlnZW0vaTkxNV9nZW1fd2FpdC5vIFwKIAlnZW0vaTkxNV9nZW1mcy5vCiBp
OTE1LXkgKz0gXAogCSAgJChnZW0teSkgXApkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ2VtL2k5MTVfZ2VtX29iamVjdC5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVf
Z2VtX29iamVjdC5oCmluZGV4IDUwOWQxNDVkODA4YS4uMjNiY2EwMDNmYmZiIDEwMDY0NAotLS0g
YS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fb2JqZWN0LmgKKysrIGIvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX29iamVjdC5oCkBAIC00MzYsNCArNDM2LDEyIEBA
IHN0YXRpYyBpbmxpbmUgdm9pZCBfX3N0YXJ0X2NwdV93cml0ZShzdHJ1Y3QgZHJtX2k5MTVfZ2Vt
X29iamVjdCAqb2JqKQogCQlvYmotPmNhY2hlX2RpcnR5ID0gdHJ1ZTsKIH0KIAoraW50IGk5MTVf
Z2VtX29iamVjdF93YWl0KHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmosCisJCQkgdW5z
aWduZWQgaW50IGZsYWdzLAorCQkJIGxvbmcgdGltZW91dCk7CitpbnQgaTkxNV9nZW1fb2JqZWN0
X3dhaXRfcHJpb3JpdHkoc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiwKKwkJCQkgIHVu
c2lnbmVkIGludCBmbGFncywKKwkJCQkgIGNvbnN0IHN0cnVjdCBpOTE1X3NjaGVkX2F0dHIgKmF0
dHIpOworI2RlZmluZSBJOTE1X1BSSU9SSVRZX0RJU1BMQVkgSTkxNV9VU0VSX1BSSU9SSVRZKEk5
MTVfUFJJT1JJVFlfTUFYKQorCiAjZW5kaWYKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2dlbS9pOTE1X2dlbV93YWl0LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9n
ZW1fd2FpdC5jCm5ldyBmaWxlIG1vZGUgMTAwNjQ0CmluZGV4IDAwMDAwMDAwMDAwMC4uZmVkNWM3
NTFlZjM3Ci0tLSAvZGV2L251bGwKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVf
Z2VtX3dhaXQuYwpAQCAtMCwwICsxLDI3NyBAQAorLyoKKyAqIFNQRFgtTGljZW5zZS1JZGVudGlm
aWVyOiBNSVQKKyAqCisgKiBDb3B5cmlnaHQgwqkgMjAxNiBJbnRlbCBDb3Jwb3JhdGlvbgorICov
CisKKyNpbmNsdWRlIDxsaW51eC9kbWEtZmVuY2UtYXJyYXkuaD4KKyNpbmNsdWRlIDxsaW51eC9q
aWZmaWVzLmg+CisKKyNpbmNsdWRlICJndC9pbnRlbF9lbmdpbmUuaCIKKworI2luY2x1ZGUgImk5
MTVfZ2VtX2lvY3Rscy5oIgorI2luY2x1ZGUgImk5MTVfZ2VtX29iamVjdC5oIgorCitzdGF0aWMg
bG9uZworaTkxNV9nZW1fb2JqZWN0X3dhaXRfZmVuY2Uoc3RydWN0IGRtYV9mZW5jZSAqZmVuY2Us
CisJCQkgICB1bnNpZ25lZCBpbnQgZmxhZ3MsCisJCQkgICBsb25nIHRpbWVvdXQpCit7CisJQlVJ
TERfQlVHX09OKEk5MTVfV0FJVF9JTlRFUlJVUFRJQkxFICE9IDB4MSk7CisKKwlpZiAodGVzdF9i
aXQoRE1BX0ZFTkNFX0ZMQUdfU0lHTkFMRURfQklULCAmZmVuY2UtPmZsYWdzKSkKKwkJcmV0dXJu
IHRpbWVvdXQ7CisKKwlpZiAoZG1hX2ZlbmNlX2lzX2k5MTUoZmVuY2UpKQorCQlyZXR1cm4gaTkx
NV9yZXF1ZXN0X3dhaXQodG9fcmVxdWVzdChmZW5jZSksIGZsYWdzLCB0aW1lb3V0KTsKKworCXJl
dHVybiBkbWFfZmVuY2Vfd2FpdF90aW1lb3V0KGZlbmNlLAorCQkJCSAgICAgIGZsYWdzICYgSTkx
NV9XQUlUX0lOVEVSUlVQVElCTEUsCisJCQkJICAgICAgdGltZW91dCk7Cit9CisKK3N0YXRpYyBs
b25nCitpOTE1X2dlbV9vYmplY3Rfd2FpdF9yZXNlcnZhdGlvbihzdHJ1Y3QgcmVzZXJ2YXRpb25f
b2JqZWN0ICpyZXN2LAorCQkJCSB1bnNpZ25lZCBpbnQgZmxhZ3MsCisJCQkJIGxvbmcgdGltZW91
dCkKK3sKKwl1bnNpZ25lZCBpbnQgc2VxID0gX19yZWFkX3NlcWNvdW50X2JlZ2luKCZyZXN2LT5z
ZXEpOworCXN0cnVjdCBkbWFfZmVuY2UgKmV4Y2w7CisJYm9vbCBwcnVuZV9mZW5jZXMgPSBmYWxz
ZTsKKworCWlmIChmbGFncyAmIEk5MTVfV0FJVF9BTEwpIHsKKwkJc3RydWN0IGRtYV9mZW5jZSAq
KnNoYXJlZDsKKwkJdW5zaWduZWQgaW50IGNvdW50LCBpOworCQlpbnQgcmV0OworCisJCXJldCA9
IHJlc2VydmF0aW9uX29iamVjdF9nZXRfZmVuY2VzX3JjdShyZXN2LAorCQkJCQkJCSZleGNsLCAm
Y291bnQsICZzaGFyZWQpOworCQlpZiAocmV0KQorCQkJcmV0dXJuIHJldDsKKworCQlmb3IgKGkg
PSAwOyBpIDwgY291bnQ7IGkrKykgeworCQkJdGltZW91dCA9IGk5MTVfZ2VtX29iamVjdF93YWl0
X2ZlbmNlKHNoYXJlZFtpXSwKKwkJCQkJCQkgICAgIGZsYWdzLCB0aW1lb3V0KTsKKwkJCWlmICh0
aW1lb3V0IDwgMCkKKwkJCQlicmVhazsKKworCQkJZG1hX2ZlbmNlX3B1dChzaGFyZWRbaV0pOwor
CQl9CisKKwkJZm9yICg7IGkgPCBjb3VudDsgaSsrKQorCQkJZG1hX2ZlbmNlX3B1dChzaGFyZWRb
aV0pOworCQlrZnJlZShzaGFyZWQpOworCisJCS8qCisJCSAqIElmIGJvdGggc2hhcmVkIGZlbmNl
cyBhbmQgYW4gZXhjbHVzaXZlIGZlbmNlIGV4aXN0LAorCQkgKiB0aGVuIGJ5IGNvbnN0cnVjdGlv
biB0aGUgc2hhcmVkIGZlbmNlcyBtdXN0IGJlIGxhdGVyCisJCSAqIHRoYW4gdGhlIGV4Y2x1c2l2
ZSBmZW5jZS4gSWYgd2Ugc3VjY2Vzc2Z1bGx5IHdhaXQgZm9yCisJCSAqIGFsbCB0aGUgc2hhcmVk
IGZlbmNlcywgd2Uga25vdyB0aGF0IHRoZSBleGNsdXNpdmUgZmVuY2UKKwkJICogbXVzdCBhbGwg
YmUgc2lnbmFsZWQuIElmIGFsbCB0aGUgc2hhcmVkIGZlbmNlcyBhcmUKKwkJICogc2lnbmFsZWQs
IHdlIGNhbiBwcnVuZSB0aGUgYXJyYXkgYW5kIHJlY292ZXIgdGhlCisJCSAqIGZsb2F0aW5nIHJl
ZmVyZW5jZXMgb24gdGhlIGZlbmNlcy9yZXF1ZXN0cy4KKwkJICovCisJCXBydW5lX2ZlbmNlcyA9
IGNvdW50ICYmIHRpbWVvdXQgPj0gMDsKKwl9IGVsc2UgeworCQlleGNsID0gcmVzZXJ2YXRpb25f
b2JqZWN0X2dldF9leGNsX3JjdShyZXN2KTsKKwl9CisKKwlpZiAoZXhjbCAmJiB0aW1lb3V0ID49
IDApCisJCXRpbWVvdXQgPSBpOTE1X2dlbV9vYmplY3Rfd2FpdF9mZW5jZShleGNsLCBmbGFncywg
dGltZW91dCk7CisKKwlkbWFfZmVuY2VfcHV0KGV4Y2wpOworCisJLyoKKwkgKiBPcHBvcnR1bmlz
dGljYWxseSBwcnVuZSB0aGUgZmVuY2VzIGlmZiB3ZSBrbm93IHRoZXkgaGF2ZSAqYWxsKiBiZWVu
CisJICogc2lnbmFsZWQgYW5kIHRoYXQgdGhlIHJlc2VydmF0aW9uIG9iamVjdCBoYXMgbm90IGJl
ZW4gY2hhbmdlZCAoaS5lLgorCSAqIG5vIG5ldyBmZW5jZXMgaGF2ZSBiZWVuIGFkZGVkKS4KKwkg
Ki8KKwlpZiAocHJ1bmVfZmVuY2VzICYmICFfX3JlYWRfc2VxY291bnRfcmV0cnkoJnJlc3YtPnNl
cSwgc2VxKSkgeworCQlpZiAocmVzZXJ2YXRpb25fb2JqZWN0X3RyeWxvY2socmVzdikpIHsKKwkJ
CWlmICghX19yZWFkX3NlcWNvdW50X3JldHJ5KCZyZXN2LT5zZXEsIHNlcSkpCisJCQkJcmVzZXJ2
YXRpb25fb2JqZWN0X2FkZF9leGNsX2ZlbmNlKHJlc3YsIE5VTEwpOworCQkJcmVzZXJ2YXRpb25f
b2JqZWN0X3VubG9jayhyZXN2KTsKKwkJfQorCX0KKworCXJldHVybiB0aW1lb3V0OworfQorCitz
dGF0aWMgdm9pZCBfX2ZlbmNlX3NldF9wcmlvcml0eShzdHJ1Y3QgZG1hX2ZlbmNlICpmZW5jZSwK
KwkJCQkgY29uc3Qgc3RydWN0IGk5MTVfc2NoZWRfYXR0ciAqYXR0cikKK3sKKwlzdHJ1Y3QgaTkx
NV9yZXF1ZXN0ICpycTsKKwlzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmU7CisKKwlpZiAo
ZG1hX2ZlbmNlX2lzX3NpZ25hbGVkKGZlbmNlKSB8fCAhZG1hX2ZlbmNlX2lzX2k5MTUoZmVuY2Up
KQorCQlyZXR1cm47CisKKwlycSA9IHRvX3JlcXVlc3QoZmVuY2UpOworCWVuZ2luZSA9IHJxLT5l
bmdpbmU7CisKKwlsb2NhbF9iaF9kaXNhYmxlKCk7CisJcmN1X3JlYWRfbG9jaygpOyAvKiBSQ1Ug
c2VyaWFsaXNhdGlvbiBmb3Igc2V0LXdlZGdlZCBwcm90ZWN0aW9uICovCisJaWYgKGVuZ2luZS0+
c2NoZWR1bGUpCisJCWVuZ2luZS0+c2NoZWR1bGUocnEsIGF0dHIpOworCXJjdV9yZWFkX3VubG9j
aygpOworCWxvY2FsX2JoX2VuYWJsZSgpOyAvKiBraWNrIHRoZSB0YXNrbGV0cyBpZiBxdWV1ZXMg
d2VyZSByZXByaW9yaXRpc2VkICovCit9CisKK3N0YXRpYyB2b2lkIGZlbmNlX3NldF9wcmlvcml0
eShzdHJ1Y3QgZG1hX2ZlbmNlICpmZW5jZSwKKwkJCSAgICAgICBjb25zdCBzdHJ1Y3QgaTkxNV9z
Y2hlZF9hdHRyICphdHRyKQoreworCS8qIFJlY3Vyc2Ugb25jZSBpbnRvIGEgZmVuY2UtYXJyYXkg
Ki8KKwlpZiAoZG1hX2ZlbmNlX2lzX2FycmF5KGZlbmNlKSkgeworCQlzdHJ1Y3QgZG1hX2ZlbmNl
X2FycmF5ICphcnJheSA9IHRvX2RtYV9mZW5jZV9hcnJheShmZW5jZSk7CisJCWludCBpOworCisJ
CWZvciAoaSA9IDA7IGkgPCBhcnJheS0+bnVtX2ZlbmNlczsgaSsrKQorCQkJX19mZW5jZV9zZXRf
cHJpb3JpdHkoYXJyYXktPmZlbmNlc1tpXSwgYXR0cik7CisJfSBlbHNlIHsKKwkJX19mZW5jZV9z
ZXRfcHJpb3JpdHkoZmVuY2UsIGF0dHIpOworCX0KK30KKworaW50CitpOTE1X2dlbV9vYmplY3Rf
d2FpdF9wcmlvcml0eShzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqLAorCQkJICAgICAg
dW5zaWduZWQgaW50IGZsYWdzLAorCQkJICAgICAgY29uc3Qgc3RydWN0IGk5MTVfc2NoZWRfYXR0
ciAqYXR0cikKK3sKKwlzdHJ1Y3QgZG1hX2ZlbmNlICpleGNsOworCisJaWYgKGZsYWdzICYgSTkx
NV9XQUlUX0FMTCkgeworCQlzdHJ1Y3QgZG1hX2ZlbmNlICoqc2hhcmVkOworCQl1bnNpZ25lZCBp
bnQgY291bnQsIGk7CisJCWludCByZXQ7CisKKwkJcmV0ID0gcmVzZXJ2YXRpb25fb2JqZWN0X2dl
dF9mZW5jZXNfcmN1KG9iai0+cmVzdiwKKwkJCQkJCQkmZXhjbCwgJmNvdW50LCAmc2hhcmVkKTsK
KwkJaWYgKHJldCkKKwkJCXJldHVybiByZXQ7CisKKwkJZm9yIChpID0gMDsgaSA8IGNvdW50OyBp
KyspIHsKKwkJCWZlbmNlX3NldF9wcmlvcml0eShzaGFyZWRbaV0sIGF0dHIpOworCQkJZG1hX2Zl
bmNlX3B1dChzaGFyZWRbaV0pOworCQl9CisKKwkJa2ZyZWUoc2hhcmVkKTsKKwl9IGVsc2Ugewor
CQlleGNsID0gcmVzZXJ2YXRpb25fb2JqZWN0X2dldF9leGNsX3JjdShvYmotPnJlc3YpOworCX0K
KworCWlmIChleGNsKSB7CisJCWZlbmNlX3NldF9wcmlvcml0eShleGNsLCBhdHRyKTsKKwkJZG1h
X2ZlbmNlX3B1dChleGNsKTsKKwl9CisJcmV0dXJuIDA7Cit9CisKKy8qKgorICogV2FpdHMgZm9y
IHJlbmRlcmluZyB0byB0aGUgb2JqZWN0IHRvIGJlIGNvbXBsZXRlZAorICogQG9iajogaTkxNSBn
ZW0gb2JqZWN0CisgKiBAZmxhZ3M6IGhvdyB0byB3YWl0ICh1bmRlciBhIGxvY2ssIGZvciBhbGwg
cmVuZGVyaW5nIG9yIGp1c3QgZm9yIHdyaXRlcyBldGMpCisgKiBAdGltZW91dDogaG93IGxvbmcg
dG8gd2FpdAorICovCitpbnQKK2k5MTVfZ2VtX29iamVjdF93YWl0KHN0cnVjdCBkcm1faTkxNV9n
ZW1fb2JqZWN0ICpvYmosCisJCSAgICAgdW5zaWduZWQgaW50IGZsYWdzLAorCQkgICAgIGxvbmcg
dGltZW91dCkKK3sKKwltaWdodF9zbGVlcCgpOworCUdFTV9CVUdfT04odGltZW91dCA8IDApOwor
CisJdGltZW91dCA9IGk5MTVfZ2VtX29iamVjdF93YWl0X3Jlc2VydmF0aW9uKG9iai0+cmVzdiwg
ZmxhZ3MsIHRpbWVvdXQpOworCXJldHVybiB0aW1lb3V0IDwgMCA/IHRpbWVvdXQgOiAwOworfQor
CitzdGF0aWMgaW5saW5lIHVuc2lnbmVkIGxvbmcgbnNlY3NfdG9famlmZmllc190aW1lb3V0KGNv
bnN0IHU2NCBuKQoreworCS8qIG5zZWNzX3RvX2ppZmZpZXM2NCgpIGRvZXMgbm90IGd1YXJkIGFn
YWluc3Qgb3ZlcmZsb3cgKi8KKwlpZiAoTlNFQ19QRVJfU0VDICUgSFogJiYKKwkgICAgZGl2X3U2
NChuLCBOU0VDX1BFUl9TRUMpID49IE1BWF9KSUZGWV9PRkZTRVQgLyBIWikKKwkJcmV0dXJuIE1B
WF9KSUZGWV9PRkZTRVQ7CisKKwlyZXR1cm4gbWluX3QodTY0LCBNQVhfSklGRllfT0ZGU0VULCBu
c2Vjc190b19qaWZmaWVzNjQobikgKyAxKTsKK30KKworc3RhdGljIHVuc2lnbmVkIGxvbmcgdG9f
d2FpdF90aW1lb3V0KHM2NCB0aW1lb3V0X25zKQoreworCWlmICh0aW1lb3V0X25zIDwgMCkKKwkJ
cmV0dXJuIE1BWF9TQ0hFRFVMRV9USU1FT1VUOworCisJaWYgKHRpbWVvdXRfbnMgPT0gMCkKKwkJ
cmV0dXJuIDA7CisKKwlyZXR1cm4gbnNlY3NfdG9famlmZmllc190aW1lb3V0KHRpbWVvdXRfbnMp
OworfQorCisvKioKKyAqIGk5MTVfZ2VtX3dhaXRfaW9jdGwgLSBpbXBsZW1lbnRzIERSTV9JT0NU
TF9JOTE1X0dFTV9XQUlUCisgKiBAZGV2OiBkcm0gZGV2aWNlIHBvaW50ZXIKKyAqIEBkYXRhOiBp
b2N0bCBkYXRhIGJsb2IKKyAqIEBmaWxlOiBkcm0gZmlsZSBwb2ludGVyCisgKgorICogUmV0dXJu
cyAwIGlmIHN1Y2Nlc3NmdWwsIGVsc2UgYW4gZXJyb3IgaXMgcmV0dXJuZWQgd2l0aCB0aGUgcmVt
YWluaW5nIHRpbWUgaW4KKyAqIHRoZSB0aW1lb3V0IHBhcmFtZXRlci4KKyAqICAtRVRJTUU6IG9i
amVjdCBpcyBzdGlsbCBidXN5IGFmdGVyIHRpbWVvdXQKKyAqICAtRVJFU1RBUlRTWVM6IHNpZ25h
bCBpbnRlcnJ1cHRlZCB0aGUgd2FpdAorICogIC1FTk9ORU5UOiBvYmplY3QgZG9lc24ndCBleGlz
dAorICogQWxzbyBwb3NzaWJsZSwgYnV0IHJhcmU6CisgKiAgLUVBR0FJTjogaW5jb21wbGV0ZSwg
cmVzdGFydCBzeXNjYWxsCisgKiAgLUVOT01FTTogZGFtbgorICogIC1FTk9ERVY6IEludGVybmFs
IElSUSBmYWlsCisgKiAgLUU/OiBUaGUgYWRkIHJlcXVlc3QgZmFpbGVkCisgKgorICogVGhlIHdh
aXQgaW9jdGwgd2l0aCBhIHRpbWVvdXQgb2YgMCByZWltcGxlbWVudHMgdGhlIGJ1c3kgaW9jdGwu
IFdpdGggYW55CisgKiBub24temVybyB0aW1lb3V0IHBhcmFtZXRlciB0aGUgd2FpdCBpb2N0bCB3
aWxsIHdhaXQgZm9yIHRoZSBnaXZlbiBudW1iZXIgb2YKKyAqIG5hbm9zZWNvbmRzIG9uIGFuIG9i
amVjdCBiZWNvbWluZyB1bmJ1c3kuIFNpbmNlIHRoZSB3YWl0IGl0c2VsZiBkb2VzIHNvCisgKiB3
aXRob3V0IGhvbGRpbmcgc3RydWN0X211dGV4IHRoZSBvYmplY3QgbWF5IGJlY29tZSByZS1idXNp
ZWQgYmVmb3JlIHRoaXMKKyAqIGZ1bmN0aW9uIGNvbXBsZXRlcy4gQSBzaW1pbGFyIGJ1dCBzaG9y
dGVyICogcmFjZSBjb25kaXRpb24gZXhpc3RzIGluIHRoZSBidXN5CisgKiBpb2N0bAorICovCitp
bnQKK2k5MTVfZ2VtX3dhaXRfaW9jdGwoc3RydWN0IGRybV9kZXZpY2UgKmRldiwgdm9pZCAqZGF0
YSwgc3RydWN0IGRybV9maWxlICpmaWxlKQoreworCXN0cnVjdCBkcm1faTkxNV9nZW1fd2FpdCAq
YXJncyA9IGRhdGE7CisJc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iajsKKwlrdGltZV90
IHN0YXJ0OworCWxvbmcgcmV0OworCisJaWYgKGFyZ3MtPmZsYWdzICE9IDApCisJCXJldHVybiAt
RUlOVkFMOworCisJb2JqID0gaTkxNV9nZW1fb2JqZWN0X2xvb2t1cChmaWxlLCBhcmdzLT5ib19o
YW5kbGUpOworCWlmICghb2JqKQorCQlyZXR1cm4gLUVOT0VOVDsKKworCXN0YXJ0ID0ga3RpbWVf
Z2V0KCk7CisKKwlyZXQgPSBpOTE1X2dlbV9vYmplY3Rfd2FpdChvYmosCisJCQkJICAgSTkxNV9X
QUlUX0lOVEVSUlVQVElCTEUgfAorCQkJCSAgIEk5MTVfV0FJVF9QUklPUklUWSB8CisJCQkJICAg
STkxNV9XQUlUX0FMTCwKKwkJCQkgICB0b193YWl0X3RpbWVvdXQoYXJncy0+dGltZW91dF9ucykp
OworCisJaWYgKGFyZ3MtPnRpbWVvdXRfbnMgPiAwKSB7CisJCWFyZ3MtPnRpbWVvdXRfbnMgLT0g
a3RpbWVfdG9fbnMoa3RpbWVfc3ViKGt0aW1lX2dldCgpLCBzdGFydCkpOworCQlpZiAoYXJncy0+
dGltZW91dF9ucyA8IDApCisJCQlhcmdzLT50aW1lb3V0X25zID0gMDsKKworCQkvKgorCQkgKiBB
cHBhcmVudGx5IGt0aW1lIGlzbid0IGFjY3VyYXRlIGVub3VnaCBhbmQgb2NjYXNpb25hbGx5IGhh
cyBhCisJCSAqIGJpdCBvZiBtaXNtYXRjaCBpbiB0aGUgamlmZmllczwtPm5zZWNzPC0+a3RpbWUg
bG9vcC4gU28gcGF0Y2gKKwkJICogdGhpbmdzIHVwIHRvIG1ha2UgdGhlIHRlc3QgaGFwcHkuIFdl
IGFsbG93IHVwIHRvIDEgamlmZnkuCisJCSAqCisJCSAqIFRoaXMgaXMgYSByZWdyZXNzaW9uIGZy
b20gdGhlIHRpbWVzcGVjLT5rdGltZSBjb252ZXJzaW9uLgorCQkgKi8KKwkJaWYgKHJldCA9PSAt
RVRJTUUgJiYgIW5zZWNzX3RvX2ppZmZpZXMoYXJncy0+dGltZW91dF9ucykpCisJCQlhcmdzLT50
aW1lb3V0X25zID0gMDsKKworCQkvKiBBc2tlZCB0byB3YWl0IGJleW9uZCB0aGUgamlmZmllL3Nj
aGVkdWxlciBwcmVjaXNpb24/ICovCisJCWlmIChyZXQgPT0gLUVUSU1FICYmIGFyZ3MtPnRpbWVv
dXRfbnMpCisJCQlyZXQgPSAtRUFHQUlOOworCX0KKworCWk5MTVfZ2VtX29iamVjdF9wdXQob2Jq
KTsKKwlyZXR1cm4gcmV0OworfQpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkx
NV9kcnYuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZHJ2LmgKaW5kZXggNmY4ZGRmYmU3
ZDg1Li44ZWIwMWIxYjNlMGUgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVf
ZHJ2LmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYuaApAQCAtMjc0MiwxMyAr
Mjc0Miw2IEBAIHZvaWQgaTkxNV9nZW1fc3VzcGVuZChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAq
ZGV2X3ByaXYpOwogdm9pZCBpOTE1X2dlbV9zdXNwZW5kX2xhdGUoc3RydWN0IGRybV9pOTE1X3By
aXZhdGUgKmRldl9wcml2KTsKIHZvaWQgaTkxNV9nZW1fcmVzdW1lKHN0cnVjdCBkcm1faTkxNV9w
cml2YXRlICpkZXZfcHJpdik7CiB2bV9mYXVsdF90IGk5MTVfZ2VtX2ZhdWx0KHN0cnVjdCB2bV9m
YXVsdCAqdm1mKTsKLWludCBpOTE1X2dlbV9vYmplY3Rfd2FpdChzdHJ1Y3QgZHJtX2k5MTVfZ2Vt
X29iamVjdCAqb2JqLAotCQkJIHVuc2lnbmVkIGludCBmbGFncywKLQkJCSBsb25nIHRpbWVvdXQp
OwotaW50IGk5MTVfZ2VtX29iamVjdF93YWl0X3ByaW9yaXR5KHN0cnVjdCBkcm1faTkxNV9nZW1f
b2JqZWN0ICpvYmosCi0JCQkJICB1bnNpZ25lZCBpbnQgZmxhZ3MsCi0JCQkJICBjb25zdCBzdHJ1
Y3QgaTkxNV9zY2hlZF9hdHRyICphdHRyKTsKLSNkZWZpbmUgSTkxNV9QUklPUklUWV9ESVNQTEFZ
IEk5MTVfVVNFUl9QUklPUklUWShJOTE1X1BSSU9SSVRZX01BWCkKIAogaW50IGk5MTVfZ2VtX29w
ZW4oc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUsIHN0cnVjdCBkcm1fZmlsZSAqZmlsZSk7
CiB2b2lkIGk5MTVfZ2VtX3JlbGVhc2Uoc3RydWN0IGRybV9kZXZpY2UgKmRldiwgc3RydWN0IGRy
bV9maWxlICpmaWxlKTsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2Vt
LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbS5jCmluZGV4IDMyZmRjMTk3N2FmZS4u
NDY3MjczZGQyZDRhIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbS5j
CisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtLmMKQEAgLTEyNCwxNzggKzEyNCw2
IEBAIGludCBpOTE1X2dlbV9vYmplY3RfdW5iaW5kKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0
ICpvYmopCiAJcmV0dXJuIHJldDsKIH0KIAotc3RhdGljIGxvbmcKLWk5MTVfZ2VtX29iamVjdF93
YWl0X2ZlbmNlKHN0cnVjdCBkbWFfZmVuY2UgKmZlbmNlLAotCQkJICAgdW5zaWduZWQgaW50IGZs
YWdzLAotCQkJICAgbG9uZyB0aW1lb3V0KQotewotCUJVSUxEX0JVR19PTihJOTE1X1dBSVRfSU5U
RVJSVVBUSUJMRSAhPSAweDEpOwotCi0JaWYgKHRlc3RfYml0KERNQV9GRU5DRV9GTEFHX1NJR05B
TEVEX0JJVCwgJmZlbmNlLT5mbGFncykpCi0JCXJldHVybiB0aW1lb3V0OwotCi0JaWYgKGRtYV9m
ZW5jZV9pc19pOTE1KGZlbmNlKSkKLQkJcmV0dXJuIGk5MTVfcmVxdWVzdF93YWl0KHRvX3JlcXVl
c3QoZmVuY2UpLCBmbGFncywgdGltZW91dCk7Ci0KLQlyZXR1cm4gZG1hX2ZlbmNlX3dhaXRfdGlt
ZW91dChmZW5jZSwKLQkJCQkgICAgICBmbGFncyAmIEk5MTVfV0FJVF9JTlRFUlJVUFRJQkxFLAot
CQkJCSAgICAgIHRpbWVvdXQpOwotfQotCi1zdGF0aWMgbG9uZwotaTkxNV9nZW1fb2JqZWN0X3dh
aXRfcmVzZXJ2YXRpb24oc3RydWN0IHJlc2VydmF0aW9uX29iamVjdCAqcmVzdiwKLQkJCQkgdW5z
aWduZWQgaW50IGZsYWdzLAotCQkJCSBsb25nIHRpbWVvdXQpCi17Ci0JdW5zaWduZWQgaW50IHNl
cSA9IF9fcmVhZF9zZXFjb3VudF9iZWdpbigmcmVzdi0+c2VxKTsKLQlzdHJ1Y3QgZG1hX2ZlbmNl
ICpleGNsOwotCWJvb2wgcHJ1bmVfZmVuY2VzID0gZmFsc2U7Ci0KLQlpZiAoZmxhZ3MgJiBJOTE1
X1dBSVRfQUxMKSB7Ci0JCXN0cnVjdCBkbWFfZmVuY2UgKipzaGFyZWQ7Ci0JCXVuc2lnbmVkIGlu
dCBjb3VudCwgaTsKLQkJaW50IHJldDsKLQotCQlyZXQgPSByZXNlcnZhdGlvbl9vYmplY3RfZ2V0
X2ZlbmNlc19yY3UocmVzdiwKLQkJCQkJCQkmZXhjbCwgJmNvdW50LCAmc2hhcmVkKTsKLQkJaWYg
KHJldCkKLQkJCXJldHVybiByZXQ7Ci0KLQkJZm9yIChpID0gMDsgaSA8IGNvdW50OyBpKyspIHsK
LQkJCXRpbWVvdXQgPSBpOTE1X2dlbV9vYmplY3Rfd2FpdF9mZW5jZShzaGFyZWRbaV0sCi0JCQkJ
CQkJICAgICBmbGFncywgdGltZW91dCk7Ci0JCQlpZiAodGltZW91dCA8IDApCi0JCQkJYnJlYWs7
Ci0KLQkJCWRtYV9mZW5jZV9wdXQoc2hhcmVkW2ldKTsKLQkJfQotCi0JCWZvciAoOyBpIDwgY291
bnQ7IGkrKykKLQkJCWRtYV9mZW5jZV9wdXQoc2hhcmVkW2ldKTsKLQkJa2ZyZWUoc2hhcmVkKTsK
LQotCQkvKgotCQkgKiBJZiBib3RoIHNoYXJlZCBmZW5jZXMgYW5kIGFuIGV4Y2x1c2l2ZSBmZW5j
ZSBleGlzdCwKLQkJICogdGhlbiBieSBjb25zdHJ1Y3Rpb24gdGhlIHNoYXJlZCBmZW5jZXMgbXVz
dCBiZSBsYXRlcgotCQkgKiB0aGFuIHRoZSBleGNsdXNpdmUgZmVuY2UuIElmIHdlIHN1Y2Nlc3Nm
dWxseSB3YWl0IGZvcgotCQkgKiBhbGwgdGhlIHNoYXJlZCBmZW5jZXMsIHdlIGtub3cgdGhhdCB0
aGUgZXhjbHVzaXZlIGZlbmNlCi0JCSAqIG11c3QgYWxsIGJlIHNpZ25hbGVkLiBJZiBhbGwgdGhl
IHNoYXJlZCBmZW5jZXMgYXJlCi0JCSAqIHNpZ25hbGVkLCB3ZSBjYW4gcHJ1bmUgdGhlIGFycmF5
IGFuZCByZWNvdmVyIHRoZQotCQkgKiBmbG9hdGluZyByZWZlcmVuY2VzIG9uIHRoZSBmZW5jZXMv
cmVxdWVzdHMuCi0JCSAqLwotCQlwcnVuZV9mZW5jZXMgPSBjb3VudCAmJiB0aW1lb3V0ID49IDA7
Ci0JfSBlbHNlIHsKLQkJZXhjbCA9IHJlc2VydmF0aW9uX29iamVjdF9nZXRfZXhjbF9yY3UocmVz
dik7Ci0JfQotCi0JaWYgKGV4Y2wgJiYgdGltZW91dCA+PSAwKQotCQl0aW1lb3V0ID0gaTkxNV9n
ZW1fb2JqZWN0X3dhaXRfZmVuY2UoZXhjbCwgZmxhZ3MsIHRpbWVvdXQpOwotCi0JZG1hX2ZlbmNl
X3B1dChleGNsKTsKLQotCS8qCi0JICogT3Bwb3J0dW5pc3RpY2FsbHkgcHJ1bmUgdGhlIGZlbmNl
cyBpZmYgd2Uga25vdyB0aGV5IGhhdmUgKmFsbCogYmVlbgotCSAqIHNpZ25hbGVkIGFuZCB0aGF0
IHRoZSByZXNlcnZhdGlvbiBvYmplY3QgaGFzIG5vdCBiZWVuIGNoYW5nZWQgKGkuZS4KLQkgKiBu
byBuZXcgZmVuY2VzIGhhdmUgYmVlbiBhZGRlZCkuCi0JICovCi0JaWYgKHBydW5lX2ZlbmNlcyAm
JiAhX19yZWFkX3NlcWNvdW50X3JldHJ5KCZyZXN2LT5zZXEsIHNlcSkpIHsKLQkJaWYgKHJlc2Vy
dmF0aW9uX29iamVjdF90cnlsb2NrKHJlc3YpKSB7Ci0JCQlpZiAoIV9fcmVhZF9zZXFjb3VudF9y
ZXRyeSgmcmVzdi0+c2VxLCBzZXEpKQotCQkJCXJlc2VydmF0aW9uX29iamVjdF9hZGRfZXhjbF9m
ZW5jZShyZXN2LCBOVUxMKTsKLQkJCXJlc2VydmF0aW9uX29iamVjdF91bmxvY2socmVzdik7Ci0J
CX0KLQl9Ci0KLQlyZXR1cm4gdGltZW91dDsKLX0KLQotc3RhdGljIHZvaWQgX19mZW5jZV9zZXRf
cHJpb3JpdHkoc3RydWN0IGRtYV9mZW5jZSAqZmVuY2UsCi0JCQkJIGNvbnN0IHN0cnVjdCBpOTE1
X3NjaGVkX2F0dHIgKmF0dHIpCi17Ci0Jc3RydWN0IGk5MTVfcmVxdWVzdCAqcnE7Ci0Jc3RydWN0
IGludGVsX2VuZ2luZV9jcyAqZW5naW5lOwotCi0JaWYgKGRtYV9mZW5jZV9pc19zaWduYWxlZChm
ZW5jZSkgfHwgIWRtYV9mZW5jZV9pc19pOTE1KGZlbmNlKSkKLQkJcmV0dXJuOwotCi0JcnEgPSB0
b19yZXF1ZXN0KGZlbmNlKTsKLQllbmdpbmUgPSBycS0+ZW5naW5lOwotCi0JbG9jYWxfYmhfZGlz
YWJsZSgpOwotCXJjdV9yZWFkX2xvY2soKTsgLyogUkNVIHNlcmlhbGlzYXRpb24gZm9yIHNldC13
ZWRnZWQgcHJvdGVjdGlvbiAqLwotCWlmIChlbmdpbmUtPnNjaGVkdWxlKQotCQllbmdpbmUtPnNj
aGVkdWxlKHJxLCBhdHRyKTsKLQlyY3VfcmVhZF91bmxvY2soKTsKLQlsb2NhbF9iaF9lbmFibGUo
KTsgLyoga2ljayB0aGUgdGFza2xldHMgaWYgcXVldWVzIHdlcmUgcmVwcmlvcml0aXNlZCAqLwot
fQotCi1zdGF0aWMgdm9pZCBmZW5jZV9zZXRfcHJpb3JpdHkoc3RydWN0IGRtYV9mZW5jZSAqZmVu
Y2UsCi0JCQkgICAgICAgY29uc3Qgc3RydWN0IGk5MTVfc2NoZWRfYXR0ciAqYXR0cikKLXsKLQkv
KiBSZWN1cnNlIG9uY2UgaW50byBhIGZlbmNlLWFycmF5ICovCi0JaWYgKGRtYV9mZW5jZV9pc19h
cnJheShmZW5jZSkpIHsKLQkJc3RydWN0IGRtYV9mZW5jZV9hcnJheSAqYXJyYXkgPSB0b19kbWFf
ZmVuY2VfYXJyYXkoZmVuY2UpOwotCQlpbnQgaTsKLQotCQlmb3IgKGkgPSAwOyBpIDwgYXJyYXkt
Pm51bV9mZW5jZXM7IGkrKykKLQkJCV9fZmVuY2Vfc2V0X3ByaW9yaXR5KGFycmF5LT5mZW5jZXNb
aV0sIGF0dHIpOwotCX0gZWxzZSB7Ci0JCV9fZmVuY2Vfc2V0X3ByaW9yaXR5KGZlbmNlLCBhdHRy
KTsKLQl9Ci19Ci0KLWludAotaTkxNV9nZW1fb2JqZWN0X3dhaXRfcHJpb3JpdHkoc3RydWN0IGRy
bV9pOTE1X2dlbV9vYmplY3QgKm9iaiwKLQkJCSAgICAgIHVuc2lnbmVkIGludCBmbGFncywKLQkJ
CSAgICAgIGNvbnN0IHN0cnVjdCBpOTE1X3NjaGVkX2F0dHIgKmF0dHIpCi17Ci0Jc3RydWN0IGRt
YV9mZW5jZSAqZXhjbDsKLQotCWlmIChmbGFncyAmIEk5MTVfV0FJVF9BTEwpIHsKLQkJc3RydWN0
IGRtYV9mZW5jZSAqKnNoYXJlZDsKLQkJdW5zaWduZWQgaW50IGNvdW50LCBpOwotCQlpbnQgcmV0
OwotCi0JCXJldCA9IHJlc2VydmF0aW9uX29iamVjdF9nZXRfZmVuY2VzX3JjdShvYmotPnJlc3Ys
Ci0JCQkJCQkJJmV4Y2wsICZjb3VudCwgJnNoYXJlZCk7Ci0JCWlmIChyZXQpCi0JCQlyZXR1cm4g
cmV0OwotCi0JCWZvciAoaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7Ci0JCQlmZW5jZV9zZXRfcHJp
b3JpdHkoc2hhcmVkW2ldLCBhdHRyKTsKLQkJCWRtYV9mZW5jZV9wdXQoc2hhcmVkW2ldKTsKLQkJ
fQotCi0JCWtmcmVlKHNoYXJlZCk7Ci0JfSBlbHNlIHsKLQkJZXhjbCA9IHJlc2VydmF0aW9uX29i
amVjdF9nZXRfZXhjbF9yY3Uob2JqLT5yZXN2KTsKLQl9Ci0KLQlpZiAoZXhjbCkgewotCQlmZW5j
ZV9zZXRfcHJpb3JpdHkoZXhjbCwgYXR0cik7Ci0JCWRtYV9mZW5jZV9wdXQoZXhjbCk7Ci0JfQot
CXJldHVybiAwOwotfQotCi0vKioKLSAqIFdhaXRzIGZvciByZW5kZXJpbmcgdG8gdGhlIG9iamVj
dCB0byBiZSBjb21wbGV0ZWQKLSAqIEBvYmo6IGk5MTUgZ2VtIG9iamVjdAotICogQGZsYWdzOiBo
b3cgdG8gd2FpdCAodW5kZXIgYSBsb2NrLCBmb3IgYWxsIHJlbmRlcmluZyBvciBqdXN0IGZvciB3
cml0ZXMgZXRjKQotICogQHRpbWVvdXQ6IGhvdyBsb25nIHRvIHdhaXQKLSAqLwotaW50Ci1pOTE1
X2dlbV9vYmplY3Rfd2FpdChzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqLAotCQkgICAg
IHVuc2lnbmVkIGludCBmbGFncywKLQkJICAgICBsb25nIHRpbWVvdXQpCi17Ci0JbWlnaHRfc2xl
ZXAoKTsKLQlHRU1fQlVHX09OKHRpbWVvdXQgPCAwKTsKLQotCXRpbWVvdXQgPSBpOTE1X2dlbV9v
YmplY3Rfd2FpdF9yZXNlcnZhdGlvbihvYmotPnJlc3YsIGZsYWdzLCB0aW1lb3V0KTsKLQlyZXR1
cm4gdGltZW91dCA8IDAgPyB0aW1lb3V0IDogMDsKLX0KLQogc3RhdGljIGludAogaTkxNV9nZW1f
cGh5c19wd3JpdGUoc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiwKIAkJICAgICBzdHJ1
Y3QgZHJtX2k5MTVfZ2VtX3B3cml0ZSAqYXJncywKQEAgLTEwNzMsODggKzkwMSw2IEBAIHZvaWQg
aTkxNV9nZW1fcnVudGltZV9zdXNwZW5kKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJp
dikKIAl9CiB9CiAKLXN0YXRpYyB1bnNpZ25lZCBsb25nIHRvX3dhaXRfdGltZW91dChzNjQgdGlt
ZW91dF9ucykKLXsKLQlpZiAodGltZW91dF9ucyA8IDApCi0JCXJldHVybiBNQVhfU0NIRURVTEVf
VElNRU9VVDsKLQotCWlmICh0aW1lb3V0X25zID09IDApCi0JCXJldHVybiAwOwotCi0JcmV0dXJu
IG5zZWNzX3RvX2ppZmZpZXNfdGltZW91dCh0aW1lb3V0X25zKTsKLX0KLQotLyoqCi0gKiBpOTE1
X2dlbV93YWl0X2lvY3RsIC0gaW1wbGVtZW50cyBEUk1fSU9DVExfSTkxNV9HRU1fV0FJVAotICog
QGRldjogZHJtIGRldmljZSBwb2ludGVyCi0gKiBAZGF0YTogaW9jdGwgZGF0YSBibG9iCi0gKiBA
ZmlsZTogZHJtIGZpbGUgcG9pbnRlcgotICoKLSAqIFJldHVybnMgMCBpZiBzdWNjZXNzZnVsLCBl
bHNlIGFuIGVycm9yIGlzIHJldHVybmVkIHdpdGggdGhlIHJlbWFpbmluZyB0aW1lIGluCi0gKiB0
aGUgdGltZW91dCBwYXJhbWV0ZXIuCi0gKiAgLUVUSU1FOiBvYmplY3QgaXMgc3RpbGwgYnVzeSBh
ZnRlciB0aW1lb3V0Ci0gKiAgLUVSRVNUQVJUU1lTOiBzaWduYWwgaW50ZXJydXB0ZWQgdGhlIHdh
aXQKLSAqICAtRU5PTkVOVDogb2JqZWN0IGRvZXNuJ3QgZXhpc3QKLSAqIEFsc28gcG9zc2libGUs
IGJ1dCByYXJlOgotICogIC1FQUdBSU46IGluY29tcGxldGUsIHJlc3RhcnQgc3lzY2FsbAotICog
IC1FTk9NRU06IGRhbW4KLSAqICAtRU5PREVWOiBJbnRlcm5hbCBJUlEgZmFpbAotICogIC1FPzog
VGhlIGFkZCByZXF1ZXN0IGZhaWxlZAotICoKLSAqIFRoZSB3YWl0IGlvY3RsIHdpdGggYSB0aW1l
b3V0IG9mIDAgcmVpbXBsZW1lbnRzIHRoZSBidXN5IGlvY3RsLiBXaXRoIGFueQotICogbm9uLXpl
cm8gdGltZW91dCBwYXJhbWV0ZXIgdGhlIHdhaXQgaW9jdGwgd2lsbCB3YWl0IGZvciB0aGUgZ2l2
ZW4gbnVtYmVyIG9mCi0gKiBuYW5vc2Vjb25kcyBvbiBhbiBvYmplY3QgYmVjb21pbmcgdW5idXN5
LiBTaW5jZSB0aGUgd2FpdCBpdHNlbGYgZG9lcyBzbwotICogd2l0aG91dCBob2xkaW5nIHN0cnVj
dF9tdXRleCB0aGUgb2JqZWN0IG1heSBiZWNvbWUgcmUtYnVzaWVkIGJlZm9yZSB0aGlzCi0gKiBm
dW5jdGlvbiBjb21wbGV0ZXMuIEEgc2ltaWxhciBidXQgc2hvcnRlciAqIHJhY2UgY29uZGl0aW9u
IGV4aXN0cyBpbiB0aGUgYnVzeQotICogaW9jdGwKLSAqLwotaW50Ci1pOTE1X2dlbV93YWl0X2lv
Y3RsKHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsIHZvaWQgKmRhdGEsIHN0cnVjdCBkcm1fZmlsZSAq
ZmlsZSkKLXsKLQlzdHJ1Y3QgZHJtX2k5MTVfZ2VtX3dhaXQgKmFyZ3MgPSBkYXRhOwotCXN0cnVj
dCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmo7Ci0Ja3RpbWVfdCBzdGFydDsKLQlsb25nIHJldDsK
LQotCWlmIChhcmdzLT5mbGFncyAhPSAwKQotCQlyZXR1cm4gLUVJTlZBTDsKLQotCW9iaiA9IGk5
MTVfZ2VtX29iamVjdF9sb29rdXAoZmlsZSwgYXJncy0+Ym9faGFuZGxlKTsKLQlpZiAoIW9iaikK
LQkJcmV0dXJuIC1FTk9FTlQ7Ci0KLQlzdGFydCA9IGt0aW1lX2dldCgpOwotCi0JcmV0ID0gaTkx
NV9nZW1fb2JqZWN0X3dhaXQob2JqLAotCQkJCSAgIEk5MTVfV0FJVF9JTlRFUlJVUFRJQkxFIHwK
LQkJCQkgICBJOTE1X1dBSVRfUFJJT1JJVFkgfAotCQkJCSAgIEk5MTVfV0FJVF9BTEwsCi0JCQkJ
ICAgdG9fd2FpdF90aW1lb3V0KGFyZ3MtPnRpbWVvdXRfbnMpKTsKLQotCWlmIChhcmdzLT50aW1l
b3V0X25zID4gMCkgewotCQlhcmdzLT50aW1lb3V0X25zIC09IGt0aW1lX3RvX25zKGt0aW1lX3N1
YihrdGltZV9nZXQoKSwgc3RhcnQpKTsKLQkJaWYgKGFyZ3MtPnRpbWVvdXRfbnMgPCAwKQotCQkJ
YXJncy0+dGltZW91dF9ucyA9IDA7Ci0KLQkJLyoKLQkJICogQXBwYXJlbnRseSBrdGltZSBpc24n
dCBhY2N1cmF0ZSBlbm91Z2ggYW5kIG9jY2FzaW9uYWxseSBoYXMgYQotCQkgKiBiaXQgb2YgbWlz
bWF0Y2ggaW4gdGhlIGppZmZpZXM8LT5uc2VjczwtPmt0aW1lIGxvb3AuIFNvIHBhdGNoCi0JCSAq
IHRoaW5ncyB1cCB0byBtYWtlIHRoZSB0ZXN0IGhhcHB5LiBXZSBhbGxvdyB1cCB0byAxIGppZmZ5
LgotCQkgKgotCQkgKiBUaGlzIGlzIGEgcmVncmVzc2lvbiBmcm9tIHRoZSB0aW1lc3BlYy0+a3Rp
bWUgY29udmVyc2lvbi4KLQkJICovCi0JCWlmIChyZXQgPT0gLUVUSU1FICYmICFuc2Vjc190b19q
aWZmaWVzKGFyZ3MtPnRpbWVvdXRfbnMpKQotCQkJYXJncy0+dGltZW91dF9ucyA9IDA7Ci0KLQkJ
LyogQXNrZWQgdG8gd2FpdCBiZXlvbmQgdGhlIGppZmZpZS9zY2hlZHVsZXIgcHJlY2lzaW9uPyAq
LwotCQlpZiAocmV0ID09IC1FVElNRSAmJiBhcmdzLT50aW1lb3V0X25zKQotCQkJcmV0ID0gLUVB
R0FJTjsKLQl9Ci0KLQlpOTE1X2dlbV9vYmplY3RfcHV0KG9iaik7Ci0JcmV0dXJuIHJldDsKLX0K
LQogc3RhdGljIGludCB3YWl0X2Zvcl9lbmdpbmVzKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpp
OTE1KQogewogCWlmICh3YWl0X2ZvcihpbnRlbF9lbmdpbmVzX2FyZV9pZGxlKGk5MTUpLCBJOTE1
X0lETEVfRU5HSU5FU19USU1FT1VUKSkgewpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvaTkxNV91dGlscy5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV91dGlscy5oCmluZGV4
IGVkZmM2OWFjZGFhYy4uOTkxMWY1MzM4MmE1IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9pOTE1X3V0aWxzLmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV91dGlscy5o
CkBAIC0yMTgsMTYgKzIxOCw2IEBAIHN0YXRpYyBpbmxpbmUgdW5zaWduZWQgbG9uZyBtc2Vjc190
b19qaWZmaWVzX3RpbWVvdXQoY29uc3QgdW5zaWduZWQgaW50IG0pCiAJcmV0dXJuIG1pbl90KHVu
c2lnbmVkIGxvbmcsIE1BWF9KSUZGWV9PRkZTRVQsIGogKyAxKTsKIH0KIAotc3RhdGljIGlubGlu
ZSB1bnNpZ25lZCBsb25nIG5zZWNzX3RvX2ppZmZpZXNfdGltZW91dChjb25zdCB1NjQgbikKLXsK
LQkvKiBuc2Vjc190b19qaWZmaWVzNjQoKSBkb2VzIG5vdCBndWFyZCBhZ2FpbnN0IG92ZXJmbG93
ICovCi0JaWYgKE5TRUNfUEVSX1NFQyAlIEhaICYmCi0JICAgIGRpdl91NjQobiwgTlNFQ19QRVJf
U0VDKSA+PSBNQVhfSklGRllfT0ZGU0VUIC8gSFopCi0JCXJldHVybiBNQVhfSklGRllfT0ZGU0VU
OwotCi0gICAgICAgIHJldHVybiBtaW5fdCh1NjQsIE1BWF9KSUZGWV9PRkZTRVQsIG5zZWNzX3Rv
X2ppZmZpZXM2NChuKSArIDEpOwotfQotCiAvKgogICogSWYgeW91IG5lZWQgdG8gd2FpdCBYIG1p
bGxpc2Vjb25kcyBiZXR3ZWVuIGV2ZW50cyBBIGFuZCBCLCBidXQgZXZlbnQgQgogICogZG9lc24n
dCBoYXBwZW4gZXhhY3RseSBhZnRlciBldmVudCBBLCB5b3UgcmVjb3JkIHRoZSB0aW1lc3RhbXAg
KGppZmZpZXMpIG9mCi0tIAoyLjIwLjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZy
ZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3Rp
bmZvL2ludGVsLWdmeA==

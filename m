Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 9CEA96B120
	for <lists+intel-gfx@lfdr.de>; Tue, 16 Jul 2019 23:34:51 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 076096E069;
	Tue, 16 Jul 2019 21:34:50 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 1D4A56E069
 for <intel-gfx@lists.freedesktop.org>; Tue, 16 Jul 2019 21:34:47 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17353843-1500050 
 for <intel-gfx@lists.freedesktop.org>; Tue, 16 Jul 2019 22:34:44 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Tue, 16 Jul 2019 22:34:43 +0100
Message-Id: <20190716213443.9874-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.22.0
MIME-Version: 1.0
Subject: [Intel-gfx] [CI] drm/i915/oa: Reconfigure contexts on the fly
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

QXZvaWQgYSBnbG9iYWwgaWRsZSBiYXJyaWVyIGJ5IHJlY29uZmlndXJpbmcgZWFjaCBjb250ZXh0
IGJ5IHJld3JpdGluZwp0aGVtIHdpdGggTUlfU1RPUkVfRFdPUkQgZnJvbSB0aGUga2VybmVsIGNv
bnRleHQuCgp2MjogV2Ugb25seSBuZWVkIHRvIGRldGVybWluZSB0aGUgZGVzaXJlZCByZWdpc3Rl
ciB2YWx1ZXMgb25jZSwgdGhleSBhcmUKdGhlIHNhbWUgZm9yIGFsbCBjb250ZXh0cy4KdjM6IERv
bid0IHJlbW92ZSB0aGUga2VybmVsIGNvbnRleHQgZnJvbSB0aGUgbGlzdCBvZiBrbm93biBHRU0g
Y29udGV4dHM7CnRoZSB3b3JsZCBpcyBub3QgcmVhZHkgZm9yIHRoYXQgeWV0LgoKU2lnbmVkLW9m
Zi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28udWs+CkNjOiBMaW9uZWwg
TGFuZHdlcmxpbiA8bGlvbmVsLmcubGFuZHdlcmxpbkBpbnRlbC5jb20+CkNjOiBUdnJ0a28gVXJz
dWxpbiA8dHZydGtvLnVyc3VsaW5AaW50ZWwuY29tPgpSZXZpZXdlZC1ieTogTGlvbmVsIExhbmR3
ZXJsaW4gPGxpb25lbC5nLmxhbmR3ZXJsaW5AaW50ZWwuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2dlbS9pOTE1X2dlbV9jb250ZXh0LmMgfCAgMjMgKy0KIGRyaXZlcnMvZ3B1L2RybS9p
OTE1L2d0L2ludGVsX2NvbnRleHQuYyAgICAgfCAgMjUgKysKIGRyaXZlcnMvZ3B1L2RybS9pOTE1
L2d0L2ludGVsX2NvbnRleHQuaCAgICAgfCAgIDMgKwogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Qv
aW50ZWxfbHJjLmMgICAgICAgICB8ICAgNyArLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9w
ZXJmLmMgICAgICAgICAgICB8IDI0MyArKysrKysrKysrKysrKystLS0tLQogNSBmaWxlcyBjaGFu
Z2VkLCAyMjEgaW5zZXJ0aW9ucygrKSwgODAgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRleHQuYyBiL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2dlbS9pOTE1X2dlbV9jb250ZXh0LmMKaW5kZXggYzVmOGJmYTNmN2IwLi5mZmI1OWQ5
NmQ0ZDggMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jb250
ZXh0LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRleHQuYwpA
QCAtMTE3MywyNiArMTE3MywxMSBAQCBnZW44X21vZGlmeV9ycGNzKHN0cnVjdCBpbnRlbF9jb250
ZXh0ICpjZSwgc3RydWN0IGludGVsX3NzZXUgc3NldSkKIAlpZiAoSVNfRVJSKHJxKSkKIAkJcmV0
dXJuIFBUUl9FUlIocnEpOwogCi0JLyogUXVldWUgdGhpcyBzd2l0Y2ggYWZ0ZXIgYWxsIG90aGVy
IGFjdGl2aXR5IGJ5IHRoaXMgY29udGV4dC4gKi8KLQlyZXQgPSBpOTE1X2FjdGl2ZV9yZXF1ZXN0
X3NldCgmY2UtPnJpbmctPnRpbWVsaW5lLT5sYXN0X3JlcXVlc3QsIHJxKTsKLQlpZiAocmV0KQot
CQlnb3RvIG91dF9hZGQ7Ci0KLQkvKgotCSAqIEd1YXJhbnRlZSBjb250ZXh0IGltYWdlIGFuZCB0
aGUgdGltZWxpbmUgcmVtYWlucyBwaW5uZWQgdW50aWwgdGhlCi0JICogbW9kaWZ5aW5nIHJlcXVl
c3QgaXMgcmV0aXJlZCBieSBzZXR0aW5nIHRoZSBjZSBhY3Rpdml0eSB0cmFja2VyLgotCSAqCi0J
ICogQnV0IHdlIG9ubHkgbmVlZCB0byB0YWtlIG9uZSBwaW4gb24gdGhlIGFjY291bnQgb2YgaXQu
IE9yIGluIG90aGVyCi0JICogd29yZHMgdHJhbnNmZXIgdGhlIHBpbm5lZCBjZSBvYmplY3QgdG8g
dHJhY2tlZCBhY3RpdmUgcmVxdWVzdC4KLQkgKi8KLQlHRU1fQlVHX09OKGk5MTVfYWN0aXZlX2lz
X2lkbGUoJmNlLT5hY3RpdmUpKTsKLQlyZXQgPSBpOTE1X2FjdGl2ZV9yZWYoJmNlLT5hY3RpdmUs
IHJxLT5mZW5jZS5jb250ZXh0LCBycSk7Ci0JaWYgKHJldCkKLQkJZ290byBvdXRfYWRkOwotCi0J
cmV0ID0gZ2VuOF9lbWl0X3JwY3NfY29uZmlnKHJxLCBjZSwgc3NldSk7CisJLyogU2VyaWFsaXNl
IHdpdGggdGhlIHJlbW90ZSBjb250ZXh0ICovCisJcmV0ID0gaW50ZWxfY29udGV4dF9wcmVwYXJl
X3JlbW90ZV9yZXF1ZXN0KGNlLCBycSk7CisJaWYgKHJldCA9PSAwKQorCQlyZXQgPSBnZW44X2Vt
aXRfcnBjc19jb25maWcocnEsIGNlLCBzc2V1KTsKIAotb3V0X2FkZDoKIAlpOTE1X3JlcXVlc3Rf
YWRkKHJxKTsKIAlyZXR1cm4gcmV0OwogfQpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ3QvaW50ZWxfY29udGV4dC5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfY29u
dGV4dC5jCmluZGV4IDExMTBmYzhmNjU3YS4uYjY2N2UyYjM1ODA0IDEwMDY0NAotLS0gYS9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9jb250ZXh0LmMKKysrIGIvZHJpdmVycy9ncHUvZHJt
L2k5MTUvZ3QvaW50ZWxfY29udGV4dC5jCkBAIC0yMzksNiArMjM5LDMxIEBAIHZvaWQgaW50ZWxf
Y29udGV4dF9leGl0X2VuZ2luZShzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UpCiAJaW50ZWxfZW5n
aW5lX3BtX3B1dChjZS0+ZW5naW5lKTsKIH0KIAoraW50IGludGVsX2NvbnRleHRfcHJlcGFyZV9y
ZW1vdGVfcmVxdWVzdChzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UsCisJCQkJCSBzdHJ1Y3QgaTkx
NV9yZXF1ZXN0ICpycSkKK3sKKwlzdHJ1Y3QgaW50ZWxfdGltZWxpbmUgKnRsID0gY2UtPnJpbmct
PnRpbWVsaW5lOworCWludCBlcnI7CisKKwkvKiBPbmx5IHN1aXRhYmxlIGZvciB1c2UgaW4gcmVt
b3RlbHkgbW9kaWZ5aW5nIHRoaXMgY29udGV4dCAqLworCUdFTV9CVUdfT04ocnEtPmh3X2NvbnRl
eHQgPT0gY2UpOworCisJLyogUXVldWUgdGhpcyBzd2l0Y2ggYWZ0ZXIgYWxsIG90aGVyIGFjdGl2
aXR5IGJ5IHRoaXMgY29udGV4dC4gKi8KKwllcnIgPSBpOTE1X2FjdGl2ZV9yZXF1ZXN0X3NldCgm
dGwtPmxhc3RfcmVxdWVzdCwgcnEpOworCWlmIChlcnIpCisJCXJldHVybiBlcnI7CisKKwkvKgor
CSAqIEd1YXJhbnRlZSBjb250ZXh0IGltYWdlIGFuZCB0aGUgdGltZWxpbmUgcmVtYWlucyBwaW5u
ZWQgdW50aWwgdGhlCisJICogbW9kaWZ5aW5nIHJlcXVlc3QgaXMgcmV0aXJlZCBieSBzZXR0aW5n
IHRoZSBjZSBhY3Rpdml0eSB0cmFja2VyLgorCSAqCisJICogQnV0IHdlIG9ubHkgbmVlZCB0byB0
YWtlIG9uZSBwaW4gb24gdGhlIGFjY291bnQgb2YgaXQuIE9yIGluIG90aGVyCisJICogd29yZHMg
dHJhbnNmZXIgdGhlIHBpbm5lZCBjZSBvYmplY3QgdG8gdHJhY2tlZCBhY3RpdmUgcmVxdWVzdC4K
KwkgKi8KKwlHRU1fQlVHX09OKGk5MTVfYWN0aXZlX2lzX2lkbGUoJmNlLT5hY3RpdmUpKTsKKwly
ZXR1cm4gaTkxNV9hY3RpdmVfcmVmKCZjZS0+YWN0aXZlLCBycS0+ZmVuY2UuY29udGV4dCwgcnEp
OworfQorCiBzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICppbnRlbF9jb250ZXh0X2NyZWF0ZV9yZXF1ZXN0
KHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSkKIHsKIAlzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycTsK
ZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2NvbnRleHQuaCBiL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2NvbnRleHQuaAppbmRleCA0MGNkODMyMGZjYzMu
LmI0MWM2MTBjMmNlNiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxf
Y29udGV4dC5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2NvbnRleHQuaApA
QCAtMTM5LDYgKzEzOSw5IEBAIHN0YXRpYyBpbmxpbmUgdm9pZCBpbnRlbF9jb250ZXh0X3RpbWVs
aW5lX3VubG9jayhzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UpCiAJbXV0ZXhfdW5sb2NrKCZjZS0+
cmluZy0+dGltZWxpbmUtPm11dGV4KTsKIH0KIAoraW50IGludGVsX2NvbnRleHRfcHJlcGFyZV9y
ZW1vdGVfcmVxdWVzdChzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UsCisJCQkJCSBzdHJ1Y3QgaTkx
NV9yZXF1ZXN0ICpycSk7CisKIHN0cnVjdCBpOTE1X3JlcXVlc3QgKmludGVsX2NvbnRleHRfY3Jl
YXRlX3JlcXVlc3Qoc3RydWN0IGludGVsX2NvbnRleHQgKmNlKTsKIAogI2VuZGlmIC8qIF9fSU5U
RUxfQ09OVEVYVF9IX18gKi8KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2lu
dGVsX2xyYy5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjLmMKaW5kZXggYTIy
MDU3NWE2OWJjLi5mMzVhNTdkNmQzNGEgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2d0L2ludGVsX2xyYy5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2xyYy5j
CkBAIC0xNTc2LDkgKzE1NzYsMTIgQEAgX19leGVjbGlzdHNfdXBkYXRlX3JlZ19zdGF0ZShzdHJ1
Y3QgaW50ZWxfY29udGV4dCAqY2UsCiAJcmVnc1tDVFhfUklOR19UQUlMICsgMV0gPSByaW5nLT50
YWlsOwogCiAJLyogUlBDUyAqLwotCWlmIChlbmdpbmUtPmNsYXNzID09IFJFTkRFUl9DTEFTUykK
KwlpZiAoZW5naW5lLT5jbGFzcyA9PSBSRU5ERVJfQ0xBU1MpIHsKIAkJcmVnc1tDVFhfUl9QV1Jf
Q0xLX1NUQVRFICsgMV0gPQogCQkJaW50ZWxfc3NldV9tYWtlX3JwY3MoZW5naW5lLT5pOTE1LCAm
Y2UtPnNzZXUpOworCisJCWk5MTVfb2FfaW5pdF9yZWdfc3RhdGUoZW5naW5lLCBjZSwgcmVncyk7
CisJfQogfQogCiBzdGF0aWMgaW50CkBAIC0zMDAxLDggKzMwMDQsNiBAQCBzdGF0aWMgdm9pZCBl
eGVjbGlzdHNfaW5pdF9yZWdfc3RhdGUodTMyICpyZWdzLAogCWlmIChyY3MpIHsKIAkJcmVnc1tD
VFhfTFJJX0hFQURFUl8yXSA9IE1JX0xPQURfUkVHSVNURVJfSU1NKDEpOwogCQlDVFhfUkVHKHJl
Z3MsIENUWF9SX1BXUl9DTEtfU1RBVEUsIEdFTjhfUl9QV1JfQ0xLX1NUQVRFLCAwKTsKLQotCQlp
OTE1X29hX2luaXRfcmVnX3N0YXRlKGVuZ2luZSwgY2UsIHJlZ3MpOwogCX0KIAogCXJlZ3NbQ1RY
X0VORF0gPSBNSV9CQVRDSF9CVUZGRVJfRU5EOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJt
L2k5MTUvaTkxNV9wZXJmLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3BlcmYuYwppbmRl
eCAwMDc4MjZkZWQ5YjMuLmFiODJjY2JhODk2YiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJt
L2k5MTUvaTkxNV9wZXJmLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wZXJmLmMK
QEAgLTE2MzYsNiArMTYzNiwyNyBAQCBzdGF0aWMgdm9pZCBoc3dfZGlzYWJsZV9tZXRyaWNfc2V0
KHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdikKIAkJCQkgICAgICB+R1RfTk9BX0VO
QUJMRSkpOwogfQogCitzdGF0aWMgdTMyIG9hX2NvbmZpZ19mbGV4X3JlZyhjb25zdCBzdHJ1Y3Qg
aTkxNV9vYV9jb25maWcgKm9hX2NvbmZpZywKKwkJCSAgICAgIGk5MTVfcmVnX3QgcmVnKQorewor
CXUzMiBtbWlvID0gaTkxNV9tbWlvX3JlZ19vZmZzZXQocmVnKTsKKwlpbnQgaTsKKworCS8qCisJ
ICogVGhpcyBhcmJpdHJhcnkgZGVmYXVsdCB3aWxsIHNlbGVjdCB0aGUgJ0VVIEZQVTAgUGlwZWxp
bmUKKwkgKiBBY3RpdmUnIGV2ZW50LiBJbiB0aGUgZnV0dXJlIGl0J3MgYW50aWNpcGF0ZWQgdGhh
dCB0aGVyZQorCSAqIHdpbGwgYmUgYW4gZXhwbGljaXQgJ05vIEV2ZW50JyB3ZSBjYW4gc2VsZWN0
LCBidXQgbm90IHlldC4uLgorCSAqLworCWlmICghb2FfY29uZmlnKQorCQlyZXR1cm4gMDsKKwor
CWZvciAoaSA9IDA7IGkgPCBvYV9jb25maWctPmZsZXhfcmVnc19sZW47IGkrKykgeworCQlpZiAo
aTkxNV9tbWlvX3JlZ19vZmZzZXQob2FfY29uZmlnLT5mbGV4X3JlZ3NbaV0uYWRkcikgPT0gbW1p
bykKKwkJCXJldHVybiBvYV9jb25maWctPmZsZXhfcmVnc1tpXS52YWx1ZTsKKwl9CisKKwlyZXR1
cm4gMDsKK30KIC8qCiAgKiBOQjogSXQgbXVzdCBhbHdheXMgcmVtYWluIHBvaW50ZXIgc2FmZSB0
byBydW4gdGhpcyBldmVuIGlmIHRoZSBPQSB1bml0CiAgKiBoYXMgYmVlbiBkaXNhYmxlZC4KQEAg
LTE2NjksMjggKzE2OTAsOCBAQCBnZW44X3VwZGF0ZV9yZWdfc3RhdGVfdW5sb2NrZWQoc3RydWN0
IGludGVsX2NvbnRleHQgKmNlLAogCQlHRU44X09BX0NPVU5URVJfUkVTVU1FKTsKIAogCWZvciAo
aSA9IDA7IGkgPCBBUlJBWV9TSVpFKGZsZXhfcmVncyk7IGkrKykgewotCQl1MzIgc3RhdGVfb2Zm
c2V0ID0gY3R4X2ZsZXhldTAgKyBpICogMjsKLQkJdTMyIG1taW8gPSBpOTE1X21taW9fcmVnX29m
ZnNldChmbGV4X3JlZ3NbaV0pOwotCi0JCS8qCi0JCSAqIFRoaXMgYXJiaXRyYXJ5IGRlZmF1bHQg
d2lsbCBzZWxlY3QgdGhlICdFVSBGUFUwIFBpcGVsaW5lCi0JCSAqIEFjdGl2ZScgZXZlbnQuIElu
IHRoZSBmdXR1cmUgaXQncyBhbnRpY2lwYXRlZCB0aGF0IHRoZXJlCi0JCSAqIHdpbGwgYmUgYW4g
ZXhwbGljaXQgJ05vIEV2ZW50JyB3ZSBjYW4gc2VsZWN0LCBidXQgbm90IHlldC4uLgotCQkgKi8K
LQkJdTMyIHZhbHVlID0gMDsKLQotCQlpZiAob2FfY29uZmlnKSB7Ci0JCQl1MzIgajsKLQotCQkJ
Zm9yIChqID0gMDsgaiA8IG9hX2NvbmZpZy0+ZmxleF9yZWdzX2xlbjsgaisrKSB7Ci0JCQkJaWYg
KGk5MTVfbW1pb19yZWdfb2Zmc2V0KG9hX2NvbmZpZy0+ZmxleF9yZWdzW2pdLmFkZHIpID09IG1t
aW8pIHsKLQkJCQkJdmFsdWUgPSBvYV9jb25maWctPmZsZXhfcmVnc1tqXS52YWx1ZTsKLQkJCQkJ
YnJlYWs7Ci0JCQkJfQotCQkJfQotCQl9Ci0KLQkJQ1RYX1JFRyhyZWdfc3RhdGUsIHN0YXRlX29m
ZnNldCwgZmxleF9yZWdzW2ldLCB2YWx1ZSk7CisJCUNUWF9SRUcocmVnX3N0YXRlLCBjdHhfZmxl
eGV1MCArIGkgKiAyLCBmbGV4X3JlZ3NbaV0sCisJCQlvYV9jb25maWdfZmxleF9yZWcob2FfY29u
ZmlnLCBmbGV4X3JlZ3NbaV0pKTsKIAl9CiAKIAlDVFhfUkVHKHJlZ19zdGF0ZSwKQEAgLTE2OTgs
NiArMTY5OSw5OSBAQCBnZW44X3VwZGF0ZV9yZWdfc3RhdGVfdW5sb2NrZWQoc3RydWN0IGludGVs
X2NvbnRleHQgKmNlLAogCQlpbnRlbF9zc2V1X21ha2VfcnBjcyhpOTE1LCAmY2UtPnNzZXUpKTsK
IH0KIAorc3RydWN0IGZsZXggeworCWk5MTVfcmVnX3QgcmVnOworCXUzMiBvZmZzZXQ7CisJdTMy
IHZhbHVlOworfTsKKworc3RhdGljIGludAorZ2VuOF9zdG9yZV9mbGV4KHN0cnVjdCBpOTE1X3Jl
cXVlc3QgKnJxLAorCQlzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UsCisJCWNvbnN0IHN0cnVjdCBm
bGV4ICpmbGV4LCB1bnNpZ25lZCBpbnQgY291bnQpCit7CisJdTMyIG9mZnNldDsKKwl1MzIgKmNz
OworCisJY3MgPSBpbnRlbF9yaW5nX2JlZ2luKHJxLCA0ICogY291bnQpOworCWlmIChJU19FUlIo
Y3MpKQorCQlyZXR1cm4gUFRSX0VSUihjcyk7CisKKwlvZmZzZXQgPSBpOTE1X2dndHRfb2Zmc2V0
KGNlLT5zdGF0ZSkgKyBMUkNfU1RBVEVfUE4gKiBQQUdFX1NJWkU7CisJZG8geworCQkqY3MrKyA9
IE1JX1NUT1JFX0RXT1JEX0lNTV9HRU40IHwgTUlfVVNFX0dHVFQ7CisJCSpjcysrID0gb2Zmc2V0
ICsgKGZsZXgtPm9mZnNldCArIDEpICogc2l6ZW9mKHUzMik7CisJCSpjcysrID0gMDsKKwkJKmNz
KysgPSBmbGV4LT52YWx1ZTsKKwl9IHdoaWxlIChmbGV4KyssIC0tY291bnQpOworCisJaW50ZWxf
cmluZ19hZHZhbmNlKHJxLCBjcyk7CisKKwlyZXR1cm4gMDsKK30KKworc3RhdGljIGludAorZ2Vu
OF9sb2FkX2ZsZXgoc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEsCisJICAgICAgIHN0cnVjdCBpbnRl
bF9jb250ZXh0ICpjZSwKKwkgICAgICAgY29uc3Qgc3RydWN0IGZsZXggKmZsZXgsIHVuc2lnbmVk
IGludCBjb3VudCkKK3sKKwl1MzIgKmNzOworCisJR0VNX0JVR19PTighY291bnQgfHwgY291bnQg
PiA2Myk7CisKKwljcyA9IGludGVsX3JpbmdfYmVnaW4ocnEsIDIgKiBjb3VudCArIDIpOworCWlm
IChJU19FUlIoY3MpKQorCQlyZXR1cm4gUFRSX0VSUihjcyk7CisKKwkqY3MrKyA9IE1JX0xPQURf
UkVHSVNURVJfSU1NKGNvdW50KTsKKwlkbyB7CisJCSpjcysrID0gaTkxNV9tbWlvX3JlZ19vZmZz
ZXQoZmxleC0+cmVnKTsKKwkJKmNzKysgPSBmbGV4LT52YWx1ZTsKKwl9IHdoaWxlIChmbGV4Kyss
IC0tY291bnQpOworCSpjcysrID0gTUlfTk9PUDsKKworCWludGVsX3JpbmdfYWR2YW5jZShycSwg
Y3MpOworCisJcmV0dXJuIDA7Cit9CisKK3N0YXRpYyBpbnQgZ2VuOF9tb2RpZnlfY29udGV4dChz
dHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UsCisJCQkgICAgICAgY29uc3Qgc3RydWN0IGZsZXggKmZs
ZXgsIHVuc2lnbmVkIGludCBjb3VudCkKK3sKKwlzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycTsKKwlp
bnQgZXJyOworCisJbG9ja2RlcF9hc3NlcnRfaGVsZCgmY2UtPnBpbl9tdXRleCk7CisKKwlycSA9
IGk5MTVfcmVxdWVzdF9jcmVhdGUoY2UtPmVuZ2luZS0+a2VybmVsX2NvbnRleHQpOworCWlmIChJ
U19FUlIocnEpKQorCQlyZXR1cm4gUFRSX0VSUihycSk7CisKKwkvKiBTZXJpYWxpc2Ugd2l0aCB0
aGUgcmVtb3RlIGNvbnRleHQgKi8KKwllcnIgPSBpbnRlbF9jb250ZXh0X3ByZXBhcmVfcmVtb3Rl
X3JlcXVlc3QoY2UsIHJxKTsKKwlpZiAoZXJyID09IDApCisJCWVyciA9IGdlbjhfc3RvcmVfZmxl
eChycSwgY2UsIGZsZXgsIGNvdW50KTsKKworCWk5MTVfcmVxdWVzdF9hZGQocnEpOworCXJldHVy
biBlcnI7Cit9CisKK3N0YXRpYyBpbnQgZ2VuOF9tb2RpZnlfc2VsZihzdHJ1Y3QgaW50ZWxfY29u
dGV4dCAqY2UsCisJCQkgICAgY29uc3Qgc3RydWN0IGZsZXggKmZsZXgsIHVuc2lnbmVkIGludCBj
b3VudCkKK3sKKwlzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycTsKKwlpbnQgZXJyOworCisJcnEgPSBp
OTE1X3JlcXVlc3RfY3JlYXRlKGNlKTsKKwlpZiAoSVNfRVJSKHJxKSkKKwkJcmV0dXJuIFBUUl9F
UlIocnEpOworCisJZXJyID0gZ2VuOF9sb2FkX2ZsZXgocnEsIGNlLCBmbGV4LCBjb3VudCk7CisK
KwlpOTE1X3JlcXVlc3RfYWRkKHJxKTsKKwlyZXR1cm4gZXJyOworfQorCiAvKgogICogTWFuYWdl
cyB1cGRhdGluZyB0aGUgcGVyLWNvbnRleHQgYXNwZWN0cyBvZiB0aGUgT0Egc3RyZWFtCiAgKiBj
b25maWd1cmF0aW9uIGFjcm9zcyBhbGwgY29udGV4dHMuCkBAIC0xNzIyLDE1ICsxODE2LDQzIEBA
IGdlbjhfdXBkYXRlX3JlZ19zdGF0ZV91bmxvY2tlZChzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2Us
CiAgKgogICogTm90ZTogaXQncyBvbmx5IHRoZSBSQ1MvUmVuZGVyIGNvbnRleHQgdGhhdCBoYXMg
YW55IE9BIHN0YXRlLgogICovCi1zdGF0aWMgaW50IGdlbjhfY29uZmlndXJlX2FsbF9jb250ZXh0
cyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYsCitzdGF0aWMgaW50IGdlbjhfY29u
ZmlndXJlX2FsbF9jb250ZXh0cyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSwKIAkJCQkg
ICAgICAgY29uc3Qgc3RydWN0IGk5MTVfb2FfY29uZmlnICpvYV9jb25maWcpCiB7Ci0JdW5zaWdu
ZWQgaW50IG1hcF90eXBlID0gaTkxNV9jb2hlcmVudF9tYXBfdHlwZShkZXZfcHJpdik7CisJLyog
VGhlIE1NSU8gb2Zmc2V0cyBmb3IgRmxleCBFVSByZWdpc3RlcnMgYXJlbid0IGNvbnRpZ3VvdXMg
Ki8KKwljb25zdCB1MzIgY3R4X2ZsZXhldTAgPSBpOTE1LT5wZXJmLm9hLmN0eF9mbGV4ZXUwX29m
ZnNldDsKKyNkZWZpbmUgY3R4X2ZsZXhldU4oTikgKGN0eF9mbGV4ZXUwICsgMiAqIChOKSkKKwlz
dHJ1Y3QgZmxleCByZWdzW10gPSB7CisJCXsKKwkJCUdFTjhfUl9QV1JfQ0xLX1NUQVRFLAorCQkJ
Q1RYX1JfUFdSX0NMS19TVEFURSwKKwkJfSwKKwkJeworCQkJR0VOOF9PQUNUWENPTlRST0wsCisJ
CQlpOTE1LT5wZXJmLm9hLmN0eF9vYWN0eGN0cmxfb2Zmc2V0LAorCQkJKChpOTE1LT5wZXJmLm9h
LnBlcmlvZF9leHBvbmVudCA8PCBHRU44X09BX1RJTUVSX1BFUklPRF9TSElGVCkgfAorCQkJIChp
OTE1LT5wZXJmLm9hLnBlcmlvZGljID8gR0VOOF9PQV9USU1FUl9FTkFCTEUgOiAwKSB8CisJCQkg
R0VOOF9PQV9DT1VOVEVSX1JFU1VNRSkKKwkJfSwKKwkJeyBFVV9QRVJGX0NOVEwwLCBjdHhfZmxl
eGV1TigwKSB9LAorCQl7IEVVX1BFUkZfQ05UTDEsIGN0eF9mbGV4ZXVOKDEpIH0sCisJCXsgRVVf
UEVSRl9DTlRMMiwgY3R4X2ZsZXhldU4oMikgfSwKKwkJeyBFVV9QRVJGX0NOVEwzLCBjdHhfZmxl
eGV1TigzKSB9LAorCQl7IEVVX1BFUkZfQ05UTDQsIGN0eF9mbGV4ZXVOKDQpIH0sCisJCXsgRVVf
UEVSRl9DTlRMNSwgY3R4X2ZsZXhldU4oNSkgfSwKKwkJeyBFVV9QRVJGX0NOVEw2LCBjdHhfZmxl
eGV1Tig2KSB9LAorCX07CisjdW5kZWYgY3R4X2ZsZXhldU4KKwlzdHJ1Y3QgaW50ZWxfZW5naW5l
X2NzICplbmdpbmU7CiAJc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eDsKLQlzdHJ1Y3QgaTkx
NV9yZXF1ZXN0ICpycTsKLQlpbnQgcmV0OworCWVudW0gaW50ZWxfZW5naW5lX2lkIGlkOworCWlu
dCBlcnI7CisJaW50IGk7CisKKwlmb3IgKGkgPSAyOyBpIDwgQVJSQVlfU0laRShyZWdzKTsgaSsr
KQorCQlyZWdzW2ldLnZhbHVlID0gb2FfY29uZmlnX2ZsZXhfcmVnKG9hX2NvbmZpZywgcmVnc1tp
XS5yZWcpOwogCi0JbG9ja2RlcF9hc3NlcnRfaGVsZCgmZGV2X3ByaXYtPmRybS5zdHJ1Y3RfbXV0
ZXgpOworCWxvY2tkZXBfYXNzZXJ0X2hlbGQoJmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOwogCiAJ
LyoKIAkgKiBUaGUgT0EgcmVnaXN0ZXIgY29uZmlnIGlzIHNldHVwIHRocm91Z2ggdGhlIGNvbnRl
eHQgaW1hZ2UuIFRoaXMgaW1hZ2UKQEAgLTE3NDIsNTggKzE4NjQsNjMgQEAgc3RhdGljIGludCBn
ZW44X2NvbmZpZ3VyZV9hbGxfY29udGV4dHMoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9w
cml2LAogCSAqIHRoaXMgbWlnaHQgbGVhdmUgc21hbGwgaW50ZXJ2YWwgb2YgdGltZSB3aGVyZSB0
aGUgT0EgdW5pdCBpcwogCSAqIGNvbmZpZ3VyZWQgYXQgYW4gaW52YWxpZCBzYW1wbGluZyBwZXJp
b2QuCiAJICoKLQkgKiBTbyBmYXIgdGhlIGJlc3Qgd2F5IHRvIHdvcmsgYXJvdW5kIHRoaXMgaXNz
dWUgc2VlbXMgdG8gYmUgZHJhaW5pbmcKLQkgKiB0aGUgR1BVIGZyb20gYW55IHN1Ym1pdHRlZCB3
b3JrLgorCSAqIE5vdGUgdGhhdCBzaW5jZSB3ZSBlbWl0IGFsbCByZXF1ZXN0cyBmcm9tIGEgc2lu
Z2xlIHJpbmcsIHRoZXJlCisJICogaXMgc3RpbGwgYW4gaW1wbGljaXQgZ2xvYmFsIGJhcnJpZXIg
aGVyZSB0aGF0IG1heSBjYXVzZSBhIGhpZ2gKKwkgKiBwcmlvcml0eSBjb250ZXh0IHRvIHdhaXQg
Zm9yIGFuIG90aGVyd2lzZSBpbmRlcGVuZGVudCBsb3cgcHJpb3JpdHkKKwkgKiBjb250ZXh0LiBD
b250ZXh0cyBpZGxlIGF0IHRoZSB0aW1lIG9mIHJlY29uZmlndXJhdGlvbiBhcmUgbm90CisJICog
dHJhcHBlZCBiZWhpbmQgdGhlIGJhcnJpZXIuCiAJICovCi0JcmV0ID0gaTkxNV9nZW1fd2FpdF9m
b3JfaWRsZShkZXZfcHJpdiwKLQkJCQkgICAgIEk5MTVfV0FJVF9MT0NLRUQsCi0JCQkJICAgICBN
QVhfU0NIRURVTEVfVElNRU9VVCk7Ci0JaWYgKHJldCkKLQkJcmV0dXJuIHJldDsKLQotCS8qIFVw
ZGF0ZSBhbGwgY29udGV4dHMgbm93IHRoYXQgd2UndmUgc3RhbGxlZCB0aGUgc3VibWlzc2lvbi4g
Ki8KLQlsaXN0X2Zvcl9lYWNoX2VudHJ5KGN0eCwgJmRldl9wcml2LT5jb250ZXh0cy5saXN0LCBs
aW5rKSB7CisJbGlzdF9mb3JfZWFjaF9lbnRyeShjdHgsICZpOTE1LT5jb250ZXh0cy5saXN0LCBs
aW5rKSB7CiAJCXN0cnVjdCBpOTE1X2dlbV9lbmdpbmVzX2l0ZXIgaXQ7CiAJCXN0cnVjdCBpbnRl
bF9jb250ZXh0ICpjZTsKIAorCQlpZiAoY3R4ID09IGk5MTUtPmtlcm5lbF9jb250ZXh0KQorCQkJ
Y29udGludWU7CisKIAkJZm9yX2VhY2hfZ2VtX2VuZ2luZShjZSwKIAkJCQkgICAgaTkxNV9nZW1f
Y29udGV4dF9sb2NrX2VuZ2luZXMoY3R4KSwKIAkJCQkgICAgaXQpIHsKLQkJCXUzMiAqcmVnczsK
KwkJCUdFTV9CVUdfT04oY2UgPT0gY2UtPmVuZ2luZS0+a2VybmVsX2NvbnRleHQpOwogCiAJCQlp
ZiAoY2UtPmVuZ2luZS0+Y2xhc3MgIT0gUkVOREVSX0NMQVNTKQogCQkJCWNvbnRpbnVlOwogCi0J
CQkvKiBPQSBzZXR0aW5ncyB3aWxsIGJlIHNldCB1cG9uIGZpcnN0IHVzZSAqLwotCQkJaWYgKCFj
ZS0+c3RhdGUpCi0JCQkJY29udGludWU7Ci0KLQkJCXJlZ3MgPSBpOTE1X2dlbV9vYmplY3RfcGlu
X21hcChjZS0+c3RhdGUtPm9iaiwKLQkJCQkJCSAgICAgICBtYXBfdHlwZSk7Ci0JCQlpZiAoSVNf
RVJSKHJlZ3MpKSB7Ci0JCQkJaTkxNV9nZW1fY29udGV4dF91bmxvY2tfZW5naW5lcyhjdHgpOwot
CQkJCXJldHVybiBQVFJfRVJSKHJlZ3MpOwotCQkJfQorCQkJZXJyID0gaW50ZWxfY29udGV4dF9s
b2NrX3Bpbm5lZChjZSk7CisJCQlpZiAoZXJyKQorCQkJCWJyZWFrOwogCi0JCQljZS0+c3RhdGUt
Pm9iai0+bW0uZGlydHkgPSB0cnVlOwotCQkJcmVncyArPSBMUkNfU1RBVEVfUE4gKiBQQUdFX1NJ
WkUgLyBzaXplb2YoKnJlZ3MpOworCQkJcmVnc1swXS52YWx1ZSA9IGludGVsX3NzZXVfbWFrZV9y
cGNzKGk5MTUsICZjZS0+c3NldSk7CiAKLQkJCWdlbjhfdXBkYXRlX3JlZ19zdGF0ZV91bmxvY2tl
ZChjZSwgcmVncywgb2FfY29uZmlnKTsKKwkJCS8qIE90aGVyd2lzZSBPQSBzZXR0aW5ncyB3aWxs
IGJlIHNldCB1cG9uIGZpcnN0IHVzZSAqLworCQkJaWYgKGludGVsX2NvbnRleHRfaXNfcGlubmVk
KGNlKSkKKwkJCQllcnIgPSBnZW44X21vZGlmeV9jb250ZXh0KGNlLCByZWdzLCBBUlJBWV9TSVpF
KHJlZ3MpKTsKIAotCQkJaTkxNV9nZW1fb2JqZWN0X3VucGluX21hcChjZS0+c3RhdGUtPm9iaik7
CisJCQlpbnRlbF9jb250ZXh0X3VubG9ja19waW5uZWQoY2UpOworCQkJaWYgKGVycikKKwkJCQli
cmVhazsKIAkJfQogCQlpOTE1X2dlbV9jb250ZXh0X3VubG9ja19lbmdpbmVzKGN0eCk7CisJCWlm
IChlcnIpCisJCQlyZXR1cm4gZXJyOwogCX0KIAogCS8qCi0JICogQXBwbHkgdGhlIGNvbmZpZ3Vy
YXRpb24gYnkgZG9pbmcgb25lIGNvbnRleHQgcmVzdG9yZSBvZiB0aGUgZWRpdGVkCi0JICogY29u
dGV4dCBpbWFnZS4KKwkgKiBBZnRlciB1cGRhdGluZyBhbGwgb3RoZXIgY29udGV4dHMsIHdlIG5l
ZWQgdG8gbW9kaWZ5IG91cnNlbHZlcy4KKwkgKiBJZiB3ZSBkb24ndCBtb2RpZnkgdGhlIGtlcm5l
bF9jb250ZXh0LCB3ZSBkbyBub3QgZ2V0IGV2ZW50cyB3aGlsZQorCSAqIGlkbGUuCiAJICovCi0J
cnEgPSBpOTE1X3JlcXVlc3RfY3JlYXRlKGRldl9wcml2LT5lbmdpbmVbUkNTMF0tPmtlcm5lbF9j
b250ZXh0KTsKLQlpZiAoSVNfRVJSKHJxKSkKLQkJcmV0dXJuIFBUUl9FUlIocnEpOworCWZvcl9l
YWNoX2VuZ2luZShlbmdpbmUsIGk5MTUsIGlkKSB7CisJCXN0cnVjdCBpbnRlbF9jb250ZXh0ICpj
ZSA9IGVuZ2luZS0+a2VybmVsX2NvbnRleHQ7CiAKLQlpOTE1X3JlcXVlc3RfYWRkKHJxKTsKKwkJ
aWYgKGVuZ2luZS0+Y2xhc3MgIT0gUkVOREVSX0NMQVNTKQorCQkJY29udGludWU7CisKKwkJcmVn
c1swXS52YWx1ZSA9IGludGVsX3NzZXVfbWFrZV9ycGNzKGk5MTUsICZjZS0+c3NldSk7CisKKwkJ
ZXJyID0gZ2VuOF9tb2RpZnlfc2VsZihjZSwgcmVncywgQVJSQVlfU0laRShyZWdzKSk7CisJCWlm
IChlcnIpCisJCQlyZXR1cm4gZXJyOworCX0KIAogCXJldHVybiAwOwogfQotLSAKMi4yMi4wCgpf
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpJbnRlbC1nZngg
bWFpbGluZyBsaXN0CkludGVsLWdmeEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0
cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9pbnRlbC1nZng=

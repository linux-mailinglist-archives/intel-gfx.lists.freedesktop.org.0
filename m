Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 6DDF524A154
	for <lists+intel-gfx@lfdr.de>; Wed, 19 Aug 2020 16:09:31 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id F16EC6E408;
	Wed, 19 Aug 2020 14:09:17 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mblankhorst.nl (mblankhorst.nl [141.105.120.124])
 by gabe.freedesktop.org (Postfix) with ESMTPS id DF09F6E3AC
 for <intel-gfx@lists.freedesktop.org>; Wed, 19 Aug 2020 14:09:13 +0000 (UTC)
From: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
To: intel-gfx@lists.freedesktop.org
Date: Wed, 19 Aug 2020 16:09:01 +0200
Message-Id: <20200819140904.1708856-22-maarten.lankhorst@linux.intel.com>
X-Mailer: git-send-email 2.28.0
In-Reply-To: <20200819140904.1708856-1-maarten.lankhorst@linux.intel.com>
References: <20200819140904.1708856-1-maarten.lankhorst@linux.intel.com>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v2 21/24] drm/i915: Move i915_vma_lock in the
 selftests to avoid lock inversion, v3.
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: =?UTF-8?q?Thomas=20Hellstr=C3=B6m?= <thomas.hellstrom@intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

TWFrZSBzdXJlIHZtYV9sb2NrIGlzIG5vdCB1c2VkIGFzIGlubmVyIGxvY2sgd2hlbiBrZXJuZWwg
Y29udGV4dCBpcyB1c2VkLAphbmQgYWRkIHd3IGhhbmRsaW5nIHdoZXJlIGFwcHJvcHJpYXRlLgoK
RW5zdXJlIHRoYXQgZXhlY2J1ZiBzZWxmdGVzdHMga2VlcCBwYXNzaW5nIGJ5IHVzaW5nIHd3IGhh
bmRsaW5nLgoKQ2hhbmdlcyBzaW5jZSB2MjoKLSBGaXggaTkxNV9nZW1fY29udGV4dCBmaW5hbGx5
LgoKU2lnbmVkLW9mZi1ieTogTWFhcnRlbiBMYW5raG9yc3QgPG1hYXJ0ZW4ubGFua2hvcnN0QGxp
bnV4LmludGVsLmNvbT4KUmV2aWV3ZWQtYnk6IFRob21hcyBIZWxsc3Ryw7ZtIDx0aG9tYXMuaGVs
bHN0cm9tQGludGVsLmNvbT4KLS0tCiAuLi4vaTkxNS9nZW0vc2VsZnRlc3RzL2k5MTVfZ2VtX2Nv
aGVyZW5jeS5jICAgfCAgMjYgKysrLS0KIC4uLi9kcm0vaTkxNS9nZW0vc2VsZnRlc3RzL2k5MTVf
Z2VtX2NvbnRleHQuYyB8IDEwNiArKysrKysrKystLS0tLS0tLS0KIC4uLi9kcm0vaTkxNS9nZW0v
c2VsZnRlc3RzL2k5MTVfZ2VtX21tYW4uYyAgICB8ICA0MSArKysrKy0tCiBkcml2ZXJzL2dwdS9k
cm0vaTkxNS9ndC9zZWxmdGVzdF9ycHMuYyAgICAgICAgfCAgMzAgKysrLS0KIGRyaXZlcnMvZ3B1
L2RybS9pOTE1L3NlbGZ0ZXN0cy9pOTE1X3JlcXVlc3QuYyB8ICAxOCArKy0KIDUgZmlsZXMgY2hh
bmdlZCwgMTI1IGluc2VydGlvbnMoKyksIDk2IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMvaTkxNV9nZW1fY29oZXJlbmN5LmMgYi9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vc2VsZnRlc3RzL2k5MTVfZ2VtX2NvaGVyZW5jeS5jCmlu
ZGV4IGRjZGZjMzk2ZjJmOC4uNzA0OWE2YmJjMDNkIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9nZW0vc2VsZnRlc3RzL2k5MTVfZ2VtX2NvaGVyZW5jeS5jCisrKyBiL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMvaTkxNV9nZW1fY29oZXJlbmN5LmMKQEAgLTIwMSwy
NSArMjAxLDI1IEBAIHN0YXRpYyBpbnQgZ3B1X3NldChzdHJ1Y3QgY29udGV4dCAqY3R4LCB1bnNp
Z25lZCBsb25nIG9mZnNldCwgdTMyIHYpCiAKIAlpOTE1X2dlbV9vYmplY3RfbG9jayhjdHgtPm9i
aiwgTlVMTCk7CiAJZXJyID0gaTkxNV9nZW1fb2JqZWN0X3NldF90b19ndHRfZG9tYWluKGN0eC0+
b2JqLCB0cnVlKTsKLQlpOTE1X2dlbV9vYmplY3RfdW5sb2NrKGN0eC0+b2JqKTsKIAlpZiAoZXJy
KQotCQlyZXR1cm4gZXJyOworCQlnb3RvIG91dF91bmxvY2s7CiAKIAl2bWEgPSBpOTE1X2dlbV9v
YmplY3RfZ2d0dF9waW4oY3R4LT5vYmosIE5VTEwsIDAsIDAsIDApOwotCWlmIChJU19FUlIodm1h
KSkKLQkJcmV0dXJuIFBUUl9FUlIodm1hKTsKKwlpZiAoSVNfRVJSKHZtYSkpIHsKKwkJZXJyID0g
UFRSX0VSUih2bWEpOworCQlnb3RvIG91dF91bmxvY2s7CisJfQogCiAJcnEgPSBpbnRlbF9lbmdp
bmVfY3JlYXRlX2tlcm5lbF9yZXF1ZXN0KGN0eC0+ZW5naW5lKTsKIAlpZiAoSVNfRVJSKHJxKSkg
ewotCQlpOTE1X3ZtYV91bnBpbih2bWEpOwotCQlyZXR1cm4gUFRSX0VSUihycSk7CisJCWVyciA9
IFBUUl9FUlIocnEpOworCQlnb3RvIG91dF91bnBpbjsKIAl9CiAKIAljcyA9IGludGVsX3Jpbmdf
YmVnaW4ocnEsIDQpOwogCWlmIChJU19FUlIoY3MpKSB7Ci0JCWk5MTVfcmVxdWVzdF9hZGQocnEp
OwotCQlpOTE1X3ZtYV91bnBpbih2bWEpOwotCQlyZXR1cm4gUFRSX0VSUihjcyk7CisJCWVyciA9
IFBUUl9FUlIoY3MpOworCQlnb3RvIG91dF9ycTsKIAl9CiAKIAlpZiAoSU5URUxfR0VOKGN0eC0+
ZW5naW5lLT5pOTE1KSA+PSA4KSB7CkBAIC0yNDAsMTQgKzI0MCwxNiBAQCBzdGF0aWMgaW50IGdw
dV9zZXQoc3RydWN0IGNvbnRleHQgKmN0eCwgdW5zaWduZWQgbG9uZyBvZmZzZXQsIHUzMiB2KQog
CX0KIAlpbnRlbF9yaW5nX2FkdmFuY2UocnEsIGNzKTsKIAotCWk5MTVfdm1hX2xvY2sodm1hKTsK
IAllcnIgPSBpOTE1X3JlcXVlc3RfYXdhaXRfb2JqZWN0KHJxLCB2bWEtPm9iaiwgdHJ1ZSk7CiAJ
aWYgKGVyciA9PSAwKQogCQllcnIgPSBpOTE1X3ZtYV9tb3ZlX3RvX2FjdGl2ZSh2bWEsIHJxLCBF
WEVDX09CSkVDVF9XUklURSk7Ci0JaTkxNV92bWFfdW5sb2NrKHZtYSk7Ci0JaTkxNV92bWFfdW5w
aW4odm1hKTsKIAorb3V0X3JxOgogCWk5MTVfcmVxdWVzdF9hZGQocnEpOworb3V0X3VucGluOgor
CWk5MTVfdm1hX3VucGluKHZtYSk7CitvdXRfdW5sb2NrOgorCWk5MTVfZ2VtX29iamVjdF91bmxv
Y2soY3R4LT5vYmopOwogCiAJcmV0dXJuIGVycjsKIH0KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMvaTkxNV9nZW1fY29udGV4dC5jIGIvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvZ2VtL3NlbGZ0ZXN0cy9pOTE1X2dlbV9jb250ZXh0LmMKaW5kZXggZmE0MDAwNmI0
NTNhLi45OWJlY2I4NmFiZDMgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9z
ZWxmdGVzdHMvaTkxNV9nZW1fY29udGV4dC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dl
bS9zZWxmdGVzdHMvaTkxNV9nZW1fY29udGV4dC5jCkBAIC04OTMsMjQgKzg5MywxNSBAQCBzdGF0
aWMgaW50IGlndF9zaGFyZWRfY3R4X2V4ZWModm9pZCAqYXJnKQogCXJldHVybiBlcnI7CiB9CiAK
LXN0YXRpYyBzdHJ1Y3QgaTkxNV92bWEgKnJwY3NfcXVlcnlfYmF0Y2goc3RydWN0IGk5MTVfdm1h
ICp2bWEpCitzdGF0aWMgaW50IHJwY3NfcXVlcnlfYmF0Y2goc3RydWN0IGRybV9pOTE1X2dlbV9v
YmplY3QgKnJwY3MsIHN0cnVjdCBpOTE1X3ZtYSAqdm1hKQogewotCXN0cnVjdCBkcm1faTkxNV9n
ZW1fb2JqZWN0ICpvYmo7CiAJdTMyICpjbWQ7Ci0JaW50IGVycjsKIAotCWlmIChJTlRFTF9HRU4o
dm1hLT52bS0+aTkxNSkgPCA4KQotCQlyZXR1cm4gRVJSX1BUUigtRUlOVkFMKTsKKwlHRU1fQlVH
X09OKElOVEVMX0dFTih2bWEtPnZtLT5pOTE1KSA8IDgpOwogCi0Jb2JqID0gaTkxNV9nZW1fb2Jq
ZWN0X2NyZWF0ZV9pbnRlcm5hbCh2bWEtPnZtLT5pOTE1LCBQQUdFX1NJWkUpOwotCWlmIChJU19F
UlIob2JqKSkKLQkJcmV0dXJuIEVSUl9DQVNUKG9iaik7Ci0KLQljbWQgPSBpOTE1X2dlbV9vYmpl
Y3RfcGluX21hcChvYmosIEk5MTVfTUFQX1dCKTsKLQlpZiAoSVNfRVJSKGNtZCkpIHsKLQkJZXJy
ID0gUFRSX0VSUihjbWQpOwotCQlnb3RvIGVycjsKLQl9CisJY21kID0gaTkxNV9nZW1fb2JqZWN0
X3Bpbl9tYXAocnBjcywgSTkxNV9NQVBfV0IpOworCWlmIChJU19FUlIoY21kKSkKKwkJcmV0dXJu
IFBUUl9FUlIoY21kKTsKIAogCSpjbWQrKyA9IE1JX1NUT1JFX1JFR0lTVEVSX01FTV9HRU44Owog
CSpjbWQrKyA9IGk5MTVfbW1pb19yZWdfb2Zmc2V0KEdFTjhfUl9QV1JfQ0xLX1NUQVRFKTsKQEAg
LTkxOCwyNiArOTA5LDEyIEBAIHN0YXRpYyBzdHJ1Y3QgaTkxNV92bWEgKnJwY3NfcXVlcnlfYmF0
Y2goc3RydWN0IGk5MTVfdm1hICp2bWEpCiAJKmNtZCsrID0gdXBwZXJfMzJfYml0cyh2bWEtPm5v
ZGUuc3RhcnQpOwogCSpjbWQgPSBNSV9CQVRDSF9CVUZGRVJfRU5EOwogCi0JX19pOTE1X2dlbV9v
YmplY3RfZmx1c2hfbWFwKG9iaiwgMCwgNjQpOwotCWk5MTVfZ2VtX29iamVjdF91bnBpbl9tYXAo
b2JqKTsKKwlfX2k5MTVfZ2VtX29iamVjdF9mbHVzaF9tYXAocnBjcywgMCwgNjQpOworCWk5MTVf
Z2VtX29iamVjdF91bnBpbl9tYXAocnBjcyk7CiAKIAlpbnRlbF9ndF9jaGlwc2V0X2ZsdXNoKHZt
YS0+dm0tPmd0KTsKIAotCXZtYSA9IGk5MTVfdm1hX2luc3RhbmNlKG9iaiwgdm1hLT52bSwgTlVM
TCk7Ci0JaWYgKElTX0VSUih2bWEpKSB7Ci0JCWVyciA9IFBUUl9FUlIodm1hKTsKLQkJZ290byBl
cnI7Ci0JfQotCi0JZXJyID0gaTkxNV92bWFfcGluKHZtYSwgMCwgMCwgUElOX1VTRVIpOwotCWlm
IChlcnIpCi0JCWdvdG8gZXJyOwotCi0JcmV0dXJuIHZtYTsKLQotZXJyOgotCWk5MTVfZ2VtX29i
amVjdF9wdXQob2JqKTsKLQlyZXR1cm4gRVJSX1BUUihlcnIpOworCXJldHVybiAwOwogfQogCiBz
dGF0aWMgaW50CkBAIC05NDUsNTIgKzkyMiw2OCBAQCBlbWl0X3JwY3NfcXVlcnkoc3RydWN0IGRy
bV9pOTE1X2dlbV9vYmplY3QgKm9iaiwKIAkJc3RydWN0IGludGVsX2NvbnRleHQgKmNlLAogCQlz
dHJ1Y3QgaTkxNV9yZXF1ZXN0ICoqcnFfb3V0KQogeworCXN0cnVjdCBkcm1faTkxNV9wcml2YXRl
ICppOTE1ID0gdG9faTkxNShvYmotPmJhc2UuZGV2KTsKIAlzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpy
cTsKKwlzdHJ1Y3QgaTkxNV9nZW1fd3dfY3R4IHd3OwogCXN0cnVjdCBpOTE1X3ZtYSAqYmF0Y2g7
CiAJc3RydWN0IGk5MTVfdm1hICp2bWE7CisJc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKnJw
Y3M7CiAJaW50IGVycjsKIAogCUdFTV9CVUdfT04oIWludGVsX2VuZ2luZV9jYW5fc3RvcmVfZHdv
cmQoY2UtPmVuZ2luZSkpOwogCisJaWYgKElOVEVMX0dFTihpOTE1KSA8IDgpCisJCXJldHVybiAt
RUlOVkFMOworCiAJdm1hID0gaTkxNV92bWFfaW5zdGFuY2Uob2JqLCBjZS0+dm0sIE5VTEwpOwog
CWlmIChJU19FUlIodm1hKSkKIAkJcmV0dXJuIFBUUl9FUlIodm1hKTsKIAotCWk5MTVfZ2VtX29i
amVjdF9sb2NrKG9iaiwgTlVMTCk7Ci0JZXJyID0gaTkxNV9nZW1fb2JqZWN0X3NldF90b19ndHRf
ZG9tYWluKG9iaiwgZmFsc2UpOwotCWk5MTVfZ2VtX29iamVjdF91bmxvY2sob2JqKTsKLQlpZiAo
ZXJyKQotCQlyZXR1cm4gZXJyOworCXJwY3MgPSBpOTE1X2dlbV9vYmplY3RfY3JlYXRlX2ludGVy
bmFsKGk5MTUsIFBBR0VfU0laRSk7CisJaWYgKElTX0VSUihycGNzKSkKKwkJcmV0dXJuIFBUUl9F
UlIocnBjcyk7CiAKLQllcnIgPSBpOTE1X3ZtYV9waW4odm1hLCAwLCAwLCBQSU5fVVNFUik7Ci0J
aWYgKGVycikKLQkJcmV0dXJuIGVycjsKLQotCWJhdGNoID0gcnBjc19xdWVyeV9iYXRjaCh2bWEp
OworCWJhdGNoID0gaTkxNV92bWFfaW5zdGFuY2UocnBjcywgY2UtPnZtLCBOVUxMKTsKIAlpZiAo
SVNfRVJSKGJhdGNoKSkgewogCQllcnIgPSBQVFJfRVJSKGJhdGNoKTsKLQkJZ290byBlcnJfdm1h
OworCQlnb3RvIGVycl9wdXQ7CiAJfQogCisJaTkxNV9nZW1fd3dfY3R4X2luaXQoJnd3LCBmYWxz
ZSk7CityZXRyeToKKwllcnIgPSBpOTE1X2dlbV9vYmplY3RfbG9jayhvYmosICZ3dyk7CisJaWYg
KCFlcnIpCisJCWVyciA9IGk5MTVfZ2VtX29iamVjdF9sb2NrKHJwY3MsICZ3dyk7CisJaWYgKCFl
cnIpCisJCWVyciA9IGk5MTVfZ2VtX29iamVjdF9zZXRfdG9fZ3R0X2RvbWFpbihvYmosIGZhbHNl
KTsKKwlpZiAoIWVycikKKwkJZXJyID0gaTkxNV92bWFfcGluX3d3KHZtYSwgJnd3LCAwLCAwLCBQ
SU5fVVNFUik7CisJaWYgKGVycikKKwkJZ290byBlcnJfcHV0OworCisJZXJyID0gaTkxNV92bWFf
cGluX3d3KGJhdGNoLCAmd3csIDAsIDAsIFBJTl9VU0VSKTsKKwlpZiAoZXJyKQorCQlnb3RvIGVy
cl92bWE7CisKKwllcnIgPSBycGNzX3F1ZXJ5X2JhdGNoKHJwY3MsIHZtYSk7CisJaWYgKGVycikK
KwkJZ290byBlcnJfYmF0Y2g7CisKIAlycSA9IGk5MTVfcmVxdWVzdF9jcmVhdGUoY2UpOwogCWlm
IChJU19FUlIocnEpKSB7CiAJCWVyciA9IFBUUl9FUlIocnEpOwogCQlnb3RvIGVycl9iYXRjaDsK
IAl9CiAKLQlpOTE1X3ZtYV9sb2NrKGJhdGNoKTsKIAllcnIgPSBpOTE1X3JlcXVlc3RfYXdhaXRf
b2JqZWN0KHJxLCBiYXRjaC0+b2JqLCBmYWxzZSk7CiAJaWYgKGVyciA9PSAwKQogCQllcnIgPSBp
OTE1X3ZtYV9tb3ZlX3RvX2FjdGl2ZShiYXRjaCwgcnEsIDApOwotCWk5MTVfdm1hX3VubG9jayhi
YXRjaCk7CiAJaWYgKGVycikKIAkJZ290byBza2lwX3JlcXVlc3Q7CiAKLQlpOTE1X3ZtYV9sb2Nr
KHZtYSk7CiAJZXJyID0gaTkxNV9yZXF1ZXN0X2F3YWl0X29iamVjdChycSwgdm1hLT5vYmosIHRy
dWUpOwogCWlmIChlcnIgPT0gMCkKIAkJZXJyID0gaTkxNV92bWFfbW92ZV90b19hY3RpdmUodm1h
LCBycSwgRVhFQ19PQkpFQ1RfV1JJVEUpOwotCWk5MTVfdm1hX3VubG9jayh2bWEpOwogCWlmIChl
cnIpCiAJCWdvdG8gc2tpcF9yZXF1ZXN0OwogCkBAIC0xMDA2LDIzICs5OTksMjQgQEAgZW1pdF9y
cGNzX3F1ZXJ5KHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmosCiAJaWYgKGVycikKIAkJ
Z290byBza2lwX3JlcXVlc3Q7CiAKLQlpOTE1X3ZtYV91bnBpbl9hbmRfcmVsZWFzZSgmYmF0Y2gs
IDApOwotCWk5MTVfdm1hX3VucGluKHZtYSk7Ci0KIAkqcnFfb3V0ID0gaTkxNV9yZXF1ZXN0X2dl
dChycSk7CiAKLQlpOTE1X3JlcXVlc3RfYWRkKHJxKTsKLQotCXJldHVybiAwOwotCiBza2lwX3Jl
cXVlc3Q6Ci0JaTkxNV9yZXF1ZXN0X3NldF9lcnJvcl9vbmNlKHJxLCBlcnIpOworCWlmIChlcnIp
CisJCWk5MTVfcmVxdWVzdF9zZXRfZXJyb3Jfb25jZShycSwgZXJyKTsKIAlpOTE1X3JlcXVlc3Rf
YWRkKHJxKTsKIGVycl9iYXRjaDoKLQlpOTE1X3ZtYV91bnBpbl9hbmRfcmVsZWFzZSgmYmF0Y2gs
IDApOworCWk5MTVfdm1hX3VucGluKGJhdGNoKTsKIGVycl92bWE6CiAJaTkxNV92bWFfdW5waW4o
dm1hKTsKLQorZXJyX3B1dDoKKwlpZiAoZXJyID09IC1FREVBRExLKSB7CisJCWVyciA9IGk5MTVf
Z2VtX3d3X2N0eF9iYWNrb2ZmKCZ3dyk7CisJCWlmICghZXJyKQorCQkJZ290byByZXRyeTsKKwl9
CisJaTkxNV9nZW1fd3dfY3R4X2ZpbmkoJnd3KTsKKwlpOTE1X2dlbV9vYmplY3RfcHV0KHJwY3Mp
OwogCXJldHVybiBlcnI7CiB9CiAKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dl
bS9zZWxmdGVzdHMvaTkxNV9nZW1fbW1hbi5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL3Nl
bGZ0ZXN0cy9pOTE1X2dlbV9tbWFuLmMKaW5kZXggOWZiOTVhNDViY2FkLi5kMjdkODdhNjc4Yzgg
MTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMvaTkxNV9nZW1f
bW1hbi5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMvaTkxNV9nZW1f
bW1hbi5jCkBAIC01MjgsMzEgKzUyOCw0MiBAQCBzdGF0aWMgaW50IG1ha2Vfb2JqX2J1c3koc3Ry
dWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaikKIAlmb3JfZWFjaF91YWJpX2VuZ2luZShlbmdp
bmUsIGk5MTUpIHsKIAkJc3RydWN0IGk5MTVfcmVxdWVzdCAqcnE7CiAJCXN0cnVjdCBpOTE1X3Zt
YSAqdm1hOworCQlzdHJ1Y3QgaTkxNV9nZW1fd3dfY3R4IHd3OwogCQlpbnQgZXJyOwogCiAJCXZt
YSA9IGk5MTVfdm1hX2luc3RhbmNlKG9iaiwgJmVuZ2luZS0+Z3QtPmdndHQtPnZtLCBOVUxMKTsK
IAkJaWYgKElTX0VSUih2bWEpKQogCQkJcmV0dXJuIFBUUl9FUlIodm1hKTsKIAotCQllcnIgPSBp
OTE1X3ZtYV9waW4odm1hLCAwLCAwLCBQSU5fVVNFUik7CisJCWk5MTVfZ2VtX3d3X2N0eF9pbml0
KCZ3dywgZmFsc2UpOworcmV0cnk6CisJCWVyciA9IGk5MTVfZ2VtX29iamVjdF9sb2NrKG9iaiwg
Jnd3KTsKKwkJaWYgKCFlcnIpCisJCQllcnIgPSBpOTE1X3ZtYV9waW5fd3codm1hLCAmd3csIDAs
IDAsIFBJTl9VU0VSKTsKIAkJaWYgKGVycikKLQkJCXJldHVybiBlcnI7CisJCQlnb3RvIGVycjsK
IAogCQlycSA9IGludGVsX2VuZ2luZV9jcmVhdGVfa2VybmVsX3JlcXVlc3QoZW5naW5lKTsKIAkJ
aWYgKElTX0VSUihycSkpIHsKLQkJCWk5MTVfdm1hX3VucGluKHZtYSk7Ci0JCQlyZXR1cm4gUFRS
X0VSUihycSk7CisJCQllcnIgPSBQVFJfRVJSKHJxKTsKKwkJCWdvdG8gZXJyX3VucGluOwogCQl9
CiAKLQkJaTkxNV92bWFfbG9jayh2bWEpOwogCQllcnIgPSBpOTE1X3JlcXVlc3RfYXdhaXRfb2Jq
ZWN0KHJxLCB2bWEtPm9iaiwgdHJ1ZSk7CiAJCWlmIChlcnIgPT0gMCkKIAkJCWVyciA9IGk5MTVf
dm1hX21vdmVfdG9fYWN0aXZlKHZtYSwgcnEsCiAJCQkJCQkgICAgICBFWEVDX09CSkVDVF9XUklU
RSk7Ci0JCWk5MTVfdm1hX3VubG9jayh2bWEpOwogCiAJCWk5MTVfcmVxdWVzdF9hZGQocnEpOwor
ZXJyX3VucGluOgogCQlpOTE1X3ZtYV91bnBpbih2bWEpOworZXJyOgorCQlpZiAoZXJyID09IC1F
REVBRExLKSB7CisJCQllcnIgPSBpOTE1X2dlbV93d19jdHhfYmFja29mZigmd3cpOworCQkJaWYg
KCFlcnIpCisJCQkJZ290byByZXRyeTsKKwkJfQorCQlpOTE1X2dlbV93d19jdHhfZmluaSgmd3cp
OwogCQlpZiAoZXJyKQogCQkJcmV0dXJuIGVycjsKIAl9CkBAIC0xMTIzLDYgKzExMzQsNyBAQCBz
dGF0aWMgaW50IF9faWd0X21tYXBfZ3B1KHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1LAog
CWZvcl9lYWNoX3VhYmlfZW5naW5lKGVuZ2luZSwgaTkxNSkgewogCQlzdHJ1Y3QgaTkxNV9yZXF1
ZXN0ICpycTsKIAkJc3RydWN0IGk5MTVfdm1hICp2bWE7CisJCXN0cnVjdCBpOTE1X2dlbV93d19j
dHggd3c7CiAKIAkJdm1hID0gaTkxNV92bWFfaW5zdGFuY2Uob2JqLCBlbmdpbmUtPmtlcm5lbF9j
b250ZXh0LT52bSwgTlVMTCk7CiAJCWlmIChJU19FUlIodm1hKSkgewpAQCAtMTEzMCw5ICsxMTQy
LDEzIEBAIHN0YXRpYyBpbnQgX19pZ3RfbW1hcF9ncHUoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUg
Kmk5MTUsCiAJCQlnb3RvIG91dF91bm1hcDsKIAkJfQogCi0JCWVyciA9IGk5MTVfdm1hX3Bpbih2
bWEsIDAsIDAsIFBJTl9VU0VSKTsKKwkJaTkxNV9nZW1fd3dfY3R4X2luaXQoJnd3LCBmYWxzZSk7
CityZXRyeToKKwkJZXJyID0gaTkxNV9nZW1fb2JqZWN0X2xvY2sob2JqLCAmd3cpOworCQlpZiAo
IWVycikKKwkJCWVyciA9IGk5MTVfdm1hX3Bpbl93dyh2bWEsICZ3dywgMCwgMCwgUElOX1VTRVIp
OwogCQlpZiAoZXJyKQotCQkJZ290byBvdXRfdW5tYXA7CisJCQlnb3RvIG91dF93dzsKIAogCQly
cSA9IGk5MTVfcmVxdWVzdF9jcmVhdGUoZW5naW5lLT5rZXJuZWxfY29udGV4dCk7CiAJCWlmIChJ
U19FUlIocnEpKSB7CkBAIC0xMTQwLDExICsxMTU2LDkgQEAgc3RhdGljIGludCBfX2lndF9tbWFw
X2dwdShzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSwKIAkJCWdvdG8gb3V0X3VucGluOwog
CQl9CiAKLQkJaTkxNV92bWFfbG9jayh2bWEpOwogCQllcnIgPSBpOTE1X3JlcXVlc3RfYXdhaXRf
b2JqZWN0KHJxLCB2bWEtPm9iaiwgZmFsc2UpOwogCQlpZiAoZXJyID09IDApCiAJCQllcnIgPSBp
OTE1X3ZtYV9tb3ZlX3RvX2FjdGl2ZSh2bWEsIHJxLCAwKTsKLQkJaTkxNV92bWFfdW5sb2NrKHZt
YSk7CiAKIAkJZXJyID0gZW5naW5lLT5lbWl0X2JiX3N0YXJ0KHJxLCB2bWEtPm5vZGUuc3RhcnQs
IDAsIDApOwogCQlpOTE1X3JlcXVlc3RfZ2V0KHJxKTsKQEAgLTExNjYsNiArMTE4MCwxMyBAQCBz
dGF0aWMgaW50IF9faWd0X21tYXBfZ3B1KHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1LAog
CiBvdXRfdW5waW46CiAJCWk5MTVfdm1hX3VucGluKHZtYSk7CitvdXRfd3c6CisJCWlmIChlcnIg
PT0gLUVERUFETEspIHsKKwkJCWVyciA9IGk5MTVfZ2VtX3d3X2N0eF9iYWNrb2ZmKCZ3dyk7CisJ
CQlpZiAoIWVycikKKwkJCQlnb3RvIHJldHJ5OworCQl9CisJCWk5MTVfZ2VtX3d3X2N0eF9maW5p
KCZ3dyk7CiAJCWlmIChlcnIpCiAJCQlnb3RvIG91dF91bm1hcDsKIAl9CmRpZmYgLS1naXQgYS9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVzdF9ycHMuYyBiL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2d0L3NlbGZ0ZXN0X3Jwcy5jCmluZGV4IDM0YjQwM2Q0Nzg0MC4uMzU0MGJhOWJkNDU5IDEw
MDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVzdF9ycHMuYworKysgYi9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVzdF9ycHMuYwpAQCAtNzcsMjAgKzc3LDIwIEBA
IGNyZWF0ZV9zcGluX2NvdW50ZXIoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lLAogCiAJ
dm1hID0gaTkxNV92bWFfaW5zdGFuY2Uob2JqLCB2bSwgTlVMTCk7CiAJaWYgKElTX0VSUih2bWEp
KSB7Ci0JCWk5MTVfZ2VtX29iamVjdF9wdXQob2JqKTsKLQkJcmV0dXJuIHZtYTsKKwkJZXJyID0g
UFRSX0VSUih2bWEpOworCQlnb3RvIGVycl9wdXQ7CiAJfQogCiAJZXJyID0gaTkxNV92bWFfcGlu
KHZtYSwgMCwgMCwgUElOX1VTRVIpOwotCWlmIChlcnIpIHsKLQkJaTkxNV92bWFfcHV0KHZtYSk7
Ci0JCXJldHVybiBFUlJfUFRSKGVycik7Ci0JfQorCWlmIChlcnIpCisJCWdvdG8gZXJyX3VubG9j
azsKKworCWk5MTVfdm1hX2xvY2sodm1hKTsKIAogCWJhc2UgPSBpOTE1X2dlbV9vYmplY3RfcGlu
X21hcChvYmosIEk5MTVfTUFQX1dDKTsKIAlpZiAoSVNfRVJSKGJhc2UpKSB7Ci0JCWk5MTVfZ2Vt
X29iamVjdF9wdXQob2JqKTsKLQkJcmV0dXJuIEVSUl9DQVNUKGJhc2UpOworCQllcnIgPSBQVFJf
RVJSKGJhc2UpOworCQlnb3RvIGVycl91bnBpbjsKIAl9CiAJY3MgPSBiYXNlOwogCkBAIC0xMzQs
NiArMTM0LDE0IEBAIGNyZWF0ZV9zcGluX2NvdW50ZXIoc3RydWN0IGludGVsX2VuZ2luZV9jcyAq
ZW5naW5lLAogCSpjYW5jZWwgPSBiYXNlICsgbG9vcDsKIAkqY291bnRlciA9IHNybSA/IG1lbXNl
dDMyKGJhc2UgKyBlbmQsIDAsIDEpIDogTlVMTDsKIAlyZXR1cm4gdm1hOworCitlcnJfdW5waW46
CisJaTkxNV92bWFfdW5waW4odm1hKTsKK2Vycl91bmxvY2s6CisJaTkxNV92bWFfdW5sb2NrKHZt
YSk7CitlcnJfcHV0OgorCWk5MTVfZ2VtX29iamVjdF9wdXQob2JqKTsKKwlyZXR1cm4gRVJSX1BU
UihlcnIpOwogfQogCiBzdGF0aWMgdTggd2FpdF9mb3JfZnJlcShzdHJ1Y3QgaW50ZWxfcnBzICpy
cHMsIHU4IGZyZXEsIGludCB0aW1lb3V0X21zKQpAQCAtNjM5LDcgKzY0Nyw2IEBAIGludCBsaXZl
X3Jwc19mcmVxdWVuY3lfY3Modm9pZCAqYXJnKQogCQkJZ290byBlcnJfdm1hOwogCQl9CiAKLQkJ
aTkxNV92bWFfbG9jayh2bWEpOwogCQllcnIgPSBpOTE1X3JlcXVlc3RfYXdhaXRfb2JqZWN0KHJx
LCB2bWEtPm9iaiwgZmFsc2UpOwogCQlpZiAoIWVycikKIAkJCWVyciA9IGk5MTVfdm1hX21vdmVf
dG9fYWN0aXZlKHZtYSwgcnEsIDApOwpAQCAtNjQ3LDcgKzY1NCw2IEBAIGludCBsaXZlX3Jwc19m
cmVxdWVuY3lfY3Modm9pZCAqYXJnKQogCQkJZXJyID0gcnEtPmVuZ2luZS0+ZW1pdF9iYl9zdGFy
dChycSwKIAkJCQkJCQl2bWEtPm5vZGUuc3RhcnQsCiAJCQkJCQkJUEFHRV9TSVpFLCAwKTsKLQkJ
aTkxNV92bWFfdW5sb2NrKHZtYSk7CiAJCWk5MTVfcmVxdWVzdF9hZGQocnEpOwogCQlpZiAoZXJy
KQogCQkJZ290byBlcnJfdm1hOwpAQCAtNzA4LDYgKzcxNCw3IEBAIGludCBsaXZlX3Jwc19mcmVx
dWVuY3lfY3Modm9pZCAqYXJnKQogCQlpOTE1X2dlbV9vYmplY3RfZmx1c2hfbWFwKHZtYS0+b2Jq
KTsKIAkJaTkxNV9nZW1fb2JqZWN0X3VucGluX21hcCh2bWEtPm9iaik7CiAJCWk5MTVfdm1hX3Vu
cGluKHZtYSk7CisJCWk5MTVfdm1hX3VubG9jayh2bWEpOwogCQlpOTE1X3ZtYV9wdXQodm1hKTsK
IAogCQlzdF9lbmdpbmVfaGVhcnRiZWF0X2VuYWJsZShlbmdpbmUpOwpAQCAtNzgxLDcgKzc4OCw2
IEBAIGludCBsaXZlX3Jwc19mcmVxdWVuY3lfc3JtKHZvaWQgKmFyZykKIAkJCWdvdG8gZXJyX3Zt
YTsKIAkJfQogCi0JCWk5MTVfdm1hX2xvY2sodm1hKTsKIAkJZXJyID0gaTkxNV9yZXF1ZXN0X2F3
YWl0X29iamVjdChycSwgdm1hLT5vYmosIGZhbHNlKTsKIAkJaWYgKCFlcnIpCiAJCQllcnIgPSBp
OTE1X3ZtYV9tb3ZlX3RvX2FjdGl2ZSh2bWEsIHJxLCAwKTsKQEAgLTc4OSw3ICs3OTUsNiBAQCBp
bnQgbGl2ZV9ycHNfZnJlcXVlbmN5X3NybSh2b2lkICphcmcpCiAJCQllcnIgPSBycS0+ZW5naW5l
LT5lbWl0X2JiX3N0YXJ0KHJxLAogCQkJCQkJCXZtYS0+bm9kZS5zdGFydCwKIAkJCQkJCQlQQUdF
X1NJWkUsIDApOwotCQlpOTE1X3ZtYV91bmxvY2sodm1hKTsKIAkJaTkxNV9yZXF1ZXN0X2FkZChy
cSk7CiAJCWlmIChlcnIpCiAJCQlnb3RvIGVycl92bWE7CkBAIC04NDksNiArODU0LDcgQEAgaW50
IGxpdmVfcnBzX2ZyZXF1ZW5jeV9zcm0odm9pZCAqYXJnKQogCQlpOTE1X2dlbV9vYmplY3RfZmx1
c2hfbWFwKHZtYS0+b2JqKTsKIAkJaTkxNV9nZW1fb2JqZWN0X3VucGluX21hcCh2bWEtPm9iaik7
CiAJCWk5MTVfdm1hX3VucGluKHZtYSk7CisJCWk5MTVfdm1hX3VubG9jayh2bWEpOwogCQlpOTE1
X3ZtYV9wdXQodm1hKTsKIAogCQlzdF9lbmdpbmVfaGVhcnRiZWF0X2VuYWJsZShlbmdpbmUpOwpk
aWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvc2VsZnRlc3RzL2k5MTVfcmVxdWVzdC5j
IGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvc2VsZnRlc3RzL2k5MTVfcmVxdWVzdC5jCmluZGV4IGMx
ZGNkNGI5MWJkYS4uMzA5MmNhNzYzNzg5IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9zZWxmdGVzdHMvaTkxNV9yZXF1ZXN0LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvc2Vs
ZnRlc3RzL2k5MTVfcmVxdWVzdC5jCkBAIC04NjIsNiArODYyLDggQEAgc3RhdGljIGludCBsaXZl
X2FsbF9lbmdpbmVzKHZvaWQgKmFyZykKIAkJZ290byBvdXRfZnJlZTsKIAl9CiAKKwlpOTE1X3Zt
YV9sb2NrKGJhdGNoKTsKKwogCWlkeCA9IDA7CiAJZm9yX2VhY2hfdWFiaV9lbmdpbmUoZW5naW5l
LCBpOTE1KSB7CiAJCXJlcXVlc3RbaWR4XSA9IGludGVsX2VuZ2luZV9jcmVhdGVfa2VybmVsX3Jl
cXVlc3QoZW5naW5lKTsKQEAgLTg3MiwxMSArODc0LDkgQEAgc3RhdGljIGludCBsaXZlX2FsbF9l
bmdpbmVzKHZvaWQgKmFyZykKIAkJCWdvdG8gb3V0X3JlcXVlc3Q7CiAJCX0KIAotCQlpOTE1X3Zt
YV9sb2NrKGJhdGNoKTsKIAkJZXJyID0gaTkxNV9yZXF1ZXN0X2F3YWl0X29iamVjdChyZXF1ZXN0
W2lkeF0sIGJhdGNoLT5vYmosIDApOwogCQlpZiAoZXJyID09IDApCiAJCQllcnIgPSBpOTE1X3Zt
YV9tb3ZlX3RvX2FjdGl2ZShiYXRjaCwgcmVxdWVzdFtpZHhdLCAwKTsKLQkJaTkxNV92bWFfdW5s
b2NrKGJhdGNoKTsKIAkJR0VNX0JVR19PTihlcnIpOwogCiAJCWVyciA9IGVuZ2luZS0+ZW1pdF9i
Yl9zdGFydChyZXF1ZXN0W2lkeF0sCkBAIC04OTEsNiArODkxLDggQEAgc3RhdGljIGludCBsaXZl
X2FsbF9lbmdpbmVzKHZvaWQgKmFyZykKIAkJaWR4Kys7CiAJfQogCisJaTkxNV92bWFfdW5sb2Nr
KGJhdGNoKTsKKwogCWlkeCA9IDA7CiAJZm9yX2VhY2hfdWFiaV9lbmdpbmUoZW5naW5lLCBpOTE1
KSB7CiAJCWlmIChpOTE1X3JlcXVlc3RfY29tcGxldGVkKHJlcXVlc3RbaWR4XSkpIHsKQEAgLTk4
MSwxMiArOTgzLDEzIEBAIHN0YXRpYyBpbnQgbGl2ZV9zZXF1ZW50aWFsX2VuZ2luZXModm9pZCAq
YXJnKQogCQkJZ290byBvdXRfZnJlZTsKIAkJfQogCisJCWk5MTVfdm1hX2xvY2soYmF0Y2gpOwog
CQlyZXF1ZXN0W2lkeF0gPSBpbnRlbF9lbmdpbmVfY3JlYXRlX2tlcm5lbF9yZXF1ZXN0KGVuZ2lu
ZSk7CiAJCWlmIChJU19FUlIocmVxdWVzdFtpZHhdKSkgewogCQkJZXJyID0gUFRSX0VSUihyZXF1
ZXN0W2lkeF0pOwogCQkJcHJfZXJyKCIlczogUmVxdWVzdCBhbGxvY2F0aW9uIGZhaWxlZCBmb3Ig
JXMgd2l0aCBlcnI9JWRcbiIsCiAJCQkgICAgICAgX19mdW5jX18sIGVuZ2luZS0+bmFtZSwgZXJy
KTsKLQkJCWdvdG8gb3V0X3JlcXVlc3Q7CisJCQlnb3RvIG91dF91bmxvY2s7CiAJCX0KIAogCQlp
ZiAocHJldikgewpAQCAtOTk2LDE2ICs5OTksMTQgQEAgc3RhdGljIGludCBsaXZlX3NlcXVlbnRp
YWxfZW5naW5lcyh2b2lkICphcmcpCiAJCQkJaTkxNV9yZXF1ZXN0X2FkZChyZXF1ZXN0W2lkeF0p
OwogCQkJCXByX2VycigiJXM6IFJlcXVlc3QgYXdhaXQgZmFpbGVkIGZvciAlcyB3aXRoIGVycj0l
ZFxuIiwKIAkJCQkgICAgICAgX19mdW5jX18sIGVuZ2luZS0+bmFtZSwgZXJyKTsKLQkJCQlnb3Rv
IG91dF9yZXF1ZXN0OworCQkJCWdvdG8gb3V0X3VubG9jazsKIAkJCX0KIAkJfQogCi0JCWk5MTVf
dm1hX2xvY2soYmF0Y2gpOwogCQllcnIgPSBpOTE1X3JlcXVlc3RfYXdhaXRfb2JqZWN0KHJlcXVl
c3RbaWR4XSwKIAkJCQkJCWJhdGNoLT5vYmosIGZhbHNlKTsKIAkJaWYgKGVyciA9PSAwKQogCQkJ
ZXJyID0gaTkxNV92bWFfbW92ZV90b19hY3RpdmUoYmF0Y2gsIHJlcXVlc3RbaWR4XSwgMCk7Ci0J
CWk5MTVfdm1hX3VubG9jayhiYXRjaCk7CiAJCUdFTV9CVUdfT04oZXJyKTsKIAogCQllcnIgPSBl
bmdpbmUtPmVtaXRfYmJfc3RhcnQocmVxdWVzdFtpZHhdLApAQCAtMTAyMCw2ICsxMDIxLDExIEBA
IHN0YXRpYyBpbnQgbGl2ZV9zZXF1ZW50aWFsX2VuZ2luZXModm9pZCAqYXJnKQogCiAJCXByZXYg
PSByZXF1ZXN0W2lkeF07CiAJCWlkeCsrOworCitvdXRfdW5sb2NrOgorCQlpOTE1X3ZtYV91bmxv
Y2soYmF0Y2gpOworCQlpZiAoZXJyKQorCQkJZ290byBvdXRfcmVxdWVzdDsKIAl9CiAKIAlpZHgg
PSAwOwotLSAKMi4yOC4wCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fXwpJbnRlbC1nZnggbWFpbGluZyBsaXN0CkludGVsLWdmeEBsaXN0cy5mcmVlZGVza3Rv
cC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9pbnRl
bC1nZngK

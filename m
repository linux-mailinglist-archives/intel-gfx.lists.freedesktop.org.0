Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id AEF36D076E
	for <lists+intel-gfx@lfdr.de>; Wed,  9 Oct 2019 08:42:51 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 0E9BE6E8E7;
	Wed,  9 Oct 2019 06:42:44 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id D58346E8E5
 for <intel-gfx@lists.freedesktop.org>; Wed,  9 Oct 2019 06:42:40 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18772588-1500050 
 for multiple; Wed, 09 Oct 2019 07:42:26 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Wed,  9 Oct 2019 07:42:21 +0100
Message-Id: <20191009064224.25348-6-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20191009064224.25348-1-chris@chris-wilson.co.uk>
References: <20191009064224.25348-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v2 6/9] drm/i915/perf: execute OA configuration
 from command stream
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

RnJvbTogTGlvbmVsIExhbmR3ZXJsaW4gPGxpb25lbC5nLmxhbmR3ZXJsaW5AaW50ZWwuY29tPgoK
V2UgaGF2ZW4ndCBydW4gaW50byBpc3N1ZXMgd2l0aCBwcm9ncmFtbWluZyB0aGUgZ2xvYmFsIE9B
L05PQQpyZWdpc3RlcnMgY29uZmlndXJhdGlvbiBmcm9tIENQVSBzbyBmYXIsIGJ1dCBIVyBlbmdp
bmVlcnMgYWN0dWFsbHkKcmVjb21tZW5kIGRvaW5nIHRoaXMgZnJvbSB0aGUgY29tbWFuZCBzdHJl
YW1lci4gT24gVEdMIGluIHBhcnRpY3VsYXIKb25lIG9mIHRoZSBjbG9jayBkb21haW4gaW4gd2hp
Y2ggc29tZSBvZiB0aGF0IHByb2dyYW1taW5nIGdvZXMgbWlnaHQKbm90IGJlIHBvd2VyZWQgd2hl
biB3ZSBwb2tlIHRoaW5ncyBmcm9tIHRoZSBDUFUuCgpTaW5jZSB3ZSBoYXZlIGEgY29tbWFuZCBi
dWZmZXIgcHJlcGFyZWQgZm9yIHRoZSBleGVjYnVmZmVyIHNpZGUgb2YKdGhpbmdzLCB3ZSBjYW4g
cmV1c2UgdGhhdCBhcHByb2FjaCBoZXJlIHRvby4KClRoaXMgYWxzbyBhbGxvd3MgdXMgdG8gc2ln
bmlmaWNhbnRseSByZWR1Y2UgdGhlIGFtb3VudCBvZiB0aW1lIHdlIGhvbGQKdGhlIG1haW4gbG9j
ay4KCnYyOiBEcm9wIHRoZSBnbG9iYWwgbG9jayBhcyBtdWNoIGFzIHBvc3NpYmxlCgp2MzogVGFr
ZSBnbG9iYWwgbG9jayB0byBwaW4gZ2xvYmFsCgp2NDogQ3JlYXRlIGk5MTUgcmVxdWVzdCBpbiBl
bWl0X29hX2NvbmZpZygpIHRvIGF2b2lkIGRlYWRsb2NrcyAoTGlvbmVsKQoKdjU6IE1vdmUgbG9j
a2luZyB0byB0aGUgc3RyZWFtIChMaW9uZWwpCgp2NjogTW92ZSBhY3RpdmUgcmVjb25maWd1cmF0
aW9uIHJlcXVlc3QgaW50byBpOTE1X3BlcmZfc3RyZWFtIChMaW9uZWwpCgp2NzogUGluIFZNQSBv
dXRzaWRlIHJlcXVlc3QgY3JlYXRpb24gKENocmlzKQogICAgTG9jayBWTUEgYmVmb3JlIG1vdmUg
dG8gYWN0aXZlIChDaHJpcykKCnY4OiBGaXggZG91YmxlIGZyZWUgb24gc3RyZWFtLT5pbml0aWFs
X29hX2NvbmZpZ19ibyAoTGlvbmVsKQogICAgRG9uJ3QgYWxsb3cgaW50ZXJydXB0aW9uIHdoZW4g
d2FpdGluZyBvbiBhY3RpdmUgY29uZmlnIHJlcXVlc3QKICAgIChMaW9uZWwpCgpTaWduZWQtb2Zm
LWJ5OiBMaW9uZWwgTGFuZHdlcmxpbiA8bGlvbmVsLmcubGFuZHdlcmxpbkBpbnRlbC5jb20+Ci0t
LQogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wZXJmLmMgICAgICAgfCA5NCArKysrKysrKysr
KystLS0tLS0tLS0tLS0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wZXJmX3R5cGVzLmgg
fCAgNiArKwogMiBmaWxlcyBjaGFuZ2VkLCA0OCBpbnNlcnRpb25zKCspLCA1MiBkZWxldGlvbnMo
LSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3BlcmYuYyBiL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L2k5MTVfcGVyZi5jCmluZGV4IDExNzA0YTEzMGJjYy4uNGVhN2Y5M2Rj
NWVhIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3BlcmYuYworKysgYi9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3BlcmYuYwpAQCAtMTg1OSw1NiArMTg1OSw1OSBAQCBz
dGF0aWMgaW50IGFsbG9jX25vYV93YWl0KHN0cnVjdCBpOTE1X3BlcmZfc3RyZWFtICpzdHJlYW0p
CiAJcmV0dXJuIDA7CiAKIGVycl91bnBpbjoKLQlfX2k5MTVfdm1hX3VucGluKHZtYSk7CisJaTkx
NV92bWFfdW5waW5fYW5kX3JlbGVhc2UoJnZtYSwgMCk7CiBlcnJfdW5yZWY6CiAJaTkxNV9nZW1f
b2JqZWN0X3B1dChibyk7CiAJcmV0dXJuIHJldDsKIH0KIAotc3RhdGljIHZvaWQgY29uZmlnX29h
X3JlZ3Moc3RydWN0IGludGVsX3VuY29yZSAqdW5jb3JlLAotCQkJICAgY29uc3Qgc3RydWN0IGk5
MTVfb2FfcmVnICpyZWdzLAotCQkJICAgdTMyIG5fcmVncykKK3N0YXRpYyBpbnQgZW1pdF9vYV9j
b25maWcoc3RydWN0IGk5MTVfcGVyZl9zdHJlYW0gKnN0cmVhbSkKIHsKLQl1MzIgaTsKKwlzdHJ1
Y3QgaTkxNV9yZXF1ZXN0ICpycTsKKwlzdHJ1Y3QgaTkxNV92bWEgKnZtYTsKKwlpbnQgZXJyOwog
Ci0JZm9yIChpID0gMDsgaSA8IG5fcmVnczsgaSsrKSB7Ci0JCWNvbnN0IHN0cnVjdCBpOTE1X29h
X3JlZyAqcmVnID0gcmVncyArIGk7CisJdm1hID0gaTkxNV9wZXJmX3N0cmVhbV9nZXRfb2Ffdm1h
KHN0cmVhbSwgc3RyZWFtLT5vYV9jb25maWcpOworCWlmIChJU19FUlIodm1hKSkKKwkJcmV0dXJu
IFBUUl9FUlIodm1hKTsKKworCWVyciA9IGk5MTVfdm1hX3Bpbih2bWEsIDAsIDAsIFBJTl9HTE9C
QUwgfCBQSU5fSElHSCk7CisJaWYgKGVycikKKwkJZ290byBlcnJfdm1hX3B1dDsKIAotCQlpbnRl
bF91bmNvcmVfd3JpdGUodW5jb3JlLCByZWctPmFkZHIsIHJlZy0+dmFsdWUpOworCXJxID0gaTkx
NV9yZXF1ZXN0X2NyZWF0ZShzdHJlYW0tPmVuZ2luZS0+a2VybmVsX2NvbnRleHQpOworCWlmIChJ
U19FUlIocnEpKSB7CisJCWVyciA9IFBUUl9FUlIocnEpOworCQlnb3RvIGVycl92bWFfdW5waW47
CiAJfQotfQogCi1zdGF0aWMgdm9pZCBkZWxheV9hZnRlcl9tdXgodm9pZCkKLXsKLQkvKgotCSAq
IEl0IGFwcGFyZW50bHkgdGFrZXMgYSBmYWlybHkgbG9uZyB0aW1lIGZvciBhIG5ldyBNVVgKLQkg
KiBjb25maWd1cmF0aW9uIHRvIGJlIGJlIGFwcGxpZWQgYWZ0ZXIgdGhlc2UgcmVnaXN0ZXIgd3Jp
dGVzLgotCSAqIFRoaXMgZGVsYXkgZHVyYXRpb24gd2FzIGRlcml2ZWQgZW1waXJpY2FsbHkgYmFz
ZWQgb24gdGhlCi0JICogcmVuZGVyX2Jhc2ljIGNvbmZpZyBidXQgaG9wZWZ1bGx5IGl0IGNvdmVy
cyB0aGUgbWF4aW11bQotCSAqIGNvbmZpZ3VyYXRpb24gbGF0ZW5jeS4KLQkgKgotCSAqIEFzIGEg
ZmFsbGJhY2ssIHRoZSBjaGVja3MgaW4gX2FwcGVuZF9vYV9yZXBvcnRzKCkgdG8gc2tpcAotCSAq
IGludmFsaWQgT0EgcmVwb3J0cyBkbyBhbHNvIHNlZW0gdG8gd29yayB0byBkaXNjYXJkIHJlcG9y
dHMKLQkgKiBnZW5lcmF0ZWQgYmVmb3JlIHRoaXMgY29uZmlnIGhhcyBjb21wbGV0ZWQgLSBhbGJl
aXQgbm90Ci0JICogc2lsZW50bHkuCi0JICoKLQkgKiBVbmZvcnR1bmF0ZWx5IHRoaXMgaXMgZXNz
ZW50aWFsbHkgYSBtYWdpYyBudW1iZXIsIHNpbmNlIHdlCi0JICogZG9uJ3QgY3VycmVudGx5IGtu
b3cgb2YgYSByZWxpYWJsZSBtZWNoYW5pc20gZm9yIHByZWRpY3RpbmcKLQkgKiBob3cgbG9uZyB0
aGUgTVVYIGNvbmZpZyB3aWxsIHRha2UgdG8gYXBwbHkgYW5kIGJlc2lkZXMKLQkgKiBzZWVpbmcg
aW52YWxpZCByZXBvcnRzIHdlIGRvbid0IGtub3cgb2YgYSByZWxpYWJsZSB3YXkgdG8KLQkgKiBl
eHBsaWNpdGx5IGNoZWNrIHRoYXQgdGhlIE1VWCBjb25maWcgaGFzIGxhbmRlZC4KLQkgKgotCSAq
IEl0J3MgZXZlbiBwb3NzaWJsZSB3ZSd2ZSBtaXNzIGNoYXJhY3Rlcml6ZWQgdGhlIHVuZGVybHlp
bmcKLQkgKiBwcm9ibGVtIC0gaXQganVzdCBzZWVtcyBsaWtlIHRoZSBzaW1wbGVzdCBleHBsYW5h
dGlvbiB3aHkKLQkgKiBhIGRlbGF5IGF0IHRoaXMgbG9jYXRpb24gd291bGQgbWl0aWdhdGUgYW55
IGludmFsaWQgcmVwb3J0cy4KLQkgKi8KLQl1c2xlZXBfcmFuZ2UoMTUwMDAsIDIwMDAwKTsKKwll
cnIgPSBpOTE1X2FjdGl2ZV9mZW5jZV9zZXQoJnN0cmVhbS0+cGVyZi0+YWN0aXZlX2NvbmZpZywg
cnEpOworCWlmIChlcnIpCisJCWdvdG8gZXJyX2FkZF9yZXF1ZXN0OworCisJaTkxNV92bWFfbG9j
ayh2bWEpOworCWVyciA9IGk5MTVfcmVxdWVzdF9hd2FpdF9vYmplY3QocnEsIHZtYS0+b2JqLCAw
KTsKKwlpZiAoIWVycikKKwkJZXJyID0gaTkxNV92bWFfbW92ZV90b19hY3RpdmUodm1hLCBycSwg
MCk7CisJaTkxNV92bWFfdW5sb2NrKHZtYSk7CisJaWYgKGVycikKKwkJZ290byBlcnJfYWRkX3Jl
cXVlc3Q7CisKKwllcnIgPSBycS0+ZW5naW5lLT5lbWl0X2JiX3N0YXJ0KHJxLAorCQkJCQl2bWEt
Pm5vZGUuc3RhcnQsIDAsCisJCQkJCUk5MTVfRElTUEFUQ0hfU0VDVVJFKTsKK2Vycl9hZGRfcmVx
dWVzdDoKKwlpOTE1X3JlcXVlc3RfYWRkKHJxKTsKK2Vycl92bWFfdW5waW46CisJaTkxNV92bWFf
dW5waW4odm1hKTsKK2Vycl92bWFfcHV0OgorCWk5MTVfdm1hX3B1dCh2bWEpOworCXJldHVybiBl
cnI7CiB9CiAKIHN0YXRpYyBpbnQgaHN3X2VuYWJsZV9tZXRyaWNfc2V0KHN0cnVjdCBpOTE1X3Bl
cmZfc3RyZWFtICpzdHJlYW0pCiB7CiAJc3RydWN0IGludGVsX3VuY29yZSAqdW5jb3JlID0gc3Ry
ZWFtLT5ndC0+dW5jb3JlOwotCWNvbnN0IHN0cnVjdCBpOTE1X29hX2NvbmZpZyAqb2FfY29uZmln
ID0gc3RyZWFtLT5vYV9jb25maWc7CiAKIAkvKgogCSAqIFBSTToKQEAgLTE5MjUsMTMgKzE5Mjgs
NyBAQCBzdGF0aWMgaW50IGhzd19lbmFibGVfbWV0cmljX3NldChzdHJ1Y3QgaTkxNV9wZXJmX3N0
cmVhbSAqc3RyZWFtKQogCWludGVsX3VuY29yZV9ybXcodW5jb3JlLCBHRU42X1VDR0NUTDEsCiAJ
CQkgMCwgR0VONl9DU1VOSVRfQ0xPQ0tfR0FURV9ESVNBQkxFKTsKIAotCWNvbmZpZ19vYV9yZWdz
KHVuY29yZSwgb2FfY29uZmlnLT5tdXhfcmVncywgb2FfY29uZmlnLT5tdXhfcmVnc19sZW4pOwot
CWRlbGF5X2FmdGVyX211eCgpOwotCi0JY29uZmlnX29hX3JlZ3ModW5jb3JlLCBvYV9jb25maWct
PmJfY291bnRlcl9yZWdzLAotCQkgICAgICAgb2FfY29uZmlnLT5iX2NvdW50ZXJfcmVnc19sZW4p
OwotCi0JcmV0dXJuIDA7CisJcmV0dXJuIGVtaXRfb2FfY29uZmlnKHN0cmVhbSk7CiB9CiAKIHN0
YXRpYyB2b2lkIGhzd19kaXNhYmxlX21ldHJpY19zZXQoc3RydWN0IGk5MTVfcGVyZl9zdHJlYW0g
KnN0cmVhbSkKQEAgLTIyOTUsMTMgKzIyOTIsNyBAQCBzdGF0aWMgaW50IGdlbjhfZW5hYmxlX21l
dHJpY19zZXQoc3RydWN0IGk5MTVfcGVyZl9zdHJlYW0gKnN0cmVhbSkKIAlpZiAocmV0KQogCQly
ZXR1cm4gcmV0OwogCi0JY29uZmlnX29hX3JlZ3ModW5jb3JlLCBvYV9jb25maWctPm11eF9yZWdz
LCBvYV9jb25maWctPm11eF9yZWdzX2xlbik7Ci0JZGVsYXlfYWZ0ZXJfbXV4KCk7Ci0KLQljb25m
aWdfb2FfcmVncyh1bmNvcmUsIG9hX2NvbmZpZy0+Yl9jb3VudGVyX3JlZ3MsCi0JCSAgICAgICBv
YV9jb25maWctPmJfY291bnRlcl9yZWdzX2xlbik7Ci0KLQlyZXR1cm4gMDsKKwlyZXR1cm4gZW1p
dF9vYV9jb25maWcoc3RyZWFtKTsKIH0KIAogc3RhdGljIHZvaWQgZ2VuOF9kaXNhYmxlX21ldHJp
Y19zZXQoc3RydWN0IGk5MTVfcGVyZl9zdHJlYW0gKnN0cmVhbSkKQEAgLTI1NzgsMTAgKzI1Njks
OCBAQCBzdGF0aWMgaW50IGk5MTVfb2Ffc3RyZWFtX2luaXQoc3RydWN0IGk5MTVfcGVyZl9zdHJl
YW0gKnN0cmVhbSwKIAlwZXJmLT5leGNsdXNpdmVfc3RyZWFtID0gc3RyZWFtOwogCiAJcmV0ID0g
cGVyZi0+b3BzLmVuYWJsZV9tZXRyaWNfc2V0KHN0cmVhbSk7Ci0JaWYgKHJldCkgewotCQlEUk1f
REVCVUcoIlVuYWJsZSB0byBlbmFibGUgbWV0cmljIHNldFxuIik7CisJaWYgKHJldCkKIAkJZ290
byBlcnJfZW5hYmxlOwotCX0KIAogCURSTV9ERUJVRygib3BlbmluZyBzdHJlYW0gb2EgY29uZmln
IHV1aWQ9JXNcbiIsCiAJCSAgc3RyZWFtLT5vYV9jb25maWctPnV1aWQpOwpAQCAtMzk3OSw2ICsz
OTY4LDcgQEAgdm9pZCBpOTE1X3BlcmZfaW5pdChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkx
NSkKIAogCWlmIChwZXJmLT5vcHMuZW5hYmxlX21ldHJpY19zZXQpIHsKIAkJbXV0ZXhfaW5pdCgm
cGVyZi0+bG9jayk7CisJCUlOSVRfQUNUSVZFX0ZFTkNFKCZwZXJmLT5hY3RpdmVfY29uZmlnLCAm
cGVyZi0+bG9jayk7CiAKIAkJb2Ffc2FtcGxlX3JhdGVfaGFyZF9saW1pdCA9IDEwMDAgKgogCQkJ
KFJVTlRJTUVfSU5GTyhpOTE1KS0+Y3NfdGltZXN0YW1wX2ZyZXF1ZW5jeV9raHogLyAyKTsKZGlm
ZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcGVyZl90eXBlcy5oIGIvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvaTkxNV9wZXJmX3R5cGVzLmgKaW5kZXggZWI1MDY1MDIzYzkzLi41ZjA3
ZWVmZjBhZDYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcGVyZl90eXBl
cy5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcGVyZl90eXBlcy5oCkBAIC0xNiw2
ICsxNiw3IEBACiAjaW5jbHVkZSA8bGludXgvdXVpZC5oPgogI2luY2x1ZGUgPGxpbnV4L3dhaXQu
aD4KIAorI2luY2x1ZGUgImk5MTVfYWN0aXZlX3R5cGVzLmgiCiAjaW5jbHVkZSAiaTkxNV9yZWcu
aCIKICNpbmNsdWRlICJpbnRlbF93YWtlcmVmLmgiCiAKQEAgLTM3Niw2ICszNzcsMTEgQEAgc3Ry
dWN0IGk5MTVfcGVyZiB7CiAJICovCiAJc3RydWN0IGk5MTVfcGVyZl9zdHJlYW0gKmV4Y2x1c2l2
ZV9zdHJlYW07CiAKKwkvKioKKwkgKiBAYWN0aXZlX2NvbmZpZzogTGFzdCByZXF1ZXN0IHVzaW5n
IHRoZSBhY3RpdmUgY29uZmlndXJhdGlvbi4KKwkgKi8KKwlzdHJ1Y3QgaTkxNV9hY3RpdmVfZmVu
Y2UgYWN0aXZlX2NvbmZpZzsKKwogCS8qKgogCSAqIEZvciByYXRlIGxpbWl0aW5nIGFueSBub3Rp
ZmljYXRpb25zIG9mIHNwdXJpb3VzCiAJICogaW52YWxpZCBPQSByZXBvcnRzCi0tIAoyLjIzLjAK
Cl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCkludGVsLWdm
eCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xp
c3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWdmeA==

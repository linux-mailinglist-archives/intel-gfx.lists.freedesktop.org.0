Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 4A20B71F77
	for <lists+intel-gfx@lfdr.de>; Tue, 23 Jul 2019 20:40:41 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 9D1F16E37C;
	Tue, 23 Jul 2019 18:40:39 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 2415189219
 for <intel-gfx@lists.freedesktop.org>; Tue, 23 Jul 2019 18:40:32 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17542615-1500050 
 for multiple; Tue, 23 Jul 2019 19:38:45 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Tue, 23 Jul 2019 19:38:30 +0100
Message-Id: <20190723183842.20372-11-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.22.0
In-Reply-To: <20190723183842.20372-1-chris@chris-wilson.co.uk>
References: <20190723183842.20372-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 11/23] drm/i915: Only include active engines in
 the capture state
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

U2tpcCBwcmludGluZyBvdXQgaWRsZSBlbmdpbmVzIHRoYXQgZGlkIG5vdCBjb250cmlidXRlIHRv
IHRoZSBHUFUgaGFuZy4KQXMgdGhlIG51bWJlciBvZiBlbmdpbmVzIGdldHMgZXZlciBsYXJnZXIs
IHdlIGhhdmUgaW5jcmVhc2luZyBub2lzZSBpbgp0aGUgZXJyb3Igc3RhdGUgd2hlcmUgdHlwaWNh
bGx5IHRoZXJlIGlzIG9ubHkgb25lIGd1aWx0eSByZXF1ZXN0IG9uIG9uZQplbmdpbmUgdGhhdCB3
ZSBuZWVkIHRvIGluc3BlY3QuCgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNocmlzQGNo
cmlzLXdpbHNvbi5jby51az4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dwdV9lcnJv
ci5jIHwgMjQxICsrKysrKysrKysrLS0tLS0tLS0tLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkx
NS9pOTE1X2dwdV9lcnJvci5oIHwgICA3ICstCiAyIGZpbGVzIGNoYW5nZWQsIDEwNiBpbnNlcnRp
b25zKCspLCAxNDIgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvaTkxNV9ncHVfZXJyb3IuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ3B1X2Vycm9y
LmMKaW5kZXggMjE5MzY4N2VhYzcyLi45MjAzODA2M2FjNzQgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2k5MTVfZ3B1X2Vycm9yLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUv
aTkxNV9ncHVfZXJyb3IuYwpAQCAtNDksMjcgKzQ5LDYgQEAKICNkZWZpbmUgQUxMT1dfRkFJTCAo
R0ZQX0tFUk5FTCB8IF9fR0ZQX1JFVFJZX01BWUZBSUwgfCBfX0dGUF9OT1dBUk4pCiAjZGVmaW5l
IEFUT01JQ19NQVlGQUlMIChHRlBfQVRPTUlDIHwgX19HRlBfTk9XQVJOKQogCi1zdGF0aWMgaW5s
aW5lIGNvbnN0IHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKgotZW5naW5lX2xvb2t1cChjb25zdCBz
dHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSwgdW5zaWduZWQgaW50IGlkKQotewotCWlmIChp
ZCA+PSBJOTE1X05VTV9FTkdJTkVTKQotCQlyZXR1cm4gTlVMTDsKLQotCXJldHVybiBpOTE1LT5l
bmdpbmVbaWRdOwotfQotCi1zdGF0aWMgaW5saW5lIGNvbnN0IGNoYXIgKgotX19lbmdpbmVfbmFt
ZShjb25zdCBzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUpCi17Ci0JcmV0dXJuIGVuZ2lu
ZSA/IGVuZ2luZS0+bmFtZSA6ICIiOwotfQotCi1zdGF0aWMgY29uc3QgY2hhciAqCi1lbmdpbmVf
bmFtZShjb25zdCBzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSwgdW5zaWduZWQgaW50IGlk
KQotewotCXJldHVybiBfX2VuZ2luZV9uYW1lKGVuZ2luZV9sb29rdXAoaTkxNSwgaWQpKTsKLX0K
LQogc3RhdGljIHZvaWQgX19zZ19zZXRfYnVmKHN0cnVjdCBzY2F0dGVybGlzdCAqc2csCiAJCQkg
dm9pZCAqYWRkciwgdW5zaWduZWQgaW50IGxlbiwgbG9mZl90IGl0KQogewpAQCAtNDQ5LDcgKzQy
OCw3IEBAIHN0YXRpYyB2b2lkIGVycm9yX3ByaW50X2luc3Rkb25lKHN0cnVjdCBkcm1faTkxNV9l
cnJvcl9zdGF0ZV9idWYgKm0sCiAJZXJyX3ByaW50ZihtLCAiICBJTlNURE9ORTogMHglMDh4XG4i
LAogCQkgICBlZS0+aW5zdGRvbmUuaW5zdGRvbmUpOwogCi0JaWYgKGVlLT5lbmdpbmVfaWQgIT0g
UkNTMCB8fCBJTlRFTF9HRU4obS0+aTkxNSkgPD0gMykKKwlpZiAoZWUtPmVuZ2luZS0+Y2xhc3Mg
IT0gUkVOREVSX0NMQVNTIHx8IElOVEVMX0dFTihtLT5pOTE1KSA8PSAzKQogCQlyZXR1cm47CiAK
IAllcnJfcHJpbnRmKG0sICIgIFNDX0lOU1RET05FOiAweCUwOHhcbiIsCkBAIC01MDMsOCArNDgy
LDcgQEAgc3RhdGljIHZvaWQgZXJyb3JfcHJpbnRfZW5naW5lKHN0cnVjdCBkcm1faTkxNV9lcnJv
cl9zdGF0ZV9idWYgKm0sCiB7CiAJaW50IG47CiAKLQllcnJfcHJpbnRmKG0sICIlcyBjb21tYW5k
IHN0cmVhbTpcbiIsCi0JCSAgIGVuZ2luZV9uYW1lKG0tPmk5MTUsIGVlLT5lbmdpbmVfaWQpKTsK
KwllcnJfcHJpbnRmKG0sICIlcyBjb21tYW5kIHN0cmVhbTpcbiIsIGVlLT5lbmdpbmUtPm5hbWUp
OwogCWVycl9wcmludGYobSwgIiAgSURMRT86ICVzXG4iLCB5ZXNubyhlZS0+aWRsZSkpOwogCWVy
cl9wcmludGYobSwgIiAgU1RBUlQ6IDB4JTA4eFxuIiwgZWUtPnN0YXJ0KTsKIAllcnJfcHJpbnRm
KG0sICIgIEhFQUQ6ICAweCUwOHggWzB4JTA4eF1cbiIsIGVlLT5oZWFkLCBlZS0+cnFfaGVhZCk7
CkBAIC01ODAsOSArNTU4LDkgQEAgdm9pZCBpOTE1X2Vycm9yX3ByaW50ZihzdHJ1Y3QgZHJtX2k5
MTVfZXJyb3Jfc3RhdGVfYnVmICplLCBjb25zdCBjaGFyICpmLCAuLi4pCiB9CiAKIHN0YXRpYyB2
b2lkIHByaW50X2Vycm9yX29iaihzdHJ1Y3QgZHJtX2k5MTVfZXJyb3Jfc3RhdGVfYnVmICptLAot
CQkJICAgIHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSwKKwkJCSAgICBjb25zdCBzdHJ1
Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUsCiAJCQkgICAgY29uc3QgY2hhciAqbmFtZSwKLQkJ
CSAgICBzdHJ1Y3QgZHJtX2k5MTVfZXJyb3Jfb2JqZWN0ICpvYmopCisJCQkgICAgY29uc3Qgc3Ry
dWN0IGRybV9pOTE1X2Vycm9yX29iamVjdCAqb2JqKQogewogCWNoYXIgb3V0W0FTQ0lJODVfQlVG
U1pdOwogCWludCBwYWdlOwpAQCAtNjc5LDcgKzY1Nyw3IEBAIHN0YXRpYyB2b2lkIGVycl9mcmVl
X3NnbChzdHJ1Y3Qgc2NhdHRlcmxpc3QgKnNnbCkKIHN0YXRpYyB2b2lkIF9fZXJyX3ByaW50X3Rv
X3NnbChzdHJ1Y3QgZHJtX2k5MTVfZXJyb3Jfc3RhdGVfYnVmICptLAogCQkJICAgICAgIHN0cnVj
dCBpOTE1X2dwdV9zdGF0ZSAqZXJyb3IpCiB7Ci0Jc3RydWN0IGRybV9pOTE1X2Vycm9yX29iamVj
dCAqb2JqOworCWNvbnN0IHN0cnVjdCBkcm1faTkxNV9lcnJvcl9lbmdpbmUgKmVlOwogCXN0cnVj
dCB0aW1lc3BlYzY0IHRzOwogCWludCBpLCBqOwogCkBAIC03MDMsMTUgKzY4MSwxMiBAQCBzdGF0
aWMgdm9pZCBfX2Vycl9wcmludF90b19zZ2woc3RydWN0IGRybV9pOTE1X2Vycm9yX3N0YXRlX2J1
ZiAqbSwKIAkJICAgamlmZmllc190b19tc2VjcyhqaWZmaWVzIC0gZXJyb3ItPmNhcHR1cmUpLAog
CQkgICBqaWZmaWVzX3RvX21zZWNzKGVycm9yLT5jYXB0dXJlIC0gZXJyb3ItPmVwb2NoKSk7CiAK
LQlmb3IgKGkgPSAwOyBpIDwgQVJSQVlfU0laRShlcnJvci0+ZW5naW5lKTsgaSsrKSB7Ci0JCWlm
ICghZXJyb3ItPmVuZ2luZVtpXS5jb250ZXh0LnBpZCkKLQkJCWNvbnRpbnVlOwotCisJZm9yIChl
ZSA9IGVycm9yLT5lbmdpbmU7IGVlOyBlZSA9IGVlLT5uZXh0KQogCQllcnJfcHJpbnRmKG0sICJB
Y3RpdmUgcHJvY2VzcyAob24gcmluZyAlcyk6ICVzIFslZF1cbiIsCi0JCQkgICBlbmdpbmVfbmFt
ZShtLT5pOTE1LCBpKSwKLQkJCSAgIGVycm9yLT5lbmdpbmVbaV0uY29udGV4dC5jb21tLAotCQkJ
ICAgZXJyb3ItPmVuZ2luZVtpXS5jb250ZXh0LnBpZCk7Ci0JfQorCQkJICAgZWUtPmVuZ2luZS0+
bmFtZSwKKwkJCSAgIGVlLT5jb250ZXh0LmNvbW0sCisJCQkgICBlZS0+Y29udGV4dC5waWQpOwor
CiAJZXJyX3ByaW50ZihtLCAiUmVzZXQgY291bnQ6ICV1XG4iLCBlcnJvci0+cmVzZXRfY291bnQp
OwogCWVycl9wcmludGYobSwgIlN1c3BlbmQgY291bnQ6ICV1XG4iLCBlcnJvci0+c3VzcGVuZF9j
b3VudCk7CiAJZXJyX3ByaW50ZihtLCAiUGxhdGZvcm06ICVzXG4iLCBpbnRlbF9wbGF0Zm9ybV9u
YW1lKGVycm9yLT5kZXZpY2VfaW5mby5wbGF0Zm9ybSkpOwpAQCAtNzYwLDE3ICs3MzUsMTUgQEAg
c3RhdGljIHZvaWQgX19lcnJfcHJpbnRfdG9fc2dsKHN0cnVjdCBkcm1faTkxNV9lcnJvcl9zdGF0
ZV9idWYgKm0sCiAJaWYgKElTX0dFTihtLT5pOTE1LCA3KSkKIAkJZXJyX3ByaW50ZihtLCAiRVJS
X0lOVDogMHglMDh4XG4iLCBlcnJvci0+ZXJyX2ludCk7CiAKLQlmb3IgKGkgPSAwOyBpIDwgQVJS
QVlfU0laRShlcnJvci0+ZW5naW5lKTsgaSsrKSB7Ci0JCWlmIChlcnJvci0+ZW5naW5lW2ldLmVu
Z2luZV9pZCAhPSAtMSkKLQkJCWVycm9yX3ByaW50X2VuZ2luZShtLCAmZXJyb3ItPmVuZ2luZVtp
XSwgZXJyb3ItPmVwb2NoKTsKLQl9CisJZm9yIChlZSA9IGVycm9yLT5lbmdpbmU7IGVlOyBlZSA9
IGVlLT5uZXh0KQorCQllcnJvcl9wcmludF9lbmdpbmUobSwgZWUsIGVycm9yLT5lcG9jaCk7CiAK
LQlmb3IgKGkgPSAwOyBpIDwgQVJSQVlfU0laRShlcnJvci0+ZW5naW5lKTsgaSsrKSB7Ci0JCWNv
bnN0IHN0cnVjdCBkcm1faTkxNV9lcnJvcl9lbmdpbmUgKmVlID0gJmVycm9yLT5lbmdpbmVbaV07
CisJZm9yIChlZSA9IGVycm9yLT5lbmdpbmU7IGVlOyBlZSA9IGVlLT5uZXh0KSB7CisJCWNvbnN0
IHN0cnVjdCBkcm1faTkxNV9lcnJvcl9vYmplY3QgKm9iajsKIAogCQlvYmogPSBlZS0+YmF0Y2hi
dWZmZXI7CiAJCWlmIChvYmopIHsKLQkJCWVycl9wdXRzKG0sIG0tPmk5MTUtPmVuZ2luZVtpXS0+
bmFtZSk7CisJCQllcnJfcHV0cyhtLCBlZS0+ZW5naW5lLT5uYW1lKTsKIAkJCWlmIChlZS0+Y29u
dGV4dC5waWQpCiAJCQkJZXJyX3ByaW50ZihtLCAiIChzdWJtaXR0ZWQgYnkgJXMgWyVkXSkiLAog
CQkJCQkgICBlZS0+Y29udGV4dC5jb21tLApAQCAtNzc4LDE2ICs3NTEsMTUgQEAgc3RhdGljIHZv
aWQgX19lcnJfcHJpbnRfdG9fc2dsKHN0cnVjdCBkcm1faTkxNV9lcnJvcl9zdGF0ZV9idWYgKm0s
CiAJCQllcnJfcHJpbnRmKG0sICIgLS0tIGd0dF9vZmZzZXQgPSAweCUwOHggJTA4eFxuIiwKIAkJ
CQkgICB1cHBlcl8zMl9iaXRzKG9iai0+Z3R0X29mZnNldCksCiAJCQkJICAgbG93ZXJfMzJfYml0
cyhvYmotPmd0dF9vZmZzZXQpKTsKLQkJCXByaW50X2Vycm9yX29iaihtLCBtLT5pOTE1LT5lbmdp
bmVbaV0sIE5VTEwsIG9iaik7CisJCQlwcmludF9lcnJvcl9vYmoobSwgZWUtPmVuZ2luZSwgTlVM
TCwgb2JqKTsKIAkJfQogCiAJCWZvciAoaiA9IDA7IGogPCBlZS0+dXNlcl9ib19jb3VudDsgaisr
KQotCQkJcHJpbnRfZXJyb3Jfb2JqKG0sIG0tPmk5MTUtPmVuZ2luZVtpXSwKLQkJCQkJInVzZXIi
LCBlZS0+dXNlcl9ib1tqXSk7CisJCQlwcmludF9lcnJvcl9vYmoobSwgZWUtPmVuZ2luZSwgInVz
ZXIiLCBlZS0+dXNlcl9ib1tqXSk7CiAKIAkJaWYgKGVlLT5udW1fcmVxdWVzdHMpIHsKIAkJCWVy
cl9wcmludGYobSwgIiVzIC0tLSAlZCByZXF1ZXN0c1xuIiwKLQkJCQkgICBtLT5pOTE1LT5lbmdp
bmVbaV0tPm5hbWUsCisJCQkJICAgZWUtPmVuZ2luZS0+bmFtZSwKIAkJCQkgICBlZS0+bnVtX3Jl
cXVlc3RzKTsKIAkJCWZvciAoaiA9IDA7IGogPCBlZS0+bnVtX3JlcXVlc3RzOyBqKyspCiAJCQkJ
ZXJyb3JfcHJpbnRfcmVxdWVzdChtLCAiICIsCkBAIC03OTUsMjIgKzc2NywxMyBAQCBzdGF0aWMg
dm9pZCBfX2Vycl9wcmludF90b19zZ2woc3RydWN0IGRybV9pOTE1X2Vycm9yX3N0YXRlX2J1ZiAq
bSwKIAkJCQkJCSAgICBlcnJvci0+ZXBvY2gpOwogCQl9CiAKLQkJcHJpbnRfZXJyb3Jfb2JqKG0s
IG0tPmk5MTUtPmVuZ2luZVtpXSwKLQkJCQkicmluZ2J1ZmZlciIsIGVlLT5yaW5nYnVmZmVyKTsK
LQotCQlwcmludF9lcnJvcl9vYmoobSwgbS0+aTkxNS0+ZW5naW5lW2ldLAotCQkJCSJIVyBTdGF0
dXMiLCBlZS0+aHdzX3BhZ2UpOwotCi0JCXByaW50X2Vycm9yX29iaihtLCBtLT5pOTE1LT5lbmdp
bmVbaV0sCi0JCQkJIkhXIGNvbnRleHQiLCBlZS0+Y3R4KTsKLQotCQlwcmludF9lcnJvcl9vYmoo
bSwgbS0+aTkxNS0+ZW5naW5lW2ldLAotCQkJCSJXQSBjb250ZXh0IiwgZWUtPndhX2N0eCk7Ci0K
LQkJcHJpbnRfZXJyb3Jfb2JqKG0sIG0tPmk5MTUtPmVuZ2luZVtpXSwKKwkJcHJpbnRfZXJyb3Jf
b2JqKG0sIGVlLT5lbmdpbmUsICJyaW5nYnVmZmVyIiwgZWUtPnJpbmdidWZmZXIpOworCQlwcmlu
dF9lcnJvcl9vYmoobSwgZWUtPmVuZ2luZSwgIkhXIFN0YXR1cyIsIGVlLT5od3NfcGFnZSk7CisJ
CXByaW50X2Vycm9yX29iaihtLCBlZS0+ZW5naW5lLCAiSFcgY29udGV4dCIsIGVlLT5jdHgpOwor
CQlwcmludF9lcnJvcl9vYmoobSwgZWUtPmVuZ2luZSwgIldBIGNvbnRleHQiLCBlZS0+d2FfY3R4
KTsKKwkJcHJpbnRfZXJyb3Jfb2JqKG0sIGVlLT5lbmdpbmUsCiAJCQkJIldBIGJhdGNoYnVmZmVy
IiwgZWUtPndhX2JhdGNoYnVmZmVyKTsKLQotCQlwcmludF9lcnJvcl9vYmoobSwgbS0+aTkxNS0+
ZW5naW5lW2ldLAorCQlwcmludF9lcnJvcl9vYmoobSwgZWUtPmVuZ2luZSwKIAkJCQkiTlVMTCBj
b250ZXh0IiwgZWUtPmRlZmF1bHRfc3RhdGUpOwogCX0KIApAQCAtOTU5LDEzICs5MjIsMTUgQEAg
dm9pZCBfX2k5MTVfZ3B1X3N0YXRlX2ZyZWUoc3RydWN0IGtyZWYgKmVycm9yX3JlZikKIHsKIAlz
dHJ1Y3QgaTkxNV9ncHVfc3RhdGUgKmVycm9yID0KIAkJY29udGFpbmVyX29mKGVycm9yX3JlZiwg
dHlwZW9mKCplcnJvciksIHJlZik7Ci0JbG9uZyBpLCBqOworCWxvbmcgaTsKIAotCWZvciAoaSA9
IDA7IGkgPCBBUlJBWV9TSVpFKGVycm9yLT5lbmdpbmUpOyBpKyspIHsKLQkJc3RydWN0IGRybV9p
OTE1X2Vycm9yX2VuZ2luZSAqZWUgPSAmZXJyb3ItPmVuZ2luZVtpXTsKKwl3aGlsZSAoZXJyb3It
PmVuZ2luZSkgeworCQlzdHJ1Y3QgZHJtX2k5MTVfZXJyb3JfZW5naW5lICplZSA9IGVycm9yLT5l
bmdpbmU7CiAKLQkJZm9yIChqID0gMDsgaiA8IGVlLT51c2VyX2JvX2NvdW50OyBqKyspCi0JCQlp
OTE1X2Vycm9yX29iamVjdF9mcmVlKGVlLT51c2VyX2JvW2pdKTsKKwkJZXJyb3ItPmVuZ2luZSA9
IGVlLT5uZXh0OworCisJCWZvciAoaSA9IDA7IGkgPCBlZS0+dXNlcl9ib19jb3VudDsgaSsrKQor
CQkJaTkxNV9lcnJvcl9vYmplY3RfZnJlZShlZS0+dXNlcl9ib1tpXSk7CiAJCWtmcmVlKGVlLT51
c2VyX2JvKTsKIAogCQlpOTE1X2Vycm9yX29iamVjdF9mcmVlKGVlLT5iYXRjaGJ1ZmZlcik7CkBA
IC05NzYsNiArOTQxLDcgQEAgdm9pZCBfX2k5MTVfZ3B1X3N0YXRlX2ZyZWUoc3RydWN0IGtyZWYg
KmVycm9yX3JlZikKIAkJaTkxNV9lcnJvcl9vYmplY3RfZnJlZShlZS0+d2FfY3R4KTsKIAogCQlr
ZnJlZShlZS0+cmVxdWVzdHMpOworCQlrZnJlZShlZSk7CiAJfQogCiAJa2ZyZWUoZXJyb3ItPm92
ZXJsYXkpOwpAQCAtMTA1NSwyMyArMTAyMSwxNyBAQCBpOTE1X2Vycm9yX29iamVjdF9jcmVhdGUo
c3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUsCiAgKgogICogSXQncyBvbmx5IGEgc21hbGwg
c3RlcCBiZXR0ZXIgdGhhbiBhIHJhbmRvbSBudW1iZXIgaW4gaXRzIGN1cnJlbnQgZm9ybS4KICAq
Lwotc3RhdGljIHUzMiBpOTE1X2Vycm9yX2dlbmVyYXRlX2NvZGUoc3RydWN0IGk5MTVfZ3B1X3N0
YXRlICplcnJvciwKLQkJCQkgICAgaW50ZWxfZW5naW5lX21hc2tfdCBlbmdpbmVfbWFzaykKK3N0
YXRpYyB1MzIgaTkxNV9lcnJvcl9nZW5lcmF0ZV9jb2RlKHN0cnVjdCBpOTE1X2dwdV9zdGF0ZSAq
ZXJyb3IpCiB7CisJY29uc3Qgc3RydWN0IGRybV9pOTE1X2Vycm9yX2VuZ2luZSAqZWUgPSBlcnJv
ci0+ZW5naW5lOworCiAJLyoKIAkgKiBJUEVIUiB3b3VsZCBiZSBhbiBpZGVhbCB3YXkgdG8gZGV0
ZWN0IGVycm9ycywgYXMgaXQncyB0aGUgZ3Jvc3MKIAkgKiBtZWFzdXJlIG9mICJ0aGUgY29tbWFu
ZCB0aGF0IGh1bmcuIiBIb3dldmVyLCBoYXMgc29tZSB2ZXJ5IGNvbW1vbgogCSAqIHN5bmNocm9u
aXphdGlvbiBjb21tYW5kcyB3aGljaCBhbG1vc3QgYWx3YXlzIGFwcGVhciBpbiB0aGUgY2FzZQog
CSAqIHN0cmljdGx5IGEgY2xpZW50IGJ1Zy4gVXNlIGluc3Rkb25lIHRvIGRpZmZlcmVudGlhdGUg
dGhvc2Ugc29tZS4KIAkgKi8KLQlpZiAoZW5naW5lX21hc2spIHsKLQkJc3RydWN0IGRybV9pOTE1
X2Vycm9yX2VuZ2luZSAqZWUgPQotCQkJJmVycm9yLT5lbmdpbmVbZmZzKGVuZ2luZV9tYXNrKV07
Ci0KLQkJcmV0dXJuIGVlLT5pcGVociBeIGVlLT5pbnN0ZG9uZS5pbnN0ZG9uZTsKLQl9Ci0KLQly
ZXR1cm4gMDsKKwlyZXR1cm4gZWUgPyBlZS0+aXBlaHIgXiBlZS0+aW5zdGRvbmUuaW5zdGRvbmUg
OiAwOwogfQogCiBzdGF0aWMgdm9pZCBnZW1fcmVjb3JkX2ZlbmNlcyhzdHJ1Y3QgaTkxNV9ncHVf
c3RhdGUgKmVycm9yKQpAQCAtMTI4MSw5ICsxMjQxLDExIEBAIHN0YXRpYyB2b2lkIGVycm9yX3Jl
Y29yZF9lbmdpbmVfZXhlY2xpc3RzKGNvbnN0IHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2lu
ZSwKIAllZS0+bnVtX3BvcnRzID0gbjsKIH0KIAotc3RhdGljIHZvaWQgcmVjb3JkX2NvbnRleHQo
c3RydWN0IGRybV9pOTE1X2Vycm9yX2NvbnRleHQgKmUsCi0JCQkgICBzdHJ1Y3QgaTkxNV9nZW1f
Y29udGV4dCAqY3R4KQorc3RhdGljIGJvb2wgcmVjb3JkX2NvbnRleHQoc3RydWN0IGRybV9pOTE1
X2Vycm9yX2NvbnRleHQgKmUsCisJCQkgICBjb25zdCBzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSkK
IHsKKwljb25zdCBzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4ID0gcnEtPmdlbV9jb250ZXh0
OworCiAJaWYgKGN0eC0+cGlkKSB7CiAJCXN0cnVjdCB0YXNrX3N0cnVjdCAqdGFzazsKIApAQCAt
MTMwMCw2ICsxMjYyLDggQEAgc3RhdGljIHZvaWQgcmVjb3JkX2NvbnRleHQoc3RydWN0IGRybV9p
OTE1X2Vycm9yX2NvbnRleHQgKmUsCiAJZS0+c2NoZWRfYXR0ciA9IGN0eC0+c2NoZWQ7CiAJZS0+
Z3VpbHR5ID0gYXRvbWljX3JlYWQoJmN0eC0+Z3VpbHR5X2NvdW50KTsKIAllLT5hY3RpdmUgPSBh
dG9taWNfcmVhZCgmY3R4LT5hY3RpdmVfY291bnQpOworCisJcmV0dXJuIGk5MTVfZ2VtX2NvbnRl
eHRfbm9fZXJyb3JfY2FwdHVyZShjdHgpOwogfQogCiBzdGF0aWMgdm9pZApAQCAtMTM2NCw3NCAr
MTMyOCw2OCBAQCBzdGF0aWMgdm9pZAogZ2VtX3JlY29yZF9yaW5ncyhzdHJ1Y3QgaTkxNV9ncHVf
c3RhdGUgKmVycm9yLCBzdHJ1Y3QgY29tcHJlc3MgKmNvbXByZXNzKQogewogCXN0cnVjdCBkcm1f
aTkxNV9wcml2YXRlICppOTE1ID0gZXJyb3ItPmk5MTU7Ci0JaW50IGk7CisJc3RydWN0IGludGVs
X2VuZ2luZV9jcyAqZW5naW5lOworCXN0cnVjdCBkcm1faTkxNV9lcnJvcl9lbmdpbmUgKmVlOwor
CisJZWUgPSBremFsbG9jKHNpemVvZigqZWUpLCBHRlBfS0VSTkVMKTsKKwlpZiAoIWVlKQorCQly
ZXR1cm47CiAKLQlmb3IgKGkgPSAwOyBpIDwgSTkxNV9OVU1fRU5HSU5FUzsgaSsrKSB7Ci0JCXN0
cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSA9IGk5MTUtPmVuZ2luZVtpXTsKLQkJc3RydWN0
IGRybV9pOTE1X2Vycm9yX2VuZ2luZSAqZWUgPSAmZXJyb3ItPmVuZ2luZVtpXTsKKwlmb3JfZWFj
aF91c2VyX2VuZ2luZShlbmdpbmUsIGk5MTUpIHsKIAkJc3RydWN0IGk5MTVfcmVxdWVzdCAqcmVx
dWVzdDsKIAkJdW5zaWduZWQgbG9uZyBmbGFnczsKIAotCQllZS0+ZW5naW5lX2lkID0gLTE7Ci0K
LQkJaWYgKCFlbmdpbmUpCi0JCQljb250aW51ZTsKLQotCQllZS0+ZW5naW5lX2lkID0gaTsKLQog
CQkvKiBSZWZpbGwgb3VyIHBhZ2UgcG9vbCBiZWZvcmUgZW50ZXJpbmcgYXRvbWljIHNlY3Rpb24g
Ki8KIAkJcG9vbF9yZWZpbGwoJmNvbXByZXNzLT5wb29sLCBBTExPV19GQUlMKTsKIAotCQllcnJv
cl9yZWNvcmRfZW5naW5lX3JlZ2lzdGVycyhlcnJvciwgZW5naW5lLCBlZSk7Ci0JCWVycm9yX3Jl
Y29yZF9lbmdpbmVfZXhlY2xpc3RzKGVuZ2luZSwgZWUpOwotCiAJCXNwaW5fbG9ja19pcnFzYXZl
KCZlbmdpbmUtPmFjdGl2ZS5sb2NrLCBmbGFncyk7CiAJCXJlcXVlc3QgPSBpbnRlbF9lbmdpbmVf
ZmluZF9hY3RpdmVfcmVxdWVzdChlbmdpbmUpOwotCQlpZiAocmVxdWVzdCkgewotCQkJc3RydWN0
IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCA9IHJlcXVlc3QtPmdlbV9jb250ZXh0OwotCQkJc3RydWN0
IGludGVsX3JpbmcgKnJpbmcgPSByZXF1ZXN0LT5yaW5nOwotCi0JCQlyZWNvcmRfY29udGV4dCgm
ZWUtPmNvbnRleHQsIGN0eCk7CisJCWlmICghcmVxdWVzdCkgeworCQkJc3Bpbl91bmxvY2tfaXJx
cmVzdG9yZSgmZW5naW5lLT5hY3RpdmUubG9jaywgZmxhZ3MpOworCQkJY29udGludWU7CisJCX0K
IAotCQkJLyogV2UgbmVlZCB0byBjb3B5IHRoZXNlIHRvIGFuIGFub255bW91cyBidWZmZXIKLQkJ
CSAqIGFzIHRoZSBzaW1wbGVzdCBtZXRob2QgdG8gYXZvaWQgYmVpbmcgb3ZlcndyaXR0ZW4KLQkJ
CSAqIGJ5IHVzZXJzcGFjZS4KLQkJCSAqLwotCQkJZWUtPmJhdGNoYnVmZmVyID0KLQkJCQlpOTE1
X2Vycm9yX29iamVjdF9jcmVhdGUoaTkxNSwKLQkJCQkJCQkgcmVxdWVzdC0+YmF0Y2gsCi0JCQkJ
CQkJIGNvbXByZXNzKTsKKwkJZXJyb3ItPnNpbXVsYXRlZCB8PSByZWNvcmRfY29udGV4dCgmZWUt
PmNvbnRleHQsIHJlcXVlc3QpOwogCi0JCQlpZiAoSEFTX0JST0tFTl9DU19UTEIoaTkxNSkpCi0J
CQkJZWUtPndhX2JhdGNoYnVmZmVyID0KLQkJCQkgIGk5MTVfZXJyb3Jfb2JqZWN0X2NyZWF0ZShp
OTE1LAotCQkJCQkJCSAgIGVuZ2luZS0+Z3QtPnNjcmF0Y2gsCi0JCQkJCQkJICAgY29tcHJlc3Mp
OwotCQkJcmVxdWVzdF9yZWNvcmRfdXNlcl9ibyhyZXF1ZXN0LCBlZSwgY29tcHJlc3MpOworCQkv
KgorCQkgKiBXZSBuZWVkIHRvIGNvcHkgdGhlc2UgdG8gYW4gYW5vbnltb3VzIGJ1ZmZlcgorCQkg
KiBhcyB0aGUgc2ltcGxlc3QgbWV0aG9kIHRvIGF2b2lkIGJlaW5nIG92ZXJ3cml0dGVuCisJCSAq
IGJ5IHVzZXJzcGFjZS4KKwkJICovCisJCWVlLT5iYXRjaGJ1ZmZlciA9CisJCQlpOTE1X2Vycm9y
X29iamVjdF9jcmVhdGUoaTkxNSwKKwkJCQkJCSByZXF1ZXN0LT5iYXRjaCwKKwkJCQkJCSBjb21w
cmVzcyk7CiAKLQkJCWVlLT5jdHggPQorCQlpZiAoSEFTX0JST0tFTl9DU19UTEIoaTkxNSkpCisJ
CQllZS0+d2FfYmF0Y2hidWZmZXIgPQogCQkJCWk5MTVfZXJyb3Jfb2JqZWN0X2NyZWF0ZShpOTE1
LAotCQkJCQkJCSByZXF1ZXN0LT5od19jb250ZXh0LT5zdGF0ZSwKKwkJCQkJCQkgZW5naW5lLT5n
dC0+c2NyYXRjaCwKIAkJCQkJCQkgY29tcHJlc3MpOworCQlyZXF1ZXN0X3JlY29yZF91c2VyX2Jv
KHJlcXVlc3QsIGVlLCBjb21wcmVzcyk7CiAKLQkJCWVycm9yLT5zaW11bGF0ZWQgfD0KLQkJCQlp
OTE1X2dlbV9jb250ZXh0X25vX2Vycm9yX2NhcHR1cmUoY3R4KTsKKwkJZWUtPmN0eCA9CisJCQlp
OTE1X2Vycm9yX29iamVjdF9jcmVhdGUoaTkxNSwKKwkJCQkJCSByZXF1ZXN0LT5od19jb250ZXh0
LT5zdGF0ZSwKKwkJCQkJCSBjb21wcmVzcyk7CiAKLQkJCWVlLT5ycV9oZWFkID0gcmVxdWVzdC0+
aGVhZDsKLQkJCWVlLT5ycV9wb3N0ID0gcmVxdWVzdC0+cG9zdGZpeDsKLQkJCWVlLT5ycV90YWls
ID0gcmVxdWVzdC0+dGFpbDsKKwkJZWUtPnJxX2hlYWQgPSByZXF1ZXN0LT5oZWFkOworCQllZS0+
cnFfcG9zdCA9IHJlcXVlc3QtPnBvc3RmaXg7CisJCWVlLT5ycV90YWlsID0gcmVxdWVzdC0+dGFp
bDsKIAotCQkJZWUtPmNwdV9yaW5nX2hlYWQgPSByaW5nLT5oZWFkOwotCQkJZWUtPmNwdV9yaW5n
X3RhaWwgPSByaW5nLT50YWlsOwotCQkJZWUtPnJpbmdidWZmZXIgPQotCQkJCWk5MTVfZXJyb3Jf
b2JqZWN0X2NyZWF0ZShpOTE1LAotCQkJCQkJCSByaW5nLT52bWEsCi0JCQkJCQkJIGNvbXByZXNz
KTsKKwkJZWUtPmNwdV9yaW5nX2hlYWQgPSByZXF1ZXN0LT5yaW5nLT5oZWFkOworCQllZS0+Y3B1
X3JpbmdfdGFpbCA9IHJlcXVlc3QtPnJpbmctPnRhaWw7CisJCWVlLT5yaW5nYnVmZmVyID0KKwkJ
CWk5MTVfZXJyb3Jfb2JqZWN0X2NyZWF0ZShpOTE1LAorCQkJCQkJIHJlcXVlc3QtPnJpbmctPnZt
YSwKKwkJCQkJCSBjb21wcmVzcyk7CiAKLQkJCWVuZ2luZV9yZWNvcmRfcmVxdWVzdHMoZW5naW5l
LCByZXF1ZXN0LCBlZSk7Ci0JCX0KKwkJZW5naW5lX3JlY29yZF9yZXF1ZXN0cyhlbmdpbmUsIHJl
cXVlc3QsIGVlKTsKIAkJc3Bpbl91bmxvY2tfaXJxcmVzdG9yZSgmZW5naW5lLT5hY3RpdmUubG9j
aywgZmxhZ3MpOwogCisJCWVycm9yX3JlY29yZF9lbmdpbmVfcmVnaXN0ZXJzKGVycm9yLCBlbmdp
bmUsIGVlKTsKKwkJZXJyb3JfcmVjb3JkX2VuZ2luZV9leGVjbGlzdHMoZW5naW5lLCBlZSk7CisK
IAkJZWUtPmh3c19wYWdlID0KIAkJCWk5MTVfZXJyb3Jfb2JqZWN0X2NyZWF0ZShpOTE1LAogCQkJ
CQkJIGVuZ2luZS0+c3RhdHVzX3BhZ2Uudm1hLApAQCAtMTQ0NCw3ICsxNDAyLDE4IEBAIGdlbV9y
ZWNvcmRfcmluZ3Moc3RydWN0IGk5MTVfZ3B1X3N0YXRlICplcnJvciwgc3RydWN0IGNvbXByZXNz
ICpjb21wcmVzcykKIAogCQllZS0+ZGVmYXVsdF9zdGF0ZSA9CiAJCQljYXB0dXJlX29iamVjdChp
OTE1LCBlbmdpbmUtPmRlZmF1bHRfc3RhdGUsIGNvbXByZXNzKTsKKworCQllZS0+ZW5naW5lID0g
ZW5naW5lOworCisJCWVlLT5uZXh0ID0gZXJyb3ItPmVuZ2luZTsKKwkJZXJyb3ItPmVuZ2luZSA9
IGVlOworCisJCWVlID0ga3phbGxvYyhzaXplb2YoKmVlKSwgR0ZQX0tFUk5FTCk7CisJCWlmICgh
ZWUpCisJCQlyZXR1cm47CiAJfQorCisJa2ZyZWUoZWUpOwogfQogCiBzdGF0aWMgdm9pZApAQCAt
MTU3MywyNCArMTU0MiwxOCBAQCBlcnJvcl9tc2coc3RydWN0IGk5MTVfZ3B1X3N0YXRlICplcnJv
ciwKIAkgIGludGVsX2VuZ2luZV9tYXNrX3QgZW5naW5lcywgY29uc3QgY2hhciAqbXNnKQogewog
CWludCBsZW47Ci0JaW50IGk7Ci0KLQlmb3IgKGkgPSAwOyBpIDwgQVJSQVlfU0laRShlcnJvci0+
ZW5naW5lKTsgaSsrKQotCQlpZiAoIWVycm9yLT5lbmdpbmVbaV0uY29udGV4dC5waWQpCi0JCQll
bmdpbmVzICY9IH5CSVQoaSk7CiAKIAlsZW4gPSBzY25wcmludGYoZXJyb3ItPmVycm9yX21zZywg
c2l6ZW9mKGVycm9yLT5lcnJvcl9tc2cpLAogCQkJIkdQVSBIQU5HOiBlY29kZSAlZDoleDoweCUw
OHgiLAogCQkJSU5URUxfR0VOKGVycm9yLT5pOTE1KSwgZW5naW5lcywKLQkJCWk5MTVfZXJyb3Jf
Z2VuZXJhdGVfY29kZShlcnJvciwgZW5naW5lcykpOwotCWlmIChlbmdpbmVzKSB7CisJCQlpOTE1
X2Vycm9yX2dlbmVyYXRlX2NvZGUoZXJyb3IpKTsKKwlpZiAoZXJyb3ItPmVuZ2luZSkgewogCQkv
KiBKdXN0IHNob3cgdGhlIGZpcnN0IGV4ZWN1dGluZyBwcm9jZXNzLCBtb3JlIGlzIGNvbmZ1c2lu
ZyAqLwotCQlpID0gX19mZnMoZW5naW5lcyk7CiAJCWxlbiArPSBzY25wcmludGYoZXJyb3ItPmVy
cm9yX21zZyArIGxlbiwKIAkJCQkgc2l6ZW9mKGVycm9yLT5lcnJvcl9tc2cpIC0gbGVuLAogCQkJ
CSAiLCBpbiAlcyBbJWRdIiwKLQkJCQkgZXJyb3ItPmVuZ2luZVtpXS5jb250ZXh0LmNvbW0sCi0J
CQkJIGVycm9yLT5lbmdpbmVbaV0uY29udGV4dC5waWQpOworCQkJCSBlcnJvci0+ZW5naW5lLT5j
b250ZXh0LmNvbW0sCisJCQkJIGVycm9yLT5lbmdpbmUtPmNvbnRleHQucGlkKTsKIAl9CiAJaWYg
KG1zZykKIAkJbGVuICs9IHNjbnByaW50ZihlcnJvci0+ZXJyb3JfbXNnICsgbGVuLApAQCAtMTYz
MSwxMiArMTU5NCwxMCBAQCBzdGF0aWMgdm9pZCBjYXB0dXJlX3BhcmFtcyhzdHJ1Y3QgaTkxNV9n
cHVfc3RhdGUgKmVycm9yKQogCiBzdGF0aWMgdW5zaWduZWQgbG9uZyBjYXB0dXJlX2ZpbmRfZXBv
Y2goY29uc3Qgc3RydWN0IGk5MTVfZ3B1X3N0YXRlICplcnJvcikKIHsKKwljb25zdCBzdHJ1Y3Qg
ZHJtX2k5MTVfZXJyb3JfZW5naW5lICplZTsKIAl1bnNpZ25lZCBsb25nIGVwb2NoID0gZXJyb3It
PmNhcHR1cmU7Ci0JaW50IGk7Ci0KLQlmb3IgKGkgPSAwOyBpIDwgQVJSQVlfU0laRShlcnJvci0+
ZW5naW5lKTsgaSsrKSB7Ci0JCWNvbnN0IHN0cnVjdCBkcm1faTkxNV9lcnJvcl9lbmdpbmUgKmVl
ID0gJmVycm9yLT5lbmdpbmVbaV07CiAKKwlmb3IgKGVlID0gZXJyb3ItPmVuZ2luZTsgZWU7IGVl
ID0gZWUtPm5leHQpIHsKIAkJaWYgKGVlLT5oYW5nY2hlY2tfdGltZXN0YW1wICYmCiAJCSAgICB0
aW1lX2JlZm9yZShlZS0+aGFuZ2NoZWNrX3RpbWVzdGFtcCwgZXBvY2gpKQogCQkJZXBvY2ggPSBl
ZS0+aGFuZ2NoZWNrX3RpbWVzdGFtcDsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2k5MTVfZ3B1X2Vycm9yLmggYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dwdV9lcnJvci5o
CmluZGV4IGEyNGMzNTEwN2QxNi4uZGY5ZjU3NzY2NjI2IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9pOTE1X2dwdV9lcnJvci5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5
MTVfZ3B1X2Vycm9yLmgKQEAgLTgxLDcgKzgxLDggQEAgc3RydWN0IGk5MTVfZ3B1X3N0YXRlIHsK
IAlzdHJ1Y3QgaW50ZWxfZGlzcGxheV9lcnJvcl9zdGF0ZSAqZGlzcGxheTsKIAogCXN0cnVjdCBk
cm1faTkxNV9lcnJvcl9lbmdpbmUgewotCQlpbnQgZW5naW5lX2lkOworCQljb25zdCBzdHJ1Y3Qg
aW50ZWxfZW5naW5lX2NzICplbmdpbmU7CisKIAkJLyogU29mdHdhcmUgdHJhY2tlZCBzdGF0ZSAq
LwogCQlib29sIGlkbGU7CiAJCXVuc2lnbmVkIGxvbmcgaGFuZ2NoZWNrX3RpbWVzdGFtcDsKQEAg
LTE1OCw3ICsxNTksOSBAQCBzdHJ1Y3QgaTkxNV9ncHVfc3RhdGUgewogCQkJCXUzMiBwcF9kaXJf
YmFzZTsKIAkJCX07CiAJCX0gdm1faW5mbzsKLQl9IGVuZ2luZVtJOTE1X05VTV9FTkdJTkVTXTsK
KworCQlzdHJ1Y3QgZHJtX2k5MTVfZXJyb3JfZW5naW5lICpuZXh0OworCX0gKmVuZ2luZTsKIAog
CXN0cnVjdCBzY2F0dGVybGlzdCAqc2dsLCAqZml0OwogfTsKLS0gCjIuMjIuMAoKX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcg
bGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRl
c2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

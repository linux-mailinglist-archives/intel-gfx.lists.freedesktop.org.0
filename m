Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id A71EB89FE1
	for <lists+intel-gfx@lfdr.de>; Mon, 12 Aug 2019 15:41:10 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 004216E508;
	Mon, 12 Aug 2019 13:41:09 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 85AD86E514
 for <intel-gfx@lists.freedesktop.org>; Mon, 12 Aug 2019 13:41:05 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17969918-1500050 
 for multiple; Mon, 12 Aug 2019 14:39:17 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 12 Aug 2019 14:39:01 +0100
Message-Id: <20190812133915.18824-4-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0.rc1
In-Reply-To: <20190812133915.18824-1-chris@chris-wilson.co.uk>
References: <20190812133915.18824-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 04/18] drm/i915/execlists: Lift process_csb()
 out of the irq-off spinlock
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SWYgd2Ugb25seSBjYWxsIHByb2Nlc3NfY3NiKCkgZnJvbSB0aGUgdGFza2xldCwgdGhvdWdoIHdl
IGxvc2UgdGhlCmFiaWxpdHkgdG8gYnlwYXNzIGtzb2Z0aXJxZCBpbnRlcnJ1cHQgcHJvY2Vzc2lu
ZyBvbiBkaXJlY3Qgc3VibWlzc2lvbgpwYXRocywgd2UgY2FuIHB1c2ggaXQgb3V0IG9mIHRoZSBp
cnEtb2ZmIHNwaW5sb2NrLgoKVGhlIHBlbmFsdHkgaXMgdGhhdCB3ZSB0aGVuIGFsbG93IHNjaGVk
dWxlX291dCB0byBiZSBjYWxsZWQgY29uY3VycmVudGx5CndpdGggc2NoZWR1bGVfaW4gcmVxdWly
aW5nIHVzIHRvIGhhbmRsZSB0aGUgdXNhZ2UgY291bnQgKGJha2VkIGludG8gdGhlCnBvaW50ZXIg
aXRzZWxmKSBhdG9taWNhbGx5LgoKQXMgd2UgZG8ga2ljayB0aGUgdGFza2xldHMgKHZpYSBsb2Nh
bF9iaF9lbmFibGUoKSkgYWZ0ZXIgb3VyIHN1Ym1pc3Npb24sCnRoZXJlIGlzIGEgcG9zc2liaWxp
dHkgdGhlcmUgdG8gc2VlIGlmIHdlIGNhbiBwdWxsIHRoZSBsb2NhbCBzb2Z0aXJxCnByb2Nlc3Np
bmcgYmFjayBmcm9tIHRoZSBrc29mdGlycWQuCgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24g
PGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9p
bnRlbF9jb250ZXh0X3R5cGVzLmggfCAgIDQgKy0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2lu
dGVsX2VuZ2luZV9jcy5jICAgICB8ICAgMiArLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50
ZWxfbHJjLmMgICAgICAgICAgIHwgMTMwICsrKysrKysrKysrLS0tLS0tLQogZHJpdmVycy9ncHUv
ZHJtL2k5MTUvaTkxNV91dGlscy5oICAgICAgICAgICAgIHwgIDIwICsrLQogNCBmaWxlcyBjaGFu
Z2VkLCA5NCBpbnNlcnRpb25zKCspLCA2MiBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9jb250ZXh0X3R5cGVzLmggYi9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9ndC9pbnRlbF9jb250ZXh0X3R5cGVzLmgKaW5kZXggYTYzMmIyMGVjNGQ4Li5kOGNl
MjY2YzA0OWYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2NvbnRl
eHRfdHlwZXMuaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9jb250ZXh0X3R5
cGVzLmgKQEAgLTQxLDkgKzQxLDcgQEAgc3RydWN0IGludGVsX2NvbnRleHQgewogCXN0cnVjdCBp
bnRlbF9lbmdpbmVfY3MgKmVuZ2luZTsKIAlzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICppbmZsaWdo
dDsKICNkZWZpbmUgaW50ZWxfY29udGV4dF9pbmZsaWdodChjZSkgcHRyX21hc2tfYml0cygoY2Up
LT5pbmZsaWdodCwgMikKLSNkZWZpbmUgaW50ZWxfY29udGV4dF9pbmZsaWdodF9jb3VudChjZSkg
IHB0cl91bm1hc2tfYml0cygoY2UpLT5pbmZsaWdodCwgMikKLSNkZWZpbmUgaW50ZWxfY29udGV4
dF9pbmZsaWdodF9pbmMoY2UpIHB0cl9jb3VudF9pbmMoJihjZSktPmluZmxpZ2h0KQotI2RlZmlu
ZSBpbnRlbF9jb250ZXh0X2luZmxpZ2h0X2RlYyhjZSkgcHRyX2NvdW50X2RlYygmKGNlKS0+aW5m
bGlnaHQpCisjZGVmaW5lIGludGVsX2NvbnRleHRfaW5mbGlnaHRfY291bnQoY2UpIHB0cl91bm1h
c2tfYml0cygoY2UpLT5pbmZsaWdodCwgMikKIAogCXN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2Ug
KnZtOwogCXN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICpnZW1fY29udGV4dDsKZGlmZiAtLWdpdCBh
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZV9jcy5jIGIvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvZ3QvaW50ZWxfZW5naW5lX2NzLmMKaW5kZXggYzdiMjQxNDE3ZWUxLi4xM2E1Njk5
MDdjM2QgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZV9j
cy5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZV9jcy5jCkBAIC0x
NDU5LDcgKzE0NTksNyBAQCBpbnQgaW50ZWxfZW5hYmxlX2VuZ2luZV9zdGF0cyhzdHJ1Y3QgaW50
ZWxfZW5naW5lX2NzICplbmdpbmUpCiAKIAkJZm9yIChwb3J0ID0gZXhlY2xpc3RzLT5wZW5kaW5n
OyAocnEgPSAqcG9ydCk7IHBvcnQrKykgewogCQkJLyogRXhjbHVkZSBhbnkgY29udGV4dHMgYWxy
ZWFkeSBjb3VudGVkIGluIGFjdGl2ZSAqLwotCQkJaWYgKGludGVsX2NvbnRleHRfaW5mbGlnaHRf
Y291bnQocnEtPmh3X2NvbnRleHQpID09IDEpCisJCQlpZiAoIWludGVsX2NvbnRleHRfaW5mbGln
aHRfY291bnQocnEtPmh3X2NvbnRleHQpKQogCQkJCWVuZ2luZS0+c3RhdHMuYWN0aXZlKys7CiAJ
CX0KIApkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjLmMgYi9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9scmMuYwppbmRleCA1YzI2YzRhZTEzOWIuLjk0
NWYzYWNjMmU3NSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJj
LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjLmMKQEAgLTU0NywyNyAr
NTQ3LDM5IEBAIGV4ZWNsaXN0c19jb250ZXh0X3N0YXR1c19jaGFuZ2Uoc3RydWN0IGk5MTVfcmVx
dWVzdCAqcnEsIHVuc2lnbmVkIGxvbmcgc3RhdHVzKQogCQkJCSAgIHN0YXR1cywgcnEpOwogfQog
CitzdGF0aWMgaW5saW5lIHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKgorX19leGVjbGlzdHNfc2No
ZWR1bGVfaW4oc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEpCit7CisJc3RydWN0IGludGVsX2VuZ2lu
ZV9jcyAqIGNvbnN0IGVuZ2luZSA9IHJxLT5lbmdpbmU7CisJc3RydWN0IGludGVsX2NvbnRleHQg
KiBjb25zdCBjZSA9IHJxLT5od19jb250ZXh0OworCisJaW50ZWxfY29udGV4dF9nZXQoY2UpOwor
CisJaW50ZWxfZ3RfcG1fZ2V0KGVuZ2luZS0+Z3QpOworCWV4ZWNsaXN0c19jb250ZXh0X3N0YXR1
c19jaGFuZ2UocnEsIElOVEVMX0NPTlRFWFRfU0NIRURVTEVfSU4pOworCWludGVsX2VuZ2luZV9j
b250ZXh0X2luKGVuZ2luZSk7CisKKwlyZXR1cm4gZW5naW5lOworfQorCiBzdGF0aWMgaW5saW5l
IHN0cnVjdCBpOTE1X3JlcXVlc3QgKgogZXhlY2xpc3RzX3NjaGVkdWxlX2luKHN0cnVjdCBpOTE1
X3JlcXVlc3QgKnJxLCBpbnQgaWR4KQogewotCXN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSA9IHJx
LT5od19jb250ZXh0OwotCWludCBjb3VudDsKKwlzdHJ1Y3QgaW50ZWxfY29udGV4dCAqIGNvbnN0
IGNlID0gcnEtPmh3X2NvbnRleHQ7CisJc3RydWN0IGludGVsX2VuZ2luZV9jcyAqb2xkOwogCisJ
R0VNX0JVR19PTighaW50ZWxfZW5naW5lX3BtX2lzX2F3YWtlKHJxLT5lbmdpbmUpKTsKIAl0cmFj
ZV9pOTE1X3JlcXVlc3RfaW4ocnEsIGlkeCk7CiAKLQljb3VudCA9IGludGVsX2NvbnRleHRfaW5m
bGlnaHRfY291bnQoY2UpOwotCWlmICghY291bnQpIHsKLQkJaW50ZWxfY29udGV4dF9nZXQoY2Up
OwotCQljZS0+aW5mbGlnaHQgPSBycS0+ZW5naW5lOwotCi0JCWludGVsX2d0X3BtX2dldChjZS0+
aW5mbGlnaHQtPmd0KTsKLQkJZXhlY2xpc3RzX2NvbnRleHRfc3RhdHVzX2NoYW5nZShycSwgSU5U
RUxfQ09OVEVYVF9TQ0hFRFVMRV9JTik7Ci0JCWludGVsX2VuZ2luZV9jb250ZXh0X2luKGNlLT5p
bmZsaWdodCk7Ci0JfQorCW9sZCA9IFJFQURfT05DRShjZS0+aW5mbGlnaHQpOworCWRvIHsKKwkJ
aWYgKCFvbGQpIHsKKwkJCVdSSVRFX09OQ0UoY2UtPmluZmxpZ2h0LCBfX2V4ZWNsaXN0c19zY2hl
ZHVsZV9pbihycSkpOworCQkJYnJlYWs7CisJCX0KKwl9IHdoaWxlICghdHJ5X2NtcHhjaGcoJmNl
LT5pbmZsaWdodCwgJm9sZCwgcHRyX2luYyhvbGQpKSk7CiAKLQlpbnRlbF9jb250ZXh0X2luZmxp
Z2h0X2luYyhjZSk7CiAJR0VNX0JVR19PTihpbnRlbF9jb250ZXh0X2luZmxpZ2h0KGNlKSAhPSBy
cS0+ZW5naW5lKTsKLQogCXJldHVybiBpOTE1X3JlcXVlc3RfZ2V0KHJxKTsKIH0KIApAQCAtNTgx
LDM1ICs1OTMsNDUgQEAgc3RhdGljIHZvaWQga2lja19zaWJsaW5ncyhzdHJ1Y3QgaTkxNV9yZXF1
ZXN0ICpycSwgc3RydWN0IGludGVsX2NvbnRleHQgKmNlKQogfQogCiBzdGF0aWMgaW5saW5lIHZv
aWQKLWV4ZWNsaXN0c19zY2hlZHVsZV9vdXQoc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEpCitfX2V4
ZWNsaXN0c19zY2hlZHVsZV9vdXQoc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEpCiB7Ci0Jc3RydWN0
IGludGVsX2NvbnRleHQgKmNlID0gcnEtPmh3X2NvbnRleHQ7CisJc3RydWN0IGludGVsX2VuZ2lu
ZV9jcyAqIGNvbnN0IGVuZ2luZSA9IHJxLT5lbmdpbmU7CisJc3RydWN0IGludGVsX2NvbnRleHQg
KiBjb25zdCBjZSA9IHJxLT5od19jb250ZXh0OwogCi0JR0VNX0JVR19PTighaW50ZWxfY29udGV4
dF9pbmZsaWdodF9jb3VudChjZSkpOworCWludGVsX2VuZ2luZV9jb250ZXh0X291dChlbmdpbmUp
OworCWV4ZWNsaXN0c19jb250ZXh0X3N0YXR1c19jaGFuZ2UocnEsIElOVEVMX0NPTlRFWFRfU0NI
RURVTEVfT1VUKTsKKwlpbnRlbF9ndF9wbV9wdXQoZW5naW5lLT5ndCk7CiAKLQl0cmFjZV9pOTE1
X3JlcXVlc3Rfb3V0KHJxKTsKKwkvKgorCSAqIElmIHRoaXMgaXMgcGFydCBvZiBhIHZpcnR1YWwg
ZW5naW5lLCBpdHMgbmV4dCByZXF1ZXN0IG1heQorCSAqIGhhdmUgYmVlbiBibG9ja2VkIHdhaXRp
bmcgZm9yIGFjY2VzcyB0byB0aGUgYWN0aXZlIGNvbnRleHQuCisJICogV2UgaGF2ZSB0byBraWNr
IGFsbCB0aGUgc2libGluZ3MgYWdhaW4gaW4gY2FzZSB3ZSBuZWVkIHRvCisJICogc3dpdGNoIChl
LmcuIHRoZSBuZXh0IHJlcXVlc3QgaXMgbm90IHJ1bm5hYmxlIG9uIHRoaXMKKwkgKiBlbmdpbmUp
LiBIb3BlZnVsbHksIHdlIHdpbGwgYWxyZWFkeSBoYXZlIHN1Ym1pdHRlZCB0aGUgbmV4dAorCSAq
IHJlcXVlc3QgYmVmb3JlIHRoZSB0YXNrbGV0IHJ1bnMgYW5kIGRvIG5vdCBuZWVkIHRvIHJlYnVp
bGQKKwkgKiBlYWNoIHZpcnR1YWwgdHJlZSBhbmQga2ljayBldmVyeW9uZSBhZ2Fpbi4KKwkgKi8K
KwlpZiAoY2UtPmVuZ2luZSAhPSBlbmdpbmUpCisJCWtpY2tfc2libGluZ3MocnEsIGNlKTsKIAot
CWludGVsX2NvbnRleHRfaW5mbGlnaHRfZGVjKGNlKTsKLQlpZiAoIWludGVsX2NvbnRleHRfaW5m
bGlnaHRfY291bnQoY2UpKSB7Ci0JCWludGVsX2VuZ2luZV9jb250ZXh0X291dChjZS0+aW5mbGln
aHQpOwotCQlleGVjbGlzdHNfY29udGV4dF9zdGF0dXNfY2hhbmdlKHJxLCBJTlRFTF9DT05URVhU
X1NDSEVEVUxFX09VVCk7Ci0JCWludGVsX2d0X3BtX3B1dChjZS0+aW5mbGlnaHQtPmd0KTsKKwlp
bnRlbF9jb250ZXh0X3B1dChjZSk7Cit9CiAKLQkJLyoKLQkJICogSWYgdGhpcyBpcyBwYXJ0IG9m
IGEgdmlydHVhbCBlbmdpbmUsIGl0cyBuZXh0IHJlcXVlc3QgbWF5Ci0JCSAqIGhhdmUgYmVlbiBi
bG9ja2VkIHdhaXRpbmcgZm9yIGFjY2VzcyB0byB0aGUgYWN0aXZlIGNvbnRleHQuCi0JCSAqIFdl
IGhhdmUgdG8ga2ljayBhbGwgdGhlIHNpYmxpbmdzIGFnYWluIGluIGNhc2Ugd2UgbmVlZCB0bwot
CQkgKiBzd2l0Y2ggKGUuZy4gdGhlIG5leHQgcmVxdWVzdCBpcyBub3QgcnVubmFibGUgb24gdGhp
cwotCQkgKiBlbmdpbmUpLiBIb3BlZnVsbHksIHdlIHdpbGwgYWxyZWFkeSBoYXZlIHN1Ym1pdHRl
ZCB0aGUgbmV4dAotCQkgKiByZXF1ZXN0IGJlZm9yZSB0aGUgdGFza2xldCBydW5zIGFuZCBkbyBu
b3QgbmVlZCB0byByZWJ1aWxkCi0JCSAqIGVhY2ggdmlydHVhbCB0cmVlIGFuZCBraWNrIGV2ZXJ5
b25lIGFnYWluLgotCQkgKi8KLQkJY2UtPmluZmxpZ2h0ID0gTlVMTDsKLQkJaWYgKHJxLT5lbmdp
bmUgIT0gY2UtPmVuZ2luZSkKLQkJCWtpY2tfc2libGluZ3MocnEsIGNlKTsKK3N0YXRpYyBpbmxp
bmUgdm9pZAorZXhlY2xpc3RzX3NjaGVkdWxlX291dChzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSkK
K3sKKwlzdHJ1Y3QgaW50ZWxfY29udGV4dCAqIGNvbnN0IGNlID0gcnEtPmh3X2NvbnRleHQ7CisJ
c3RydWN0IGludGVsX2VuZ2luZV9jcyAqY3VyLCAqb2xkOwogCi0JCWludGVsX2NvbnRleHRfcHV0
KGNlKTsKLQl9CisJdHJhY2VfaTkxNV9yZXF1ZXN0X291dChycSk7CisJR0VNX0JVR19PTihpbnRl
bF9jb250ZXh0X2luZmxpZ2h0KGNlKSAhPSBycS0+ZW5naW5lKTsKKworCW9sZCA9IFJFQURfT05D
RShjZS0+aW5mbGlnaHQpOworCWRvCisJCWN1ciA9IHB0cl91bm1hc2tfYml0cyhvbGQsIDIpID8g
cHRyX2RlYyhvbGQpIDogTlVMTDsKKwl3aGlsZSAoIXRyeV9jbXB4Y2hnKCZjZS0+aW5mbGlnaHQs
ICZvbGQsIGN1cikpOworCWlmICghY3VyKQorCQlfX2V4ZWNsaXN0c19zY2hlZHVsZV9vdXQocnEp
OwogCiAJaTkxNV9yZXF1ZXN0X3B1dChycSk7CiB9CkBAIC02ODQsNiArNzA2LDkgQEAgYXNzZXJ0
X3BlbmRpbmdfdmFsaWQoY29uc3Qgc3RydWN0IGludGVsX2VuZ2luZV9leGVjbGlzdHMgKmV4ZWNs
aXN0cywKIAogCXRyYWNlX3BvcnRzKGV4ZWNsaXN0cywgbXNnLCBleGVjbGlzdHMtPnBlbmRpbmcp
OwogCisJaWYgKCFleGVjbGlzdHMtPnBlbmRpbmdbMF0pCisJCXJldHVybiBmYWxzZTsKKwogCWlm
IChleGVjbGlzdHMtPnBlbmRpbmdbZXhlY2xpc3RzX251bV9wb3J0cyhleGVjbGlzdHMpXSkKIAkJ
cmV0dXJuIGZhbHNlOwogCkBAIC05NDQsOSArOTY5LDIxIEBAIG5lZWRfdGltZXNsaWNlKHN0cnVj
dCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSwgY29uc3Qgc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEp
CiBzdGF0aWMgYm9vbAogZW5hYmxlX3RpbWVzbGljZShzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICpl
bmdpbmUpCiB7Ci0Jc3RydWN0IGk5MTVfcmVxdWVzdCAqbGFzdCA9IGxhc3RfYWN0aXZlKCZlbmdp
bmUtPmV4ZWNsaXN0cyk7CisJc3RydWN0IGk5MTVfcmVxdWVzdCAqIGNvbnN0ICpwb3J0OworCWlu
dCBoaW50OworCisJcG9ydCA9IGVuZ2luZS0+ZXhlY2xpc3RzLmFjdGl2ZTsKKwl3aGlsZSAocG9y
dFswXSAmJiBpOTE1X3JlcXVlc3RfY29tcGxldGVkKHBvcnRbMF0pKQorCQlwb3J0Kys7CisJaWYg
KCFwb3J0WzBdKQorCQlyZXR1cm4gZmFsc2U7CiAKLQlyZXR1cm4gbGFzdCAmJiBuZWVkX3RpbWVz
bGljZShlbmdpbmUsIGxhc3QpOworCWhpbnQgPSBlbmdpbmUtPmV4ZWNsaXN0cy5xdWV1ZV9wcmlv
cml0eV9oaW50OworCWlmIChwb3J0WzFdKQorCQloaW50ID0gbWF4KHJxX3ByaW8ocG9ydFsxXSks
IGhpbnQpOworCisJLyogQ29tcGFyZSB0aGUgdHdvIGVuZC1wb2ludHMgYXMgYW4gdW5sb2NrZWQg
YXBwcm94aW1hdGlvbiAqLworCXJldHVybiBoaW50ID49IGVmZmVjdGl2ZV9wcmlvKHBvcnRbMF0p
OwogfQogCiBzdGF0aWMgdm9pZCByZWNvcmRfcHJlZW1wdGlvbihzdHJ1Y3QgaW50ZWxfZW5naW5l
X2V4ZWNsaXN0cyAqZXhlY2xpc3RzKQpAQCAtMTM1Niw3ICsxMzkzLDYgQEAgc3RhdGljIHZvaWQg
cHJvY2Vzc19jc2Ioc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lKQogCWNvbnN0IHU4IG51
bV9lbnRyaWVzID0gZXhlY2xpc3RzLT5jc2Jfc2l6ZTsKIAl1OCBoZWFkLCB0YWlsOwogCi0JbG9j
a2RlcF9hc3NlcnRfaGVsZCgmZW5naW5lLT5hY3RpdmUubG9jayk7CiAJR0VNX0JVR19PTihVU0VT
X0dVQ19TVUJNSVNTSU9OKGVuZ2luZS0+aTkxNSkpOwogCiAJLyoKQEAgLTE0MjcsMTUgKzE0NjMs
MTQgQEAgc3RhdGljIHZvaWQgcHJvY2Vzc19jc2Ioc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5n
aW5lKQogCQkJCSAgICAgICBleGVjbGlzdHMtPnBlbmRpbmcsCiAJCQkJICAgICAgIGV4ZWNsaXN0
c19udW1fcG9ydHMoZXhlY2xpc3RzKSAqCiAJCQkJICAgICAgIHNpemVvZigqZXhlY2xpc3RzLT5w
ZW5kaW5nKSk7Ci0JCQlleGVjbGlzdHMtPnBlbmRpbmdbMF0gPSBOVUxMOwotCi0JCQl0cmFjZV9w
b3J0cyhleGVjbGlzdHMsICJwcm9tb3RlZCIsIGV4ZWNsaXN0cy0+YWN0aXZlKTsKIAogCQkJaWYg
KGVuYWJsZV90aW1lc2xpY2UoZW5naW5lKSkKIAkJCQltb2RfdGltZXIoJmV4ZWNsaXN0cy0+dGlt
ZXIsIGppZmZpZXMgKyAxKTsKIAogCQkJaWYgKCFpbmplY3RfcHJlZW1wdF9oYW5nKGV4ZWNsaXN0
cykpCiAJCQkJcmluZ19zZXRfcGF1c2VkKGVuZ2luZSwgMCk7CisKKwkJCVdSSVRFX09OQ0UoZXhl
Y2xpc3RzLT5wZW5kaW5nWzBdLCBOVUxMKTsKIAkJCWJyZWFrOwogCiAJCWNhc2UgQ1NCX0NPTVBM
RVRFOiAvKiBwb3J0MCBjb21wbGV0ZWQsIGFkdmFuY2VkIHRvIHBvcnQxICovCkBAIC0xNDc5LDgg
KzE1MTQsNiBAQCBzdGF0aWMgdm9pZCBwcm9jZXNzX2NzYihzdHJ1Y3QgaW50ZWxfZW5naW5lX2Nz
ICplbmdpbmUpCiBzdGF0aWMgdm9pZCBfX2V4ZWNsaXN0c19zdWJtaXNzaW9uX3Rhc2tsZXQoc3Ry
dWN0IGludGVsX2VuZ2luZV9jcyAqY29uc3QgZW5naW5lKQogewogCWxvY2tkZXBfYXNzZXJ0X2hl
bGQoJmVuZ2luZS0+YWN0aXZlLmxvY2spOwotCi0JcHJvY2Vzc19jc2IoZW5naW5lKTsKIAlpZiAo
IWVuZ2luZS0+ZXhlY2xpc3RzLnBlbmRpbmdbMF0pCiAJCWV4ZWNsaXN0c19kZXF1ZXVlKGVuZ2lu
ZSk7CiB9CkBAIC0xNDk0LDkgKzE1MjcsMTIgQEAgc3RhdGljIHZvaWQgZXhlY2xpc3RzX3N1Ym1p
c3Npb25fdGFza2xldCh1bnNpZ25lZCBsb25nIGRhdGEpCiAJc3RydWN0IGludGVsX2VuZ2luZV9j
cyAqIGNvbnN0IGVuZ2luZSA9IChzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICopZGF0YTsKIAl1bnNp
Z25lZCBsb25nIGZsYWdzOwogCi0Jc3Bpbl9sb2NrX2lycXNhdmUoJmVuZ2luZS0+YWN0aXZlLmxv
Y2ssIGZsYWdzKTsKLQlfX2V4ZWNsaXN0c19zdWJtaXNzaW9uX3Rhc2tsZXQoZW5naW5lKTsKLQlz
cGluX3VubG9ja19pcnFyZXN0b3JlKCZlbmdpbmUtPmFjdGl2ZS5sb2NrLCBmbGFncyk7CisJcHJv
Y2Vzc19jc2IoZW5naW5lKTsKKwlpZiAoIWVuZ2luZS0+ZXhlY2xpc3RzLnBlbmRpbmdbMF0pIHsK
KwkJc3Bpbl9sb2NrX2lycXNhdmUoJmVuZ2luZS0+YWN0aXZlLmxvY2ssIGZsYWdzKTsKKwkJX19l
eGVjbGlzdHNfc3VibWlzc2lvbl90YXNrbGV0KGVuZ2luZSk7CisJCXNwaW5fdW5sb2NrX2lycXJl
c3RvcmUoJmVuZ2luZS0+YWN0aXZlLmxvY2ssIGZsYWdzKTsKKwl9CiB9CiAKIHN0YXRpYyB2b2lk
IGV4ZWNsaXN0c19zdWJtaXNzaW9uX3RpbWVyKHN0cnVjdCB0aW1lcl9saXN0ICp0aW1lcikKZGlm
ZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfdXRpbHMuaCBiL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L2k5MTVfdXRpbHMuaAppbmRleCBkNjUyYmE1ZDIzMjAuLjU2MmY3NTZkYTQyMSAx
MDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV91dGlscy5oCisrKyBiL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L2k5MTVfdXRpbHMuaApAQCAtMTYxLDE3ICsxNjEsMTUgQEAgX19jaGVj
a19zdHJ1Y3Rfc2l6ZShzaXplX3QgYmFzZSwgc2l6ZV90IGFyciwgc2l6ZV90IGNvdW50LCBzaXpl
X3QgKnNpemUpCiAJKCh0eXBlb2YocHRyKSkoKHVuc2lnbmVkIGxvbmcpKHB0cikgfCBfX2JpdHMp
KTsJCQlcCiB9KQogCi0jZGVmaW5lIHB0cl9jb3VudF9kZWMocF9wdHIpIGRvIHsJCQkJCVwKLQl0
eXBlb2YocF9wdHIpIF9fcCA9IChwX3B0cik7CQkJCQlcCi0JdW5zaWduZWQgbG9uZyBfX3YgPSAo
dW5zaWduZWQgbG9uZykoKl9fcCk7CQkJXAotCSpfX3AgPSAodHlwZW9mKCpwX3B0cikpKC0tX192
KTsJCQkJCVwKLX0gd2hpbGUgKDApCi0KLSNkZWZpbmUgcHRyX2NvdW50X2luYyhwX3B0cikgZG8g
ewkJCQkJXAotCXR5cGVvZihwX3B0cikgX19wID0gKHBfcHRyKTsJCQkJCVwKLQl1bnNpZ25lZCBs
b25nIF9fdiA9ICh1bnNpZ25lZCBsb25nKSgqX19wKTsJCQlcCi0JKl9fcCA9ICh0eXBlb2YoKnBf
cHRyKSkoKytfX3YpOwkJCQkJXAotfSB3aGlsZSAoMCkKKyNkZWZpbmUgcHRyX2RlYyhwdHIpICh7
CQkJCQkJCVwKKwl1bnNpZ25lZCBsb25nIF9fdiA9ICh1bnNpZ25lZCBsb25nKShwdHIpOwkJCVwK
KwkodHlwZW9mKHB0cikpKF9fdiAtIDEpOwkJCQkJCVwKK30pCisKKyNkZWZpbmUgcHRyX2luYyhw
dHIpICh7CQkJCQkJCVwKKwl1bnNpZ25lZCBsb25nIF9fdiA9ICh1bnNpZ25lZCBsb25nKShwdHIp
OwkJCVwKKwkodHlwZW9mKHB0cikpKF9fdiArIDEpOwkJCQkJCVwKK30pCiAKICNkZWZpbmUgcGFn
ZV9tYXNrX2JpdHMocHRyKSBwdHJfbWFza19iaXRzKHB0ciwgUEFHRV9TSElGVCkKICNkZWZpbmUg
cGFnZV91bm1hc2tfYml0cyhwdHIpIHB0cl91bm1hc2tfYml0cyhwdHIsIFBBR0VfU0hJRlQpCi0t
IAoyLjIzLjAucmMxCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fXwpJbnRlbC1nZnggbWFpbGluZyBsaXN0CkludGVsLWdmeEBsaXN0cy5mcmVlZGVza3RvcC5v
cmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9pbnRlbC1n
Zng=

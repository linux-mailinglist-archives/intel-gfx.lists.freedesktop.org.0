Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 85491173C4
	for <lists+intel-gfx@lfdr.de>; Wed,  8 May 2019 10:28:27 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id C99F4897EF;
	Wed,  8 May 2019 08:28:25 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 8F7CB89686
 for <intel-gfx@lists.freedesktop.org>; Wed,  8 May 2019 08:28:24 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 16485931-1500050 
 for multiple; Wed, 08 May 2019 09:07:12 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Wed,  8 May 2019 09:06:55 +0100
Message-Id: <20190508080704.24223-31-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190508080704.24223-1-chris@chris-wilson.co.uk>
References: <20190508080704.24223-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 31/40] drm/i915: Move GEM client throttling to
 its own file
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

Q29udGludWluZyB0aGUgZGVjbHV0dGVyaW5nIG9mIGk5MTVfZ2VtLmMgYnkgbW92aW5nIHRoZSBj
bGllbnQgc2VsZgp0aHJvdHRsaW5nIGludG8gaXRzIG93biBmaWxlLgoKU2lnbmVkLW9mZi1ieTog
Q2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28udWs+Ci0tLQogZHJpdmVycy9ncHUv
ZHJtL2k5MTUvTWFrZWZpbGUgICAgICAgICAgICAgICAgfCAgMSArCiBkcml2ZXJzL2dwdS9kcm0v
aTkxNS9nZW0vaTkxNV9nZW1fdGhyb3R0bGUuYyB8IDc0ICsrKysrKysrKysrKysrKysrKysrCiBk
cml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2Rydi5oICAgICAgICAgICAgICB8ICA2IC0tCiBkcml2
ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbS5jICAgICAgICAgICAgICB8IDU4IC0tLS0tLS0tLS0t
LS0tLQogNCBmaWxlcyBjaGFuZ2VkLCA3NSBpbnNlcnRpb25zKCspLCA2NCBkZWxldGlvbnMoLSkK
IGNyZWF0ZSBtb2RlIDEwMDY0NCBkcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fdGhy
b3R0bGUuYwoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L01ha2VmaWxlIGIvZHJp
dmVycy9ncHUvZHJtL2k5MTUvTWFrZWZpbGUKaW5kZXggODY1ZDdiNTFjMjk3Li43OGQzNmVhZmYw
NzAgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L01ha2VmaWxlCisrKyBiL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L01ha2VmaWxlCkBAIC0xMDQsNiArMTA0LDcgQEAgZ2VtLXkgKz0gXAog
CWdlbS9pOTE1X2dlbV9zaG1lbS5vIFwKIAlnZW0vaTkxNV9nZW1fc2hyaW5rZXIubyBcCiAJZ2Vt
L2k5MTVfZ2VtX3N0b2xlbi5vIFwKKwlnZW0vaTkxNV9nZW1fdGhyb3R0bGUubyBcCiAJZ2VtL2k5
MTVfZ2VtX3RpbGluZy5vIFwKIAlnZW0vaTkxNV9nZW1fdXNlcnB0ci5vIFwKIAlnZW0vaTkxNV9n
ZW1fd2FpdC5vIFwKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dl
bV90aHJvdHRsZS5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3Rocm90dGxl
LmMKbmV3IGZpbGUgbW9kZSAxMDA2NDQKaW5kZXggMDAwMDAwMDAwMDAwLi40OTFiYzI4YzE3NWQK
LS0tIC9kZXYvbnVsbAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fdGhy
b3R0bGUuYwpAQCAtMCwwICsxLDc0IEBACisvKgorICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6
IE1JVAorICoKKyAqIENvcHlyaWdodCDCqSAyMDE0LTIwMTYgSW50ZWwgQ29ycG9yYXRpb24KKyAq
LworCisjaW5jbHVkZSA8bGludXgvamlmZmllcy5oPgorCisjaW5jbHVkZSA8ZHJtL2RybV9maWxl
Lmg+CisKKyNpbmNsdWRlICJpOTE1X2dlbV9pb2N0bHMuaCIKKyNpbmNsdWRlICJpOTE1X2dlbV9v
YmplY3QuaCIKKworI2luY2x1ZGUgIi4uL2k5MTVfZHJ2LmgiCisKKy8qCisgKiAyMG1zIGlzIGEg
ZmFpcmx5IGFyYml0cmFyeSBsaW1pdCAoZ3JlYXRlciB0aGFuIHRoZSBhdmVyYWdlIGZyYW1lIHRp
bWUpCisgKiBjaG9zZW4gdG8gcHJldmVudCB0aGUgQ1BVIGdldHRpbmcgbW9yZSB0aGFuIGEgZnJh
bWUgYWhlYWQgb2YgdGhlIEdQVQorICogKHdoZW4gdXNpbmcgbGF4IHRocm90dGxpbmcgZm9yIHRo
ZSBmcm9udGJ1ZmZlcikuIFdlIGFsc28gdXNlIGl0IHRvCisgKiBvZmZlciBmcmVlIEdQVSB3YWl0
Ym9vc3RzIGZvciBzZXZlcmVseSBjb25nZXN0ZWQgd29ya2xvYWRzLgorICovCisjZGVmaW5lIERS
TV9JOTE1X1RIUk9UVExFX0pJRkZJRVMgbXNlY3NfdG9famlmZmllcygyMCkKKworLyoKKyAqIFRo
cm90dGxlIG91ciByZW5kZXJpbmcgYnkgd2FpdGluZyB1bnRpbCB0aGUgcmluZyBoYXMgY29tcGxl
dGVkIG91ciByZXF1ZXN0cworICogZW1pdHRlZCBvdmVyIDIwIG1zZWMgYWdvLgorICoKKyAqIE5v
dGUgdGhhdCBpZiB3ZSB3ZXJlIHRvIHVzZSB0aGUgY3VycmVudCBqaWZmaWVzIGVhY2ggdGltZSBh
cm91bmQgdGhlIGxvb3AsCisgKiB3ZSB3b3VsZG4ndCBlc2NhcGUgdGhlIGZ1bmN0aW9uIHdpdGgg
YW55IGZyYW1lcyBvdXRzdGFuZGluZyBpZiB0aGUgdGltZSB0bworICogcmVuZGVyIGEgZnJhbWUg
d2FzIG92ZXIgMjBtcy4KKyAqCisgKiBUaGlzIHNob3VsZCBnZXQgdXMgcmVhc29uYWJsZSBwYXJh
bGxlbGlzbSBiZXR3ZWVuIENQVSBhbmQgR1BVIGJ1dCBhbHNvCisgKiByZWxhdGl2ZWx5IGxvdyBs
YXRlbmN5IHdoZW4gYmxvY2tpbmcgb24gYSBwYXJ0aWN1bGFyIHJlcXVlc3QgdG8gZmluaXNoLgor
ICovCitpbnQKK2k5MTVfZ2VtX3Rocm90dGxlX2lvY3RsKHN0cnVjdCBkcm1fZGV2aWNlICpkZXYs
IHZvaWQgKmRhdGEsCisJCQlzdHJ1Y3QgZHJtX2ZpbGUgKmZpbGUpCit7CisJc3RydWN0IGRybV9p
OTE1X2ZpbGVfcHJpdmF0ZSAqZmlsZV9wcml2ID0gZmlsZS0+ZHJpdmVyX3ByaXY7CisJdW5zaWdu
ZWQgbG9uZyByZWNlbnRfZW5vdWdoID0gamlmZmllcyAtIERSTV9JOTE1X1RIUk9UVExFX0pJRkZJ
RVM7CisJc3RydWN0IGk5MTVfcmVxdWVzdCAqcmVxdWVzdCwgKnRhcmdldCA9IE5VTEw7CisJbG9u
ZyByZXQ7CisKKwkvKiBBQkk6IHJldHVybiAtRUlPIGlmIGFscmVhZHkgd2VkZ2VkICovCisJcmV0
ID0gaTkxNV90ZXJtaW5hbGx5X3dlZGdlZCh0b19pOTE1KGRldikpOworCWlmIChyZXQpCisJCXJl
dHVybiByZXQ7CisKKwlzcGluX2xvY2soJmZpbGVfcHJpdi0+bW0ubG9jayk7CisJbGlzdF9mb3Jf
ZWFjaF9lbnRyeShyZXF1ZXN0LCAmZmlsZV9wcml2LT5tbS5yZXF1ZXN0X2xpc3QsIGNsaWVudF9s
aW5rKSB7CisJCWlmICh0aW1lX2FmdGVyX2VxKHJlcXVlc3QtPmVtaXR0ZWRfamlmZmllcywgcmVj
ZW50X2Vub3VnaCkpCisJCQlicmVhazsKKworCQlpZiAodGFyZ2V0KSB7CisJCQlsaXN0X2RlbCgm
dGFyZ2V0LT5jbGllbnRfbGluayk7CisJCQl0YXJnZXQtPmZpbGVfcHJpdiA9IE5VTEw7CisJCX0K
KworCQl0YXJnZXQgPSByZXF1ZXN0OworCX0KKwlpZiAodGFyZ2V0KQorCQlpOTE1X3JlcXVlc3Rf
Z2V0KHRhcmdldCk7CisJc3Bpbl91bmxvY2soJmZpbGVfcHJpdi0+bW0ubG9jayk7CisKKwlpZiAo
IXRhcmdldCkKKwkJcmV0dXJuIDA7CisKKwlyZXQgPSBpOTE1X3JlcXVlc3Rfd2FpdCh0YXJnZXQs
CisJCQkJSTkxNV9XQUlUX0lOVEVSUlVQVElCTEUsCisJCQkJTUFYX1NDSEVEVUxFX1RJTUVPVVQp
OworCWk5MTVfcmVxdWVzdF9wdXQodGFyZ2V0KTsKKworCXJldHVybiByZXQgPCAwID8gcmV0IDog
MDsKK30KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZHJ2LmggYi9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2Rydi5oCmluZGV4IDhlYjAxYjFiM2UwZS4uYjM3MmFjNDdh
YTFjIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2Rydi5oCisrKyBiL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZHJ2LmgKQEAgLTIxMiwxMiArMjEyLDYgQEAgc3RydWN0
IGRybV9pOTE1X2ZpbGVfcHJpdmF0ZSB7CiAJc3RydWN0IHsKIAkJc3BpbmxvY2tfdCBsb2NrOwog
CQlzdHJ1Y3QgbGlzdF9oZWFkIHJlcXVlc3RfbGlzdDsKLS8qIDIwbXMgaXMgYSBmYWlybHkgYXJi
aXRyYXJ5IGxpbWl0IChncmVhdGVyIHRoYW4gdGhlIGF2ZXJhZ2UgZnJhbWUgdGltZSkKLSAqIGNo
b3NlbiB0byBwcmV2ZW50IHRoZSBDUFUgZ2V0dGluZyBtb3JlIHRoYW4gYSBmcmFtZSBhaGVhZCBv
ZiB0aGUgR1BVCi0gKiAod2hlbiB1c2luZyBsYXggdGhyb3R0bGluZyBmb3IgdGhlIGZyb250YnVm
ZmVyKS4gV2UgYWxzbyB1c2UgaXQgdG8KLSAqIG9mZmVyIGZyZWUgR1BVIHdhaXRib29zdHMgZm9y
IHNldmVyZWx5IGNvbmdlc3RlZCB3b3JrbG9hZHMuCi0gKi8KLSNkZWZpbmUgRFJNX0k5MTVfVEhS
T1RUTEVfSklGRklFUyBtc2Vjc190b19qaWZmaWVzKDIwKQogCX0gbW07CiAKIAlzdHJ1Y3QgaWRy
IGNvbnRleHRfaWRyOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW0u
YyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtLmMKaW5kZXggMmYxZTZkZDc4ZGMxLi4y
YTllOGVjZjI5MjYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtLmMK
KysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW0uYwpAQCAtOTg4LDU3ICs5ODgsNiBA
QCBpbnQgaTkxNV9nZW1fd2FpdF9mb3JfaWRsZShzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkx
NSwKIAlyZXR1cm4gMDsKIH0KIAotLyogVGhyb3R0bGUgb3VyIHJlbmRlcmluZyBieSB3YWl0aW5n
IHVudGlsIHRoZSByaW5nIGhhcyBjb21wbGV0ZWQgb3VyIHJlcXVlc3RzCi0gKiBlbWl0dGVkIG92
ZXIgMjAgbXNlYyBhZ28uCi0gKgotICogTm90ZSB0aGF0IGlmIHdlIHdlcmUgdG8gdXNlIHRoZSBj
dXJyZW50IGppZmZpZXMgZWFjaCB0aW1lIGFyb3VuZCB0aGUgbG9vcCwKLSAqIHdlIHdvdWxkbid0
IGVzY2FwZSB0aGUgZnVuY3Rpb24gd2l0aCBhbnkgZnJhbWVzIG91dHN0YW5kaW5nIGlmIHRoZSB0
aW1lIHRvCi0gKiByZW5kZXIgYSBmcmFtZSB3YXMgb3ZlciAyMG1zLgotICoKLSAqIFRoaXMgc2hv
dWxkIGdldCB1cyByZWFzb25hYmxlIHBhcmFsbGVsaXNtIGJldHdlZW4gQ1BVIGFuZCBHUFUgYnV0
IGFsc28KLSAqIHJlbGF0aXZlbHkgbG93IGxhdGVuY3kgd2hlbiBibG9ja2luZyBvbiBhIHBhcnRp
Y3VsYXIgcmVxdWVzdCB0byBmaW5pc2guCi0gKi8KLXN0YXRpYyBpbnQKLWk5MTVfZ2VtX3Jpbmdf
dGhyb3R0bGUoc3RydWN0IGRybV9kZXZpY2UgKmRldiwgc3RydWN0IGRybV9maWxlICpmaWxlKQot
ewotCXN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiA9IHRvX2k5MTUoZGV2KTsKLQlz
dHJ1Y3QgZHJtX2k5MTVfZmlsZV9wcml2YXRlICpmaWxlX3ByaXYgPSBmaWxlLT5kcml2ZXJfcHJp
djsKLQl1bnNpZ25lZCBsb25nIHJlY2VudF9lbm91Z2ggPSBqaWZmaWVzIC0gRFJNX0k5MTVfVEhS
T1RUTEVfSklGRklFUzsKLQlzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpyZXF1ZXN0LCAqdGFyZ2V0ID0g
TlVMTDsKLQlsb25nIHJldDsKLQotCS8qIEFCSTogcmV0dXJuIC1FSU8gaWYgYWxyZWFkeSB3ZWRn
ZWQgKi8KLQlyZXQgPSBpOTE1X3Rlcm1pbmFsbHlfd2VkZ2VkKGRldl9wcml2KTsKLQlpZiAocmV0
KQotCQlyZXR1cm4gcmV0OwotCi0Jc3Bpbl9sb2NrKCZmaWxlX3ByaXYtPm1tLmxvY2spOwotCWxp
c3RfZm9yX2VhY2hfZW50cnkocmVxdWVzdCwgJmZpbGVfcHJpdi0+bW0ucmVxdWVzdF9saXN0LCBj
bGllbnRfbGluaykgewotCQlpZiAodGltZV9hZnRlcl9lcShyZXF1ZXN0LT5lbWl0dGVkX2ppZmZp
ZXMsIHJlY2VudF9lbm91Z2gpKQotCQkJYnJlYWs7Ci0KLQkJaWYgKHRhcmdldCkgewotCQkJbGlz
dF9kZWwoJnRhcmdldC0+Y2xpZW50X2xpbmspOwotCQkJdGFyZ2V0LT5maWxlX3ByaXYgPSBOVUxM
OwotCQl9Ci0KLQkJdGFyZ2V0ID0gcmVxdWVzdDsKLQl9Ci0JaWYgKHRhcmdldCkKLQkJaTkxNV9y
ZXF1ZXN0X2dldCh0YXJnZXQpOwotCXNwaW5fdW5sb2NrKCZmaWxlX3ByaXYtPm1tLmxvY2spOwot
Ci0JaWYgKHRhcmdldCA9PSBOVUxMKQotCQlyZXR1cm4gMDsKLQotCXJldCA9IGk5MTVfcmVxdWVz
dF93YWl0KHRhcmdldCwKLQkJCQlJOTE1X1dBSVRfSU5URVJSVVBUSUJMRSwKLQkJCQlNQVhfU0NI
RURVTEVfVElNRU9VVCk7Ci0JaTkxNV9yZXF1ZXN0X3B1dCh0YXJnZXQpOwotCi0JcmV0dXJuIHJl
dCA8IDAgPyByZXQgOiAwOwotfQotCiBzdHJ1Y3QgaTkxNV92bWEgKgogaTkxNV9nZW1fb2JqZWN0
X2dndHRfcGluKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmosCiAJCQkgY29uc3Qgc3Ry
dWN0IGk5MTVfZ2d0dF92aWV3ICp2aWV3LApAQCAtMTExOCwxMyArMTA2Nyw2IEBAIGk5MTVfZ2Vt
X29iamVjdF9nZ3R0X3BpbihzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqLAogCXJldHVy
biB2bWE7CiB9CiAKLWludAotaTkxNV9nZW1fdGhyb3R0bGVfaW9jdGwoc3RydWN0IGRybV9kZXZp
Y2UgKmRldiwgdm9pZCAqZGF0YSwKLQkJCXN0cnVjdCBkcm1fZmlsZSAqZmlsZV9wcml2KQotewot
CXJldHVybiBpOTE1X2dlbV9yaW5nX3Rocm90dGxlKGRldiwgZmlsZV9wcml2KTsKLX0KLQogaW50
CiBpOTE1X2dlbV9tYWR2aXNlX2lvY3RsKHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsIHZvaWQgKmRh
dGEsCiAJCSAgICAgICBzdHJ1Y3QgZHJtX2ZpbGUgKmZpbGVfcHJpdikKLS0gCjIuMjAuMQoKX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1h
aWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMu
ZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

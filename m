Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 1479C1790C7
	for <lists+intel-gfx@lfdr.de>; Wed,  4 Mar 2020 14:04:02 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 68BC889F6B;
	Wed,  4 Mar 2020 13:03:58 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 4FC5289F6B
 for <intel-gfx@lists.freedesktop.org>; Wed,  4 Mar 2020 13:03:57 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 20441070-1500050 
 for <intel-gfx@lists.freedesktop.org>; Wed, 04 Mar 2020 13:03:53 +0000
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Wed,  4 Mar 2020 13:03:52 +0000
Message-Id: <20200304130353.2448417-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.25.1
MIME-Version: 1.0
Subject: [Intel-gfx] [CI 1/2] drm/i915: Add mechanism to submit a context WA
 on ring submission
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

RnJvbTogTWlrYSBLdW9wcGFsYSA8bWlrYS5rdW9wcGFsYUBsaW51eC5pbnRlbC5jb20+CgpUaGlz
IHBhdGNoIGFkZHMgZnJhbWV3b3JrIHRvIHN1Ym1pdCBhbiBhcmJpdHJhcnkgYmF0Y2hidWZmZXIg
b24gZWFjaApjb250ZXh0IHN3aXRjaCB0byBjbGVhciByZXNpZHVhbCBzdGF0ZSBmb3IgcmVuZGVy
IGVuZ2luZSBvbiBHZW43LzcuNQpkZXZpY2VzLgoKVGhlIGlkZWEgb2YgYWx3YXlzIGVtaXR0aW5n
IHRoZSBjb250ZXh0IGFuZCB2bSBzZXR1cCBhcm91bmQgZWFjaCByZXF1ZXN0CmlzIHByaW1hcnkg
dG8gbWFrZSByZXNldCByZWNvdmVyeSBlYXN5LCBhbmQgbm90IHJlcXVpcmUgcmV3cml0aW5nIHRo
ZQpyaW5nYnVmZmVyLiBBcyBlYWNoIHJlcXVlc3Qgd291bGQgc2V0IHVwIGl0cyBvd24gY29udGV4
dCwgbGVhdmluZyBpdCB0bwp0aGUgSFcgdG8gbm90aWNlIGFuZCBlbGlkZSBuby1vcCBjb250ZXh0
IHN3aXRjaGVzLCB3ZSBjb3VsZCByZXN0YXJ0IHRoZQpyaW5nIGF0IGFueSBwb2ludCwgYW5kIHJl
b3JkZXIgdGhlIHJlcXVlc3RzIGZyZWVseS4KCkhvd2V2ZXIsIHRvIGF2b2lkIGVtaXR0aW5nIGNs
ZWFyX3Jlc2lkdWFscygpIGJldHdlZW4gY29uc2VjdXRpdmUgcmVxdWVzdHMKaW4gdGhlIHJpbmdi
dWZmZXIgb2YgdGhlIHNhbWUgY29udGV4dCwgd2UgZG8gd2FudCB0byB0cmFjayB0aGUgY3VycmVu
dApjb250ZXh0IGluIHRoZSByaW5nLiBJbiBkb2luZyBzbywgd2UgbmVlZCB0byBiZSBjYXJlZnVs
IHRvIG9ubHkgcmVjb3JkIGEKY29udGV4dCBzd2l0Y2ggd2hlbiB3ZSBhcmUgc3VyZSB0aGUgbmV4
dCByZXF1ZXN0IHdpbGwgYmUgZW1pdHRlZC4KClRoaXMgc2VjdXJpdHkgbWl0aWdhdGlvbiBjaGFu
Z2UgZG9lcyBub3QgdHJpZ2dlciBhbnkgcGVyZm9ybWFuY2UKcmVncmVzc2lvbi4gUGVyZm9ybWFu
Y2UgaXMgb24gcGFyIHdpdGggY3VycmVudCBtYWlubGluZS9kcm0tdGlwLgoKdjI6IFVwZGF0ZSB2
bV9hbGlhcyBwYXJhbXMgdG8gcG9pbnQgdG8gY29ycmVjdCBhZGRyZXNzIHNwYWNlICJ2bSIgZHVl
IHRvCmNoYW5nZXMgbWFkZSBpbiB0aGUgcGF0Y2ggImYyMTYxMzc5N2JhZTk4NzczIgoKdjMtdjQ6
IG5vbmUKClNpZ25lZC1vZmYtYnk6IE1pa2EgS3VvcHBhbGEgPG1pa2Eua3VvcHBhbGFAbGludXgu
aW50ZWwuY29tPgpTaWduZWQtb2ZmLWJ5OiBQcmF0aGFwIEt1bWFyIFZhbHNhbiA8cHJhdGhhcC5r
dW1hci52YWxzYW5AaW50ZWwuY29tPgpTaWduZWQtb2ZmLWJ5OiBBa2VlbSBHIEFib2R1bnJpbiA8
YWtlZW0uZy5hYm9kdW5yaW5AaW50ZWwuY29tPgpDYzogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJp
cy13aWxzb24uY28udWs+CkNjOiBCYWxlc3RyaWVyaSBGcmFuY2VzY28gPGZyYW5jZXNjby5iYWxl
c3RyaWVyaUBpbnRlbC5jb20+CkNjOiBCbG9vbWZpZWxkIEpvbiA8am9uLmJsb29tZmllbGRAaW50
ZWwuY29tPgpDYzogRHV0dCBTdWRlZXAgPHN1ZGVlcC5kdXR0QGludGVsLmNvbT4KUmV2aWV3ZWQt
Ynk6IENocmlzIFdpbHNvbiA8Y2hyaXMucC53aWxzb25AaW50ZWwuY29tPgotLS0KIC4uLi9ncHUv
ZHJtL2k5MTUvZ3QvaW50ZWxfcmluZ19zdWJtaXNzaW9uLmMgICB8IDEzOCArKysrKysrKystCiAu
Li4vZHJtL2k5MTUvZ3Qvc2VsZnRlc3RfcmluZ19zdWJtaXNzaW9uLmMgICAgfCAyNDcgKysrKysr
KysrKysrKysrKysrCiAuLi4vZHJtL2k5MTUvc2VsZnRlc3RzL2k5MTVfbGl2ZV9zZWxmdGVzdHMu
aCAgfCAgIDEgKwogMyBmaWxlcyBjaGFuZ2VkLCAzODIgaW5zZXJ0aW9ucygrKSwgNCBkZWxldGlv
bnMoLSkKIGNyZWF0ZSBtb2RlIDEwMDY0NCBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVz
dF9yaW5nX3N1Ym1pc3Npb24uYwoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0
L2ludGVsX3Jpbmdfc3VibWlzc2lvbi5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxf
cmluZ19zdWJtaXNzaW9uLmMKaW5kZXggZmVlNzQzNjI2MDYwLi5mNjc2NTJjZmYxNWIgMTAwNjQ0
Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX3Jpbmdfc3VibWlzc2lvbi5jCisr
KyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX3Jpbmdfc3VibWlzc2lvbi5jCkBAIC0x
MzU4LDcgKzEzNTgsOSBAQCBzdGF0aWMgaW50IGxvYWRfcGRfZGlyKHN0cnVjdCBpOTE1X3JlcXVl
c3QgKnJxLAogCXJldHVybiBycS0+ZW5naW5lLT5lbWl0X2ZsdXNoKHJxLCBFTUlUX0ZMVVNIKTsK
IH0KIAotc3RhdGljIGlubGluZSBpbnQgbWlfc2V0X2NvbnRleHQoc3RydWN0IGk5MTVfcmVxdWVz
dCAqcnEsIHUzMiBmbGFncykKK3N0YXRpYyBpbmxpbmUgaW50IG1pX3NldF9jb250ZXh0KHN0cnVj
dCBpOTE1X3JlcXVlc3QgKnJxLAorCQkJCSBzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UsCisJCQkJ
IHUzMiBmbGFncykKIHsKIAlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSA9IHJxLT5pOTE1
OwogCXN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSA9IHJxLT5lbmdpbmU7CkBAIC0xNDMz
LDcgKzE0MzUsNyBAQCBzdGF0aWMgaW5saW5lIGludCBtaV9zZXRfY29udGV4dChzdHJ1Y3QgaTkx
NV9yZXF1ZXN0ICpycSwgdTMyIGZsYWdzKQogCiAJKmNzKysgPSBNSV9OT09QOwogCSpjcysrID0g
TUlfU0VUX0NPTlRFWFQ7Ci0JKmNzKysgPSBpOTE1X2dndHRfb2Zmc2V0KHJxLT5jb250ZXh0LT5z
dGF0ZSkgfCBmbGFnczsKKwkqY3MrKyA9IGk5MTVfZ2d0dF9vZmZzZXQoY2UtPnN0YXRlKSB8IGZs
YWdzOwogCS8qCiAJICogdy9hOiBNSV9TRVRfQ09OVEVYVCBtdXN0IGFsd2F5cyBiZSBmb2xsb3dl
ZCBieSBNSV9OT09QCiAJICogV2FNaVNldENvbnRleHRfSGFuZzpzbmIsaXZiLHZsdgpAQCAtMTU0
OCwxMyArMTU1MCw1NiBAQCBzdGF0aWMgaW50IHN3aXRjaF9tbShzdHJ1Y3QgaTkxNV9yZXF1ZXN0
ICpycSwgc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0pCiAJcmV0dXJuIHJxLT5lbmdpbmUt
PmVtaXRfZmx1c2gocnEsIEVNSVRfSU5WQUxJREFURSk7CiB9CiAKK3N0YXRpYyBpbnQgY2xlYXJf
cmVzaWR1YWxzKHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxKQoreworCXN0cnVjdCBpbnRlbF9lbmdp
bmVfY3MgKmVuZ2luZSA9IHJxLT5lbmdpbmU7CisJaW50IHJldDsKKworCXJldCA9IHN3aXRjaF9t
bShycSwgdm1fYWxpYXMoZW5naW5lLT5rZXJuZWxfY29udGV4dC0+dm0pKTsKKwlpZiAocmV0KQor
CQlyZXR1cm4gcmV0OworCisJaWYgKGVuZ2luZS0+a2VybmVsX2NvbnRleHQtPnN0YXRlKSB7CisJ
CXJldCA9IG1pX3NldF9jb250ZXh0KHJxLAorCQkJCSAgICAgZW5naW5lLT5rZXJuZWxfY29udGV4
dCwKKwkJCQkgICAgIE1JX01NX1NQQUNFX0dUVCB8IE1JX1JFU1RPUkVfSU5ISUJJVCk7CisJCWlm
IChyZXQpCisJCQlyZXR1cm4gcmV0OworCX0KKworCXJldCA9IGVuZ2luZS0+ZW1pdF9iYl9zdGFy
dChycSwKKwkJCQkgICAgZW5naW5lLT53YV9jdHgudm1hLT5ub2RlLnN0YXJ0LCAwLAorCQkJCSAg
ICAwKTsKKwlpZiAocmV0KQorCQlyZXR1cm4gcmV0OworCisJcmV0ID0gZW5naW5lLT5lbWl0X2Zs
dXNoKHJxLCBFTUlUX0ZMVVNIKTsKKwlpZiAocmV0KQorCQlyZXR1cm4gcmV0OworCisJLyogQWx3
YXlzIGludmFsaWRhdGUgYmVmb3JlIHRoZSBuZXh0IHN3aXRjaF9tbSgpICovCisJcmV0dXJuIGVu
Z2luZS0+ZW1pdF9mbHVzaChycSwgRU1JVF9JTlZBTElEQVRFKTsKK30KKwogc3RhdGljIGludCBz
d2l0Y2hfY29udGV4dChzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSkKIHsKKwlzdHJ1Y3QgaW50ZWxf
ZW5naW5lX2NzICplbmdpbmUgPSBycS0+ZW5naW5lOwogCXN0cnVjdCBpbnRlbF9jb250ZXh0ICpj
ZSA9IHJxLT5jb250ZXh0OworCXZvaWQgKipyZXNpZHVhbHMgPSBOVUxMOwogCWludCByZXQ7CiAK
IAlHRU1fQlVHX09OKEhBU19FWEVDTElTVFMocnEtPmk5MTUpKTsKIAorCWlmIChlbmdpbmUtPndh
X2N0eC52bWEgJiYgY2UgIT0gZW5naW5lLT5rZXJuZWxfY29udGV4dCkgeworCQlpZiAoZW5naW5l
LT53YV9jdHgudm1hLT5wcml2YXRlICE9IGNlKSB7CisJCQlyZXQgPSBjbGVhcl9yZXNpZHVhbHMo
cnEpOworCQkJaWYgKHJldCkKKwkJCQlyZXR1cm4gcmV0OworCisJCQlyZXNpZHVhbHMgPSAmZW5n
aW5lLT53YV9jdHgudm1hLT5wcml2YXRlOworCQl9CisJfQorCiAJcmV0ID0gc3dpdGNoX21tKHJx
LCB2bV9hbGlhcyhjZS0+dm0pKTsKIAlpZiAocmV0KQogCQlyZXR1cm4gcmV0OwpAQCAtMTU2Miw3
ICsxNjA3LDcgQEAgc3RhdGljIGludCBzd2l0Y2hfY29udGV4dChzdHJ1Y3QgaTkxNV9yZXF1ZXN0
ICpycSkKIAlpZiAoY2UtPnN0YXRlKSB7CiAJCXUzMiBmbGFnczsKIAotCQlHRU1fQlVHX09OKHJx
LT5lbmdpbmUtPmlkICE9IFJDUzApOworCQlHRU1fQlVHX09OKGVuZ2luZS0+aWQgIT0gUkNTMCk7
CiAKIAkJLyogRm9yIHJlc291cmNlIHN0cmVhbWVyIG9uIEhTVysgYW5kIHBvd2VyIGNvbnRleHQg
ZWxzZXdoZXJlICovCiAJCUJVSUxEX0JVR19PTihIU1dfTUlfUlNfU0FWRV9TVEFURV9FTiAhPSBN
SV9TQVZFX0VYVF9TVEFURV9FTik7CkBAIC0xNTc0LDcgKzE2MTksNyBAQCBzdGF0aWMgaW50IHN3
aXRjaF9jb250ZXh0KHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxKQogCQllbHNlCiAJCQlmbGFncyB8
PSBNSV9SRVNUT1JFX0lOSElCSVQ7CiAKLQkJcmV0ID0gbWlfc2V0X2NvbnRleHQocnEsIGZsYWdz
KTsKKwkJcmV0ID0gbWlfc2V0X2NvbnRleHQocnEsIGNlLCBmbGFncyk7CiAJCWlmIChyZXQpCiAJ
CQlyZXR1cm4gcmV0OwogCX0KQEAgLTE1ODMsNiArMTYyOCwyMCBAQCBzdGF0aWMgaW50IHN3aXRj
aF9jb250ZXh0KHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxKQogCWlmIChyZXQpCiAJCXJldHVybiBy
ZXQ7CiAKKwkvKgorCSAqIE5vdyBwYXN0IHRoZSBwb2ludCBvZiBubyByZXR1cm4sIHRoaXMgcmVx
dWVzdCBfd2lsbF8gYmUgZW1pdHRlZC4KKwkgKgorCSAqIE9yIGF0IGxlYXN0IHRoaXMgcHJlYW1i
bGUgd2lsbCBiZSBlbWl0dGVkLCB0aGUgcmVxdWVzdCBtYXkgYmUKKwkgKiBpbnRlcnJ1cHRlZCBw
cmlvciB0byBzdWJtaXR0aW5nIHRoZSB1c2VyIHBheWxvYWQuIElmIHNvLCB3ZQorCSAqIHN0aWxs
IHN1Ym1pdCB0aGUgImVtcHR5IiByZXF1ZXN0IGluIG9yZGVyIHRvIHByZXNlcnZlIGdsb2JhbAor
CSAqIHN0YXRlIHRyYWNraW5nIHN1Y2ggYXMgdGhpcywgb3VyIHRyYWNraW5nIG9mIHRoZSBjdXJy
ZW50CisJICogZGlydHkgY29udGV4dC4KKwkgKi8KKwlpZiAocmVzaWR1YWxzKSB7CisJCWludGVs
X2NvbnRleHRfcHV0KCpyZXNpZHVhbHMpOworCQkqcmVzaWR1YWxzID0gaW50ZWxfY29udGV4dF9n
ZXQoY2UpOworCX0KKwogCXJldHVybiAwOwogfQogCkBAIC0xNzY3LDYgKzE4MjYsMTEgQEAgc3Rh
dGljIHZvaWQgcmluZ19yZWxlYXNlKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKIAog
CWludGVsX2VuZ2luZV9jbGVhbnVwX2NvbW1vbihlbmdpbmUpOwogCisJaWYgKGVuZ2luZS0+d2Ff
Y3R4LnZtYSkgeworCQlpbnRlbF9jb250ZXh0X3B1dChlbmdpbmUtPndhX2N0eC52bWEtPnByaXZh
dGUpOworCQlpOTE1X3ZtYV91bnBpbl9hbmRfcmVsZWFzZSgmZW5naW5lLT53YV9jdHgudm1hLCAw
KTsKKwl9CisKIAlpbnRlbF9yaW5nX3VucGluKGVuZ2luZS0+bGVnYWN5LnJpbmcpOwogCWludGVs
X3JpbmdfcHV0KGVuZ2luZS0+bGVnYWN5LnJpbmcpOwogCkBAIC0xOTE0LDYgKzE5NzgsNjAgQEAg
c3RhdGljIHZvaWQgc2V0dXBfdmVjcyhzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUpCiAJ
ZW5naW5lLT5lbWl0X2ZpbmlfYnJlYWRjcnVtYiA9IGdlbjdfeGNzX2VtaXRfYnJlYWRjcnVtYjsK
IH0KIAorc3RhdGljIGludCBnZW43X2N0eF9zd2l0Y2hfYmJfc2V0dXAoc3RydWN0IGludGVsX2Vu
Z2luZV9jcyAqIGNvbnN0IGVuZ2luZSwKKwkJCQkgICAgc3RydWN0IGk5MTVfdm1hICogY29uc3Qg
dm1hKQoreworCXJldHVybiAwOworfQorCitzdGF0aWMgaW50IGdlbjdfY3R4X3N3aXRjaF9iYl9p
bml0KHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKK3sKKwlzdHJ1Y3QgZHJtX2k5MTVf
Z2VtX29iamVjdCAqb2JqOworCXN0cnVjdCBpOTE1X3ZtYSAqdm1hOworCWludCBzaXplOworCWlu
dCBlcnI7CisKKwlzaXplID0gZ2VuN19jdHhfc3dpdGNoX2JiX3NldHVwKGVuZ2luZSwgTlVMTCAv
KiBwcm9iZSBzaXplICovKTsKKwlpZiAoc2l6ZSA8PSAwKQorCQlyZXR1cm4gc2l6ZTsKKworCXNp
emUgPSBBTElHTihzaXplLCBQQUdFX1NJWkUpOworCW9iaiA9IGk5MTVfZ2VtX29iamVjdF9jcmVh
dGVfaW50ZXJuYWwoZW5naW5lLT5pOTE1LCBzaXplKTsKKwlpZiAoSVNfRVJSKG9iaikpCisJCXJl
dHVybiBQVFJfRVJSKG9iaik7CisKKwl2bWEgPSBpOTE1X3ZtYV9pbnN0YW5jZShvYmosIGVuZ2lu
ZS0+Z3QtPnZtLCBOVUxMKTsKKwlpZiAoSVNfRVJSKHZtYSkpIHsKKwkJZXJyID0gUFRSX0VSUih2
bWEpOworCQlnb3RvIGVycl9vYmo7CisJfQorCisJdm1hLT5wcml2YXRlID0gaW50ZWxfY29udGV4
dF9jcmVhdGUoZW5naW5lKTsgLyogZHVtbXkgcmVzaWR1YWxzICovCisJaWYgKElTX0VSUih2bWEt
PnByaXZhdGUpKSB7CisJCWVyciA9IFBUUl9FUlIodm1hLT5wcml2YXRlKTsKKwkJZ290byBlcnJf
b2JqOworCX0KKworCWVyciA9IGk5MTVfdm1hX3Bpbih2bWEsIDAsIDAsIFBJTl9VU0VSIHwgUElO
X0hJR0gpOworCWlmIChlcnIpCisJCWdvdG8gZXJyX3ByaXZhdGU7CisKKwllcnIgPSBnZW43X2N0
eF9zd2l0Y2hfYmJfc2V0dXAoZW5naW5lLCB2bWEpOworCWlmIChlcnIpCisJCWdvdG8gZXJyX3Vu
cGluOworCisJZW5naW5lLT53YV9jdHgudm1hID0gdm1hOworCXJldHVybiAwOworCitlcnJfdW5w
aW46CisJaTkxNV92bWFfdW5waW4odm1hKTsKK2Vycl9wcml2YXRlOgorCWludGVsX2NvbnRleHRf
cHV0KHZtYS0+cHJpdmF0ZSk7CitlcnJfb2JqOgorCWk5MTVfZ2VtX29iamVjdF9wdXQob2JqKTsK
KwlyZXR1cm4gZXJyOworfQorCiBpbnQgaW50ZWxfcmluZ19zdWJtaXNzaW9uX3NldHVwKHN0cnVj
dCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKIHsKIAlzdHJ1Y3QgaW50ZWxfdGltZWxpbmUgKnRp
bWVsaW5lOwpAQCAtMTk2NywxMSArMjA4NSwxOSBAQCBpbnQgaW50ZWxfcmluZ19zdWJtaXNzaW9u
X3NldHVwKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKIAogCUdFTV9CVUdfT04odGlt
ZWxpbmUtPmh3c3BfZ2d0dCAhPSBlbmdpbmUtPnN0YXR1c19wYWdlLnZtYSk7CiAKKwlpZiAoSVNf
R0VOKGVuZ2luZS0+aTkxNSwgNykgJiYgZW5naW5lLT5jbGFzcyA9PSBSRU5ERVJfQ0xBU1MpIHsK
KwkJZXJyID0gZ2VuN19jdHhfc3dpdGNoX2JiX2luaXQoZW5naW5lKTsKKwkJaWYgKGVycikKKwkJ
CWdvdG8gZXJyX3JpbmdfdW5waW47CisJfQorCiAJLyogRmluYWxseSwgdGFrZSBvd25lcnNoaXAg
YW5kIHJlc3BvbnNpYmlsaXR5IGZvciBjbGVhbnVwISAqLwogCWVuZ2luZS0+cmVsZWFzZSA9IHJp
bmdfcmVsZWFzZTsKIAogCXJldHVybiAwOwogCitlcnJfcmluZ191bnBpbjoKKwlpbnRlbF9yaW5n
X3VucGluKHJpbmcpOwogZXJyX3Jpbmc6CiAJaW50ZWxfcmluZ19wdXQocmluZyk7CiBlcnJfdGlt
ZWxpbmVfdW5waW46CkBAIC0xOTgyLDMgKzIxMDgsNyBAQCBpbnQgaW50ZWxfcmluZ19zdWJtaXNz
aW9uX3NldHVwKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKIAlpbnRlbF9lbmdpbmVf
Y2xlYW51cF9jb21tb24oZW5naW5lKTsKIAlyZXR1cm4gZXJyOwogfQorCisjaWYgSVNfRU5BQkxF
RChDT05GSUdfRFJNX0k5MTVfU0VMRlRFU1QpCisjaW5jbHVkZSAic2VsZnRlc3RfcmluZ19zdWJt
aXNzaW9uLmMiCisjZW5kaWYKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L3Nl
bGZ0ZXN0X3Jpbmdfc3VibWlzc2lvbi5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Qvc2VsZnRl
c3RfcmluZ19zdWJtaXNzaW9uLmMKbmV3IGZpbGUgbW9kZSAxMDA2NDQKaW5kZXggMDAwMDAwMDAw
MDAwLi5jZDMxZGU5ZTI4MjcKLS0tIC9kZXYvbnVsbAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9ndC9zZWxmdGVzdF9yaW5nX3N1Ym1pc3Npb24uYwpAQCAtMCwwICsxLDI0NyBAQAorLy8gU1BE
WC1MaWNlbnNlLUlkZW50aWZpZXI6IE1JVAorLyoKKyAqIENvcHlyaWdodCDCqSAyMDIwIEludGVs
IENvcnBvcmF0aW9uCisgKi8KKworI2luY2x1ZGUgImludGVsX2VuZ2luZV9wbS5oIgorI2luY2x1
ZGUgInNlbGZ0ZXN0cy9pZ3RfZmx1c2hfdGVzdC5oIgorCitzdGF0aWMgc3RydWN0IGk5MTVfdm1h
ICpjcmVhdGVfd2FsbHkoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lKQoreworCXN0cnVj
dCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmo7CisJc3RydWN0IGk5MTVfdm1hICp2bWE7CisJdTMy
ICpjczsKKwlpbnQgZXJyOworCisJb2JqID0gaTkxNV9nZW1fb2JqZWN0X2NyZWF0ZV9pbnRlcm5h
bChlbmdpbmUtPmk5MTUsIDQwOTYpOworCWlmIChJU19FUlIob2JqKSkKKwkJcmV0dXJuIEVSUl9D
QVNUKG9iaik7CisKKwl2bWEgPSBpOTE1X3ZtYV9pbnN0YW5jZShvYmosIGVuZ2luZS0+Z3QtPnZt
LCBOVUxMKTsKKwlpZiAoSVNfRVJSKHZtYSkpIHsKKwkJaTkxNV9nZW1fb2JqZWN0X3B1dChvYmop
OworCQlyZXR1cm4gdm1hOworCX0KKworCWVyciA9IGk5MTVfdm1hX3Bpbih2bWEsIDAsIDAsIFBJ
Tl9VU0VSIHwgUElOX0hJR0gpOworCWlmIChlcnIpIHsKKwkJaTkxNV9nZW1fb2JqZWN0X3B1dChv
YmopOworCQlyZXR1cm4gRVJSX1BUUihlcnIpOworCX0KKworCWNzID0gaTkxNV9nZW1fb2JqZWN0
X3Bpbl9tYXAob2JqLCBJOTE1X01BUF9XQyk7CisJaWYgKElTX0VSUihjcykpIHsKKwkJaTkxNV9n
ZW1fb2JqZWN0X3B1dChvYmopOworCQlyZXR1cm4gRVJSX0NBU1QoY3MpOworCX0KKworCSpjcysr
ID0gTUlfU1RPUkVfRFdPUkRfSU1NX0dFTjQ7CisJKmNzKysgPSAwOworCSpjcysrID0gdm1hLT5u
b2RlLnN0YXJ0ICsgNDAwMDsKKwkqY3MrKyA9IFNUQUNLX01BR0lDOworCisJKmNzKysgPSBNSV9C
QVRDSF9CVUZGRVJfRU5EOworCWk5MTVfZ2VtX29iamVjdF91bnBpbl9tYXAob2JqKTsKKworCXZt
YS0+cHJpdmF0ZSA9IGludGVsX2NvbnRleHRfY3JlYXRlKGVuZ2luZSk7IC8qIGR1bW15IHJlc2lk
dWFscyAqLworCWlmIChJU19FUlIodm1hLT5wcml2YXRlKSkgeworCQl2bWEgPSBFUlJfQ0FTVCh2
bWEtPnByaXZhdGUpOworCQlpOTE1X2dlbV9vYmplY3RfcHV0KG9iaik7CisJfQorCisJcmV0dXJu
IHZtYTsKK30KKworc3RhdGljIGludCBjb250ZXh0X3N5bmMoc3RydWN0IGludGVsX2NvbnRleHQg
KmNlKQoreworCXN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxOworCWludCBlcnIgPSAwOworCisJcnEg
PSBpbnRlbF9jb250ZXh0X2NyZWF0ZV9yZXF1ZXN0KGNlKTsKKwlpZiAoSVNfRVJSKHJxKSkKKwkJ
cmV0dXJuIFBUUl9FUlIocnEpOworCisJaTkxNV9yZXF1ZXN0X2dldChycSk7CisJaTkxNV9yZXF1
ZXN0X2FkZChycSk7CisKKwlpZiAoaTkxNV9yZXF1ZXN0X3dhaXQocnEsIDAsIEhaIC8gNSkgPCAw
KQorCQllcnIgPSAtRVRJTUU7CisJaTkxNV9yZXF1ZXN0X3B1dChycSk7CisKKwlyZXR1cm4gZXJy
OworfQorCitzdGF0aWMgaW50IG5ld19jb250ZXh0X3N5bmMoc3RydWN0IGludGVsX2VuZ2luZV9j
cyAqZW5naW5lKQoreworCXN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZTsKKwlpbnQgZXJyOworCisJ
Y2UgPSBpbnRlbF9jb250ZXh0X2NyZWF0ZShlbmdpbmUpOworCWlmIChJU19FUlIoY2UpKQorCQly
ZXR1cm4gUFRSX0VSUihjZSk7CisKKwllcnIgPSBjb250ZXh0X3N5bmMoY2UpOworCWludGVsX2Nv
bnRleHRfcHV0KGNlKTsKKworCXJldHVybiBlcnI7Cit9CisKK3N0YXRpYyBpbnQgZG91YmxlX2Nv
bnRleHRfc3luY18wMChzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUsIHUzMiAqcmVzdWx0
KQoreworCXN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZTsKKwlpbnQgZXJyLCBpOworCisJY2UgPSBp
bnRlbF9jb250ZXh0X2NyZWF0ZShlbmdpbmUpOworCWlmIChJU19FUlIoY2UpKQorCQlyZXR1cm4g
UFRSX0VSUihjZSk7CisKKwlmb3IgKGkgPSAwOyBpIDwgMjsgaSsrKSB7CisJCVdSSVRFX09OQ0Uo
KnJlc3VsdCwgMCk7CisJCWVyciA9IGNvbnRleHRfc3luYyhjZSk7CisJCWlmIChlcnIpCisJCQli
cmVhazsKKwl9CisJaW50ZWxfY29udGV4dF9wdXQoY2UpOworCisJcmV0dXJuIGVycjsKK30KKwor
c3RhdGljIGludCBrZXJuZWxfY29udGV4dF9zeW5jXzAwKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3Mg
KmVuZ2luZSwgdTMyICpyZXN1bHQpCit7CisJc3RydWN0IGludGVsX2NvbnRleHQgKmNlOworCWlu
dCBlcnIsIGk7CisKKwljZSA9IGludGVsX2NvbnRleHRfY3JlYXRlKGVuZ2luZSk7CisJaWYgKElT
X0VSUihjZSkpCisJCXJldHVybiBQVFJfRVJSKGNlKTsKKworCWZvciAoaSA9IDA7IGkgPCAyOyBp
KyspIHsKKwkJV1JJVEVfT05DRSgqcmVzdWx0LCAwKTsKKwkJZXJyID0gY29udGV4dF9zeW5jKGNl
KTsKKwkJaWYgKGVycikKKwkJCWJyZWFrOworCisJCWVyciA9IGNvbnRleHRfc3luYyhlbmdpbmUt
Pmtlcm5lbF9jb250ZXh0KTsKKwkJaWYgKGVycikKKwkJCWJyZWFrOworCX0KKwlpbnRlbF9jb250
ZXh0X3B1dChjZSk7CisKKwlyZXR1cm4gZXJyOworfQorCitzdGF0aWMgaW50IF9fbGl2ZV9jdHhf
c3dpdGNoX3dhKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKK3sKKwlzdHJ1Y3QgaTkx
NV92bWEgKmJiOworCXUzMiAqcmVzdWx0OworCWludCBwYXNzOworCWludCBlcnI7CisKKwliYiA9
IGNyZWF0ZV93YWxseShlbmdpbmUpOworCWlmIChJU19FUlIoYmIpKQorCQlyZXR1cm4gUFRSX0VS
UihiYik7CisKKwlyZXN1bHQgPSBpOTE1X2dlbV9vYmplY3RfcGluX21hcChiYi0+b2JqLCBJOTE1
X01BUF9XQyk7CisJaWYgKElTX0VSUihyZXN1bHQpKSB7CisJCWludGVsX2NvbnRleHRfcHV0KGJi
LT5wcml2YXRlKTsKKwkJaTkxNV92bWFfdW5waW5fYW5kX3JlbGVhc2UoJmJiLCAwKTsKKwkJcmV0
dXJuIFBUUl9FUlIocmVzdWx0KTsKKwl9CisJcmVzdWx0ICs9IDEwMDA7CisKKwllbmdpbmUtPndh
X2N0eC52bWEgPSBiYjsKKworCWZvciAocGFzcyA9IDA7IHBhc3MgPCAyOyBwYXNzKyspIHsKKwkJ
V1JJVEVfT05DRSgqcmVzdWx0LCAwKTsKKwkJZXJyID0gY29udGV4dF9zeW5jKGVuZ2luZS0+a2Vy
bmVsX2NvbnRleHQpOworCQlpZiAoZXJyIHx8IFJFQURfT05DRSgqcmVzdWx0KSkgeworCQkJaWYg
KCFlcnIpIHsKKwkJCQlwcl9lcnIoInBhc3NbJWRdIHdhX2JiIGVtaXR0ZWQgZm9yIHRoZSBrZXJu
ZWwgY29udGV4dFxuIiwKKwkJCQkgICAgICAgcGFzcyk7CisJCQkJZXJyID0gLUVJTlZBTDsKKwkJ
CX0KKwkJCWdvdG8gb3V0OworCQl9CisKKwkJV1JJVEVfT05DRSgqcmVzdWx0LCAwKTsKKwkJZXJy
ID0gbmV3X2NvbnRleHRfc3luYyhlbmdpbmUpOworCQlpZiAoUkVBRF9PTkNFKCpyZXN1bHQpICE9
IFNUQUNLX01BR0lDKSB7CisJCQlpZiAoIWVycikgeworCQkJCXByX2VycigicGFzc1slZF0gd2Ff
YmIgKk5PVCogZW1pdHRlZCBhZnRlciB0aGUga2VybmVsIGNvbnRleHRcbiIsCisJCQkJICAgICAg
IHBhc3MpOworCQkJCWVyciA9IC1FSU5WQUw7CisJCQl9CisJCQlnb3RvIG91dDsKKwkJfQorCisJ
CVdSSVRFX09OQ0UoKnJlc3VsdCwgMCk7CisJCWVyciA9IG5ld19jb250ZXh0X3N5bmMoZW5naW5l
KTsKKwkJaWYgKFJFQURfT05DRSgqcmVzdWx0KSAhPSBTVEFDS19NQUdJQykgeworCQkJaWYgKCFl
cnIpIHsKKwkJCQlwcl9lcnIoInBhc3NbJWRdIHdhX2JiICpOT1QqIGVtaXR0ZWQgZm9yIHRoZSB1
c2VyIGNvbnRleHQgc3dpdGNoXG4iLAorCQkJCSAgICAgICBwYXNzKTsKKwkJCQllcnIgPSAtRUlO
VkFMOworCQkJfQorCQkJZ290byBvdXQ7CisJCX0KKwl9CisKKwllcnIgPSBkb3VibGVfY29udGV4
dF9zeW5jXzAwKGVuZ2luZSwgcmVzdWx0KTsKKwlpZiAoZXJyIHx8IFJFQURfT05DRSgqcmVzdWx0
KSkgeworCQlpZiAoIWVycikgeworCQkJcHJfZXJyKCJ3YV9iYiBlbWl0dGVkIGJldHdlZW4gdGhl
IHNhbWUgdXNlciBjb250ZXh0XG4iKTsKKwkJCWVyciA9IC1FSU5WQUw7CisJCX0KKwkJZ290byBv
dXQ7CisJfQorCisJZXJyID0ga2VybmVsX2NvbnRleHRfc3luY18wMChlbmdpbmUsIHJlc3VsdCk7
CisJaWYgKGVyciB8fCBSRUFEX09OQ0UoKnJlc3VsdCkpIHsKKwkJaWYgKCFlcnIpIHsKKwkJCXBy
X2Vycigid2FfYmIgZW1pdHRlZCBiZXR3ZWVuIHRoZSBzYW1lIHVzZXIgY29udGV4dCBbd2l0aCBp
bnRlcnZlbmluZyBrZXJuZWxdXG4iKTsKKwkJCWVyciA9IC1FSU5WQUw7CisJCX0KKwkJZ290byBv
dXQ7CisJfQorCitvdXQ6CisJaW50ZWxfY29udGV4dF9wdXQoZW5naW5lLT53YV9jdHgudm1hLT5w
cml2YXRlKTsKKwlpOTE1X3ZtYV91bnBpbl9hbmRfcmVsZWFzZSgmZW5naW5lLT53YV9jdHgudm1h
LCBJOTE1X1ZNQV9SRUxFQVNFX01BUCk7CisJcmV0dXJuIGVycjsKK30KKworc3RhdGljIGludCBs
aXZlX2N0eF9zd2l0Y2hfd2Eodm9pZCAqYXJnKQoreworCXN0cnVjdCBpbnRlbF9ndCAqZ3QgPSBh
cmc7CisJc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lOworCWVudW0gaW50ZWxfZW5naW5l
X2lkIGlkOworCisJZm9yX2VhY2hfZW5naW5lKGVuZ2luZSwgZ3QsIGlkKSB7CisJCXN0cnVjdCBp
OTE1X3ZtYSAqc2F2ZWRfd2EgPSBmZXRjaF9hbmRfemVybygmZW5naW5lLT53YV9jdHgudm1hKTsK
KwkJaW50IGVycjsKKworCQlpbnRlbF9lbmdpbmVfcG1fZ2V0KGVuZ2luZSk7CisJCWVyciA9IF9f
bGl2ZV9jdHhfc3dpdGNoX3dhKGVuZ2luZSk7CisJCWludGVsX2VuZ2luZV9wbV9wdXQoZW5naW5l
KTsKKworCQllbmdpbmUtPndhX2N0eC52bWEgPSBzYXZlZF93YTsKKwkJaWYgKGlndF9mbHVzaF90
ZXN0KGd0LT5pOTE1KSkKKwkJCWVyciA9IC1FSU87CisJCWlmIChlcnIpCisJCQlyZXR1cm4gZXJy
OworCX0KKworCXJldHVybiAwOworfQorCitpbnQgaW50ZWxfcmluZ19zdWJtaXNzaW9uX2xpdmVf
c2VsZnRlc3RzKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQoreworCXN0YXRpYyBjb25z
dCBzdHJ1Y3QgaTkxNV9zdWJ0ZXN0IHRlc3RzW10gPSB7CisJCVNVQlRFU1QobGl2ZV9jdHhfc3dp
dGNoX3dhKSwKKwl9OworCisJaWYgKEhBU19FWEVDTElTVFMoaTkxNSkpCisJCXJldHVybiAwOwor
CisJcmV0dXJuIGludGVsX2d0X2xpdmVfc3VidGVzdHModGVzdHMsICZpOTE1LT5ndCk7Cit9CmRp
ZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9zZWxmdGVzdHMvaTkxNV9saXZlX3NlbGZ0
ZXN0cy5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvc2VsZnRlc3RzL2k5MTVfbGl2ZV9zZWxmdGVz
dHMuaAppbmRleCAzNDEzOGM3YmRkMTUuLjBhOTUzYmZjMDU4NSAxMDA2NDQKLS0tIGEvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvc2VsZnRlc3RzL2k5MTVfbGl2ZV9zZWxmdGVzdHMuaAorKysgYi9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9zZWxmdGVzdHMvaTkxNV9saXZlX3NlbGZ0ZXN0cy5oCkBAIC00Myw2
ICs0Myw3IEBAIHNlbGZ0ZXN0KHJlc2V0LCBpbnRlbF9yZXNldF9saXZlX3NlbGZ0ZXN0cykKIHNl
bGZ0ZXN0KG1lbW9yeV9yZWdpb24sIGludGVsX21lbW9yeV9yZWdpb25fbGl2ZV9zZWxmdGVzdHMp
CiBzZWxmdGVzdChoYW5nY2hlY2ssIGludGVsX2hhbmdjaGVja19saXZlX3NlbGZ0ZXN0cykKIHNl
bGZ0ZXN0KGV4ZWNsaXN0cywgaW50ZWxfZXhlY2xpc3RzX2xpdmVfc2VsZnRlc3RzKQorc2VsZnRl
c3QocmluZ19zdWJtaXNzaW9uLCBpbnRlbF9yaW5nX3N1Ym1pc3Npb25fbGl2ZV9zZWxmdGVzdHMp
CiBzZWxmdGVzdChwZXJmLCBpOTE1X3BlcmZfbGl2ZV9zZWxmdGVzdHMpCiAvKiBIZXJlIGJlIGRy
YWdvbnM6IGtlZXAgbGFzdCB0byBydW4gbGFzdCEgKi8KIHNlbGZ0ZXN0KGxhdGVfZ3RfcG0sIGlu
dGVsX2d0X3BtX2xhdGVfc2VsZnRlc3RzKQotLSAKMi4yNS4xCgpfX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fXwpJbnRlbC1nZnggbWFpbGluZyBsaXN0CkludGVs
LWdmeEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcv
bWFpbG1hbi9saXN0aW5mby9pbnRlbC1nZngK

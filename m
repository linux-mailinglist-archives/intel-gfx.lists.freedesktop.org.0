Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id A52E284FC3
	for <lists+intel-gfx@lfdr.de>; Wed,  7 Aug 2019 17:24:13 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 835EB6E72D;
	Wed,  7 Aug 2019 15:24:11 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 8DF576E72D
 for <intel-gfx@lists.freedesktop.org>; Wed,  7 Aug 2019 15:24:10 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from localhost (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP (TLS) id
 17920388-1500050 for multiple; Wed, 07 Aug 2019 16:24:05 +0100
MIME-Version: 1.0
To: Mika Kuoppala <mika.kuoppala@linux.intel.com>,
 intel-gfx@lists.freedesktop.org
From: Chris Wilson <chris@chris-wilson.co.uk>
In-Reply-To: <87r25x819j.fsf@gaia.fi.intel.com>
References: <20190807083702.16349-1-chris@chris-wilson.co.uk>
 <20190807083702.16349-3-chris@chris-wilson.co.uk>
 <87r25x819j.fsf@gaia.fi.intel.com>
Message-ID: <156519144382.6198.4063420370429090061@skylake-alporthouse-com>
User-Agent: alot/0.6
Date: Wed, 07 Aug 2019 16:24:03 +0100
Subject: Re: [Intel-gfx] [PATCH 3/3] drm/i915: Defer final intel_wakeref_put
 to process context
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

UXVvdGluZyBNaWthIEt1b3BwYWxhICgyMDE5LTA4LTA3IDE2OjA0OjU2KQo+IENocmlzIFdpbHNv
biA8Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPiB3cml0ZXM6Cj4gPiAtc3RhdGljIGludCBpbnRl
bF9ndF9wYXJrKHN0cnVjdCBpbnRlbF93YWtlcmVmICp3ZikKPiA+ICtzdGF0aWMgaW50IF9fZ3Rf
cGFyayhzdHJ1Y3QgaW50ZWxfd2FrZXJlZiAqd2YpCj4gPiAgewo+ID4gICAgICAgc3RydWN0IGRy
bV9pOTE1X3ByaXZhdGUgKmk5MTUgPQo+ID4gICAgICAgICAgICAgICBjb250YWluZXJfb2Yod2Ys
IHR5cGVvZigqaTkxNSksIGd0Lndha2VyZWYpOwo+ID4gQEAgLTc0LDIyICs2NywyNSBAQCBzdGF0
aWMgaW50IGludGVsX2d0X3Bhcmsoc3RydWN0IGludGVsX3dha2VyZWYgKndmKQo+ID4gICAgICAg
aWYgKElOVEVMX0dFTihpOTE1KSA+PSA2KQo+ID4gICAgICAgICAgICAgICBnZW42X3Jwc19pZGxl
KGk5MTUpOwo+ID4gIAo+ID4gKyAgICAgLyogRXZlcnl0aGluZyBzd2l0Y2hlZCBvZmYsIGZsdXNo
IGFueSByZXNpZHVhbCBpbnRlcnJ1cHQganVzdCBpbiBjYXNlICovCj4gPiArICAgICBpbnRlbF9z
eW5jaHJvbml6ZV9pcnEoaTkxNSk7Cj4gCj4gRG8gd2UgZGV0ZWN0IGl0IGdyYWNlZnVsbHkgaWYg
d2UgZ2V0IG9uZSBleHRyYSBhZmVyIHRoaXMgZmx1c2g/CgpJZiB3ZSBtYWtlIGEgbWlzdGFrZSwg
d2UgZ2V0IHVuY2xhaW1lZCBtbWlvIGZyb20gdGhlIGludGVycnVwdCBoYW5kbGVyLgoKR2l2ZW4g
dGhlIHN0cnVjdHVyZSBvZiBlbmdpbmVfcG0vZ3RfcG0sIHdlIHNob3VsZCBub3QgYmUgZ2VuZXJh
dGluZwplaXRoZXIgdXNlciBpbnRlcnJ1cHRzIG5vciBDUyBpbnRlcnJ1cHRzIGJ5IHRoaXMgcG9p
bnQuIFRoZSBwb3RlbnRpYWwgaXMKZm9yIHRoZSBndWMvcG0gaW50ZXJydXB0cywgYnV0IEkgZmVs
dCBpdCB3YXMgbW9yZSBwcnVkZW50IHRvIGRvY3VtZW50CnRoaXMgaXMgdGhlIGZpbmFsIHBvaW50
IGZvciBHVCBpbnRlcnJ1cHRzIG9mIGFueSB0eXBlLgoKPiA+ICsgICAgIEdFTV9CVUdfT04oaW50
ZWxfZ3RfcG1faXNfYXdha2UoZ3QpKTsKPiA+ICsgICAgIGZvcl9lYWNoX2VuZ2luZShlbmdpbmUs
IGd0LT5pOTE1LCBpZCkgewo+ID4gKyAgICAgICAgICAgICBjb25zdCB0eXBlb2YoKmlndF9hdG9t
aWNfcGhhc2VzKSAqcDsKPiA+ICsKPiA+ICsgICAgICAgICAgICAgZm9yIChwID0gaWd0X2F0b21p
Y19waGFzZXM7IHAtPm5hbWU7IHArKykgewo+ID4gKyAgICAgICAgICAgICAgICAgICAgIC8qCj4g
PiArICAgICAgICAgICAgICAgICAgICAgICogQWNxdWlzaXRpb24gaXMgYWx3YXlzIHN5bmNocm9u
b3VzLCBleGNlcHQgaWYgd2UKPiA+ICsgICAgICAgICAgICAgICAgICAgICAgKiBrbm93IHRoYXQg
dGhlIGVuZ2luZSBpcyBhbHJlYWR5IGF3YWxlLCBpbiB3aGljaAo+IAo+IHMvYXdhbGUvYXdha2UK
CmEgd2hhbGUKIAo+IGluIHdoaWNoIGNhc2U/CgpBdmFzdCB5ZSBibG93cyEKTW9ieSBEaWNrIQoK
PiA+ICBzdGF0aWMgbG9uZwo+ID4gIHdhaXRfZm9yX3RpbWVsaW5lcyhzdHJ1Y3QgZHJtX2k5MTVf
cHJpdmF0ZSAqaTkxNSwKPiA+ICAgICAgICAgICAgICAgICAgdW5zaWduZWQgaW50IGZsYWdzLCBs
b25nIHRpbWVvdXQpCj4gPiBAQCAtOTU0LDI3ICs5NDEsMjAgQEAgaW50IGk5MTVfZ2VtX3dhaXRf
Zm9yX2lkbGUoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUsCj4gPiAgICAgICAgICAgICAg
ICAgICAgICAgICAgdW5zaWduZWQgaW50IGZsYWdzLCBsb25nIHRpbWVvdXQpCj4gPiAgewo+ID4g
ICAgICAgLyogSWYgdGhlIGRldmljZSBpcyBhc2xlZXAsIHdlIGhhdmUgbm8gcmVxdWVzdHMgb3V0
c3RhbmRpbmcgKi8KPiA+IC0gICAgIGlmICghUkVBRF9PTkNFKGk5MTUtPmd0LmF3YWtlKSkKPiA+
ICsgICAgIGlmICghaW50ZWxfZ3RfcG1faXNfYXdha2UoJmk5MTUtPmd0KSkKPiA+ICAgICAgICAg
ICAgICAgcmV0dXJuIDA7Cj4gPiAgCj4gPiAtICAgICBHRU1fVFJBQ0UoImZsYWdzPSV4ICglcyks
IHRpbWVvdXQ9JWxkJXMsIGF3YWtlPz0lc1xuIiwKPiA+ICsgICAgIEdFTV9UUkFDRSgiZmxhZ3M9
JXggKCVzKSwgdGltZW91dD0lbGQlc1xuIiwKPiA+ICAgICAgICAgICAgICAgICBmbGFncywgZmxh
Z3MgJiBJOTE1X1dBSVRfTE9DS0VEID8gImxvY2tlZCIgOiAidW5sb2NrZWQiLAo+ID4gLSAgICAg
ICAgICAgICAgIHRpbWVvdXQsIHRpbWVvdXQgPT0gTUFYX1NDSEVEVUxFX1RJTUVPVVQgPyAiIChm
b3JldmVyKSIgOiAiIiwKPiA+IC0gICAgICAgICAgICAgICB5ZXNubyhpOTE1LT5ndC5hd2FrZSkp
Owo+ID4gKyAgICAgICAgICAgICAgIHRpbWVvdXQsIHRpbWVvdXQgPT0gTUFYX1NDSEVEVUxFX1RJ
TUVPVVQgPyAiIChmb3JldmVyKSIgOiAiIik7Cj4gPiAgCj4gPiAgICAgICB0aW1lb3V0ID0gd2Fp
dF9mb3JfdGltZWxpbmVzKGk5MTUsIGZsYWdzLCB0aW1lb3V0KTsKPiA+ICAgICAgIGlmICh0aW1l
b3V0IDwgMCkKPiA+ICAgICAgICAgICAgICAgcmV0dXJuIHRpbWVvdXQ7Cj4gPiAgCj4gPiAgICAg
ICBpZiAoZmxhZ3MgJiBJOTE1X1dBSVRfTE9DS0VEKSB7Cj4gPiAtICAgICAgICAgICAgIGludCBl
cnI7Cj4gPiAtCj4gPiAgICAgICAgICAgICAgIGxvY2tkZXBfYXNzZXJ0X2hlbGQoJmk5MTUtPmRy
bS5zdHJ1Y3RfbXV0ZXgpOwo+ID4gIAo+ID4gLSAgICAgICAgICAgICBlcnIgPSB3YWl0X2Zvcl9l
bmdpbmVzKCZpOTE1LT5ndCk7Cj4gPiAtICAgICAgICAgICAgIGlmIChlcnIpCj4gPiAtICAgICAg
ICAgICAgICAgICAgICAgcmV0dXJuIGVycjsKPiA+IC0KPiAKPiBIbW0gd2hlcmUgZG9lcyB0aGUg
aW1wbGljaXQgd2FpdCBmb3IgaWRsZSBjb21lIGZyb20gbm93PwoKSW5zdGVhZCBvZiBoYXZpbmcg
dGhlIHdhaXQgaGVyZSwgd2UgbW92ZWQgaXQgaW50byB0aGUgZW5naW5lL2d0IHBtCnRyYWNraW5n
IGFuZCBhZGRlZCBhbiBpbnRlbF9ndF9wbV93YWl0X2Zvcl9pZGxlKCkuCgo+ID4gLWludCBfX2lu
dGVsX3dha2VyZWZfcHV0X2xhc3Qoc3RydWN0IGludGVsX3J1bnRpbWVfcG0gKnJwbSwKPiA+IC0g
ICAgICAgICAgICAgICAgICAgICAgICAgIHN0cnVjdCBpbnRlbF93YWtlcmVmICp3ZiwKPiA+IC0g
ICAgICAgICAgICAgICAgICAgICAgICAgIGludCAoKmZuKShzdHJ1Y3QgaW50ZWxfd2FrZXJlZiAq
d2YpKQo+ID4gK3N0YXRpYyB2b2lkIF9fX19pbnRlbF93YWtlcmVmX3B1dF9sYXN0KHN0cnVjdCBp
bnRlbF93YWtlcmVmICp3ZikKPiA+ICB7Cj4gPiAtICAgICBpbnQgZXJyOwo+ID4gKyAgICAgaWYg
KCFhdG9taWNfZGVjX2FuZF90ZXN0KCZ3Zi0+Y291bnQpKQo+ID4gKyAgICAgICAgICAgICBnb3Rv
IHVubG9jazsKPiA+ICsKPiA+ICsgICAgIGlmIChsaWtlbHkoIXdmLT5vcHMtPnB1dCh3ZikpKSB7
Cj4gPiArICAgICAgICAgICAgIHJwbV9wdXQod2YpOwo+ID4gKyAgICAgICAgICAgICB3YWtlX3Vw
X3Zhcigmd2YtPndha2VyZWYpOwo+ID4gKyAgICAgfSBlbHNlIHsKPiA+ICsgICAgICAgICAgICAg
Lyogb3BzLT5wdXQoKSBtdXN0IHNjaGVkdWxlIGl0cyBvd24gcmVsZWFzZSBvbiBkZWZlcnJhbCAq
Lwo+ID4gKyAgICAgICAgICAgICBhdG9taWNfc2V0X3JlbGVhc2UoJndmLT5jb3VudCwgMSk7Cj4g
Cj4gSSBsb3NlIHRyYWNrIGhlcmUuIE9uIGFzeW5jIGNhbGwgdG8gZ3RfcGFyayB3ZSBlbmQgdXAg
bGVhdmluZwo+IHdpdGggYSBjb3VudCAxLiAKClNvIHdlIGtub3cgd2YtPmNvdW50IGlzIDAgYW5k
IHRoYXQgd2UgaG9sZCB0aGUgbG9jayBwcmV2ZW50aW5nIGFueW9uZQplbHNlIHJhaXNpbmcgd2Yt
PmNvdW50IGJhY2sgdG8gMS4gSWYgd2UgZmFpbCBpbiBvdXIgY2xlYW51cCB0YXNrLAprbm93aW5n
IHRoYXQgd2UgaGF2ZSBleGNsdXNpdmUgY29udHJvbCBvdmVyIHRoZSBjb3VudGVyLCB3ZSBzaW1w
bHkgbWFyawppdCBhcyAxIGFnYWluICh1c2luZyBfcmVsZWFzZSB0byB1bmxvY2sgYW55b25lIGNv
bmN1cnJlbnRseSB0cnlpbmcgdG8KYWNxdWlyZSB0aGUgd2FrZXJlZiBmb3IgdGhlbXNlbHZlcyku
Cgo+ID4gKyAgICAgLyogQXNzdW1lIHdlIGFyZSBub3QgaW4gcHJvY2VzcyBjb250ZXh0IGFuZCBz
byBjYW5ub3Qgc2xlZXAuICovCj4gPiArICAgICBpZiAod2YtPm9wcy0+ZmxhZ3MgJiBJTlRFTF9X
QUtFUkVGX1BVVF9BU1lOQyB8fAo+ID4gKyAgICAgICAgICFtdXRleF90cnlsb2NrKCZ3Zi0+bXV0
ZXgpKSB7Cj4gCj4gRGlkbid0IGZvdW5kIGFueXRoaW5nIGluIHRyeWxvY2sgdGhhdCB3b3VsZCBw
cmV2ZW50IHlvdQo+IGZyb20gc2hvb3RpbmcgeW91IG9uIHlvdXIgb3duIGxlZy4KCll1cC4gSXQn
cyBpbW1vcmFsbHkgZXF1aXZhbGVudCB0byBzcGluX3RyeWxvY2suCgo+IFNvIGl0IGlzIHVwIHRv
IGNhbGxlciAoYW5kIGV2ZW50dWFsbHkgbG9ja2RlcCBzcGFtKSBpZgo+IHRoZSBhc3luYyB1c2Fn
ZSBmYWlscyB0byBmb2xsb3cgdGhlIHJ1bGVzPwoKTm90IHRoZSBjYWxsZXIsIHRoZSBmYXVsdCBs
aWVzIGluIHRoZSB3YWtlcmVmLiBXZSBlaXRoZXIgbWFyayBpdCB0aGF0IGlzCmhhcyB0byB1c2Ug
dGhlIHdvcmtlciAocHJvY2VzcyBjb250ZXh0KSBvciBmaXggaXQgc3VjaCB0aGF0IGl0IGlzIHF1
aWNrCmFuZCBjYW4gcnVuIGluIGF0b21pYyBjb250ZXh0LiBlbmdpbmVfcG0gd2FzIHNpbXBsZSBl
bm91Z2ggdG8gbWFrZQphdG9taWMsIGd0X3BtIGlzIHByb21pc2luZyBidXQgSSBuZWVkZWQgdG8g
bWFrZSBycHMgd2FpdGZyZWUgKGRvbmUpIGFuZAptYWtlIHRoZSBkaXNwbGF5IHBtIHRydWx5IGFz
eW5jICh3aGljaCBJIGJhdWxrZWQgYXQhKS4KCj4gCj4gPiArICAgICAgICAgICAgIHNjaGVkdWxl
X3dvcmsoJndmLT53b3JrKTsKPiA+ICsgICAgICAgICAgICAgcmV0dXJuOwo+ID4gKyAgICAgfQo+
ID4gKwo+ID4gKyAgICAgX19fX2ludGVsX3dha2VyZWZfcHV0X2xhc3Qod2YpOwo+ID4gIH0KPiA+
ICAKPiA+IC12b2lkIF9faW50ZWxfd2FrZXJlZl9pbml0KHN0cnVjdCBpbnRlbF93YWtlcmVmICp3
Ziwgc3RydWN0IGxvY2tfY2xhc3Nfa2V5ICprZXkpCj4gPiArc3RhdGljIHZvaWQgX19pbnRlbF93
YWtlcmVmX3B1dF93b3JrKHN0cnVjdCB3b3JrX3N0cnVjdCAqd3JrKQo+IAo+IE5vIG5lZWQgZm9y
IHVuZGVyc2NvcmUgYmVmb3JlIHRoZSBuYW1lIGhlcmU/CgpJIHdhcyBqdXN0IHRyeWluZyB0byBr
ZWVwIGl0IGNvbnNpc3RlbnQgd2l0aCB0aGUgMyBmdW5jdGlvbnMgd29ya2luZwp0b2dldGhlci4K
Cl9faW50ZWxfd2FrZXJlZl9wdXRfbGFzdApfX2ludGVsX3dha2VyZWZfcHV0X3dvcmsKX19fX2lu
dGVsX3dha2VyZWZfcHV0X2xhc3QKCk5vdywgY291bGQgdXNlCgpfX2ludGVsX3dha2VyZWZfcHV0
X2xhc3QKX193YWtlcmVmX3B1dF93b3JrCl9fX193YWtlcmVmX3B1dF9sYXN0CgprZWVwaW5nIHRo
ZSB1bmRlcnNjb3JlcyB0byB1bmRlcmxpbmUgdGhlIGdhbWVzIGJlaW5nIHBsYXllZCB3aXRoIGxv
Y2tpbmcKYXJlIG5vdCBmb3IgdGhlIGZhaW50IG9mIGhlYXJ0LgotQ2hyaXMKX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlz
dApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0
b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

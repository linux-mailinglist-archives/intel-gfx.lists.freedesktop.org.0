Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id F3B03C1FC8
	for <lists+intel-gfx@lfdr.de>; Mon, 30 Sep 2019 13:09:30 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id DD9276E277;
	Mon, 30 Sep 2019 11:09:28 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 6E91F6E277
 for <intel-gfx@lists.freedesktop.org>; Mon, 30 Sep 2019 11:09:27 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18665625-1500050 
 for multiple; Mon, 30 Sep 2019 12:09:23 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 30 Sep 2019 12:09:17 +0100
Message-Id: <20190930110917.21194-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH] drm/i915/selftests: Exercise context switching
 in parallell
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

V2UgY3VycmVudGx5IHRlc3QgY29udGV4dCBzd2l0Y2hpbmcgb24gZWFjaCBlbmdpbmUgYXMgYSBi
YXNpYyBzdHJlc3MKdGVzdCAoanVzdCB2ZXJpZnlpbmcgdGhhdCBub3RoaW5nIGV4cGxvZGVzIGlm
IHdlIGV4ZWN1dGUgMiByZXF1ZXN0cyBmcm9tCmRpZmZlcmVudCBjb250ZXh0cyBzZXF1ZW50aWFs
bHkpLiBXaGF0IHdlIGhhdmUgbm90IHRlc3RlZCBpcyB3aGF0CmhhcHBlbnMgaWYgd2UgdHJ5IGFu
ZCBkbyBzbyBvbiBhbGwgYXZhaWxhYmxlIGVuZ2luZXMgc2ltdWx0YW5lb3VzbHksCnB1dHRpbmcg
b3VyIFNXIGFuZCB0aGUgSFcgdW5kZXIgdGhlIG1heGltYWwgc3RyZXNzLgoKU2lnbmVkLW9mZi1i
eTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28udWs+CkNjOiBNaWthIEt1b3Bw
YWxhIDxtaWthLmt1b3BwYWxhQGxpbnV4LmludGVsLmNvbT4KLS0tCiAuLi4vZHJtL2k5MTUvZ2Vt
L3NlbGZ0ZXN0cy9pOTE1X2dlbV9jb250ZXh0LmMgfCAyMDUgKysrKysrKysrKysrKysrKysrCiAx
IGZpbGUgY2hhbmdlZCwgMjA1IGluc2VydGlvbnMoKykKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9nZW0vc2VsZnRlc3RzL2k5MTVfZ2VtX2NvbnRleHQuYyBiL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMvaTkxNV9nZW1fY29udGV4dC5jCmluZGV4IGRjMjViY2Mz
ZTM3Mi4uMzNhY2MzM2JjNzc4IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0v
c2VsZnRlc3RzL2k5MTVfZ2VtX2NvbnRleHQuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9n
ZW0vc2VsZnRlc3RzL2k5MTVfZ2VtX2NvbnRleHQuYwpAQCAtMTU2LDYgKzE1NiwyMTAgQEAgc3Rh
dGljIGludCBsaXZlX25vcF9zd2l0Y2godm9pZCAqYXJnKQogCXJldHVybiBlcnI7CiB9CiAKK3N0
cnVjdCBwYXJhbGxlbF9zd2l0Y2ggeworCXN0cnVjdCB0YXNrX3N0cnVjdCAqdHNrOworCXN0cnVj
dCBpbnRlbF9jb250ZXh0ICpjZVsyXTsKK307CisKK3N0YXRpYyBpbnQgX19saXZlX3BhcmFsbGVs
X3N3aXRjaDEodm9pZCAqZGF0YSkKK3sKKwlzdHJ1Y3QgcGFyYWxsZWxfc3dpdGNoICphcmcgPSBk
YXRhOworCXN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1ID0gYXJnLT5jZVswXS0+ZW5naW5l
LT5pOTE1OworCUlHVF9USU1FT1VUKGVuZF90aW1lKTsKKwl1bnNpZ25lZCBsb25nIGNvdW50Owor
CisJY291bnQgPSAwOworCWRvIHsKKwkJc3RydWN0IGk5MTVfcmVxdWVzdCAqcnE7CisJCWludCBl
cnI7CisKKwkJbXV0ZXhfbG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CisJCXJxID0gaTkx
NV9yZXF1ZXN0X2NyZWF0ZShhcmctPmNlWzBdKTsKKwkJaWYgKElTX0VSUihycSkpIHsKKwkJCW11
dGV4X3VubG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CisJCQlyZXR1cm4gUFRSX0VSUihy
cSk7CisJCX0KKworCQlpOTE1X3JlcXVlc3RfYWRkKHJxKTsKKwkJbXV0ZXhfdW5sb2NrKCZpOTE1
LT5kcm0uc3RydWN0X211dGV4KTsKKworCQltdXRleF9sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211
dGV4KTsKKwkJcnEgPSBpOTE1X3JlcXVlc3RfY3JlYXRlKGFyZy0+Y2VbMV0pOworCQlpZiAoSVNf
RVJSKHJxKSkgeworCQkJbXV0ZXhfdW5sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKKwkJ
CXJldHVybiBQVFJfRVJSKHJxKTsKKwkJfQorCisJCWk5MTVfcmVxdWVzdF9nZXQocnEpOworCQlp
OTE1X3JlcXVlc3RfYWRkKHJxKTsKKwkJbXV0ZXhfdW5sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211
dGV4KTsKKworCQllcnIgPSAwOworCQlpZiAoaTkxNV9yZXF1ZXN0X3dhaXQocnEsIDAsIEhaIC8g
NSkgPCAwKQorCQkJZXJyID0gLUVUSU1FOworCQlpOTE1X3JlcXVlc3RfcHV0KHJxKTsKKwkJaWYg
KGVycikKKwkJCXJldHVybiBlcnI7CisKKwkJY291bnQrKzsKKwl9IHdoaWxlICghX19pZ3RfdGlt
ZW91dChlbmRfdGltZSwgTlVMTCkpOworCisJcHJfaW5mbygiJXM6ICVsdSBzd2l0Y2hlcyAoc3lu
YylcbiIsIGFyZy0+Y2VbMF0tPmVuZ2luZS0+bmFtZSwgY291bnQpOworCXJldHVybiAwOworfQor
CitzdGF0aWMgaW50IF9fbGl2ZV9wYXJhbGxlbF9zd2l0Y2hOKHZvaWQgKmRhdGEpCit7CisJc3Ry
dWN0IHBhcmFsbGVsX3N3aXRjaCAqYXJnID0gZGF0YTsKKwlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0
ZSAqaTkxNSA9IGFyZy0+Y2VbMF0tPmVuZ2luZS0+aTkxNTsKKwlJR1RfVElNRU9VVChlbmRfdGlt
ZSk7CisJdW5zaWduZWQgbG9uZyBjb3VudDsKKworCWNvdW50ID0gMDsKKwlkbyB7CisJCXN0cnVj
dCBpOTE1X3JlcXVlc3QgKnJxOworCisJCW11dGV4X2xvY2soJmk5MTUtPmRybS5zdHJ1Y3RfbXV0
ZXgpOworCQlycSA9IGk5MTVfcmVxdWVzdF9jcmVhdGUoYXJnLT5jZVswXSk7CisJCWlmIChJU19F
UlIocnEpKSB7CisJCQltdXRleF91bmxvY2soJmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOworCQkJ
cmV0dXJuIFBUUl9FUlIocnEpOworCQl9CisKKwkJaTkxNV9yZXF1ZXN0X2FkZChycSk7CisJCW11
dGV4X3VubG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CisKKwkJbXV0ZXhfbG9jaygmaTkx
NS0+ZHJtLnN0cnVjdF9tdXRleCk7CisJCXJxID0gaTkxNV9yZXF1ZXN0X2NyZWF0ZShhcmctPmNl
WzFdKTsKKwkJaWYgKElTX0VSUihycSkpIHsKKwkJCW11dGV4X3VubG9jaygmaTkxNS0+ZHJtLnN0
cnVjdF9tdXRleCk7CisJCQlyZXR1cm4gUFRSX0VSUihycSk7CisJCX0KKworCQlpOTE1X3JlcXVl
c3RfYWRkKHJxKTsKKwkJbXV0ZXhfdW5sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKKwor
CQljb3VudCsrOworCX0gd2hpbGUgKCFfX2lndF90aW1lb3V0KGVuZF90aW1lLCBOVUxMKSk7CisK
Kwlwcl9pbmZvKCIlczogJWx1IHN3aXRjaGVzIChtYW55KVxuIiwgYXJnLT5jZVswXS0+ZW5naW5l
LT5uYW1lLCBjb3VudCk7CisJcmV0dXJuIDA7Cit9CisKK3N0YXRpYyBpbnQgbGl2ZV9wYXJhbGxl
bF9zd2l0Y2godm9pZCAqYXJnKQoreworCXN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1ID0g
YXJnOworCXN0YXRpYyBpbnQgKCogY29uc3QgZnVuY1tdKSh2b2lkICphcmcpID0geworCQlfX2xp
dmVfcGFyYWxsZWxfc3dpdGNoMSwKKwkJX19saXZlX3BhcmFsbGVsX3N3aXRjaE4sCisJCU5VTEws
CisJfTsKKwlzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4WzJdOworCXN0cnVjdCBwYXJhbGxl
bF9zd2l0Y2ggKmRhdGE7CisJaW50ICgqIGNvbnN0ICpmbikodm9pZCAqYXJnKTsKKwlzdHJ1Y3Qg
ZHJtX2ZpbGUgKmZpbGU7CisJaW50IGVyciA9IDA7CisJaW50IG47CisKKwkvKgorCSAqIENoZWNr
IHdlIGNhbiBwcm9jZXNzIHN3aXRjaGVzIG9uIGFsbCBlbmdpbmVzIHNpbXVsdGFuZW91c2x5Lgor
CSAqLworCisJaWYgKCFEUklWRVJfQ0FQUyhpOTE1KS0+aGFzX2xvZ2ljYWxfY29udGV4dHMpCisJ
CXJldHVybiAwOworCisJZmlsZSA9IG1vY2tfZmlsZShpOTE1KTsKKwlpZiAoSVNfRVJSKGZpbGUp
KQorCQlyZXR1cm4gUFRSX0VSUihmaWxlKTsKKworCWRhdGEgPSBrY2FsbG9jKEk5MTVfTlVNX0VO
R0lORVMsIHNpemVvZigqZGF0YSksIEdGUF9LRVJORUwpOworCWlmICghZGF0YSkKKwkJcmV0dXJu
IC1FTk9NRU07CisKKwlmb3IgKG4gPSAwOyBuIDwgQVJSQVlfU0laRShjdHgpOyBuKyspIHsKKwkJ
c3RydWN0IGk5MTVfZ2VtX2VuZ2luZXNfaXRlciBpdDsKKwkJc3RydWN0IGludGVsX2NvbnRleHQg
KmNlOworCisJCW11dGV4X2xvY2soJmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOworCQljdHhbbl0g
PSBsaXZlX2NvbnRleHQoaTkxNSwgZmlsZSk7CisJCW11dGV4X3VubG9jaygmaTkxNS0+ZHJtLnN0
cnVjdF9tdXRleCk7CisJCWlmIChJU19FUlIoY3R4W25dKSkgeworCQkJZXJyID0gUFRSX0VSUihj
dHhbbl0pOworCQkJZ290byBvdXQ7CisJCX0KKworCQlmb3JfZWFjaF9nZW1fZW5naW5lKGNlLAor
CQkJCSAgICBpOTE1X2dlbV9jb250ZXh0X2xvY2tfZW5naW5lcyhjdHhbbl0pLCBpdCkgeworCQkJ
bXV0ZXhfbG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CisJCQllcnIgPSBpbnRlbF9jb250
ZXh0X3BpbihjZSk7CisJCQltdXRleF91bmxvY2soJmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOwor
CQkJaWYgKGVycikgeworCQkJCWk5MTVfZ2VtX2NvbnRleHRfdW5sb2NrX2VuZ2luZXMoY3R4W25d
KTsKKwkJCQlnb3RvIG91dDsKKwkJCX0KKwkJCWRhdGFbY2UtPmVuZ2luZS0+bGVnYWN5X2lkeF0u
Y2Vbbl0gPSBjZTsKKwkJfQorCQlpOTE1X2dlbV9jb250ZXh0X3VubG9ja19lbmdpbmVzKGN0eFtu
XSk7CisJfQorCisJZm9yIChmbiA9IGZ1bmM7ICFlcnIgJiYgKmZuOyBmbisrKSB7CisJCXN0cnVj
dCBpZ3RfbGl2ZV90ZXN0IHQ7CisJCWludCBuOworCisJCW11dGV4X2xvY2soJmk5MTUtPmRybS5z
dHJ1Y3RfbXV0ZXgpOworCQllcnIgPSBpZ3RfbGl2ZV90ZXN0X2JlZ2luKCZ0LCBpOTE1LCBfX2Z1
bmNfXywgIiIpOworCQltdXRleF91bmxvY2soJmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOworCQlp
ZiAoZXJyKQorCQkJYnJlYWs7CisKKwkJZm9yIChuID0gMDsgbiA8IEk5MTVfTlVNX0VOR0lORVM7
IG4rKykgeworCQkJaWYgKGRhdGFbbl0uY2VbMF0gPT0gTlVMTCB8fCBkYXRhW25dLmNlWzFdID09
IE5VTEwpCisJCQkJY29udGludWU7CisKKwkJCWRhdGFbbl0udHNrID0ga3RocmVhZF9ydW4oKmZu
LCAmZGF0YVtuXSwKKwkJCQkJCSAgImlndC9wYXJhbGxlbDolcyIsCisJCQkJCQkgIGRhdGFbbl0u
Y2VbMF0tPmVuZ2luZS0+bmFtZSk7CisJCQlpZiAoSVNfRVJSKGRhdGFbbl0udHNrKSkgeworCQkJ
CWVyciA9IFBUUl9FUlIoZGF0YVtuXS50c2spOworCQkJCWJyZWFrOworCQkJfQorCQkJZ2V0X3Rh
c2tfc3RydWN0KGRhdGFbbl0udHNrKTsKKwkJfQorCisJCWZvciAobiA9IDA7IG4gPCBJOTE1X05V
TV9FTkdJTkVTOyBuKyspIHsKKwkJCWludCBzdGF0dXM7CisKKwkJCWlmIChJU19FUlJfT1JfTlVM
TChkYXRhW25dLnRzaykpCisJCQkJY29udGludWU7CisKKwkJCXN0YXR1cyA9IGt0aHJlYWRfc3Rv
cChkYXRhW25dLnRzayk7CisJCQlpZiAoc3RhdHVzICYmICFlcnIpCisJCQkJZXJyID0gc3RhdHVz
OworCisJCQlwdXRfdGFza19zdHJ1Y3QoZGF0YVtuXS50c2spOworCQkJZGF0YVtuXS50c2sgPSBO
VUxMOworCQl9CisKKwkJbXV0ZXhfbG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CisJCWlm
IChpZ3RfbGl2ZV90ZXN0X2VuZCgmdCkpCisJCQllcnIgPSAtRUlPOworCQltdXRleF91bmxvY2so
Jmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOworCX0KKworb3V0OgorCW11dGV4X2xvY2soJmk5MTUt
PmRybS5zdHJ1Y3RfbXV0ZXgpOworCWZvciAobiA9IDA7IG4gPCBJOTE1X05VTV9FTkdJTkVTOyBu
KyspIHsKKwkJaWYgKGRhdGFbbl0uY2VbMF0pCisJCQlpbnRlbF9jb250ZXh0X3VucGluKGRhdGFb
bl0uY2VbMF0pOworCQlpZiAoZGF0YVtuXS5jZVsxXSkKKwkJCWludGVsX2NvbnRleHRfdW5waW4o
ZGF0YVtuXS5jZVsxXSk7CisJfQorCW11dGV4X3VubG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9tdXRl
eCk7CisJa2ZyZWUoZGF0YSk7CisJbW9ja19maWxlX2ZyZWUoaTkxNSwgZmlsZSk7CisJcmV0dXJu
IGVycjsKK30KKwogc3RhdGljIHVuc2lnbmVkIGxvbmcgcmVhbF9wYWdlX2NvdW50KHN0cnVjdCBk
cm1faTkxNV9nZW1fb2JqZWN0ICpvYmopCiB7CiAJcmV0dXJuIGh1Z2VfZ2VtX29iamVjdF9waHlz
X3NpemUob2JqKSA+PiBQQUdFX1NISUZUOwpAQCAtMTY4MSw2ICsxODg1LDcgQEAgaW50IGk5MTVf
Z2VtX2NvbnRleHRfbGl2ZV9zZWxmdGVzdHMoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUp
CiB7CiAJc3RhdGljIGNvbnN0IHN0cnVjdCBpOTE1X3N1YnRlc3QgdGVzdHNbXSA9IHsKIAkJU1VC
VEVTVChsaXZlX25vcF9zd2l0Y2gpLAorCQlTVUJURVNUKGxpdmVfcGFyYWxsZWxfc3dpdGNoKSwK
IAkJU1VCVEVTVChpZ3RfY3R4X2V4ZWMpLAogCQlTVUJURVNUKGlndF9jdHhfcmVhZG9ubHkpLAog
CQlTVUJURVNUKGlndF9jdHhfc3NldSksCi0tIAoyLjIzLjAKCl9fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwt
Z2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9t
YWlsbWFuL2xpc3RpbmZvL2ludGVsLWdmeA==

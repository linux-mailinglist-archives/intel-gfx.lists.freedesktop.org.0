Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 9201365A28
	for <lists+intel-gfx@lfdr.de>; Thu, 11 Jul 2019 17:12:35 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id EDF3D6E245;
	Thu, 11 Jul 2019 15:12:32 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id E697E6E23F
 for <intel-gfx@lists.freedesktop.org>; Thu, 11 Jul 2019 15:12:31 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17226434-1500050 
 for multiple; Thu, 11 Jul 2019 16:12:19 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Thu, 11 Jul 2019 16:12:17 +0100
Message-Id: <20190711151217.29937-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.22.0
In-Reply-To: <20190708111944.20095-1-chris@chris-wilson.co.uk>
References: <20190708111944.20095-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v3] drm/i915/oa: Reconfigure contexts on the fly
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

QXZvaWQgYSBnbG9iYWwgaWRsZSBiYXJyaWVyIGJ5IHJlY29uZmlndXJpbmcgZWFjaCBjb250ZXh0
IGJ5IHJld3JpdGluZwp0aGVtIHdpdGggTUlfU1RPUkVfRFdPUkQgZnJvbSB0aGUga2VybmVsIGNv
bnRleHQuCgp2MjogV2Ugb25seSBuZWVkIHRvIGRldGVybWluZSB0aGUgZGVzaXJlZCByZWdpc3Rl
ciB2YWx1ZXMgb25jZSwgdGhleSBhcmUKdGhlIHNhbWUgZm9yIGFsbCBjb250ZXh0cy4KdjM6IERv
bid0IHJlbW92ZSB0aGUga2VybmVsIGNvbnRleHQgZnJvbSB0aGUgbGlzdCBvZiBrbm93biBHRU0g
Y29udGV4dHM7CnRoZSB3b3JsZCBpcyBub3QgcmVhZHkgZm9yIHRoYXQgeWV0LgoKU2lnbmVkLW9m
Zi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28udWs+CkNjOiBMaW9uZWwg
TGFuZHdlcmxpbiA8bGlvbmVsLmcubGFuZHdlcmxpbkBpbnRlbC5jb20+CkNjOiBUdnJ0a28gVXJz
dWxpbiA8dHZydGtvLnVyc3VsaW5AaW50ZWwuY29tPgpSZXZpZXdlZC1ieTogTGlvbmVsIExhbmR3
ZXJsaW4gPGxpb25lbC5nLmxhbmR3ZXJsaW5AaW50ZWwuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2d0L2ludGVsX2xyYy5jIHwgICA3ICstCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1
X3BlcmYuYyAgICB8IDI1MSArKysrKysrKysrKysrKysrKysrKystLS0tLS0tCiAyIGZpbGVzIGNo
YW5nZWQsIDE5NyBpbnNlcnRpb25zKCspLCA2MSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9scmMuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2d0L2ludGVsX2xyYy5jCmluZGV4IDI3MGVmNDE3ZGQxYS4uZmE5MThjMTlhNmFmIDEwMDY0NAot
LS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9scmMuYworKysgYi9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9ndC9pbnRlbF9scmMuYwpAQCAtMTU3MCw5ICsxNTcwLDEyIEBAIF9fZXhlY2xp
c3RzX3VwZGF0ZV9yZWdfc3RhdGUoc3RydWN0IGludGVsX2NvbnRleHQgKmNlLAogCXJlZ3NbQ1RY
X1JJTkdfVEFJTCArIDFdID0gcmluZy0+dGFpbDsKIAogCS8qIFJQQ1MgKi8KLQlpZiAoZW5naW5l
LT5jbGFzcyA9PSBSRU5ERVJfQ0xBU1MpCisJaWYgKGVuZ2luZS0+Y2xhc3MgPT0gUkVOREVSX0NM
QVNTKSB7CiAJCXJlZ3NbQ1RYX1JfUFdSX0NMS19TVEFURSArIDFdID0KIAkJCWludGVsX3NzZXVf
bWFrZV9ycGNzKGVuZ2luZS0+aTkxNSwgJmNlLT5zc2V1KTsKKworCQlpOTE1X29hX2luaXRfcmVn
X3N0YXRlKGVuZ2luZSwgY2UsIHJlZ3MpOworCX0KIH0KIAogc3RhdGljIGludApAQCAtMjk5Miw4
ICsyOTk1LDYgQEAgc3RhdGljIHZvaWQgZXhlY2xpc3RzX2luaXRfcmVnX3N0YXRlKHUzMiAqcmVn
cywKIAlpZiAocmNzKSB7CiAJCXJlZ3NbQ1RYX0xSSV9IRUFERVJfMl0gPSBNSV9MT0FEX1JFR0lT
VEVSX0lNTSgxKTsKIAkJQ1RYX1JFRyhyZWdzLCBDVFhfUl9QV1JfQ0xLX1NUQVRFLCBHRU44X1Jf
UFdSX0NMS19TVEFURSwgMCk7Ci0KLQkJaTkxNV9vYV9pbml0X3JlZ19zdGF0ZShlbmdpbmUsIGNl
LCByZWdzKTsKIAl9CiAKIAlyZWdzW0NUWF9FTkRdID0gTUlfQkFUQ0hfQlVGRkVSX0VORDsKZGlm
ZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcGVyZi5jIGIvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvaTkxNV9wZXJmLmMKaW5kZXggMDA3ODI2ZGVkOWIzLi43OGNiOWVjODg2NmMgMTAw
NjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcGVyZi5jCisrKyBiL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2k5MTVfcGVyZi5jCkBAIC0xNjM2LDYgKzE2MzYsMjcgQEAgc3RhdGljIHZv
aWQgaHN3X2Rpc2FibGVfbWV0cmljX3NldChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3By
aXYpCiAJCQkJICAgICAgfkdUX05PQV9FTkFCTEUpKTsKIH0KIAorc3RhdGljIHUzMiBvYV9jb25m
aWdfZmxleF9yZWcoY29uc3Qgc3RydWN0IGk5MTVfb2FfY29uZmlnICpvYV9jb25maWcsCisJCQkg
ICAgICBpOTE1X3JlZ190IHJlZykKK3sKKwl1MzIgbW1pbyA9IGk5MTVfbW1pb19yZWdfb2Zmc2V0
KHJlZyk7CisJaW50IGk7CisKKwkvKgorCSAqIFRoaXMgYXJiaXRyYXJ5IGRlZmF1bHQgd2lsbCBz
ZWxlY3QgdGhlICdFVSBGUFUwIFBpcGVsaW5lCisJICogQWN0aXZlJyBldmVudC4gSW4gdGhlIGZ1
dHVyZSBpdCdzIGFudGljaXBhdGVkIHRoYXQgdGhlcmUKKwkgKiB3aWxsIGJlIGFuIGV4cGxpY2l0
ICdObyBFdmVudCcgd2UgY2FuIHNlbGVjdCwgYnV0IG5vdCB5ZXQuLi4KKwkgKi8KKwlpZiAoIW9h
X2NvbmZpZykKKwkJcmV0dXJuIDA7CisKKwlmb3IgKGkgPSAwOyBpIDwgb2FfY29uZmlnLT5mbGV4
X3JlZ3NfbGVuOyBpKyspIHsKKwkJaWYgKGk5MTVfbW1pb19yZWdfb2Zmc2V0KG9hX2NvbmZpZy0+
ZmxleF9yZWdzW2ldLmFkZHIpID09IG1taW8pCisJCQlyZXR1cm4gb2FfY29uZmlnLT5mbGV4X3Jl
Z3NbaV0udmFsdWU7CisJfQorCisJcmV0dXJuIDA7Cit9CiAvKgogICogTkI6IEl0IG11c3QgYWx3
YXlzIHJlbWFpbiBwb2ludGVyIHNhZmUgdG8gcnVuIHRoaXMgZXZlbiBpZiB0aGUgT0EgdW5pdAog
ICogaGFzIGJlZW4gZGlzYWJsZWQuCkBAIC0xNjY5LDI4ICsxNjkwLDggQEAgZ2VuOF91cGRhdGVf
cmVnX3N0YXRlX3VubG9ja2VkKHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSwKIAkJR0VOOF9PQV9D
T1VOVEVSX1JFU1VNRSk7CiAKIAlmb3IgKGkgPSAwOyBpIDwgQVJSQVlfU0laRShmbGV4X3JlZ3Mp
OyBpKyspIHsKLQkJdTMyIHN0YXRlX29mZnNldCA9IGN0eF9mbGV4ZXUwICsgaSAqIDI7Ci0JCXUz
MiBtbWlvID0gaTkxNV9tbWlvX3JlZ19vZmZzZXQoZmxleF9yZWdzW2ldKTsKLQotCQkvKgotCQkg
KiBUaGlzIGFyYml0cmFyeSBkZWZhdWx0IHdpbGwgc2VsZWN0IHRoZSAnRVUgRlBVMCBQaXBlbGlu
ZQotCQkgKiBBY3RpdmUnIGV2ZW50LiBJbiB0aGUgZnV0dXJlIGl0J3MgYW50aWNpcGF0ZWQgdGhh
dCB0aGVyZQotCQkgKiB3aWxsIGJlIGFuIGV4cGxpY2l0ICdObyBFdmVudCcgd2UgY2FuIHNlbGVj
dCwgYnV0IG5vdCB5ZXQuLi4KLQkJICovCi0JCXUzMiB2YWx1ZSA9IDA7Ci0KLQkJaWYgKG9hX2Nv
bmZpZykgewotCQkJdTMyIGo7Ci0KLQkJCWZvciAoaiA9IDA7IGogPCBvYV9jb25maWctPmZsZXhf
cmVnc19sZW47IGorKykgewotCQkJCWlmIChpOTE1X21taW9fcmVnX29mZnNldChvYV9jb25maWct
PmZsZXhfcmVnc1tqXS5hZGRyKSA9PSBtbWlvKSB7Ci0JCQkJCXZhbHVlID0gb2FfY29uZmlnLT5m
bGV4X3JlZ3Nbal0udmFsdWU7Ci0JCQkJCWJyZWFrOwotCQkJCX0KLQkJCX0KLQkJfQotCi0JCUNU
WF9SRUcocmVnX3N0YXRlLCBzdGF0ZV9vZmZzZXQsIGZsZXhfcmVnc1tpXSwgdmFsdWUpOworCQlD
VFhfUkVHKHJlZ19zdGF0ZSwgY3R4X2ZsZXhldTAgKyBpICogMiwgZmxleF9yZWdzW2ldLAorCQkJ
b2FfY29uZmlnX2ZsZXhfcmVnKG9hX2NvbmZpZywgZmxleF9yZWdzW2ldKSk7CiAJfQogCiAJQ1RY
X1JFRyhyZWdfc3RhdGUsCkBAIC0xNjk4LDYgKzE2OTksMTA3IEBAIGdlbjhfdXBkYXRlX3JlZ19z
dGF0ZV91bmxvY2tlZChzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UsCiAJCWludGVsX3NzZXVfbWFr
ZV9ycGNzKGk5MTUsICZjZS0+c3NldSkpOwogfQogCitzdHJ1Y3QgZmxleCB7CisJaTkxNV9yZWdf
dCByZWc7CisJdTMyIG9mZnNldDsKKwl1MzIgdmFsdWU7Cit9OworCitzdGF0aWMgaW50CitnZW44
X3N0b3JlX2ZsZXgoc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEsCisJCXN0cnVjdCBpbnRlbF9jb250
ZXh0ICpjZSwKKwkJY29uc3Qgc3RydWN0IGZsZXggKmZsZXgsIHVuc2lnbmVkIGludCBjb3VudCkK
K3sKKwl1MzIgb2Zmc2V0OworCXUzMiAqY3M7CisKKwljcyA9IGludGVsX3JpbmdfYmVnaW4ocnEs
IDQgKiBjb3VudCk7CisJaWYgKElTX0VSUihjcykpCisJCXJldHVybiBQVFJfRVJSKGNzKTsKKwor
CW9mZnNldCA9IGk5MTVfZ2d0dF9vZmZzZXQoY2UtPnN0YXRlKSArIExSQ19TVEFURV9QTiAqIFBB
R0VfU0laRTsKKwlkbyB7CisJCSpjcysrID0gTUlfU1RPUkVfRFdPUkRfSU1NX0dFTjQgfCBNSV9V
U0VfR0dUVDsKKwkJKmNzKysgPSBvZmZzZXQgKyAoZmxleC0+b2Zmc2V0ICsgMSkgKiBzaXplb2Yo
dTMyKTsKKwkJKmNzKysgPSAwOworCQkqY3MrKyA9IGZsZXgtPnZhbHVlOworCX0gd2hpbGUgKGZs
ZXgrKywgLS1jb3VudCk7CisKKwlpbnRlbF9yaW5nX2FkdmFuY2UocnEsIGNzKTsKKworCXJldHVy
biAwOworfQorCitzdGF0aWMgaW50CitnZW44X2xvYWRfZmxleChzdHJ1Y3QgaTkxNV9yZXF1ZXN0
ICpycSwKKwkgICAgICAgc3RydWN0IGludGVsX2NvbnRleHQgKmNlLAorCSAgICAgICBjb25zdCBz
dHJ1Y3QgZmxleCAqZmxleCwgdW5zaWduZWQgaW50IGNvdW50KQoreworCXUzMiAqY3M7CisKKwlH
RU1fQlVHX09OKCFjb3VudCB8fCBjb3VudCA+IDYzKTsKKworCWNzID0gaW50ZWxfcmluZ19iZWdp
bihycSwgMiAqIGNvdW50ICsgMik7CisJaWYgKElTX0VSUihjcykpCisJCXJldHVybiBQVFJfRVJS
KGNzKTsKKworCSpjcysrID0gTUlfTE9BRF9SRUdJU1RFUl9JTU0oY291bnQpOworCWRvIHsKKwkJ
KmNzKysgPSBpOTE1X21taW9fcmVnX29mZnNldChmbGV4LT5yZWcpOworCQkqY3MrKyA9IGZsZXgt
PnZhbHVlOworCX0gd2hpbGUgKGZsZXgrKywgLS1jb3VudCk7CisJKmNzKysgPSBNSV9OT09QOwor
CisJaW50ZWxfcmluZ19hZHZhbmNlKHJxLCBjcyk7CisKKwlyZXR1cm4gMDsKK30KKworc3RhdGlj
IGludCBnZW44X21vZGlmeV9jb250ZXh0KHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSwKKwkJCSAg
ICAgICBjb25zdCBzdHJ1Y3QgZmxleCAqZmxleCwgdW5zaWduZWQgaW50IGNvdW50KQoreworCXN0
cnVjdCBpOTE1X3JlcXVlc3QgKnJxOworCWludCBlcnI7CisKKwlsb2NrZGVwX2Fzc2VydF9oZWxk
KCZjZS0+cGluX211dGV4KTsKKworCXJxID0gaTkxNV9yZXF1ZXN0X2NyZWF0ZShjZS0+ZW5naW5l
LT5rZXJuZWxfY29udGV4dCk7CisJaWYgKElTX0VSUihycSkpCisJCXJldHVybiBQVFJfRVJSKHJx
KTsKKworCS8qIFNlcmlhbGlzZSB3aXRoIHRoZSByZW1vdGUgY29udGV4dCAqLworCWVyciA9IGk5
MTVfYWN0aXZlX3JlcXVlc3Rfc2V0KCZjZS0+cmluZy0+dGltZWxpbmUtPmxhc3RfcmVxdWVzdCwg
cnEpOworCWlmIChlcnIpCisJCWdvdG8gb3V0X2FkZDsKKworCS8qIEtlZXAgdGhlIHJlbW90ZSBj
b250ZXh0IGFsaXZlIHVudGlsIGFmdGVyIHdlIGZpbmlzaCBlZGl0aW5nICovCisJZXJyID0gaTkx
NV9hY3RpdmVfcmVmKCZjZS0+YWN0aXZlLCBycS0+ZmVuY2UuY29udGV4dCwgcnEpOworCWlmIChl
cnIpCisJCWdvdG8gb3V0X2FkZDsKKworCWVyciA9IGdlbjhfc3RvcmVfZmxleChycSwgY2UsIGZs
ZXgsIGNvdW50KTsKKworb3V0X2FkZDoKKwlpOTE1X3JlcXVlc3RfYWRkKHJxKTsKKwlyZXR1cm4g
ZXJyOworfQorCitzdGF0aWMgaW50IGdlbjhfbW9kaWZ5X3NlbGYoc3RydWN0IGludGVsX2NvbnRl
eHQgKmNlLAorCQkJICAgIGNvbnN0IHN0cnVjdCBmbGV4ICpmbGV4LCB1bnNpZ25lZCBpbnQgY291
bnQpCit7CisJc3RydWN0IGk5MTVfcmVxdWVzdCAqcnE7CisJaW50IGVycjsKKworCXJxID0gaTkx
NV9yZXF1ZXN0X2NyZWF0ZShjZSk7CisJaWYgKElTX0VSUihycSkpCisJCXJldHVybiBQVFJfRVJS
KHJxKTsKKworCWVyciA9IGdlbjhfbG9hZF9mbGV4KHJxLCBjZSwgZmxleCwgY291bnQpOworCisJ
aTkxNV9yZXF1ZXN0X2FkZChycSk7CisJcmV0dXJuIGVycjsKK30KKwogLyoKICAqIE1hbmFnZXMg
dXBkYXRpbmcgdGhlIHBlci1jb250ZXh0IGFzcGVjdHMgb2YgdGhlIE9BIHN0cmVhbQogICogY29u
ZmlndXJhdGlvbiBhY3Jvc3MgYWxsIGNvbnRleHRzLgpAQCAtMTcyMiwxNSArMTgyNCw0MyBAQCBn
ZW44X3VwZGF0ZV9yZWdfc3RhdGVfdW5sb2NrZWQoc3RydWN0IGludGVsX2NvbnRleHQgKmNlLAog
ICoKICAqIE5vdGU6IGl0J3Mgb25seSB0aGUgUkNTL1JlbmRlciBjb250ZXh0IHRoYXQgaGFzIGFu
eSBPQSBzdGF0ZS4KICAqLwotc3RhdGljIGludCBnZW44X2NvbmZpZ3VyZV9hbGxfY29udGV4dHMo
c3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2LAorc3RhdGljIGludCBnZW44X2NvbmZp
Z3VyZV9hbGxfY29udGV4dHMoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUsCiAJCQkJICAg
ICAgIGNvbnN0IHN0cnVjdCBpOTE1X29hX2NvbmZpZyAqb2FfY29uZmlnKQogewotCXVuc2lnbmVk
IGludCBtYXBfdHlwZSA9IGk5MTVfY29oZXJlbnRfbWFwX3R5cGUoZGV2X3ByaXYpOworCS8qIFRo
ZSBNTUlPIG9mZnNldHMgZm9yIEZsZXggRVUgcmVnaXN0ZXJzIGFyZW4ndCBjb250aWd1b3VzICov
CisJY29uc3QgdTMyIGN0eF9mbGV4ZXUwID0gaTkxNS0+cGVyZi5vYS5jdHhfZmxleGV1MF9vZmZz
ZXQ7CisjZGVmaW5lIGN0eF9mbGV4ZXVOKE4pIChjdHhfZmxleGV1MCArIDIgKiAoTikpCisJc3Ry
dWN0IGZsZXggcmVnc1tdID0geworCQl7CisJCQlHRU44X1JfUFdSX0NMS19TVEFURSwKKwkJCUNU
WF9SX1BXUl9DTEtfU1RBVEUsCisJCX0sCisJCXsKKwkJCUdFTjhfT0FDVFhDT05UUk9MLAorCQkJ
aTkxNS0+cGVyZi5vYS5jdHhfb2FjdHhjdHJsX29mZnNldCwKKwkJCSgoaTkxNS0+cGVyZi5vYS5w
ZXJpb2RfZXhwb25lbnQgPDwgR0VOOF9PQV9USU1FUl9QRVJJT0RfU0hJRlQpIHwKKwkJCSAoaTkx
NS0+cGVyZi5vYS5wZXJpb2RpYyA/IEdFTjhfT0FfVElNRVJfRU5BQkxFIDogMCkgfAorCQkJIEdF
TjhfT0FfQ09VTlRFUl9SRVNVTUUpCisJCX0sCisJCXsgRVVfUEVSRl9DTlRMMCwgY3R4X2ZsZXhl
dU4oMCkgfSwKKwkJeyBFVV9QRVJGX0NOVEwxLCBjdHhfZmxleGV1TigxKSB9LAorCQl7IEVVX1BF
UkZfQ05UTDIsIGN0eF9mbGV4ZXVOKDIpIH0sCisJCXsgRVVfUEVSRl9DTlRMMywgY3R4X2ZsZXhl
dU4oMykgfSwKKwkJeyBFVV9QRVJGX0NOVEw0LCBjdHhfZmxleGV1Tig0KSB9LAorCQl7IEVVX1BF
UkZfQ05UTDUsIGN0eF9mbGV4ZXVOKDUpIH0sCisJCXsgRVVfUEVSRl9DTlRMNiwgY3R4X2ZsZXhl
dU4oNikgfSwKKwl9OworI3VuZGVmIGN0eF9mbGV4ZXVOCisJc3RydWN0IGludGVsX2VuZ2luZV9j
cyAqZW5naW5lOwogCXN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICpjdHg7Ci0Jc3RydWN0IGk5MTVf
cmVxdWVzdCAqcnE7Ci0JaW50IHJldDsKKwllbnVtIGludGVsX2VuZ2luZV9pZCBpZDsKKwlpbnQg
ZXJyOworCWludCBpOwogCi0JbG9ja2RlcF9hc3NlcnRfaGVsZCgmZGV2X3ByaXYtPmRybS5zdHJ1
Y3RfbXV0ZXgpOworCWZvciAoaSA9IDI7IGkgPCBBUlJBWV9TSVpFKHJlZ3MpOyBpKyspCisJCXJl
Z3NbaV0udmFsdWUgPSBvYV9jb25maWdfZmxleF9yZWcob2FfY29uZmlnLCByZWdzW2ldLnJlZyk7
CisKKwlsb2NrZGVwX2Fzc2VydF9oZWxkKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKIAogCS8q
CiAJICogVGhlIE9BIHJlZ2lzdGVyIGNvbmZpZyBpcyBzZXR1cCB0aHJvdWdoIHRoZSBjb250ZXh0
IGltYWdlLiBUaGlzIGltYWdlCkBAIC0xNzQyLDU4ICsxODcyLDYzIEBAIHN0YXRpYyBpbnQgZ2Vu
OF9jb25maWd1cmVfYWxsX2NvbnRleHRzKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJp
diwKIAkgKiB0aGlzIG1pZ2h0IGxlYXZlIHNtYWxsIGludGVydmFsIG9mIHRpbWUgd2hlcmUgdGhl
IE9BIHVuaXQgaXMKIAkgKiBjb25maWd1cmVkIGF0IGFuIGludmFsaWQgc2FtcGxpbmcgcGVyaW9k
LgogCSAqCi0JICogU28gZmFyIHRoZSBiZXN0IHdheSB0byB3b3JrIGFyb3VuZCB0aGlzIGlzc3Vl
IHNlZW1zIHRvIGJlIGRyYWluaW5nCi0JICogdGhlIEdQVSBmcm9tIGFueSBzdWJtaXR0ZWQgd29y
ay4KKwkgKiBOb3RlIHRoYXQgc2luY2Ugd2UgZW1pdCBhbGwgcmVxdWVzdHMgZnJvbSBhIHNpbmds
ZSByaW5nLCB0aGVyZQorCSAqIGlzIHN0aWxsIGFuIGltcGxpY2l0IGdsb2JhbCBiYXJyaWVyIGhl
cmUgdGhhdCBtYXkgY2F1c2UgYSBoaWdoCisJICogcHJpb3JpdHkgY29udGV4dCB0byB3YWl0IGZv
ciBhbiBvdGhlcndpc2UgaW5kZXBlbmRlbnQgbG93IHByaW9yaXR5CisJICogY29udGV4dC4gQ29u
dGV4dHMgaWRsZSBhdCB0aGUgdGltZSBvZiByZWNvbmZpZ3VyYXRpb24gYXJlIG5vdAorCSAqIHRy
YXBwZWQgYmVoaW5kIHRoZSBiYXJyaWVyLgogCSAqLwotCXJldCA9IGk5MTVfZ2VtX3dhaXRfZm9y
X2lkbGUoZGV2X3ByaXYsCi0JCQkJICAgICBJOTE1X1dBSVRfTE9DS0VELAotCQkJCSAgICAgTUFY
X1NDSEVEVUxFX1RJTUVPVVQpOwotCWlmIChyZXQpCi0JCXJldHVybiByZXQ7Ci0KLQkvKiBVcGRh
dGUgYWxsIGNvbnRleHRzIG5vdyB0aGF0IHdlJ3ZlIHN0YWxsZWQgdGhlIHN1Ym1pc3Npb24uICov
Ci0JbGlzdF9mb3JfZWFjaF9lbnRyeShjdHgsICZkZXZfcHJpdi0+Y29udGV4dHMubGlzdCwgbGlu
aykgeworCWxpc3RfZm9yX2VhY2hfZW50cnkoY3R4LCAmaTkxNS0+Y29udGV4dHMubGlzdCwgbGlu
aykgewogCQlzdHJ1Y3QgaTkxNV9nZW1fZW5naW5lc19pdGVyIGl0OwogCQlzdHJ1Y3QgaW50ZWxf
Y29udGV4dCAqY2U7CiAKKwkJaWYgKGN0eCA9PSBpOTE1LT5rZXJuZWxfY29udGV4dCkKKwkJCWNv
bnRpbnVlOworCiAJCWZvcl9lYWNoX2dlbV9lbmdpbmUoY2UsCiAJCQkJICAgIGk5MTVfZ2VtX2Nv
bnRleHRfbG9ja19lbmdpbmVzKGN0eCksCiAJCQkJICAgIGl0KSB7Ci0JCQl1MzIgKnJlZ3M7CisJ
CQlHRU1fQlVHX09OKGNlID09IGNlLT5lbmdpbmUtPmtlcm5lbF9jb250ZXh0KTsKIAogCQkJaWYg
KGNlLT5lbmdpbmUtPmNsYXNzICE9IFJFTkRFUl9DTEFTUykKIAkJCQljb250aW51ZTsKIAotCQkJ
LyogT0Egc2V0dGluZ3Mgd2lsbCBiZSBzZXQgdXBvbiBmaXJzdCB1c2UgKi8KLQkJCWlmICghY2Ut
PnN0YXRlKQotCQkJCWNvbnRpbnVlOwotCi0JCQlyZWdzID0gaTkxNV9nZW1fb2JqZWN0X3Bpbl9t
YXAoY2UtPnN0YXRlLT5vYmosCi0JCQkJCQkgICAgICAgbWFwX3R5cGUpOwotCQkJaWYgKElTX0VS
UihyZWdzKSkgewotCQkJCWk5MTVfZ2VtX2NvbnRleHRfdW5sb2NrX2VuZ2luZXMoY3R4KTsKLQkJ
CQlyZXR1cm4gUFRSX0VSUihyZWdzKTsKLQkJCX0KKwkJCWVyciA9IGludGVsX2NvbnRleHRfbG9j
a19waW5uZWQoY2UpOworCQkJaWYgKGVycikKKwkJCQlicmVhazsKIAotCQkJY2UtPnN0YXRlLT5v
YmotPm1tLmRpcnR5ID0gdHJ1ZTsKLQkJCXJlZ3MgKz0gTFJDX1NUQVRFX1BOICogUEFHRV9TSVpF
IC8gc2l6ZW9mKCpyZWdzKTsKKwkJCXJlZ3NbMF0udmFsdWUgPSBpbnRlbF9zc2V1X21ha2VfcnBj
cyhpOTE1LCAmY2UtPnNzZXUpOwogCi0JCQlnZW44X3VwZGF0ZV9yZWdfc3RhdGVfdW5sb2NrZWQo
Y2UsIHJlZ3MsIG9hX2NvbmZpZyk7CisJCQkvKiBPdGhlcndpc2UgT0Egc2V0dGluZ3Mgd2lsbCBi
ZSBzZXQgdXBvbiBmaXJzdCB1c2UgKi8KKwkJCWlmIChpbnRlbF9jb250ZXh0X2lzX3Bpbm5lZChj
ZSkpCisJCQkJZXJyID0gZ2VuOF9tb2RpZnlfY29udGV4dChjZSwgcmVncywgQVJSQVlfU0laRShy
ZWdzKSk7CiAKLQkJCWk5MTVfZ2VtX29iamVjdF91bnBpbl9tYXAoY2UtPnN0YXRlLT5vYmopOwor
CQkJaW50ZWxfY29udGV4dF91bmxvY2tfcGlubmVkKGNlKTsKKwkJCWlmIChlcnIpCisJCQkJYnJl
YWs7CiAJCX0KIAkJaTkxNV9nZW1fY29udGV4dF91bmxvY2tfZW5naW5lcyhjdHgpOworCQlpZiAo
ZXJyKQorCQkJcmV0dXJuIGVycjsKIAl9CiAKIAkvKgotCSAqIEFwcGx5IHRoZSBjb25maWd1cmF0
aW9uIGJ5IGRvaW5nIG9uZSBjb250ZXh0IHJlc3RvcmUgb2YgdGhlIGVkaXRlZAotCSAqIGNvbnRl
eHQgaW1hZ2UuCisJICogQWZ0ZXIgdXBkYXRpbmcgYWxsIG90aGVyIGNvbnRleHRzLCB3ZSBuZWVk
IHRvIG1vZGlmeSBvdXJzZWx2ZXMuCisJICogSWYgd2UgZG9uJ3QgbW9kaWZ5IHRoZSBrZXJuZWxf
Y29udGV4dCwgd2UgZG8gbm90IGdldCBldmVudHMgd2hpbGUKKwkgKiBpZGxlLgogCSAqLwotCXJx
ID0gaTkxNV9yZXF1ZXN0X2NyZWF0ZShkZXZfcHJpdi0+ZW5naW5lW1JDUzBdLT5rZXJuZWxfY29u
dGV4dCk7Ci0JaWYgKElTX0VSUihycSkpCi0JCXJldHVybiBQVFJfRVJSKHJxKTsKKwlmb3JfZWFj
aF9lbmdpbmUoZW5naW5lLCBpOTE1LCBpZCkgeworCQlzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2Ug
PSBlbmdpbmUtPmtlcm5lbF9jb250ZXh0OwogCi0JaTkxNV9yZXF1ZXN0X2FkZChycSk7CisJCWlm
IChlbmdpbmUtPmNsYXNzICE9IFJFTkRFUl9DTEFTUykKKwkJCWNvbnRpbnVlOworCisJCXJlZ3Nb
MF0udmFsdWUgPSBpbnRlbF9zc2V1X21ha2VfcnBjcyhpOTE1LCAmY2UtPnNzZXUpOworCisJCWVy
ciA9IGdlbjhfbW9kaWZ5X3NlbGYoY2UsIHJlZ3MsIEFSUkFZX1NJWkUocmVncykpOworCQlpZiAo
ZXJyKQorCQkJcmV0dXJuIGVycjsKKwl9CiAKIAlyZXR1cm4gMDsKIH0KLS0gCjIuMjIuMAoKX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1h
aWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMu
ZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

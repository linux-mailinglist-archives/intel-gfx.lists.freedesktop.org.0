Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id DF25C38B2B1
	for <lists+intel-gfx@lfdr.de>; Thu, 20 May 2021 17:10:57 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 33C726F47C;
	Thu, 20 May 2021 15:10:43 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mga01.intel.com (mga01.intel.com [192.55.52.88])
 by gabe.freedesktop.org (Postfix) with ESMTPS id C3E426E1BE;
 Thu, 20 May 2021 15:10:39 +0000 (UTC)
IronPort-SDR: 7HoshW6DOFErz9cFHTLxYOp+Rx0iIquKU3adhUINbNau6KAB06Q7IgMjW8ZqZmAczzzCt+IrAg
 I71fouXp2EPg==
X-IronPort-AV: E=McAfee;i="6200,9189,9989"; a="222341217"
X-IronPort-AV: E=Sophos;i="5.82,313,1613462400"; d="scan'208";a="222341217"
Received: from orsmga006.jf.intel.com ([10.7.209.51])
 by fmsmga101.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 20 May 2021 08:10:08 -0700
IronPort-SDR: aOJ2IxW9vdZuz0XsnjVp4bFqTypiLEI3W44H9LMBAvmXCtTNdknCk4AAfLclx/A8ypexmjdk17
 HqeTPmGT9X1Q==
X-IronPort-AV: E=Sophos;i="5.82,313,1613462400"; d="scan'208";a="395728204"
Received: from cbjoerns-mobl1.ger.corp.intel.com (HELO
 thellst-mobl1.intel.com) ([10.249.254.247])
 by orsmga006-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 20 May 2021 08:10:06 -0700
From: =?UTF-8?q?Thomas=20Hellstr=C3=B6m?= <thomas.hellstrom@linux.intel.com>
To: intel-gfx@lists.freedesktop.org,
	dri-devel@lists.freedesktop.org
Date: Thu, 20 May 2021 17:09:47 +0200
Message-Id: <20210520150947.803891-6-thomas.hellstrom@linux.intel.com>
X-Mailer: git-send-email 2.31.1
In-Reply-To: <20210520150947.803891-1-thomas.hellstrom@linux.intel.com>
References: <20210520150947.803891-1-thomas.hellstrom@linux.intel.com>
MIME-Version: 1.0
Subject: [Intel-gfx] [RFC PATCH 5/5] drm/ttm,
 drm/amdgpu: Allow the driver some control over swapping
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: =?UTF-8?q?Thomas=20Hellstr=C3=B6m?= <thomas.hellstrom@linux.intel.com>,
 =?UTF-8?q?Christian=20K=C3=B6nig?= <christian.koenig@amd.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

V2UgYXJlIGNhbGxpbmcgdGhlIGV2aWN0aW9uX3ZhbHVhYmxlIGRyaXZlciBjYWxsYmFjayBhdCBl
dmljdGlvbiB0aW1lIHRvCmRldGVybWluZSB3aGV0aGVyIHdlIGFjdHVhbGx5IGNhbiBldmljdCBh
IGJ1ZmZlciBvYmplY3QuClRoZSB1cGNvbWluZyBpOTE1IFRUTSBiYWNrZW5kIG5lZWRzIHRoZSBz
YW1lIGZ1bmN0aW9uYWxpdHkgZm9yIHN3YXBvdXQsCmFuZCB0aGF0IG1pZ2h0IGFjdHVhbGx5IGJl
IGJlbmVmaWNpYWwgdG8gb3RoZXIgZHJpdmVycyBhcyB3ZWxsLgoKQWRkIGFuIGV2aWN0aW9uX3Zh
bHVhYmxlIGNhbGwgYWxzbyBpbiB0aGUgc3dhcG91dCBwYXRoLiBUcnkgdG8ga2VlcCB0aGUKY3Vy
cmVudCBiZWhhdmlvdXIgZm9yIGFsbCBkcml2ZXJzIGJ5IHJldHVybmluZyB0cnVlIGlmIHRoZSBi
dWZmZXIgb2JqZWN0CmlzIGFscmVhZHkgaW4gdGhlIFRUTV9QTF9TWVNURU0gcGxhY2VtZW50LiBX
ZSBjaGFuZ2UgYmVoYXZpb3VyIGZvciB0aGUKY2FzZSB3aGVyZSBhIGJ1ZmZlciBvYmplY3QgaXMg
aW4gYSBUVCBiYWNrZWQgcGxhY2VtZW50IHdoZW4gc3dhcHBlZCBvdXQsCmluIHdoaWNoIGNhc2Ug
dGhlIGRyaXZlcnMgbm9ybWFsIGV2aWN0aW9uX3ZhbHVhYmxlIHBhdGggaXMgcnVuLgoKRmluYWxs
eSBtYWtlIHN1cmUgd2UgZG9uJ3QgdHJ5IHRvIHN3YXBvdXQgYSBibyB0aGF0IHdhcyByZWNlbnRs
eSBwdXJnZWQKYW5kIHRoZXJlZm9yZSB1bnBvcHVsYXRlZC4KCkNjOiBDaHJpc3RpYW4gS8O2bmln
IDxjaHJpc3RpYW4ua29lbmlnQGFtZC5jb20+ClNpZ25lZC1vZmYtYnk6IFRob21hcyBIZWxsc3Ry
w7ZtIDx0aG9tYXMuaGVsbHN0cm9tQGxpbnV4LmludGVsLmNvbT4KLS0tCiBkcml2ZXJzL2dwdS9k
cm0vYW1kL2FtZGdwdS9hbWRncHVfdHRtLmMgfCAgNCArKysKIGRyaXZlcnMvZ3B1L2RybS90dG0v
dHRtX2JvLmMgICAgICAgICAgICB8IDQxICsrKysrKysrKysrKysrKy0tLS0tLS0tLS0KIGRyaXZl
cnMvZ3B1L2RybS90dG0vdHRtX3R0LmMgICAgICAgICAgICB8ICA0ICsrKwogMyBmaWxlcyBjaGFu
Z2VkLCAzMyBpbnNlcnRpb25zKCspLCAxNiBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2
ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfdHRtLmMgYi9kcml2ZXJzL2dwdS9kcm0vYW1k
L2FtZGdwdS9hbWRncHVfdHRtLmMKaW5kZXggOGM3ZWMwOWViMWE0Li5kNWE5ZDdhODgzMTUgMTAw
NjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9hbWQvYW1kZ3B1L2FtZGdwdV90dG0uYworKysgYi9k
cml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfdHRtLmMKQEAgLTEzOTksNiArMTM5OSwx
MCBAQCBzdGF0aWMgYm9vbCBhbWRncHVfdHRtX2JvX2V2aWN0aW9uX3ZhbHVhYmxlKHN0cnVjdCB0
dG1fYnVmZmVyX29iamVjdCAqYm8sCiAJc3RydWN0IGRtYV9mZW5jZSAqZjsKIAlpbnQgaTsKIAor
CS8qIFN3YXBvdXQ/ICovCisJaWYgKGJvLT5tZW0ubWVtX3R5cGUgPT0gVFRNX1BMX1NZU1RFTSkK
KwkJcmV0dXJuIHRydWU7CisKIAlpZiAoYm8tPnR5cGUgPT0gdHRtX2JvX3R5cGVfa2VybmVsICYm
CiAJICAgICFhbWRncHVfdm1fZXZpY3RhYmxlKHR0bV90b19hbWRncHVfYm8oYm8pKSkKIAkJcmV0
dXJuIGZhbHNlOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL3R0bS90dG1fYm8uYyBiL2Ry
aXZlcnMvZ3B1L2RybS90dG0vdHRtX2JvLmMKaW5kZXggYThmYTMzNzViOGFhLi4zZjdjNjRhMWNk
YTEgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS90dG0vdHRtX2JvLmMKKysrIGIvZHJpdmVy
cy9ncHUvZHJtL3R0bS90dG1fYm8uYwpAQCAtNTM2LDYgKzUzNiwxMCBAQCBzdGF0aWMgaW50IHR0
bV9ib19ldmljdChzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJvLAogYm9vbCB0dG1fYm9fZXZp
Y3Rpb25fdmFsdWFibGUoc3RydWN0IHR0bV9idWZmZXJfb2JqZWN0ICpibywKIAkJCSAgICAgIGNv
bnN0IHN0cnVjdCB0dG1fcGxhY2UgKnBsYWNlKQogeworCWRtYV9yZXN2X2Fzc2VydF9oZWxkKGJv
LT5iYXNlLnJlc3YpOworCWlmIChiby0+bWVtLm1lbV90eXBlID09IFRUTV9QTF9TWVNURU0pCisJ
CXJldHVybiB0cnVlOworCiAJLyogRG9uJ3QgZXZpY3QgdGhpcyBCTyBpZiBpdCdzIG91dHNpZGUg
b2YgdGhlCiAJICogcmVxdWVzdGVkIHBsYWNlbWVudCByYW5nZQogCSAqLwpAQCAtNTU4LDcgKzU2
Miw5IEBAIEVYUE9SVF9TWU1CT0wodHRtX2JvX2V2aWN0aW9uX3ZhbHVhYmxlKTsKICAqIGIuIE90
aGVyd2lzZSwgdHJ5bG9jayBpdC4KICAqLwogc3RhdGljIGJvb2wgdHRtX2JvX2V2aWN0X3N3YXBv
dXRfYWxsb3dhYmxlKHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8sCi0JCQlzdHJ1Y3QgdHRt
X29wZXJhdGlvbl9jdHggKmN0eCwgYm9vbCAqbG9ja2VkLCBib29sICpidXN5KQorCQkJCQkgICBz
dHJ1Y3QgdHRtX29wZXJhdGlvbl9jdHggKmN0eCwKKwkJCQkJICAgY29uc3Qgc3RydWN0IHR0bV9w
bGFjZSAqcGxhY2UsCisJCQkJCSAgIGJvb2wgKmxvY2tlZCwgYm9vbCAqYnVzeSkKIHsKIAlib29s
IHJldCA9IGZhbHNlOwogCkBAIC01NzYsNiArNTgyLDEyIEBAIHN0YXRpYyBib29sIHR0bV9ib19l
dmljdF9zd2Fwb3V0X2FsbG93YWJsZShzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJvLAogCQkJ
KmJ1c3kgPSAhcmV0OwogCX0KIAorCWlmIChyZXQgJiYgcGxhY2UgJiYgIWJvLT5iZGV2LT5mdW5j
cy0+ZXZpY3Rpb25fdmFsdWFibGUoYm8sIHBsYWNlKSkgeworCQlyZXQgPSBmYWxzZTsKKwkJaWYg
KGxvY2tlZCkKKwkJCWRtYV9yZXN2X3VubG9jayhiby0+YmFzZS5yZXN2KTsKKwl9CisKIAlyZXR1
cm4gcmV0OwogfQogCkBAIC02MzAsMjAgKzY0MiwxNCBAQCBpbnQgdHRtX21lbV9ldmljdF9maXJz
dChzdHJ1Y3QgdHRtX2RldmljZSAqYmRldiwKIAkJbGlzdF9mb3JfZWFjaF9lbnRyeShibywgJm1h
bi0+bHJ1W2ldLCBscnUpIHsKIAkJCWJvb2wgYnVzeTsKIAotCQkJaWYgKCF0dG1fYm9fZXZpY3Rf
c3dhcG91dF9hbGxvd2FibGUoYm8sIGN0eCwgJmxvY2tlZCwKLQkJCQkJCQkgICAgJmJ1c3kpKSB7
CisJCQlpZiAoIXR0bV9ib19ldmljdF9zd2Fwb3V0X2FsbG93YWJsZShibywgY3R4LCBwbGFjZSwK
KwkJCQkJCQkgICAgJmxvY2tlZCwgJmJ1c3kpKSB7CiAJCQkJaWYgKGJ1c3kgJiYgIWJ1c3lfYm8g
JiYgdGlja2V0ICE9CiAJCQkJICAgIGRtYV9yZXN2X2xvY2tpbmdfY3R4KGJvLT5iYXNlLnJlc3Yp
KQogCQkJCQlidXN5X2JvID0gYm87CiAJCQkJY29udGludWU7CiAJCQl9CiAKLQkJCWlmIChwbGFj
ZSAmJiAhYmRldi0+ZnVuY3MtPmV2aWN0aW9uX3ZhbHVhYmxlKGJvLAotCQkJCQkJCQkgICAgICBw
bGFjZSkpIHsKLQkJCQlpZiAobG9ja2VkKQotCQkJCQlkbWFfcmVzdl91bmxvY2soYm8tPmJhc2Uu
cmVzdik7Ci0JCQkJY29udGludWU7Ci0JCQl9CiAJCQlpZiAoIXR0bV9ib19nZXRfdW5sZXNzX3pl
cm8oYm8pKSB7CiAJCQkJaWYgKGxvY2tlZCkKIAkJCQkJZG1hX3Jlc3ZfdW5sb2NrKGJvLT5iYXNl
LnJlc3YpOwpAQCAtMTEzOCwxMCArMTE0NCwxOCBAQCBFWFBPUlRfU1lNQk9MKHR0bV9ib193YWl0
KTsKIGludCB0dG1fYm9fc3dhcG91dChzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJvLCBzdHJ1
Y3QgdHRtX29wZXJhdGlvbl9jdHggKmN0eCwKIAkJICAgZ2ZwX3QgZ2ZwX2ZsYWdzKQogeworCXN0
cnVjdCB0dG1fcGxhY2UgcGxhY2UgPSB7fTsKIAlib29sIGxvY2tlZDsKIAlpbnQgcmV0OwogCi0J
aWYgKCF0dG1fYm9fZXZpY3Rfc3dhcG91dF9hbGxvd2FibGUoYm8sIGN0eCwgJmxvY2tlZCwgTlVM
TCkpCisJLyoKKwkgKiBXaGlsZSB0aGUgYm8gbWF5IGFscmVhZHkgcmVzaWRlIGluIFNZU1RFTSBw
bGFjZW1lbnQsIHNldAorCSAqIFNZU1RFTSBhcyBuZXcgcGxhY2VtZW50IHRvIGNvdmVyIGFsc28g
dGhlIG1vdmUgZnVydGhlciBiZWxvdy4KKwkgKiBUaGUgZHJpdmVyIG1heSB1c2UgdGhlIGZhY3Qg
dGhhdCB3ZSdyZSBtb3ZpbmcgZnJvbSBTWVNURU0KKwkgKiBhcyBhbiBpbmRpY2F0aW9uIHRoYXQg
d2UncmUgYWJvdXQgdG8gc3dhcCBvdXQuCisJICovCisJcGxhY2UubWVtX3R5cGUgPSBUVE1fUExf
U1lTVEVNOworCWlmICghdHRtX2JvX2V2aWN0X3N3YXBvdXRfYWxsb3dhYmxlKGJvLCBjdHgsICZw
bGFjZSwgJmxvY2tlZCwgTlVMTCkpCiAJCXJldHVybiAtRUJVU1k7CiAKIAlpZiAoIXR0bV9ib19n
ZXRfdW5sZXNzX3plcm8oYm8pKSB7CkBAIC0xMTY2LDEyICsxMTgwLDcgQEAgaW50IHR0bV9ib19z
d2Fwb3V0KHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8sIHN0cnVjdCB0dG1fb3BlcmF0aW9u
X2N0eCAqY3R4LAogCWlmIChiby0+bWVtLm1lbV90eXBlICE9IFRUTV9QTF9TWVNURU0pIHsKIAkJ
c3RydWN0IHR0bV9vcGVyYXRpb25fY3R4IGN0eCA9IHsgZmFsc2UsIGZhbHNlIH07CiAJCXN0cnVj
dCB0dG1fcmVzb3VyY2UgZXZpY3RfbWVtOwotCQlzdHJ1Y3QgdHRtX3BsYWNlIHBsYWNlLCBob3A7
Ci0KLQkJbWVtc2V0KCZwbGFjZSwgMCwgc2l6ZW9mKHBsYWNlKSk7Ci0JCW1lbXNldCgmaG9wLCAw
LCBzaXplb2YoaG9wKSk7Ci0KLQkJcGxhY2UubWVtX3R5cGUgPSBUVE1fUExfU1lTVEVNOworCQlz
dHJ1Y3QgdHRtX3BsYWNlIGhvcCA9IHt9OwogCiAJCXJldCA9IHR0bV9yZXNvdXJjZV9hbGxvYyhi
bywgJnBsYWNlLCAmZXZpY3RfbWVtKTsKIAkJaWYgKHVubGlrZWx5KHJldCkpCmRpZmYgLS1naXQg
YS9kcml2ZXJzL2dwdS9kcm0vdHRtL3R0bV90dC5jIGIvZHJpdmVycy9ncHUvZHJtL3R0bS90dG1f
dHQuYwppbmRleCAwYjEwNTNlOTNkYjIuLmQ0NmM3MDJjZTBjYSAxMDA2NDQKLS0tIGEvZHJpdmVy
cy9ncHUvZHJtL3R0bS90dG1fdHQuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vdHRtL3R0bV90dC5j
CkBAIC0yNjMsNiArMjYzLDkgQEAgaW50IHR0bV90dF9zd2Fwb3V0KHN0cnVjdCB0dG1fZGV2aWNl
ICpiZGV2LCBzdHJ1Y3QgdHRtX3R0ICp0dG0sCiAJc3RydWN0IHBhZ2UgKnRvX3BhZ2U7CiAJaW50
IGksIHJldDsKIAorCWlmICghdHRtX3R0X2lzX3BvcHVsYXRlZCh0dG0pKQorCQlyZXR1cm4gMDsK
KwogCXN3YXBfc3RvcmFnZSA9IHNobWVtX2ZpbGVfc2V0dXAoInR0bSBzd2FwIiwgc2l6ZSwgMCk7
CiAJaWYgKElTX0VSUihzd2FwX3N0b3JhZ2UpKSB7CiAJCXByX2VycigiRmFpbGVkIGFsbG9jYXRp
bmcgc3dhcCBzdG9yYWdlXG4iKTsKQEAgLTQwNCw2ICs0MDcsNyBAQCB2b2lkIHR0bV90dF91bnBv
cHVsYXRlKHN0cnVjdCB0dG1fZGV2aWNlICpiZGV2LCBzdHJ1Y3QgdHRtX3R0ICp0dG0pCiAKIAl0
dG0tPnBhZ2VfZmxhZ3MgJj0gflRUTV9QQUdFX0ZMQUdfUFJJVl9QT1BVTEFURUQ7CiB9CitFWFBP
UlRfU1lNQk9MKHR0bV90dF91bnBvcHVsYXRlKTsKIAogI2lmZGVmIENPTkZJR19ERUJVR19GUwog
Ci0tIAoyLjMxLjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9y
ZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWdm
eAo=

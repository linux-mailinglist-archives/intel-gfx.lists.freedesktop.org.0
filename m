Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 5A63363660
	for <lists+intel-gfx@lfdr.de>; Tue,  9 Jul 2019 15:03:34 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 4FD0289996;
	Tue,  9 Jul 2019 13:03:32 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id E9EBB89996
 for <intel-gfx@lists.freedesktop.org>; Tue,  9 Jul 2019 13:03:30 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17185012-1500050 
 for multiple; Tue, 09 Jul 2019 14:03:06 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Tue,  9 Jul 2019 14:03:03 +0100
Message-Id: <20190709130303.27990-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.22.0
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH] drm/i915: Lock the engine while dumping the
 active request
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Alex Shumsky <alexthreed@gmail.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

V2UgY2Fubm90IGxldCB0aGUgcmVxdWVzdCBiZSByZXRpcmVkIGFuZCBmcmVlZCB3aGlsZSB3ZSBh
cmUgdHJ5aW5nIHRvCmR1bXAgaXQgZHVyaW5nIGVycm9yIGNhcHR1cmUuIEl0IGlzIG5vdCBzdWZm
aWNpZW50IGp1c3QgdG8gZ3JhYiBhCnJlZmVyZW5jZSB0byB0aGUgcmVxdWVzdCwgYXMgZHVyaW5n
IHJldGlyZW1lbnQgd2UgbWF5IGZyZWUgdGhlIHJpbmcKd2hpY2ggd2UgYXJlIGFsc28gZHVtcGlu
Zy4gU28gdGFrZSB0aGUgZW5naW5lIGxvY2sgdG8gcHJldmVudCByZXRpcmluZwphbmQgZnJlZWlu
ZyBvZiB0aGUgcmVxdWVzdC4KClJlcG9ydGVkLWJ5OiBBbGV4IFNodW1za3kgPGFsZXh0aHJlZWRA
Z21haWwuY29tPgpGaXhlczogODNjMzE3ODMyZWIxICgiZHJtL2k5MTU6IER1bXAgdGhlIHJpbmdi
dWZmZXIgb2YgdGhlIGFjdGl2ZSByZXF1ZXN0IGZvciBkZWJ1Z2dpbmciKQpTaWduZWQtb2ZmLWJ5
OiBDaHJpcyBXaWxzb24gPGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KQ2M6IFR2cnRrbyBVcnN1
bGluIDx0dnJ0a28udXJzdWxpbkBpbnRlbC5jb20+CkNjOiBKb29uYXMgTGFodGluZW4gPGpvb25h
cy5sYWh0aW5lbkBsaW51eC5pbnRlbC5jb20+CkNjOiBBbGV4IFNodW1za3kgPGFsZXh0aHJlZWRA
Z21haWwuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZV9jcy5j
IHwgNTEgKysrKysrKysrKysrLS0tLS0tLS0tLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVf
Z3B1X2Vycm9yLmMgICAgIHwgIDYgKystCiAyIGZpbGVzIGNoYW5nZWQsIDMwIGluc2VydGlvbnMo
KyksIDI3IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0
L2ludGVsX2VuZ2luZV9jcy5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZW5naW5l
X2NzLmMKaW5kZXggYmRmMjc5ZmEzYjJlLi44ZWUyZGQ0MjM2NzQgMTAwNjQ0Ci0tLSBhL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZV9jcy5jCisrKyBiL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2d0L2ludGVsX2VuZ2luZV9jcy5jCkBAIC0xNDQ0LDkgKzE0NDQsMTEgQEAgc3RhdGlj
IHZvaWQgaW50ZWxfZW5naW5lX3ByaW50X3JlZ2lzdGVycyhzdHJ1Y3QgaW50ZWxfZW5naW5lX2Nz
ICplbmdpbmUsCiAJfQogfQogCi1zdGF0aWMgdm9pZCBwcmludF9yZXF1ZXN0X3Jpbmcoc3RydWN0
IGRybV9wcmludGVyICptLCBzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSkKK3N0YXRpYyB2b2lkIHBy
aW50X3JlcXVlc3RfcmluZyhzdHJ1Y3QgZHJtX3ByaW50ZXIgKm0sCisJCQkgICAgICAgY29uc3Qg
c3RydWN0IGk5MTVfcmVxdWVzdCAqcnEsCisJCQkgICAgICAgY29uc3Qgc3RydWN0IGludGVsX3Jp
bmcgKnJpbmcpCiB7Ci0Jdm9pZCAqcmluZzsKKwl2b2lkICpidWY7CiAJaW50IHNpemU7CiAKIAlk
cm1fcHJpbnRmKG0sCkBAIC0xNDU3LDIzICsxNDU5LDIzIEBAIHN0YXRpYyB2b2lkIHByaW50X3Jl
cXVlc3RfcmluZyhzdHJ1Y3QgZHJtX3ByaW50ZXIgKm0sIHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJx
KQogCiAJc2l6ZSA9IHJxLT50YWlsIC0gcnEtPmhlYWQ7CiAJaWYgKHJxLT50YWlsIDwgcnEtPmhl
YWQpCi0JCXNpemUgKz0gcnEtPnJpbmctPnNpemU7CisJCXNpemUgKz0gcmluZy0+c2l6ZTsKIAot
CXJpbmcgPSBrbWFsbG9jKHNpemUsIEdGUF9BVE9NSUMpOwotCWlmIChyaW5nKSB7Ci0JCWNvbnN0
IHZvaWQgKnZhZGRyID0gcnEtPnJpbmctPnZhZGRyOworCWJ1ZiA9IGttYWxsb2Moc2l6ZSwgR0ZQ
X0FUT01JQyk7CisJaWYgKGJ1ZikgeworCQljb25zdCB2b2lkICp2YWRkciA9IHJpbmctPnZhZGRy
OwogCQl1bnNpZ25lZCBpbnQgaGVhZCA9IHJxLT5oZWFkOwogCQl1bnNpZ25lZCBpbnQgbGVuID0g
MDsKIAogCQlpZiAocnEtPnRhaWwgPCBoZWFkKSB7Ci0JCQlsZW4gPSBycS0+cmluZy0+c2l6ZSAt
IGhlYWQ7Ci0JCQltZW1jcHkocmluZywgdmFkZHIgKyBoZWFkLCBsZW4pOworCQkJbGVuID0gcmlu
Zy0+c2l6ZSAtIGhlYWQ7CisJCQltZW1jcHkoYnVmLCB2YWRkciArIGhlYWQsIGxlbik7CiAJCQlo
ZWFkID0gMDsKIAkJfQotCQltZW1jcHkocmluZyArIGxlbiwgdmFkZHIgKyBoZWFkLCBzaXplIC0g
bGVuKTsKKwkJbWVtY3B5KGJ1ZiArIGxlbiwgdmFkZHIgKyBoZWFkLCBzaXplIC0gbGVuKTsKIAot
CQloZXhkdW1wKG0sIHJpbmcsIHNpemUpOwotCQlrZnJlZShyaW5nKTsKKwkJaGV4ZHVtcChtLCBi
dWYsIHNpemUpOworCQlrZnJlZShidWYpOwogCX0KIH0KIApAQCAtMTQ4NCw2ICsxNDg2LDcgQEAg
dm9pZCBpbnRlbF9lbmdpbmVfZHVtcChzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUsCiAJ
c3RydWN0IGk5MTVfZ3B1X2Vycm9yICogY29uc3QgZXJyb3IgPSAmZW5naW5lLT5pOTE1LT5ncHVf
ZXJyb3I7CiAJc3RydWN0IGk5MTVfcmVxdWVzdCAqcnE7CiAJaW50ZWxfd2FrZXJlZl90IHdha2Vy
ZWY7CisJdW5zaWduZWQgbG9uZyBmbGFnczsKIAogCWlmIChoZWFkZXIpIHsKIAkJdmFfbGlzdCBh
cDsKQEAgLTE1MDMsMzEgKzE1MDYsMzEgQEAgdm9pZCBpbnRlbF9lbmdpbmVfZHVtcChzdHJ1Y3Qg
aW50ZWxfZW5naW5lX2NzICplbmdpbmUsCiAJCSAgIGk5MTVfcmVzZXRfZW5naW5lX2NvdW50KGVy
cm9yLCBlbmdpbmUpLAogCQkgICBpOTE1X3Jlc2V0X2NvdW50KGVycm9yKSk7CiAKLQlyY3VfcmVh
ZF9sb2NrKCk7Ci0KIAlkcm1fcHJpbnRmKG0sICJcdFJlcXVlc3RzOlxuIik7CiAKKwlzcGluX2xv
Y2tfaXJxc2F2ZSgmZW5naW5lLT5hY3RpdmUubG9jaywgZmxhZ3MpOwogCXJxID0gaW50ZWxfZW5n
aW5lX2ZpbmRfYWN0aXZlX3JlcXVlc3QoZW5naW5lKTsKIAlpZiAocnEpIHsKKwkJc3RydWN0IGlu
dGVsX3JpbmcgKnJpbmcgPSBycS0+cmluZzsKKwogCQlwcmludF9yZXF1ZXN0KG0sIHJxLCAiXHRc
dGFjdGl2ZSAiKTsKIAogCQlkcm1fcHJpbnRmKG0sICJcdFx0cmluZy0+c3RhcnQ6ICAweCUwOHhc
biIsCi0JCQkgICBpOTE1X2dndHRfb2Zmc2V0KHJxLT5yaW5nLT52bWEpKTsKKwkJCSAgIGk5MTVf
Z2d0dF9vZmZzZXQocmluZy0+dm1hKSk7CiAJCWRybV9wcmludGYobSwgIlx0XHRyaW5nLT5oZWFk
OiAgIDB4JTA4eFxuIiwKLQkJCSAgIHJxLT5yaW5nLT5oZWFkKTsKKwkJCSAgIHJpbmctPmhlYWQp
OwogCQlkcm1fcHJpbnRmKG0sICJcdFx0cmluZy0+dGFpbDogICAweCUwOHhcbiIsCi0JCQkgICBy
cS0+cmluZy0+dGFpbCk7CisJCQkgICByaW5nLT50YWlsKTsKIAkJZHJtX3ByaW50ZihtLCAiXHRc
dHJpbmctPmVtaXQ6ICAgMHglMDh4XG4iLAotCQkJICAgcnEtPnJpbmctPmVtaXQpOworCQkJICAg
cmluZy0+ZW1pdCk7CiAJCWRybV9wcmludGYobSwgIlx0XHRyaW5nLT5zcGFjZTogIDB4JTA4eFxu
IiwKLQkJCSAgIHJxLT5yaW5nLT5zcGFjZSk7CisJCQkgICByaW5nLT5zcGFjZSk7CiAJCWRybV9w
cmludGYobSwgIlx0XHRyaW5nLT5od3NwOiAgIDB4JTA4eFxuIiwKLQkJCSAgIHJxLT50aW1lbGlu
ZS0+aHdzcF9vZmZzZXQpOworCQkJICAgcmluZy0+dGltZWxpbmUtPmh3c3Bfb2Zmc2V0KTsKIAot
CQlwcmludF9yZXF1ZXN0X3JpbmcobSwgcnEpOworCQlwcmludF9yZXF1ZXN0X3JpbmcobSwgcnEs
IHJpbmcpOwogCX0KLQotCXJjdV9yZWFkX3VubG9jaygpOworCXNwaW5fdW5sb2NrX2lycXJlc3Rv
cmUoJmVuZ2luZS0+YWN0aXZlLmxvY2ssIGZsYWdzKTsKIAogCXdha2VyZWYgPSBpbnRlbF9ydW50
aW1lX3BtX2dldF9pZl9pbl91c2UoJmVuZ2luZS0+aTkxNS0+cnVudGltZV9wbSk7CiAJaWYgKHdh
a2VyZWYpIHsKQEAgLTE2ODksNyArMTY5Miw2IEBAIHN0cnVjdCBpOTE1X3JlcXVlc3QgKgogaW50
ZWxfZW5naW5lX2ZpbmRfYWN0aXZlX3JlcXVlc3Qoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5n
aW5lKQogewogCXN0cnVjdCBpOTE1X3JlcXVlc3QgKnJlcXVlc3QsICphY3RpdmUgPSBOVUxMOwot
CXVuc2lnbmVkIGxvbmcgZmxhZ3M7CiAKIAkvKgogCSAqIFdlIGFyZSBjYWxsZWQgYnkgdGhlIGVy
cm9yIGNhcHR1cmUsIHJlc2V0IGFuZCB0byBkdW1wIGVuZ2luZQpAQCAtMTcwMiw3ICsxNzA0LDcg
QEAgaW50ZWxfZW5naW5lX2ZpbmRfYWN0aXZlX3JlcXVlc3Qoc3RydWN0IGludGVsX2VuZ2luZV9j
cyAqZW5naW5lKQogCSAqIEF0IGFsbCBvdGhlciB0aW1lcywgd2UgbXVzdCBhc3N1bWUgdGhlIEdQ
VSBpcyBzdGlsbCBydW5uaW5nLCBidXQKIAkgKiB3ZSBvbmx5IGNhcmUgYWJvdXQgdGhlIHNuYXBz
aG90IG9mIHRoaXMgbW9tZW50LgogCSAqLwotCXNwaW5fbG9ja19pcnFzYXZlKCZlbmdpbmUtPmFj
dGl2ZS5sb2NrLCBmbGFncyk7CisJbG9ja2RlcF9hc3NlcnRfaGVsZCgmZW5naW5lLT5hY3RpdmUu
bG9jayk7CiAJbGlzdF9mb3JfZWFjaF9lbnRyeShyZXF1ZXN0LCAmZW5naW5lLT5hY3RpdmUucmVx
dWVzdHMsIHNjaGVkLmxpbmspIHsKIAkJaWYgKGk5MTVfcmVxdWVzdF9jb21wbGV0ZWQocmVxdWVz
dCkpCiAJCQljb250aW51ZTsKQEAgLTE3MTcsNyArMTcxOSw2IEBAIGludGVsX2VuZ2luZV9maW5k
X2FjdGl2ZV9yZXF1ZXN0KHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKIAkJYWN0aXZl
ID0gcmVxdWVzdDsKIAkJYnJlYWs7CiAJfQotCXNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJmVuZ2lu
ZS0+YWN0aXZlLmxvY2ssIGZsYWdzKTsKIAogCXJldHVybiBhY3RpdmU7CiB9CmRpZmYgLS1naXQg
YS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dwdV9lcnJvci5jIGIvZHJpdmVycy9ncHUvZHJt
L2k5MTUvaTkxNV9ncHVfZXJyb3IuYwppbmRleCA1NDg5Y2Q4NzkzMTUuLmYyOTdhNDNkZjFlOSAx
MDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9ncHVfZXJyb3IuYworKysgYi9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dwdV9lcnJvci5jCkBAIC0xNDExLDYgKzE0MTEsNyBA
QCBzdGF0aWMgdm9pZCBnZW1fcmVjb3JkX3JpbmdzKHN0cnVjdCBpOTE1X2dwdV9zdGF0ZSAqZXJy
b3IpCiAJCXN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSA9IGk5MTUtPmVuZ2luZVtpXTsK
IAkJc3RydWN0IGRybV9pOTE1X2Vycm9yX2VuZ2luZSAqZWUgPSAmZXJyb3ItPmVuZ2luZVtpXTsK
IAkJc3RydWN0IGk5MTVfcmVxdWVzdCAqcmVxdWVzdDsKKwkJdW5zaWduZWQgbG9uZyBmbGFnczsK
IAogCQllZS0+ZW5naW5lX2lkID0gLTE7CiAKQEAgLTE0MjIsMTAgKzE0MjMsMTEgQEAgc3RhdGlj
IHZvaWQgZ2VtX3JlY29yZF9yaW5ncyhzdHJ1Y3QgaTkxNV9ncHVfc3RhdGUgKmVycm9yKQogCQll
cnJvcl9yZWNvcmRfZW5naW5lX3JlZ2lzdGVycyhlcnJvciwgZW5naW5lLCBlZSk7CiAJCWVycm9y
X3JlY29yZF9lbmdpbmVfZXhlY2xpc3RzKGVuZ2luZSwgZWUpOwogCisJCXNwaW5fbG9ja19pcnFz
YXZlKCZlbmdpbmUtPmFjdGl2ZS5sb2NrLCBmbGFncyk7CiAJCXJlcXVlc3QgPSBpbnRlbF9lbmdp
bmVfZmluZF9hY3RpdmVfcmVxdWVzdChlbmdpbmUpOwogCQlpZiAocmVxdWVzdCkgewogCQkJc3Ry
dWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCA9IHJlcXVlc3QtPmdlbV9jb250ZXh0OwotCQkJc3Ry
dWN0IGludGVsX3JpbmcgKnJpbmc7CisJCQlzdHJ1Y3QgaW50ZWxfcmluZyAqcmluZyA9IHJlcXVl
c3QtPnJpbmc7CiAKIAkJCWVlLT52bSA9IGN0eC0+dm0gPzogJmVuZ2luZS0+Z3QtPmdndHQtPnZt
OwogCkBAIC0xNDU1LDcgKzE0NTcsNiBAQCBzdGF0aWMgdm9pZCBnZW1fcmVjb3JkX3JpbmdzKHN0
cnVjdCBpOTE1X2dwdV9zdGF0ZSAqZXJyb3IpCiAJCQllZS0+cnFfcG9zdCA9IHJlcXVlc3QtPnBv
c3RmaXg7CiAJCQllZS0+cnFfdGFpbCA9IHJlcXVlc3QtPnRhaWw7CiAKLQkJCXJpbmcgPSByZXF1
ZXN0LT5yaW5nOwogCQkJZWUtPmNwdV9yaW5nX2hlYWQgPSByaW5nLT5oZWFkOwogCQkJZWUtPmNw
dV9yaW5nX3RhaWwgPSByaW5nLT50YWlsOwogCQkJZWUtPnJpbmdidWZmZXIgPQpAQCAtMTQ2Myw2
ICsxNDY0LDcgQEAgc3RhdGljIHZvaWQgZ2VtX3JlY29yZF9yaW5ncyhzdHJ1Y3QgaTkxNV9ncHVf
c3RhdGUgKmVycm9yKQogCiAJCQllbmdpbmVfcmVjb3JkX3JlcXVlc3RzKGVuZ2luZSwgcmVxdWVz
dCwgZWUpOwogCQl9CisJCXNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJmVuZ2luZS0+YWN0aXZlLmxv
Y2ssIGZsYWdzKTsKIAogCQllZS0+aHdzX3BhZ2UgPQogCQkJaTkxNV9lcnJvcl9vYmplY3RfY3Jl
YXRlKGk5MTUsCi0tIAoyLjIyLjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVk
ZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZv
L2ludGVsLWdmeA==

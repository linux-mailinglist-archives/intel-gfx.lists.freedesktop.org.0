Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 809DF5703E
	for <lists+intel-gfx@lfdr.de>; Wed, 26 Jun 2019 20:04:19 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 03C9F6E4D7;
	Wed, 26 Jun 2019 18:04:18 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mga12.intel.com (mga12.intel.com [192.55.52.136])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 56FC58922F
 for <intel-gfx@lists.freedesktop.org>; Wed, 26 Jun 2019 18:04:16 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from fmsmga008.fm.intel.com ([10.253.24.58])
 by fmsmga106.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 26 Jun 2019 11:03:59 -0700
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.63,420,1557212400"; d="scan'208";a="162357605"
Received: from stinkbox.fi.intel.com (HELO stinkbox) ([10.237.72.174])
 by fmsmga008.fm.intel.com with SMTP; 26 Jun 2019 11:03:57 -0700
Received: by stinkbox (sSMTP sendmail emulation);
 Wed, 26 Jun 2019 21:03:56 +0300
From: Ville Syrjala <ville.syrjala@linux.intel.com>
To: intel-gfx@lists.freedesktop.org
Date: Wed, 26 Jun 2019 21:03:43 +0300
Message-Id: <20190626180344.26314-5-ville.syrjala@linux.intel.com>
X-Mailer: git-send-email 2.21.0
In-Reply-To: <20190626180344.26314-1-ville.syrjala@linux.intel.com>
References: <20190626180344.26314-1-ville.syrjala@linux.intel.com>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v2 4/5] drm/i915: Finish the irq ack+handler
 split for ilk+
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

RnJvbTogVmlsbGUgU3lyasOkbMOkIDx2aWxsZS5zeXJqYWxhQGxpbnV4LmludGVsLmNvbT4KCkFs
bCB0aGUgb2xkZXIgcGxhdGZvcm1zIGFscmVhZHkgZm9sbG93IHRoZSBhY2sraGFuZGxlciBhcHBv
cm9hY2gKZm9yIGludGVycnVwdHMuIENvbnZlcnQgaWxrKyBhcyB3ZWxsLiBBcyB0aGUgbnVtYmVy
IG9mIHJlZ2lzdGVycwppbnZvbHZlZCBpcyByYXRoZXIgbGFyZ2Ugd2UnbGwgaW50cm9kdWNlIGEg
ZmV3IG1vcmUgc3RydWN0cyB0bwpjYXJyeSB0aGUgcmVnaXN0ZXIgdmFsdWVzIGFyb3VuZC4KClRo
ZSB1bmZvcnR1bmF0ZSBzaWRlIGVmZmVjdCBvZiB0aGlzIGlzIHNvbWUgZ3Jvd3RoOgphZGQvcmVt
b3ZlOiA1LzAgZ3Jvdy9zaHJpbms6IDMvNSB1cC9kb3duOiAxOTMzLy0xMDUyICg4ODEpCkZ1bmN0
aW9uICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9sZCAgICAgbmV3ICAgZGVs
dGEKZ2VuOF9kZV9pcnFfYWNrICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtICAgIDEy
MjkgICArMTIyOQppcm9ubGFrZV9pcnFfaGFuZGxlciAgICAgICAgICAgICAgICAgICAgICAgIDI4
MDggICAgMjk3MyAgICArMTY1CmNwdF9pcnFfYWNrICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgLSAgICAgMTE3ICAgICsxMTcKaWJ4X2hwZF9pcnFfYWNrLmlzcmEgICAgICAgICAg
ICAgICAgICAgICAgICAgICAtICAgICAxMDYgICAgKzEwNgpoc3dfcHNyX2lycV9hY2sgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgIC0gICAgICA5MSAgICAgKzkxCmdlbjhfaXJxX2hhbmRs
ZXIgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDIwNCAgICAgMjkxICAgICArODcKaWxrX2hw
ZF9pcnFfYWNrLmlzcmEgICAgICAgICAgICAgICAgICAgICAgICAgICAtICAgICAgODIgICAgICs4
MgpnZW4xMV9pcnFfaGFuZGxlciAgICAgICAgICAgICAgICAgICAgICAgICAgICA4NDYgICAgIDkw
MiAgICAgKzU2CmNwdF9pcnFfaGFuZGxlciAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDUx
MSAgICAgNDQwICAgICAtNzEKaWxrX2hwZF9pcnFfaGFuZGxlciAgICAgICAgICAgICAgICAgICAg
ICAgICAgMTk1ICAgICAxMTQgICAgIC04MQppYnhfaHBkX2lycV9oYW5kbGVyICAgICAgICAgICAg
ICAgICAgICAgICAgICAyMzUgICAgIDExOCAgICAtMTE3CmljcF9pcnFfaGFuZGxlciAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIDQxNyAgICAgMjUwICAgIC0xNjcKZ2VuOF9kZV9pcnFfaGFu
ZGxlciAgICAgICAgICAgICAgICAgICAgICAgICAyMTk4ICAgIDE1ODIgICAgLTYxNgpUb3RhbDog
QmVmb3JlPTMzMjUxLCBBZnRlcj0zNDEzMiwgY2hnICsyLjY1JQoKYnV0IHdlJ2xsIGZpeCB0aGF0
IHVwIGFmdGVyd2FyZHMuCgp2MjogRHJvcCB0aGUgemVybyBpbml0aWFsaXphdGlvbiAoQ2hyaXMp
CiAgICBEcm9wIHRoZSBnZW4xMSsgY2hlY2sgZm9yIEdFTjExX0RFX0hQRF9JUlEgYXMKICAgIHRo
ZSBiaXQgd2FzIG1ieiBiZWZvcmUgKENocmlzKQogICAgQWRhcHQgdG8gUENIX01DQyBjaGFuZ2Vz
CgpTaWduZWQtb2ZmLWJ5OiBWaWxsZSBTeXJqw6Rsw6QgPHZpbGxlLnN5cmphbGFAbGludXguaW50
ZWwuY29tPgpSZXZpZXdlZC1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28u
dWs+Ci0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9pcnEuYyB8IDQ0MiArKysrKysrKysr
KysrKysrKysrKystLS0tLS0tLS0tLQogMSBmaWxlIGNoYW5nZWQsIDI5MyBpbnNlcnRpb25zKCsp
LCAxNDkgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkx
NV9pcnEuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfaXJxLmMKaW5kZXggYmM2ZjgxNGFh
NWExLi5iODNjOWQ3MWQ2MzAgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVf
aXJxLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9pcnEuYwpAQCAtMjM2MSw2ICsy
MzYxLDEzIEBAIHN0YXRpYyBpcnFyZXR1cm5fdCBjaGVycnl2aWV3X2lycV9oYW5kbGVyKGludCBp
cnEsIHZvaWQgKmFyZykKIAlyZXR1cm4gcmV0OwogfQogCitzdHJ1Y3QgaWxrX2RlX2lycV9yZWdz
IHsKKwl1MzIgaWlyOworCXUzMiBlcnJfaW50OyAvKiBpdmIvaHN3ICovCisJdTMyIHBzcl9paXI7
IC8qIGhzdyAqLworCXN0cnVjdCBocGRfaXJxX3JlZ3MgaHBkOworfTsKKwogc3RydWN0IHBjaF9p
cnFfcmVncyB7CiAJdTMyIGlpcjsKIAl1MzIgc2Vycl9pbnQ7IC8qIGNwdC9scHQgKi8KQEAgLTI0
NjcsOSArMjQ3NCwxNyBAQCBzdGF0aWMgdm9pZCBpYnhfaXJxX2hhbmRsZXIoc3RydWN0IGRybV9p
OTE1X3ByaXZhdGUgKmRldl9wcml2LAogCQlpbnRlbF9wY2hfZmlmb191bmRlcnJ1bl9pcnFfaGFu
ZGxlcihkZXZfcHJpdiwgUElQRV9CKTsKIH0KIAotc3RhdGljIHZvaWQgaXZiX2Vycl9pbnRfaGFu
ZGxlcihzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYpCitzdGF0aWMgdm9pZCBpdmJf
ZXJyX2ludF9hY2soc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2LAorCQkJICAgIHN0
cnVjdCBpbGtfZGVfaXJxX3JlZ3MgKmRlKQogewotCXUzMiBlcnJfaW50ID0gSTkxNV9SRUFEKEdF
TjdfRVJSX0lOVCk7CisJZGUtPmVycl9pbnQgPSBJOTE1X1JFQUQoR0VON19FUlJfSU5UKTsKKwlJ
OTE1X1dSSVRFKEdFTjdfRVJSX0lOVCwgZGUtPmVycl9pbnQpOworfQorCitzdGF0aWMgdm9pZCBp
dmJfZXJyX2ludF9oYW5kbGVyKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiwKKwkJ
CQljb25zdCBzdHJ1Y3QgaWxrX2RlX2lycV9yZWdzICpkZSkKK3sKKwl1MzIgZXJyX2ludCA9IGRl
LT5lcnJfaW50OwogCWVudW0gcGlwZSBwaXBlOwogCiAJaWYgKGVycl9pbnQgJiBFUlJfSU5UX1BP
SVNPTikKQEAgLTI0ODYsOCArMjUwMSw2IEBAIHN0YXRpYyB2b2lkIGl2Yl9lcnJfaW50X2hhbmRs
ZXIoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2KQogCQkJCWhzd19waXBlX2NyY19p
cnFfaGFuZGxlcihkZXZfcHJpdiwgcGlwZSk7CiAJCX0KIAl9Ci0KLQlJOTE1X1dSSVRFKEdFTjdf
RVJSX0lOVCwgZXJyX2ludCk7CiB9CiAKIHN0YXRpYyB2b2lkIGNwdF9zZXJyX2ludF9hY2soc3Ry
dWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2LApAQCAtMjY2NSwxNyArMjY3OCwzOCBAQCBz
dGF0aWMgdm9pZCBpbGtfaHBkX2lycV9oYW5kbGVyKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpk
ZXZfcHJpdiwKIAlpbnRlbF9ocGRfaXJxX2hhbmRsZXIoZGV2X3ByaXYsIHBpbl9tYXNrLCBsb25n
X21hc2spOwogfQogCitzdGF0aWMgdm9pZCBpbGtfZGlzcGxheV9pcnFfYWNrKHN0cnVjdCBkcm1f
aTkxNV9wcml2YXRlICpkZXZfcHJpdiwKKwkJCQlzdHJ1Y3QgaWxrX2RlX2lycV9yZWdzICpkZSwK
KwkJCQlzdHJ1Y3QgcGNoX2lycV9yZWdzICpwY2gpCit7CisJZGUtPmhwZC5ob3RwbHVnX3RyaWdn
ZXIgPSBkZS0+aWlyICYgREVfRFBfQV9IT1RQTFVHOworCisJaWYgKGRlLT5ocGQuaG90cGx1Z190
cmlnZ2VyKQorCQlpbGtfaHBkX2lycV9hY2soZGV2X3ByaXYsICZkZS0+aHBkKTsKKworCS8qIGNo
ZWNrIGV2ZW50IGZyb20gUENIICovCisJaWYgKGRlLT5paXIgJiBERV9QQ0hfRVZFTlQpIHsKKwkJ
cGNoLT5paXIgPSBJOTE1X1JFQUQoU0RFSUlSKTsKKworCQlpZiAoSEFTX1BDSF9DUFQoZGV2X3By
aXYpKQorCQkJY3B0X2lycV9hY2soZGV2X3ByaXYsIHBjaCk7CisJCWVsc2UKKwkJCWlieF9pcnFf
YWNrKGRldl9wcml2LCBwY2gpOworCisJCS8qIHNob3VsZCBjbGVhciBQQ0ggaG90cGx1ZyBldmVu
dCBiZWZvcmUgY2xlYXIgQ1BVIGlycSAqLworCQlJOTE1X1dSSVRFKFNERUlJUiwgcGNoLT5paXIp
OworCX0KK30KKwogc3RhdGljIHZvaWQgaWxrX2Rpc3BsYXlfaXJxX2hhbmRsZXIoc3RydWN0IGRy
bV9pOTE1X3ByaXZhdGUgKmRldl9wcml2LAotCQkJCSAgICB1MzIgZGVfaWlyKQorCQkJCSAgICBj
b25zdCBzdHJ1Y3QgaWxrX2RlX2lycV9yZWdzICpkZSwKKwkJCQkgICAgY29uc3Qgc3RydWN0IHBj
aF9pcnFfcmVncyAqcGNoKQogewotCXN0cnVjdCBocGRfaXJxX3JlZ3MgaHBkOworCXUzMiBkZV9p
aXIgPSBkZS0+aWlyOwogCWVudW0gcGlwZSBwaXBlOwogCi0JaHBkLmhvdHBsdWdfdHJpZ2dlciA9
IGRlX2lpciAmIERFX0RQX0FfSE9UUExVRzsKLQlpZiAoaHBkLmhvdHBsdWdfdHJpZ2dlcikgewot
CQlpbGtfaHBkX2lycV9hY2soZGV2X3ByaXYsICZocGQpOwotCQlpbGtfaHBkX2lycV9oYW5kbGVy
KGRldl9wcml2LCAmaHBkLCBocGRfaWxrKTsKLQl9CisJaWYgKGRlLT5ocGQuaG90cGx1Z190cmln
Z2VyKQorCQlpbGtfaHBkX2lycV9oYW5kbGVyKGRldl9wcml2LCAmZGUtPmhwZCwgaHBkX2lsayk7
CiAKIAlpZiAoZGVfaWlyICYgREVfQVVYX0NIQU5ORUxfQSkKIAkJZHBfYXV4X2lycV9oYW5kbGVy
KGRldl9wcml2KTsKQEAgLTI2OTksNDcgKzI3MzMsNjUgQEAgc3RhdGljIHZvaWQgaWxrX2Rpc3Bs
YXlfaXJxX2hhbmRsZXIoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2LAogCiAJLyog
Y2hlY2sgZXZlbnQgZnJvbSBQQ0ggKi8KIAlpZiAoZGVfaWlyICYgREVfUENIX0VWRU5UKSB7Ci0J
CXN0cnVjdCBwY2hfaXJxX3JlZ3MgcGNoOwotCi0JCXBjaC5paXIgPSBJOTE1X1JFQUQoU0RFSUlS
KTsKLQotCQlpZiAoSEFTX1BDSF9DUFQoZGV2X3ByaXYpKSB7Ci0JCQljcHRfaXJxX2FjayhkZXZf
cHJpdiwgJnBjaCk7Ci0JCQljcHRfaXJxX2hhbmRsZXIoZGV2X3ByaXYsICZwY2gpOwotCQl9IGVs
c2UgewotCQkJaWJ4X2lycV9hY2soZGV2X3ByaXYsICZwY2gpOwotCQkJaWJ4X2lycV9oYW5kbGVy
KGRldl9wcml2LCAmcGNoKTsKLQkJfQotCi0JCS8qIHNob3VsZCBjbGVhciBQQ0ggaG90cGx1ZyBl
dmVudCBiZWZvcmUgY2xlYXIgQ1BVIGlycSAqLwotCQlJOTE1X1dSSVRFKFNERUlJUiwgcGNoLmlp
cik7CisJCWlmIChIQVNfUENIX0NQVChkZXZfcHJpdikpCisJCQljcHRfaXJxX2hhbmRsZXIoZGV2
X3ByaXYsIHBjaCk7CisJCWVsc2UKKwkJCWlieF9pcnFfaGFuZGxlcihkZXZfcHJpdiwgcGNoKTsK
IAl9CiAKIAlpZiAoSVNfR0VOKGRldl9wcml2LCA1KSAmJiBkZV9paXIgJiBERV9QQ1VfRVZFTlQp
CiAJCWlyb25sYWtlX3Jwc19jaGFuZ2VfaXJxX2hhbmRsZXIoZGV2X3ByaXYpOwogfQogCitzdGF0
aWMgdm9pZCBoc3dfcHNyX2lycV9hY2soc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2
LAorCQkJICAgIHUzMiAqcHNyX2lpcikKK3sKKwkqcHNyX2lpciA9IEk5MTVfUkVBRChFRFBfUFNS
X0lJUik7CisJaWYgKCpwc3JfaWlyKQorCQlJOTE1X1dSSVRFKEVEUF9QU1JfSUlSLCAqcHNyX2lp
cik7Cit9CisKK3N0YXRpYyB2b2lkIGl2Yl9kaXNwbGF5X2lycV9hY2soc3RydWN0IGRybV9pOTE1
X3ByaXZhdGUgKmRldl9wcml2LAorCQkJCXN0cnVjdCBpbGtfZGVfaXJxX3JlZ3MgKmRlLAorCQkJ
CXN0cnVjdCBwY2hfaXJxX3JlZ3MgKnBjaCkKK3sKKwlkZS0+aHBkLmhvdHBsdWdfdHJpZ2dlciA9
IGRlLT5paXIgJiBERV9EUF9BX0hPVFBMVUdfSVZCOworCisJaWYgKGRlLT5ocGQuaG90cGx1Z190
cmlnZ2VyKQorCQlpbGtfaHBkX2lycV9hY2soZGV2X3ByaXYsICZkZS0+aHBkKTsKKworCWlmIChk
ZS0+aWlyICYgREVfRVJSX0lOVF9JVkIpCisJCWl2Yl9lcnJfaW50X2FjayhkZXZfcHJpdiwgZGUp
OworCisJaWYgKGRlLT5paXIgJiBERV9FRFBfUFNSX0lOVF9IU1cpCisJCWhzd19wc3JfaXJxX2Fj
ayhkZXZfcHJpdiwgJmRlLT5wc3JfaWlyKTsKKworCS8qIGNoZWNrIGV2ZW50IGZyb20gUENIICov
CisJaWYgKCFIQVNfUENIX05PUChkZXZfcHJpdikgJiYgZGUtPmlpciAmIERFX1BDSF9FVkVOVF9J
VkIpIHsKKwkJcGNoLT5paXIgPSBJOTE1X1JFQUQoU0RFSUlSKTsKKworCQljcHRfaXJxX2Fjayhk
ZXZfcHJpdiwgcGNoKTsKKworCQkvKiBjbGVhciBQQ0ggaG90cGx1ZyBldmVudCBiZWZvcmUgY2xl
YXIgQ1BVIGlycSAqLworCQlJOTE1X1dSSVRFKFNERUlJUiwgcGNoLT5paXIpOworCX0KK30KKwog
c3RhdGljIHZvaWQgaXZiX2Rpc3BsYXlfaXJxX2hhbmRsZXIoc3RydWN0IGRybV9pOTE1X3ByaXZh
dGUgKmRldl9wcml2LAotCQkJCSAgICB1MzIgZGVfaWlyKQorCQkJCSAgICBjb25zdCBzdHJ1Y3Qg
aWxrX2RlX2lycV9yZWdzICpkZSwKKwkJCQkgICAgY29uc3Qgc3RydWN0IHBjaF9pcnFfcmVncyAq
cGNoKQogewotCXN0cnVjdCBocGRfaXJxX3JlZ3MgaHBkOworCXUzMiBkZV9paXIgPSBkZS0+aWly
OwogCWVudW0gcGlwZSBwaXBlOwogCi0JaHBkLmhvdHBsdWdfdHJpZ2dlciA9IGRlX2lpciAmIERF
X0RQX0FfSE9UUExVR19JVkI7Ci0JaWYgKGhwZC5ob3RwbHVnX3RyaWdnZXIpICB7Ci0JCWlsa19o
cGRfaXJxX2FjayhkZXZfcHJpdiwgJmhwZCk7Ci0JCWlsa19ocGRfaXJxX2hhbmRsZXIoZGV2X3By
aXYsICZocGQsIGhwZF9pdmIpOwotCX0KKwlpZiAoZGUtPmhwZC5ob3RwbHVnX3RyaWdnZXIpCisJ
CWlsa19ocGRfaXJxX2hhbmRsZXIoZGV2X3ByaXYsICZkZS0+aHBkLCBocGRfaXZiKTsKIAogCWlm
IChkZV9paXIgJiBERV9FUlJfSU5UX0lWQikKLQkJaXZiX2Vycl9pbnRfaGFuZGxlcihkZXZfcHJp
dik7Ci0KLQlpZiAoZGVfaWlyICYgREVfRURQX1BTUl9JTlRfSFNXKSB7Ci0JCXUzMiBwc3JfaWly
ID0gSTkxNV9SRUFEKEVEUF9QU1JfSUlSKTsKKwkJaXZiX2Vycl9pbnRfaGFuZGxlcihkZXZfcHJp
diwgZGUpOwogCi0JCWludGVsX3Bzcl9pcnFfaGFuZGxlcihkZXZfcHJpdiwgcHNyX2lpcik7Ci0J
CUk5MTVfV1JJVEUoRURQX1BTUl9JSVIsIHBzcl9paXIpOwotCX0KKwlpZiAoZGVfaWlyICYgREVf
RURQX1BTUl9JTlRfSFNXKQorCQlpbnRlbF9wc3JfaXJxX2hhbmRsZXIoZGV2X3ByaXYsIGRlLT5w
c3JfaWlyKTsKIAogCWlmIChkZV9paXIgJiBERV9BVVhfQ0hBTk5FTF9BX0lWQikKIAkJZHBfYXV4
X2lycV9oYW5kbGVyKGRldl9wcml2KTsKQEAgLTI3NDgsMjIgKzI4MDAsMTMgQEAgc3RhdGljIHZv
aWQgaXZiX2Rpc3BsYXlfaXJxX2hhbmRsZXIoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9w
cml2LAogCQlpbnRlbF9vcHJlZ2lvbl9hc2xlX2ludHIoZGV2X3ByaXYpOwogCiAJZm9yX2VhY2hf
cGlwZShkZXZfcHJpdiwgcGlwZSkgewotCQlpZiAoZGVfaWlyICYgKERFX1BJUEVfVkJMQU5LX0lW
QihwaXBlKSkpCisJCWlmIChkZV9paXIgJiBERV9QSVBFX1ZCTEFOS19JVkIocGlwZSkpCiAJCQlk
cm1faGFuZGxlX3ZibGFuaygmZGV2X3ByaXYtPmRybSwgcGlwZSk7CiAJfQogCiAJLyogY2hlY2sg
ZXZlbnQgZnJvbSBQQ0ggKi8KLQlpZiAoIUhBU19QQ0hfTk9QKGRldl9wcml2KSAmJiAoZGVfaWly
ICYgREVfUENIX0VWRU5UX0lWQikpIHsKLQkJc3RydWN0IHBjaF9pcnFfcmVncyBwY2g7Ci0KLQkJ
cGNoLmlpciA9IEk5MTVfUkVBRChTREVJSVIpOwotCi0JCWNwdF9pcnFfYWNrKGRldl9wcml2LCAm
cGNoKTsKLQkJY3B0X2lycV9oYW5kbGVyKGRldl9wcml2LCAmcGNoKTsKLQotCQkvKiBjbGVhciBQ
Q0ggaG90cGx1ZyBldmVudCBiZWZvcmUgY2xlYXIgQ1BVIGlycSAqLwotCQlJOTE1X1dSSVRFKFNE
RUlJUiwgcGNoLmlpcik7Ci0JfQorCWlmICghSEFTX1BDSF9OT1AoZGV2X3ByaXYpICYmIGRlX2lp
ciAmIERFX1BDSF9FVkVOVF9JVkIpCisJCWNwdF9pcnFfaGFuZGxlcihkZXZfcHJpdiwgcGNoKTsK
IH0KIAogLyoKQEAgLTI3NzcsNyArMjgyMCw5IEBAIHN0YXRpYyB2b2lkIGl2Yl9kaXNwbGF5X2ly
cV9oYW5kbGVyKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiwKIHN0YXRpYyBpcnFy
ZXR1cm5fdCBpcm9ubGFrZV9pcnFfaGFuZGxlcihpbnQgaXJxLCB2b2lkICphcmcpCiB7CiAJc3Ry
dWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2ID0gYXJnOwotCXUzMiBkZV9paXIsIGd0X2lp
ciwgZGVfaWVyLCBzZGVfaWVyID0gMDsKKwl1MzIgZ3RfaWlyLCBwbV9paXIgPSAwLCBkZV9pZXIs
IHNkZV9pZXIgPSAwOworCXN0cnVjdCBpbGtfZGVfaXJxX3JlZ3MgZGU7CisJc3RydWN0IHBjaF9p
cnFfcmVncyBwY2g7CiAJaXJxcmV0dXJuX3QgcmV0ID0gSVJRX05PTkU7CiAKIAlpZiAoIWludGVs
X2lycXNfZW5hYmxlZChkZXZfcHJpdikpCkBAIC0yODAzLDggKzI4NDgsMzAgQEAgc3RhdGljIGly
cXJldHVybl90IGlyb25sYWtlX2lycV9oYW5kbGVyKGludCBpcnEsIHZvaWQgKmFyZykKIAkvKiBG
aW5kLCBjbGVhciwgdGhlbiBwcm9jZXNzIGVhY2ggc291cmNlIG9mIGludGVycnVwdCAqLwogCiAJ
Z3RfaWlyID0gSTkxNV9SRUFEKEdUSUlSKTsKLQlpZiAoZ3RfaWlyKSB7CisJZGUuaWlyID0gSTkx
NV9SRUFEKERFSUlSKTsKKwlpZiAoSU5URUxfR0VOKGRldl9wcml2KSA+PSA2KQorCQlwbV9paXIg
PSBJOTE1X1JFQUQoR0VONl9QTUlJUik7CisKKwlpZiAoZ3RfaWlyKQogCQlJOTE1X1dSSVRFKEdU
SUlSLCBndF9paXIpOworCisJaWYgKGRlLmlpcikgeworCQlpZiAoSU5URUxfR0VOKGRldl9wcml2
KSA+PSA3KQorCQkJaXZiX2Rpc3BsYXlfaXJxX2FjayhkZXZfcHJpdiwgJmRlLCAmcGNoKTsKKwkJ
ZWxzZQorCQkJaWxrX2Rpc3BsYXlfaXJxX2FjayhkZXZfcHJpdiwgJmRlLCAmcGNoKTsKKworCQlJ
OTE1X1dSSVRFKERFSUlSLCBkZS5paXIpOworCX0KKworCWlmIChwbV9paXIpCisJCUk5MTVfV1JJ
VEUoR0VONl9QTUlJUiwgcG1faWlyKTsKKworCUk5MTVfV1JJVEUoREVJRVIsIGRlX2llcik7CisJ
aWYgKCFIQVNfUENIX05PUChkZXZfcHJpdikpCisJCUk5MTVfV1JJVEUoU0RFSUVSLCBzZGVfaWVy
KTsKKworCWlmIChndF9paXIpIHsKIAkJcmV0ID0gSVJRX0hBTkRMRUQ7CiAJCWlmIChJTlRFTF9H
RU4oZGV2X3ByaXYpID49IDYpCiAJCQlzbmJfZ3RfaXJxX2hhbmRsZXIoZGV2X3ByaXYsIGd0X2lp
cik7CkBAIC0yODEyLDI5ICsyODc5LDE5IEBAIHN0YXRpYyBpcnFyZXR1cm5fdCBpcm9ubGFrZV9p
cnFfaGFuZGxlcihpbnQgaXJxLCB2b2lkICphcmcpCiAJCQlpbGtfZ3RfaXJxX2hhbmRsZXIoZGV2
X3ByaXYsIGd0X2lpcik7CiAJfQogCi0JZGVfaWlyID0gSTkxNV9SRUFEKERFSUlSKTsKLQlpZiAo
ZGVfaWlyKSB7Ci0JCUk5MTVfV1JJVEUoREVJSVIsIGRlX2lpcik7CisJaWYgKGRlLmlpcikgewog
CQlyZXQgPSBJUlFfSEFORExFRDsKIAkJaWYgKElOVEVMX0dFTihkZXZfcHJpdikgPj0gNykKLQkJ
CWl2Yl9kaXNwbGF5X2lycV9oYW5kbGVyKGRldl9wcml2LCBkZV9paXIpOworCQkJaXZiX2Rpc3Bs
YXlfaXJxX2hhbmRsZXIoZGV2X3ByaXYsICZkZSwgJnBjaCk7CiAJCWVsc2UKLQkJCWlsa19kaXNw
bGF5X2lycV9oYW5kbGVyKGRldl9wcml2LCBkZV9paXIpOworCQkJaWxrX2Rpc3BsYXlfaXJxX2hh
bmRsZXIoZGV2X3ByaXYsICZkZSwgJnBjaCk7CiAJfQogCi0JaWYgKElOVEVMX0dFTihkZXZfcHJp
dikgPj0gNikgewotCQl1MzIgcG1faWlyID0gSTkxNV9SRUFEKEdFTjZfUE1JSVIpOwotCQlpZiAo
cG1faWlyKSB7Ci0JCQlJOTE1X1dSSVRFKEdFTjZfUE1JSVIsIHBtX2lpcik7Ci0JCQlyZXQgPSBJ
UlFfSEFORExFRDsKLQkJCWdlbjZfcnBzX2lycV9oYW5kbGVyKGRldl9wcml2LCBwbV9paXIpOwot
CQl9CisJaWYgKHBtX2lpcikgeworCQlyZXQgPSBJUlFfSEFORExFRDsKKwkJZ2VuNl9ycHNfaXJx
X2hhbmRsZXIoZGV2X3ByaXYsIHBtX2lpcik7CiAJfQogCi0JSTkxNV9XUklURShERUlFUiwgZGVf
aWVyKTsKLQlpZiAoIUhBU19QQ0hfTk9QKGRldl9wcml2KSkKLQkJSTkxNV9XUklURShTREVJRVIs
IHNkZV9pZXIpOwotCiAJLyogSVJRcyBhcmUgc3luY2VkIGR1cmluZyBydW50aW1lX3N1c3BlbmQs
IHdlIGRvbid0IHJlcXVpcmUgYSB3YWtlcmVmICovCiAJZW5hYmxlX3JwbV93YWtlcmVmX2Fzc2Vy
dHMoJmRldl9wcml2LT5ydW50aW1lX3BtKTsKIApAQCAtMjg2MSwzNyArMjkxOCwxMjkgQEAgc3Rh
dGljIHZvaWQgYnh0X2hwZF9pcnFfaGFuZGxlcihzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2
X3ByaXYsCiAJaW50ZWxfaHBkX2lycV9oYW5kbGVyKGRldl9wcml2LCBwaW5fbWFzaywgbG9uZ19t
YXNrKTsKIH0KIAotc3RhdGljIHZvaWQgZ2VuMTFfaHBkX2lycV9oYW5kbGVyKHN0cnVjdCBkcm1f
aTkxNV9wcml2YXRlICpkZXZfcHJpdiwgdTMyIGlpcikKK3N0cnVjdCBnZW44X2RlX2lycV9yZWdz
IHsKKwl1MzIgcGlwZV9paXJbSTkxNV9NQVhfUElQRVNdOworCXUzMiBwb3J0X2lpcjsKKwl1MzIg
bWlzY19paXI7CisJdTMyIHBzcl9paXI7CisJdTMyIGhwZF9paXI7IC8qIGljbCsgKi8KKwlzdHJ1
Y3QgaHBkX2lycV9yZWdzIGRkaTsKKwlzdHJ1Y3QgaHBkX2lycV9yZWdzIHRjLCB0YnQ7IC8qIGlj
bCsgKi8KK307CisKK3N0YXRpYyB2b2lkIGdlbjExX2hwZF9pcnFfYWNrKHN0cnVjdCBkcm1faTkx
NV9wcml2YXRlICpkZXZfcHJpdiwKKwkJCSAgICAgIHN0cnVjdCBnZW44X2RlX2lycV9yZWdzICpk
ZSkKIHsKLQlzdHJ1Y3QgaHBkX2lycV9yZWdzIHRjOwotCXN0cnVjdCBocGRfaXJxX3JlZ3MgdGJ0
OwotCXUzMiBwaW5fbWFzayA9IDAsIGxvbmdfbWFzayA9IDA7CisJZGUtPnRjLmhvdHBsdWdfdHJp
Z2dlciA9IGRlLT5ocGRfaWlyICYgR0VOMTFfREVfVENfSE9UUExVR19NQVNLOworCWRlLT50YnQu
aG90cGx1Z190cmlnZ2VyID0gZGUtPmhwZF9paXIgJiBHRU4xMV9ERV9UQlRfSE9UUExVR19NQVNL
OworCisJaWYgKGRlLT50Yy5ob3RwbHVnX3RyaWdnZXIpIHsKKwkJZGUtPnRjLmRpZ19ob3RwbHVn
X3JlZyA9IEk5MTVfUkVBRChHRU4xMV9UQ19IT1RQTFVHX0NUTCk7CisJCUk5MTVfV1JJVEUoR0VO
MTFfVENfSE9UUExVR19DVEwsIGRlLT50Yy5kaWdfaG90cGx1Z19yZWcpOworCX0KIAotCXRjLmhv
dHBsdWdfdHJpZ2dlciA9IGlpciAmIEdFTjExX0RFX1RDX0hPVFBMVUdfTUFTSzsKLQl0YnQuaG90
cGx1Z190cmlnZ2VyID0gaWlyICYgR0VOMTFfREVfVEJUX0hPVFBMVUdfTUFTSzsKKwlpZiAoZGUt
PnRidC5ob3RwbHVnX3RyaWdnZXIpIHsKKwkJZGUtPnRidC5kaWdfaG90cGx1Z19yZWcgPSBJOTE1
X1JFQUQoR0VOMTFfVEJUX0hPVFBMVUdfQ1RMKTsKKwkJSTkxNV9XUklURShHRU4xMV9UQlRfSE9U
UExVR19DVEwsIGRlLT50YnQuZGlnX2hvdHBsdWdfcmVnKTsKKwl9Cit9CiAKLQlpZiAodGMuaG90
cGx1Z190cmlnZ2VyKSB7Ci0JCXRjLmRpZ19ob3RwbHVnX3JlZyA9IEk5MTVfUkVBRChHRU4xMV9U
Q19IT1RQTFVHX0NUTCk7Ci0JCUk5MTVfV1JJVEUoR0VOMTFfVENfSE9UUExVR19DVEwsIHRjLmRp
Z19ob3RwbHVnX3JlZyk7CitzdGF0aWMgdm9pZCBnZW4xMV9ocGRfaXJxX2hhbmRsZXIoc3RydWN0
IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2LAorCQkJCSAgY29uc3Qgc3RydWN0IGdlbjhfZGVf
aXJxX3JlZ3MgKmRlKQoreworCXUzMiBwaW5fbWFzayA9IDAsIGxvbmdfbWFzayA9IDA7CiAKKwlp
ZiAoZGUtPnRjLmhvdHBsdWdfdHJpZ2dlcikgewogCQlpbnRlbF9nZXRfaHBkX3BpbnMoZGV2X3By
aXYsICZwaW5fbWFzaywgJmxvbmdfbWFzaywKLQkJCQkgICAmdGMsIGhwZF9nZW4xMSwKKwkJCQkg
ICAmZGUtPnRjLCBocGRfZ2VuMTEsCiAJCQkJICAgZ2VuMTFfcG9ydF9ob3RwbHVnX2xvbmdfZGV0
ZWN0KTsKIAl9CiAKLQlpZiAodGJ0LmhvdHBsdWdfdHJpZ2dlcikgewotCQl0YnQuZGlnX2hvdHBs
dWdfcmVnID0gSTkxNV9SRUFEKEdFTjExX1RCVF9IT1RQTFVHX0NUTCk7Ci0JCUk5MTVfV1JJVEUo
R0VOMTFfVEJUX0hPVFBMVUdfQ1RMLCB0YnQuZGlnX2hvdHBsdWdfcmVnKTsKLQorCWlmIChkZS0+
dGJ0LmhvdHBsdWdfdHJpZ2dlcikgewogCQlpbnRlbF9nZXRfaHBkX3BpbnMoZGV2X3ByaXYsICZw
aW5fbWFzaywgJmxvbmdfbWFzaywKLQkJCQkgICAmdGJ0LCBocGRfZ2VuMTEsCisJCQkJICAgJmRl
LT50YnQsIGhwZF9nZW4xMSwKIAkJCQkgICBnZW4xMV9wb3J0X2hvdHBsdWdfbG9uZ19kZXRlY3Qp
OwogCX0KIAogCWlmIChwaW5fbWFzaykKIAkJaW50ZWxfaHBkX2lycV9oYW5kbGVyKGRldl9wcml2
LCBwaW5fbWFzaywgbG9uZ19tYXNrKTsKIAllbHNlCi0JCURSTV9FUlJPUigiVW5leHBlY3RlZCBE
RSBIUEQgaW50ZXJydXB0IDB4JTA4eFxuIiwgaWlyKTsKKwkJRFJNX0VSUk9SKCJVbmV4cGVjdGVk
IERFIEhQRCBpbnRlcnJ1cHQgMHglMDh4XG4iLCBkZS0+aHBkX2lpcik7Cit9CisKK3N0YXRpYyB2
b2lkCitnZW44X2RlX2lycV9hY2soc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2LCB1
MzIgbWFzdGVyX2N0bCwKKwkJc3RydWN0IGdlbjhfZGVfaXJxX3JlZ3MgKmRlLCBzdHJ1Y3QgcGNo
X2lycV9yZWdzICpwY2gpCit7CisJZW51bSBwaXBlIHBpcGU7CisKKwlpZiAobWFzdGVyX2N0bCAm
IEdFTjhfREVfTUlTQ19JUlEpIHsKKwkJZGUtPm1pc2NfaWlyID0gSTkxNV9SRUFEKEdFTjhfREVf
TUlTQ19JSVIpOworCisJCWlmIChkZS0+bWlzY19paXIpIHsKKwkJCWlmIChkZS0+bWlzY19paXIg
JiBHRU44X0RFX0VEUF9QU1IpCisJCQkJaHN3X3Bzcl9pcnFfYWNrKGRldl9wcml2LCAmZGUtPnBz
cl9paXIpOworCisJCQlJOTE1X1dSSVRFKEdFTjhfREVfTUlTQ19JSVIsIGRlLT5taXNjX2lpcik7
CisJCX0KKwl9CisKKwlpZiAobWFzdGVyX2N0bCAmIEdFTjExX0RFX0hQRF9JUlEpIHsKKwkJZGUt
PmhwZF9paXIgPSBJOTE1X1JFQUQoR0VOMTFfREVfSFBEX0lJUik7CisKKwkJaWYgKGRlLT5ocGRf
aWlyKSB7CisJCQlnZW4xMV9ocGRfaXJxX2FjayhkZXZfcHJpdiwgZGUpOworCisJCQlJOTE1X1dS
SVRFKEdFTjExX0RFX0hQRF9JSVIsIGRlLT5ocGRfaWlyKTsKKwkJfQorCX0KKworCWlmIChtYXN0
ZXJfY3RsICYgR0VOOF9ERV9QT1JUX0lSUSkgeworCQlkZS0+cG9ydF9paXIgPSBJOTE1X1JFQUQo
R0VOOF9ERV9QT1JUX0lJUik7CisKKwkJaWYgKGRlLT5wb3J0X2lpcikgeworCQkJaWYgKElTX0dF
TjlfTFAoZGV2X3ByaXYpKSB7CisJCQkJZGUtPmRkaS5ob3RwbHVnX3RyaWdnZXIgPSBkZS0+cG9y
dF9paXIgJiBCWFRfREVfUE9SVF9IT1RQTFVHX01BU0s7CisJCQkJaWYgKGRlLT5kZGkuaG90cGx1
Z190cmlnZ2VyKQorCQkJCQlieHRfaHBkX2lycV9hY2soZGV2X3ByaXYsICZkZS0+ZGRpKTsKKwkJ
CX0gZWxzZSBpZiAoSVNfQlJPQURXRUxMKGRldl9wcml2KSkgeworCQkJCWRlLT5kZGkuaG90cGx1
Z190cmlnZ2VyID0gZGUtPnBvcnRfaWlyICYgR0VOOF9QT1JUX0RQX0FfSE9UUExVRzsKKwkJCQlp
ZiAoZGUtPmRkaS5ob3RwbHVnX3RyaWdnZXIpCisJCQkJCWlsa19ocGRfaXJxX2FjayhkZXZfcHJp
diwgJmRlLT5kZGkpOworCQkJfQorCisJCQlJOTE1X1dSSVRFKEdFTjhfREVfUE9SVF9JSVIsIGRl
LT5wb3J0X2lpcik7CisJCX0KKwl9CisKKwlmb3JfZWFjaF9waXBlKGRldl9wcml2LCBwaXBlKSB7
CisJCWlmICghKG1hc3Rlcl9jdGwgJiBHRU44X0RFX1BJUEVfSVJRKHBpcGUpKSkKKwkJCWNvbnRp
bnVlOworCisJCWRlLT5waXBlX2lpcltwaXBlXSA9IEk5MTVfUkVBRChHRU44X0RFX1BJUEVfSUlS
KHBpcGUpKTsKKwkJaWYgKGRlLT5waXBlX2lpcltwaXBlXSkKKwkJCUk5MTVfV1JJVEUoR0VOOF9E
RV9QSVBFX0lJUihwaXBlKSwgZGUtPnBpcGVfaWlyW3BpcGVdKTsKKwl9CisKKwlpZiAoSEFTX1BD
SF9TUExJVChkZXZfcHJpdikgJiYgIUhBU19QQ0hfTk9QKGRldl9wcml2KSAmJgorCSAgICBtYXN0
ZXJfY3RsICYgR0VOOF9ERV9QQ0hfSVJRKSB7CisJCS8qCisJCSAqIEZJWE1FKEJEVyk6IEFzc3Vt
ZSBmb3Igbm93IHRoYXQgdGhlIG5ldyBpbnRlcnJ1cHQgaGFuZGxpbmcKKwkJICogc2NoZW1lIGFs
c28gY2xvc2VkIHRoZSBTREUgaW50ZXJydXB0IGhhbmRsaW5nIHJhY2Ugd2UndmUgc2VlbgorCQkg
KiBvbiBvbGRlciBwY2gtc3BsaXQgcGxhdGZvcm1zLiBCdXQgdGhpcyBuZWVkcyB0ZXN0aW5nLgor
CQkgKi8KKwkJcGNoLT5paXIgPSBJOTE1X1JFQUQoU0RFSUlSKTsKKwkJaWYgKHBjaC0+aWlyKSB7
CisJCQlpZiAoSU5URUxfUENIX1RZUEUoZGV2X3ByaXYpID49IFBDSF9JQ1ApCisJCQkJaWNwX2ly
cV9hY2soZGV2X3ByaXYsIHBjaCk7CisJCQllbHNlIGlmIChJTlRFTF9QQ0hfVFlQRShkZXZfcHJp
dikgPj0gUENIX1NQVCkKKwkJCQlzcHRfaXJxX2FjayhkZXZfcHJpdiwgcGNoKTsKKwkJCWVsc2UK
KwkJCQljcHRfaXJxX2FjayhkZXZfcHJpdiwgcGNoKTsKKworCQkJSTkxNV9XUklURShTREVJSVIs
IHBjaC0+aWlyKTsKKwkJfQorCX0KIH0KIAogc3RhdGljIHUzMiBnZW44X2RlX3BvcnRfYXV4X21h
c2soc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2KQpAQCAtMjkyMiw1NyArMzA3MSw1
MSBAQCBzdGF0aWMgdTMyIGdlbjhfZGVfcGlwZV9mYXVsdF9tYXNrKHN0cnVjdCBkcm1faTkxNV9w
cml2YXRlICpkZXZfcHJpdikKIH0KIAogc3RhdGljIGlycXJldHVybl90Ci1nZW44X2RlX2lycV9o
YW5kbGVyKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiwgdTMyIG1hc3Rlcl9jdGwp
CitnZW44X2RlX2lycV9oYW5kbGVyKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiwg
dTMyIG1hc3Rlcl9jdGwsCisJCSAgICBjb25zdCBzdHJ1Y3QgZ2VuOF9kZV9pcnFfcmVncyAqZGUs
CisJCSAgICBjb25zdCBzdHJ1Y3QgcGNoX2lycV9yZWdzICpwY2gpCiB7CiAJaXJxcmV0dXJuX3Qg
cmV0ID0gSVJRX05PTkU7Ci0JdTMyIGlpcjsKIAllbnVtIHBpcGUgcGlwZTsKIAogCWlmIChtYXN0
ZXJfY3RsICYgR0VOOF9ERV9NSVNDX0lSUSkgewotCQlpaXIgPSBJOTE1X1JFQUQoR0VOOF9ERV9N
SVNDX0lJUik7CisJCXUzMiBpaXIgPSBkZS0+bWlzY19paXI7CisKIAkJaWYgKGlpcikgewogCQkJ
Ym9vbCBmb3VuZCA9IGZhbHNlOwogCi0JCQlJOTE1X1dSSVRFKEdFTjhfREVfTUlTQ19JSVIsIGlp
cik7Ci0JCQlyZXQgPSBJUlFfSEFORExFRDsKLQogCQkJaWYgKGlpciAmIEdFTjhfREVfTUlTQ19H
U0UpIHsKIAkJCQlpbnRlbF9vcHJlZ2lvbl9hc2xlX2ludHIoZGV2X3ByaXYpOwogCQkJCWZvdW5k
ID0gdHJ1ZTsKIAkJCX0KIAogCQkJaWYgKGlpciAmIEdFTjhfREVfRURQX1BTUikgewotCQkJCXUz
MiBwc3JfaWlyID0gSTkxNV9SRUFEKEVEUF9QU1JfSUlSKTsKLQotCQkJCWludGVsX3Bzcl9pcnFf
aGFuZGxlcihkZXZfcHJpdiwgcHNyX2lpcik7Ci0JCQkJSTkxNV9XUklURShFRFBfUFNSX0lJUiwg
cHNyX2lpcik7CisJCQkJaW50ZWxfcHNyX2lycV9oYW5kbGVyKGRldl9wcml2LCBkZS0+cHNyX2lp
cik7CiAJCQkJZm91bmQgPSB0cnVlOwogCQkJfQogCiAJCQlpZiAoIWZvdW5kKQogCQkJCURSTV9F
UlJPUigiVW5leHBlY3RlZCBERSBNaXNjIGludGVycnVwdFxuIik7Ci0JCX0KLQkJZWxzZQorCQl9
IGVsc2UgewogCQkJRFJNX0VSUk9SKCJUaGUgbWFzdGVyIGNvbnRyb2wgaW50ZXJydXB0IGxpZWQg
KERFIE1JU0MpIVxuIik7CisJCX0KIAl9CiAKLQlpZiAoSU5URUxfR0VOKGRldl9wcml2KSA+PSAx
MSAmJiAobWFzdGVyX2N0bCAmIEdFTjExX0RFX0hQRF9JUlEpKSB7Ci0JCWlpciA9IEk5MTVfUkVB
RChHRU4xMV9ERV9IUERfSUlSKTsKLQkJaWYgKGlpcikgewotCQkJSTkxNV9XUklURShHRU4xMV9E
RV9IUERfSUlSLCBpaXIpOwotCQkJcmV0ID0gSVJRX0hBTkRMRUQ7Ci0JCQlnZW4xMV9ocGRfaXJx
X2hhbmRsZXIoZGV2X3ByaXYsIGlpcik7Ci0JCX0gZWxzZSB7CisJaWYgKG1hc3Rlcl9jdGwgJiBH
RU4xMV9ERV9IUERfSVJRKSB7CisJCXUzMiBpaXIgPSBkZS0+aHBkX2lpcjsKKworCQlpZiAoaWly
KQorCQkJZ2VuMTFfaHBkX2lycV9oYW5kbGVyKGRldl9wcml2LCBkZSk7CisJCWVsc2UKIAkJCURS
TV9FUlJPUigiVGhlIG1hc3RlciBjb250cm9sIGludGVycnVwdCBsaWVkLCAoREUgSFBEKSFcbiIp
OwotCQl9CiAJfQogCiAJaWYgKG1hc3Rlcl9jdGwgJiBHRU44X0RFX1BPUlRfSVJRKSB7Ci0JCWlp
ciA9IEk5MTVfUkVBRChHRU44X0RFX1BPUlRfSUlSKTsKKwkJdTMyIGlpciA9IGRlLT5wb3J0X2lp
cjsKKwogCQlpZiAoaWlyKSB7CiAJCQlib29sIGZvdW5kID0gZmFsc2U7CiAKLQkJCUk5MTVfV1JJ
VEUoR0VOOF9ERV9QT1JUX0lJUiwgaWlyKTsKIAkJCXJldCA9IElSUV9IQU5ETEVEOwogCiAJCQlp
ZiAoaWlyICYgZ2VuOF9kZV9wb3J0X2F1eF9tYXNrKGRldl9wcml2KSkgewpAQCAtMjk4MCwyNCAr
MzEyMywxMiBAQCBnZW44X2RlX2lycV9oYW5kbGVyKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpk
ZXZfcHJpdiwgdTMyIG1hc3Rlcl9jdGwpCiAJCQkJZm91bmQgPSB0cnVlOwogCQkJfQogCi0JCQlp
ZiAoSVNfR0VOOV9MUChkZXZfcHJpdikpIHsKLQkJCQlzdHJ1Y3QgaHBkX2lycV9yZWdzIGRkaTsK
LQotCQkJCWRkaS5ob3RwbHVnX3RyaWdnZXIgPSBpaXIgJiBCWFRfREVfUE9SVF9IT1RQTFVHX01B
U0s7Ci0JCQkJaWYgKGRkaS5ob3RwbHVnX3RyaWdnZXIpIHsKLQkJCQkJYnh0X2hwZF9pcnFfYWNr
KGRldl9wcml2LCAmZGRpKTsKLQkJCQkJYnh0X2hwZF9pcnFfaGFuZGxlcihkZXZfcHJpdiwgJmRk
aSwgaHBkX2J4dCk7Ci0JCQkJCWZvdW5kID0gdHJ1ZTsKLQkJCQl9Ci0JCQl9IGVsc2UgaWYgKElT
X0JST0FEV0VMTChkZXZfcHJpdikpIHsKLQkJCQlzdHJ1Y3QgaHBkX2lycV9yZWdzIGRkaTsKLQot
CQkJCWRkaS5ob3RwbHVnX3RyaWdnZXIgPSBpaXIgJiBHRU44X1BPUlRfRFBfQV9IT1RQTFVHOwot
CQkJCWlmIChkZGkuaG90cGx1Z190cmlnZ2VyKSB7Ci0JCQkJCWlsa19ocGRfaXJxX2FjayhkZXZf
cHJpdiwgJmRkaSk7Ci0JCQkJCWlsa19ocGRfaXJxX2hhbmRsZXIoZGV2X3ByaXYsICZkZGksIGhw
ZF9iZHcpOwotCQkJCQlmb3VuZCA9IHRydWU7Ci0JCQkJfQorCQkJaWYgKElTX0dFTjlfTFAoZGV2
X3ByaXYpICYmIGRlLT5kZGkuaG90cGx1Z190cmlnZ2VyKSB7CisJCQkJYnh0X2hwZF9pcnFfaGFu
ZGxlcihkZXZfcHJpdiwgJmRlLT5kZGksIGhwZF9ieHQpOworCQkJCWZvdW5kID0gdHJ1ZTsKKwkJ
CX0gZWxzZSBpZiAoSVNfQlJPQURXRUxMKGRldl9wcml2KSAmJiBkZS0+ZGRpLmhvdHBsdWdfdHJp
Z2dlcikgeworCQkJCWlsa19ocGRfaXJxX2hhbmRsZXIoZGV2X3ByaXYsICZkZS0+ZGRpLCBocGRf
YmR3KTsKKwkJCQlmb3VuZCA9IHRydWU7CiAJCQl9CiAKIAkJCWlmIChJU19HRU45X0xQKGRldl9w
cml2KSAmJiAoaWlyICYgQlhUX0RFX1BPUlRfR01CVVMpKSB7CkBAIC0zMDA3LDI1ICszMTM4LDI0
IEBAIGdlbjhfZGVfaXJxX2hhbmRsZXIoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2
LCB1MzIgbWFzdGVyX2N0bCkKIAogCQkJaWYgKCFmb3VuZCkKIAkJCQlEUk1fRVJST1IoIlVuZXhw
ZWN0ZWQgREUgUG9ydCBpbnRlcnJ1cHRcbiIpOwotCQl9Ci0JCWVsc2UKKwkJfSBlbHNlIHsKIAkJ
CURSTV9FUlJPUigiVGhlIG1hc3RlciBjb250cm9sIGludGVycnVwdCBsaWVkIChERSBQT1JUKSFc
biIpOworCQl9CiAJfQogCiAJZm9yX2VhY2hfcGlwZShkZXZfcHJpdiwgcGlwZSkgeworCQl1MzIg
aWlyID0gZGUtPnBpcGVfaWlyW3BpcGVdOwogCQl1MzIgZmF1bHRfZXJyb3JzOwogCiAJCWlmICgh
KG1hc3Rlcl9jdGwgJiBHRU44X0RFX1BJUEVfSVJRKHBpcGUpKSkKIAkJCWNvbnRpbnVlOwogCi0J
CWlpciA9IEk5MTVfUkVBRChHRU44X0RFX1BJUEVfSUlSKHBpcGUpKTsKIAkJaWYgKCFpaXIpIHsK
IAkJCURSTV9FUlJPUigiVGhlIG1hc3RlciBjb250cm9sIGludGVycnVwdCBsaWVkIChERSBQSVBF
KSFcbiIpOwogCQkJY29udGludWU7CiAJCX0KIAogCQlyZXQgPSBJUlFfSEFORExFRDsKLQkJSTkx
NV9XUklURShHRU44X0RFX1BJUEVfSUlSKHBpcGUpLCBpaXIpOwogCiAJCWlmIChpaXIgJiBHRU44
X1BJUEVfVkJMQU5LKQogCQkJZHJtX2hhbmRsZV92YmxhbmsoJmRldl9wcml2LT5kcm0sIHBpcGUp
OwpAQCAtMzA0NSwzMSArMzE3NSwyNCBAQCBnZW44X2RlX2lycV9oYW5kbGVyKHN0cnVjdCBkcm1f
aTkxNV9wcml2YXRlICpkZXZfcHJpdiwgdTMyIG1hc3Rlcl9jdGwpCiAKIAlpZiAoSEFTX1BDSF9T
UExJVChkZXZfcHJpdikgJiYgIUhBU19QQ0hfTk9QKGRldl9wcml2KSAmJgogCSAgICBtYXN0ZXJf
Y3RsICYgR0VOOF9ERV9QQ0hfSVJRKSB7Ci0JCXN0cnVjdCBwY2hfaXJxX3JlZ3MgcGNoOworCQl1
MzIgaWlyID0gcGNoLT5paXI7CiAKIAkJLyoKIAkJICogRklYTUUoQkRXKTogQXNzdW1lIGZvciBu
b3cgdGhhdCB0aGUgbmV3IGludGVycnVwdCBoYW5kbGluZwogCQkgKiBzY2hlbWUgYWxzbyBjbG9z
ZWQgdGhlIFNERSBpbnRlcnJ1cHQgaGFuZGxpbmcgcmFjZSB3ZSd2ZSBzZWVuCiAJCSAqIG9uIG9s
ZGVyIHBjaC1zcGxpdCBwbGF0Zm9ybXMuIEJ1dCB0aGlzIG5lZWRzIHRlc3RpbmcuCiAJCSAqLwot
CQlwY2guaWlyID0gSTkxNV9SRUFEKFNERUlJUik7Ci0JCWlmIChwY2guaWlyKSB7Ci0JCQlJOTE1
X1dSSVRFKFNERUlJUiwgcGNoLmlpcik7CisJCWlmIChpaXIpIHsKIAkJCXJldCA9IElSUV9IQU5E
TEVEOwogCi0JCQlpZiAoSU5URUxfUENIX1RZUEUoZGV2X3ByaXYpID49IFBDSF9NQ0MpIHsKLQkJ
CQlpY3BfaXJxX2FjayhkZXZfcHJpdiwgJnBjaCk7Ci0JCQkJaWNwX2lycV9oYW5kbGVyKGRldl9w
cml2LCAmcGNoLCBocGRfbWNjKTsKLQkJCX0gZWxzZSBpZiAoSU5URUxfUENIX1RZUEUoZGV2X3By
aXYpID49IFBDSF9JQ1ApIHsKLQkJCQlpY3BfaXJxX2FjayhkZXZfcHJpdiwgJnBjaCk7Ci0JCQkJ
aWNwX2lycV9oYW5kbGVyKGRldl9wcml2LCAmcGNoLCBocGRfaWNwKTsKLQkJCX0gZWxzZSBpZiAo
SU5URUxfUENIX1RZUEUoZGV2X3ByaXYpID49IFBDSF9TUFQpIHsKLQkJCQlzcHRfaXJxX2Fjayhk
ZXZfcHJpdiwgJnBjaCk7Ci0JCQkJc3B0X2lycV9oYW5kbGVyKGRldl9wcml2LCAmcGNoKTsKLQkJ
CX0gZWxzZSB7Ci0JCQkJY3B0X2lycV9hY2soZGV2X3ByaXYsICZwY2gpOwotCQkJCWNwdF9pcnFf
aGFuZGxlcihkZXZfcHJpdiwgJnBjaCk7Ci0JCQl9CisJCQlpZiAoSU5URUxfUENIX1RZUEUoZGV2
X3ByaXYpID49IFBDSF9NQ0MpCisJCQkJaWNwX2lycV9oYW5kbGVyKGRldl9wcml2LCBwY2gsIGhw
ZF9tY2MpOworCQkJZWxzZSBpZiAoSU5URUxfUENIX1RZUEUoZGV2X3ByaXYpID49IFBDSF9JQ1Ap
CisJCQkJaWNwX2lycV9oYW5kbGVyKGRldl9wcml2LCBwY2gsIGhwZF9pY3ApOworCQkJZWxzZSBp
ZiAoSU5URUxfUENIX1RZUEUoZGV2X3ByaXYpID49IFBDSF9TUFQpCisJCQkJc3B0X2lycV9oYW5k
bGVyKGRldl9wcml2LCBwY2gpOworCQkJZWxzZQorCQkJCWNwdF9pcnFfaGFuZGxlcihkZXZfcHJp
diwgcGNoKTsKIAkJfSBlbHNlIHsKIAkJCS8qCiAJCQkgKiBMaWtlIG9uIHByZXZpb3VzIFBDSCB0
aGVyZSBzZWVtcyB0byBiZSBzb21ldGhpbmcKQEAgLTMxMDYsNiArMzIyOSw4IEBAIHN0YXRpYyBp
cnFyZXR1cm5fdCBnZW44X2lycV9oYW5kbGVyKGludCBpcnEsIHZvaWQgKmFyZykKIAl2b2lkIF9f
aW9tZW0gKiBjb25zdCByZWdzID0gZGV2X3ByaXYtPnVuY29yZS5yZWdzOwogCXUzMiBtYXN0ZXJf
Y3RsOwogCXUzMiBndF9paXJbNF07CisJc3RydWN0IGdlbjhfZGVfaXJxX3JlZ3MgZGU7CisJc3Ry
dWN0IHBjaF9pcnFfcmVncyBwY2g7CiAKIAlpZiAoIWludGVsX2lycXNfZW5hYmxlZChkZXZfcHJp
dikpCiAJCXJldHVybiBJUlFfTk9ORTsKQEAgLTMxMjIsNyArMzI0Nyw3IEBAIHN0YXRpYyBpcnFy
ZXR1cm5fdCBnZW44X2lycV9oYW5kbGVyKGludCBpcnEsIHZvaWQgKmFyZykKIAkvKiBJUlFzIGFy
ZSBzeW5jZWQgZHVyaW5nIHJ1bnRpbWVfc3VzcGVuZCwgd2UgZG9uJ3QgcmVxdWlyZSBhIHdha2Vy
ZWYgKi8KIAlpZiAobWFzdGVyX2N0bCAmIH5HRU44X0dUX0lSUVMpIHsKIAkJZGlzYWJsZV9ycG1f
d2FrZXJlZl9hc3NlcnRzKCZkZXZfcHJpdi0+cnVudGltZV9wbSk7Ci0JCWdlbjhfZGVfaXJxX2hh
bmRsZXIoZGV2X3ByaXYsIG1hc3Rlcl9jdGwpOworCQlnZW44X2RlX2lycV9hY2soZGV2X3ByaXYs
IG1hc3Rlcl9jdGwsICZkZSwgJnBjaCk7CiAJCWVuYWJsZV9ycG1fd2FrZXJlZl9hc3NlcnRzKCZk
ZXZfcHJpdi0+cnVudGltZV9wbSk7CiAJfQogCkBAIC0zMTMwLDYgKzMyNTUsMTIgQEAgc3RhdGlj
IGlycXJldHVybl90IGdlbjhfaXJxX2hhbmRsZXIoaW50IGlycSwgdm9pZCAqYXJnKQogCiAJZ2Vu
OF9ndF9pcnFfaGFuZGxlcihkZXZfcHJpdiwgbWFzdGVyX2N0bCwgZ3RfaWlyKTsKIAorCWlmICht
YXN0ZXJfY3RsICYgfkdFTjhfR1RfSVJRUykgeworCQlkaXNhYmxlX3JwbV93YWtlcmVmX2Fzc2Vy
dHMoJmRldl9wcml2LT5ydW50aW1lX3BtKTsKKwkJZ2VuOF9kZV9pcnFfaGFuZGxlcihkZXZfcHJp
diwgbWFzdGVyX2N0bCwgJmRlLCAmcGNoKTsKKwkJZW5hYmxlX3JwbV93YWtlcmVmX2Fzc2VydHMo
JmRldl9wcml2LT5ydW50aW1lX3BtKTsKKwl9CisKIAlyZXR1cm4gSVJRX0hBTkRMRUQ7CiB9CiAK
QEAgLTMzMDUsNiArMzQzNiw5IEBAIHN0YXRpYyBpcnFyZXR1cm5fdCBnZW4xMV9pcnFfaGFuZGxl
cihpbnQgaXJxLCB2b2lkICphcmcpCiAJdm9pZCBfX2lvbWVtICogY29uc3QgcmVncyA9IGk5MTUt
PnVuY29yZS5yZWdzOwogCXUzMiBtYXN0ZXJfY3RsOwogCXUzMiBndV9taXNjX2lpcjsKKwl1MzIg
ZGlzcF9jdGw7CisJc3RydWN0IGdlbjhfZGVfaXJxX3JlZ3MgZGU7CisJc3RydWN0IHBjaF9pcnFf
cmVncyBwY2g7CiAKIAlpZiAoIWludGVsX2lycXNfZW5hYmxlZChpOTE1KSkKIAkJcmV0dXJuIElS
UV9OT05FOwpAQCAtMzMyMCwxNCArMzQ1NCwxNCBAQCBzdGF0aWMgaXJxcmV0dXJuX3QgZ2VuMTFf
aXJxX2hhbmRsZXIoaW50IGlycSwgdm9pZCAqYXJnKQogCiAJLyogSVJRcyBhcmUgc3luY2VkIGR1
cmluZyBydW50aW1lX3N1c3BlbmQsIHdlIGRvbid0IHJlcXVpcmUgYSB3YWtlcmVmICovCiAJaWYg
KG1hc3Rlcl9jdGwgJiBHRU4xMV9ESVNQTEFZX0lSUSkgewotCQljb25zdCB1MzIgZGlzcF9jdGwg
PSByYXdfcmVnX3JlYWQocmVncywgR0VOMTFfRElTUExBWV9JTlRfQ1RMKTsKKwkJZGlzcF9jdGwg
PSByYXdfcmVnX3JlYWQocmVncywgR0VOMTFfRElTUExBWV9JTlRfQ1RMKTsKIAogCQlkaXNhYmxl
X3JwbV93YWtlcmVmX2Fzc2VydHMoJmk5MTUtPnJ1bnRpbWVfcG0pOwogCQkvKgogCQkgKiBHRU4x
MV9ESVNQTEFZX0lOVF9DVEwgaGFzIHNhbWUgZm9ybWF0IGFzIEdFTjhfTUFTVEVSX0lSUQogCQkg
KiBmb3IgdGhlIGRpc3BsYXkgcmVsYXRlZCBiaXRzLgogCQkgKi8KLQkJZ2VuOF9kZV9pcnFfaGFu
ZGxlcihpOTE1LCBkaXNwX2N0bCk7CisJCWdlbjhfZGVfaXJxX2FjayhpOTE1LCBkaXNwX2N0bCwg
JmRlLCAmcGNoKTsKIAkJZW5hYmxlX3JwbV93YWtlcmVmX2Fzc2VydHMoJmk5MTUtPnJ1bnRpbWVf
cG0pOwogCX0KIApAQCAtMzMzNSw2ICszNDY5LDE2IEBAIHN0YXRpYyBpcnFyZXR1cm5fdCBnZW4x
MV9pcnFfaGFuZGxlcihpbnQgaXJxLCB2b2lkICphcmcpCiAKIAlnZW4xMV9tYXN0ZXJfaW50cl9l
bmFibGUocmVncyk7CiAKKwlpZiAobWFzdGVyX2N0bCAmIEdFTjExX0RJU1BMQVlfSVJRKSB7CisJ
CWRpc2FibGVfcnBtX3dha2VyZWZfYXNzZXJ0cygmaTkxNS0+cnVudGltZV9wbSk7CisJCS8qCisJ
CSAqIEdFTjExX0RJU1BMQVlfSU5UX0NUTCBoYXMgc2FtZSBmb3JtYXQgYXMgR0VOOF9NQVNURVJf
SVJRCisJCSAqIGZvciB0aGUgZGlzcGxheSByZWxhdGVkIGJpdHMuCisJCSAqLworCQlnZW44X2Rl
X2lycV9oYW5kbGVyKGk5MTUsIGRpc3BfY3RsLCAmZGUsICZwY2gpOworCQllbmFibGVfcnBtX3dh
a2VyZWZfYXNzZXJ0cygmaTkxNS0+cnVudGltZV9wbSk7CisJfQorCiAJZ2VuMTFfZ3VfbWlzY19p
cnFfaGFuZGxlcihpOTE1LCBndV9taXNjX2lpcik7CiAKIAlyZXR1cm4gSVJRX0hBTkRMRUQ7Ci0t
IAoyLjIxLjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
CkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpo
dHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWdmeA==

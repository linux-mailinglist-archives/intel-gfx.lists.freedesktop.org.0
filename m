Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 88D93D6B76
	for <lists+intel-gfx@lfdr.de>; Tue, 15 Oct 2019 00:05:52 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 2A07089D30;
	Mon, 14 Oct 2019 22:05:48 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 4EC6189D2F
 for <intel-gfx@lists.freedesktop.org>; Mon, 14 Oct 2019 22:05:47 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18837432-1500050 
 for multiple; Mon, 14 Oct 2019 23:05:37 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 14 Oct 2019 23:05:31 +0100
Message-Id: <20191014220534.1662-7-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20191014220534.1662-1-chris@chris-wilson.co.uk>
References: <20191014220534.1662-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 07/10] drm/i915/gem: Cancel non-persistent
 contexts on close
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

Tm9ybWFsbHksIHdlIHJlbHkgb24gb3VyIGhhbmdjaGVjayB0byBwcmV2ZW50IHBlcnNpc3RlbnQg
YmF0Y2hlcyBmcm9tCmhvZ2dpbmcgdGhlIEdQVS4gSG93ZXZlciwgaWYgdGhlIHVzZXIgZGlzYWJs
ZXMgaGFuZ2NoZWNrLCB0aGlzIG1lY2hhbmlzbQpicmVha3MgZG93bi4gRGVzcGl0ZSBvdXIgaW5z
aXN0ZW5jZSB0aGF0IHRoaXMgaXMgdW5zYWZlLCB0aGUgdXNlcnMgYXJlCmVxdWFsbHkgaW5zaXN0
ZW50IHRoYXQgdGhleSB3YW50IHRvIHVzZSBlbmRsZXNzIGJhdGNoZXMgYW5kIHdpbGwgZGlzYWJs
ZQp0aGUgaGFuZ2NoZWNrIG1lY2hhbmlzbS4gV2UgYXJlIGxvb2tpbmcgYXQgcGVyaGFwcyByZXBs
YWNpbmcgaGFuZ2NoZWNrCndpdGggYSBzb2Z0ZXIgbWVjaGFuaXNtLCB0aGF0IHNlbmRzIGEgcHVs
c2UgZG93biB0aGUgZW5naW5lIHRvIGNoZWNrIGlmCml0IGlzIHdlbGwuIFdlIGNhbiB1c2UgdGhl
IHNhbWUgcHJlZW1wdGl2ZSBwdWxzZSB0byBmbHVzaCBhbiBhY3RpdmUKcGVyc2lzdGVudCBjb250
ZXh0IG9mZiB0aGUgR1BVIHVwb24gY29udGV4dCBjbG9zZSwgcHJldmVudGluZyByZXNvdXJjZXMK
YmVpbmcgbG9zdCBhbmQgdW5raWxsYWJsZSByZXF1ZXN0cyByZW1haW5pbmcgb24gdGhlIEdQVSBh
ZnRlciBwcm9jZXNzCnRlcm1pbmF0aW9uLiBUbyBhdm9pZCBjaGFuZ2luZyB0aGUgQUJJIGFuZCBh
Y2NpZGVudGFsbHkgYnJlYWtpbmcKZXhpc3RpbmcgdXNlcnNwYWNlLCB3ZSBtYWtlIHRoZSBwZXJz
aXN0ZW5jZSBvZiBhIGNvbnRleHQgZXhwbGljaXQgYW5kCmVuYWJsZSBpdCBieSBkZWZhdWx0ICht
YXRjaGluZyBjdXJyZW50IEFCSSkuIFVzZXJzcGFjZSBjYW4gb3B0IG91dCBvZgpwZXJzaXN0ZW50
IG1vZGUgKGZvcmNpbmcgcmVxdWVzdHMgdG8gYmUgY2FuY2VsbGVkIHdoZW4gdGhlIGNvbnRleHQg
aXMKY2xvc2VkIGJ5IHByb2Nlc3MgdGVybWluYXRpb24gb3IgZXhwbGljaXRseSkgYnkgYSBjb250
ZXh0IHBhcmFtZXRlci4gVG8KZmFjaWxpdGF0ZSBleGlzdGluZyB1c2UtY2FzZXMgb2YgZGlzYWJs
aW5nIGhhbmdjaGVjaywgaWYgdGhlIG1vZHBhcmFtIGlzCmRpc2FibGVkIChpOTE1LmVuYWJsZV9o
YW5nY2hlY2s9MCksIHdlIGRpc2FibGUgcGVyc2lzdGVuY2UgbW9kZSBieQpkZWZhdWx0LiAgKE5v
dGUsIG9uZSBvZiB0aGUgb3V0Y29tZXMgZm9yIHN1cHBvcnRpbmcgZW5kbGVzcyBtb2RlIHdpbGwg
YmUKdGhlIHJlbW92YWwgb2YgaGFuZ2NoZWNraW5nLCBhdCB3aGljaCBwb2ludCBvcHRpbmcgaW50
byBwZXJzaXN0ZW50IG1vZGUKd2lsbCBiZSBtYW5kYXRvcnksIG9yIG1heWJlIHRoZSBkZWZhdWx0
IHBlcmhhcHMgY29udHJvbGxlZCBieSBjZ3JvdXBzLikKCnYyOiBDaGVjayBmb3IgaGFuZ2NoZWNr
aW5nIGF0IGNvbnRleHQgdGVybWluYXRpb24sIHNvIHRoYXQgd2UgYXJlIG5vdApsZWZ0IHdpdGgg
dW5keWluZyBjb250ZXh0cyBmcm9tIGEgY3JhZnR5IHVzZXIuCnYzOiBGb3JjZSBjb250ZXh0IHRl
cm1pbmF0aW9uIGV2ZW4gaWYgZm9yY2VkLXByZWVtcHRpb24gaXMgZGlzYWJsZWQuCgpUZXN0Y2Fz
ZTogaWd0L2dlbV9jdHhfcGVyc2lzdGVuY2UKU2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxj
aHJpc0BjaHJpcy13aWxzb24uY28udWs+CkNjOiBKb29uYXMgTGFodGluZW4gPGpvb25hcy5sYWh0
aW5lbkBsaW51eC5pbnRlbC5jb20+CkNjOiBNaWNoYcWCIFdpbmlhcnNraSA8bWljaGFsLndpbmlh
cnNraUBpbnRlbC5jb20+CkNjOiBKb24gQmxvb21maWVsZCA8am9uLmJsb29tZmllbGRAaW50ZWwu
Y29tPgpSZXZpZXdlZC1ieTogSm9uIEJsb29tZmllbGQgPGpvbi5ibG9vbWZpZWxkQGludGVsLmNv
bT4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fY29udGV4dC5jICAgfCAx
ODkgKysrKysrKysrKysrKysrKysrCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1f
Y29udGV4dC5oICAgfCAgMTUgKysKIC4uLi9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRl
eHRfdHlwZXMuaCB8ICAgMSArCiAuLi4vZ3B1L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMvbW9ja19j
b250ZXh0LmMgfCAgIDIgKwogaW5jbHVkZS91YXBpL2RybS9pOTE1X2RybS5oICAgICAgICAgICAg
ICAgICAgIHwgIDE1ICsrCiA1IGZpbGVzIGNoYW5nZWQsIDIyMiBpbnNlcnRpb25zKCspCgpkaWZm
IC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRleHQuYyBiL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jb250ZXh0LmMKaW5kZXggNWQ4MjIxYzdi
YTgzLi40OWYzN2JiYTU2OTMgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9p
OTE1X2dlbV9jb250ZXh0LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2Vt
X2NvbnRleHQuYwpAQCAtNzAsNiArNzAsNyBAQAogI2luY2x1ZGUgPGRybS9pOTE1X2RybS5oPgog
CiAjaW5jbHVkZSAiZ3QvaW50ZWxfbHJjX3JlZy5oIgorI2luY2x1ZGUgImd0L2ludGVsX2VuZ2lu
ZV9oZWFydGJlYXQuaCIKICNpbmNsdWRlICJndC9pbnRlbF9lbmdpbmVfdXNlci5oIgogCiAjaW5j
bHVkZSAiaTkxNV9nZW1fY29udGV4dC5oIgpAQCAtMjY5LDYgKzI3MCwxMzUgQEAgdm9pZCBpOTE1
X2dlbV9jb250ZXh0X3JlbGVhc2Uoc3RydWN0IGtyZWYgKnJlZikKIAkJc2NoZWR1bGVfd29yaygm
Z2MtPmZyZWVfd29yayk7CiB9CiAKK3N0YXRpYyBpbmxpbmUgc3RydWN0IGk5MTVfZ2VtX2VuZ2lu
ZXMgKgorX19jb250ZXh0X2VuZ2luZXNfc3RhdGljKGNvbnN0IHN0cnVjdCBpOTE1X2dlbV9jb250
ZXh0ICpjdHgpCit7CisJcmV0dXJuIHJjdV9kZXJlZmVyZW5jZV9wcm90ZWN0ZWQoY3R4LT5lbmdp
bmVzLCB0cnVlKTsKK30KKworc3RhdGljIGJvb2wgX19yZXNldF9lbmdpbmUoc3RydWN0IGludGVs
X2VuZ2luZV9jcyAqZW5naW5lKQoreworCXN0cnVjdCBpbnRlbF9ndCAqZ3QgPSBlbmdpbmUtPmd0
OworCWJvb2wgc3VjY2VzcyA9IGZhbHNlOworCisJaWYgKCFpbnRlbF9oYXNfcmVzZXRfZW5naW5l
KGd0KSkKKwkJcmV0dXJuIGZhbHNlOworCisJaWYgKCF0ZXN0X2FuZF9zZXRfYml0KEk5MTVfUkVT
RVRfRU5HSU5FICsgZW5naW5lLT5pZCwKKwkJCSAgICAgICZndC0+cmVzZXQuZmxhZ3MpKSB7CisJ
CXN1Y2Nlc3MgPSBpbnRlbF9lbmdpbmVfcmVzZXQoZW5naW5lLCBOVUxMKSA9PSAwOworCQljbGVh
cl9hbmRfd2FrZV91cF9iaXQoSTkxNV9SRVNFVF9FTkdJTkUgKyBlbmdpbmUtPmlkLAorCQkJCSAg
ICAgICZndC0+cmVzZXQuZmxhZ3MpOworCX0KKworCXJldHVybiBzdWNjZXNzOworfQorCitzdGF0
aWMgdm9pZCBfX3Jlc2V0X2NvbnRleHQoc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCwKKwkJ
CSAgICBzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUpCit7CisJaW50ZWxfZ3RfaGFuZGxl
X2Vycm9yKGVuZ2luZS0+Z3QsIGVuZ2luZS0+bWFzaywgMCwKKwkJCSAgICAgICJjb250ZXh0IGNs
b3N1cmUgaW4gJXMiLCBjdHgtPm5hbWUpOworfQorCitzdGF0aWMgYm9vbCBfX2NhbmNlbF9lbmdp
bmUoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lKQoreworCS8qCisJICogU2VuZCBhICJo
aWdoIHByaW9yaXR5IHB1bHNlIiBkb3duIHRoZSBlbmdpbmUgdG8gY2F1c2UgdGhlCisJICogY3Vy
cmVudCByZXF1ZXN0IHRvIGJlIG1vbWVudGFyaWx5IHByZWVtcHRlZC4gKElmIGl0IGZhaWxzIHRv
CisJICogYmUgcHJlZW1wdGVkLCBpdCB3aWxsIGJlIHJlc2V0KS4gQXMgd2UgaGF2ZSBtYXJrZWQg
b3VyIGNvbnRleHQKKwkgKiBhcyBiYW5uZWQsIGFueSBpbmNvbXBsZXRlIHJlcXVlc3QsIGluY2x1
ZGluZyBhbnkgcnVubmluZywgd2lsbAorCSAqIGJlIHNraXBwZWQgZm9sbG93aW5nIHRoZSBwcmVl
bXB0aW9uLgorCSAqCisJICogSWYgdGhlcmUgaXMgbm8gaGFuZ2NoZWNraW5nIChvbmUgb2YgdGhl
IHJlYXNvbnMgd2h5IHdlIHRyeSB0bworCSAqIGNhbmNlbCB0aGUgY29udGV4dCkgYW5kIG5vIGZv
cmNlZCBwcmVlbXB0aW9uLCB0aGVyZSBtYXkgYmUgbm8KKwkgKiBtZWFucyBieSB3aGljaCB3ZSBy
ZXNldCB0aGUgR1BVIGFuZCBldmljdCB0aGUgcGVyc2lzdGVudCBob2cuCisJICogRXJnbyBpZiB3
ZSBhcmUgdW5hYmxlIHRvIGluamVjdCBhIHByZWVtcHRpdmUgcHVsc2UgdGhhdCBjYW4KKwkgKiBr
aWxsIHRoZSBiYW5uZWQgY29udGV4dCwgd2UgZmFsbGJhY2sgdG8gZG9pbmcgYSBsb2NhbCByZXNl
dAorCSAqIGluc3RlYWQuCisJICovCisJaWYgKENPTkZJR19EUk1fSTkxNV9QUkVFTVBUX1RJTUVP
VVQgJiYgIWludGVsX2VuZ2luZV9wdWxzZShlbmdpbmUpKQorCQlyZXR1cm4gdHJ1ZTsKKworCS8q
IElmIHdlIGFyZSB1bmFibGUgdG8gc2VuZCBhIHB1bHNlLCB0cnkgcmVzZXR0aW5nIHRoaXMgZW5n
aW5lLiAqLworCXJldHVybiBfX3Jlc2V0X2VuZ2luZShlbmdpbmUpOworfQorCitzdGF0aWMgc3Ry
dWN0IGludGVsX2VuZ2luZV9jcyAqCithY3RpdmVfZW5naW5lKHN0cnVjdCBkbWFfZmVuY2UgKmZl
bmNlLCBzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UpCit7CisJc3RydWN0IGk5MTVfcmVxdWVzdCAq
cnEgPSB0b19yZXF1ZXN0KGZlbmNlKTsKKwlzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUs
ICpsb2NrZWQ7CisKKwkvKgorCSAqIFNlcmlhbGlzZSB3aXRoIF9faTkxNV9yZXF1ZXN0X3N1Ym1p
dCgpIHNvIHRoYXQgaXQgc2VlcworCSAqIGlzLWJhbm5lZD8sIG9yIHdlIGtub3cgdGhlIHJlcXVl
c3QgaXMgYWxyZWFkeSBpbmZsaWdodC4KKwkgKi8KKwlsb2NrZWQgPSBSRUFEX09OQ0UocnEtPmVu
Z2luZSk7CisJc3Bpbl9sb2NrX2lycSgmbG9ja2VkLT5hY3RpdmUubG9jayk7CisJd2hpbGUgKHVu
bGlrZWx5KGxvY2tlZCAhPSAoZW5naW5lID0gUkVBRF9PTkNFKHJxLT5lbmdpbmUpKSkpIHsKKwkJ
c3Bpbl91bmxvY2soJmxvY2tlZC0+YWN0aXZlLmxvY2spOworCQlzcGluX2xvY2soJmVuZ2luZS0+
YWN0aXZlLmxvY2spOworCQlsb2NrZWQgPSBlbmdpbmU7CisJfQorCisJZW5naW5lID0gTlVMTDsK
KwlpZiAoaTkxNV9yZXF1ZXN0X2lzX2FjdGl2ZShycSkgJiYgIXJxLT5mZW5jZS5lcnJvcikKKwkJ
ZW5naW5lID0gcnEtPmVuZ2luZTsKKworCXNwaW5fdW5sb2NrX2lycSgmbG9ja2VkLT5hY3RpdmUu
bG9jayk7CisKKwlyZXR1cm4gZW5naW5lOworfQorCitzdGF0aWMgdm9pZCBraWxsX2NvbnRleHQo
c3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCkKK3sKKwlzdHJ1Y3QgaTkxNV9nZW1fZW5naW5l
c19pdGVyIGl0OworCXN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZTsKKworCS8qCisJICogSWYgd2Ug
YXJlIGFscmVhZHkgYmFubmVkLCBpdCB3YXMgZHVlIHRvIGEgZ3VpbHR5IHJlcXVlc3QgY2F1c2lu
ZworCSAqIGEgcmVzZXQgYW5kIHRoZSBlbnRpcmUgY29udGV4dCBiZWluZyBldmljdGVkIGZyb20g
dGhlIEdQVS4KKwkgKi8KKwlpZiAoaTkxNV9nZW1fY29udGV4dF9pc19iYW5uZWQoY3R4KSkKKwkJ
cmV0dXJuOworCisJaTkxNV9nZW1fY29udGV4dF9zZXRfYmFubmVkKGN0eCk7CisKKwkvKgorCSAq
IE1hcCB0aGUgdXNlcidzIGVuZ2luZSBiYWNrIHRvIHRoZSBhY3R1YWwgZW5naW5lczsgb25lIHZp
cnR1YWwKKwkgKiBlbmdpbmUgd2lsbCBiZSBtYXBwZWQgdG8gbXVsdGlwbGUgZW5naW5lcywgYW5k
IHVzaW5nIGN0eC0+ZW5naW5lW10KKwkgKiB0aGUgc2FtZSBlbmdpbmUgbWF5IGJlIGhhdmUgbXVs
dGlwbGUgaW5zdGFuY2VzIGluIHRoZSB1c2VyJ3MgbWFwLgorCSAqIEhvd2V2ZXIsIHdlIG9ubHkg
Y2FyZSBhYm91dCBwZW5kaW5nIHJlcXVlc3RzLCBzbyBvbmx5IGluY2x1ZGUKKwkgKiBlbmdpbmVz
IG9uIHdoaWNoIHRoZXJlIGFyZSBpbmNvbXBsZXRlIHJlcXVlc3RzLgorCSAqLworCWZvcl9lYWNo
X2dlbV9lbmdpbmUoY2UsIF9fY29udGV4dF9lbmdpbmVzX3N0YXRpYyhjdHgpLCBpdCkgeworCQlz
dHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmU7CisJCXN0cnVjdCBkbWFfZmVuY2UgKmZlbmNl
OworCisJCWlmICghY2UtPnRpbWVsaW5lKQorCQkJY29udGludWU7CisKKwkJZmVuY2UgPSBpOTE1
X2FjdGl2ZV9mZW5jZV9nZXQoJmNlLT50aW1lbGluZS0+bGFzdF9yZXF1ZXN0KTsKKwkJaWYgKCFm
ZW5jZSkKKwkJCWNvbnRpbnVlOworCisJCS8qIENoZWNrIHdpdGggdGhlIGJhY2tlbmQgaWYgdGhl
IHJlcXVlc3QgaXMgc3RpbGwgaW5mbGlnaHQgKi8KKwkJZW5naW5lID0gYWN0aXZlX2VuZ2luZShm
ZW5jZSwgY2UpOworCisJCS8qIEZpcnN0IGF0dGVtcHQgdG8gZ3JhY2VmdWxseSBjYW5jZWwgdGhl
IGNvbnRleHQgKi8KKwkJaWYgKGVuZ2luZSAmJiAhX19jYW5jZWxfZW5naW5lKGVuZ2luZSkpCisJ
CQkvKgorCQkJICogSWYgd2UgYXJlIHVuYWJsZSB0byBzZW5kIGEgcHJlZW1wdGl2ZSBwdWxzZSB0
byBidW1wCisJCQkgKiB0aGUgY29udGV4dCBmcm9tIHRoZSBHUFUsIHdlIGhhdmUgdG8gcmVzb3J0
IHRvIGEgZnVsbAorCQkJICogcmVzZXQuIFdlIGhvcGUgdGhlIGNvbGxhdGVyYWwgZGFtYWdlIGlz
IHdvcnRoIGl0LgorCQkJICovCisJCQlfX3Jlc2V0X2NvbnRleHQoY3R4LCBlbmdpbmUpOworCisJ
CWRtYV9mZW5jZV9wdXQoZmVuY2UpOworCX0KK30KKwogc3RhdGljIHZvaWQgY29udGV4dF9jbG9z
ZShzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4KQogewogCXN0cnVjdCBpOTE1X2FkZHJlc3Nf
c3BhY2UgKnZtOwpAQCAtMjkxLDkgKzQyMSw0NyBAQCBzdGF0aWMgdm9pZCBjb250ZXh0X2Nsb3Nl
KHN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICpjdHgpCiAJbHV0X2Nsb3NlKGN0eCk7CiAKIAltdXRl
eF91bmxvY2soJmN0eC0+bXV0ZXgpOworCisJLyoKKwkgKiBJZiB0aGUgdXNlciBoYXMgZGlzYWJs
ZWQgaGFuZ2NoZWNraW5nLCB3ZSBjYW4gbm90IGJlIHN1cmUgdGhhdAorCSAqIHRoZSBiYXRjaGVz
IHdpbGwgZXZlciBjb21wbGV0ZSBhZnRlciB0aGUgY29udGV4dCBpcyBjbG9zZWQsCisJICoga2Vl
cGluZyB0aGUgY29udGV4dCBhbmQgYWxsIHJlc291cmNlcyBwaW5uZWQgZm9yZXZlci4gU28gaW4g
dGhpcworCSAqIGNhc2Ugd2Ugb3B0IHRvIGZvcmNpYmx5IGtpbGwgb2ZmIGFsbCByZW1haW5pbmcg
cmVxdWVzdHMgb24KKwkgKiBjb250ZXh0IGNsb3NlLgorCSAqLworCWlmICghaTkxNV9nZW1fY29u
dGV4dF9pc19wZXJzaXN0ZW50KGN0eCkgfHwKKwkgICAgIWk5MTVfbW9kcGFyYW1zLmVuYWJsZV9o
YW5nY2hlY2spCisJCWtpbGxfY29udGV4dChjdHgpOworCiAJaTkxNV9nZW1fY29udGV4dF9wdXQo
Y3R4KTsKIH0KIAorc3RhdGljIGludCBfX2NvbnRleHRfc2V0X3BlcnNpc3RlbmNlKHN0cnVjdCBp
OTE1X2dlbV9jb250ZXh0ICpjdHgsIGJvb2wgc3RhdGUpCit7CisJaWYgKGk5MTVfZ2VtX2NvbnRl
eHRfaXNfcGVyc2lzdGVudChjdHgpID09IHN0YXRlKQorCQlyZXR1cm4gMDsKKworCWlmIChzdGF0
ZSkgeworCQkvKgorCQkgKiBPbmx5IGNvbnRleHRzIHRoYXQgYXJlIHNob3J0LWxpdmVkIFt0aGF0
IHdpbGwgZXhwaXJlIG9yIGJlCisJCSAqIHJlc2V0XSBhcmUgYWxsb3dlZCB0byBzdXJ2aXZlIHBh
c3QgdGVybWluYXRpb24uIFdlIHJlcXVpcmUKKwkJICogaGFuZ2NoZWNrIHRvIGVuc3VyZSB0aGF0
IHRoZSBwZXJzaXN0ZW50IHJlcXVlc3RzIGFyZSBoZWFsdGh5LgorCQkgKi8KKwkJaWYgKCFpOTE1
X21vZHBhcmFtcy5lbmFibGVfaGFuZ2NoZWNrKQorCQkJcmV0dXJuIC1FSU5WQUw7CisKKwkJaTkx
NV9nZW1fY29udGV4dF9zZXRfcGVyc2lzdGVuY2UoY3R4KTsKKwl9IGVsc2UgeworCQkvKiBUbyBj
YW5jZWwgYSBjb250ZXh0IHdlIHVzZSAicHJlZW1wdC10by1pZGxlIiAqLworCQlpZiAoIShjdHgt
Pmk5MTUtPmNhcHMuc2NoZWR1bGVyICYgSTkxNV9TQ0hFRFVMRVJfQ0FQX1BSRUVNUFRJT04pKQor
CQkJcmV0dXJuIC1FTk9ERVY7CisKKwkJaTkxNV9nZW1fY29udGV4dF9jbGVhcl9wZXJzaXN0ZW5j
ZShjdHgpOworCX0KKworCXJldHVybiAwOworfQorCiBzdGF0aWMgc3RydWN0IGk5MTVfZ2VtX2Nv
bnRleHQgKgogX19jcmVhdGVfY29udGV4dChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkK
IHsKQEAgLTMyOCw2ICs0OTYsNyBAQCBfX2NyZWF0ZV9jb250ZXh0KHN0cnVjdCBkcm1faTkxNV9w
cml2YXRlICppOTE1KQogCiAJaTkxNV9nZW1fY29udGV4dF9zZXRfYmFubmFibGUoY3R4KTsKIAlp
OTE1X2dlbV9jb250ZXh0X3NldF9yZWNvdmVyYWJsZShjdHgpOworCV9fY29udGV4dF9zZXRfcGVy
c2lzdGVuY2UoY3R4LCB0cnVlIC8qIGNncm91cCBob29rPyAqLyk7CiAKIAlmb3IgKGkgPSAwOyBp
IDwgQVJSQVlfU0laRShjdHgtPmhhbmdfdGltZXN0YW1wKTsgaSsrKQogCQljdHgtPmhhbmdfdGlt
ZXN0YW1wW2ldID0gamlmZmllcyAtIENPTlRFWFRfRkFTVF9IQU5HX0pJRkZJRVM7CkBAIC00ODQs
NiArNjUzLDcgQEAgaTkxNV9nZW1fY29udGV4dF9jcmVhdGVfa2VybmVsKHN0cnVjdCBkcm1faTkx
NV9wcml2YXRlICppOTE1LCBpbnQgcHJpbykKIAkJcmV0dXJuIGN0eDsKIAogCWk5MTVfZ2VtX2Nv
bnRleHRfY2xlYXJfYmFubmFibGUoY3R4KTsKKwlpOTE1X2dlbV9jb250ZXh0X3NldF9wZXJzaXN0
ZW5jZShjdHgpOwogCWN0eC0+c2NoZWQucHJpb3JpdHkgPSBJOTE1X1VTRVJfUFJJT1JJVFkocHJp
byk7CiAKIAlHRU1fQlVHX09OKCFpOTE1X2dlbV9jb250ZXh0X2lzX2tlcm5lbChjdHgpKTsKQEAg
LTE1OTQsNiArMTc2NCwxNiBAQCBnZXRfZW5naW5lcyhzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAq
Y3R4LAogCXJldHVybiBlcnI7CiB9CiAKK3N0YXRpYyBpbnQKK3NldF9wZXJzaXN0ZW5jZShzdHJ1
Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4LAorCQljb25zdCBzdHJ1Y3QgZHJtX2k5MTVfZ2VtX2Nv
bnRleHRfcGFyYW0gKmFyZ3MpCit7CisJaWYgKGFyZ3MtPnNpemUpCisJCXJldHVybiAtRUlOVkFM
OworCisJcmV0dXJuIF9fY29udGV4dF9zZXRfcGVyc2lzdGVuY2UoY3R4LCBhcmdzLT52YWx1ZSk7
Cit9CisKIHN0YXRpYyBpbnQgY3R4X3NldHBhcmFtKHN0cnVjdCBkcm1faTkxNV9maWxlX3ByaXZh
dGUgKmZwcml2LAogCQkJc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCwKIAkJCXN0cnVjdCBk
cm1faTkxNV9nZW1fY29udGV4dF9wYXJhbSAqYXJncykKQEAgLTE2NzEsNiArMTg1MSwxMCBAQCBz
dGF0aWMgaW50IGN0eF9zZXRwYXJhbShzdHJ1Y3QgZHJtX2k5MTVfZmlsZV9wcml2YXRlICpmcHJp
diwKIAkJcmV0ID0gc2V0X2VuZ2luZXMoY3R4LCBhcmdzKTsKIAkJYnJlYWs7CiAKKwljYXNlIEk5
MTVfQ09OVEVYVF9QQVJBTV9QRVJTSVNURU5DRToKKwkJcmV0ID0gc2V0X3BlcnNpc3RlbmNlKGN0
eCwgYXJncyk7CisJCWJyZWFrOworCiAJY2FzZSBJOTE1X0NPTlRFWFRfUEFSQU1fQkFOX1BFUklP
RDoKIAlkZWZhdWx0OgogCQlyZXQgPSAtRUlOVkFMOwpAQCAtMjEyMyw2ICsyMzA3LDExIEBAIGlu
dCBpOTE1X2dlbV9jb250ZXh0X2dldHBhcmFtX2lvY3RsKHN0cnVjdCBkcm1fZGV2aWNlICpkZXYs
IHZvaWQgKmRhdGEsCiAJCXJldCA9IGdldF9lbmdpbmVzKGN0eCwgYXJncyk7CiAJCWJyZWFrOwog
CisJY2FzZSBJOTE1X0NPTlRFWFRfUEFSQU1fUEVSU0lTVEVOQ0U6CisJCWFyZ3MtPnNpemUgPSAw
OworCQlhcmdzLT52YWx1ZSA9IGk5MTVfZ2VtX2NvbnRleHRfaXNfcGVyc2lzdGVudChjdHgpOwor
CQlicmVhazsKKwogCWNhc2UgSTkxNV9DT05URVhUX1BBUkFNX0JBTl9QRVJJT0Q6CiAJZGVmYXVs
dDoKIAkJcmV0ID0gLUVJTlZBTDsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dl
bS9pOTE1X2dlbV9jb250ZXh0LmggYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1f
Y29udGV4dC5oCmluZGV4IGNmZTgwNTkwZjBlZC4uMThlNTBhNzY5YTZlIDEwMDY0NAotLS0gYS9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fY29udGV4dC5oCisrKyBiL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jb250ZXh0LmgKQEAgLTc2LDYgKzc2LDIxIEBAIHN0
YXRpYyBpbmxpbmUgdm9pZCBpOTE1X2dlbV9jb250ZXh0X2NsZWFyX3JlY292ZXJhYmxlKHN0cnVj
dCBpOTE1X2dlbV9jb250ZXh0ICpjCiAJY2xlYXJfYml0KFVDT05URVhUX1JFQ09WRVJBQkxFLCAm
Y3R4LT51c2VyX2ZsYWdzKTsKIH0KIAorc3RhdGljIGlubGluZSBib29sIGk5MTVfZ2VtX2NvbnRl
eHRfaXNfcGVyc2lzdGVudChjb25zdCBzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4KQorewor
CXJldHVybiB0ZXN0X2JpdChVQ09OVEVYVF9QRVJTSVNURU5DRSwgJmN0eC0+dXNlcl9mbGFncyk7
Cit9CisKK3N0YXRpYyBpbmxpbmUgdm9pZCBpOTE1X2dlbV9jb250ZXh0X3NldF9wZXJzaXN0ZW5j
ZShzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4KQoreworCXNldF9iaXQoVUNPTlRFWFRfUEVS
U0lTVEVOQ0UsICZjdHgtPnVzZXJfZmxhZ3MpOworfQorCitzdGF0aWMgaW5saW5lIHZvaWQgaTkx
NV9nZW1fY29udGV4dF9jbGVhcl9wZXJzaXN0ZW5jZShzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAq
Y3R4KQoreworCWNsZWFyX2JpdChVQ09OVEVYVF9QRVJTSVNURU5DRSwgJmN0eC0+dXNlcl9mbGFn
cyk7Cit9CisKIHN0YXRpYyBpbmxpbmUgYm9vbCBpOTE1X2dlbV9jb250ZXh0X2lzX2Jhbm5lZChj
b25zdCBzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4KQogewogCXJldHVybiB0ZXN0X2JpdChD
T05URVhUX0JBTk5FRCwgJmN0eC0+ZmxhZ3MpOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJt
L2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRleHRfdHlwZXMuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2dlbS9pOTE1X2dlbV9jb250ZXh0X3R5cGVzLmgKaW5kZXggZmU5N2I4YmE0ZmRhLi44NjFkN2Q5
MmZlOWYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jb250
ZXh0X3R5cGVzLmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRl
eHRfdHlwZXMuaApAQCAtMTM3LDYgKzEzNyw3IEBAIHN0cnVjdCBpOTE1X2dlbV9jb250ZXh0IHsK
ICNkZWZpbmUgVUNPTlRFWFRfTk9fRVJST1JfQ0FQVFVSRQkxCiAjZGVmaW5lIFVDT05URVhUX0JB
Tk5BQkxFCQkyCiAjZGVmaW5lIFVDT05URVhUX1JFQ09WRVJBQkxFCQkzCisjZGVmaW5lIFVDT05U
RVhUX1BFUlNJU1RFTkNFCQk0CiAKIAkvKioKIAkgKiBAZmxhZ3M6IHNtYWxsIHNldCBvZiBib29s
ZWFucwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL3NlbGZ0ZXN0cy9tb2Nr
X2NvbnRleHQuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMvbW9ja19jb250
ZXh0LmMKaW5kZXggNzRkZGQ2ODJjOWNkLi4yOWI4OTg0ZjBlNDcgMTAwNjQ0Ci0tLSBhL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMvbW9ja19jb250ZXh0LmMKKysrIGIvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ2VtL3NlbGZ0ZXN0cy9tb2NrX2NvbnRleHQuYwpAQCAtMjIsNiArMjIs
OCBAQCBtb2NrX2NvbnRleHQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUsCiAJSU5JVF9M
SVNUX0hFQUQoJmN0eC0+bGluayk7CiAJY3R4LT5pOTE1ID0gaTkxNTsKIAorCWk5MTVfZ2VtX2Nv
bnRleHRfc2V0X3BlcnNpc3RlbmNlKGN0eCk7CisKIAltdXRleF9pbml0KCZjdHgtPmVuZ2luZXNf
bXV0ZXgpOwogCWUgPSBkZWZhdWx0X2VuZ2luZXMoY3R4KTsKIAlpZiAoSVNfRVJSKGUpKQpkaWZm
IC0tZ2l0IGEvaW5jbHVkZS91YXBpL2RybS9pOTE1X2RybS5oIGIvaW5jbHVkZS91YXBpL2RybS9p
OTE1X2RybS5oCmluZGV4IDYzZDQwY2JhOTdlMC4uYjVmZDVlNGJkMTZlIDEwMDY0NAotLS0gYS9p
bmNsdWRlL3VhcGkvZHJtL2k5MTVfZHJtLmgKKysrIGIvaW5jbHVkZS91YXBpL2RybS9pOTE1X2Ry
bS5oCkBAIC0xNTcyLDYgKzE1NzIsMjEgQEAgc3RydWN0IGRybV9pOTE1X2dlbV9jb250ZXh0X3Bh
cmFtIHsKICAqICAgaTkxNV9jb250ZXh0X2VuZ2luZXNfYm9uZCAoSTkxNV9DT05URVhUX0VOR0lO
RVNfRVhUX0JPTkQpCiAgKi8KICNkZWZpbmUgSTkxNV9DT05URVhUX1BBUkFNX0VOR0lORVMJMHhh
CisKKy8qCisgKiBJOTE1X0NPTlRFWFRfUEFSQU1fUEVSU0lTVEVOQ0U6CisgKgorICogQWxsb3cg
dGhlIGNvbnRleHQgYW5kIGFjdGl2ZSByZW5kZXJpbmcgdG8gc3Vydml2ZSB0aGUgcHJvY2VzcyB1
bnRpbAorICogY29tcGxldGlvbi4gUGVyc2lzdGVuY2UgYWxsb3dzIGZpcmUtYW5kLWZvcmdldCBj
bGllbnRzIHRvIHF1ZXVlIHVwIGEKKyAqIGJ1bmNoIG9mIHdvcmssIGhhbmQgdGhlIG91dHB1dCBv
dmVyIHRvIGEgZGlzcGxheSBzZXJ2ZXIgYW5kIHRoZSBxdWl0LgorICogSWYgdGhlIGNvbnRleHQg
aXMgbm90IG1hcmtlZCBhcyBwZXJzaXN0ZW50LCB1cG9uIGNsb3NpbmcgKGVpdGhlciB2aWEKKyAq
IGFuIGV4cGxpY2l0IERSTV9JOTE1X0dFTV9DT05URVhUX0RFU1RST1kgb3IgaW1wbGljaXRseSBm
cm9tIGZpbGUgY2xvc3VyZQorICogb3IgcHJvY2VzcyB0ZXJtaW5hdGlvbiksIHRoZSBjb250ZXh0
IGFuZCBhbnkgb3V0c3RhbmRpbmcgcmVxdWVzdHMgd2lsbCBiZQorICogY2FuY2VsbGVkIChhbmQg
ZXhwb3J0ZWQgZmVuY2VzIGZvciBjYW5jZWxsZWQgcmVxdWVzdHMgbWFya2VkIGFzIC1FSU8pLgor
ICoKKyAqIEJ5IGRlZmF1bHQsIG5ldyBjb250ZXh0cyBhbGxvdyBwZXJzaXN0ZW5jZS4KKyAqLwor
I2RlZmluZSBJOTE1X0NPTlRFWFRfUEFSQU1fUEVSU0lTVEVOQ0UJMHhiCiAvKiBNdXN0IGJlIGtl
cHQgY29tcGFjdCAtLSBubyBob2xlcyBhbmQgd2VsbCBkb2N1bWVudGVkICovCiAKIAlfX3U2NCB2
YWx1ZTsKLS0gCjIuMjMuMAoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0
b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50
ZWwtZ2Z4

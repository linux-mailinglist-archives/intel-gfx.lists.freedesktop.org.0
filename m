Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 450146541E
	for <lists+intel-gfx@lfdr.de>; Thu, 11 Jul 2019 11:46:59 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id B81006E17C;
	Thu, 11 Jul 2019 09:46:56 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mga14.intel.com (mga14.intel.com [192.55.52.115])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 0D3FE6E179
 for <intel-gfx@lists.freedesktop.org>; Thu, 11 Jul 2019 09:46:52 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from fmsmga002.fm.intel.com ([10.253.24.26])
 by fmsmga103.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 11 Jul 2019 02:46:51 -0700
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.63,478,1557212400"; d="scan'208";a="193346431"
Received: from amahmed2-mobl1.ger.corp.intel.com (HELO
 delly.ger.corp.intel.com) ([10.252.49.213])
 by fmsmga002.fm.intel.com with ESMTP; 11 Jul 2019 02:46:50 -0700
From: Lionel Landwerlin <lionel.g.landwerlin@intel.com>
To: intel-gfx@lists.freedesktop.org
Date: Thu, 11 Jul 2019 12:46:37 +0300
Message-Id: <20190711094638.8022-9-lionel.g.landwerlin@intel.com>
X-Mailer: git-send-email 2.22.0
In-Reply-To: <20190711094638.8022-1-lionel.g.landwerlin@intel.com>
References: <20190711094638.8022-1-lionel.g.landwerlin@intel.com>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v9 8/9] drm/i915/perf: execute OA configuration
 from command stream
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

V2UgaGF2ZW4ndCBydW4gaW50byBpc3N1ZXMgd2l0aCBwcm9ncmFtbWluZyB0aGUgZ2xvYmFsIE9B
L05PQQpyZWdpc3RlcnMgY29uZmlndXJhdGlvbiBmcm9tIENQVSBzbyBmYXIsIGJ1dCBIVyBlbmdp
bmVlcnMgYWN0dWFsbHkKcmVjb21tZW5kIGRvaW5nIHRoaXMgZnJvbSB0aGUgY29tbWFuZCBzdHJl
YW1lci4gT24gVEdMIGluIHBhcnRpY3VsYXIKb25lIG9mIHRoZSBjbG9jayBkb21haW4gaW4gd2hp
Y2ggc29tZSBvZiB0aGF0IHByb2dyYW1taW5nIGdvZXMgbWlnaHQKbm90IGJlIHBvd2VyZWQgd2hl
biB3ZSBwb2tlIHRoaW5ncyBmcm9tIHRoZSBDUFUuCgpTaW5jZSB3ZSBoYXZlIGEgY29tbWFuZCBi
dWZmZXIgcHJlcGFyZWQgZm9yIHRoZSBleGVjYnVmZmVyIHNpZGUgb2YKdGhpbmdzLCB3ZSBjYW4g
cmV1c2UgdGhhdCBhcHByb2FjaCBoZXJlIHRvby4KClRoaXMgYWxzbyBhbGxvd3MgdXMgdG8gc2ln
bmlmaWNhbnRseSByZWR1Y2UgdGhlIGFtb3VudCBvZiB0aW1lIHdlIGhvbGQKdGhlIG1haW4gbG9j
ay4KCnYyOiBEcm9wIHRoZSBnbG9iYWwgbG9jayBhcyBtdWNoIGFzIHBvc3NpYmxlCgp2MzogVGFr
ZSBnbG9iYWwgbG9jayB0byBwaW4gZ2xvYmFsCgpTaWduZWQtb2ZmLWJ5OiBMaW9uZWwgTGFuZHdl
cmxpbiA8bGlvbmVsLmcubGFuZHdlcmxpbkBpbnRlbC5jb20+Ci0tLQogZHJpdmVycy9ncHUvZHJt
L2k5MTUvaTkxNV9kcnYuaCAgfCAgIDcgKwogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wZXJm
LmMgfCAyNDggKysrKysrKysrKysrKysrKysrKystLS0tLS0tLS0tLQogMiBmaWxlcyBjaGFuZ2Vk
LCAxNjYgaW5zZXJ0aW9ucygrKSwgODkgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZHJ2
LmgKaW5kZXggZGMwZTQ5ODJjNjcyLi5jNzJlN2M3NDZiNTcgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2k5MTVfZHJ2LmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9k
cnYuaApAQCAtMTIwNSw2ICsxMjA1LDEzIEBAIHN0cnVjdCBpOTE1X3BlcmZfc3RyZWFtIHsKIAkg
Ki8KIAlpbnRlbF93YWtlcmVmX3Qgd2FrZXJlZjsKIAorCS8qKgorCSAqIEBpbml0aWFsX2NvbmZp
Z19ycTogRmlyc3QgcmVxdWVzdCBydW4gYXQgdGhlIG9wZW5pbmcgb2YgdGhlIGk5MTUKKwkgKiBw
ZXJmIHN0cmVhbSB0byBjb25maWd1cmUgdGhlIEhXLiBTaG91bGQgYmUgTlVMTCBhZnRlciB0aGUg
cGVyZgorCSAqIHN0cmVhbSBoYXMgYmVlbiBvcGVuZWQgc3VjY2Vzc2Z1bGx5LgorCSAqLworCXN0
cnVjdCBpOTE1X3JlcXVlc3QgKmluaXRpYWxfY29uZmlnX3JxOworCiAJLyoqCiAJICogQHNhbXBs
ZV9mbGFnczogRmxhZ3MgcmVwcmVzZW50aW5nIHRoZSBgRFJNX0k5MTVfUEVSRl9QUk9QX1NBTVBM
RV8qYAogCSAqIHByb3BlcnRpZXMgZ2l2ZW4gd2hlbiBvcGVuaW5nIGEgc3RyZWFtLCByZXByZXNl
bnRpbmcgdGhlIGNvbnRlbnRzCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1
X3BlcmYuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcGVyZi5jCmluZGV4IDI2ZmQxNTc5
NDM5Ni4uZDI5MTUyOWI5MmY3IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1
X3BlcmYuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3BlcmYuYwpAQCAtMzkyLDYg
KzM5MiwxOSBAQCB2b2lkIGk5MTVfb2FfY29uZmlnX3JlbGVhc2Uoc3RydWN0IGtyZWYgKnJlZikK
IAlrZnJlZShvYV9jb25maWcpOwogfQogCitzdGF0aWMgdm9pZCBpOTE1X29hX2NvbmZpZ19kaXNw
b3NlX2J1ZmZlcnMoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCit7CisJc3RydWN0IGk5
MTVfb2FfY29uZmlnICpvYV9jb25maWcsICpuZXh0OworCisJbXV0ZXhfbG9jaygmaTkxNS0+cGVy
Zi5tZXRyaWNzX2xvY2spOworCWxpc3RfZm9yX2VhY2hfZW50cnlfc2FmZShvYV9jb25maWcsIG5l
eHQsICZpOTE1LT5wZXJmLm1ldHJpY3NfYnVmZmVycywgdm1hX2xpbmspIHsKKwkJbGlzdF9kZWwo
Jm9hX2NvbmZpZy0+dm1hX2xpbmspOworCQlpOTE1X2dlbV9vYmplY3RfcHV0KG9hX2NvbmZpZy0+
b2JqKTsKKwkJb2FfY29uZmlnLT5vYmogPSBOVUxMOworCX0KKwltdXRleF91bmxvY2soJmk5MTUt
PnBlcmYubWV0cmljc19sb2NrKTsKK30KKwogc3RhdGljIHUzMiAqd3JpdGVfY3NfbWlfbHJpKHUz
MiAqY3MsIGNvbnN0IHN0cnVjdCBpOTE1X29hX3JlZyAqcmVnX2RhdGEsIHUzMiBuX3JlZ3MpCiB7
CiAJdTMyIGk7CkBAIC0xNDQ5LDYgKzE0NjIsMTQgQEAgc3RhdGljIHZvaWQgb2FfcHV0X3JlbmRl
cl9jdHhfaWQoc3RydWN0IGk5MTVfcGVyZl9zdHJlYW0gKnN0cmVhbSkKIAl9CiB9CiAKK3N0YXRp
YyB2b2lkIGZyZWVfbm9hX3dhaXQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCit7CisJ
bXV0ZXhfbG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CisJaTkxNV92bWFfdW5waW5fYW5k
X3JlbGVhc2UoJmk5MTUtPnBlcmYub2Eubm9hX3dhaXQsCisJCQkJICAgSTkxNV9WTUFfUkVMRUFT
RV9NQVApOworCW11dGV4X3VubG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7Cit9CisKIHN0
YXRpYyB2b2lkCiBmcmVlX29hX2J1ZmZlcihzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkK
IHsKQEAgLTE0NjgsMTYgKzE0ODksMTcgQEAgc3RhdGljIHZvaWQgaTkxNV9vYV9zdHJlYW1fZGVz
dHJveShzdHJ1Y3QgaTkxNV9wZXJmX3N0cmVhbSAqc3RyZWFtKQogCiAJQlVHX09OKHN0cmVhbSAh
PSBkZXZfcHJpdi0+cGVyZi5vYS5leGNsdXNpdmVfc3RyZWFtKTsKIAorCWRldl9wcml2LT5wZXJm
Lm9hLm9wcy5kaXNhYmxlX21ldHJpY19zZXQoZGV2X3ByaXYpOworCiAJLyoKIAkgKiBVbnNldCBl
eGNsdXNpdmVfc3RyZWFtIGZpcnN0LCBpdCB3aWxsIGJlIGNoZWNrZWQgd2hpbGUgZGlzYWJsaW5n
CiAJICogdGhlIG1ldHJpYyBzZXQgb24gZ2VuOCsuCiAJICovCiAJbXV0ZXhfbG9jaygmZGV2X3By
aXYtPmRybS5zdHJ1Y3RfbXV0ZXgpOwogCWRldl9wcml2LT5wZXJmLm9hLmV4Y2x1c2l2ZV9zdHJl
YW0gPSBOVUxMOwotCWRldl9wcml2LT5wZXJmLm9hLm9wcy5kaXNhYmxlX21ldHJpY19zZXQoZGV2
X3ByaXYpOwotCWk5MTVfdm1hX3VucGluX2FuZF9yZWxlYXNlKCZkZXZfcHJpdi0+cGVyZi5vYS5u
b2Ffd2FpdCwgMCk7CiAJbXV0ZXhfdW5sb2NrKCZkZXZfcHJpdi0+ZHJtLnN0cnVjdF9tdXRleCk7
CiAKKwlmcmVlX25vYV93YWl0KGRldl9wcml2KTsKIAlmcmVlX29hX2J1ZmZlcihkZXZfcHJpdik7
CiAKIAlpbnRlbF91bmNvcmVfZm9yY2V3YWtlX3B1dCgmZGV2X3ByaXYtPnVuY29yZSwgRk9SQ0VX
QUtFX0FMTCk7CkBAIC0xNzA1LDYgKzE3MjcsMTAgQEAgc3RhdGljIGludCBhbGxvY19ub2Ffd2Fp
dChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKIAkJcmV0dXJuIFBUUl9FUlIoYm8pOwog
CX0KIAorCXJldCA9IGk5MTVfbXV0ZXhfbG9ja19pbnRlcnJ1cHRpYmxlKCZpOTE1LT5kcm0pOwor
CWlmIChyZXQpCisJCWdvdG8gZXJyX3VucmVmOworCiAJLyoKIAkgKiBXZSBwaW4gaW4gR0dUVCBi
ZWNhdXNlIHdlIGp1bXAgaW50byB0aGlzIGJ1ZmZlciBub3cgYmVjYXVzZQogCSAqIG11bHRpcGxl
IE9BIGNvbmZpZyBCT3Mgd2lsbCBoYXZlIGEganVtcCB0byB0aGlzIGFkZHJlc3MgYW5kIGl0CkBA
IC0xNzEyLDEwICsxNzM4LDEzIEBAIHN0YXRpYyBpbnQgYWxsb2Nfbm9hX3dhaXQoc3RydWN0IGRy
bV9pOTE1X3ByaXZhdGUgKmk5MTUpCiAJICovCiAJdm1hID0gaTkxNV9nZW1fb2JqZWN0X2dndHRf
cGluKGJvLCBOVUxMLCAwLCA0MDk2LCAwKTsKIAlpZiAoSVNfRVJSKHZtYSkpIHsKKwkJbXV0ZXhf
dW5sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKIAkJcmV0ID0gUFRSX0VSUih2bWEpOwog
CQlnb3RvIGVycl91bnJlZjsKIAl9CiAKKwltdXRleF91bmxvY2soJmk5MTUtPmRybS5zdHJ1Y3Rf
bXV0ZXgpOworCiAJYmF0Y2ggPSBjcyA9IGk5MTVfZ2VtX29iamVjdF9waW5fbWFwKGJvLCBJOTE1
X01BUF9XQik7CiAJaWYgKElTX0VSUihiYXRjaCkpIHsKIAkJcmV0ID0gUFRSX0VSUihiYXRjaCk7
CkBAIC0xODQ5LDcgKzE4NzgsMTEgQEAgc3RhdGljIGludCBhbGxvY19ub2Ffd2FpdChzdHJ1Y3Qg
ZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKIAlyZXR1cm4gMDsKIAogZXJyX3VucGluOgotCV9faTkx
NV92bWFfdW5waW4odm1hKTsKKwltdXRleF9sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsK
KwlpOTE1X3ZtYV91bnBpbl9hbmRfcmVsZWFzZSgmaTkxNS0+cGVyZi5vYS5ub2Ffd2FpdCwgMCk7
CisJbXV0ZXhfdW5sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKKworCXJldHVybiByZXQ7
CiAKIGVycl91bnJlZjoKIAlpOTE1X2dlbV9vYmplY3RfcHV0KGJvKTsKQEAgLTE4NTcsNTAgKzE4
OTAsNjEgQEAgc3RhdGljIGludCBhbGxvY19ub2Ffd2FpdChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0
ZSAqaTkxNSkKIAlyZXR1cm4gcmV0OwogfQogCi1zdGF0aWMgdm9pZCBjb25maWdfb2FfcmVncyhz
dHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYsCi0JCQkgICBjb25zdCBzdHJ1Y3QgaTkx
NV9vYV9yZWcgKnJlZ3MsCi0JCQkgICB1MzIgbl9yZWdzKQorc3RhdGljIGludCBlbWl0X29hX2Nv
bmZpZyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSwKKwkJCSAgc3RydWN0IGk5MTVfcGVy
Zl9zdHJlYW0gKnN0cmVhbSkKIHsKLQl1MzIgaTsKKwlzdHJ1Y3QgaTkxNV9vYV9jb25maWcgKm9h
X2NvbmZpZyA9IHN0cmVhbS0+b2FfY29uZmlnOworCXN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxID0g
c3RyZWFtLT5pbml0aWFsX2NvbmZpZ19ycTsKKwlzdHJ1Y3QgaTkxNV92bWEgKnZtYTsKKwl1MzIg
KmNzOworCWludCBlcnI7CiAKLQlmb3IgKGkgPSAwOyBpIDwgbl9yZWdzOyBpKyspIHsKLQkJY29u
c3Qgc3RydWN0IGk5MTVfb2FfcmVnICpyZWcgPSByZWdzICsgaTsKKwl2bWEgPSBpOTE1X3ZtYV9p
bnN0YW5jZShvYV9jb25maWctPm9iaiwgJmk5MTUtPmdndHQudm0sIE5VTEwpOworCWlmICh1bmxp
a2VseShJU19FUlIodm1hKSkpCisJCXJldHVybiBQVFJfRVJSKHZtYSk7CiAKLQkJSTkxNV9XUklU
RShyZWctPmFkZHIsIHJlZy0+dmFsdWUpOworCWVyciA9IGk5MTVfbXV0ZXhfbG9ja19pbnRlcnJ1
cHRpYmxlKCZpOTE1LT5kcm0pOworCWlmIChlcnIpCisJCXJldHVybiBlcnI7CisKKwllcnIgPSBp
OTE1X3ZtYV9waW4odm1hLCAwLCAwLCBQSU5fR0xPQkFMKTsKKwlpZiAoZXJyKQorCQlyZXR1cm4g
ZXJyOworCisJbXV0ZXhfdW5sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKKworCWVyciA9
IGk5MTVfdm1hX21vdmVfdG9fYWN0aXZlKHZtYSwgcnEsIDApOworCWlmIChlcnIpIHsKKwkJaTkx
NV92bWFfdW5waW4odm1hKTsKKwkJcmV0dXJuIGVycjsKIAl9Ci19CiAKLXN0YXRpYyB2b2lkIGRl
bGF5X2FmdGVyX211eCh2b2lkKQotewotCS8qCi0JICogSXQgYXBwYXJlbnRseSB0YWtlcyBhIGZh
aXJseSBsb25nIHRpbWUgZm9yIGEgbmV3IE1VWAotCSAqIGNvbmZpZ3VyYXRpb24gdG8gYmUgYmUg
YXBwbGllZCBhZnRlciB0aGVzZSByZWdpc3RlciB3cml0ZXMuCi0JICogVGhpcyBkZWxheSBkdXJh
dGlvbiB3YXMgZGVyaXZlZCBlbXBpcmljYWxseSBiYXNlZCBvbiB0aGUKLQkgKiByZW5kZXJfYmFz
aWMgY29uZmlnIGJ1dCBob3BlZnVsbHkgaXQgY292ZXJzIHRoZSBtYXhpbXVtCi0JICogY29uZmln
dXJhdGlvbiBsYXRlbmN5LgotCSAqCi0JICogQXMgYSBmYWxsYmFjaywgdGhlIGNoZWNrcyBpbiBf
YXBwZW5kX29hX3JlcG9ydHMoKSB0byBza2lwCi0JICogaW52YWxpZCBPQSByZXBvcnRzIGRvIGFs
c28gc2VlbSB0byB3b3JrIHRvIGRpc2NhcmQgcmVwb3J0cwotCSAqIGdlbmVyYXRlZCBiZWZvcmUg
dGhpcyBjb25maWcgaGFzIGNvbXBsZXRlZCAtIGFsYmVpdCBub3QKLQkgKiBzaWxlbnRseS4KLQkg
KgotCSAqIFVuZm9ydHVuYXRlbHkgdGhpcyBpcyBlc3NlbnRpYWxseSBhIG1hZ2ljIG51bWJlciwg
c2luY2Ugd2UKLQkgKiBkb24ndCBjdXJyZW50bHkga25vdyBvZiBhIHJlbGlhYmxlIG1lY2hhbmlz
bSBmb3IgcHJlZGljdGluZwotCSAqIGhvdyBsb25nIHRoZSBNVVggY29uZmlnIHdpbGwgdGFrZSB0
byBhcHBseSBhbmQgYmVzaWRlcwotCSAqIHNlZWluZyBpbnZhbGlkIHJlcG9ydHMgd2UgZG9uJ3Qg
a25vdyBvZiBhIHJlbGlhYmxlIHdheSB0bwotCSAqIGV4cGxpY2l0bHkgY2hlY2sgdGhhdCB0aGUg
TVVYIGNvbmZpZyBoYXMgbGFuZGVkLgotCSAqCi0JICogSXQncyBldmVuIHBvc3NpYmxlIHdlJ3Zl
IG1pc3MgY2hhcmFjdGVyaXplZCB0aGUgdW5kZXJseWluZwotCSAqIHByb2JsZW0gLSBpdCBqdXN0
IHNlZW1zIGxpa2UgdGhlIHNpbXBsZXN0IGV4cGxhbmF0aW9uIHdoeQotCSAqIGEgZGVsYXkgYXQg
dGhpcyBsb2NhdGlvbiB3b3VsZCBtaXRpZ2F0ZSBhbnkgaW52YWxpZCByZXBvcnRzLgotCSAqLwot
CXVzbGVlcF9yYW5nZSgxNTAwMCwgMjAwMDApOworCWNzID0gaW50ZWxfcmluZ19iZWdpbihycSwg
SU5URUxfR0VOKGk5MTUpID49IDggPyA0IDogMik7CisJaWYgKElTX0VSUihjcykpIHsKKwkJaTkx
NV92bWFfdW5waW4odm1hKTsKKwkJcmV0dXJuIFBUUl9FUlIoY3MpOworCX0KKworCWlmIChJTlRF
TF9HRU4oaTkxNSkgPiA4KSB7CisJCSpjcysrID0gTUlfQkFUQ0hfQlVGRkVSX1NUQVJUX0dFTjg7
CisJCSpjcysrID0gbG93ZXJfMzJfYml0cyh2bWEtPm5vZGUuc3RhcnQpOworCQkqY3MrKyA9IHVw
cGVyXzMyX2JpdHModm1hLT5ub2RlLnN0YXJ0KTsKKwkJKmNzKysgPSBNSV9OT09QOworCX0gZWxz
ZSB7CisJCSpjcysrID0gTUlfQkFUQ0hfQlVGRkVSX1NUQVJUOworCQkqY3MrKyA9IHZtYS0+bm9k
ZS5zdGFydDsKKwl9CisKKwlpbnRlbF9yaW5nX2FkdmFuY2UocnEsIGNzKTsKKworCWk5MTVfdm1h
X3VucGluKHZtYSk7CisKKwlyZXR1cm4gMDsKIH0KIAogc3RhdGljIGludCBoc3dfZW5hYmxlX21l
dHJpY19zZXQoc3RydWN0IGk5MTVfcGVyZl9zdHJlYW0gKnN0cmVhbSkKIHsKIAlzdHJ1Y3QgZHJt
X2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYgPSBzdHJlYW0tPmRldl9wcml2OwotCWNvbnN0IHN0cnVj
dCBpOTE1X29hX2NvbmZpZyAqb2FfY29uZmlnID0gc3RyZWFtLT5vYV9jb25maWc7CiAKIAkvKgog
CSAqIFBSTToKQEAgLTE5MTcsMTMgKzE5NjEsNyBAQCBzdGF0aWMgaW50IGhzd19lbmFibGVfbWV0
cmljX3NldChzdHJ1Y3QgaTkxNV9wZXJmX3N0cmVhbSAqc3RyZWFtKQogCUk5MTVfV1JJVEUoR0VO
Nl9VQ0dDVEwxLCAoSTkxNV9SRUFEKEdFTjZfVUNHQ1RMMSkgfAogCQkJCSAgR0VONl9DU1VOSVRf
Q0xPQ0tfR0FURV9ESVNBQkxFKSk7CiAKLQljb25maWdfb2FfcmVncyhkZXZfcHJpdiwgb2FfY29u
ZmlnLT5tdXhfcmVncywgb2FfY29uZmlnLT5tdXhfcmVnc19sZW4pOwotCWRlbGF5X2FmdGVyX211
eCgpOwotCi0JY29uZmlnX29hX3JlZ3MoZGV2X3ByaXYsIG9hX2NvbmZpZy0+Yl9jb3VudGVyX3Jl
Z3MsCi0JCSAgICAgICBvYV9jb25maWctPmJfY291bnRlcl9yZWdzX2xlbik7Ci0KLQlyZXR1cm4g
MDsKKwlyZXR1cm4gZW1pdF9vYV9jb25maWcoZGV2X3ByaXYsIHN0cmVhbSk7CiB9CiAKIHN0YXRp
YyB2b2lkIGhzd19kaXNhYmxlX21ldHJpY19zZXQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRl
dl9wcml2KQpAQCAtMjAyOCwxMCArMjA2NiwxOCBAQCBzdGF0aWMgaW50IGdlbjhfY29uZmlndXJl
X2FsbF9jb250ZXh0cyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYsCiB7CiAJdW5z
aWduZWQgaW50IG1hcF90eXBlID0gaTkxNV9jb2hlcmVudF9tYXBfdHlwZShkZXZfcHJpdik7CiAJ
c3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eDsKLQlzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycTsK
IAlpbnQgcmV0OwogCi0JbG9ja2RlcF9hc3NlcnRfaGVsZCgmZGV2X3ByaXYtPmRybS5zdHJ1Y3Rf
bXV0ZXgpOworCS8qIFdoZW4gY2FsbGluZyB3aXRob3V0IGEgY29uZmlndXJhdGlvbiwgd2UncmUg
dGVhcmluZyBkb3duIHRoZSBpOTE1CisJICogcGVyZiBzdHJlYW0uIERvbid0IGJlIGludGVycnVw
dGlibGUgaW4gdGhhdCBjYXNlLgorCSAqLworCWlmIChvYV9jb25maWcpIHsKKwkJcmV0ID0gaTkx
NV9tdXRleF9sb2NrX2ludGVycnVwdGlibGUoJmRldl9wcml2LT5kcm0pOworCQlpZiAocmV0KQor
CQkJcmV0dXJuIHJldDsKKwl9IGVsc2UgeworCQltdXRleF9sb2NrKCZkZXZfcHJpdi0+ZHJtLnN0
cnVjdF9tdXRleCk7CisJfQogCiAJLyoKIAkgKiBUaGUgT0EgcmVnaXN0ZXIgY29uZmlnIGlzIHNl
dHVwIHRocm91Z2ggdGhlIGNvbnRleHQgaW1hZ2UuIFRoaXMgaW1hZ2UKQEAgLTIwNTAsNyArMjA5
Niw3IEBAIHN0YXRpYyBpbnQgZ2VuOF9jb25maWd1cmVfYWxsX2NvbnRleHRzKHN0cnVjdCBkcm1f
aTkxNV9wcml2YXRlICpkZXZfcHJpdiwKIAkJCQkgICAgIEk5MTVfV0FJVF9MT0NLRUQsCiAJCQkJ
ICAgICBNQVhfU0NIRURVTEVfVElNRU9VVCk7CiAJaWYgKHJldCkKLQkJcmV0dXJuIHJldDsKKwkJ
Z290byB1bmxvY2s7CiAKIAkvKiBVcGRhdGUgYWxsIGNvbnRleHRzIG5vdyB0aGF0IHdlJ3ZlIHN0
YWxsZWQgdGhlIHN1Ym1pc3Npb24uICovCiAJbGlzdF9mb3JfZWFjaF9lbnRyeShjdHgsICZkZXZf
cHJpdi0+Y29udGV4dHMubGlzdCwgbGluaykgewpAQCAtMjA3Myw3ICsyMTE5LDggQEAgc3RhdGlj
IGludCBnZW44X2NvbmZpZ3VyZV9hbGxfY29udGV4dHMoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUg
KmRldl9wcml2LAogCQkJCQkJICAgICAgIG1hcF90eXBlKTsKIAkJCWlmIChJU19FUlIocmVncykp
IHsKIAkJCQlpOTE1X2dlbV9jb250ZXh0X3VubG9ja19lbmdpbmVzKGN0eCk7Ci0JCQkJcmV0dXJu
IFBUUl9FUlIocmVncyk7CisJCQkJcmV0ID0gUFRSX0VSUihyZWdzKTsKKwkJCQlnb3RvIHVubG9j
azsKIAkJCX0KIAogCQkJY2UtPnN0YXRlLT5vYmotPm1tLmRpcnR5ID0gdHJ1ZTsKQEAgLTIwODcs
MTYgKzIxMzQsMTQgQEAgc3RhdGljIGludCBnZW44X2NvbmZpZ3VyZV9hbGxfY29udGV4dHMoc3Ry
dWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2LAogCX0KIAogCS8qCi0JICogQXBwbHkgdGhl
IGNvbmZpZ3VyYXRpb24gYnkgZG9pbmcgb25lIGNvbnRleHQgcmVzdG9yZSBvZiB0aGUgZWRpdGVk
Ci0JICogY29udGV4dCBpbWFnZS4KKwkgKiBUaGUgYWJvdmUgY29uZmlndXJhdGlvbiB3aWxsIGJl
IGFwcGxpZWQgd2hlbiBjYWxsZWQKKwkgKiBjb25maWdfb2FfcmVncygpLgogCSAqLwotCXJxID0g
aTkxNV9yZXF1ZXN0X2NyZWF0ZShkZXZfcHJpdi0+ZW5naW5lW1JDUzBdLT5rZXJuZWxfY29udGV4
dCk7Ci0JaWYgKElTX0VSUihycSkpCi0JCXJldHVybiBQVFJfRVJSKHJxKTsKIAotCWk5MTVfcmVx
dWVzdF9hZGQocnEpOwordW5sb2NrOgorCW11dGV4X3VubG9jaygmZGV2X3ByaXYtPmRybS5zdHJ1
Y3RfbXV0ZXgpOwogCi0JcmV0dXJuIDA7CisJcmV0dXJuIHJldDsKIH0KIAogc3RhdGljIGludCBn
ZW44X2VuYWJsZV9tZXRyaWNfc2V0KHN0cnVjdCBpOTE1X3BlcmZfc3RyZWFtICpzdHJlYW0pCkBA
IC0yMTQzLDEzICsyMTg4LDcgQEAgc3RhdGljIGludCBnZW44X2VuYWJsZV9tZXRyaWNfc2V0KHN0
cnVjdCBpOTE1X3BlcmZfc3RyZWFtICpzdHJlYW0pCiAJaWYgKHJldCkKIAkJcmV0dXJuIHJldDsK
IAotCWNvbmZpZ19vYV9yZWdzKGRldl9wcml2LCBvYV9jb25maWctPm11eF9yZWdzLCBvYV9jb25m
aWctPm11eF9yZWdzX2xlbik7Ci0JZGVsYXlfYWZ0ZXJfbXV4KCk7Ci0KLQljb25maWdfb2FfcmVn
cyhkZXZfcHJpdiwgb2FfY29uZmlnLT5iX2NvdW50ZXJfcmVncywKLQkJICAgICAgIG9hX2NvbmZp
Zy0+Yl9jb3VudGVyX3JlZ3NfbGVuKTsKLQotCXJldHVybiAwOworCXJldHVybiBlbWl0X29hX2Nv
bmZpZyhkZXZfcHJpdiwgc3RyZWFtKTsKIH0KIAogc3RhdGljIHZvaWQgZ2VuOF9kaXNhYmxlX21l
dHJpY19zZXQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2KQpAQCAtMjMyMCw3ICsy
MzU5LDkgQEAgc3RhdGljIGludCBpOTE1X29hX3N0cmVhbV9pbml0KHN0cnVjdCBpOTE1X3BlcmZf
c3RyZWFtICpzdHJlYW0sCiAJCQkgICAgICAgc3RydWN0IHBlcmZfb3Blbl9wcm9wZXJ0aWVzICpw
cm9wcykKIHsKIAlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYgPSBzdHJlYW0tPmRl
dl9wcml2OworCXN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmo7CiAJaW50IGZvcm1hdF9z
aXplOworCWxvbmcgdGltZW91dDsKIAlpbnQgcmV0OwogCiAJLyogSWYgdGhlIHN5c2ZzIG1ldHJp
Y3MvIGRpcmVjdG9yeSB3YXNuJ3QgcmVnaXN0ZXJlZCBmb3Igc29tZQpAQCAtMjQwNCwxMyArMjQ0
NSw2IEBAIHN0YXRpYyBpbnQgaTkxNV9vYV9zdHJlYW1faW5pdChzdHJ1Y3QgaTkxNV9wZXJmX3N0
cmVhbSAqc3RyZWFtLAogCQl9CiAJfQogCi0JcmV0ID0gaTkxNV9wZXJmX2dldF9vYV9jb25maWco
ZGV2X3ByaXYsIHByb3BzLT5tZXRyaWNzX3NldCwKLQkJCQkgICAgICAmc3RyZWFtLT5vYV9jb25m
aWcsIE5VTEwpOwotCWlmIChyZXQpIHsKLQkJRFJNX0RFQlVHKCJJbnZhbGlkIE9BIGNvbmZpZyBp
ZD0laVxuIiwgcHJvcHMtPm1ldHJpY3Nfc2V0KTsKLQkJZ290byBlcnJfY29uZmlnOwotCX0KLQog
CXJldCA9IGFsbG9jX25vYV93YWl0KGRldl9wcml2KTsKIAlpZiAocmV0KSB7CiAJCURSTV9ERUJV
RygiVW5hYmxlIHRvIGFsbG9jYXRlIE5PQSB3YWl0IGJhdGNoIGJ1ZmZlclxuIik7CkBAIC0yNDM2
LDQ3ICsyNDcwLDkwIEBAIHN0YXRpYyBpbnQgaTkxNV9vYV9zdHJlYW1faW5pdChzdHJ1Y3QgaTkx
NV9wZXJmX3N0cmVhbSAqc3RyZWFtLAogCWlmIChyZXQpCiAJCWdvdG8gZXJyX29hX2J1Zl9hbGxv
YzsKIAorCXJldCA9IGk5MTVfcGVyZl9nZXRfb2FfY29uZmlnKGRldl9wcml2LCBwcm9wcy0+bWV0
cmljc19zZXQsCisJCQkJICAgICAgJnN0cmVhbS0+b2FfY29uZmlnLCAmb2JqKTsKKwlpZiAocmV0
KSB7CisJCURSTV9ERUJVRygiSW52YWxpZCBPQSBjb25maWcgaWQ9JWlcbiIsIHByb3BzLT5tZXRy
aWNzX3NldCk7CisJCWdvdG8gZXJyX2NvbmZpZzsKKwl9CisKKwkvKgorCSAqIFdlIGp1c3QgbmVl
ZCB0aGUgYnVmZmVyIHRvIGJlIGNyZWF0ZWQsIGJ1dCBub3Qgb3VyIG93biByZWZlcmVuY2Ugb24K
KwkgKiBpdCBhcyB0aGUgb2FfY29uZmlnIGFscmVhZHkgaGFzIG9uZS4KKwkgKi8KKwlpOTE1X2dl
bV9vYmplY3RfcHV0KG9iaik7CisKKwlzdHJlYW0tPmluaXRpYWxfY29uZmlnX3JxID0KKwkJaTkx
NV9yZXF1ZXN0X2NyZWF0ZShkZXZfcHJpdi0+ZW5naW5lW1JDUzBdLT5rZXJuZWxfY29udGV4dCk7
CisJaWYgKElTX0VSUihzdHJlYW0tPmluaXRpYWxfY29uZmlnX3JxKSkgeworCQlyZXQgPSBQVFJf
RVJSKHN0cmVhbS0+aW5pdGlhbF9jb25maWdfcnEpOworCQlnb3RvIGVycl9pbml0aWFsX2NvbmZp
ZzsKKwl9CisKKwlzdHJlYW0tPm9wcyA9ICZpOTE1X29hX3N0cmVhbV9vcHM7CisKIAlyZXQgPSBp
OTE1X211dGV4X2xvY2tfaW50ZXJydXB0aWJsZSgmZGV2X3ByaXYtPmRybSk7CiAJaWYgKHJldCkK
IAkJZ290byBlcnJfbG9jazsKIAotCXN0cmVhbS0+b3BzID0gJmk5MTVfb2Ffc3RyZWFtX29wczsK
KwlyZXQgPSBpOTE1X2FjdGl2ZV9yZXF1ZXN0X3NldCgmZGV2X3ByaXYtPmVuZ2luZVtSQ1MwXS0+
bGFzdF9vYV9jb25maWcsCisJCQkJICAgICAgc3RyZWFtLT5pbml0aWFsX2NvbmZpZ19ycSk7CisJ
aWYgKHJldCkgeworCQltdXRleF91bmxvY2soJmRldl9wcml2LT5kcm0uc3RydWN0X211dGV4KTsK
KwkJZ290byBlcnJfbG9jazsKKwl9CisKIAlkZXZfcHJpdi0+cGVyZi5vYS5leGNsdXNpdmVfc3Ry
ZWFtID0gc3RyZWFtOwogCisJbXV0ZXhfdW5sb2NrKCZkZXZfcHJpdi0+ZHJtLnN0cnVjdF9tdXRl
eCk7CisKIAlyZXQgPSBkZXZfcHJpdi0+cGVyZi5vYS5vcHMuZW5hYmxlX21ldHJpY19zZXQoc3Ry
ZWFtKTsKIAlpZiAocmV0KSB7CiAJCURSTV9ERUJVRygiVW5hYmxlIHRvIGVuYWJsZSBtZXRyaWMg
c2V0XG4iKTsKIAkJZ290byBlcnJfZW5hYmxlOwogCX0KIAotCURSTV9ERUJVRygib3BlbmluZyBz
dHJlYW0gb2EgY29uZmlnIHV1aWQ9JXNcbiIsIHN0cmVhbS0+b2FfY29uZmlnLT51dWlkKTsKKwlp
OTE1X3JlcXVlc3RfZ2V0KHN0cmVhbS0+aW5pdGlhbF9jb25maWdfcnEpOwogCi0JbXV0ZXhfdW5s
b2NrKCZkZXZfcHJpdi0+ZHJtLnN0cnVjdF9tdXRleCk7CisJaTkxNV9yZXF1ZXN0X2FkZChzdHJl
YW0tPmluaXRpYWxfY29uZmlnX3JxKTsKKworCXRpbWVvdXQgPSBpOTE1X3JlcXVlc3Rfd2FpdChz
dHJlYW0tPmluaXRpYWxfY29uZmlnX3JxLAorCQkJCSAgICBJOTE1X1dBSVRfSU5URVJSVVBUSUJM
RSwKKwkJCQkgICAgTUFYX1NDSEVEVUxFX1RJTUVPVVQpOworCWk5MTVfcmVxdWVzdF9wdXQoc3Ry
ZWFtLT5pbml0aWFsX2NvbmZpZ19ycSk7CisJc3RyZWFtLT5pbml0aWFsX2NvbmZpZ19ycSA9IE5V
TEw7CisKKwlyZXQgPSB0aW1lb3V0IDwgMCA/IHRpbWVvdXQgOiAwOworCWlmIChyZXQpCisJCWdv
dG8gZXJyX2VuYWJsZTsKKworCURSTV9ERUJVRygib3BlbmluZyBzdHJlYW0gb2EgY29uZmlnIHV1
aWQ9JXNcbiIsIHN0cmVhbS0+b2FfY29uZmlnLT51dWlkKTsKIAogCXJldHVybiAwOwogCiBlcnJf
ZW5hYmxlOgorCW11dGV4X2xvY2soJmRldl9wcml2LT5kcm0uc3RydWN0X211dGV4KTsKIAlkZXZf
cHJpdi0+cGVyZi5vYS5leGNsdXNpdmVfc3RyZWFtID0gTlVMTDsKLQlkZXZfcHJpdi0+cGVyZi5v
YS5vcHMuZGlzYWJsZV9tZXRyaWNfc2V0KGRldl9wcml2KTsKIAltdXRleF91bmxvY2soJmRldl9w
cml2LT5kcm0uc3RydWN0X211dGV4KTsKKwlkZXZfcHJpdi0+cGVyZi5vYS5vcHMuZGlzYWJsZV9t
ZXRyaWNfc2V0KGRldl9wcml2KTsKIAogZXJyX2xvY2s6Ci0JZnJlZV9vYV9idWZmZXIoZGV2X3By
aXYpOworCWk5MTVfcmVxdWVzdF9hZGQoc3RyZWFtLT5pbml0aWFsX2NvbmZpZ19ycSk7CiAKLWVy
cl9vYV9idWZfYWxsb2M6CitlcnJfaW5pdGlhbF9jb25maWc6CiAJaTkxNV9vYV9jb25maWdfcHV0
KHN0cmVhbS0+b2FfY29uZmlnKTsKKwlpOTE1X29hX2NvbmZpZ19kaXNwb3NlX2J1ZmZlcnMoZGV2
X3ByaXYpOworCitlcnJfY29uZmlnOgorCWZyZWVfb2FfYnVmZmVyKGRldl9wcml2KTsKIAorZXJy
X29hX2J1Zl9hbGxvYzoKIAlpbnRlbF91bmNvcmVfZm9yY2V3YWtlX3B1dCgmZGV2X3ByaXYtPnVu
Y29yZSwgRk9SQ0VXQUtFX0FMTCk7CiAJaW50ZWxfcnVudGltZV9wbV9wdXQoJmRldl9wcml2LT5y
dW50aW1lX3BtLCBzdHJlYW0tPndha2VyZWYpOwogCi0JbXV0ZXhfbG9jaygmZGV2X3ByaXYtPmRy
bS5zdHJ1Y3RfbXV0ZXgpOwotCWk5MTVfdm1hX3VucGluX2FuZF9yZWxlYXNlKCZkZXZfcHJpdi0+
cGVyZi5vYS5ub2Ffd2FpdCwgMCk7Ci0JbXV0ZXhfdW5sb2NrKCZkZXZfcHJpdi0+ZHJtLnN0cnVj
dF9tdXRleCk7CisJZnJlZV9ub2Ffd2FpdChkZXZfcHJpdik7CiAKIGVycl9ub2Ffd2FpdF9hbGxv
YzoKLQlpOTE1X29hX2NvbmZpZ19wdXQoc3RyZWFtLT5vYV9jb25maWcpOwotCi1lcnJfY29uZmln
OgogCWlmIChzdHJlYW0tPmN0eCkKIAkJb2FfcHV0X3JlbmRlcl9jdHhfaWQoc3RyZWFtKTsKIApA
QCAtMjgzOCwyMCArMjkxNSwxMyBAQCBzdGF0aWMgaW50IGk5MTVfcGVyZl9yZWxlYXNlKHN0cnVj
dCBpbm9kZSAqaW5vZGUsIHN0cnVjdCBmaWxlICpmaWxlKQogewogCXN0cnVjdCBpOTE1X3BlcmZf
c3RyZWFtICpzdHJlYW0gPSBmaWxlLT5wcml2YXRlX2RhdGE7CiAJc3RydWN0IGRybV9pOTE1X3By
aXZhdGUgKmRldl9wcml2ID0gc3RyZWFtLT5kZXZfcHJpdjsKLQlzdHJ1Y3QgaTkxNV9vYV9jb25m
aWcgKm9hX2NvbmZpZywgKm5leHQ7CiAKIAltdXRleF9sb2NrKCZkZXZfcHJpdi0+cGVyZi5sb2Nr
KTsKIAogCWk5MTVfcGVyZl9kZXN0cm95X2xvY2tlZChzdHJlYW0pOwogCiAJLyogRGlzcG9zZSBv
ZiBhbGwgb2EgY29uZmlnIGJhdGNoIGJ1ZmZlcnMuICovCi0JbXV0ZXhfbG9jaygmZGV2X3ByaXYt
PnBlcmYubWV0cmljc19sb2NrKTsKLQlsaXN0X2Zvcl9lYWNoX2VudHJ5X3NhZmUob2FfY29uZmln
LCBuZXh0LCAmZGV2X3ByaXYtPnBlcmYubWV0cmljc19idWZmZXJzLCB2bWFfbGluaykgewotCQls
aXN0X2RlbCgmb2FfY29uZmlnLT52bWFfbGluayk7Ci0JCWk5MTVfZ2VtX29iamVjdF9wdXQob2Ff
Y29uZmlnLT5vYmopOwotCQlvYV9jb25maWctPm9iaiA9IE5VTEw7Ci0JfQotCW11dGV4X3VubG9j
aygmZGV2X3ByaXYtPnBlcmYubWV0cmljc19sb2NrKTsKKwlpOTE1X29hX2NvbmZpZ19kaXNwb3Nl
X2J1ZmZlcnMoZGV2X3ByaXYpOwogCiAJbXV0ZXhfdW5sb2NrKCZkZXZfcHJpdi0+cGVyZi5sb2Nr
KTsKIAotLSAKMi4yMi4wCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fXwpJbnRlbC1nZnggbWFpbGluZyBsaXN0CkludGVsLWdmeEBsaXN0cy5mcmVlZGVza3Rv
cC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9pbnRl
bC1nZng=

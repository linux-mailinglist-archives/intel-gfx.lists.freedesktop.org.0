Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 6641691E69
	for <lists+intel-gfx@lfdr.de>; Mon, 19 Aug 2019 09:58:54 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 371CC6E0BB;
	Mon, 19 Aug 2019 07:58:52 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 956126E0BB
 for <intel-gfx@lists.freedesktop.org>; Mon, 19 Aug 2019 07:58:49 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18185101-1500050 
 for multiple; Mon, 19 Aug 2019 08:58:38 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 19 Aug 2019 08:58:25 +0100
Message-Id: <20190819075835.20065-9-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0.rc1
In-Reply-To: <20190819075835.20065-1-chris@chris-wilson.co.uk>
References: <20190819075835.20065-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 08/18] drm/i915: Track ggtt fence reservations
 under its own mutex
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

V2UgY2FuIHJlZHVjZSB0aGUgbG9ja2luZyBmb3IgZmVuY2UgcmVnaXN0ZXJzIGZyb20gdGhlIGRl
di0+c3RydWN0X211dGV4CnRvIGEgbG9jYWwgbXV0ZXguIFdlIGNvdWxkIGludHJvZHVjZSBhIG11
dGV4IGZvciB0aGUgc29sZSBwdXJwb3NlIG9mCnRyYWNraW5nIHRoZSBmZW5jZSBhY3F1aXNpdGlv
biwgZXhjZXB0IHRoZXJlIGlzIGEgbGl0dGxlIGJpdCBvZiBvdmVybGFwCndpdGggdGhlIGZhdWx0
IHRyYWNraW5nLCBzbyB1c2UgdGhlIGk5MTVfZ2d0dC5tdXRleCBhcyBpdCBjb3ZlcnMgYm90aC4K
ClNpZ25lZC1vZmYtYnk6IENocmlzIFdpbHNvbiA8Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPgpD
YzogTWlrYSBLdW9wcGFsYSA8bWlrYS5rdW9wcGFsYUBsaW51eC5pbnRlbC5jb20+Ci0tLQogZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ3Qvc2VsZnRlc3RfaGFuZ2NoZWNrLmMgfCAgIDcgKysKIGRyaXZl
cnMvZ3B1L2RybS9pOTE1L2d2dC9hcGVydHVyZV9nbS5jICAgICAgIHwgIDEwICstCiBkcml2ZXJz
L2dwdS9kcm0vaTkxNS9pOTE1X2RlYnVnZnMuYyAgICAgICAgICB8ICAgNSArLQogZHJpdmVycy9n
cHUvZHJtL2k5MTUvaTkxNV9nZW1fZmVuY2VfcmVnLmMgICAgfCAxMDggKysrKysrKysrKysrLS0t
LS0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW1fZmVuY2VfcmVnLmggICAgfCAgIDIg
Ky0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfdm1hLmggICAgICAgICAgICAgIHwgICA0ICst
CiA2IGZpbGVzIGNoYW5nZWQsIDg3IGluc2VydGlvbnMoKyksIDQ5IGRlbGV0aW9ucygtKQoKZGlm
ZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L3NlbGZ0ZXN0X2hhbmdjaGVjay5jIGIv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Qvc2VsZnRlc3RfaGFuZ2NoZWNrLmMKaW5kZXggNDQ4NGI0
NDQ3ZGIxLi5hMzFlZWQyYmIwMGYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0
L3NlbGZ0ZXN0X2hhbmdjaGVjay5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L3NlbGZ0
ZXN0X2hhbmdjaGVjay5jCkBAIC0xMTU0LDcgKzExNTQsMTQgQEAgc3RhdGljIGludCBldmljdF9m
ZW5jZSh2b2lkICpkYXRhKQogCQlnb3RvIG91dF91bmxvY2s7CiAJfQogCisJZXJyID0gaTkxNV92
bWFfcGluKGFyZy0+dm1hLCAwLCAwLCBQSU5fR0xPQkFMIHwgUElOX01BUFBBQkxFKTsKKwlpZiAo
ZXJyKSB7CisJCXByX2VycigiVW5hYmxlIHRvIHBpbiB2bWEgZm9yIFktdGlsZWQgZmVuY2U7IGVy
cjolZFxuIiwgZXJyKTsKKwkJZ290byBvdXRfdW5sb2NrOworCX0KKwogCWVyciA9IGk5MTVfdm1h
X3Bpbl9mZW5jZShhcmctPnZtYSk7CisJaTkxNV92bWFfdW5waW4oYXJnLT52bWEpOwogCWlmIChl
cnIpIHsKIAkJcHJfZXJyKCJVbmFibGUgdG8gcGluIFktdGlsZWQgZmVuY2U7IGVycjolZFxuIiwg
ZXJyKTsKIAkJZ290byBvdXRfdW5sb2NrOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ3Z0L2FwZXJ0dXJlX2dtLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQvYXBlcnR1cmVf
Z20uYwppbmRleCBjM2QxOWQ4OGRhNDAuLjVmZjI0MzdiMjk5OCAxMDA2NDQKLS0tIGEvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ3Z0L2FwZXJ0dXJlX2dtLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ3Z0L2FwZXJ0dXJlX2dtLmMKQEAgLTE3MiwxNCArMTcyLDE0IEBAIHN0YXRpYyB2b2lkIGZy
ZWVfdmdwdV9mZW5jZShzdHJ1Y3QgaW50ZWxfdmdwdSAqdmdwdSkKIAogCWludGVsX3J1bnRpbWVf
cG1fZ2V0KCZkZXZfcHJpdi0+cnVudGltZV9wbSk7CiAKLQltdXRleF9sb2NrKCZkZXZfcHJpdi0+
ZHJtLnN0cnVjdF9tdXRleCk7CisJbXV0ZXhfbG9jaygmZGV2X3ByaXYtPmdndHQudm0ubXV0ZXgp
OwogCV9jbGVhcl92Z3B1X2ZlbmNlKHZncHUpOwogCWZvciAoaSA9IDA7IGkgPCB2Z3B1X2ZlbmNl
X3N6KHZncHUpOyBpKyspIHsKIAkJcmVnID0gdmdwdS0+ZmVuY2UucmVnc1tpXTsKIAkJaTkxNV91
bnJlc2VydmVfZmVuY2UocmVnKTsKIAkJdmdwdS0+ZmVuY2UucmVnc1tpXSA9IE5VTEw7CiAJfQot
CW11dGV4X3VubG9jaygmZGV2X3ByaXYtPmRybS5zdHJ1Y3RfbXV0ZXgpOworCW11dGV4X3VubG9j
aygmZGV2X3ByaXYtPmdndHQudm0ubXV0ZXgpOwogCiAJaW50ZWxfcnVudGltZV9wbV9wdXRfdW5j
aGVja2VkKCZkZXZfcHJpdi0+cnVudGltZV9wbSk7CiB9CkBAIC0xOTUsNyArMTk1LDcgQEAgc3Rh
dGljIGludCBhbGxvY192Z3B1X2ZlbmNlKHN0cnVjdCBpbnRlbF92Z3B1ICp2Z3B1KQogCWludGVs
X3J1bnRpbWVfcG1fZ2V0KHJwbSk7CiAKIAkvKiBSZXF1ZXN0IGZlbmNlcyBmcm9tIGhvc3QgKi8K
LQltdXRleF9sb2NrKCZkZXZfcHJpdi0+ZHJtLnN0cnVjdF9tdXRleCk7CisJbXV0ZXhfbG9jaygm
ZGV2X3ByaXYtPmdndHQudm0ubXV0ZXgpOwogCiAJZm9yIChpID0gMDsgaSA8IHZncHVfZmVuY2Vf
c3oodmdwdSk7IGkrKykgewogCQlyZWcgPSBpOTE1X3Jlc2VydmVfZmVuY2UoZGV2X3ByaXYpOwpA
QCAtMjA3LDcgKzIwNyw3IEBAIHN0YXRpYyBpbnQgYWxsb2NfdmdwdV9mZW5jZShzdHJ1Y3QgaW50
ZWxfdmdwdSAqdmdwdSkKIAogCV9jbGVhcl92Z3B1X2ZlbmNlKHZncHUpOwogCi0JbXV0ZXhfdW5s
b2NrKCZkZXZfcHJpdi0+ZHJtLnN0cnVjdF9tdXRleCk7CisJbXV0ZXhfdW5sb2NrKCZkZXZfcHJp
di0+Z2d0dC52bS5tdXRleCk7CiAJaW50ZWxfcnVudGltZV9wbV9wdXRfdW5jaGVja2VkKHJwbSk7
CiAJcmV0dXJuIDA7CiBvdXRfZnJlZV9mZW5jZToKQEAgLTIyMCw3ICsyMjAsNyBAQCBzdGF0aWMg
aW50IGFsbG9jX3ZncHVfZmVuY2Uoc3RydWN0IGludGVsX3ZncHUgKnZncHUpCiAJCWk5MTVfdW5y
ZXNlcnZlX2ZlbmNlKHJlZyk7CiAJCXZncHUtPmZlbmNlLnJlZ3NbaV0gPSBOVUxMOwogCX0KLQlt
dXRleF91bmxvY2soJmRldl9wcml2LT5kcm0uc3RydWN0X211dGV4KTsKKwltdXRleF91bmxvY2so
JmRldl9wcml2LT5nZ3R0LnZtLm11dGV4KTsKIAlpbnRlbF9ydW50aW1lX3BtX3B1dF91bmNoZWNr
ZWQocnBtKTsKIAlyZXR1cm4gLUVOT1NQQzsKIH0KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2k5MTVfZGVidWdmcy5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kZWJ1Z2Zz
LmMKaW5kZXggYjM5MjI2ZDdmOGQyLi5mNWQ2NzAyZWM3ZGYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2k5MTVfZGVidWdmcy5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5
MTVfZGVidWdmcy5jCkBAIC02NTIsMTAgKzY1MiwxMSBAQCBzdGF0aWMgaW50IGk5MTVfZ2VtX2Zl
bmNlX3JlZ3NfaW5mbyhzdHJ1Y3Qgc2VxX2ZpbGUgKm0sIHZvaWQgKmRhdGEpCiAKIAlyY3VfcmVh
ZF9sb2NrKCk7CiAJZm9yIChpID0gMDsgaSA8IGk5MTUtPmdndHQubnVtX2ZlbmNlczsgaSsrKSB7
Ci0JCXN0cnVjdCBpOTE1X3ZtYSAqdm1hID0gaTkxNS0+Z2d0dC5mZW5jZV9yZWdzW2ldLnZtYTsK
KwkJc3RydWN0IGk5MTVfZmVuY2VfcmVnICpyZWcgPSAmaTkxNS0+Z2d0dC5mZW5jZV9yZWdzW2ld
OworCQlzdHJ1Y3QgaTkxNV92bWEgKnZtYSA9IHJlZy0+dm1hOwogCiAJCXNlcV9wcmludGYobSwg
IkZlbmNlICVkLCBwaW4gY291bnQgPSAlZCwgb2JqZWN0ID0gIiwKLQkJCSAgIGksIGk5MTUtPmdn
dHQuZmVuY2VfcmVnc1tpXS5waW5fY291bnQpOworCQkJICAgaSwgYXRvbWljX3JlYWQoJnJlZy0+
cGluX2NvdW50KSk7CiAJCWlmICghdm1hKQogCQkJc2VxX3B1dHMobSwgInVudXNlZCIpOwogCQll
bHNlCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9mZW5jZV9yZWcu
YyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtX2ZlbmNlX3JlZy5jCmluZGV4IGM5NjU0
ZjFhNDY4Zi4uNmEzM2EwYmI5N2E5IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9p
OTE1X2dlbV9mZW5jZV9yZWcuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9m
ZW5jZV9yZWcuYwpAQCAtMjk5LDE1ICsyOTksMjQgQEAgc3RhdGljIGludCBmZW5jZV91cGRhdGUo
c3RydWN0IGk5MTVfZmVuY2VfcmVnICpmZW5jZSwKICAqLwogaW50IGk5MTVfdm1hX3B1dF9mZW5j
ZShzdHJ1Y3QgaTkxNV92bWEgKnZtYSkKIHsKKwlzdHJ1Y3QgaTkxNV9nZ3R0ICpnZ3R0ID0gaTkx
NV92bV90b19nZ3R0KHZtYS0+dm0pOwogCXN0cnVjdCBpOTE1X2ZlbmNlX3JlZyAqZmVuY2UgPSB2
bWEtPmZlbmNlOworCWludCBlcnI7CiAKIAlpZiAoIWZlbmNlKQogCQlyZXR1cm4gMDsKIAotCWlm
IChmZW5jZS0+cGluX2NvdW50KQorCWlmIChhdG9taWNfcmVhZCgmZmVuY2UtPnBpbl9jb3VudCkp
CiAJCXJldHVybiAtRUJVU1k7CiAKLQlyZXR1cm4gZmVuY2VfdXBkYXRlKGZlbmNlLCBOVUxMKTsK
KwllcnIgPSBtdXRleF9sb2NrX2ludGVycnVwdGlibGUoJmdndHQtPnZtLm11dGV4KTsKKwlpZiAo
ZXJyKQorCQlyZXR1cm4gZXJyOworCisJZXJyID0gZmVuY2VfdXBkYXRlKGZlbmNlLCBOVUxMKTsK
KwltdXRleF91bmxvY2soJmdndHQtPnZtLm11dGV4KTsKKworCXJldHVybiBlcnI7CiB9CiAKIHN0
YXRpYyBzdHJ1Y3QgaTkxNV9mZW5jZV9yZWcgKmZlbmNlX2ZpbmQoc3RydWN0IGRybV9pOTE1X3By
aXZhdGUgKmk5MTUpCkBAIC0zMTcsNyArMzI2LDcgQEAgc3RhdGljIHN0cnVjdCBpOTE1X2ZlbmNl
X3JlZyAqZmVuY2VfZmluZChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKIAlsaXN0X2Zv
cl9lYWNoX2VudHJ5KGZlbmNlLCAmaTkxNS0+Z2d0dC5mZW5jZV9saXN0LCBsaW5rKSB7CiAJCUdF
TV9CVUdfT04oZmVuY2UtPnZtYSAmJiBmZW5jZS0+dm1hLT5mZW5jZSAhPSBmZW5jZSk7CiAKLQkJ
aWYgKGZlbmNlLT5waW5fY291bnQpCisJCWlmIChhdG9taWNfcmVhZCgmZmVuY2UtPnBpbl9jb3Vu
dCkpCiAJCQljb250aW51ZTsKIAogCQlyZXR1cm4gZmVuY2U7CkBAIC0zMzAsNiArMzM5LDQ4IEBA
IHN0YXRpYyBzdHJ1Y3QgaTkxNV9mZW5jZV9yZWcgKmZlbmNlX2ZpbmQoc3RydWN0IGRybV9pOTE1
X3ByaXZhdGUgKmk5MTUpCiAJcmV0dXJuIEVSUl9QVFIoLUVERUFETEspOwogfQogCitzdGF0aWMg
aW50IF9faTkxNV92bWFfcGluX2ZlbmNlKHN0cnVjdCBpOTE1X3ZtYSAqdm1hKQoreworCXN0cnVj
dCBpOTE1X2dndHQgKmdndHQgPSBpOTE1X3ZtX3RvX2dndHQodm1hLT52bSk7CisJc3RydWN0IGk5
MTVfZmVuY2VfcmVnICpmZW5jZTsKKwlzdHJ1Y3QgaTkxNV92bWEgKnNldCA9IGk5MTVfZ2VtX29i
amVjdF9pc190aWxlZCh2bWEtPm9iaikgPyB2bWEgOiBOVUxMOworCWludCBlcnI7CisKKwkvKiBK
dXN0IHVwZGF0ZSBvdXIgcGxhY2UgaW4gdGhlIExSVSBpZiBvdXIgZmVuY2UgaXMgZ2V0dGluZyBy
ZXVzZWQuICovCisJaWYgKHZtYS0+ZmVuY2UpIHsKKwkJZmVuY2UgPSB2bWEtPmZlbmNlOworCQlH
RU1fQlVHX09OKGZlbmNlLT52bWEgIT0gdm1hKTsKKwkJYXRvbWljX2luYygmZmVuY2UtPnBpbl9j
b3VudCk7CisJCWlmICghZmVuY2UtPmRpcnR5KSB7CisJCQlsaXN0X21vdmVfdGFpbCgmZmVuY2Ut
PmxpbmssICZnZ3R0LT5mZW5jZV9saXN0KTsKKwkJCXJldHVybiAwOworCQl9CisJfSBlbHNlIGlm
IChzZXQpIHsKKwkJZmVuY2UgPSBmZW5jZV9maW5kKHZtYS0+dm0tPmk5MTUpOworCQlpZiAoSVNf
RVJSKGZlbmNlKSkKKwkJCXJldHVybiBQVFJfRVJSKGZlbmNlKTsKKworCQlHRU1fQlVHX09OKGF0
b21pY19yZWFkKCZmZW5jZS0+cGluX2NvdW50KSk7CisJCWF0b21pY19pbmMoJmZlbmNlLT5waW5f
Y291bnQpOworCX0gZWxzZSB7CisJCXJldHVybiAwOworCX0KKworCWVyciA9IGZlbmNlX3VwZGF0
ZShmZW5jZSwgc2V0KTsKKwlpZiAoZXJyKQorCQlnb3RvIG91dF91bnBpbjsKKworCUdFTV9CVUdf
T04oZmVuY2UtPnZtYSAhPSBzZXQpOworCUdFTV9CVUdfT04odm1hLT5mZW5jZSAhPSAoc2V0ID8g
ZmVuY2UgOiBOVUxMKSk7CisKKwlpZiAoc2V0KQorCQlyZXR1cm4gMDsKKworb3V0X3VucGluOgor
CWF0b21pY19kZWMoJmZlbmNlLT5waW5fY291bnQpOworCXJldHVybiBlcnI7Cit9CisKIC8qKgog
ICogaTkxNV92bWFfcGluX2ZlbmNlIC0gc2V0IHVwIGZlbmNpbmcgZm9yIGEgdm1hCiAgKiBAdm1h
OiB2bWEgdG8gbWFwIHRocm91Z2ggYSBmZW5jZSByZWcKQEAgLTM1MCw4ICs0MDEsNiBAQCBzdGF0
aWMgc3RydWN0IGk5MTVfZmVuY2VfcmVnICpmZW5jZV9maW5kKHN0cnVjdCBkcm1faTkxNV9wcml2
YXRlICppOTE1KQogICovCiBpbnQgaTkxNV92bWFfcGluX2ZlbmNlKHN0cnVjdCBpOTE1X3ZtYSAq
dm1hKQogewotCXN0cnVjdCBpOTE1X2ZlbmNlX3JlZyAqZmVuY2U7Ci0Jc3RydWN0IGk5MTVfdm1h
ICpzZXQgPSBpOTE1X2dlbV9vYmplY3RfaXNfdGlsZWQodm1hLT5vYmopID8gdm1hIDogTlVMTDsK
IAlpbnQgZXJyOwogCiAJLyoKQEAgLTM1OSwzOSArNDA4LDE2IEBAIGludCBpOTE1X3ZtYV9waW5f
ZmVuY2Uoc3RydWN0IGk5MTVfdm1hICp2bWEpCiAJICogbXVzdCBrZWVwIHRoZSBkZXZpY2UgYXdh
a2Ugd2hpbHN0IHVzaW5nIHRoZSBmZW5jZS4KIAkgKi8KIAlhc3NlcnRfcnBtX3dha2Vsb2NrX2hl
bGQoJnZtYS0+dm0tPmk5MTUtPnJ1bnRpbWVfcG0pOworCUdFTV9CVUdfT04oIWk5MTVfdm1hX2lz
X3Bpbm5lZCh2bWEpKTsKKwlHRU1fQlVHX09OKCFpOTE1X3ZtYV9pc19nZ3R0KHZtYSkpOwogCi0J
LyogSnVzdCB1cGRhdGUgb3VyIHBsYWNlIGluIHRoZSBMUlUgaWYgb3VyIGZlbmNlIGlzIGdldHRp
bmcgcmV1c2VkLiAqLwotCWlmICh2bWEtPmZlbmNlKSB7Ci0JCWZlbmNlID0gdm1hLT5mZW5jZTsK
LQkJR0VNX0JVR19PTihmZW5jZS0+dm1hICE9IHZtYSk7Ci0JCWZlbmNlLT5waW5fY291bnQrKzsK
LQkJaWYgKCFmZW5jZS0+ZGlydHkpIHsKLQkJCWxpc3RfbW92ZV90YWlsKCZmZW5jZS0+bGluaywK
LQkJCQkgICAgICAgJmZlbmNlLT5pOTE1LT5nZ3R0LmZlbmNlX2xpc3QpOwotCQkJcmV0dXJuIDA7
Ci0JCX0KLQl9IGVsc2UgaWYgKHNldCkgewotCQlmZW5jZSA9IGZlbmNlX2ZpbmQodm1hLT52bS0+
aTkxNSk7Ci0JCWlmIChJU19FUlIoZmVuY2UpKQotCQkJcmV0dXJuIFBUUl9FUlIoZmVuY2UpOwot
Ci0JCUdFTV9CVUdfT04oZmVuY2UtPnBpbl9jb3VudCk7Ci0JCWZlbmNlLT5waW5fY291bnQrKzsK
LQl9IGVsc2UKLQkJcmV0dXJuIDA7Ci0KLQllcnIgPSBmZW5jZV91cGRhdGUoZmVuY2UsIHNldCk7
CisJZXJyID0gbXV0ZXhfbG9ja19pbnRlcnJ1cHRpYmxlKCZ2bWEtPnZtLT5tdXRleCk7CiAJaWYg
KGVycikKLQkJZ290byBvdXRfdW5waW47CisJCXJldHVybiBlcnI7CiAKLQlHRU1fQlVHX09OKGZl
bmNlLT52bWEgIT0gc2V0KTsKLQlHRU1fQlVHX09OKHZtYS0+ZmVuY2UgIT0gKHNldCA/IGZlbmNl
IDogTlVMTCkpOwotCi0JaWYgKHNldCkKLQkJcmV0dXJuIDA7CisJZXJyID0gX19pOTE1X3ZtYV9w
aW5fZmVuY2Uodm1hKTsKKwltdXRleF91bmxvY2soJnZtYS0+dm0tPm11dGV4KTsKIAotb3V0X3Vu
cGluOgotCWZlbmNlLT5waW5fY291bnQtLTsKIAlyZXR1cm4gZXJyOwogfQogCkBAIC00MDQsMTYg
KzQzMCwxNyBAQCBpbnQgaTkxNV92bWFfcGluX2ZlbmNlKHN0cnVjdCBpOTE1X3ZtYSAqdm1hKQog
ICovCiBzdHJ1Y3QgaTkxNV9mZW5jZV9yZWcgKmk5MTVfcmVzZXJ2ZV9mZW5jZShzdHJ1Y3QgZHJt
X2k5MTVfcHJpdmF0ZSAqaTkxNSkKIHsKKwlzdHJ1Y3QgaTkxNV9nZ3R0ICpnZ3R0ID0gJmk5MTUt
PmdndHQ7CiAJc3RydWN0IGk5MTVfZmVuY2VfcmVnICpmZW5jZTsKIAlpbnQgY291bnQ7CiAJaW50
IHJldDsKIAotCWxvY2tkZXBfYXNzZXJ0X2hlbGQoJmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOwor
CWxvY2tkZXBfYXNzZXJ0X2hlbGQoJmdndHQtPnZtLm11dGV4KTsKIAogCS8qIEtlZXAgYXQgbGVh
c3Qgb25lIGZlbmNlIGF2YWlsYWJsZSBmb3IgdGhlIGRpc3BsYXkgZW5naW5lLiAqLwogCWNvdW50
ID0gMDsKLQlsaXN0X2Zvcl9lYWNoX2VudHJ5KGZlbmNlLCAmaTkxNS0+Z2d0dC5mZW5jZV9saXN0
LCBsaW5rKQotCQljb3VudCArPSAhZmVuY2UtPnBpbl9jb3VudDsKKwlsaXN0X2Zvcl9lYWNoX2Vu
dHJ5KGZlbmNlLCAmZ2d0dC0+ZmVuY2VfbGlzdCwgbGluaykKKwkJY291bnQgKz0gIWF0b21pY19y
ZWFkKCZmZW5jZS0+cGluX2NvdW50KTsKIAlpZiAoY291bnQgPD0gMSkKIAkJcmV0dXJuIEVSUl9Q
VFIoLUVOT1NQQyk7CiAKQEAgLTQyOSw2ICs0NTYsNyBAQCBzdHJ1Y3QgaTkxNV9mZW5jZV9yZWcg
Kmk5MTVfcmVzZXJ2ZV9mZW5jZShzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKIAl9CiAK
IAlsaXN0X2RlbCgmZmVuY2UtPmxpbmspOworCiAJcmV0dXJuIGZlbmNlOwogfQogCkBAIC00NDAs
OSArNDY4LDExIEBAIHN0cnVjdCBpOTE1X2ZlbmNlX3JlZyAqaTkxNV9yZXNlcnZlX2ZlbmNlKHN0
cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQogICovCiB2b2lkIGk5MTVfdW5yZXNlcnZlX2Zl
bmNlKHN0cnVjdCBpOTE1X2ZlbmNlX3JlZyAqZmVuY2UpCiB7Ci0JbG9ja2RlcF9hc3NlcnRfaGVs
ZCgmZmVuY2UtPmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOworCXN0cnVjdCBpOTE1X2dndHQgKmdn
dHQgPSAmZmVuY2UtPmk5MTUtPmdndHQ7CisKKwlsb2NrZGVwX2Fzc2VydF9oZWxkKCZnZ3R0LT52
bS5tdXRleCk7CiAKLQlsaXN0X2FkZCgmZmVuY2UtPmxpbmssICZmZW5jZS0+aTkxNS0+Z2d0dC5m
ZW5jZV9saXN0KTsKKwlsaXN0X2FkZCgmZmVuY2UtPmxpbmssICZnZ3R0LT5mZW5jZV9saXN0KTsK
IH0KIAogLyoqCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9mZW5j
ZV9yZWcuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtX2ZlbmNlX3JlZy5oCmluZGV4
IDM3ZTRmMTA0ZjdjMC4uOTk4NjZmYjlkOTRmIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9pOTE1X2dlbV9mZW5jZV9yZWcuaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1
X2dlbV9mZW5jZV9yZWcuaApAQCAtNDEsNyArNDEsNyBAQCBzdHJ1Y3QgaTkxNV9mZW5jZV9yZWcg
ewogCXN0cnVjdCBsaXN0X2hlYWQgbGluazsKIAlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkx
NTsKIAlzdHJ1Y3QgaTkxNV92bWEgKnZtYTsKLQlpbnQgcGluX2NvdW50OworCWF0b21pY190IHBp
bl9jb3VudDsKIAlpbnQgaWQ7CiAJLyoqCiAJICogV2hldGhlciB0aGUgdGlsaW5nIHBhcmFtZXRl
cnMgZm9yIHRoZSBjdXJyZW50bHkKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5
MTVfdm1hLmggYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3ZtYS5oCmluZGV4IGJhMWM2YTc0
ZTY0YS4uZWRlZDI2NDYxMjZiIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1
X3ZtYS5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfdm1hLmgKQEAgLTQxOCw4ICs0
MTgsOCBAQCBpbnQgX19tdXN0X2NoZWNrIGk5MTVfdm1hX3B1dF9mZW5jZShzdHJ1Y3QgaTkxNV92
bWEgKnZtYSk7CiAKIHN0YXRpYyBpbmxpbmUgdm9pZCBfX2k5MTVfdm1hX3VucGluX2ZlbmNlKHN0
cnVjdCBpOTE1X3ZtYSAqdm1hKQogewotCUdFTV9CVUdfT04odm1hLT5mZW5jZS0+cGluX2NvdW50
IDw9IDApOwotCXZtYS0+ZmVuY2UtPnBpbl9jb3VudC0tOworCUdFTV9CVUdfT04oYXRvbWljX3Jl
YWQoJnZtYS0+ZmVuY2UtPnBpbl9jb3VudCkgPD0gMCk7CisJYXRvbWljX2RlYygmdm1hLT5mZW5j
ZS0+cGluX2NvdW50KTsKIH0KIAogLyoqCi0tIAoyLjIzLjAucmMxCgpfX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpJbnRlbC1nZnggbWFpbGluZyBsaXN0Cklu
dGVsLWdmeEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5v
cmcvbWFpbG1hbi9saXN0aW5mby9pbnRlbC1nZng=

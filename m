Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id C43BA1C2B99
	for <lists+intel-gfx@lfdr.de>; Sun,  3 May 2020 13:21:51 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 9B15F6E16D;
	Sun,  3 May 2020 11:21:49 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 0BFC26E16D
 for <intel-gfx@lists.freedesktop.org>; Sun,  3 May 2020 11:21:46 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from build.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 21097485-1500050 
 for multiple; Sun, 03 May 2020 12:21:36 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Sun,  3 May 2020 12:21:20 +0100
Message-Id: <20200503112132.17899-2-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20200503112132.17899-1-chris@chris-wilson.co.uk>
References: <20200503112132.17899-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 02/14] drm/i915/gem: Implement legacy
 MI_STORE_DATA_IMM
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Chris Wilson <chris@chris-wilson.co.uk>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

VGhlIG9sZGVyIGFyY2hlcyBkaWQgbm90IGNvbnZlcnQgTUlfU1RPUkVfREFUQV9JTU0gdG8gdXNp
bmcgdGhlIEdUVCwgYnV0CmxlZnQgdGhlbSB3cml0aW5nIHRvIGEgcGh5c2ljYWwgYWRkcmVzcy4g
VGhlIG5vdGVzIHN1Z2dlc3QgdGhhdCB0aGUKcHJpbWFyeSByZWFzb24gd291bGQgYmUgc28gdGhh
dCB0aGUgd3JpdGVzIHdlcmUgY2FjaGUgY29oZXJlbnQsIGFzIHRoZQpDUFUgY2FjaGUgdXNlcyBw
aHlzaWNhbCB0YWdnaW5nLiBBcyBzdWNoIHdlIGRpZCBub3QgaW1wbGVtZW50IHRoZQpsZWdhY3kg
dmFyaWFudCBvZiBNSV9TVE9SRV9EQVRBX0lNTSBhbmQgc28gbGVmdCBhbGwgdGhlIHJlbG9jYXRp
b25zCnN5bmNocm9ub3VzIC0tIGJ1dCB3aXRoIGEgc21hbGwgZnVuY3Rpb24gdG8gY29udmVydCBm
cm9tIHRoZSB2bWEgYWRkcmVzcwppbnRvIHRoZSBwaHlzaWNhbCBhZGRyZXNzLCB3ZSBjYW4gaW1w
bGVtZW50IGFzeW5jaHJvbm91cyByZWxvY3Mgb24gdGhlc2UKb2xkZXIgYXJjaGVzLCBmaXhpbmcg
dXAgYSBmZXcgdGVzdHMgdGhhdCByZXF1aXJlIHRoZW0uCgpJbiBvcmRlciB0byBiZSBhYmxlIHRv
IHRlc3QgdGhlIGxlZ2FjeSBwYXRocywgcmVmYWN0b3IgdGhlIGdwdQpyZWxvY2F0aW9ucyBzbyB0
aGF0IHdlIGNhbiBob29rIHRoZW0gdXAgdG8gYSBzZWxmdGVzdC4KCkNsb3NlczogaHR0cHM6Ly9n
aXRsYWIuZnJlZWRlc2t0b3Aub3JnL2RybS9pbnRlbC8tL2lzc3Vlcy83NTcKU2lnbmVkLW9mZi1i
eTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28udWs+Ci0tLQogLi4uL2dwdS9k
cm0vaTkxNS9nZW0vaTkxNV9nZW1fZXhlY2J1ZmZlci5jICAgIHwgMjA0ICsrKysrKysrKystLS0t
LS0tCiAuLi4vaTkxNS9nZW0vc2VsZnRlc3RzL2k5MTVfZ2VtX2V4ZWNidWZmZXIuYyAgfCAyMDYg
KysrKysrKysrKysrKysrKysrCiAuLi4vZHJtL2k5MTUvc2VsZnRlc3RzL2k5MTVfbGl2ZV9zZWxm
dGVzdHMuaCAgfCAgIDEgKwogMyBmaWxlcyBjaGFuZ2VkLCAzMzcgaW5zZXJ0aW9ucygrKSwgNzQg
ZGVsZXRpb25zKC0pCiBjcmVhdGUgbW9kZSAxMDA2NDQgZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2Vt
L3NlbGZ0ZXN0cy9pOTE1X2dlbV9leGVjYnVmZmVyLmMKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fZXhlY2J1ZmZlci5jIGIvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ2VtL2k5MTVfZ2VtX2V4ZWNidWZmZXIuYwppbmRleCBhYjBkNGRmMTNjMGIuLjQ0ZDdkYTBl
MjAwZSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2V4ZWNi
dWZmZXIuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fZXhlY2J1ZmZl
ci5jCkBAIC05NTUsNyArOTU1LDcgQEAgc3RhdGljIHZvaWQgcmVsb2NfY2FjaGVfaW5pdChzdHJ1
Y3QgcmVsb2NfY2FjaGUgKmNhY2hlLAogCWNhY2hlLT5uZWVkc191bmZlbmNlZCA9IElOVEVMX0lO
Rk8oaTkxNSktPnVuZmVuY2VkX25lZWRzX2FsaWdubWVudDsKIAljYWNoZS0+bm9kZS5mbGFncyA9
IDA7CiAJY2FjaGUtPnJxID0gTlVMTDsKLQljYWNoZS0+cnFfc2l6ZSA9IDA7CisJY2FjaGUtPnRh
cmdldCA9IE5VTEw7CiB9CiAKIHN0YXRpYyBpbmxpbmUgdm9pZCAqdW5tYXNrX3BhZ2UodW5zaWdu
ZWQgbG9uZyBwKQpAQCAtMTMyNSw3ICsxMzI1LDcgQEAgc3RhdGljIGludCBfX3JlbG9jX2dwdV9h
bGxvYyhzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYiwKIAogCQljZSA9IGludGVsX2NvbnRleHRf
Y3JlYXRlKGVuZ2luZSk7CiAJCWlmIChJU19FUlIoY2UpKSB7Ci0JCQllcnIgPSBQVFJfRVJSKHJx
KTsKKwkJCWVyciA9IFBUUl9FUlIoY2UpOwogCQkJZ290byBlcnJfdW5waW47CiAJCX0KIApAQCAt
MTM3Niw2ICsxMzc2LDExIEBAIHN0YXRpYyBpbnQgX19yZWxvY19ncHVfYWxsb2Moc3RydWN0IGk5
MTVfZXhlY2J1ZmZlciAqZWIsCiAJcmV0dXJuIGVycjsKIH0KIAorc3RhdGljIGJvb2wgY2FuX3N0
b3JlX2R3b3JkKGNvbnN0IHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKK3sKKwlyZXR1
cm4gZW5naW5lLT5jbGFzcyAhPSBWSURFT19ERUNPREVfQ0xBU1MgfHwgIUlTX0dFTihlbmdpbmUt
Pmk5MTUsIDYpOworfQorCiBzdGF0aWMgdTMyICpyZWxvY19ncHUoc3RydWN0IGk5MTVfZXhlY2J1
ZmZlciAqZWIsCiAJCSAgICAgIHN0cnVjdCBpOTE1X3ZtYSAqdm1hLAogCQkgICAgICB1bnNpZ25l
ZCBpbnQgbGVuKQpAQCAtMTM4Nyw5ICsxMzkyLDkgQEAgc3RhdGljIHUzMiAqcmVsb2NfZ3B1KHN0
cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViLAogCWlmICh1bmxpa2VseSghY2FjaGUtPnJxKSkgewog
CQlzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUgPSBlYi0+ZW5naW5lOwogCi0JCWlmICgh
aW50ZWxfZW5naW5lX2Nhbl9zdG9yZV9kd29yZChlbmdpbmUpKSB7CisJCWlmICghY2FuX3N0b3Jl
X2R3b3JkKGVuZ2luZSkpIHsKIAkJCWVuZ2luZSA9IGVuZ2luZS0+Z3QtPmVuZ2luZV9jbGFzc1tD
T1BZX0VOR0lORV9DTEFTU11bMF07Ci0JCQlpZiAoIWVuZ2luZSB8fCAhaW50ZWxfZW5naW5lX2Nh
bl9zdG9yZV9kd29yZChlbmdpbmUpKQorCQkJaWYgKCFlbmdpbmUpCiAJCQkJcmV0dXJuIEVSUl9Q
VFIoLUVOT0RFVik7CiAJCX0KIApAQCAtMTQzNSw5MSArMTQ0MCwxMzggQEAgc3RhdGljIGlubGlu
ZSBib29sIHVzZV9yZWxvY19ncHUoc3RydWN0IGk5MTVfdm1hICp2bWEpCiAJcmV0dXJuICFkbWFf
cmVzdl90ZXN0X3NpZ25hbGVkX3JjdSh2bWEtPnJlc3YsIHRydWUpOwogfQogCi1zdGF0aWMgdTY0
Ci1yZWxvY2F0ZV9lbnRyeShzdHJ1Y3QgaTkxNV92bWEgKnZtYSwKLQkgICAgICAgY29uc3Qgc3Ry
dWN0IGRybV9pOTE1X2dlbV9yZWxvY2F0aW9uX2VudHJ5ICpyZWxvYywKLQkgICAgICAgc3RydWN0
IGk5MTVfZXhlY2J1ZmZlciAqZWIsCi0JICAgICAgIGNvbnN0IHN0cnVjdCBpOTE1X3ZtYSAqdGFy
Z2V0KQorc3RhdGljIHVuc2lnbmVkIGxvbmcgdm1hX3BoeXNfYWRkcihzdHJ1Y3QgaTkxNV92bWEg
KnZtYSwgdTMyIG9mZnNldCkKIHsKLQl1NjQgb2Zmc2V0ID0gcmVsb2MtPm9mZnNldDsKLQl1NjQg
dGFyZ2V0X29mZnNldCA9IHJlbG9jYXRpb25fdGFyZ2V0KHJlbG9jLCB0YXJnZXQpOwotCWJvb2wg
d2lkZSA9IGViLT5yZWxvY19jYWNoZS51c2VfNjRiaXRfcmVsb2M7Ci0Jdm9pZCAqdmFkZHI7CisJ
c3RydWN0IHBhZ2UgKnBhZ2U7CisJdW5zaWduZWQgbG9uZyBhZGRyOwogCi0JaWYgKCFlYi0+cmVs
b2NfY2FjaGUudmFkZHIgJiYgdXNlX3JlbG9jX2dwdSh2bWEpKSB7Ci0JCWNvbnN0IHVuc2lnbmVk
IGludCBnZW4gPSBlYi0+cmVsb2NfY2FjaGUuZ2VuOwotCQl1bnNpZ25lZCBpbnQgbGVuOwotCQl1
MzIgKmJhdGNoOwotCQl1NjQgYWRkcjsKKwlHRU1fQlVHX09OKHZtYS0+cGFnZXMgIT0gdm1hLT5v
YmotPm1tLnBhZ2VzKTsKIAotCQlpZiAod2lkZSkKLQkJCWxlbiA9IG9mZnNldCAmIDcgPyA4IDog
NTsKLQkJZWxzZSBpZiAoZ2VuID49IDQpCi0JCQlsZW4gPSA0OwotCQllbHNlCi0JCQlsZW4gPSAz
OworCXBhZ2UgPSBpOTE1X2dlbV9vYmplY3RfZ2V0X3BhZ2Uodm1hLT5vYmosIG9mZnNldCA+PiBQ
QUdFX1NISUZUKTsKKwlhZGRyID0gUEZOX1BIWVMocGFnZV90b19wZm4ocGFnZSkpOworCUdFTV9C
VUdfT04ob3ZlcmZsb3dzX3R5cGUoYWRkciwgdTMyKSk7IC8qIGV4cGVjdGVkIGRtYTMyICovCiAK
LQkJYmF0Y2ggPSByZWxvY19ncHUoZWIsIHZtYSwgbGVuKTsKLQkJaWYgKElTX0VSUihiYXRjaCkp
Ci0JCQlnb3RvIHJlcGVhdDsKKwlyZXR1cm4gYWRkciArIG9mZnNldF9pbl9wYWdlKG9mZnNldCk7
Cit9CisKK3N0YXRpYyBib29sIF9fcmVsb2NfZW50cnlfZ3B1KHN0cnVjdCBpOTE1X3ZtYSAqdm1h
LAorCQkJICAgICAgc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIsCisJCQkgICAgICB1NjQgb2Zm
c2V0LAorCQkJICAgICAgdTY0IHRhcmdldF9hZGRyKQoreworCWNvbnN0IHVuc2lnbmVkIGludCBn
ZW4gPSBlYi0+cmVsb2NfY2FjaGUuZ2VuOworCXVuc2lnbmVkIGludCBsZW47CisJdTMyICpiYXRj
aDsKKwl1NjQgYWRkcjsKKworCWlmIChnZW4gPj0gOCkKKwkJbGVuID0gb2Zmc2V0ICYgNyA/IDgg
OiA1OworCWVsc2UgaWYgKGdlbiA+PSA0KQorCQlsZW4gPSA0OworCWVsc2UKKwkJbGVuID0gMzsK
KworCWJhdGNoID0gcmVsb2NfZ3B1KGViLCB2bWEsIGxlbik7CisJaWYgKElTX0VSUihiYXRjaCkp
CisJCXJldHVybiBmYWxzZTsKKworCWFkZHIgPSBnZW44X2Nhbm9uaWNhbF9hZGRyKHZtYS0+bm9k
ZS5zdGFydCArIG9mZnNldCk7CisJaWYgKGdlbiA+PSA4KSB7CisJCWlmIChvZmZzZXQgJiA3KSB7
CisJCQkqYmF0Y2grKyA9IE1JX1NUT1JFX0RXT1JEX0lNTV9HRU40OworCQkJKmJhdGNoKysgPSBs
b3dlcl8zMl9iaXRzKGFkZHIpOworCQkJKmJhdGNoKysgPSB1cHBlcl8zMl9iaXRzKGFkZHIpOwor
CQkJKmJhdGNoKysgPSBsb3dlcl8zMl9iaXRzKHRhcmdldF9hZGRyKTsKKworCQkJYWRkciA9IGdl
bjhfY2Fub25pY2FsX2FkZHIoYWRkciArIDQpOwogCi0JCWFkZHIgPSBnZW44X2Nhbm9uaWNhbF9h
ZGRyKHZtYS0+bm9kZS5zdGFydCArIG9mZnNldCk7Ci0JCWlmICh3aWRlKSB7Ci0JCQlpZiAob2Zm
c2V0ICYgNykgewotCQkJCSpiYXRjaCsrID0gTUlfU1RPUkVfRFdPUkRfSU1NX0dFTjQ7Ci0JCQkJ
KmJhdGNoKysgPSBsb3dlcl8zMl9iaXRzKGFkZHIpOwotCQkJCSpiYXRjaCsrID0gdXBwZXJfMzJf
Yml0cyhhZGRyKTsKLQkJCQkqYmF0Y2grKyA9IGxvd2VyXzMyX2JpdHModGFyZ2V0X29mZnNldCk7
Ci0KLQkJCQlhZGRyID0gZ2VuOF9jYW5vbmljYWxfYWRkcihhZGRyICsgNCk7Ci0KLQkJCQkqYmF0
Y2grKyA9IE1JX1NUT1JFX0RXT1JEX0lNTV9HRU40OwotCQkJCSpiYXRjaCsrID0gbG93ZXJfMzJf
Yml0cyhhZGRyKTsKLQkJCQkqYmF0Y2grKyA9IHVwcGVyXzMyX2JpdHMoYWRkcik7Ci0JCQkJKmJh
dGNoKysgPSB1cHBlcl8zMl9iaXRzKHRhcmdldF9vZmZzZXQpOwotCQkJfSBlbHNlIHsKLQkJCQkq
YmF0Y2grKyA9IChNSV9TVE9SRV9EV09SRF9JTU1fR0VONCB8ICgxIDw8IDIxKSkgKyAxOwotCQkJ
CSpiYXRjaCsrID0gbG93ZXJfMzJfYml0cyhhZGRyKTsKLQkJCQkqYmF0Y2grKyA9IHVwcGVyXzMy
X2JpdHMoYWRkcik7Ci0JCQkJKmJhdGNoKysgPSBsb3dlcl8zMl9iaXRzKHRhcmdldF9vZmZzZXQp
OwotCQkJCSpiYXRjaCsrID0gdXBwZXJfMzJfYml0cyh0YXJnZXRfb2Zmc2V0KTsKLQkJCX0KLQkJ
fSBlbHNlIGlmIChnZW4gPj0gNikgewogCQkJKmJhdGNoKysgPSBNSV9TVE9SRV9EV09SRF9JTU1f
R0VONDsKLQkJCSpiYXRjaCsrID0gMDsKLQkJCSpiYXRjaCsrID0gYWRkcjsKLQkJCSpiYXRjaCsr
ID0gdGFyZ2V0X29mZnNldDsKLQkJfSBlbHNlIGlmIChnZW4gPj0gNCkgewotCQkJKmJhdGNoKysg
PSBNSV9TVE9SRV9EV09SRF9JTU1fR0VONCB8IE1JX1VTRV9HR1RUOwotCQkJKmJhdGNoKysgPSAw
OwotCQkJKmJhdGNoKysgPSBhZGRyOwotCQkJKmJhdGNoKysgPSB0YXJnZXRfb2Zmc2V0OworCQkJ
KmJhdGNoKysgPSBsb3dlcl8zMl9iaXRzKGFkZHIpOworCQkJKmJhdGNoKysgPSB1cHBlcl8zMl9i
aXRzKGFkZHIpOworCQkJKmJhdGNoKysgPSB1cHBlcl8zMl9iaXRzKHRhcmdldF9hZGRyKTsKIAkJ
fSBlbHNlIHsKLQkJCSpiYXRjaCsrID0gTUlfU1RPUkVfRFdPUkRfSU1NIHwgTUlfTUVNX1ZJUlRV
QUw7Ci0JCQkqYmF0Y2grKyA9IGFkZHI7Ci0JCQkqYmF0Y2grKyA9IHRhcmdldF9vZmZzZXQ7CisJ
CQkqYmF0Y2grKyA9IChNSV9TVE9SRV9EV09SRF9JTU1fR0VONCB8ICgxIDw8IDIxKSkgKyAxOwor
CQkJKmJhdGNoKysgPSBsb3dlcl8zMl9iaXRzKGFkZHIpOworCQkJKmJhdGNoKysgPSB1cHBlcl8z
Ml9iaXRzKGFkZHIpOworCQkJKmJhdGNoKysgPSBsb3dlcl8zMl9iaXRzKHRhcmdldF9hZGRyKTsK
KwkJCSpiYXRjaCsrID0gdXBwZXJfMzJfYml0cyh0YXJnZXRfYWRkcik7CiAJCX0KLQotCQlnb3Rv
IG91dDsKKwl9IGVsc2UgaWYgKGdlbiA+PSA2KSB7CisJCSpiYXRjaCsrID0gTUlfU1RPUkVfRFdP
UkRfSU1NX0dFTjQ7CisJCSpiYXRjaCsrID0gMDsKKwkJKmJhdGNoKysgPSBhZGRyOworCQkqYmF0
Y2grKyA9IHRhcmdldF9hZGRyOworCX0gZWxzZSBpZiAoSVNfSTk2NUcoZWItPmk5MTUpKSB7CisJ
CSpiYXRjaCsrID0gTUlfU1RPUkVfRFdPUkRfSU1NX0dFTjQ7CisJCSpiYXRjaCsrID0gMDsKKwkJ
KmJhdGNoKysgPSB2bWFfcGh5c19hZGRyKHZtYSwgb2Zmc2V0KTsKKwkJKmJhdGNoKysgPSB0YXJn
ZXRfYWRkcjsKKwl9IGVsc2UgaWYgKGdlbiA+PSA0KSB7CisJCSpiYXRjaCsrID0gTUlfU1RPUkVf
RFdPUkRfSU1NX0dFTjQgfCBNSV9VU0VfR0dUVDsKKwkJKmJhdGNoKysgPSAwOworCQkqYmF0Y2gr
KyA9IGFkZHI7CisJCSpiYXRjaCsrID0gdGFyZ2V0X2FkZHI7CisJfSBlbHNlIGlmIChnZW4gPj0g
MyAmJgorCQkgICAhKElTX0k5MTVHKGViLT5pOTE1KSB8fCBJU19JOTE1R00oZWItPmk5MTUpKSkg
eworCQkqYmF0Y2grKyA9IE1JX1NUT1JFX0RXT1JEX0lNTSB8IE1JX01FTV9WSVJUVUFMOworCQkq
YmF0Y2grKyA9IGFkZHI7CisJCSpiYXRjaCsrID0gdGFyZ2V0X2FkZHI7CisJfSBlbHNlIHsKKwkJ
KmJhdGNoKysgPSBNSV9TVE9SRV9EV09SRF9JTU07CisJCSpiYXRjaCsrID0gdm1hX3BoeXNfYWRk
cih2bWEsIG9mZnNldCk7CisJCSpiYXRjaCsrID0gdGFyZ2V0X2FkZHI7CiAJfQogCisJcmV0dXJu
IHRydWU7Cit9CisKK3N0YXRpYyBib29sIHJlbG9jX2VudHJ5X2dwdShzdHJ1Y3QgaTkxNV92bWEg
KnZtYSwKKwkJCSAgICBzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYiwKKwkJCSAgICB1NjQgb2Zm
c2V0LAorCQkJICAgIHU2NCB0YXJnZXRfYWRkcikKK3sKKwlpZiAoZWItPnJlbG9jX2NhY2hlLnZh
ZGRyKQorCQlyZXR1cm4gZmFsc2U7CisKKwlpZiAoIXVzZV9yZWxvY19ncHUodm1hKSkKKwkJcmV0
dXJuIGZhbHNlOworCisJcmV0dXJuIF9fcmVsb2NfZW50cnlfZ3B1KHZtYSwgZWIsIG9mZnNldCwg
dGFyZ2V0X2FkZHIpOworfQorCitzdGF0aWMgdTY0CityZWxvY2F0ZV9lbnRyeShzdHJ1Y3QgaTkx
NV92bWEgKnZtYSwKKwkgICAgICAgY29uc3Qgc3RydWN0IGRybV9pOTE1X2dlbV9yZWxvY2F0aW9u
X2VudHJ5ICpyZWxvYywKKwkgICAgICAgc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIsCisJICAg
ICAgIGNvbnN0IHN0cnVjdCBpOTE1X3ZtYSAqdGFyZ2V0KQoreworCXU2NCB0YXJnZXRfYWRkciA9
IHJlbG9jYXRpb25fdGFyZ2V0KHJlbG9jLCB0YXJnZXQpOworCXU2NCBvZmZzZXQgPSByZWxvYy0+
b2Zmc2V0OworCisJaWYgKCFyZWxvY19lbnRyeV9ncHUodm1hLCBlYiwgb2Zmc2V0LCB0YXJnZXRf
YWRkcikpIHsKKwkJYm9vbCB3aWRlID0gZWItPnJlbG9jX2NhY2hlLnVzZV82NGJpdF9yZWxvYzsK
KwkJdm9pZCAqdmFkZHI7CisKIHJlcGVhdDoKLQl2YWRkciA9IHJlbG9jX3ZhZGRyKHZtYS0+b2Jq
LCAmZWItPnJlbG9jX2NhY2hlLCBvZmZzZXQgPj4gUEFHRV9TSElGVCk7Ci0JaWYgKElTX0VSUih2
YWRkcikpCi0JCXJldHVybiBQVFJfRVJSKHZhZGRyKTsKKwkJdmFkZHIgPSByZWxvY192YWRkcih2
bWEtPm9iaiwKKwkJCQkgICAgJmViLT5yZWxvY19jYWNoZSwKKwkJCQkgICAgb2Zmc2V0ID4+IFBB
R0VfU0hJRlQpOworCQlpZiAoSVNfRVJSKHZhZGRyKSkKKwkJCXJldHVybiBQVFJfRVJSKHZhZGRy
KTsKIAotCWNsZmx1c2hfd3JpdGUzMih2YWRkciArIG9mZnNldF9pbl9wYWdlKG9mZnNldCksCi0J
CQlsb3dlcl8zMl9iaXRzKHRhcmdldF9vZmZzZXQpLAotCQkJZWItPnJlbG9jX2NhY2hlLnZhZGRy
KTsKKwkJR0VNX0JVR19PTighSVNfQUxJR05FRChvZmZzZXQsIHNpemVvZih1MzIpKSk7CisJCWNs
Zmx1c2hfd3JpdGUzMih2YWRkciArIG9mZnNldF9pbl9wYWdlKG9mZnNldCksCisJCQkJbG93ZXJf
MzJfYml0cyh0YXJnZXRfYWRkciksCisJCQkJZWItPnJlbG9jX2NhY2hlLnZhZGRyKTsKIAotCWlm
ICh3aWRlKSB7Ci0JCW9mZnNldCArPSBzaXplb2YodTMyKTsKLQkJdGFyZ2V0X29mZnNldCA+Pj0g
MzI7Ci0JCXdpZGUgPSBmYWxzZTsKLQkJZ290byByZXBlYXQ7CisJCWlmICh3aWRlKSB7CisJCQlv
ZmZzZXQgKz0gc2l6ZW9mKHUzMik7CisJCQl0YXJnZXRfYWRkciA+Pj0gMzI7CisJCQl3aWRlID0g
ZmFsc2U7CisJCQlnb3RvIHJlcGVhdDsKKwkJfQogCX0KIAotb3V0OgogCXJldHVybiB0YXJnZXQt
Pm5vZGUuc3RhcnQgfCBVUERBVEU7CiB9CiAKQEAgLTMwMjIsMyArMzA3NCw3IEBAIGVuZDo7CiAJ
a3ZmcmVlKGV4ZWMyX2xpc3QpOwogCXJldHVybiBlcnI7CiB9CisKKyNpZiBJU19FTkFCTEVEKENP
TkZJR19EUk1fSTkxNV9TRUxGVEVTVCkKKyNpbmNsdWRlICJzZWxmdGVzdHMvaTkxNV9nZW1fZXhl
Y2J1ZmZlci5jIgorI2VuZGlmCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0v
c2VsZnRlc3RzL2k5MTVfZ2VtX2V4ZWNidWZmZXIuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dl
bS9zZWxmdGVzdHMvaTkxNV9nZW1fZXhlY2J1ZmZlci5jCm5ldyBmaWxlIG1vZGUgMTAwNjQ0Cmlu
ZGV4IDAwMDAwMDAwMDAwMC4uNTk1NTU3NzlkZDkxCi0tLSAvZGV2L251bGwKKysrIGIvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ2VtL3NlbGZ0ZXN0cy9pOTE1X2dlbV9leGVjYnVmZmVyLmMKQEAgLTAs
MCArMSwyMDYgQEAKKy8vIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNSVQKKy8qCisgKiBDb3B5
cmlnaHQgwqkgMjAyMCBJbnRlbCBDb3Jwb3JhdGlvbgorICovCisKKyNpbmNsdWRlICJpOTE1X3Nl
bGZ0ZXN0LmgiCisKKyNpbmNsdWRlICJndC9pbnRlbF9lbmdpbmVfcG0uaCIKKyNpbmNsdWRlICJz
ZWxmdGVzdHMvaWd0X2ZsdXNoX3Rlc3QuaCIKKworc3RhdGljIHZvaWQgaGV4ZHVtcChjb25zdCB2
b2lkICpidWYsIHNpemVfdCBsZW4pCit7CisJY29uc3Qgc2l6ZV90IHJvd3NpemUgPSA4ICogc2l6
ZW9mKHUzMik7CisJY29uc3Qgdm9pZCAqcHJldiA9IE5VTEw7CisJYm9vbCBza2lwID0gZmFsc2U7
CisJc2l6ZV90IHBvczsKKworCWZvciAocG9zID0gMDsgcG9zIDwgbGVuOyBwb3MgKz0gcm93c2l6
ZSkgeworCQljaGFyIGxpbmVbMTI4XTsKKworCQlpZiAocHJldiAmJiAhbWVtY21wKHByZXYsIGJ1
ZiArIHBvcywgcm93c2l6ZSkpIHsKKwkJCWlmICghc2tpcCkgeworCQkJCXByX2luZm8oIipcbiIp
OworCQkJCXNraXAgPSB0cnVlOworCQkJfQorCQkJY29udGludWU7CisJCX0KKworCQlXQVJOX09O
X09OQ0UoaGV4X2R1bXBfdG9fYnVmZmVyKGJ1ZiArIHBvcywgbGVuIC0gcG9zLAorCQkJCQkJcm93
c2l6ZSwgc2l6ZW9mKHUzMiksCisJCQkJCQlsaW5lLCBzaXplb2YobGluZSksCisJCQkJCQlmYWxz
ZSkgPj0gc2l6ZW9mKGxpbmUpKTsKKwkJcHJfaW5mbygiWyUwNHp4XSAlc1xuIiwgcG9zLCBsaW5l
KTsKKworCQlwcmV2ID0gYnVmICsgcG9zOworCQlza2lwID0gZmFsc2U7CisJfQorfQorCitzdGF0
aWMgdTY0IHJlYWRfcmVsb2MoY29uc3QgdTMyICptYXAsIGludCB4LCBjb25zdCB1NjQgbWFzaykK
K3sKKwl1NjQgcmVsb2M7CisKKwltZW1jcHkoJnJlbG9jLCAmbWFwW3hdLCBzaXplb2YocmVsb2Mp
KTsKKwlyZXR1cm4gcmVsb2MgJiBtYXNrOworfQorCitzdGF0aWMgaW50IF9faWd0X2dwdV9yZWxv
YyhzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYiwKKwkJCSAgIHN0cnVjdCBkcm1faTkxNV9nZW1f
b2JqZWN0ICpvYmopCit7CisJZW51bSB7CisJCVggPSAwLAorCQlZID0gMywKKwkJWiA9IDgKKwl9
OworCWNvbnN0IHU2NCBtYXNrID0gR0VOTUFTSyhlYi0+cmVsb2NfY2FjaGUuZ2VuID49IDggPyA2
MyA6IDMxLCAwKTsKKwljb25zdCB1MzIgKm1hcCA9IHBhZ2VfbWFza19iaXRzKG9iai0+bW0ubWFw
cGluZyk7CisJc3RydWN0IGk5MTVfcmVxdWVzdCAqcnE7CisJc3RydWN0IGk5MTVfdm1hICp2bWE7
CisJaW50IGluYzsKKwlpbnQgZXJyOworCisJdm1hID0gaTkxNV92bWFfaW5zdGFuY2Uob2JqLCBl
Yi0+Y29udGV4dC0+dm0sIE5VTEwpOworCWlmIChJU19FUlIodm1hKSkKKwkJcmV0dXJuIFBUUl9F
UlIodm1hKTsKKworCWVyciA9IGk5MTVfdm1hX3Bpbih2bWEsIDAsIDAsIFBJTl9VU0VSIHwgUElO
X0hJR0gpOworCWlmIChlcnIpCisJCXJldHVybiBlcnI7CisKKwkvKiA4LUJ5dGUgYWxpZ25lZCAq
LworCWlmICghX19yZWxvY19lbnRyeV9ncHUodm1hLCBlYiwgWCAqIHNpemVvZih1MzIpLCBYKSkg
eworCQllcnIgPSAtRUlPOworCQlnb3RvIHVucGluX3ZtYTsKKwl9CisKKwkvKiAhOC1CeXRlIGFs
aWduZWQgKi8KKwlpZiAoIV9fcmVsb2NfZW50cnlfZ3B1KHZtYSwgZWIsIFkgKiBzaXplb2YodTMy
KSwgWSkpIHsKKwkJZXJyID0gLUVJTzsKKwkJZ290byB1bnBpbl92bWE7CisJfQorCisJLyogU2tp
cCB0byB0aGUgZW5kIG9mIHRoZSBjbWQgcGFnZSAqLworCWluYyA9IFBBR0VfU0laRSAvIHNpemVv
Zih1MzIpIC0gUkVMT0NfVEFJTCAtIDE7CisJaW5jIC09IGViLT5yZWxvY19jYWNoZS5ycV9zaXpl
OworCW1lbXNldChlYi0+cmVsb2NfY2FjaGUucnFfY21kICsgZWItPnJlbG9jX2NhY2hlLnJxX3Np
emUsCisJICAgICAgIDAsIGluYyAqIHNpemVvZih1MzIpKTsKKwllYi0+cmVsb2NfY2FjaGUucnFf
c2l6ZSArPSBpbmM7CisKKwkvKiBGb3JjZSBiYXRjaCBjaGFpbmluZyAqLworCWlmICghX19yZWxv
Y19lbnRyeV9ncHUodm1hLCBlYiwgWiAqIHNpemVvZih1MzIpLCBaKSkgeworCQllcnIgPSAtRUlP
OworCQlnb3RvIHVucGluX3ZtYTsKKwl9CisKKwlHRU1fQlVHX09OKCFlYi0+cmVsb2NfY2FjaGUu
cnEpOworCXJxID0gaTkxNV9yZXF1ZXN0X2dldChlYi0+cmVsb2NfY2FjaGUucnEpOworCWVyciA9
IHJlbG9jX2dwdV9mbHVzaCgmZWItPnJlbG9jX2NhY2hlKTsKKwlpZiAoZXJyKQorCQlnb3RvIHB1
dF9ycTsKKwlHRU1fQlVHX09OKGViLT5yZWxvY19jYWNoZS5ycSk7CisKKwllcnIgPSBpOTE1X2dl
bV9vYmplY3Rfd2FpdChvYmosIEk5MTVfV0FJVF9JTlRFUlJVUFRJQkxFLCBIWiAvIDIpOworCWlm
IChlcnIpIHsKKwkJaW50ZWxfZ3Rfc2V0X3dlZGdlZChlYi0+ZW5naW5lLT5ndCk7CisJCWdvdG8g
cHV0X3JxOworCX0KKworCWlmICghaTkxNV9yZXF1ZXN0X2NvbXBsZXRlZChycSkpIHsKKwkJcHJf
ZXJyKCIlczogZGlkIG5vdCB3YWl0IGZvciByZWxvY2F0aW9ucyFcbiIsIGViLT5lbmdpbmUtPm5h
bWUpOworCQllcnIgPSAtRUlOVkFMOworCQlnb3RvIHB1dF9ycTsKKwl9CisKKwlpZiAocmVhZF9y
ZWxvYyhtYXAsIFgsIG1hc2spICE9IFgpIHsKKwkJcHJfZXJyKCIlc1tYXTogbWFwWyVkXSAlbGx4
ICE9ICV4XG4iLAorCQkgICAgICAgZWItPmVuZ2luZS0+bmFtZSwgWCwgcmVhZF9yZWxvYyhtYXAs
IFgsIG1hc2spLCBYKTsKKwkJZXJyID0gLUVJTlZBTDsKKwl9CisKKwlpZiAocmVhZF9yZWxvYyht
YXAsIFksIG1hc2spICE9IFkpIHsKKwkJcHJfZXJyKCIlc1tZXTogbWFwWyVkXSAlbGx4ICE9ICV4
XG4iLAorCQkgICAgICAgZWItPmVuZ2luZS0+bmFtZSwgWSwgcmVhZF9yZWxvYyhtYXAsIFksIG1h
c2spLCBZKTsKKwkJZXJyID0gLUVJTlZBTDsKKwl9CisKKwlpZiAocmVhZF9yZWxvYyhtYXAsIFos
IG1hc2spICE9IFopIHsKKwkJcHJfZXJyKCIlc1taXTogbWFwWyVkXSAlbGx4ICE9ICV4XG4iLAor
CQkgICAgICAgZWItPmVuZ2luZS0+bmFtZSwgWiwgcmVhZF9yZWxvYyhtYXAsIFosIG1hc2spLCBa
KTsKKwkJZXJyID0gLUVJTlZBTDsKKwl9CisKKwlpZiAoZXJyKQorCQloZXhkdW1wKG1hcCwgNDA5
Nik7CisKK3B1dF9ycToKKwlpOTE1X3JlcXVlc3RfcHV0KHJxKTsKK3VucGluX3ZtYToKKwlpOTE1
X3ZtYV91bnBpbih2bWEpOworCXJldHVybiBlcnI7Cit9CisKK3N0YXRpYyBpbnQgaWd0X2dwdV9y
ZWxvYyh2b2lkICphcmcpCit7CisJc3RydWN0IGk5MTVfZXhlY2J1ZmZlciBlYjsKKwlzdHJ1Y3Qg
ZHJtX2k5MTVfZ2VtX29iamVjdCAqc2NyYXRjaDsKKwlpbnQgZXJyID0gMDsKKwl1MzIgKm1hcDsK
KworCWViLmk5MTUgPSBhcmc7CisKKwlzY3JhdGNoID0gaTkxNV9nZW1fb2JqZWN0X2NyZWF0ZV9p
bnRlcm5hbChlYi5pOTE1LCA0MDk2KTsKKwlpZiAoSVNfRVJSKHNjcmF0Y2gpKQorCQlyZXR1cm4g
UFRSX0VSUihzY3JhdGNoKTsKKworCW1hcCA9IGk5MTVfZ2VtX29iamVjdF9waW5fbWFwKHNjcmF0
Y2gsIEk5MTVfTUFQX1dDKTsKKwlpZiAoSVNfRVJSKG1hcCkpIHsKKwkJZXJyID0gUFRSX0VSUiht
YXApOworCQlnb3RvIGVycl9zY3JhdGNoOworCX0KKworCWZvcl9lYWNoX3VhYmlfZW5naW5lKGVi
LmVuZ2luZSwgZWIuaTkxNSkgeworCQlyZWxvY19jYWNoZV9pbml0KCZlYi5yZWxvY19jYWNoZSwg
ZWIuaTkxNSk7CisJCW1lbXNldChtYXAsIFBPSVNPTl9JTlVTRSwgNDA5Nik7CisKKwkJaW50ZWxf
ZW5naW5lX3BtX2dldChlYi5lbmdpbmUpOworCQllYi5jb250ZXh0ID0gaW50ZWxfY29udGV4dF9j
cmVhdGUoZWIuZW5naW5lKTsKKwkJaWYgKElTX0VSUihlYi5jb250ZXh0KSkgeworCQkJZXJyID0g
UFRSX0VSUihlYi5jb250ZXh0KTsKKwkJCWdvdG8gZXJyX3BtOworCQl9CisKKwkJZXJyID0gaW50
ZWxfY29udGV4dF9waW4oZWIuY29udGV4dCk7CisJCWlmIChlcnIpCisJCQlnb3RvIGVycl9wdXQ7
CisKKwkJZXJyID0gX19pZ3RfZ3B1X3JlbG9jKCZlYiwgc2NyYXRjaCk7CisKKwkJaW50ZWxfY29u
dGV4dF91bnBpbihlYi5jb250ZXh0KTsKK2Vycl9wdXQ6CisJCWludGVsX2NvbnRleHRfcHV0KGVi
LmNvbnRleHQpOworZXJyX3BtOgorCQlpbnRlbF9lbmdpbmVfcG1fcHV0KGViLmVuZ2luZSk7CisJ
CWlmIChlcnIpCisJCQlicmVhazsKKwl9CisKKwlpZiAoaWd0X2ZsdXNoX3Rlc3QoZWIuaTkxNSkp
CisJCWVyciA9IC1FSU87CisKK2Vycl9zY3JhdGNoOgorCWk5MTVfZ2VtX29iamVjdF9wdXQoc2Ny
YXRjaCk7CisJcmV0dXJuIGVycjsKK30KKworaW50IGk5MTVfZ2VtX2V4ZWNidWZmZXJfbGl2ZV9z
ZWxmdGVzdHMoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCit7CisJc3RhdGljIGNvbnN0
IHN0cnVjdCBpOTE1X3N1YnRlc3QgdGVzdHNbXSA9IHsKKwkJU1VCVEVTVChpZ3RfZ3B1X3JlbG9j
KSwKKwl9OworCisJaWYgKGludGVsX2d0X2lzX3dlZGdlZCgmaTkxNS0+Z3QpKQorCQlyZXR1cm4g
MDsKKworCXJldHVybiBpOTE1X2xpdmVfc3VidGVzdHModGVzdHMsIGk5MTUpOworfQpkaWZmIC0t
Z2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvc2VsZnRlc3RzL2k5MTVfbGl2ZV9zZWxmdGVzdHMu
aCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L3NlbGZ0ZXN0cy9pOTE1X2xpdmVfc2VsZnRlc3RzLmgK
aW5kZXggMGE5NTNiZmMwNTg1Li41ZGQ1ZDgxNjQ2YzQgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L3NlbGZ0ZXN0cy9pOTE1X2xpdmVfc2VsZnRlc3RzLmgKKysrIGIvZHJpdmVycy9n
cHUvZHJtL2k5MTUvc2VsZnRlc3RzL2k5MTVfbGl2ZV9zZWxmdGVzdHMuaApAQCAtMzcsNiArMzcs
NyBAQCBzZWxmdGVzdChnZW0sIGk5MTVfZ2VtX2xpdmVfc2VsZnRlc3RzKQogc2VsZnRlc3QoZXZp
Y3QsIGk5MTVfZ2VtX2V2aWN0X2xpdmVfc2VsZnRlc3RzKQogc2VsZnRlc3QoaHVnZXBhZ2VzLCBp
OTE1X2dlbV9odWdlX3BhZ2VfbGl2ZV9zZWxmdGVzdHMpCiBzZWxmdGVzdChnZW1fY29udGV4dHMs
IGk5MTVfZ2VtX2NvbnRleHRfbGl2ZV9zZWxmdGVzdHMpCitzZWxmdGVzdChnZW1fZXhlY2J1Ziwg
aTkxNV9nZW1fZXhlY2J1ZmZlcl9saXZlX3NlbGZ0ZXN0cykKIHNlbGZ0ZXN0KGJsdCwgaTkxNV9n
ZW1fb2JqZWN0X2JsdF9saXZlX3NlbGZ0ZXN0cykKIHNlbGZ0ZXN0KGNsaWVudCwgaTkxNV9nZW1f
Y2xpZW50X2JsdF9saXZlX3NlbGZ0ZXN0cykKIHNlbGZ0ZXN0KHJlc2V0LCBpbnRlbF9yZXNldF9s
aXZlX3NlbGZ0ZXN0cykKLS0gCjIuMjAuMQoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMu
ZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlz
dGluZm8vaW50ZWwtZ2Z4Cg==

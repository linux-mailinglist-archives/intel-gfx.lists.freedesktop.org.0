Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 52E8263765
	for <lists+intel-gfx@lfdr.de>; Tue,  9 Jul 2019 16:02:31 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 468FB89686;
	Tue,  9 Jul 2019 14:02:29 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 88CB489686
 for <intel-gfx@lists.freedesktop.org>; Tue,  9 Jul 2019 14:02:27 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17185939-1500050 
 for multiple; Tue, 09 Jul 2019 15:02:13 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Tue,  9 Jul 2019 15:02:12 +0100
Message-Id: <20190709140212.23849-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.22.0
In-Reply-To: <20190709130303.27990-1-chris@chris-wilson.co.uk>
References: <20190709130303.27990-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v2] drm/i915: Lock the engine while dumping the
 active request
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Alex Shumsky <alexthreed@gmail.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

V2UgY2Fubm90IGxldCB0aGUgcmVxdWVzdCBiZSByZXRpcmVkIGFuZCBmcmVlZCB3aGlsZSB3ZSBh
cmUgdHJ5aW5nIHRvCmR1bXAgaXQgZHVyaW5nIGVycm9yIGNhcHR1cmUuIEl0IGlzIG5vdCBzdWZm
aWNpZW50IGp1c3QgdG8gZ3JhYiBhCnJlZmVyZW5jZSB0byB0aGUgcmVxdWVzdCwgYXMgZHVyaW5n
IHJldGlyZW1lbnQgd2UgbWF5IGZyZWUgdGhlIHJpbmcKd2hpY2ggd2UgYXJlIGFsc28gZHVtcGlu
Zy4gU28gdGFrZSB0aGUgZW5naW5lIGxvY2sgdG8gcHJldmVudCByZXRpcmluZwphbmQgZnJlZWlu
ZyBvZiB0aGUgcmVxdWVzdC4KClJlcG9ydGVkLWJ5OiBBbGV4IFNodW1za3kgPGFsZXh0aHJlZWRA
Z21haWwuY29tPgpGaXhlczogODNjMzE3ODMyZWIxICgiZHJtL2k5MTU6IER1bXAgdGhlIHJpbmdi
dWZmZXIgb2YgdGhlIGFjdGl2ZSByZXF1ZXN0IGZvciBkZWJ1Z2dpbmciKQpTaWduZWQtb2ZmLWJ5
OiBDaHJpcyBXaWxzb24gPGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KQ2M6IFR2cnRrbyBVcnN1
bGluIDx0dnJ0a28udXJzdWxpbkBpbnRlbC5jb20+CkNjOiBKb29uYXMgTGFodGluZW4gPGpvb25h
cy5sYWh0aW5lbkBsaW51eC5pbnRlbC5jb20+CkNjOiBBbGV4IFNodW1za3kgPGFsZXh0aHJlZWRA
Z21haWwuY29tPgotLS0KUmVtb3ZlIHRoZSBzdXBlcmZsdW91cyBjaGFuZ2VzLgotQ2hyaXMKLS0t
CiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfY3MuYyB8IDExICsrKystLS0t
LS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dwdV9lcnJvci5jICAgICB8ICA2ICsrKyst
LQogMiBmaWxlcyBjaGFuZ2VkLCA4IGluc2VydGlvbnMoKyksIDkgZGVsZXRpb25zKC0pCgpkaWZm
IC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZW5naW5lX2NzLmMgYi9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfY3MuYwppbmRleCBiZGYyNzlmYTNiMmUu
LjBhMmU3YTQwNGM3NCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxf
ZW5naW5lX2NzLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZW5naW5lX2Nz
LmMKQEAgLTE0ODQsNiArMTQ4NCw3IEBAIHZvaWQgaW50ZWxfZW5naW5lX2R1bXAoc3RydWN0IGlu
dGVsX2VuZ2luZV9jcyAqZW5naW5lLAogCXN0cnVjdCBpOTE1X2dwdV9lcnJvciAqIGNvbnN0IGVy
cm9yID0gJmVuZ2luZS0+aTkxNS0+Z3B1X2Vycm9yOwogCXN0cnVjdCBpOTE1X3JlcXVlc3QgKnJx
OwogCWludGVsX3dha2VyZWZfdCB3YWtlcmVmOworCXVuc2lnbmVkIGxvbmcgZmxhZ3M7CiAKIAlp
ZiAoaGVhZGVyKSB7CiAJCXZhX2xpc3QgYXA7CkBAIC0xNTAzLDEwICsxNTA0LDkgQEAgdm9pZCBp
bnRlbF9lbmdpbmVfZHVtcChzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUsCiAJCSAgIGk5
MTVfcmVzZXRfZW5naW5lX2NvdW50KGVycm9yLCBlbmdpbmUpLAogCQkgICBpOTE1X3Jlc2V0X2Nv
dW50KGVycm9yKSk7CiAKLQlyY3VfcmVhZF9sb2NrKCk7Ci0KIAlkcm1fcHJpbnRmKG0sICJcdFJl
cXVlc3RzOlxuIik7CiAKKwlzcGluX2xvY2tfaXJxc2F2ZSgmZW5naW5lLT5hY3RpdmUubG9jaywg
ZmxhZ3MpOwogCXJxID0gaW50ZWxfZW5naW5lX2ZpbmRfYWN0aXZlX3JlcXVlc3QoZW5naW5lKTsK
IAlpZiAocnEpIHsKIAkJcHJpbnRfcmVxdWVzdChtLCBycSwgIlx0XHRhY3RpdmUgIik7CkBAIC0x
NTI2LDggKzE1MjYsNyBAQCB2b2lkIGludGVsX2VuZ2luZV9kdW1wKHN0cnVjdCBpbnRlbF9lbmdp
bmVfY3MgKmVuZ2luZSwKIAogCQlwcmludF9yZXF1ZXN0X3JpbmcobSwgcnEpOwogCX0KLQotCXJj
dV9yZWFkX3VubG9jaygpOworCXNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJmVuZ2luZS0+YWN0aXZl
LmxvY2ssIGZsYWdzKTsKIAogCXdha2VyZWYgPSBpbnRlbF9ydW50aW1lX3BtX2dldF9pZl9pbl91
c2UoJmVuZ2luZS0+aTkxNS0+cnVudGltZV9wbSk7CiAJaWYgKHdha2VyZWYpIHsKQEAgLTE2ODks
NyArMTY4OCw2IEBAIHN0cnVjdCBpOTE1X3JlcXVlc3QgKgogaW50ZWxfZW5naW5lX2ZpbmRfYWN0
aXZlX3JlcXVlc3Qoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lKQogewogCXN0cnVjdCBp
OTE1X3JlcXVlc3QgKnJlcXVlc3QsICphY3RpdmUgPSBOVUxMOwotCXVuc2lnbmVkIGxvbmcgZmxh
Z3M7CiAKIAkvKgogCSAqIFdlIGFyZSBjYWxsZWQgYnkgdGhlIGVycm9yIGNhcHR1cmUsIHJlc2V0
IGFuZCB0byBkdW1wIGVuZ2luZQpAQCAtMTcwMiw3ICsxNzAwLDcgQEAgaW50ZWxfZW5naW5lX2Zp
bmRfYWN0aXZlX3JlcXVlc3Qoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lKQogCSAqIEF0
IGFsbCBvdGhlciB0aW1lcywgd2UgbXVzdCBhc3N1bWUgdGhlIEdQVSBpcyBzdGlsbCBydW5uaW5n
LCBidXQKIAkgKiB3ZSBvbmx5IGNhcmUgYWJvdXQgdGhlIHNuYXBzaG90IG9mIHRoaXMgbW9tZW50
LgogCSAqLwotCXNwaW5fbG9ja19pcnFzYXZlKCZlbmdpbmUtPmFjdGl2ZS5sb2NrLCBmbGFncyk7
CisJbG9ja2RlcF9hc3NlcnRfaGVsZCgmZW5naW5lLT5hY3RpdmUubG9jayk7CiAJbGlzdF9mb3Jf
ZWFjaF9lbnRyeShyZXF1ZXN0LCAmZW5naW5lLT5hY3RpdmUucmVxdWVzdHMsIHNjaGVkLmxpbmsp
IHsKIAkJaWYgKGk5MTVfcmVxdWVzdF9jb21wbGV0ZWQocmVxdWVzdCkpCiAJCQljb250aW51ZTsK
QEAgLTE3MTcsNyArMTcxNSw2IEBAIGludGVsX2VuZ2luZV9maW5kX2FjdGl2ZV9yZXF1ZXN0KHN0
cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKIAkJYWN0aXZlID0gcmVxdWVzdDsKIAkJYnJl
YWs7CiAJfQotCXNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJmVuZ2luZS0+YWN0aXZlLmxvY2ssIGZs
YWdzKTsKIAogCXJldHVybiBhY3RpdmU7CiB9CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9pOTE1X2dwdV9lcnJvci5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9ncHVfZXJy
b3IuYwppbmRleCA1NDg5Y2Q4NzkzMTUuLmYyOTdhNDNkZjFlOSAxMDA2NDQKLS0tIGEvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvaTkxNV9ncHVfZXJyb3IuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9pOTE1X2dwdV9lcnJvci5jCkBAIC0xNDExLDYgKzE0MTEsNyBAQCBzdGF0aWMgdm9pZCBnZW1f
cmVjb3JkX3JpbmdzKHN0cnVjdCBpOTE1X2dwdV9zdGF0ZSAqZXJyb3IpCiAJCXN0cnVjdCBpbnRl
bF9lbmdpbmVfY3MgKmVuZ2luZSA9IGk5MTUtPmVuZ2luZVtpXTsKIAkJc3RydWN0IGRybV9pOTE1
X2Vycm9yX2VuZ2luZSAqZWUgPSAmZXJyb3ItPmVuZ2luZVtpXTsKIAkJc3RydWN0IGk5MTVfcmVx
dWVzdCAqcmVxdWVzdDsKKwkJdW5zaWduZWQgbG9uZyBmbGFnczsKIAogCQllZS0+ZW5naW5lX2lk
ID0gLTE7CiAKQEAgLTE0MjIsMTAgKzE0MjMsMTEgQEAgc3RhdGljIHZvaWQgZ2VtX3JlY29yZF9y
aW5ncyhzdHJ1Y3QgaTkxNV9ncHVfc3RhdGUgKmVycm9yKQogCQllcnJvcl9yZWNvcmRfZW5naW5l
X3JlZ2lzdGVycyhlcnJvciwgZW5naW5lLCBlZSk7CiAJCWVycm9yX3JlY29yZF9lbmdpbmVfZXhl
Y2xpc3RzKGVuZ2luZSwgZWUpOwogCisJCXNwaW5fbG9ja19pcnFzYXZlKCZlbmdpbmUtPmFjdGl2
ZS5sb2NrLCBmbGFncyk7CiAJCXJlcXVlc3QgPSBpbnRlbF9lbmdpbmVfZmluZF9hY3RpdmVfcmVx
dWVzdChlbmdpbmUpOwogCQlpZiAocmVxdWVzdCkgewogCQkJc3RydWN0IGk5MTVfZ2VtX2NvbnRl
eHQgKmN0eCA9IHJlcXVlc3QtPmdlbV9jb250ZXh0OwotCQkJc3RydWN0IGludGVsX3JpbmcgKnJp
bmc7CisJCQlzdHJ1Y3QgaW50ZWxfcmluZyAqcmluZyA9IHJlcXVlc3QtPnJpbmc7CiAKIAkJCWVl
LT52bSA9IGN0eC0+dm0gPzogJmVuZ2luZS0+Z3QtPmdndHQtPnZtOwogCkBAIC0xNDU1LDcgKzE0
NTcsNiBAQCBzdGF0aWMgdm9pZCBnZW1fcmVjb3JkX3JpbmdzKHN0cnVjdCBpOTE1X2dwdV9zdGF0
ZSAqZXJyb3IpCiAJCQllZS0+cnFfcG9zdCA9IHJlcXVlc3QtPnBvc3RmaXg7CiAJCQllZS0+cnFf
dGFpbCA9IHJlcXVlc3QtPnRhaWw7CiAKLQkJCXJpbmcgPSByZXF1ZXN0LT5yaW5nOwogCQkJZWUt
PmNwdV9yaW5nX2hlYWQgPSByaW5nLT5oZWFkOwogCQkJZWUtPmNwdV9yaW5nX3RhaWwgPSByaW5n
LT50YWlsOwogCQkJZWUtPnJpbmdidWZmZXIgPQpAQCAtMTQ2Myw2ICsxNDY0LDcgQEAgc3RhdGlj
IHZvaWQgZ2VtX3JlY29yZF9yaW5ncyhzdHJ1Y3QgaTkxNV9ncHVfc3RhdGUgKmVycm9yKQogCiAJ
CQllbmdpbmVfcmVjb3JkX3JlcXVlc3RzKGVuZ2luZSwgcmVxdWVzdCwgZWUpOwogCQl9CisJCXNw
aW5fdW5sb2NrX2lycXJlc3RvcmUoJmVuZ2luZS0+YWN0aXZlLmxvY2ssIGZsYWdzKTsKIAogCQll
ZS0+aHdzX3BhZ2UgPQogCQkJaTkxNV9lcnJvcl9vYmplY3RfY3JlYXRlKGk5MTUsCi0tIAoyLjIy
LjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCkludGVs
LWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczov
L2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWdmeA==

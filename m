Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 4902A33734
	for <lists+intel-gfx@lfdr.de>; Mon,  3 Jun 2019 19:49:49 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 9D948892CA;
	Mon,  3 Jun 2019 17:49:46 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 80B3F892C6
 for <intel-gfx@lists.freedesktop.org>; Mon,  3 Jun 2019 17:49:45 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 16778867-1500050 
 for multiple; Mon, 03 Jun 2019 18:49:39 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon,  3 Jun 2019 18:49:35 +0100
Message-Id: <20190603174935.23982-7-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190603174935.23982-1-chris@chris-wilson.co.uk>
References: <20190603174935.23982-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 7/7] drm/i915: Allow vma binding to occur
 asynchronously
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SWYgd2UgbGV0IHBhZ2VzIGJlIGFsbG9jYXRlZCBhc3luY2hyb25vdXNseSwgd2UgYWxzbyB0aGVu
IHdhbnQgdG8gcHVzaAp0aGUgYmluZGluZyBwcm9jZXNzIGludG8gYW4gYXN5bmNocm9ub3VzIHRh
c2suIE1ha2UgaXQgc28sIHV0aWxpc2luZyB0aGUKcmVjZW50IGltcHJvdmVtZW50cyB0byBmZW5j
ZSBlcnJvciB0cmFja2luZyBhbmQgc3RydWN0X211dGV4IHJlZHVjdGlvbi4KClNpZ25lZC1vZmYt
Ynk6IENocmlzIFdpbHNvbiA8Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPgotLS0KIC4uLi9ncHUv
ZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2V4ZWNidWZmZXIuYyAgICB8ICAxNCArLQogLi4uL2RybS9p
OTE1L2dlbS9zZWxmdGVzdHMvaTkxNV9nZW1fY29udGV4dC5jIHwgICA0ICsKIGRyaXZlcnMvZ3B1
L2RybS9pOTE1L2k5MTVfZ2VtX2d0dC5jICAgICAgICAgICB8ICAyOSArKy0KIGRyaXZlcnMvZ3B1
L2RybS9pOTE1L2k5MTVfdm1hLmMgICAgICAgICAgICAgICB8IDE3MCArKysrKysrKysrKysrKyst
LS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfdm1hLmggICAgICAgICAgICAgICB8ICAgOSAr
CiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9zZWxmdGVzdHMvaTkxNV92bWEuYyAgICAgfCAgIDQgKy0K
IDYgZmlsZXMgY2hhbmdlZCwgMTkxIGluc2VydGlvbnMoKyksIDM5IGRlbGV0aW9ucygtKQoKZGlm
ZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9leGVjYnVmZmVyLmMg
Yi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fZXhlY2J1ZmZlci5jCmluZGV4IDY1
MTNlZTRiY2VkYi4uNmYxODgxNjZmNGE2IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9nZW0vaTkxNV9nZW1fZXhlY2J1ZmZlci5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dl
bS9pOTE1X2dlbV9leGVjYnVmZmVyLmMKQEAgLTU4MCw2ICs1ODAsMTUgQEAgc3RhdGljIGludCBl
Yl9yZXNlcnZlX3ZtYShjb25zdCBzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYiwKIAl1NjQgcGlu
X2ZsYWdzOwogCWludCBlcnI7CiAKKwkvKgorCSAqIElmIHdlIGxvYWQgdGhlIHBhZ2VzIGFzeW5j
aHJvbm91c2x5LCB0aGVuIHRoZSB1c2VyICptdXN0KgorCSAqIG9iZXkgdGhlIHJlc2VydmF0aW9u
X29iamVjdCBhbmQgbm90IGJ5cGFzcyB3YWl0aW5nIG9uIGl0LgorCSAqIE9uIHRoZSBwb3NpdGl2
ZSBzaWRlLCBpZiB0aGUgdm1hIGlzIG5vdCB5ZXQgYm91bmQgKG5vIHBhZ2VzISksCisJICogdGhl
biBpdCBzaG91bGQgbm90IGhhdmUgYW55IGFubm95aW5nIGltcGxpY2l0IGZlbmNlcy4KKwkgKi8K
KwlpZiAoZXhlY19mbGFncyAmIEVYRUNfT0JKRUNUX0FTWU5DICYmICF2bWEtPnBhZ2VzKQorCQkq
dm1hLT5leGVjX2ZsYWdzICY9IH5FWEVDX09CSkVDVF9BU1lOQzsKKwogCXBpbl9mbGFncyA9IFBJ
Tl9VU0VSIHwgUElOX05PTkJMT0NLOwogCWlmIChleGVjX2ZsYWdzICYgRVhFQ19PQkpFQ1RfTkVF
RFNfR1RUKQogCQlwaW5fZmxhZ3MgfD0gUElOX0dMT0JBTDsKQEAgLTEyMzYsOCArMTI0NSw5IEBA
IHN0YXRpYyBpbnQgX19yZWxvY19ncHVfYWxsb2Moc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIs
CiAJCWdvdG8gc2tpcF9yZXF1ZXN0OwogCiAJaTkxNV92bWFfbG9jayhiYXRjaCk7Ci0JR0VNX0JV
R19PTighcmVzZXJ2YXRpb25fb2JqZWN0X3Rlc3Rfc2lnbmFsZWRfcmN1KGJhdGNoLT5yZXN2LCB0
cnVlKSk7Ci0JZXJyID0gaTkxNV92bWFfbW92ZV90b19hY3RpdmUoYmF0Y2gsIHJxLCAwKTsKKwll
cnIgPSBpOTE1X3JlcXVlc3RfYXdhaXRfb2JqZWN0KHJxLCBiYXRjaC0+b2JqLCBmYWxzZSk7CisJ
aWYgKGVyciA9PSAwKQorCQllcnIgPSBpOTE1X3ZtYV9tb3ZlX3RvX2FjdGl2ZShiYXRjaCwgcnEs
IDApOwogCWk5MTVfdm1hX3VubG9jayhiYXRjaCk7CiAJaWYgKGVycikKIAkJZ290byBza2lwX3Jl
cXVlc3Q7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vc2VsZnRlc3RzL2k5
MTVfZ2VtX2NvbnRleHQuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMvaTkx
NV9nZW1fY29udGV4dC5jCmluZGV4IDI1YTdlYjEyZDMzOS4uZDExMjNkZmJmYjBlIDEwMDY0NAot
LS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vc2VsZnRlc3RzL2k5MTVfZ2VtX2NvbnRleHQu
YworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vc2VsZnRlc3RzL2k5MTVfZ2VtX2NvbnRl
eHQuYwpAQCAtMjk1LDYgKzI5NSwxMCBAQCBzdGF0aWMgaW50IGdwdV9maWxsKHN0cnVjdCBkcm1f
aTkxNV9nZW1fb2JqZWN0ICpvYmosCiAJCWdvdG8gZXJyX2JhdGNoOwogCX0KIAorCWVyciA9IGk5
MTVfcmVxdWVzdF9hd2FpdF9vYmplY3QocnEsIGJhdGNoLT5vYmosIGZhbHNlKTsKKwlpZiAoZXJy
KQorCQlnb3RvIGVycl9yZXF1ZXN0OworCiAJZmxhZ3MgPSAwOwogCWlmIChJTlRFTF9HRU4odm0t
Pmk5MTUpIDw9IDUpCiAJCWZsYWdzIHw9IEk5MTVfRElTUEFUQ0hfU0VDVVJFOwpkaWZmIC0tZ2l0
IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW1fZ3R0LmMgYi9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9pOTE1X2dlbV9ndHQuYwppbmRleCAyNzY1ZjM4NDhjYjEuLmQ1MGRhNWRiZjRmYyAxMDA2
NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW1fZ3R0LmMKKysrIGIvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvaTkxNV9nZW1fZ3R0LmMKQEAgLTMwLDYgKzMwLDcgQEAKICNpbmNsdWRl
IDxsaW51eC9yYW5kb20uaD4KICNpbmNsdWRlIDxsaW51eC9zZXFfZmlsZS5oPgogI2luY2x1ZGUg
PGxpbnV4L3N0b3BfbWFjaGluZS5oPgorI2luY2x1ZGUgPGxpbnV4L3dvcmtxdWV1ZS5oPgogCiAj
aW5jbHVkZSA8YXNtL3NldF9tZW1vcnkuaD4KIApAQCAtMTM1LDE0ICsxMzYsMTQgQEAgc3RhdGlj
IGlubGluZSB2b2lkIGk5MTVfZ2d0dF9pbnZhbGlkYXRlKHN0cnVjdCBkcm1faTkxNV9wcml2YXRl
ICppOTE1KQogCiBzdGF0aWMgaW50IHBwZ3R0X2JpbmRfdm1hKHN0cnVjdCBpOTE1X3ZtYSAqdm1h
LAogCQkJICBlbnVtIGk5MTVfY2FjaGVfbGV2ZWwgY2FjaGVfbGV2ZWwsCi0JCQkgIHUzMiB1bnVz
ZWQpCisJCQkgIHUzMiBmbGFncykKIHsKKwlzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSA9
IHZtYS0+dm07CiAJdTMyIHB0ZV9mbGFnczsKIAlpbnQgZXJyOwogCi0JaWYgKCEodm1hLT5mbGFn
cyAmIEk5MTVfVk1BX0xPQ0FMX0JJTkQpKSB7Ci0JCWVyciA9IHZtYS0+dm0tPmFsbG9jYXRlX3Zh
X3JhbmdlKHZtYS0+dm0sCi0JCQkJCQkgdm1hLT5ub2RlLnN0YXJ0LCB2bWEtPnNpemUpOworCWlm
IChmbGFncyAmIEk5MTVfVk1BX0FMTE9DX0JJTkQpIHsKKwkJZXJyID0gdm0tPmFsbG9jYXRlX3Zh
X3JhbmdlKHZtLCB2bWEtPm5vZGUuc3RhcnQsIHZtYS0+c2l6ZSk7CiAJCWlmIChlcnIpCiAJCQly
ZXR1cm4gZXJyOwogCX0KQEAgLTE1MiwyMCArMTUzLDI2IEBAIHN0YXRpYyBpbnQgcHBndHRfYmlu
ZF92bWEoc3RydWN0IGk5MTVfdm1hICp2bWEsCiAJaWYgKGk5MTVfZ2VtX29iamVjdF9pc19yZWFk
b25seSh2bWEtPm9iaikpCiAJCXB0ZV9mbGFncyB8PSBQVEVfUkVBRF9PTkxZOwogCi0Jdm1hLT52
bS0+aW5zZXJ0X2VudHJpZXModm1hLT52bSwgdm1hLCBjYWNoZV9sZXZlbCwgcHRlX2ZsYWdzKTsK
Kwl2bS0+aW5zZXJ0X2VudHJpZXModm0sIHZtYSwgY2FjaGVfbGV2ZWwsIHB0ZV9mbGFncyk7CiAK
IAlyZXR1cm4gMDsKIH0KIAogc3RhdGljIHZvaWQgcHBndHRfdW5iaW5kX3ZtYShzdHJ1Y3QgaTkx
NV92bWEgKnZtYSkKIHsKLQl2bWEtPnZtLT5jbGVhcl9yYW5nZSh2bWEtPnZtLCB2bWEtPm5vZGUu
c3RhcnQsIHZtYS0+c2l6ZSk7CisJc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0gPSB2bWEt
PnZtOworCisJdm0tPmNsZWFyX3JhbmdlKHZtLCB2bWEtPm5vZGUuc3RhcnQsIHZtYS0+c2l6ZSk7
CiB9CiAKIHN0YXRpYyBpbnQgcHBndHRfc2V0X3BhZ2VzKHN0cnVjdCBpOTE1X3ZtYSAqdm1hKQog
ewogCUdFTV9CVUdfT04odm1hLT5wYWdlcyk7CiAKKwl3YWl0X2Zvcl9jb21wbGV0aW9uKCZ2bWEt
Pm9iai0+bW0uY29tcGxldGlvbik7CisJaWYgKElTX0VSUih2bWEtPm9iai0+bW0ucGFnZXMpKQor
CQlyZXR1cm4gUFRSX0VSUih2bWEtPm9iai0+bW0ucGFnZXMpOworCiAJdm1hLT5wYWdlcyA9IHZt
YS0+b2JqLT5tbS5wYWdlczsKIAogCXZtYS0+cGFnZV9zaXplcyA9IHZtYS0+b2JqLT5tbS5wYWdl
X3NpemVzOwpAQCAtMjY4Niw2ICsyNjkzLDcgQEAgc3RhdGljIGludCBnZ3R0X2JpbmRfdm1hKHN0
cnVjdCBpOTE1X3ZtYSAqdm1hLAogCSAqIHVwZ3JhZGUgdG8gYm90aCBib3VuZCBpZiB3ZSBiaW5k
IGVpdGhlciB0byBhdm9pZCBkb3VibGUtYmluZGluZy4KIAkgKi8KIAl2bWEtPmZsYWdzIHw9IEk5
MTVfVk1BX0dMT0JBTF9CSU5EIHwgSTkxNV9WTUFfTE9DQUxfQklORDsKKwlkbWFfZmVuY2Vfc2ln
bmFsKHZtYS0+YXN5bmMuZG1hKTsKIAogCXJldHVybiAwOwogfQpAQCAtMjcxNSw3ICsyNzIzLDcg
QEAgc3RhdGljIGludCBhbGlhc2luZ19ndHRfYmluZF92bWEoc3RydWN0IGk5MTVfdm1hICp2bWEs
CiAJaWYgKGZsYWdzICYgSTkxNV9WTUFfTE9DQUxfQklORCkgewogCQlzdHJ1Y3QgaTkxNV9wcGd0
dCAqYXBwZ3R0ID0gaTkxNS0+bW0uYWxpYXNpbmdfcHBndHQ7CiAKLQkJaWYgKCEodm1hLT5mbGFn
cyAmIEk5MTVfVk1BX0xPQ0FMX0JJTkQpKSB7CisJCWlmIChmbGFncyAmIEk5MTVfVk1BX0FMTE9D
X0JJTkQpIHsKIAkJCXJldCA9IGFwcGd0dC0+dm0uYWxsb2NhdGVfdmFfcmFuZ2UoJmFwcGd0dC0+
dm0sCiAJCQkJCQkJICAgdm1hLT5ub2RlLnN0YXJ0LAogCQkJCQkJCSAgIHZtYS0+c2l6ZSk7CkBA
IC0zOTAyLDEzICszOTEwLDE4IEBAIGk5MTVfZ2V0X2dndHRfdm1hX3BhZ2VzKHN0cnVjdCBpOTE1
X3ZtYSAqdm1hKQogewogCWludCByZXQ7CiAKLQkvKiBUaGUgdm1hLT5wYWdlcyBhcmUgb25seSB2
YWxpZCB3aXRoaW4gdGhlIGxpZmVzcGFuIG9mIHRoZSBib3Jyb3dlZAorCS8qCisJICogVGhlIHZt
YS0+cGFnZXMgYXJlIG9ubHkgdmFsaWQgd2l0aGluIHRoZSBsaWZlc3BhbiBvZiB0aGUgYm9ycm93
ZWQKIAkgKiBvYmotPm1tLnBhZ2VzLiBXaGVuIHRoZSBvYmotPm1tLnBhZ2VzIHNnX3RhYmxlIGlz
IHJlZ2VuZXJhdGVkLCBzbwogCSAqIG11c3QgYmUgdGhlIHZtYS0+cGFnZXMuIEEgc2ltcGxlIHJ1
bGUgaXMgdGhhdCB2bWEtPnBhZ2VzIG11c3Qgb25seQogCSAqIGJlIGFjY2Vzc2VkIHdoZW4gdGhl
IG9iai0+bW0ucGFnZXMgYXJlIHBpbm5lZC4KIAkgKi8KIAlHRU1fQlVHX09OKCFpOTE1X2dlbV9v
YmplY3RfaGFzX3Bpbm5lZF9wYWdlcyh2bWEtPm9iaikpOwogCisJd2FpdF9mb3JfY29tcGxldGlv
bigmdm1hLT5vYmotPm1tLmNvbXBsZXRpb24pOworCWlmIChJU19FUlIodm1hLT5vYmotPm1tLnBh
Z2VzKSkKKwkJcmV0dXJuIFBUUl9FUlIodm1hLT5vYmotPm1tLnBhZ2VzKTsKKwogCXN3aXRjaCAo
dm1hLT5nZ3R0X3ZpZXcudHlwZSkgewogCWRlZmF1bHQ6CiAJCUdFTV9CVUdfT04odm1hLT5nZ3R0
X3ZpZXcudHlwZSk7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3ZtYS5j
IGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV92bWEuYwppbmRleCAwZjM4NDcxYzJhZWMuLjM2
M2NjYzZlMWMyNCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV92bWEuYwor
KysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3ZtYS5jCkBAIC0xMTUsNiArMTE1LDg0IEBA
IHN0YXRpYyB2b2lkIF9faTkxNV92bWFfcmV0aXJlKHN0cnVjdCBpOTE1X2FjdGl2ZSAqcmVmKQog
CWk5MTVfZ2VtX29iamVjdF9wdXQob2JqKTsgLyogYW5kIGRyb3AgdGhlIGFjdGl2ZSByZWZlcmVu
Y2UgKi8KIH0KIAorc3RhdGljIGludCBfX3ZtYV9iaW5kKHN0cnVjdCBpOTE1X3ZtYSAqdm1hLAor
CQkgICAgICB1bnNpZ25lZCBpbnQgY2FjaGVfbGV2ZWwsCisJCSAgICAgIHVuc2lnbmVkIGludCBm
bGFncykKK3sKKwlpbnQgZXJyOworCisJaWYgKCF2bWEtPnBhZ2VzKSB7CisJCWVyciA9IHZtYS0+
b3BzLT5zZXRfcGFnZXModm1hKTsKKwkJaWYgKGVycikKKwkJCXJldHVybiBlcnI7CisJfQorCisJ
cmV0dXJuIHZtYS0+b3BzLT5iaW5kX3ZtYSh2bWEsIGNhY2hlX2xldmVsLCBmbGFncyk7Cit9CisK
K3N0YXRpYyB2b2lkIGRvX2FzeW5jX2JpbmQoc3RydWN0IHdvcmtfc3RydWN0ICp3b3JrKQorewor
CXN0cnVjdCBpOTE1X3ZtYSAqdm1hID0gY29udGFpbmVyX29mKHdvcmssIHR5cGVvZigqdm1hKSwg
YXN5bmMud29yayk7CisJc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0gPSB2bWEtPnZtOwor
CWludCBlcnI7CisKKwlpZiAodm1hLT5hc3luYy5kbWEtPmVycm9yKQorCQlnb3RvIG91dDsKKwor
CWVyciA9IF9fdm1hX2JpbmQodm1hLCB2bWEtPmFzeW5jLmNhY2hlX2xldmVsLCB2bWEtPmFzeW5j
LmZsYWdzKTsKKwlpZiAoZXJyKQorCQlkbWFfZmVuY2Vfc2V0X2Vycm9yKHZtYS0+YXN5bmMuZG1h
LCBlcnIpOworCitvdXQ6CisJZG1hX2ZlbmNlX3NpZ25hbCh2bWEtPmFzeW5jLmRtYSk7CisJaTkx
NV92bWFfcHV0KHZtYSk7CisJaTkxNV92bV9wdXQodm0pOworfQorCitzdGF0aWMgdm9pZCBfX3F1
ZXVlX2FzeW5jX2JpbmQoc3RydWN0IGRtYV9mZW5jZSAqZiwgc3RydWN0IGRtYV9mZW5jZV9jYiAq
Y2IpCit7CisJc3RydWN0IGk5MTVfdm1hICp2bWEgPSBjb250YWluZXJfb2YoY2IsIHR5cGVvZigq
dm1hKSwgYXN5bmMuY2IpOworCisJaWYgKGYtPmVycm9yKQorCQlkbWFfZmVuY2Vfc2V0X2Vycm9y
KHZtYS0+YXN5bmMuZG1hLCBmLT5lcnJvcik7CisKKwlJTklUX1dPUksoJnZtYS0+YXN5bmMud29y
aywgZG9fYXN5bmNfYmluZCk7CisJcXVldWVfd29yayhzeXN0ZW1fdW5ib3VuZF93cSwgJnZtYS0+
YXN5bmMud29yayk7Cit9CisKK3N0YXRpYyBjb25zdCBjaGFyICphc3luY19iaW5kX2RyaXZlcl9u
YW1lKHN0cnVjdCBkbWFfZmVuY2UgKmZlbmNlKQoreworCXJldHVybiBEUklWRVJfTkFNRTsKK30K
Kworc3RhdGljIGNvbnN0IGNoYXIgKmFzeW5jX2JpbmRfdGltZWxpbmVfbmFtZShzdHJ1Y3QgZG1h
X2ZlbmNlICpmZW5jZSkKK3sKKwlyZXR1cm4gImJpbmQiOworfQorCitzdGF0aWMgY29uc3Qgc3Ry
dWN0IGRtYV9mZW5jZV9vcHMgYXN5bmNfYmluZF9vcHMgPSB7CisJLmdldF9kcml2ZXJfbmFtZSA9
IGFzeW5jX2JpbmRfZHJpdmVyX25hbWUsCisJLmdldF90aW1lbGluZV9uYW1lID0gYXN5bmNfYmlu
ZF90aW1lbGluZV9uYW1lLAorfTsKKworc3RhdGljIERFRklORV9TUElOTE9DSyhhc3luY19sb2Nr
KTsKKworc3RhdGljIHN0cnVjdCBkbWFfZmVuY2UgKmFzeW5jX2ZlbmNlX2NyZWF0ZShzdHJ1Y3Qg
ZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKK3sKKwlzdHJ1Y3QgZG1hX2ZlbmNlICpmOworCisJZiA9
IGttYWxsb2Moc2l6ZW9mKCpmKSwgR0ZQX0tFUk5FTCk7CisJaWYgKGYpIHsKKwkJZG1hX2ZlbmNl
X2luaXQoZiwKKwkJCSAgICAgICAmYXN5bmNfYmluZF9vcHMsCisJCQkgICAgICAgJmFzeW5jX2xv
Y2ssCisJCQkgICAgICAgaTkxNS0+bW0udW5vcmRlcmVkX3RpbWVsaW5lLAorCQkJICAgICAgIDAp
OworCX0KKworCXJldHVybiBmOworfQorCiBzdGF0aWMgc3RydWN0IGk5MTVfdm1hICoKIHZtYV9j
cmVhdGUoc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiwKIAkgICBzdHJ1Y3QgaTkxNV9h
ZGRyZXNzX3NwYWNlICp2bSwKQEAgLTEzMCw5ICsyMDgsNiBAQCB2bWFfY3JlYXRlKHN0cnVjdCBk
cm1faTkxNV9nZW1fb2JqZWN0ICpvYmosCiAJaWYgKHZtYSA9PSBOVUxMKQogCQlyZXR1cm4gRVJS
X1BUUigtRU5PTUVNKTsKIAotCWk5MTVfYWN0aXZlX2luaXQodm0tPmk5MTUsICZ2bWEtPmFjdGl2
ZSwgX19pOTE1X3ZtYV9yZXRpcmUpOwotCUlOSVRfQUNUSVZFX1JFUVVFU1QoJnZtYS0+bGFzdF9m
ZW5jZSk7Ci0KIAl2bWEtPnZtID0gdm07CiAJdm1hLT5vcHMgPSAmdm0tPnZtYV9vcHM7CiAJdm1h
LT5vYmogPSBvYmo7CkBAIC0xNDAsNiArMjE1LDkgQEAgdm1hX2NyZWF0ZShzdHJ1Y3QgZHJtX2k5
MTVfZ2VtX29iamVjdCAqb2JqLAogCXZtYS0+c2l6ZSA9IG9iai0+YmFzZS5zaXplOwogCXZtYS0+
ZGlzcGxheV9hbGlnbm1lbnQgPSBJOTE1X0dUVF9NSU5fQUxJR05NRU5UOwogCisJaTkxNV9hY3Rp
dmVfaW5pdCh2bS0+aTkxNSwgJnZtYS0+YWN0aXZlLCBfX2k5MTVfdm1hX3JldGlyZSk7CisJSU5J
VF9BQ1RJVkVfUkVRVUVTVCgmdm1hLT5sYXN0X2ZlbmNlKTsKKwogCWlmICh2aWV3ICYmIHZpZXct
PnR5cGUgIT0gSTkxNV9HR1RUX1ZJRVdfTk9STUFMKSB7CiAJCXZtYS0+Z2d0dF92aWV3ID0gKnZp
ZXc7CiAJCWlmICh2aWV3LT50eXBlID09IEk5MTVfR0dUVF9WSUVXX1BBUlRJQUwpIHsKQEAgLTMw
Miw2ICszODAsMzkgQEAgaTkxNV92bWFfaW5zdGFuY2Uoc3RydWN0IGRybV9pOTE1X2dlbV9vYmpl
Y3QgKm9iaiwKIAlyZXR1cm4gdm1hOwogfQogCitzdGF0aWMgaW50IHF1ZXVlX2FzeW5jX2JpbmQo
c3RydWN0IGk5MTVfdm1hICp2bWEsCisJCQkgICAgZW51bSBpOTE1X2NhY2hlX2xldmVsIGNhY2hl
X2xldmVsLAorCQkJICAgIHUzMiBmbGFncykKK3sKKwlib29sIHJlYWR5ID0gdHJ1ZTsKKworCWlm
ICghdm1hLT5hc3luYy5kbWEpCisJCXJldHVybiAtRU5PTUVNOworCisJaTkxNV92bWFfZ2V0KHZt
YSk7CisJaTkxNV92bV9nZXQodm1hLT52bSk7CisKKwl2bWEtPmFzeW5jLmNhY2hlX2xldmVsID0g
Y2FjaGVfbGV2ZWw7CisJdm1hLT5hc3luYy5mbGFncyA9IGZsYWdzOworCisJaTkxNV92bWFfbG9j
ayh2bWEpOworCWlmIChyY3VfYWNjZXNzX3BvaW50ZXIodm1hLT5yZXN2LT5mZW5jZV9leGNsKSkg
eyAvKiBhc3luYyBwYWdlcyAqLworCQlzdHJ1Y3QgZG1hX2ZlbmNlICpmID0gcmVzZXJ2YXRpb25f
b2JqZWN0X2dldF9leGNsKHZtYS0+cmVzdik7CisKKwkJaWYgKCFkbWFfZmVuY2VfYWRkX2NhbGxi
YWNrKGYsCisJCQkJCSAgICAmdm1hLT5hc3luYy5jYiwKKwkJCQkJICAgIF9fcXVldWVfYXN5bmNf
YmluZCkpCisJCQlyZWFkeSA9IGZhbHNlOworCX0KKwlyZXNlcnZhdGlvbl9vYmplY3RfYWRkX2V4
Y2xfZmVuY2Uodm1hLT5yZXN2LCB2bWEtPmFzeW5jLmRtYSk7CisJaTkxNV92bWFfdW5sb2NrKHZt
YSk7CisKKwlpZiAocmVhZHkpCisJCV9fcXVldWVfYXN5bmNfYmluZCh2bWEtPmFzeW5jLmRtYSwg
JnZtYS0+YXN5bmMuY2IpOworCisJcmV0dXJuIDA7Cit9CisKIC8qKgogICogaTkxNV92bWFfYmlu
ZCAtIFNldHMgdXAgUFRFcyBmb3IgYW4gVk1BIGluIGl0J3MgY29ycmVzcG9uZGluZyBhZGRyZXNz
IHNwYWNlLgogICogQHZtYTogVk1BIHRvIG1hcApAQCAtMzE5LDE3ICs0MzAsMTIgQEAgaW50IGk5
MTVfdm1hX2JpbmQoc3RydWN0IGk5MTVfdm1hICp2bWEsIGVudW0gaTkxNV9jYWNoZV9sZXZlbCBj
YWNoZV9sZXZlbCwKIAl1MzIgdm1hX2ZsYWdzOwogCWludCByZXQ7CiAKKwlHRU1fQlVHX09OKCFm
bGFncyk7CiAJR0VNX0JVR19PTighZHJtX21tX25vZGVfYWxsb2NhdGVkKCZ2bWEtPm5vZGUpKTsK
IAlHRU1fQlVHX09OKHZtYS0+c2l6ZSA+IHZtYS0+bm9kZS5zaXplKTsKLQotCWlmIChHRU1fREVC
VUdfV0FSTl9PTihyYW5nZV9vdmVyZmxvd3Modm1hLT5ub2RlLnN0YXJ0LAotCQkJCQkgICAgICB2
bWEtPm5vZGUuc2l6ZSwKLQkJCQkJICAgICAgdm1hLT52bS0+dG90YWwpKSkKLQkJcmV0dXJuIC1F
Tk9ERVY7Ci0KLQlpZiAoR0VNX0RFQlVHX1dBUk5fT04oIWZsYWdzKSkKLQkJcmV0dXJuIC1FSU5W
QUw7Ci0KKwlHRU1fQlVHX09OKHJhbmdlX292ZXJmbG93cyh2bWEtPm5vZGUuc3RhcnQsCisJCQkJ
ICAgdm1hLT5ub2RlLnNpemUsCisJCQkJICAgdm1hLT52bS0+dG90YWwpKTsKIAliaW5kX2ZsYWdz
ID0gMDsKIAlpZiAoZmxhZ3MgJiBQSU5fR0xPQkFMKQogCQliaW5kX2ZsYWdzIHw9IEk5MTVfVk1B
X0dMT0JBTF9CSU5EOwpAQCAtMzQ0LDE0ICs0NTAsMjIgQEAgaW50IGk5MTVfdm1hX2JpbmQoc3Ry
dWN0IGk5MTVfdm1hICp2bWEsIGVudW0gaTkxNV9jYWNoZV9sZXZlbCBjYWNoZV9sZXZlbCwKIAlp
ZiAoYmluZF9mbGFncyA9PSAwKQogCQlyZXR1cm4gMDsKIAotCUdFTV9CVUdfT04oIXZtYS0+cGFn
ZXMpOworCXZtYS0+YXN5bmMuZG1hID0gYXN5bmNfZmVuY2VfY3JlYXRlKHZtYS0+dm0tPmk5MTUp
OworCWlmICghdm1hLT5hc3luYy5kbWEpCisJCXJldHVybiAtRU5PTUVNOworCisJaWYgKChiaW5k
X2ZsYWdzICYgfnZtYV9mbGFncykgJiBJOTE1X1ZNQV9MT0NBTF9CSU5EKQorCQliaW5kX2ZsYWdz
IHw9IEk5MTVfVk1BX0FMTE9DX0JJTkQ7CiAKIAl0cmFjZV9pOTE1X3ZtYV9iaW5kKHZtYSwgYmlu
ZF9mbGFncyk7Ci0JcmV0ID0gdm1hLT5vcHMtPmJpbmRfdm1hKHZtYSwgY2FjaGVfbGV2ZWwsIGJp
bmRfZmxhZ3MpOworCWlmIChiaW5kX2ZsYWdzICYgSTkxNV9WTUFfQUxMT0NfQklORCkKKwkJcmV0
ID0gcXVldWVfYXN5bmNfYmluZCh2bWEsIGNhY2hlX2xldmVsLCBiaW5kX2ZsYWdzKTsKKwllbHNl
CisJCXJldCA9IF9fdm1hX2JpbmQodm1hLCBjYWNoZV9sZXZlbCwgYmluZF9mbGFncyk7CiAJaWYg
KHJldCkKIAkJcmV0dXJuIHJldDsKIAotCXZtYS0+ZmxhZ3MgfD0gYmluZF9mbGFnczsKKwl2bWEt
PmZsYWdzIHw9IGJpbmRfZmxhZ3MgJiB+STkxNV9WTUFfQUxMT0NfQklORDsKIAlyZXR1cm4gMDsK
IH0KIApAQCAtNTk1LDcgKzcwOSw3IEBAIGk5MTVfdm1hX2luc2VydChzdHJ1Y3QgaTkxNV92bWEg
KnZtYSwgdTY0IHNpemUsIHU2NCBhbGlnbm1lbnQsIHU2NCBmbGFncykKIAl9CiAKIAlpZiAodm1h
LT5vYmopIHsKLQkJcmV0ID0gaTkxNV9nZW1fb2JqZWN0X3Bpbl9wYWdlcyh2bWEtPm9iaik7CisJ
CXJldCA9IGk5MTVfZ2VtX29iamVjdF9waW5fcGFnZXNfYXN5bmModm1hLT5vYmopOwogCQlpZiAo
cmV0KQogCQkJcmV0dXJuIHJldDsKIApAQCAtNjA0LDI1ICs3MTgsMTkgQEAgaTkxNV92bWFfaW5z
ZXJ0KHN0cnVjdCBpOTE1X3ZtYSAqdm1hLCB1NjQgc2l6ZSwgdTY0IGFsaWdubWVudCwgdTY0IGZs
YWdzKQogCQljYWNoZV9sZXZlbCA9IDA7CiAJfQogCi0JR0VNX0JVR19PTih2bWEtPnBhZ2VzKTsK
LQotCXJldCA9IHZtYS0+b3BzLT5zZXRfcGFnZXModm1hKTsKLQlpZiAocmV0KQotCQlnb3RvIGVy
cl91bnBpbjsKLQogCWlmIChmbGFncyAmIFBJTl9PRkZTRVRfRklYRUQpIHsKIAkJdTY0IG9mZnNl
dCA9IGZsYWdzICYgUElOX09GRlNFVF9NQVNLOwogCQlpZiAoIUlTX0FMSUdORUQob2Zmc2V0LCBh
bGlnbm1lbnQpIHx8CiAJCSAgICByYW5nZV9vdmVyZmxvd3Mob2Zmc2V0LCBzaXplLCBlbmQpKSB7
CiAJCQlyZXQgPSAtRUlOVkFMOwotCQkJZ290byBlcnJfY2xlYXI7CisJCQlnb3RvIGVycl91bnBp
bjsKIAkJfQogCiAJCXJldCA9IGk5MTVfZ2VtX2d0dF9yZXNlcnZlKHZtYS0+dm0sICZ2bWEtPm5v
ZGUsCiAJCQkJCSAgIHNpemUsIG9mZnNldCwgY2FjaGVfbGV2ZWwsCiAJCQkJCSAgIGZsYWdzKTsK
IAkJaWYgKHJldCkKLQkJCWdvdG8gZXJyX2NsZWFyOworCQkJZ290byBlcnJfdW5waW47CiAJfSBl
bHNlIHsKIAkJLyoKIAkJICogV2Ugb25seSBzdXBwb3J0IGh1Z2UgZ3R0IHBhZ2VzIHRocm91Z2gg
dGhlIDQ4YiBQUEdUVCwKQEAgLTY2MSw3ICs3NjksNyBAQCBpOTE1X3ZtYV9pbnNlcnQoc3RydWN0
IGk5MTVfdm1hICp2bWEsIHU2NCBzaXplLCB1NjQgYWxpZ25tZW50LCB1NjQgZmxhZ3MpCiAJCQkJ
CSAgc2l6ZSwgYWxpZ25tZW50LCBjYWNoZV9sZXZlbCwKIAkJCQkJICBzdGFydCwgZW5kLCBmbGFn
cyk7CiAJCWlmIChyZXQpCi0JCQlnb3RvIGVycl9jbGVhcjsKKwkJCWdvdG8gZXJyX3VucGluOwog
CiAJCUdFTV9CVUdfT04odm1hLT5ub2RlLnN0YXJ0IDwgc3RhcnQpOwogCQlHRU1fQlVHX09OKHZt
YS0+bm9kZS5zdGFydCArIHZtYS0+bm9kZS5zaXplID4gZW5kKTsKQEAgLTY4MCw4ICs3ODgsNiBA
QCBpOTE1X3ZtYV9pbnNlcnQoc3RydWN0IGk5MTVfdm1hICp2bWEsIHU2NCBzaXplLCB1NjQgYWxp
Z25tZW50LCB1NjQgZmxhZ3MpCiAKIAlyZXR1cm4gMDsKIAotZXJyX2NsZWFyOgotCXZtYS0+b3Bz
LT5jbGVhcl9wYWdlcyh2bWEpOwogZXJyX3VucGluOgogCWlmICh2bWEtPm9iaikKIAkJaTkxNV9n
ZW1fb2JqZWN0X3VucGluX3BhZ2VzKHZtYS0+b2JqKTsKQEAgLTc5OSw2ICs5MDUsNyBAQCB2b2lk
IGk5MTVfdm1hX3Jlb3BlbihzdHJ1Y3QgaTkxNV92bWEgKnZtYSkKIAogc3RhdGljIHZvaWQgX19p
OTE1X3ZtYV9kZXN0cm95KHN0cnVjdCBpOTE1X3ZtYSAqdm1hKQogeworCUdFTV9CVUdfT04odm1h
LT5hc3luYy5kbWEpOwogCUdFTV9CVUdfT04odm1hLT5ub2RlLmFsbG9jYXRlZCk7CiAJR0VNX0JV
R19PTih2bWEtPmZlbmNlKTsKIApAQCAtOTU0LDEyICsxMDYxLDE3IEBAIGludCBpOTE1X3ZtYV91
bmJpbmQoc3RydWN0IGk5MTVfdm1hICp2bWEpCiAJaW50IHJldDsKIAogCWxvY2tkZXBfYXNzZXJ0
X2hlbGQoJnZtYS0+dm0tPmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOworCW1pZ2h0X3NsZWVwKCk7
CisKKwlpZiAodm1hLT5mbGFncyAmIEk5MTVfVk1BX0xPQ0FMX0JJTkQgJiYKKwkgICAgZG1hX2Zl
bmNlX3dhaXRfdGltZW91dCh2bWEtPmFzeW5jLmRtYSwgdHJ1ZSwKKwkJCQkgICBNQVhfU0NIRURV
TEVfVElNRU9VVCkgPCAwKQorCQlyZXR1cm4gLUVJTlRSOwogCiAJLyoKIAkgKiBGaXJzdCB3YWl0
IHVwb24gYW55IGFjdGl2aXR5IGFzIHJldGlyaW5nIHRoZSByZXF1ZXN0IG1heQogCSAqIGhhdmUg
c2lkZS1lZmZlY3RzIHN1Y2ggYXMgdW5waW5uaW5nIG9yIGV2ZW4gdW5iaW5kaW5nIHRoaXMgdm1h
LgogCSAqLwotCW1pZ2h0X3NsZWVwKCk7CiAJaWYgKGk5MTVfdm1hX2lzX2FjdGl2ZSh2bWEpKSB7
CiAJCS8qCiAJCSAqIFdoZW4gYSBjbG9zZWQgVk1BIGlzIHJldGlyZWQsIGl0IGlzIHVuYm91bmQg
LSBlZWsuCkBAIC0xMDI3LDYgKzExMzksOCBAQCBpbnQgaTkxNV92bWFfdW5iaW5kKHN0cnVjdCBp
OTE1X3ZtYSAqdm1hKQogCX0KIAl2bWEtPmZsYWdzICY9IH4oSTkxNV9WTUFfR0xPQkFMX0JJTkQg
fCBJOTE1X1ZNQV9MT0NBTF9CSU5EKTsKIAorCWRtYV9mZW5jZV9wdXQoZmV0Y2hfYW5kX3plcm8o
JnZtYS0+YXN5bmMuZG1hKSk7CisKIAlpOTE1X3ZtYV9yZW1vdmUodm1hKTsKIAogCXJldHVybiAw
OwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV92bWEuaCBiL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2k5MTVfdm1hLmgKaW5kZXggMjY1N2M5OWZlMTg3Li5hZDMzMjEzYmNlZTkg
MTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfdm1hLmgKKysrIGIvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvaTkxNV92bWEuaApAQCAtMTAxLDYgKzEwMSw3IEBAIHN0cnVjdCBpOTE1
X3ZtYSB7CiAjZGVmaW5lIEk5MTVfVk1BX0dMT0JBTF9CSU5ECUJJVCg5KQogI2RlZmluZSBJOTE1
X1ZNQV9MT0NBTF9CSU5ECUJJVCgxMCkKICNkZWZpbmUgSTkxNV9WTUFfQklORF9NQVNLIChJOTE1
X1ZNQV9HTE9CQUxfQklORCB8IEk5MTVfVk1BX0xPQ0FMX0JJTkQgfCBJOTE1X1ZNQV9QSU5fT1ZF
UkZMT1cpCisjZGVmaW5lIEk5MTVfVk1BX0FMTE9DX0JJTkQJSTkxNV9WTUFfUElOX09WRVJGTE9X
IC8qIG5vdCBzdG9yZWQgKi8KIAogI2RlZmluZSBJOTE1X1ZNQV9HR1RUCQlCSVQoMTEpCiAjZGVm
aW5lIEk5MTVfVk1BX0NBTl9GRU5DRQlCSVQoMTIpCkBAIC0xNDMsNiArMTQ0LDE0IEBAIHN0cnVj
dCBpOTE1X3ZtYSB7CiAJdW5zaWduZWQgaW50ICpleGVjX2ZsYWdzOwogCXN0cnVjdCBobGlzdF9u
b2RlIGV4ZWNfbm9kZTsKIAl1MzIgZXhlY19oYW5kbGU7CisKKwlzdHJ1Y3QgaTkxNV92bWFfYXN5
bmNfYmluZCB7CisJCXN0cnVjdCBkbWFfZmVuY2UgKmRtYTsKKwkJc3RydWN0IGRtYV9mZW5jZV9j
YiBjYjsKKwkJc3RydWN0IHdvcmtfc3RydWN0IHdvcms7CisJCXVuc2lnbmVkIGludCBjYWNoZV9s
ZXZlbDsKKwkJdW5zaWduZWQgaW50IGZsYWdzOworCX0gYXN5bmM7CiB9OwogCiBzdHJ1Y3QgaTkx
NV92bWEgKgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvc2VsZnRlc3RzL2k5MTVf
dm1hLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9zZWxmdGVzdHMvaTkxNV92bWEuYwppbmRleCBh
MTY2ZDk0MDVhOTQuLjYxNWFjNDg1YzczMSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvc2VsZnRlc3RzL2k5MTVfdm1hLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvc2VsZnRl
c3RzL2k5MTVfdm1hLmMKQEAgLTIwNCw4ICsyMDQsMTAgQEAgc3RhdGljIGludCBpZ3Rfdm1hX2Ny
ZWF0ZSh2b2lkICphcmcpCiAJCW1vY2tfY29udGV4dF9jbG9zZShjdHgpOwogCX0KIAotCWxpc3Rf
Zm9yX2VhY2hfZW50cnlfc2FmZShvYmosIG9uLCAmb2JqZWN0cywgc3RfbGluaykKKwlsaXN0X2Zv
cl9lYWNoX2VudHJ5X3NhZmUob2JqLCBvbiwgJm9iamVjdHMsIHN0X2xpbmspIHsKKwkJaTkxNV9n
ZW1fb2JqZWN0X3dhaXQob2JqLCBJOTE1X1dBSVRfQUxMLCBNQVhfU0NIRURVTEVfVElNRU9VVCk7
CiAJCWk5MTVfZ2VtX29iamVjdF9wdXQob2JqKTsKKwl9CiAJcmV0dXJuIGVycjsKIH0KIAotLSAK
Mi4yMC4xCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpJ
bnRlbC1nZnggbWFpbGluZyBsaXN0CkludGVsLWdmeEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0
cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9pbnRlbC1nZng=

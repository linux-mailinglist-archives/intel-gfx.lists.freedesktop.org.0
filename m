Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 5312529AB2
	for <lists+intel-gfx@lfdr.de>; Fri, 24 May 2019 17:13:12 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 5AB1D6E114;
	Fri, 24 May 2019 15:13:10 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 11AFA6E114
 for <intel-gfx@lists.freedesktop.org>; Fri, 24 May 2019 15:13:08 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 16670538-1500050 
 for multiple; Fri, 24 May 2019 16:12:34 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Fri, 24 May 2019 16:12:23 +0100
Message-Id: <20190524151223.17879-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH] drm/i915: Keep user GGTT alive for a minimum of
 250ms
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

RG8gbm90IGFsbG93IHJ1bnRpbWUgcG0gYXV0b3N1c3BlbmQgdG8gcmVtb3ZlIHVzZXJzcGFjZSBH
R1RUIG1tYXBzIHRvbwpxdWlja2x5LiBGb3IgZXhhbXBsZSwgaWd0IHNldHMgdGhlIGF1dG9zdXNw
ZW5kIGRlbGF5IHRvIDAsIGFuZCBzbyB3ZQppbW1lZGlhdGVseSBhdHRlbXB0IHRvIHBlcmZvcm0g
cnVudGltZSBzdXNwZW5kIHVwb24gcmVsZWFzaW5nIHRoZQp3YWtlcmVmLiBVbmZvcnR1bmF0ZWx5
LCB0aGF0IGludm9sdmVzIHRlYXJpbmcgZG93biBHR1RUIG1tYXBzIGFzIHRoZXkKcmVxdWlyZSBh
biBhY3RpdmUgZGV2aWNlLgoKT3ZlcnJpZGUgdGhlIGF1dG9zdXNwZW5kIGZvciBHR1RUIG1tYXBz
LCBieSBrZWVwaW5nIHRoZSB3YWtlcmVmIGFyb3VuZApmb3IgMjUwbXMgYWZ0ZXIgcG9wdWxhdGlu
ZyB0aGUgUFRFIGZvciBhIGZyZXNoIG1tYXAuCgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24g
PGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KQ2M6IE1pa2EgS3VvcHBhbGEgPG1pa2Eua3VvcHBh
bGFAbGludXguaW50ZWwuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L0tjb25maWcucHJv
ZmlsZSB8IDE0ICsrKysrKysKIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZHJ2LmggICAgICB8
ICAzICsrCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbS5jICAgICAgfCAgNyArKysrCiBk
cml2ZXJzL2dwdS9kcm0vaTkxNS9pbnRlbF93YWtlcmVmLmMgfCA1NSArKysrKysrKysrKysrKysr
KysrKysrKysrKysrCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pbnRlbF93YWtlcmVmLmggfCAyNyAr
KysrKysrKysrKysrKwogNSBmaWxlcyBjaGFuZ2VkLCAxMDYgaW5zZXJ0aW9ucygrKQoKZGlmZiAt
LWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L0tjb25maWcucHJvZmlsZSBiL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L0tjb25maWcucHJvZmlsZQppbmRleCAwZTVkYjk4ZGE4ZjMuLjRmZDFlYTYzOWQw
ZiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvS2NvbmZpZy5wcm9maWxlCisrKyBi
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L0tjb25maWcucHJvZmlsZQpAQCAtMSwzICsxLDE3IEBACitj
b25maWcgRFJNX0k5MTVfVVNFUkZBVUxUX0FVVE9TVVNQRU5ECisJaW50ICJSdW50aW1lIGF1dG9z
dXNwZW5kIGRlbGF5IGZvciB1c2Vyc3BhY2UgR0dUVCBtbWFwcyAobXMpIgorCWRlZmF1bHQgMjUw
ICMgbWlsbGlzZWNvbmRzCisJaGVscAorCSAgT24gcnVudGltZSBzdXNwZW5kLCBhcyB3ZSBzdXNw
ZW5kIHRoZSBkZXZpY2UsIHdlIGhhdmUgdG8gcmV2b2tlCisJICB1c2Vyc3BhY2UgR0dUVCBtbWFw
cyBhbmQgZm9yY2UgdXNlcnNwYWNlIHRvIHRha2UgYSBwYWdlZmF1bHQgb24KKwkgIHRoZWlyIG5l
eHQgYWNjZXNzLiBUaGUgcmV2b2NhdGlvbiBhbmQgc3Vic2VxdWVudCByZWNyZWF0aW9uIG9mCisJ
ICB0aGUgR0dUVCBtbWFwIGNhbiBiZSB2ZXJ5IHNsb3cgYW5kIHNvIHdlIGltcG9zZSBhIHNtYWxs
IGh5c3RlcmlzCisJICB0aGF0IGNvbXBsZW1lbnRzIHRoZSBydW50aW1lLXBtIGF1dG9zdXNwZW5k
IGFuZCBwcm92aWRlcyBhIGxvd2VyCisJICBmbG9vciBvbiB0aGUgYXV0b3N1c3BlbmQgZGVsYXku
CisKKwkgIE1heSBiZSAwIHRvIGRpc2FibGUgdGhlIGV4dHJhIGRlbGF5IGFuZCBzb2xlbHkgdXNl
IHRoZSBkZXZpY2UgbGV2ZWwKKwkgIHJ1bnRpbWUgcG0gYXV0b3N1c3BlbmQgZGVsYXkgdHVuYWJs
ZS4KKwogY29uZmlnIERSTV9JOTE1X1NQSU5fUkVRVUVTVAogCWludAogCWRlZmF1bHQgNSAjIG1p
Y3Jvc2Vjb25kcwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYuaCBi
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZHJ2LmgKaW5kZXggMzExZTE5MTU0NjcyLi40MWRh
ZDg4ODllYWEgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZHJ2LmgKKysr
IGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYuaApAQCAtODc0LDYgKzg3NCw5IEBAIHN0
cnVjdCBpOTE1X2dlbV9tbSB7CiAJICovCiAJc3RydWN0IGxpc3RfaGVhZCB1c2VyZmF1bHRfbGlz
dDsKIAorCS8qIE1hbnVhbCBydW50aW1lIHBtIGF1dG9zdXNwZW5kIGRlbGF5IGZvciB1c2VyIEdH
VFQgbW1hcHMgKi8KKwlzdHJ1Y3QgaW50ZWxfd2FrZXJlZl9hdXRvIHVzZXJmYXVsdF93YWtlcmVm
OworCiAJLyoqCiAJICogTGlzdCBvZiBvYmplY3RzIHdoaWNoIGFyZSBwZW5kaW5nIGRlc3RydWN0
aW9uLgogCSAqLwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW0uYyBi
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtLmMKaW5kZXggZDNiN2RhYzUyN2RjLi5jYjc4
NjU4MmUyZmUgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtLmMKKysr
IGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW0uYwpAQCAtMTgzNCw2ICsxODM0LDkgQEAg
dm1fZmF1bHRfdCBpOTE1X2dlbV9mYXVsdChzdHJ1Y3Qgdm1fZmF1bHQgKnZtZikKIAlhc3NlcnRf
cnBtX3dha2Vsb2NrX2hlbGQoZGV2X3ByaXYpOwogCWlmICghaTkxNV92bWFfc2V0X3VzZXJmYXVs
dCh2bWEpICYmICFvYmotPnVzZXJmYXVsdF9jb3VudCsrKQogCQlsaXN0X2FkZCgmb2JqLT51c2Vy
ZmF1bHRfbGluaywgJmRldl9wcml2LT5tbS51c2VyZmF1bHRfbGlzdCk7CisJaWYgKENPTkZJR19E
Uk1fSTkxNV9VU0VSRkFVTFRfQVVUT1NVU1BFTkQpCisJCWludGVsX3dha2VyZWZfYXV0bygmZGV2
X3ByaXYtPm1tLnVzZXJmYXVsdF93YWtlcmVmLAorCQkJCSAgIG1zZWNzX3RvX2ppZmZpZXNfdGlt
ZW91dChDT05GSUdfRFJNX0k5MTVfVVNFUkZBVUxUX0FVVE9TVVNQRU5EKSk7CiAJR0VNX0JVR19P
Tighb2JqLT51c2VyZmF1bHRfY291bnQpOwogCiAJaTkxNV92bWFfc2V0X2dndHRfd3JpdGUodm1h
KTsKQEAgLTQ2NzEsNiArNDY3NCw4IEBAIHZvaWQgaTkxNV9nZW1fZmluaShzdHJ1Y3QgZHJtX2k5
MTVfcHJpdmF0ZSAqZGV2X3ByaXYpCiB7CiAJR0VNX0JVR19PTihkZXZfcHJpdi0+Z3QuYXdha2Up
OwogCisJaW50ZWxfd2FrZXJlZl9hdXRvX2ZpbmkoJmRldl9wcml2LT5tbS51c2VyZmF1bHRfd2Fr
ZXJlZik7CisKIAlpOTE1X2dlbV9zdXNwZW5kX2xhdGUoZGV2X3ByaXYpOwogCWludGVsX2Rpc2Fi
bGVfZ3RfcG93ZXJzYXZlKGRldl9wcml2KTsKIApAQCAtNDc0OCw2ICs0NzUzLDggQEAgc3RhdGlj
IHZvaWQgaTkxNV9nZW1faW5pdF9fbW0oc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCiAJ
SU5JVF9MSVNUX0hFQUQoJmk5MTUtPm1tLmZlbmNlX2xpc3QpOwogCUlOSVRfTElTVF9IRUFEKCZp
OTE1LT5tbS51c2VyZmF1bHRfbGlzdCk7CiAKKwlpbnRlbF93YWtlcmVmX2F1dG9faW5pdCgmaTkx
NS0+bW0udXNlcmZhdWx0X3dha2VyZWYsIGk5MTUpOworCiAJSU5JVF9XT1JLKCZpOTE1LT5tbS5m
cmVlX3dvcmssIF9faTkxNV9nZW1fZnJlZV93b3JrKTsKIH0KIApkaWZmIC0tZ2l0IGEvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvaW50ZWxfd2FrZXJlZi5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50
ZWxfd2FrZXJlZi5jCmluZGV4IDkxMTk2ZDk2MTJiYi4uMzQ2OTNiNzRjNjdhIDEwMDY0NAotLS0g
YS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pbnRlbF93YWtlcmVmLmMKKysrIGIvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvaW50ZWxfd2FrZXJlZi5jCkBAIC03MywzICs3Myw1OCBAQCB2b2lkIF9faW50ZWxf
d2FrZXJlZl9pbml0KHN0cnVjdCBpbnRlbF93YWtlcmVmICp3Ziwgc3RydWN0IGxvY2tfY2xhc3Nf
a2V5ICprZXkpCiAJYXRvbWljX3NldCgmd2YtPmNvdW50LCAwKTsKIAl3Zi0+d2FrZXJlZiA9IDA7
CiB9CisKK3N0YXRpYyB2b2lkIHdha2VyZWZfYXV0b190aW1lb3V0KHN0cnVjdCB0aW1lcl9saXN0
ICp0KQoreworCXN0cnVjdCBpbnRlbF93YWtlcmVmX2F1dG8gKndmID0gZnJvbV90aW1lcih3Ziwg
dCwgdGltZXIpOworCWludGVsX3dha2VyZWZfdCB3YWtlcmVmOworCXVuc2lnbmVkIGxvbmcgZmxh
Z3M7CisKKwlpZiAoIWF0b21pY19kZWNfYW5kX2xvY2tfaXJxc2F2ZSgmd2YtPmNvdW50LCAmd2Yt
PmxvY2ssIGZsYWdzKSkKKwkJcmV0dXJuOworCisJd2FrZXJlZiA9IGZldGNoX2FuZF96ZXJvKCZ3
Zi0+d2FrZXJlZik7CisJc3Bpbl91bmxvY2tfaXJxcmVzdG9yZSgmd2YtPmxvY2ssIGZsYWdzKTsK
KworCWludGVsX3J1bnRpbWVfcG1fcHV0KHdmLT5pOTE1LCB3YWtlcmVmKTsKK30KKwordm9pZCBp
bnRlbF93YWtlcmVmX2F1dG9faW5pdChzdHJ1Y3QgaW50ZWxfd2FrZXJlZl9hdXRvICp3ZiwKKwkJ
CSAgICAgc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCit7CisJc3Bpbl9sb2NrX2luaXQo
JndmLT5sb2NrKTsKKwl0aW1lcl9zZXR1cCgmd2YtPnRpbWVyLCB3YWtlcmVmX2F1dG9fdGltZW91
dCwgMCk7CisJYXRvbWljX3NldCgmd2YtPmNvdW50LCAwKTsKKwl3Zi0+d2FrZXJlZiA9IDA7CisJ
d2YtPmk5MTUgPSBpOTE1OworfQorCit2b2lkIGludGVsX3dha2VyZWZfYXV0byhzdHJ1Y3QgaW50
ZWxfd2FrZXJlZl9hdXRvICp3ZiwgbG9uZyB0aW1lb3V0KQoreworCXVuc2lnbmVkIGxvbmcgZmxh
Z3M7CisKKwlhc3NlcnRfcnBtX3dha2Vsb2NrX2hlbGQod2YtPmk5MTUpOworCisJc3Bpbl9sb2Nr
X2lycXNhdmUoJndmLT5sb2NrLCBmbGFncyk7CisJaWYgKCFhdG9taWNfZmV0Y2hfaW5jKCZ3Zi0+
Y291bnQpKSB7CisJCUdFTV9CVUdfT04od2YtPndha2VyZWYpOworCQl3Zi0+d2FrZXJlZiA9IGlu
dGVsX3J1bnRpbWVfcG1fZ2V0X2lmX2luX3VzZSh3Zi0+aTkxNSk7CisJfQorCXNwaW5fdW5sb2Nr
X2lycXJlc3RvcmUoJndmLT5sb2NrLCBmbGFncyk7CisKKwkvKgorCSAqIElmIHdlIGV4dGVuZCBh
IHBlbmRpbmcgdGltZXIsIHdlIHdpbGwgb25seSBnZXQgYSBzaW5nbGUgdGltZXIKKwkgKiBjYWxs
YmFjayBhbmQgc28gbmVlZCB0byBjYW5jZWwgdGhlIGxvY2FsIGluYyBieSBydW5uaW5nIHRoZQor
CSAqIGVsaWRlZCBjYWxsYmFjayB0byBrZWVwIHRoZSB3Zi0+Y291bnQgYmFsYW5jZWQuCisJICov
CisJaWYgKG1vZF90aW1lcigmd2YtPnRpbWVyLCBqaWZmaWVzICsgdGltZW91dCkpCisJCXdha2Vy
ZWZfYXV0b190aW1lb3V0KCZ3Zi0+dGltZXIpOworfQorCit2b2lkIGludGVsX3dha2VyZWZfYXV0
b19maW5pKHN0cnVjdCBpbnRlbF93YWtlcmVmX2F1dG8gKndmKQoreworCWlmIChkZWxfdGltZXJf
c3luYygmd2YtPnRpbWVyKSkKKwkJd2FrZXJlZl9hdXRvX3RpbWVvdXQoJndmLT50aW1lcik7CisK
KwlHRU1fQlVHX09OKHdmLT53YWtlcmVmKTsKK30KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2ludGVsX3dha2VyZWYuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2ludGVsX3dha2Vy
ZWYuaAppbmRleCBkYjc0MjI5MTIxMWMuLjRiYzk5ZTcwYjk4YyAxMDA2NDQKLS0tIGEvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvaW50ZWxfd2FrZXJlZi5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2ludGVsX3dha2VyZWYuaApAQCAtMTAsNiArMTAsNyBAQAogI2luY2x1ZGUgPGxpbnV4L2F0b21p
Yy5oPgogI2luY2x1ZGUgPGxpbnV4L211dGV4Lmg+CiAjaW5jbHVkZSA8bGludXgvc3RhY2tkZXBv
dC5oPgorI2luY2x1ZGUgPGxpbnV4L3RpbWVyLmg+CiAKIHN0cnVjdCBkcm1faTkxNV9wcml2YXRl
OwogCkBAIC0xMzAsNCArMTMxLDMwIEBAIGludGVsX3dha2VyZWZfYWN0aXZlKHN0cnVjdCBpbnRl
bF93YWtlcmVmICp3ZikKIAlyZXR1cm4gUkVBRF9PTkNFKHdmLT53YWtlcmVmKTsKIH0KIAorc3Ry
dWN0IGludGVsX3dha2VyZWZfYXV0byB7CisJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTU7
CisJc3RydWN0IHRpbWVyX2xpc3QgdGltZXI7CisJaW50ZWxfd2FrZXJlZl90IHdha2VyZWY7CisJ
c3BpbmxvY2tfdCBsb2NrOworCWF0b21pY190IGNvdW50OworfTsKKworLyoqCisgKiBpbnRlbF93
YWtlcmVmX2F1dG86IERlbGF5IHRoZSBydW50aW1lLXBtIGF1dG9zdXNwZW5kCisgKiBAd2Y6IHRo
ZSB3YWtlcmVmCisgKiBAdGltZW91dDogcmVsYXRpdmUgdGltZW91dCBpbiBqaWZmaWVzCisgKgor
ICogVGhlIHJ1bnRpbWUtcG0gY29yZSB1c2VzIGEgc3VzcGVuZCBkZWxheSBhZnRlciB0aGUgbGFz
dCB3YWtlcmVmCisgKiBpcyByZWxlYXNlZCBiZWZvcmUgdHJpZ2dlcmluZyBydW50aW1lIHN1c3Bl
bmQgb2YgdGhlIGRldmljZS4gVGhhdAorICogZGVsYXkgaXMgY29uZmlndXJhYmxlIHZpYSBzeXNm
cyB3aXRoIGxpdHRsZSByZWdhcmQgdG8gdGhlIGRldmljZQorICogY2hhcmFjdGVyaXN0aWNzLiBJ
bnN0ZWFkLCB3ZSB3YW50IHRvIHR1bmUgdGhlIGF1dG9zdXNwZW5kIGJhc2VkIG9uIG91cgorICog
SFcga25vd2xlZGdlLiBpbnRlbF93YWtlcmVmX2F1dG8oKSBkZWxheXMgdGhlIHNsZWVwIGJ5IHRo
ZSBzdXBwbGllZAorICogdGltZW91dC4KKyAqLwordm9pZCBpbnRlbF93YWtlcmVmX2F1dG8oc3Ry
dWN0IGludGVsX3dha2VyZWZfYXV0byAqd2YsIGxvbmcgdGltZW91dCk7CisKK3ZvaWQgaW50ZWxf
d2FrZXJlZl9hdXRvX2luaXQoc3RydWN0IGludGVsX3dha2VyZWZfYXV0byAqd2YsCisJCQkgICAg
IHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KTsKK3ZvaWQgaW50ZWxfd2FrZXJlZl9hdXRv
X2Zpbmkoc3RydWN0IGludGVsX3dha2VyZWZfYXV0byAqd2YpOworCiAjZW5kaWYgLyogSU5URUxf
V0FLRVJFRl9IICovCi0tIAoyLjIwLjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZy
ZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3Rp
bmZvL2ludGVsLWdmeA==

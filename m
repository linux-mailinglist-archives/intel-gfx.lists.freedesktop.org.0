Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 1F56B1E591C
	for <lists+intel-gfx@lfdr.de>; Thu, 28 May 2020 09:41:54 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id BC3DC6E3EF;
	Thu, 28 May 2020 07:41:49 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 587A46E3DF
 for <intel-gfx@lists.freedesktop.org>; Thu, 28 May 2020 07:41:45 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from build.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 21318029-1500050 
 for multiple; Thu, 28 May 2020 08:41:12 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Thu, 28 May 2020 08:41:07 +0100
Message-Id: <20200528074109.28235-9-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20200528074109.28235-1-chris@chris-wilson.co.uk>
References: <20200528074109.28235-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 09/11] dma-buf: Proxy fence,
 an unsignaled fence placeholder
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Chris Wilson <chris@chris-wilson.co.uk>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

T2Z0ZW4gd2UgbmVlZCB0byBjcmVhdGUgYSBmZW5jZSBmb3IgYSBmdXR1cmUgZXZlbnQgdGhhdCBo
YXMgbm90IHlldCBiZWVuCmFzc29jaWF0ZWQgd2l0aCBhIGZlbmNlLiBXZSBjYW4gc3RvcmUgYSBw
cm94eSBmZW5jZSwgYSBwbGFjZWhvbGRlciwgaW4KdGhlIHRpbWVsaW5lIGFuZCByZXBsYWNlIGl0
IGxhdGVyIHdoZW4gdGhlIHJlYWwgZmVuY2UgaXMga25vd24uIEFueQpsaXN0ZW5lcnMgdGhhdCBh
dHRhY2ggdG8gdGhlIHByb3h5IGZlbmNlIHdpbGwgYXV0b21hdGljYWxseSBiZSBzaWduYWxlZAp3
aGVuIHRoZSByZWFsIGZlbmNlIGNvbXBsZXRlcywgYW5kIGFueSBmdXR1cmUgbGlzdGVuZXJzIHdp
bGwgaW5zdGVhZCBiZQphdHRhY2ggZGlyZWN0bHkgdG8gdGhlIHJlYWwgZmVuY2UgYXZvaWRpbmcg
YW55IGluZGlyZWN0aW9uIG92ZXJoZWFkLgoKU2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxj
aHJpc0BjaHJpcy13aWxzb24uY28udWs+CkNjOiBMaW9uZWwgTGFuZHdlcmxpbiA8bGlvbmVsLmcu
bGFuZHdlcmxpbkBpbnRlbC5jb20+Ci0tLQogZHJpdmVycy9kbWEtYnVmL01ha2VmaWxlICAgICAg
ICAgICAgIHwgIDEzICstCiBkcml2ZXJzL2RtYS1idWYvZG1hLWZlbmNlLXByaXZhdGUuaCAgfCAg
MjAgKwogZHJpdmVycy9kbWEtYnVmL2RtYS1mZW5jZS1wcm94eS5jICAgIHwgMjk1ICsrKysrKysr
KysrCiBkcml2ZXJzL2RtYS1idWYvZG1hLWZlbmNlLmMgICAgICAgICAgfCAgIDQgKy0KIGRyaXZl
cnMvZG1hLWJ1Zi9zZWxmdGVzdHMuaCAgICAgICAgICB8ICAgMSArCiBkcml2ZXJzL2RtYS1idWYv
c3QtZG1hLWZlbmNlLXByb3h5LmMgfCA3NTIgKysrKysrKysrKysrKysrKysrKysrKysrKysrCiBp
bmNsdWRlL2xpbnV4L2RtYS1mZW5jZS1wcm94eS5oICAgICAgfCAgMzggKysKIDcgZmlsZXMgY2hh
bmdlZCwgMTExOSBpbnNlcnRpb25zKCspLCA0IGRlbGV0aW9ucygtKQogY3JlYXRlIG1vZGUgMTAw
NjQ0IGRyaXZlcnMvZG1hLWJ1Zi9kbWEtZmVuY2UtcHJpdmF0ZS5oCiBjcmVhdGUgbW9kZSAxMDA2
NDQgZHJpdmVycy9kbWEtYnVmL2RtYS1mZW5jZS1wcm94eS5jCiBjcmVhdGUgbW9kZSAxMDA2NDQg
ZHJpdmVycy9kbWEtYnVmL3N0LWRtYS1mZW5jZS1wcm94eS5jCiBjcmVhdGUgbW9kZSAxMDA2NDQg
aW5jbHVkZS9saW51eC9kbWEtZmVuY2UtcHJveHkuaAoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZG1h
LWJ1Zi9NYWtlZmlsZSBiL2RyaXZlcnMvZG1hLWJ1Zi9NYWtlZmlsZQppbmRleCA5OTVlMDVmNjA5
ZmYuLmFmYWY2ZGFkZDlhMyAxMDA2NDQKLS0tIGEvZHJpdmVycy9kbWEtYnVmL01ha2VmaWxlCisr
KyBiL2RyaXZlcnMvZG1hLWJ1Zi9NYWtlZmlsZQpAQCAtMSw2ICsxLDEyIEBACiAjIFNQRFgtTGlj
ZW5zZS1JZGVudGlmaWVyOiBHUEwtMi4wLW9ubHkKLW9iai15IDo9IGRtYS1idWYubyBkbWEtZmVu
Y2UubyBkbWEtZmVuY2UtYXJyYXkubyBkbWEtZmVuY2UtY2hhaW4ubyBcCi0JIGRtYS1yZXN2Lm8g
c2Vxbm8tZmVuY2Uubworb2JqLXkgOj0gXAorCWRtYS1idWYubyBcCisJZG1hLWZlbmNlLm8gXAor
CWRtYS1mZW5jZS1hcnJheS5vIFwKKwlkbWEtZmVuY2UtY2hhaW4ubyBcCisJZG1hLWZlbmNlLXBy
b3h5Lm8gXAorCWRtYS1yZXN2Lm8gXAorCXNlcW5vLWZlbmNlLm8KIG9iai0kKENPTkZJR19ETUFC
VUZfSEVBUFMpCSs9IGRtYS1oZWFwLm8KIG9iai0kKENPTkZJR19ETUFCVUZfSEVBUFMpCSs9IGhl
YXBzLwogb2JqLSQoQ09ORklHX1NZTkNfRklMRSkJCSs9IHN5bmNfZmlsZS5vCkBAIC0xMCw2ICsx
Niw3IEBAIG9iai0kKENPTkZJR19VRE1BQlVGKQkJKz0gdWRtYWJ1Zi5vCiBkbWFidWZfc2VsZnRl
c3RzLXkgOj0gXAogCXNlbGZ0ZXN0Lm8gXAogCXN0LWRtYS1mZW5jZS5vIFwKLQlzdC1kbWEtZmVu
Y2UtY2hhaW4ubworCXN0LWRtYS1mZW5jZS1jaGFpbi5vIFwKKwlzdC1kbWEtZmVuY2UtcHJveHku
bwogCiBvYmotJChDT05GSUdfRE1BQlVGX1NFTEZURVNUUykJKz0gZG1hYnVmX3NlbGZ0ZXN0cy5v
CmRpZmYgLS1naXQgYS9kcml2ZXJzL2RtYS1idWYvZG1hLWZlbmNlLXByaXZhdGUuaCBiL2RyaXZl
cnMvZG1hLWJ1Zi9kbWEtZmVuY2UtcHJpdmF0ZS5oCm5ldyBmaWxlIG1vZGUgMTAwNjQ0CmluZGV4
IDAwMDAwMDAwMDAwMC4uNjkyNGQyOGFmMGZhCi0tLSAvZGV2L251bGwKKysrIGIvZHJpdmVycy9k
bWEtYnVmL2RtYS1mZW5jZS1wcml2YXRlLmgKQEAgLTAsMCArMSwyMCBAQAorLyogU1BEWC1MaWNl
bnNlLUlkZW50aWZpZXI6IEdQTC0yLjAtb25seSAqLworLyoKKyAqIEZlbmNlIG1lY2hhbmlzbSBm
b3IgZG1hLWJ1ZiBhbmQgdG8gYWxsb3cgZm9yIGFzeW5jaHJvbm91cyBkbWEgYWNjZXNzCisgKgor
ICogQ29weXJpZ2h0IChDKSAyMDEyIENhbm9uaWNhbCBMdGQKKyAqIENvcHlyaWdodCAoQykgMjAx
MiBUZXhhcyBJbnN0cnVtZW50cworICoKKyAqIEF1dGhvcnM6CisgKiBSb2IgQ2xhcmsgPHJvYmRj
bGFya0BnbWFpbC5jb20+CisgKiBNYWFydGVuIExhbmtob3JzdCA8bWFhcnRlbi5sYW5raG9yc3RA
Y2Fub25pY2FsLmNvbT4KKyAqLworCisjaWZuZGVmIERNQV9GRU5DRV9QUklWQVRFX0gKKyNkZWZp
bmUgRE1BX0ZFTkNFX1BSSUFWVEVfSAorCitzdHJ1Y3QgZG1hX2ZlbmNlOworCitib29sIF9fZG1h
X2ZlbmNlX2VuYWJsZV9zaWduYWxpbmcoc3RydWN0IGRtYV9mZW5jZSAqZmVuY2UpOworCisjZW5k
aWYgLyogRE1BX0ZFTkNFX1BSSUFWVEVfSCAqLwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9kbWEtYnVm
L2RtYS1mZW5jZS1wcm94eS5jIGIvZHJpdmVycy9kbWEtYnVmL2RtYS1mZW5jZS1wcm94eS5jCm5l
dyBmaWxlIG1vZGUgMTAwNjQ0CmluZGV4IDAwMDAwMDAwMDAwMC4uNjY4OWNjODljNmFkCi0tLSAv
ZGV2L251bGwKKysrIGIvZHJpdmVycy9kbWEtYnVmL2RtYS1mZW5jZS1wcm94eS5jCkBAIC0wLDAg
KzEsMjk1IEBACisvLyBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogR1BMLTIuMC1vbmx5CisvKgor
ICogZG1hLWZlbmNlLXByb3h5OiBwbGFjZWhvbGRlciB1bnNpZ25hbGVkIGZlbmNlCisgKgorICog
Q29weXJpZ2h0IChDKSAyMDE3LTIwMTkgSW50ZWwgQ29ycG9yYXRpb24KKyAqLworCisjaW5jbHVk
ZSA8bGludXgvZG1hLWZlbmNlLmg+CisjaW5jbHVkZSA8bGludXgvZG1hLWZlbmNlLXByb3h5Lmg+
CisjaW5jbHVkZSA8bGludXgvZXhwb3J0Lmg+CisjaW5jbHVkZSA8bGludXgvaXJxX3dvcmsuaD4K
KyNpbmNsdWRlIDxsaW51eC9zbGFiLmg+CisKKyNpbmNsdWRlICJkbWEtZmVuY2UtcHJpdmF0ZS5o
IgorCitzdHJ1Y3QgZG1hX2ZlbmNlX3Byb3h5IHsKKwlzdHJ1Y3QgZG1hX2ZlbmNlIGJhc2U7CisK
KwlzdHJ1Y3QgZG1hX2ZlbmNlICpyZWFsOworCXN0cnVjdCBkbWFfZmVuY2VfY2IgY2I7CisJc3Ry
dWN0IGlycV93b3JrIHdvcms7CisKKwl3YWl0X3F1ZXVlX2hlYWRfdCB3cTsKK307CisKKyNpZmRl
ZiBDT05GSUdfREVCVUdfTE9DS19BTExPQworI2RlZmluZSBzYW1lX2xvY2tjbGFzcyhBLCBCKSAo
QSktPmRlcF9tYXAua2V5ID09IChCKS0+ZGVwX21hcC5rZXkKKyNlbHNlCisjZGVmaW5lIHNhbWVf
bG9ja2NsYXNzKEEsIEIpIDAKKyNlbmRpZgorCitzdGF0aWMgY29uc3QgY2hhciAqcHJveHlfZ2V0
X2RyaXZlcl9uYW1lKHN0cnVjdCBkbWFfZmVuY2UgKmZlbmNlKQoreworCXN0cnVjdCBkbWFfZmVu
Y2VfcHJveHkgKnAgPSBjb250YWluZXJfb2YoZmVuY2UsIHR5cGVvZigqcCksIGJhc2UpOworCXN0
cnVjdCBkbWFfZmVuY2UgKnJlYWwgPSBSRUFEX09OQ0UocC0+cmVhbCk7CisKKwlyZXR1cm4gcmVh
bCA/IHJlYWwtPm9wcy0+Z2V0X2RyaXZlcl9uYW1lKHJlYWwpIDogInByb3h5IjsKK30KKworc3Rh
dGljIGNvbnN0IGNoYXIgKnByb3h5X2dldF90aW1lbGluZV9uYW1lKHN0cnVjdCBkbWFfZmVuY2Ug
KmZlbmNlKQoreworCXN0cnVjdCBkbWFfZmVuY2VfcHJveHkgKnAgPSBjb250YWluZXJfb2YoZmVu
Y2UsIHR5cGVvZigqcCksIGJhc2UpOworCXN0cnVjdCBkbWFfZmVuY2UgKnJlYWwgPSBSRUFEX09O
Q0UocC0+cmVhbCk7CisKKwlyZXR1cm4gcmVhbCA/IHJlYWwtPm9wcy0+Z2V0X3RpbWVsaW5lX25h
bWUocmVhbCkgOiAidW5zZXQiOworfQorCitzdGF0aWMgdm9pZCBwcm94eV9pcnFfd29yayhzdHJ1
Y3QgaXJxX3dvcmsgKndvcmspCit7CisJc3RydWN0IGRtYV9mZW5jZV9wcm94eSAqcCA9IGNvbnRh
aW5lcl9vZih3b3JrLCB0eXBlb2YoKnApLCB3b3JrKTsKKworCWRtYV9mZW5jZV9zaWduYWwoJnAt
PmJhc2UpOworCWRtYV9mZW5jZV9wdXQoJnAtPmJhc2UpOworfQorCitzdGF0aWMgdm9pZCBwcm94
eV9jYWxsYmFjayhzdHJ1Y3QgZG1hX2ZlbmNlICpyZWFsLCBzdHJ1Y3QgZG1hX2ZlbmNlX2NiICpj
YikKK3sKKwlzdHJ1Y3QgZG1hX2ZlbmNlX3Byb3h5ICpwID0gY29udGFpbmVyX29mKGNiLCB0eXBl
b2YoKnApLCBjYik7CisKKwlpZiAocmVhbC0+ZXJyb3IpCisJCWRtYV9mZW5jZV9zZXRfZXJyb3Io
JnAtPmJhc2UsIHJlYWwtPmVycm9yKTsKKworCS8qIExvd2VyIHRoZSBoZWlnaHQgb2YgdGhlIHBy
b3h5IGNoYWluIC0+IHNpbmdsZSBzdGFjayBmcmFtZSAqLworCWlycV93b3JrX3F1ZXVlKCZwLT53
b3JrKTsKK30KKworc3RhdGljIGJvb2wgcHJveHlfZW5hYmxlX3NpZ25hbGluZyhzdHJ1Y3QgZG1h
X2ZlbmNlICpmZW5jZSkKK3sKKwlzdHJ1Y3QgZG1hX2ZlbmNlX3Byb3h5ICpwID0gY29udGFpbmVy
X29mKGZlbmNlLCB0eXBlb2YoKnApLCBiYXNlKTsKKwlzdHJ1Y3QgZG1hX2ZlbmNlICpyZWFsID0g
UkVBRF9PTkNFKHAtPnJlYWwpOworCWJvb2wgcmV0ID0gdHJ1ZTsKKworCWlmIChyZWFsKSB7CisJ
CXNwaW5fbG9ja19uZXN0ZWQocmVhbC0+bG9jaywKKwkJCQkgc2FtZV9sb2NrY2xhc3MoJnAtPndx
LmxvY2ssIHJlYWwtPmxvY2spKTsKKwkJcmV0ID0gX19kbWFfZmVuY2VfZW5hYmxlX3NpZ25hbGlu
ZyhyZWFsKTsKKwkJc3Bpbl91bmxvY2socmVhbC0+bG9jayk7CisJfQorCisJcmV0dXJuIHJldDsK
K30KKworc3RhdGljIHZvaWQgcHJveHlfcmVsZWFzZShzdHJ1Y3QgZG1hX2ZlbmNlICpmZW5jZSkK
K3sKKwlzdHJ1Y3QgZG1hX2ZlbmNlX3Byb3h5ICpwID0gY29udGFpbmVyX29mKGZlbmNlLCB0eXBl
b2YoKnApLCBiYXNlKTsKKworCWRtYV9mZW5jZV9wdXQocC0+cmVhbCk7CisJZG1hX2ZlbmNlX2Zy
ZWUoJnAtPmJhc2UpOworfQorCitjb25zdCBzdHJ1Y3QgZG1hX2ZlbmNlX29wcyBkbWFfZmVuY2Vf
cHJveHlfb3BzID0geworCS5nZXRfZHJpdmVyX25hbWUgPSBwcm94eV9nZXRfZHJpdmVyX25hbWUs
CisJLmdldF90aW1lbGluZV9uYW1lID0gcHJveHlfZ2V0X3RpbWVsaW5lX25hbWUsCisJLmVuYWJs
ZV9zaWduYWxpbmcgPSBwcm94eV9lbmFibGVfc2lnbmFsaW5nLAorCS53YWl0ID0gZG1hX2ZlbmNl
X2RlZmF1bHRfd2FpdCwKKwkucmVsZWFzZSA9IHByb3h5X3JlbGVhc2UsCit9OworRVhQT1JUX1NZ
TUJPTF9HUEwoZG1hX2ZlbmNlX3Byb3h5X29wcyk7CisKKy8qKgorICogX19kbWFfZmVuY2VfY3Jl
YXRlX3Byb3h5IC0gQ3JlYXRlIGFuIHVuc2V0IGRtYS1mZW5jZQorICogQGNvbnRleHQ6IGNvbnRl
eHQgbnVtYmVyIHRvIHVzZSBmb3IgcHJveHkgZmVuY2UKKyAqIEBzZXFubzogc2VxdWVuY2UgbnVt
YmVyIHRvIHVzZSBmb3IgcHJveHkgZmVuY2UKKyAqCisgKiBfX2RtYV9mZW5jZV9jcmVhdGVfcHJv
eHkoKSBjcmVhdGVzIGEgbmV3IGRtYV9mZW5jZSBzdHViIHRoYXQgaXMgaW5pdGlhbGx5CisgKiB1
bnNpZ25hbGVkIGFuZCBtYXkgbGF0ZXIgYmUgcmVwbGFjZWQgd2l0aCBhIHJlYWwgZmVuY2UuIEFu
eSBsaXN0ZW5lcnMKKyAqIHRvIHRoZSBwcm94eSBmZW5jZSB3aWxsIGJlIHNpZ25hbGVkIHdoZW4g
dGhlIHRhcmdldCBmZW5jZSBzaWduYWxzIGl0cworICogY29tcGxldGlvbi4KKyAqLworc3RydWN0
IGRtYV9mZW5jZSAqX19kbWFfZmVuY2VfY3JlYXRlX3Byb3h5KHU2NCBjb250ZXh0LCB1NjQgc2Vx
bm8pCit7CisJc3RydWN0IGRtYV9mZW5jZV9wcm94eSAqcDsKKworCXAgPSBremFsbG9jKHNpemVv
ZigqcCksIEdGUF9LRVJORUwpOworCWlmICghcCkKKwkJcmV0dXJuIE5VTEw7CisKKwlpbml0X3dh
aXRxdWV1ZV9oZWFkKCZwLT53cSk7CisJZG1hX2ZlbmNlX2luaXQoJnAtPmJhc2UsICZkbWFfZmVu
Y2VfcHJveHlfb3BzLCAmcC0+d3EubG9jaywKKwkJICAgICAgIGNvbnRleHQsIHNlcW5vKTsKKwlp
bml0X2lycV93b3JrKCZwLT53b3JrLCBwcm94eV9pcnFfd29yayk7CisKKwlyZXR1cm4gJnAtPmJh
c2U7Cit9CitFWFBPUlRfU1lNQk9MKF9fZG1hX2ZlbmNlX2NyZWF0ZV9wcm94eSk7CisKKy8qKgor
ICogZG1hX2ZlbmNlX2NyZWF0ZV9wcm94eSAtIENyZWF0ZSBhbiB1bnNldCBkbWEtZmVuY2UKKyAq
CisgKiBXcmFwcyBfX2RtYV9mZW5jZV9jcmVhdGVfcHJveHkoKSB0byBjcmVhdGUgYSBuZXcgcHJv
eHkgZmVuY2Ugd2l0aCB0aGUKKyAqIG5leHQgYXZhaWxhYmxlICh1bmlxdWUpIGNvbnRleHQgaWQu
CisgKi8KK3N0cnVjdCBkbWFfZmVuY2UgKmRtYV9mZW5jZV9jcmVhdGVfcHJveHkodm9pZCkKK3sK
KwlyZXR1cm4gX19kbWFfZmVuY2VfY3JlYXRlX3Byb3h5KGRtYV9mZW5jZV9jb250ZXh0X2FsbG9j
KDEpLCAwKTsKK30KK0VYUE9SVF9TWU1CT0woZG1hX2ZlbmNlX2NyZWF0ZV9wcm94eSk7CisKK3N0
YXRpYyB2b2lkIF9fd2FrZV91cF9saXN0ZW5lcnMoc3RydWN0IGRtYV9mZW5jZV9wcm94eSAqcCkK
K3sKKwlzdHJ1Y3Qgd2FpdF9xdWV1ZV9lbnRyeSAqd2FpdCwgKm5leHQ7CisKKwlsaXN0X2Zvcl9l
YWNoX2VudHJ5X3NhZmUod2FpdCwgbmV4dCwgJnAtPndxLmhlYWQsIGVudHJ5KSB7CisJCUlOSVRf
TElTVF9IRUFEKCZ3YWl0LT5lbnRyeSk7CisJCXdhaXQtPmZ1bmMod2FpdCwgVEFTS19OT1JNQUws
IDAsIHAtPnJlYWwpOworCX0KK30KKworc3RhdGljIHZvaWQgcHJveHlfYXNzaWduKHN0cnVjdCBk
bWFfZmVuY2UgKmZlbmNlLCBzdHJ1Y3QgZG1hX2ZlbmNlICpyZWFsKQoreworCXN0cnVjdCBkbWFf
ZmVuY2VfcHJveHkgKnAgPSBjb250YWluZXJfb2YoZmVuY2UsIHR5cGVvZigqcCksIGJhc2UpOwor
CXVuc2lnbmVkIGxvbmcgZmxhZ3M7CisKKwlpZiAoV0FSTl9PTihmZW5jZSA9PSByZWFsKSkKKwkJ
cmV0dXJuOworCisJaWYgKFdBUk5fT04odGVzdF9iaXQoRE1BX0ZFTkNFX0ZMQUdfU0lHTkFMRURf
QklULCAmZmVuY2UtPmZsYWdzKSkpCisJCXJldHVybjsKKworCWlmIChXQVJOX09OKHAtPnJlYWwp
KQorCQlyZXR1cm47CisKKwlzcGluX2xvY2tfaXJxc2F2ZSgmcC0+d3EubG9jaywgZmxhZ3MpOwor
CisJaWYgKHVubGlrZWx5KCFyZWFsKSkgeworCQlkbWFfZmVuY2Vfc2lnbmFsX2xvY2tlZCgmcC0+
YmFzZSk7CisJCWdvdG8gdW5sb2NrOworCX0KKworCXAtPnJlYWwgPSBkbWFfZmVuY2VfZ2V0KHJl
YWwpOworCisJZG1hX2ZlbmNlX2dldCgmcC0+YmFzZSk7CisJc3Bpbl9sb2NrX25lc3RlZChyZWFs
LT5sb2NrLCBzYW1lX2xvY2tjbGFzcygmcC0+d3EubG9jaywgcmVhbC0+bG9jaykpOworCWlmIChk
bWFfZmVuY2VfaXNfc2lnbmFsZWRfbG9ja2VkKHJlYWwpKSB7CisJCXByb3h5X2NhbGxiYWNrKHJl
YWwsICZwLT5jYik7CisJfSBlbHNlIGlmICh0ZXN0X2JpdChETUFfRkVOQ0VfRkxBR19FTkFCTEVf
U0lHTkFMX0JJVCwKKwkJCSAgICAmcC0+YmFzZS5mbGFncykgJiYKKwkJICAgIV9fZG1hX2ZlbmNl
X2VuYWJsZV9zaWduYWxpbmcocmVhbCkpIHsKKwkJcHJveHlfY2FsbGJhY2socmVhbCwgJnAtPmNi
KTsKKwl9IGVsc2UgeworCQlwLT5jYi5mdW5jID0gcHJveHlfY2FsbGJhY2s7CisJCWxpc3RfYWRk
X3RhaWwoJnAtPmNiLm5vZGUsICZyZWFsLT5jYl9saXN0KTsKKwl9CisJc3Bpbl91bmxvY2socmVh
bC0+bG9jayk7CisKK3VubG9jazoKKwlfX3dha2VfdXBfbGlzdGVuZXJzKHApOworCXNwaW5fdW5s
b2NrX2lycXJlc3RvcmUoJnAtPndxLmxvY2ssIGZsYWdzKTsKK30KKworLyoqCisgKiBkbWFfZmVu
Y2VfcmVwbGFjZV9wcm94eSAtIFJlcGxhY2UgdGhlIHByb3h5IGZlbmNlIHdpdGggdGhlIHJlYWwg
dGFyZ2V0CisgKiBAc2xvdDogcG9pbnRlciB0byBsb2NhdGlvbiBvZiBmZW5jZSB0byB1cGRhdGUK
KyAqIEBmZW5jZTogdGhlIG5ldyBmZW5jZSB0byBzdG9yZSBpbiBAc2xvdAorICoKKyAqIE9uY2Ug
dGhlIHJlYWwgZG1hX2ZlbmNlIGlzIGtub3duLCB3ZSBjYW4gcmVwbGFjZSB0aGUgcHJveHkgZmVu
Y2UgaG9sZGVyCisgKiB3aXRoIGEgcG9pbnRlciB0byB0aGUgcmVhbCBkbWEgZmVuY2UuIEZ1dHVy
ZSBsaXN0ZW5lcnMgd2lsbCBhdHRhY2ggdG8KKyAqIHRoZSByZWFsIGZlbmNlLCBhdm9pZGluZyBh
bnkgaW5kaXJlY3Rpb24gb3ZlcmhlYWQuIFByZXZpb3VzIGxpc3RlbmVycworICogd2lsbCByZW1h
aW4gYXR0YWNoZWQgdG8gdGhlIHByb3h5IGZlbmNlLCBhbmQgYmUgc2lnbmFsZWQgaW4gdHVybiB3
aGVuCisgKiB0aGUgdGFyZ2V0IGZlbmNlIGNvbXBsZXRlcy4KKyAqLworc3RydWN0IGRtYV9mZW5j
ZSAqCitkbWFfZmVuY2VfcmVwbGFjZV9wcm94eShzdHJ1Y3QgZG1hX2ZlbmNlIF9fcmN1ICoqc2xv
dCwgc3RydWN0IGRtYV9mZW5jZSAqZmVuY2UpCit7CisJc3RydWN0IGRtYV9mZW5jZSAqb2xkOwor
CisJaWYgKGZlbmNlKQorCQlkbWFfZmVuY2VfZ2V0KGZlbmNlKTsKKworCW9sZCA9IHJjdV9yZXBs
YWNlX3BvaW50ZXIoKnNsb3QsIGZlbmNlLCB0cnVlKTsKKwlpZiAob2xkICYmIGRtYV9mZW5jZV9p
c19wcm94eShvbGQpKQorCQlwcm94eV9hc3NpZ24ob2xkLCBmZW5jZSk7CisKKwlyZXR1cm4gb2xk
OworfQorRVhQT1JUX1NZTUJPTChkbWFfZmVuY2VfcmVwbGFjZV9wcm94eSk7CisKKy8qKgorICog
ZG1hX2ZlbmNlX3Byb3h5X3NldF9yZWFsIC0gU2V0IHRoZSB0YXJnZXQgb2YgYSBwcm94eSBmZW5j
ZQorICogQGZlbmNlOiB0aGUgcHJveHkgZmVuY2UKKyAqIEByZWFsOiB0aGUgdGFyZ2V0IGZlbmNl
LgorICoKKyAqLwordm9pZCBkbWFfZmVuY2VfcHJveHlfc2V0X3JlYWwoc3RydWN0IGRtYV9mZW5j
ZSAqZmVuY2UsIHN0cnVjdCBkbWFfZmVuY2UgKnJlYWwpCit7CisJaWYgKGRtYV9mZW5jZV9pc19w
cm94eShmZW5jZSkpCisJCXByb3h5X2Fzc2lnbihmZW5jZSwgcmVhbCk7Cit9CitFWFBPUlRfU1lN
Qk9MKGRtYV9mZW5jZV9wcm94eV9zZXRfcmVhbCk7CisKKy8qKgorICogZG1hX2ZlbmNlX3Byb3h5
X2dldF9yZWFsIC0gUXVlcnkgdGhlIHRhcmdldCBvZiBhIHByb3h5IGZlbmNlCisgKiBAZmVuY2U6
IHRoZSBwcm94eSBmZW5jZQorICoKKyAqIFVucGVlbCB0aGUgcHJveHkgZmVuY2UgdG8gc2VlIGlm
IGl0IGhhcyBiZWVuIHJlcGxhY2VkIHdpdGggYSByZWFsIGZlbmNlLgorICovCitzdHJ1Y3QgZG1h
X2ZlbmNlICpkbWFfZmVuY2VfcHJveHlfZ2V0X3JlYWwoc3RydWN0IGRtYV9mZW5jZSAqZmVuY2Up
Cit7CisJaWYgKGRtYV9mZW5jZV9pc19wcm94eShmZW5jZSkpIHsKKwkJc3RydWN0IGRtYV9mZW5j
ZV9wcm94eSAqcCA9CisJCQljb250YWluZXJfb2YoZmVuY2UsIHR5cGVvZigqcCksIGJhc2UpOwor
CisJCWlmIChwLT5yZWFsKQorCQkJZmVuY2UgPSBwLT5yZWFsOworCX0KKworCXJldHVybiBmZW5j
ZTsKK30KK0VYUE9SVF9TWU1CT0woZG1hX2ZlbmNlX3Byb3h5X2dldF9yZWFsKTsKKwordm9pZCBk
bWFfZmVuY2VfYWRkX3Byb3h5X2xpc3RlbmVyKHN0cnVjdCBkbWFfZmVuY2UgKmZlbmNlLAorCQkJ
CSAgc3RydWN0IHdhaXRfcXVldWVfZW50cnkgKndhaXQpCit7CisJaWYgKGRtYV9mZW5jZV9pc19w
cm94eShmZW5jZSkpIHsKKwkJc3RydWN0IGRtYV9mZW5jZV9wcm94eSAqcCA9CisJCQljb250YWlu
ZXJfb2YoZmVuY2UsIHR5cGVvZigqcCksIGJhc2UpOworCQl1bnNpZ25lZCBsb25nIGZsYWdzOwor
CisJCXNwaW5fbG9ja19pcnFzYXZlKCZwLT53cS5sb2NrLCBmbGFncyk7CisJCWlmICghcC0+cmVh
bCkgeworCQkJbGlzdF9hZGRfdGFpbCgmd2FpdC0+ZW50cnksICZwLT53cS5oZWFkKTsKKwkJCXdh
aXQgPSBOVUxMOworCQl9CisJCWZlbmNlID0gcC0+cmVhbDsKKwkJc3Bpbl91bmxvY2tfaXJxcmVz
dG9yZSgmcC0+d3EubG9jaywgZmxhZ3MpOworCX0KKworCWlmICh3YWl0KSB7CisJCUlOSVRfTElT
VF9IRUFEKCZ3YWl0LT5lbnRyeSk7CisJCXdhaXQtPmZ1bmMod2FpdCwgVEFTS19OT1JNQUwsIDAs
IGZlbmNlKTsKKwl9Cit9CitFWFBPUlRfU1lNQk9MKGRtYV9mZW5jZV9hZGRfcHJveHlfbGlzdGVu
ZXIpOworCitib29sIGRtYV9mZW5jZV9yZW1vdmVfcHJveHlfbGlzdGVuZXIoc3RydWN0IGRtYV9m
ZW5jZSAqZmVuY2UsCisJCQkJICAgICBzdHJ1Y3Qgd2FpdF9xdWV1ZV9lbnRyeSAqd2FpdCkKK3sK
Kwlib29sIHJldCA9IGZhbHNlOworCisJaWYgKGRtYV9mZW5jZV9pc19wcm94eShmZW5jZSkpIHsK
KwkJc3RydWN0IGRtYV9mZW5jZV9wcm94eSAqcCA9CisJCQljb250YWluZXJfb2YoZmVuY2UsIHR5
cGVvZigqcCksIGJhc2UpOworCQl1bnNpZ25lZCBsb25nIGZsYWdzOworCisJCXNwaW5fbG9ja19p
cnFzYXZlKCZwLT53cS5sb2NrLCBmbGFncyk7CisJCWlmICghbGlzdF9lbXB0eSgmd2FpdC0+ZW50
cnkpKSB7CisJCQlsaXN0X2RlbF9pbml0KCZ3YWl0LT5lbnRyeSk7CisJCQlyZXQgPSB0cnVlOwor
CQl9CisJCXNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJnAtPndxLmxvY2ssIGZsYWdzKTsKKwl9CisK
KwlyZXR1cm4gcmV0OworfQorRVhQT1JUX1NZTUJPTChkbWFfZmVuY2VfcmVtb3ZlX3Byb3h5X2xp
c3RlbmVyKTsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZG1hLWJ1Zi9kbWEtZmVuY2UuYyBiL2RyaXZl
cnMvZG1hLWJ1Zi9kbWEtZmVuY2UuYwppbmRleCA2NTZlOWFjMmQwMjguLjMyOWJkMDMzMDU5ZiAx
MDA2NDQKLS0tIGEvZHJpdmVycy9kbWEtYnVmL2RtYS1mZW5jZS5jCisrKyBiL2RyaXZlcnMvZG1h
LWJ1Zi9kbWEtZmVuY2UuYwpAQCAtMTksNiArMTksOCBAQAogI2RlZmluZSBDUkVBVEVfVFJBQ0Vf
UE9JTlRTCiAjaW5jbHVkZSA8dHJhY2UvZXZlbnRzL2RtYV9mZW5jZS5oPgogCisjaW5jbHVkZSAi
ZG1hLWZlbmNlLXByaXZhdGUuaCIKKwogRVhQT1JUX1RSQUNFUE9JTlRfU1lNQk9MKGRtYV9mZW5j
ZV9lbWl0KTsKIEVYUE9SVF9UUkFDRVBPSU5UX1NZTUJPTChkbWFfZmVuY2VfZW5hYmxlX3NpZ25h
bCk7CiBFWFBPUlRfVFJBQ0VQT0lOVF9TWU1CT0woZG1hX2ZlbmNlX3NpZ25hbGVkKTsKQEAgLTI3
NSw3ICsyNzcsNyBAQCB2b2lkIGRtYV9mZW5jZV9mcmVlKHN0cnVjdCBkbWFfZmVuY2UgKmZlbmNl
KQogfQogRVhQT1JUX1NZTUJPTChkbWFfZmVuY2VfZnJlZSk7CiAKLXN0YXRpYyBib29sIF9fZG1h
X2ZlbmNlX2VuYWJsZV9zaWduYWxpbmcoc3RydWN0IGRtYV9mZW5jZSAqZmVuY2UpCitib29sIF9f
ZG1hX2ZlbmNlX2VuYWJsZV9zaWduYWxpbmcoc3RydWN0IGRtYV9mZW5jZSAqZmVuY2UpCiB7CiAJ
Ym9vbCB3YXNfc2V0OwogCmRpZmYgLS1naXQgYS9kcml2ZXJzL2RtYS1idWYvc2VsZnRlc3RzLmgg
Yi9kcml2ZXJzL2RtYS1idWYvc2VsZnRlc3RzLmgKaW5kZXggNTU5MThlZjlhZGFiLi42MTZlY2E3
MGUyZDggMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZG1hLWJ1Zi9zZWxmdGVzdHMuaAorKysgYi9kcml2
ZXJzL2RtYS1idWYvc2VsZnRlc3RzLmgKQEAgLTEyLDMgKzEyLDQgQEAKIHNlbGZ0ZXN0KHNhbml0
eWNoZWNrLCBfX3Nhbml0eWNoZWNrX18pIC8qIGtlZXAgZmlyc3QgKGlndCBzZWxmY2hlY2spICov
CiBzZWxmdGVzdChkbWFfZmVuY2UsIGRtYV9mZW5jZSkKIHNlbGZ0ZXN0KGRtYV9mZW5jZV9jaGFp
biwgZG1hX2ZlbmNlX2NoYWluKQorc2VsZnRlc3QoZG1hX2ZlbmNlX3Byb3h5LCBkbWFfZmVuY2Vf
cHJveHkpCmRpZmYgLS1naXQgYS9kcml2ZXJzL2RtYS1idWYvc3QtZG1hLWZlbmNlLXByb3h5LmMg
Yi9kcml2ZXJzL2RtYS1idWYvc3QtZG1hLWZlbmNlLXByb3h5LmMKbmV3IGZpbGUgbW9kZSAxMDA2
NDQKaW5kZXggMDAwMDAwMDAwMDAwLi5jM2YyMTBiYzRlNjAKLS0tIC9kZXYvbnVsbAorKysgYi9k
cml2ZXJzL2RtYS1idWYvc3QtZG1hLWZlbmNlLXByb3h5LmMKQEAgLTAsMCArMSw3NTIgQEAKKy8v
IFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNSVQKKy8qCisgKiBDb3B5cmlnaHQgwqkgMjAxOSBJ
bnRlbCBDb3Jwb3JhdGlvbgorICovCisKKyNpbmNsdWRlIDxsaW51eC9kZWxheS5oPgorI2luY2x1
ZGUgPGxpbnV4L2RtYS1mZW5jZS5oPgorI2luY2x1ZGUgPGxpbnV4L2RtYS1mZW5jZS1wcm94eS5o
PgorI2luY2x1ZGUgPGxpbnV4L2tlcm5lbC5oPgorI2luY2x1ZGUgPGxpbnV4L3NjaGVkL3NpZ25h
bC5oPgorI2luY2x1ZGUgPGxpbnV4L3NsYWIuaD4KKyNpbmNsdWRlIDxsaW51eC9zcGlubG9jay5o
PgorCisjaW5jbHVkZSAic2VsZnRlc3QuaCIKKworc3RhdGljIHN0cnVjdCBrbWVtX2NhY2hlICpz
bGFiX2ZlbmNlczsKKworc3RhdGljIHN0cnVjdCBtb2NrX2ZlbmNlIHsKKwlzdHJ1Y3QgZG1hX2Zl
bmNlIGJhc2U7CisJc3BpbmxvY2tfdCBsb2NrOworfSAqdG9fbW9ja19mZW5jZShzdHJ1Y3QgZG1h
X2ZlbmNlICpmKSB7CisJcmV0dXJuIGNvbnRhaW5lcl9vZihmLCBzdHJ1Y3QgbW9ja19mZW5jZSwg
YmFzZSk7Cit9CisKK3N0YXRpYyBjb25zdCBjaGFyICptb2NrX25hbWUoc3RydWN0IGRtYV9mZW5j
ZSAqZikKK3sKKwlyZXR1cm4gIm1vY2siOworfQorCitzdGF0aWMgdm9pZCBtb2NrX2ZlbmNlX3Jl
bGVhc2Uoc3RydWN0IGRtYV9mZW5jZSAqZikKK3sKKwlrbWVtX2NhY2hlX2ZyZWUoc2xhYl9mZW5j
ZXMsIHRvX21vY2tfZmVuY2UoZikpOworfQorCitzdGF0aWMgY29uc3Qgc3RydWN0IGRtYV9mZW5j
ZV9vcHMgbW9ja19vcHMgPSB7CisJLmdldF9kcml2ZXJfbmFtZSA9IG1vY2tfbmFtZSwKKwkuZ2V0
X3RpbWVsaW5lX25hbWUgPSBtb2NrX25hbWUsCisJLnJlbGVhc2UgPSBtb2NrX2ZlbmNlX3JlbGVh
c2UsCit9OworCitzdGF0aWMgc3RydWN0IGRtYV9mZW5jZSAqbW9ja19mZW5jZSh2b2lkKQorewor
CXN0cnVjdCBtb2NrX2ZlbmNlICpmOworCisJZiA9IGttZW1fY2FjaGVfYWxsb2Moc2xhYl9mZW5j
ZXMsIEdGUF9LRVJORUwpOworCWlmICghZikKKwkJcmV0dXJuIE5VTEw7CisKKwlzcGluX2xvY2tf
aW5pdCgmZi0+bG9jayk7CisJZG1hX2ZlbmNlX2luaXQoJmYtPmJhc2UsICZtb2NrX29wcywgJmYt
PmxvY2ssIDAsIDApOworCisJcmV0dXJuICZmLT5iYXNlOworfQorCitzdGF0aWMgaW50IHNhbml0
eWNoZWNrKHZvaWQgKmFyZykKK3sKKwlzdHJ1Y3QgZG1hX2ZlbmNlICpmOworCisJZiA9IGRtYV9m
ZW5jZV9jcmVhdGVfcHJveHkoKTsKKwlpZiAoIWYpCisJCXJldHVybiAtRU5PTUVNOworCisJZG1h
X2ZlbmNlX3NpZ25hbChmKTsKKwlkbWFfZmVuY2VfcHV0KGYpOworCisJcmV0dXJuIDA7Cit9CisK
K3N0cnVjdCBmZW5jZXMgeworCXN0cnVjdCBkbWFfZmVuY2UgKnJlYWw7CisJc3RydWN0IGRtYV9m
ZW5jZSAqcHJveHk7CisJc3RydWN0IGRtYV9mZW5jZSBfX3JjdSAqc2xvdDsKK307CisKK3N0YXRp
YyBpbnQgY3JlYXRlX2ZlbmNlcyhzdHJ1Y3QgZmVuY2VzICpmLCBib29sIGF0dGFjaCkKK3sKKwlm
LT5wcm94eSA9IGRtYV9mZW5jZV9jcmVhdGVfcHJveHkoKTsKKwlpZiAoIWYtPnByb3h5KQorCQly
ZXR1cm4gLUVOT01FTTsKKworCVJDVV9JTklUX1BPSU5URVIoZi0+c2xvdCwgZi0+cHJveHkpOwor
CisJZi0+cmVhbCA9IG1vY2tfZmVuY2UoKTsKKwlpZiAoIWYtPnJlYWwpIHsKKwkJZG1hX2ZlbmNl
X3B1dChmLT5wcm94eSk7CisJCXJldHVybiAtRU5PTUVNOworCX0KKworCWlmIChhdHRhY2gpCisJ
CWRtYV9mZW5jZV9yZXBsYWNlX3Byb3h5KCZmLT5zbG90LCBmLT5yZWFsKTsKKworCXJldHVybiAw
OworfQorCitzdGF0aWMgdm9pZCBmcmVlX2ZlbmNlcyhzdHJ1Y3QgZmVuY2VzICpmKQoreworCWRt
YV9mZW5jZV9wdXQoZG1hX2ZlbmNlX3JlcGxhY2VfcHJveHkoJmYtPnNsb3QsIE5VTEwpKTsKKwor
CWRtYV9mZW5jZV9zaWduYWwoZi0+cmVhbCk7CisJZG1hX2ZlbmNlX3B1dChmLT5yZWFsKTsKKwor
CWRtYV9mZW5jZV9zaWduYWwoZi0+cHJveHkpOworCWRtYV9mZW5jZV9wdXQoZi0+cHJveHkpOwor
fQorCitzdGF0aWMgaW50IHdyYXBfdGFyZ2V0KHZvaWQgKmFyZykKK3sKKwlzdHJ1Y3QgZmVuY2Vz
IGY7CisJaW50IGVyciA9IC1FSU5WQUw7CisKKwlpZiAoY3JlYXRlX2ZlbmNlcygmZiwgZmFsc2Up
KQorCQlyZXR1cm4gLUVOT01FTTsKKworCWlmIChkbWFfZmVuY2VfcHJveHlfZ2V0X3JlYWwoZi5w
cm94eSkgIT0gZi5wcm94eSkgeworCQlwcl9lcnIoIlVud3JhcHBlZCBwcm94eSBmZW5jZWQgcmVw
b3J0ZWQgYSB0YXJnZXQgZmVuY2UhXG4iKTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwlkbWFf
ZmVuY2VfcHJveHlfc2V0X3JlYWwoZi5wcm94eSwgZi5yZWFsKTsKKwlyY3VfYXNzaWduX3BvaW50
ZXIoZi5zbG90LCBkbWFfZmVuY2VfZ2V0KGYucmVhbCkpOyAvKiBmcmVlX2ZlbmNlcygpICovCisK
KwlpZiAoZG1hX2ZlbmNlX3Byb3h5X2dldF9yZWFsKGYucHJveHkpICE9IGYucmVhbCkgeworCQlw
cl9lcnIoIldyYXBwZWQgcHJveHkgZmVuY2VkIGRpZCBub3QgcmVwb3J0IHRoZSB0YXJnZXQgZmVu
Y2UhXG4iKTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwllcnIgPSAwOworZXJyX2ZyZWU6CisJ
ZnJlZV9mZW5jZXMoJmYpOworCXJldHVybiBlcnI7Cit9CisKK3N0YXRpYyBpbnQgd3JhcF9wcm94
eSh2b2lkICphcmcpCit7CisJc3RydWN0IGZlbmNlcyBmOworCWludCBlcnIgPSAtRUlOVkFMOwor
CisJaWYgKGNyZWF0ZV9mZW5jZXMoJmYsIHRydWUpKQorCQlyZXR1cm4gLUVOT01FTTsKKworCWlm
IChkbWFfZmVuY2VfcHJveHlfZ2V0X3JlYWwoZi5wcm94eSkgIT0gZi5yZWFsKSB7CisJCXByX2Vy
cigiV3JhcHBlZCBwcm94eSBmZW5jZWQgZGlkIG5vdCByZXBvcnQgdGhlIHRhcmdldCBmZW5jZSFc
biIpOworCQlnb3RvIGVycl9mcmVlOworCX0KKworCWVyciA9IDA7CitlcnJfZnJlZToKKwlmcmVl
X2ZlbmNlcygmZik7CisJcmV0dXJuIGVycjsKK30KKworc3RhdGljIGludCB3cmFwX3NpZ25hbGlu
Zyh2b2lkICphcmcpCit7CisJc3RydWN0IGZlbmNlcyBmOworCWludCBlcnIgPSAtRUlOVkFMOwor
CisJaWYgKGNyZWF0ZV9mZW5jZXMoJmYsIHRydWUpKQorCQlyZXR1cm4gLUVOT01FTTsKKworCWlm
IChkbWFfZmVuY2VfaXNfc2lnbmFsZWQoZi5wcm94eSkpIHsKKwkJcHJfZXJyKCJGZW5jZSB1bmV4
cGVjdGVkbHkgc2lnbmFsZWQgb24gY3JlYXRpb25cbiIpOworCQlnb3RvIGVycl9mcmVlOworCX0K
KworCWlmIChkbWFfZmVuY2Vfc2lnbmFsKGYucmVhbCkpIHsKKwkJcHJfZXJyKCJGZW5jZSByZXBv
cnRlZCBiZWluZyBhbHJlYWR5IHNpZ25hbGVkXG4iKTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisK
KwlpZiAoIWRtYV9mZW5jZV9pc19zaWduYWxlZChmLnByb3h5KSkgeworCQlwcl9lcnIoIkZlbmNl
IG5vdCByZXBvcnRpbmcgc2lnbmFsZWRcbiIpOworCQlnb3RvIGVycl9mcmVlOworCX0KKworCWVy
ciA9IDA7CitlcnJfZnJlZToKKwlmcmVlX2ZlbmNlcygmZik7CisJcmV0dXJuIGVycjsKK30KKwor
c3RhdGljIGludCB3cmFwX3NpZ25hbGluZ19yZWN1cnNlKHZvaWQgKmFyZykKK3sKKwlzdHJ1Y3Qg
ZmVuY2VzIGY7CisJc3RydWN0IGRtYV9mZW5jZSAqY2hhaW47CisJaW50IGVyciA9IC1FSU5WQUw7
CisKKwlpZiAoY3JlYXRlX2ZlbmNlcygmZiwgZmFsc2UpKQorCQlyZXR1cm4gLUVOT01FTTsKKwor
CWNoYWluID0gZG1hX2ZlbmNlX2NyZWF0ZV9wcm94eSgpOworCWlmICghY2hhaW4pIHsKKwkJZXJy
ID0gLUVOT01FTTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwlkbWFfZmVuY2VfcmVwbGFjZV9w
cm94eSgmZi5zbG90LCBjaGFpbik7CisJZG1hX2ZlbmNlX3B1dChkbWFfZmVuY2VfcmVwbGFjZV9w
cm94eSgmZi5zbG90LCBmLnJlYWwpKTsKKwlkbWFfZmVuY2VfcHV0KGNoYWluKTsKKworCS8qIGYu
cmVhbCA8LSBjaGFpbiA8LSBmLnByb3h5ICovCisKKwlpZiAoZG1hX2ZlbmNlX2lzX3NpZ25hbGVk
KGYucHJveHkpKSB7CisJCXByX2VycigiRmVuY2UgdW5leHBlY3RlZGx5IHNpZ25hbGVkIG9uIGNy
ZWF0aW9uXG4iKTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwlpZiAoZG1hX2ZlbmNlX3NpZ25h
bChmLnJlYWwpKSB7CisJCXByX2VycigiRmVuY2UgcmVwb3J0ZWQgYmVpbmcgYWxyZWFkeSBzaWdu
YWxlZFxuIik7CisJCWdvdG8gZXJyX2ZyZWU7CisJfQorCisJaWYgKCFkbWFfZmVuY2VfaXNfc2ln
bmFsZWQoZi5wcm94eSkpIHsKKwkJcHJfZXJyKCJGZW5jZSBub3QgcmVwb3J0aW5nIHNpZ25hbGVk
XG4iKTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwllcnIgPSAwOworZXJyX2ZyZWU6CisJZnJl
ZV9mZW5jZXMoJmYpOworCXJldHVybiBlcnI7Cit9CisKK3N0cnVjdCBzaW1wbGVfY2IgeworCXN0
cnVjdCBkbWFfZmVuY2VfY2IgY2I7CisJYm9vbCBzZWVuOworfTsKKworc3RhdGljIHZvaWQgc2lt
cGxlX2NhbGxiYWNrKHN0cnVjdCBkbWFfZmVuY2UgKmYsIHN0cnVjdCBkbWFfZmVuY2VfY2IgKmNi
KQoreworCS8qIEVuc3VyZSB0aGUgY2FsbGJhY2sgbWFya2VyIGlzIHZpc2libGUsIG5vIGV4Y3Vz
ZXMgZm9yIG1pc3NpbmcgaXQhICovCisJc21wX3N0b3JlX21iKGNvbnRhaW5lcl9vZihjYiwgc3Ry
dWN0IHNpbXBsZV9jYiwgY2IpLT5zZWVuLCB0cnVlKTsKK30KKworc3RhdGljIGludCB3cmFwX2Fk
ZF9jYWxsYmFjayh2b2lkICphcmcpCit7CisJc3RydWN0IHNpbXBsZV9jYiBjYiA9IHt9OworCXN0
cnVjdCBmZW5jZXMgZjsKKwlpbnQgZXJyID0gLUVJTlZBTDsKKworCWlmIChjcmVhdGVfZmVuY2Vz
KCZmLCB0cnVlKSkKKwkJcmV0dXJuIC1FTk9NRU07CisKKwlpZiAoZG1hX2ZlbmNlX2FkZF9jYWxs
YmFjayhmLnByb3h5LCAmY2IuY2IsIHNpbXBsZV9jYWxsYmFjaykpIHsKKwkJcHJfZXJyKCJGYWls
ZWQgdG8gYWRkIGNhbGxiYWNrLCBmZW5jZSBhbHJlYWR5IHNpZ25hbGVkIVxuIik7CisJCWdvdG8g
ZXJyX2ZyZWU7CisJfQorCisJZG1hX2ZlbmNlX3NpZ25hbChmLnJlYWwpOworCWlmICghY2Iuc2Vl
bikgeworCQlwcl9lcnIoIkNhbGxiYWNrIGZhaWxlZCFcbiIpOworCQlnb3RvIGVycl9mcmVlOwor
CX0KKworCWVyciA9IDA7CitlcnJfZnJlZToKKwlmcmVlX2ZlbmNlcygmZik7CisJcmV0dXJuIGVy
cjsKK30KKworc3RhdGljIGludCB3cmFwX2FkZF9jYWxsYmFja19yZWN1cnNlKHZvaWQgKmFyZykK
K3sKKwlzdHJ1Y3Qgc2ltcGxlX2NiIGNiID0ge307CisJc3RydWN0IGRtYV9mZW5jZSAqY2hhaW47
CisJc3RydWN0IGZlbmNlcyBmOworCWludCBlcnIgPSAtRUlOVkFMOworCisJaWYgKGNyZWF0ZV9m
ZW5jZXMoJmYsIGZhbHNlKSkKKwkJcmV0dXJuIC1FTk9NRU07CisKKwljaGFpbiA9IGRtYV9mZW5j
ZV9jcmVhdGVfcHJveHkoKTsKKwlpZiAoIWNoYWluKSB7CisJCWVyciA9IC1FTk9NRU07CisJCWdv
dG8gZXJyX2ZyZWU7CisJfQorCisJZG1hX2ZlbmNlX3JlcGxhY2VfcHJveHkoJmYuc2xvdCwgY2hh
aW4pOworCWRtYV9mZW5jZV9wdXQoZG1hX2ZlbmNlX3JlcGxhY2VfcHJveHkoJmYuc2xvdCwgZi5y
ZWFsKSk7CisJZG1hX2ZlbmNlX3B1dChjaGFpbik7CisKKwkvKiBmLnJlYWwgPC0gY2hhaW4gPC0g
Zi5wcm94eSAqLworCisJaWYgKGRtYV9mZW5jZV9hZGRfY2FsbGJhY2soZi5wcm94eSwgJmNiLmNi
LCBzaW1wbGVfY2FsbGJhY2spKSB7CisJCXByX2VycigiRmFpbGVkIHRvIGFkZCBjYWxsYmFjaywg
ZmVuY2UgYWxyZWFkeSBzaWduYWxlZCFcbiIpOworCQlnb3RvIGVycl9mcmVlOworCX0KKworCWRt
YV9mZW5jZV9zaWduYWwoZi5yZWFsKTsKKwlpZiAoIWNiLnNlZW4pIHsKKwkJcHJfZXJyKCJDYWxs
YmFjayBmYWlsZWQhXG4iKTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwllcnIgPSAwOworZXJy
X2ZyZWU6CisJZnJlZV9mZW5jZXMoJmYpOworCXJldHVybiBlcnI7Cit9CisKK3N0YXRpYyBpbnQg
d3JhcF9sYXRlX2FkZF9jYWxsYmFjayh2b2lkICphcmcpCit7CisJc3RydWN0IHNpbXBsZV9jYiBj
YiA9IHt9OworCXN0cnVjdCBmZW5jZXMgZjsKKwlpbnQgZXJyID0gLUVJTlZBTDsKKworCWlmIChj
cmVhdGVfZmVuY2VzKCZmLCB0cnVlKSkKKwkJcmV0dXJuIC1FTk9NRU07CisKKwlkbWFfZmVuY2Vf
c2lnbmFsKGYucmVhbCk7CisKKwlpZiAoIWRtYV9mZW5jZV9hZGRfY2FsbGJhY2soZi5wcm94eSwg
JmNiLmNiLCBzaW1wbGVfY2FsbGJhY2spKSB7CisJCXByX2VycigiQWRkZWQgY2FsbGJhY2ssIGJ1
dCBmZW5jZSB3YXMgYWxyZWFkeSBzaWduYWxlZCFcbiIpOworCQlnb3RvIGVycl9mcmVlOworCX0K
KworCWRtYV9mZW5jZV9zaWduYWwoZi5yZWFsKTsKKwlpZiAoY2Iuc2VlbikgeworCQlwcl9lcnIo
IkNhbGxiYWNrIGNhbGxlZCBhZnRlciBmYWlsZWQgYXR0YWNobWVudCFcbiIpOworCQlnb3RvIGVy
cl9mcmVlOworCX0KKworCWVyciA9IDA7CitlcnJfZnJlZToKKwlmcmVlX2ZlbmNlcygmZik7CisJ
cmV0dXJuIGVycjsKK30KKworc3RhdGljIGludCB3cmFwX2Vhcmx5X2FkZF9jYWxsYmFjayh2b2lk
ICphcmcpCit7CisJc3RydWN0IHNpbXBsZV9jYiBjYiA9IHt9OworCXN0cnVjdCBmZW5jZXMgZjsK
KwlpbnQgZXJyID0gLUVJTlZBTDsKKworCWlmIChjcmVhdGVfZmVuY2VzKCZmLCBmYWxzZSkpCisJ
CXJldHVybiAtRU5PTUVNOworCisJaWYgKGRtYV9mZW5jZV9hZGRfY2FsbGJhY2soZi5wcm94eSwg
JmNiLmNiLCBzaW1wbGVfY2FsbGJhY2spKSB7CisJCXByX2VycigiRmFpbGVkIHRvIGFkZCBjYWxs
YmFjaywgZmVuY2UgYWxyZWFkeSBzaWduYWxlZCFcbiIpOworCQlnb3RvIGVycl9mcmVlOworCX0K
KworCWRtYV9mZW5jZV9yZXBsYWNlX3Byb3h5KCZmLnNsb3QsIGYucmVhbCk7CisJZG1hX2ZlbmNl
X3NpZ25hbChmLnJlYWwpOworCWlmICghY2Iuc2VlbikgeworCQlwcl9lcnIoIkNhbGxiYWNrIGZh
aWxlZCFcbiIpOworCQlnb3RvIGVycl9mcmVlOworCX0KKworCWVyciA9IDA7CitlcnJfZnJlZToK
KwlmcmVlX2ZlbmNlcygmZik7CisJcmV0dXJuIGVycjsKK30KKworc3RhdGljIGludCB3cmFwX2Vh
cmx5X2FkZF9jYWxsYmFja19sYXRlKHZvaWQgKmFyZykKK3sKKwlzdHJ1Y3Qgc2ltcGxlX2NiIGNi
ID0ge307CisJc3RydWN0IGZlbmNlcyBmOworCWludCBlcnIgPSAtRUlOVkFMOworCisJaWYgKGNy
ZWF0ZV9mZW5jZXMoJmYsIGZhbHNlKSkKKwkJcmV0dXJuIC1FTk9NRU07CisKKwlkbWFfZmVuY2Vf
c2lnbmFsKGYucmVhbCk7CisKKwlpZiAoZG1hX2ZlbmNlX2FkZF9jYWxsYmFjayhmLnByb3h5LCAm
Y2IuY2IsIHNpbXBsZV9jYWxsYmFjaykpIHsKKwkJcHJfZXJyKCJGYWlsZWQgdG8gYWRkIGNhbGxi
YWNrLCBmZW5jZSBhbHJlYWR5IHNpZ25hbGVkIVxuIik7CisJCWdvdG8gZXJyX2ZyZWU7CisJfQor
CisJZG1hX2ZlbmNlX3JlcGxhY2VfcHJveHkoJmYuc2xvdCwgZi5yZWFsKTsKKwlkbWFfZmVuY2Vf
c2lnbmFsKGYucmVhbCk7CisJaWYgKCFjYi5zZWVuKSB7CisJCXByX2VycigiQ2FsbGJhY2sgZmFp
bGVkIVxuIik7CisJCWdvdG8gZXJyX2ZyZWU7CisJfQorCisJZXJyID0gMDsKK2Vycl9mcmVlOgor
CWZyZWVfZmVuY2VzKCZmKTsKKwlyZXR1cm4gZXJyOworfQorCitzdGF0aWMgaW50IHdyYXBfZWFy
bHlfYWRkX2NhbGxiYWNrX2Vhcmx5KHZvaWQgKmFyZykKK3sKKwlzdHJ1Y3Qgc2ltcGxlX2NiIGNi
ID0ge307CisJc3RydWN0IGZlbmNlcyBmOworCWludCBlcnIgPSAtRUlOVkFMOworCisJaWYgKGNy
ZWF0ZV9mZW5jZXMoJmYsIGZhbHNlKSkKKwkJcmV0dXJuIC1FTk9NRU07CisKKwlpZiAoZG1hX2Zl
bmNlX2FkZF9jYWxsYmFjayhmLnByb3h5LCAmY2IuY2IsIHNpbXBsZV9jYWxsYmFjaykpIHsKKwkJ
cHJfZXJyKCJGYWlsZWQgdG8gYWRkIGNhbGxiYWNrLCBmZW5jZSBhbHJlYWR5IHNpZ25hbGVkIVxu
Iik7CisJCWdvdG8gZXJyX2ZyZWU7CisJfQorCisJZG1hX2ZlbmNlX3JlcGxhY2VfcHJveHkoJmYu
c2xvdCwgZi5yZWFsKTsKKwlkbWFfZmVuY2Vfc2lnbmFsKGYucmVhbCk7CisJaWYgKCFjYi5zZWVu
KSB7CisJCXByX2VycigiQ2FsbGJhY2sgZmFpbGVkIVxuIik7CisJCWdvdG8gZXJyX2ZyZWU7CisJ
fQorCisJZXJyID0gMDsKK2Vycl9mcmVlOgorCWZyZWVfZmVuY2VzKCZmKTsKKwlyZXR1cm4gZXJy
OworfQorCitzdGF0aWMgaW50IHdyYXBfcm1fY2FsbGJhY2sodm9pZCAqYXJnKQoreworCXN0cnVj
dCBzaW1wbGVfY2IgY2IgPSB7fTsKKwlzdHJ1Y3QgZmVuY2VzIGY7CisJaW50IGVyciA9IC1FSU5W
QUw7CisKKwlpZiAoY3JlYXRlX2ZlbmNlcygmZiwgdHJ1ZSkpCisJCXJldHVybiAtRU5PTUVNOwor
CisJaWYgKGRtYV9mZW5jZV9hZGRfY2FsbGJhY2soZi5wcm94eSwgJmNiLmNiLCBzaW1wbGVfY2Fs
bGJhY2spKSB7CisJCXByX2VycigiRmFpbGVkIHRvIGFkZCBjYWxsYmFjaywgZmVuY2UgYWxyZWFk
eSBzaWduYWxlZCFcbiIpOworCQlnb3RvIGVycl9mcmVlOworCX0KKworCWlmICghZG1hX2ZlbmNl
X3JlbW92ZV9jYWxsYmFjayhmLnByb3h5LCAmY2IuY2IpKSB7CisJCXByX2VycigiRmFpbGVkIHRv
IHJlbW92ZSBjYWxsYmFjayFcbiIpOworCQlnb3RvIGVycl9mcmVlOworCX0KKworCWRtYV9mZW5j
ZV9zaWduYWwoZi5yZWFsKTsKKwlpZiAoY2Iuc2VlbikgeworCQlwcl9lcnIoIkNhbGxiYWNrIHN0
aWxsIHNpZ25hbGVkIGFmdGVyIHJlbW92YWwhXG4iKTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisK
KwllcnIgPSAwOworZXJyX2ZyZWU6CisJZnJlZV9mZW5jZXMoJmYpOworCXJldHVybiBlcnI7Cit9
CisKK3N0YXRpYyBpbnQgd3JhcF9sYXRlX3JtX2NhbGxiYWNrKHZvaWQgKmFyZykKK3sKKwlzdHJ1
Y3Qgc2ltcGxlX2NiIGNiID0ge307CisJc3RydWN0IGZlbmNlcyBmOworCWludCBlcnIgPSAtRUlO
VkFMOworCisJaWYgKGNyZWF0ZV9mZW5jZXMoJmYsIHRydWUpKQorCQlyZXR1cm4gLUVOT01FTTsK
KworCWlmIChkbWFfZmVuY2VfYWRkX2NhbGxiYWNrKGYucHJveHksICZjYi5jYiwgc2ltcGxlX2Nh
bGxiYWNrKSkgeworCQlwcl9lcnIoIkZhaWxlZCB0byBhZGQgY2FsbGJhY2ssIGZlbmNlIGFscmVh
ZHkgc2lnbmFsZWQhXG4iKTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwlkbWFfZmVuY2Vfc2ln
bmFsKGYucmVhbCk7CisJaWYgKCFjYi5zZWVuKSB7CisJCXByX2VycigiQ2FsbGJhY2sgZmFpbGVk
IVxuIik7CisJCWdvdG8gZXJyX2ZyZWU7CisJfQorCisJaWYgKGRtYV9mZW5jZV9yZW1vdmVfY2Fs
bGJhY2soZi5wcm94eSwgJmNiLmNiKSkgeworCQlwcl9lcnIoIkNhbGxiYWNrIHJlbW92YWwgc3Vj
Y2VlZCBhZnRlciBiZWluZyBleGVjdXRlZCFcbiIpOworCQlnb3RvIGVycl9mcmVlOworCX0KKwor
CWVyciA9IDA7CitlcnJfZnJlZToKKwlmcmVlX2ZlbmNlcygmZik7CisJcmV0dXJuIGVycjsKK30K
Kworc3RhdGljIGludCB3cmFwX3N0YXR1cyh2b2lkICphcmcpCit7CisJc3RydWN0IGZlbmNlcyBm
OworCWludCBlcnIgPSAtRUlOVkFMOworCisJaWYgKGNyZWF0ZV9mZW5jZXMoJmYsIHRydWUpKQor
CQlyZXR1cm4gLUVOT01FTTsKKworCWlmIChkbWFfZmVuY2VfZ2V0X3N0YXR1cyhmLnByb3h5KSkg
eworCQlwcl9lcnIoIkZlbmNlIHVuZXhwZWN0ZWRseSBoYXMgc2lnbmFsZWQgc3RhdHVzIG9uIGNy
ZWF0aW9uXG4iKTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwlkbWFfZmVuY2Vfc2lnbmFsKGYu
cmVhbCk7CisJaWYgKCFkbWFfZmVuY2VfZ2V0X3N0YXR1cyhmLnByb3h5KSkgeworCQlwcl9lcnIo
IkZlbmNlIG5vdCByZXBvcnRpbmcgc2lnbmFsZWQgc3RhdHVzXG4iKTsKKwkJZ290byBlcnJfZnJl
ZTsKKwl9CisKKwllcnIgPSAwOworZXJyX2ZyZWU6CisJZnJlZV9mZW5jZXMoJmYpOworCXJldHVy
biBlcnI7Cit9CisKK3N0YXRpYyBpbnQgd3JhcF9lcnJvcih2b2lkICphcmcpCit7CisJc3RydWN0
IGZlbmNlcyBmOworCWludCBlcnIgPSAtRUlOVkFMOworCisJaWYgKGNyZWF0ZV9mZW5jZXMoJmYs
IHRydWUpKQorCQlyZXR1cm4gLUVOT01FTTsKKworCWRtYV9mZW5jZV9zZXRfZXJyb3IoZi5yZWFs
LCAtRUlPKTsKKworCWlmIChkbWFfZmVuY2VfZ2V0X3N0YXR1cyhmLnByb3h5KSkgeworCQlwcl9l
cnIoIkZlbmNlIHVuZXhwZWN0ZWRseSBoYXMgZXJyb3Igc3RhdHVzIGJlZm9yZSBzaWduYWxcbiIp
OworCQlnb3RvIGVycl9mcmVlOworCX0KKworCWRtYV9mZW5jZV9zaWduYWwoZi5yZWFsKTsKKwlp
ZiAoZG1hX2ZlbmNlX2dldF9zdGF0dXMoZi5wcm94eSkgIT0gLUVJTykgeworCQlwcl9lcnIoIkZl
bmNlIG5vdCByZXBvcnRpbmcgZXJyb3Igc3RhdHVzLCBnb3QgJWRcbiIsCisJCSAgICAgICBkbWFf
ZmVuY2VfZ2V0X3N0YXR1cyhmLnByb3h5KSk7CisJCWdvdG8gZXJyX2ZyZWU7CisJfQorCisJZXJy
ID0gMDsKK2Vycl9mcmVlOgorCWZyZWVfZmVuY2VzKCZmKTsKKwlyZXR1cm4gZXJyOworfQorCitz
dGF0aWMgaW50IHdyYXBfd2FpdCh2b2lkICphcmcpCit7CisJc3RydWN0IGZlbmNlcyBmOworCWlu
dCBlcnIgPSAtRUlOVkFMOworCisJaWYgKGNyZWF0ZV9mZW5jZXMoJmYsIHRydWUpKQorCQlyZXR1
cm4gLUVOT01FTTsKKworCWlmIChkbWFfZmVuY2Vfd2FpdF90aW1lb3V0KGYucHJveHksIGZhbHNl
LCAwKSAhPSAwKSB7CisJCXByX2VycigiV2FpdCByZXBvcnRlZCBjb21wbGV0ZSBiZWZvcmUgYmVp
bmcgc2lnbmFsZWRcbiIpOworCQlnb3RvIGVycl9mcmVlOworCX0KKworCWRtYV9mZW5jZV9zaWdu
YWwoZi5yZWFsKTsKKworCWlmIChkbWFfZmVuY2Vfd2FpdF90aW1lb3V0KGYucHJveHksIGZhbHNl
LCAwKSA9PSAwKSB7CisJCXByX2VycigiV2FpdCByZXBvcnRlZCBpbmNvbXBsZXRlIGFmdGVyIGJl
aW5nIHNpZ25hbGVkXG4iKTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwllcnIgPSAwOworZXJy
X2ZyZWU6CisJZG1hX2ZlbmNlX3NpZ25hbChmLnJlYWwpOworCWZyZWVfZmVuY2VzKCZmKTsKKwly
ZXR1cm4gZXJyOworfQorCitzdHJ1Y3Qgd2FpdF90aW1lciB7CisJc3RydWN0IHRpbWVyX2xpc3Qg
dGltZXI7CisJc3RydWN0IGZlbmNlcyBmOworfTsKKworc3RhdGljIHZvaWQgd2FpdF90aW1lcihz
dHJ1Y3QgdGltZXJfbGlzdCAqdGltZXIpCit7CisJc3RydWN0IHdhaXRfdGltZXIgKnd0ID0gZnJv
bV90aW1lcih3dCwgdGltZXIsIHRpbWVyKTsKKworCWRtYV9mZW5jZV9zaWduYWwod3QtPmYucmVh
bCk7Cit9CisKK3N0YXRpYyBpbnQgd3JhcF93YWl0X3RpbWVvdXQodm9pZCAqYXJnKQoreworCXN0
cnVjdCB3YWl0X3RpbWVyIHd0OworCWludCBlcnIgPSAtRUlOVkFMOworCisJaWYgKGNyZWF0ZV9m
ZW5jZXMoJnd0LmYsIHRydWUpKQorCQlyZXR1cm4gLUVOT01FTTsKKworCXRpbWVyX3NldHVwX29u
X3N0YWNrKCZ3dC50aW1lciwgd2FpdF90aW1lciwgMCk7CisKKwlpZiAoZG1hX2ZlbmNlX3dhaXRf
dGltZW91dCh3dC5mLnByb3h5LCBmYWxzZSwgMSkgIT0gMCkgeworCQlwcl9lcnIoIldhaXQgcmVw
b3J0ZWQgY29tcGxldGUgYmVmb3JlIGJlaW5nIHNpZ25hbGVkXG4iKTsKKwkJZ290byBlcnJfZnJl
ZTsKKwl9CisKKwltb2RfdGltZXIoJnd0LnRpbWVyLCBqaWZmaWVzICsgMSk7CisKKwlpZiAoZG1h
X2ZlbmNlX3dhaXRfdGltZW91dCh3dC5mLnByb3h5LCBmYWxzZSwgMikgIT0gMCkgeworCQlpZiAo
dGltZXJfcGVuZGluZygmd3QudGltZXIpKSB7CisJCQlwcl9ub3RpY2UoIlRpbWVyIGRpZCBub3Qg
ZmlyZSB3aXRoaW4gdGhlIGppZmZpZSFcbiIpOworCQkJZXJyID0gMDsgLyogbm90IG91ciBmYXVs
dCEgKi8KKwkJfSBlbHNlIHsKKwkJCXByX2VycigiV2FpdCByZXBvcnRlZCBpbmNvbXBsZXRlIGFm
dGVyIHRpbWVvdXRcbiIpOworCQl9CisJCWdvdG8gZXJyX2ZyZWU7CisJfQorCisJZXJyID0gMDsK
K2Vycl9mcmVlOgorCWRlbF90aW1lcl9zeW5jKCZ3dC50aW1lcik7CisJZGVzdHJveV90aW1lcl9v
bl9zdGFjaygmd3QudGltZXIpOworCWRtYV9mZW5jZV9zaWduYWwod3QuZi5yZWFsKTsKKwlmcmVl
X2ZlbmNlcygmd3QuZik7CisJcmV0dXJuIGVycjsKK30KKworc3RydWN0IHByb3h5X3dhaXQgewor
CXN0cnVjdCB3YWl0X3F1ZXVlX2VudHJ5IGJhc2U7CisJc3RydWN0IGRtYV9mZW5jZSAqZmVuY2U7
CisJYm9vbCBzZWVuOworfTsKKworc3RhdGljIGludCBwcm94eV93YWl0X2NiKHN0cnVjdCB3YWl0
X3F1ZXVlX2VudHJ5ICplbnRyeSwKKwkJCSB1bnNpZ25lZCBpbnQgbW9kZSwgaW50IGZsYWdzLCB2
b2lkICprZXkpCit7CisJc3RydWN0IHByb3h5X3dhaXQgKnAgPSBjb250YWluZXJfb2YoZW50cnks
IHR5cGVvZigqcCksIGJhc2UpOworCisJcC0+ZmVuY2UgPSBrZXk7CisJcC0+c2VlbiA9IHRydWU7
CisKKwlyZXR1cm4gMDsKK30KKworc3RhdGljIGludCB3cmFwX2xpc3Rlbl9lYXJseSh2b2lkICph
cmcpCit7CisJc3RydWN0IHByb3h5X3dhaXQgd2FpdCA9IHsgLmJhc2UuZnVuYyA9IHByb3h5X3dh
aXRfY2IgfTsKKwlzdHJ1Y3QgZmVuY2VzIGY7CisJaW50IGVyciA9IC1FSU5WQUw7CisKKwlpZiAo
Y3JlYXRlX2ZlbmNlcygmZiwgZmFsc2UpKQorCQlyZXR1cm4gLUVOT01FTTsKKworCWRtYV9mZW5j
ZV9yZXBsYWNlX3Byb3h5KCZmLnNsb3QsIGYucmVhbCk7CisJZG1hX2ZlbmNlX2FkZF9wcm94eV9s
aXN0ZW5lcihmLnByb3h5LCAmd2FpdC5iYXNlKTsKKworCWlmICghd2FpdC5zZWVuKSB7CisJCXBy
X2VycigiUHJveHkgbGlzdGVuZXIgd2FzIG5vdCBjYWxsZWQgYWZ0ZXIgcmVwbGFjZSFcbiIpOwor
CQllcnIgPSAtRUlOVkFMOworCQlnb3RvIGVycl9mcmVlOworCX0KKworCWlmICh3YWl0LmZlbmNl
ICE9IGYucmVhbCkgeworCQlwcl9lcnIoIlByb3h5IGxpc3RlbmVyIHdhcyBub3QgcGFzc2VkIHRo
ZSByZWFsIGZlbmNlIVxuIik7CisJCWVyciA9IC1FSU5WQUw7CisJCWdvdG8gZXJyX2ZyZWU7CisJ
fQorCisJZXJyID0gMDsKK2Vycl9mcmVlOgorCWRtYV9mZW5jZV9zaWduYWwoZi5yZWFsKTsKKwlm
cmVlX2ZlbmNlcygmZik7CisJcmV0dXJuIGVycjsKK30KKworc3RhdGljIGludCB3cmFwX2xpc3Rl
bl9sYXRlKHZvaWQgKmFyZykKK3sKKwlzdHJ1Y3QgcHJveHlfd2FpdCB3YWl0ID0geyAuYmFzZS5m
dW5jID0gcHJveHlfd2FpdF9jYiB9OworCXN0cnVjdCBmZW5jZXMgZjsKKwlpbnQgZXJyID0gLUVJ
TlZBTDsKKworCWlmIChjcmVhdGVfZmVuY2VzKCZmLCBmYWxzZSkpCisJCXJldHVybiAtRU5PTUVN
OworCisJZG1hX2ZlbmNlX2FkZF9wcm94eV9saXN0ZW5lcihmLnByb3h5LCAmd2FpdC5iYXNlKTsK
KwlkbWFfZmVuY2VfcmVwbGFjZV9wcm94eSgmZi5zbG90LCBmLnJlYWwpOworCisJaWYgKCF3YWl0
LnNlZW4pIHsKKwkJcHJfZXJyKCJQcm94eSBsaXN0ZW5lciB3YXMgbm90IGNhbGxlZCBvbiByZXBs
YWNlIVxuIik7CisJCWVyciA9IC1FSU5WQUw7CisJCWdvdG8gZXJyX2ZyZWU7CisJfQorCisJaWYg
KHdhaXQuZmVuY2UgIT0gZi5yZWFsKSB7CisJCXByX2VycigiUHJveHkgbGlzdGVuZXIgd2FzIG5v
dCBwYXNzZWQgdGhlIHJlYWwgZmVuY2UhXG4iKTsKKwkJZXJyID0gLUVJTlZBTDsKKwkJZ290byBl
cnJfZnJlZTsKKwl9CisKKwllcnIgPSAwOworZXJyX2ZyZWU6CisJZG1hX2ZlbmNlX3NpZ25hbChm
LnJlYWwpOworCWZyZWVfZmVuY2VzKCZmKTsKKwlyZXR1cm4gZXJyOworfQorCitzdGF0aWMgaW50
IHdyYXBfbGlzdGVuX2NhbmNlbCh2b2lkICphcmcpCit7CisJc3RydWN0IHByb3h5X3dhaXQgd2Fp
dCA9IHsgLmJhc2UuZnVuYyA9IHByb3h5X3dhaXRfY2IgfTsKKwlzdHJ1Y3QgZmVuY2VzIGY7CisJ
aW50IGVyciA9IC1FSU5WQUw7CisKKwlpZiAoY3JlYXRlX2ZlbmNlcygmZiwgZmFsc2UpKQorCQly
ZXR1cm4gLUVOT01FTTsKKworCWRtYV9mZW5jZV9hZGRfcHJveHlfbGlzdGVuZXIoZi5wcm94eSwg
JndhaXQuYmFzZSk7CisJaWYgKCFkbWFfZmVuY2VfcmVtb3ZlX3Byb3h5X2xpc3RlbmVyKGYucHJv
eHksICZ3YWl0LmJhc2UpKSB7CisJCXByX2VycigiQ2FuY2VsbGluZyBsaXN0ZW5lciwgYWxyZWFk
eSBkZXRhY2hlZD9cbiIpOworCQllcnIgPSAtRUlOVkFMOworCQlnb3RvIGVycl9mcmVlOworCX0K
KwlkbWFfZmVuY2VfcmVwbGFjZV9wcm94eSgmZi5zbG90LCBmLnJlYWwpOworCisJaWYgKHdhaXQu
c2VlbikgeworCQlwcl9lcnIoIlByb3h5IGxpc3RlbmVyIHdhcyBjYWxsZWQgYWZ0ZXIgYmVpbmcg
cmVtb3ZlZCFcbiIpOworCQllcnIgPSAtRUlOVkFMOworCQlnb3RvIGVycl9mcmVlOworCX0KKwor
CWlmIChkbWFfZmVuY2VfcmVtb3ZlX3Byb3h5X2xpc3RlbmVyKGYucHJveHksICZ3YWl0LmJhc2Up
KSB7CisJCXByX2VycigiRG91YmxlIGxpc3RlbmVyIGNhbmNlbGxhdGlvbiFcbiIpOworCQllcnIg
PSAtRUlOVkFMOworCQlnb3RvIGVycl9mcmVlOworCX0KKworCWVyciA9IDA7CitlcnJfZnJlZToK
KwlkbWFfZmVuY2Vfc2lnbmFsKGYucmVhbCk7CisJZnJlZV9mZW5jZXMoJmYpOworCXJldHVybiBl
cnI7Cit9CisKK2ludCBkbWFfZmVuY2VfcHJveHkodm9pZCkKK3sKKwlzdGF0aWMgY29uc3Qgc3Ry
dWN0IHN1YnRlc3QgdGVzdHNbXSA9IHsKKwkJU1VCVEVTVChzYW5pdHljaGVjayksCisJCVNVQlRF
U1Qod3JhcF90YXJnZXQpLAorCQlTVUJURVNUKHdyYXBfcHJveHkpLAorCQlTVUJURVNUKHdyYXBf
c2lnbmFsaW5nKSwKKwkJU1VCVEVTVCh3cmFwX3NpZ25hbGluZ19yZWN1cnNlKSwKKwkJU1VCVEVT
VCh3cmFwX2FkZF9jYWxsYmFjayksCisJCVNVQlRFU1Qod3JhcF9hZGRfY2FsbGJhY2tfcmVjdXJz
ZSksCisJCVNVQlRFU1Qod3JhcF9sYXRlX2FkZF9jYWxsYmFjayksCisJCVNVQlRFU1Qod3JhcF9l
YXJseV9hZGRfY2FsbGJhY2spLAorCQlTVUJURVNUKHdyYXBfZWFybHlfYWRkX2NhbGxiYWNrX2xh
dGUpLAorCQlTVUJURVNUKHdyYXBfZWFybHlfYWRkX2NhbGxiYWNrX2Vhcmx5KSwKKwkJU1VCVEVT
VCh3cmFwX3JtX2NhbGxiYWNrKSwKKwkJU1VCVEVTVCh3cmFwX2xhdGVfcm1fY2FsbGJhY2spLAor
CQlTVUJURVNUKHdyYXBfc3RhdHVzKSwKKwkJU1VCVEVTVCh3cmFwX2Vycm9yKSwKKwkJU1VCVEVT
VCh3cmFwX3dhaXQpLAorCQlTVUJURVNUKHdyYXBfd2FpdF90aW1lb3V0KSwKKwkJU1VCVEVTVCh3
cmFwX2xpc3Rlbl9lYXJseSksCisJCVNVQlRFU1Qod3JhcF9saXN0ZW5fbGF0ZSksCisJCVNVQlRF
U1Qod3JhcF9saXN0ZW5fY2FuY2VsKSwKKwl9OworCWludCByZXQ7CisKKwlzbGFiX2ZlbmNlcyA9
IEtNRU1fQ0FDSEUobW9ja19mZW5jZSwKKwkJCQkgU0xBQl9UWVBFU0FGRV9CWV9SQ1UgfAorCQkJ
CSBTTEFCX0hXQ0FDSEVfQUxJR04pOworCWlmICghc2xhYl9mZW5jZXMpCisJCXJldHVybiAtRU5P
TUVNOworCisJcmV0ID0gc3VidGVzdHModGVzdHMsIE5VTEwpOworCisJa21lbV9jYWNoZV9kZXN0
cm95KHNsYWJfZmVuY2VzKTsKKworCXJldHVybiByZXQ7Cit9CmRpZmYgLS1naXQgYS9pbmNsdWRl
L2xpbnV4L2RtYS1mZW5jZS1wcm94eS5oIGIvaW5jbHVkZS9saW51eC9kbWEtZmVuY2UtcHJveHku
aApuZXcgZmlsZSBtb2RlIDEwMDY0NAppbmRleCAwMDAwMDAwMDAwMDAuLjZhOTg2YjViYjAwOQot
LS0gL2Rldi9udWxsCisrKyBiL2luY2x1ZGUvbGludXgvZG1hLWZlbmNlLXByb3h5LmgKQEAgLTAs
MCArMSwzOCBAQAorLyogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEdQTC0yLjAtb25seSAqLwor
LyoKKyAqIGRtYS1mZW5jZS1wcm94eTogYWxsb3dzIHdhaXRpbmcgdXBvbiB1bnNldCBhbmQgZnV0
dXJlIGZlbmNlcworICoKKyAqIENvcHlyaWdodCAoQykgMjAxNyBJbnRlbCBDb3Jwb3JhdGlvbgor
ICovCisKKyNpZm5kZWYgX19MSU5VWF9ETUFfRkVOQ0VfUFJPWFlfSAorI2RlZmluZSBfX0xJTlVY
X0RNQV9GRU5DRV9QUk9YWV9ICisKKyNpbmNsdWRlIDxsaW51eC9rZXJuZWwuaD4KKyNpbmNsdWRl
IDxsaW51eC9kbWEtZmVuY2UuaD4KKworc3RydWN0IHdhaXRfcXVldWVfZW50cnk7CisKK2V4dGVy
biBjb25zdCBzdHJ1Y3QgZG1hX2ZlbmNlX29wcyBkbWFfZmVuY2VfcHJveHlfb3BzOworCitzdHJ1
Y3QgZG1hX2ZlbmNlICpfX2RtYV9mZW5jZV9jcmVhdGVfcHJveHkodTY0IGNvbnRleHQsIHU2NCBz
ZXFubyk7CitzdHJ1Y3QgZG1hX2ZlbmNlICpkbWFfZmVuY2VfY3JlYXRlX3Byb3h5KHZvaWQpOwor
CitzdGF0aWMgaW5saW5lIGJvb2wgZG1hX2ZlbmNlX2lzX3Byb3h5KHN0cnVjdCBkbWFfZmVuY2Ug
KmZlbmNlKQoreworCXJldHVybiBmZW5jZS0+b3BzID09ICZkbWFfZmVuY2VfcHJveHlfb3BzOwor
fQorCit2b2lkIGRtYV9mZW5jZV9wcm94eV9zZXRfcmVhbChzdHJ1Y3QgZG1hX2ZlbmNlICpmZW5j
ZSwgc3RydWN0IGRtYV9mZW5jZSAqcmVhbCk7CitzdHJ1Y3QgZG1hX2ZlbmNlICpkbWFfZmVuY2Vf
cHJveHlfZ2V0X3JlYWwoc3RydWN0IGRtYV9mZW5jZSAqZmVuY2UpOworCitzdHJ1Y3QgZG1hX2Zl
bmNlICoKK2RtYV9mZW5jZV9yZXBsYWNlX3Byb3h5KHN0cnVjdCBkbWFfZmVuY2UgX19yY3UgKipz
bG90LAorCQkJc3RydWN0IGRtYV9mZW5jZSAqZmVuY2UpOworCit2b2lkIGRtYV9mZW5jZV9hZGRf
cHJveHlfbGlzdGVuZXIoc3RydWN0IGRtYV9mZW5jZSAqZmVuY2UsCisJCQkJICBzdHJ1Y3Qgd2Fp
dF9xdWV1ZV9lbnRyeSAqd2FpdCk7Citib29sIGRtYV9mZW5jZV9yZW1vdmVfcHJveHlfbGlzdGVu
ZXIoc3RydWN0IGRtYV9mZW5jZSAqZmVuY2UsCisJCQkJICAgICBzdHJ1Y3Qgd2FpdF9xdWV1ZV9l
bnRyeSAqd2FpdCk7CisKKyNlbmRpZiAvKiBfX0xJTlVYX0RNQV9GRU5DRV9QUk9YWV9IICovCi0t
IAoyLjIwLjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
CkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpo
dHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWdmeAo=

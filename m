Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 561205FABFF
	for <lists+intel-gfx@lfdr.de>; Tue, 11 Oct 2022 07:53:42 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id D2FBA10E4DB;
	Tue, 11 Oct 2022 05:53:35 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mga03.intel.com (mga03.intel.com [134.134.136.65])
 by gabe.freedesktop.org (Postfix) with ESMTPS id A12A510E4DB
 for <intel-gfx@lists.freedesktop.org>; Tue, 11 Oct 2022 05:53:32 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
 d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
 t=1665467612; x=1697003612;
 h=date:message-id:from:to:cc:subject:in-reply-to:
 references:mime-version;
 bh=IqeHqwkwRbxeyFbNnmTtvZU3D6qVlw4yfEeEukS+Ue8=;
 b=fgtDdcW8KGtQDxr+zbZuUM2+AMIP6+E00B1SUfDZnL7dmS0JM8pRt06q
 okltEUgJ8osaKzjLgsiIMX/bFIIAunnfXSLKXP2jx/4aFNIcZ0ixnUqkf
 5MIoZ1KYIS9wNWs7mCiUiLVgSFpBGf72KnH2IJL0hixfeCqWN5YVtHQrt
 SdgLYAR/2gUatULSS4bM+yRXRMQt1cAeoMGDxKOYjWN4FK+5VSLIh89ce
 h62L2U/mjaJlFk116Mie7acmQJLi56chMbtUM2DrireiGib2ZWHWPnvs2
 3Js7MaqdP9zSjLjwP4GgXWgUzm/s1Yil/v96FeskPSXmZ+Cz0WZDVeFTE g==;
X-IronPort-AV: E=McAfee;i="6500,9779,10496"; a="306038651"
X-IronPort-AV: E=Sophos;i="5.95,175,1661842800"; d="scan'208";a="306038651"
Received: from orsmga006.jf.intel.com ([10.7.209.51])
 by orsmga103.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 10 Oct 2022 22:53:32 -0700
X-IronPort-AV: E=McAfee;i="6500,9779,10496"; a="604011144"
X-IronPort-AV: E=Sophos;i="5.95,175,1661842800"; d="scan'208";a="604011144"
Received: from adixit-mobl.amr.corp.intel.com (HELO adixit-arch.intel.com)
 ([10.212.187.14])
 by orsmga006-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 10 Oct 2022 22:53:31 -0700
Date: Mon, 10 Oct 2022 22:53:31 -0700
Message-ID: <87pmey29es.wl-ashutosh.dixit@intel.com>
From: "Dixit, Ashutosh" <ashutosh.dixit@intel.com>
To: intel-gfx@lists.freedesktop.org
In-Reply-To: <da81208882ba7fb24a8051c5edfbf6a735127f88.1665458640.git.ashutosh.dixit@intel.com>
References: <cover.1665458639.git.ashutosh.dixit@intel.com>	<da81208882ba7fb24a8051c5edfbf6a735127f88.1665458640.git.ashutosh.dixit@intel.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?ISO-8859-4?Q?Goj=F2?=) APEL-LB/10.8 EasyPG/1.0.0
 Emacs/28.1 (x86_64-pc-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
Subject: Re: [Intel-gfx] [PATCH 2/2] drm/i915/gt: Warn if not in RC6 when GT
 is parked
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

On Mon, 10 Oct 2022 20:29:23 -0700, Ashutosh Dixit wrote:
>
> Some i915 modules implicitly assume that there is no user, kernel or
> firmware activity after GT is parked. For example, PMU calculations are
> incorrect if GT is not in RC6 when GT is parked (outside of the GT
> wakeref). Therefore check and warn if GT is not in RC6 at the time of
> parking the GT.

This patch has cause widespread dmesg_warn's in premerge CI so there is no
intention of merging this. It just proves that these assumptions in PMU
(for quantities such as frequency and RC6 residency) are incorrect and need
to be addressed.

Thanks.
--
Ashutosh


> @@ -123,6 +125,10 @@ static int __gt_park(struct intel_wakeref *wf)
>		intel_display_power_put_async(i915, POWER_DOMAIN_GT_IRQ, wakeref);
>	}
>
> +	ret = intel_rc6_in_rc6(&gt->rc6, &in_rc6);
> +	if (!ret && !in_rc6)
> +		drm_warn_once(&i915->drm, "Parking, but GT is not in RC6!\n");
> +
>	return 0;
>  }

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 5F74145564
	for <lists+intel-gfx@lfdr.de>; Fri, 14 Jun 2019 09:11:12 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id ED40F892BF;
	Fri, 14 Jun 2019 07:10:59 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 88BC6892BF
 for <intel-gfx@lists.freedesktop.org>; Fri, 14 Jun 2019 07:10:42 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 16897539-1500050 
 for multiple; Fri, 14 Jun 2019 08:10:41 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Fri, 14 Jun 2019 08:10:12 +0100
Message-Id: <20190614071023.17929-29-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190614071023.17929-1-chris@chris-wilson.co.uk>
References: <20190614071023.17929-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 28/39] initial-plane-vma
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

LS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fc3RvbGVuLmMgfCAgODggKysr
LS0tLS0tLS0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYuaCAgICAgICAgICAgIHwg
ICAxIC0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2ludGVsX2Rpc3BsYXkuYyAgICAgICB8IDE0NiAr
KysrKysrKysrKysrLS0tLS0tLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2ludGVsX2Rydi5oICAg
ICAgICAgICB8ICAgMSArCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pbnRlbF9wbS5jICAgICAgICAg
ICAgfCAgIDEgLQogNSBmaWxlcyBjaGFuZ2VkLCAxMDkgaW5zZXJ0aW9ucygrKSwgMTI4IGRlbGV0
aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9z
dG9sZW4uYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9zdG9sZW4uYwppbmRl
eCBlOGJjOWI0NmQ0ZTguLjcwNjYwNDRkNjNjZiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJt
L2k5MTUvZ2VtL2k5MTVfZ2VtX3N0b2xlbi5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dl
bS9pOTE1X2dlbV9zdG9sZW4uYwpAQCAtNjA0LDI5ICs2MDQsMjQgQEAgaTkxNV9nZW1fb2JqZWN0
X2NyZWF0ZV9zdG9sZW4oc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2LAogfQogCiBz
dHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqCi1pOTE1X2dlbV9vYmplY3RfY3JlYXRlX3N0b2xl
bl9mb3JfcHJlYWxsb2NhdGVkKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiwKK2k5
MTVfZ2VtX29iamVjdF9jcmVhdGVfc3RvbGVuX2Zvcl9wcmVhbGxvY2F0ZWQoc3RydWN0IGRybV9p
OTE1X3ByaXZhdGUgKmk5MTUsCiAJCQkJCSAgICAgICByZXNvdXJjZV9zaXplX3Qgc3RvbGVuX29m
ZnNldCwKLQkJCQkJICAgICAgIHJlc291cmNlX3NpemVfdCBndHRfb2Zmc2V0LAogCQkJCQkgICAg
ICAgcmVzb3VyY2Vfc2l6ZV90IHNpemUpCiB7Ci0Jc3RydWN0IGk5MTVfZ2d0dCAqZ2d0dCA9ICZk
ZXZfcHJpdi0+Z2d0dDsKIAlzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqOwogCXN0cnVj
dCBkcm1fbW1fbm9kZSAqc3RvbGVuOwotCXN0cnVjdCBpOTE1X3ZtYSAqdm1hOwogCWludCByZXQ7
CiAKLQlpZiAoIWRybV9tbV9pbml0aWFsaXplZCgmZGV2X3ByaXYtPm1tLnN0b2xlbikpCisJaWYg
KCFkcm1fbW1faW5pdGlhbGl6ZWQoJmk5MTUtPm1tLnN0b2xlbikpCiAJCXJldHVybiBOVUxMOwog
Ci0JbG9ja2RlcF9hc3NlcnRfaGVsZCgmZGV2X3ByaXYtPmRybS5zdHJ1Y3RfbXV0ZXgpOwotCi0J
RFJNX0RFQlVHX0RSSVZFUigiY3JlYXRpbmcgcHJlYWxsb2NhdGVkIHN0b2xlbiBvYmplY3Q6IHN0
b2xlbl9vZmZzZXQ9JXBhLCBndHRfb2Zmc2V0PSVwYSwgc2l6ZT0lcGFcbiIsCi0JCQkgJnN0b2xl
bl9vZmZzZXQsICZndHRfb2Zmc2V0LCAmc2l6ZSk7CisJRFJNX0RFQlVHX0RSSVZFUigiY3JlYXRp
bmcgcHJlYWxsb2NhdGVkIHN0b2xlbiBvYmplY3Q6IHN0b2xlbl9vZmZzZXQ9JXBhLCBzaXplPSVw
YVxuIiwKKwkJCSAmc3RvbGVuX29mZnNldCwgJnNpemUpOwogCiAJLyogS0lTUyBhbmQgZXhwZWN0
IGV2ZXJ5dGhpbmcgdG8gYmUgcGFnZS1hbGlnbmVkICovCi0JaWYgKFdBUk5fT04oc2l6ZSA9PSAw
KSB8fAotCSAgICBXQVJOX09OKCFJU19BTElHTkVEKHNpemUsIEk5MTVfR1RUX1BBR0VfU0laRSkp
IHx8Ci0JICAgIFdBUk5fT04oIUlTX0FMSUdORUQoc3RvbGVuX29mZnNldCwgSTkxNV9HVFRfTUlO
X0FMSUdOTUVOVCkpKQorCWlmIChHRU1fV0FSTl9PTihzaXplID09IDApIHx8CisJICAgIEdFTV9X
QVJOX09OKCFJU19BTElHTkVEKHNpemUsIEk5MTVfR1RUX1BBR0VfU0laRSkpIHx8CisJICAgIEdF
TV9XQVJOX09OKCFJU19BTElHTkVEKHN0b2xlbl9vZmZzZXQsIEk5MTVfR1RUX01JTl9BTElHTk1F
TlQpKSkKIAkJcmV0dXJuIE5VTEw7CiAKIAlzdG9sZW4gPSBremFsbG9jKHNpemVvZigqc3RvbGVu
KSwgR0ZQX0tFUk5FTCk7CkBAIC02MzUsNjggKzYzMCwyMSBAQCBpOTE1X2dlbV9vYmplY3RfY3Jl
YXRlX3N0b2xlbl9mb3JfcHJlYWxsb2NhdGVkKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZf
cHJpdgogCiAJc3RvbGVuLT5zdGFydCA9IHN0b2xlbl9vZmZzZXQ7CiAJc3RvbGVuLT5zaXplID0g
c2l6ZTsKLQltdXRleF9sb2NrKCZkZXZfcHJpdi0+bW0uc3RvbGVuX2xvY2spOwotCXJldCA9IGRy
bV9tbV9yZXNlcnZlX25vZGUoJmRldl9wcml2LT5tbS5zdG9sZW4sIHN0b2xlbik7Ci0JbXV0ZXhf
dW5sb2NrKCZkZXZfcHJpdi0+bW0uc3RvbGVuX2xvY2spOwotCWlmIChyZXQpIHsKLQkJRFJNX0RF
QlVHX0RSSVZFUigiZmFpbGVkIHRvIGFsbG9jYXRlIHN0b2xlbiBzcGFjZVxuIik7Ci0JCWtmcmVl
KHN0b2xlbik7Ci0JCXJldHVybiBOVUxMOwotCX0KLQotCW9iaiA9IF9pOTE1X2dlbV9vYmplY3Rf
Y3JlYXRlX3N0b2xlbihkZXZfcHJpdiwgc3RvbGVuKTsKLQlpZiAob2JqID09IE5VTEwpIHsKLQkJ
RFJNX0RFQlVHX0RSSVZFUigiZmFpbGVkIHRvIGFsbG9jYXRlIHN0b2xlbiBvYmplY3RcbiIpOwot
CQlpOTE1X2dlbV9zdG9sZW5fcmVtb3ZlX25vZGUoZGV2X3ByaXYsIHN0b2xlbik7Ci0JCWtmcmVl
KHN0b2xlbik7Ci0JCXJldHVybiBOVUxMOwotCX0KLQotCS8qIFNvbWUgb2JqZWN0cyBqdXN0IG5l
ZWQgcGh5c2ljYWwgbWVtIGZyb20gc3RvbGVuIHNwYWNlICovCi0JaWYgKGd0dF9vZmZzZXQgPT0g
STkxNV9HVFRfT0ZGU0VUX05PTkUpCi0JCXJldHVybiBvYmo7Ci0KLQlyZXQgPSBpOTE1X2dlbV9v
YmplY3RfcGluX3BhZ2VzKG9iaik7CisJbXV0ZXhfbG9jaygmaTkxNS0+bW0uc3RvbGVuX2xvY2sp
OworCXJldCA9IGRybV9tbV9yZXNlcnZlX25vZGUoJmk5MTUtPm1tLnN0b2xlbiwgc3RvbGVuKTsK
KwltdXRleF91bmxvY2soJmk5MTUtPm1tLnN0b2xlbl9sb2NrKTsKIAlpZiAocmV0KQotCQlnb3Rv
IGVycjsKKwkJZ290byBlcnJfZnJlZTsKIAotCXZtYSA9IGk5MTVfdm1hX2luc3RhbmNlKG9iaiwg
JmdndHQtPnZtLCBOVUxMKTsKLQlpZiAoSVNfRVJSKHZtYSkpIHsKLQkJcmV0ID0gUFRSX0VSUih2
bWEpOwotCQlnb3RvIGVycl9wYWdlczsKLQl9Ci0KLQkvKiBUbyBzaW1wbGlmeSB0aGUgaW5pdGlh
bGlzYXRpb24gc2VxdWVuY2UgYmV0d2VlbiBLTVMgYW5kIEdUVCwKLQkgKiB3ZSBhbGxvdyBjb25z
dHJ1Y3Rpb24gb2YgdGhlIHN0b2xlbiBvYmplY3QgcHJpb3IgdG8KLQkgKiBzZXR0aW5nIHVwIHRo
ZSBHVFQgc3BhY2UuIFRoZSBhY3R1YWwgcmVzZXJ2YXRpb24gd2lsbCBvY2N1cgotCSAqIGxhdGVy
LgotCSAqLwotCXJldCA9IGk5MTVfZ2VtX2d0dF9yZXNlcnZlKCZnZ3R0LT52bSwgJnZtYS0+bm9k
ZSwKLQkJCQkgICBzaXplLCBndHRfb2Zmc2V0LCBvYmotPmNhY2hlX2xldmVsLAotCQkJCSAgIDAp
OwotCWlmIChyZXQpIHsKLQkJRFJNX0RFQlVHX0RSSVZFUigiZmFpbGVkIHRvIGFsbG9jYXRlIHN0
b2xlbiBHVFQgc3BhY2VcbiIpOwotCQlnb3RvIGVycl9wYWdlczsKLQl9Ci0KLQlHRU1fQlVHX09O
KCFkcm1fbW1fbm9kZV9hbGxvY2F0ZWQoJnZtYS0+bm9kZSkpOwotCi0Jdm1hLT5wYWdlcyA9IG9i
ai0+bW0ucGFnZXM7Ci0Jdm1hLT5mbGFncyB8PSBJOTE1X1ZNQV9HTE9CQUxfQklORDsKLQlfX2k5
MTVfdm1hX3NldF9tYXBfYW5kX2ZlbmNlYWJsZSh2bWEpOwotCi0JbXV0ZXhfbG9jaygmZ2d0dC0+
dm0ubXV0ZXgpOwotCWxpc3RfYWRkX3RhaWwoJnZtYS0+dm1fbGluaywgJmdndHQtPnZtLmJvdW5k
X2xpc3QpOwotCW11dGV4X3VubG9jaygmZ2d0dC0+dm0ubXV0ZXgpOwotCi0JR0VNX0JVR19PTihp
OTE1X2dlbV9vYmplY3RfaXNfc2hyaW5rYWJsZShvYmopKTsKLQlhdG9taWNfaW5jKCZvYmotPmJp
bmRfY291bnQpOworCW9iaiA9IF9pOTE1X2dlbV9vYmplY3RfY3JlYXRlX3N0b2xlbihpOTE1LCBz
dG9sZW4pOworCWlmICghb2JqKQorCQlnb3RvIGVycl9zdG9sZW47CiAKIAlyZXR1cm4gb2JqOwog
Ci1lcnJfcGFnZXM6Ci0JaTkxNV9nZW1fb2JqZWN0X3VucGluX3BhZ2VzKG9iaik7Ci1lcnI6Ci0J
aTkxNV9nZW1fb2JqZWN0X3B1dChvYmopOworZXJyX3N0b2xlbjoKKwlpOTE1X2dlbV9zdG9sZW5f
cmVtb3ZlX25vZGUoaTkxNSwgc3RvbGVuKTsKK2Vycl9mcmVlOgorCWtmcmVlKHN0b2xlbik7CiAJ
cmV0dXJuIE5VTEw7CiB9CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2Ry
di5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYuaAppbmRleCAzYzkzMTc1OTI3Mjku
LjlhMWVjNDg3ZThiMSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYu
aAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2Rydi5oCkBAIC0yNzAzLDcgKzI3MDMs
NiBAQCBpOTE1X2dlbV9vYmplY3RfY3JlYXRlX3N0b2xlbihzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0
ZSAqZGV2X3ByaXYsCiBzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqCiBpOTE1X2dlbV9vYmpl
Y3RfY3JlYXRlX3N0b2xlbl9mb3JfcHJlYWxsb2NhdGVkKHN0cnVjdCBkcm1faTkxNV9wcml2YXRl
ICpkZXZfcHJpdiwKIAkJCQkJICAgICAgIHJlc291cmNlX3NpemVfdCBzdG9sZW5fb2Zmc2V0LAot
CQkJCQkgICAgICAgcmVzb3VyY2Vfc2l6ZV90IGd0dF9vZmZzZXQsCiAJCQkJCSAgICAgICByZXNv
dXJjZV9zaXplX3Qgc2l6ZSk7CiAKIC8qIGk5MTVfZ2VtX2ludGVybmFsLmMgKi8KZGlmZiAtLWdp
dCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2ludGVsX2Rpc3BsYXkuYyBiL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2ludGVsX2Rpc3BsYXkuYwppbmRleCAwMzk1MzY2MjViYmYuLjc0ZmM2ZDY5NjU0MCAx
MDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfZGlzcGxheS5jCisrKyBiL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2ludGVsX2Rpc3BsYXkuYwpAQCAtMzA0MSw2ICszMDQxLDcxIEBA
IGludCBza2xfZm9ybWF0X3RvX2ZvdXJjYyhpbnQgZm9ybWF0LCBib29sIHJnYl9vcmRlciwgYm9v
bCBhbHBoYSkKIAl9CiB9CiAKK3N0YXRpYyBzdHJ1Y3QgaTkxNV92bWEgKgoraW5pdGlhbF9wbGFu
ZV92bWEoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUsCisJCSAgc3RydWN0IGludGVsX2lu
aXRpYWxfcGxhbmVfY29uZmlnICpwbGFuZV9jb25maWcpCit7CisJc3RydWN0IGRybV9pOTE1X2dl
bV9vYmplY3QgKm9iajsKKwlzdHJ1Y3QgaTkxNV92bWEgKnZtYTsKKwl1MzIgYmFzZSwgc2l6ZTsK
KwlpbnQgZXJyOworCisJaWYgKHBsYW5lX2NvbmZpZy0+c2l6ZSA9PSAwKQorCQlyZXR1cm4gTlVM
TDsKKworCWJhc2UgPSByb3VuZF9kb3duKHBsYW5lX2NvbmZpZy0+YmFzZSwgUEFHRV9TSVpFKTsK
KwlzaXplID0gcm91bmRfdXAocGxhbmVfY29uZmlnLT5iYXNlICsgcGxhbmVfY29uZmlnLT5zaXpl
LCBQQUdFX1NJWkUpOworCXNpemUgLT0gYmFzZTsKKworCS8qCisJICogSWYgdGhlIEZCIGlzIHRv
byBiaWcsIGp1c3QgZG9uJ3QgdXNlIGl0IHNpbmNlIGZiZGV2IGlzIG5vdCB2ZXJ5CisJICogaW1w
b3J0YW50IGFuZCB3ZSBzaG91bGQgcHJvYmFibHkgdXNlIHRoYXQgc3BhY2Ugd2l0aCBGQkMgb3Ig
b3RoZXIKKwkgKiBmZWF0dXJlcy4KKwkgKi8KKwlpZiAoc2l6ZSAqIDIgPiBpOTE1LT5zdG9sZW5f
dXNhYmxlX3NpemUpCisJCXJldHVybiBOVUxMOworCisJb2JqID0gaTkxNV9nZW1fb2JqZWN0X2Ny
ZWF0ZV9zdG9sZW5fZm9yX3ByZWFsbG9jYXRlZChpOTE1LCBiYXNlLCBzaXplKTsKKwlpZiAoIW9i
aikKKwkJcmV0dXJuIE5VTEw7CisKKwlzd2l0Y2ggKHBsYW5lX2NvbmZpZy0+dGlsaW5nKSB7CisJ
Y2FzZSBJOTE1X1RJTElOR19OT05FOgorCQlicmVhazsKKwljYXNlIEk5MTVfVElMSU5HX1g6CisJ
Y2FzZSBJOTE1X1RJTElOR19ZOgorCQlvYmotPnRpbGluZ19hbmRfc3RyaWRlID0KKwkJCXBsYW5l
X2NvbmZpZy0+ZmItPmJhc2UucGl0Y2hlc1swXSB8CisJCQlwbGFuZV9jb25maWctPnRpbGluZzsK
KwkJYnJlYWs7CisJZGVmYXVsdDoKKwkJTUlTU0lOR19DQVNFKHBsYW5lX2NvbmZpZy0+dGlsaW5n
KTsKKwkJZ290byBlcnJfb2JqOworCX0KKworCXZtYSA9IGk5MTVfdm1hX2luc3RhbmNlKG9iaiwg
Jmk5MTUtPmdndHQudm0sIE5VTEwpOworCWlmIChJU19FUlIodm1hKSkKKwkJZ290byBlcnJfb2Jq
OworCisJbXV0ZXhfbG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CisJZXJyID0gaTkxNV92
bWFfcGluKHZtYSwgMCwgMCwKKwkJCSAgIFBJTl9HTE9CQUwgfCBQSU5fTUFQUEFCTEUgfAorCQkJ
ICAgYmFzZSB8IFBJTl9PRkZTRVRfRklYRUQpOworCW11dGV4X3VubG9jaygmaTkxNS0+ZHJtLnN0
cnVjdF9tdXRleCk7CisJaWYgKGVycikKKwkJZ290byBlcnJfb2JqOworCisJaWYgKGk5MTVfZ2Vt
X29iamVjdF9pc190aWxlZChvYmopICYmCisJICAgICFpOTE1X3ZtYV9pc19tYXBfYW5kX2ZlbmNl
YWJsZSh2bWEpKQorCQlnb3RvIGVycl9vYmo7CisKKwlyZXR1cm4gdm1hOworCitlcnJfb2JqOgor
CWk5MTVfZ2VtX29iamVjdF9wdXQob2JqKTsKKwlyZXR1cm4gTlVMTDsKK30KKwogc3RhdGljIGJv
b2wKIGludGVsX2FsbG9jX2luaXRpYWxfcGxhbmVfb2JqKHN0cnVjdCBpbnRlbF9jcnRjICpjcnRj
LAogCQkJICAgICAgc3RydWN0IGludGVsX2luaXRpYWxfcGxhbmVfY29uZmlnICpwbGFuZV9jb25m
aWcpCkBAIC0zMDQ5LDIyICszMTE0LDcgQEAgaW50ZWxfYWxsb2NfaW5pdGlhbF9wbGFuZV9vYmoo
c3RydWN0IGludGVsX2NydGMgKmNydGMsCiAJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9w
cml2ID0gdG9faTkxNShkZXYpOwogCXN0cnVjdCBkcm1fbW9kZV9mYl9jbWQyIG1vZGVfY21kID0g
eyAwIH07CiAJc3RydWN0IGRybV9mcmFtZWJ1ZmZlciAqZmIgPSAmcGxhbmVfY29uZmlnLT5mYi0+
YmFzZTsKLQl1MzIgYmFzZV9hbGlnbmVkID0gcm91bmRfZG93bihwbGFuZV9jb25maWctPmJhc2Us
IFBBR0VfU0laRSk7Ci0JdTMyIHNpemVfYWxpZ25lZCA9IHJvdW5kX3VwKHBsYW5lX2NvbmZpZy0+
YmFzZSArIHBsYW5lX2NvbmZpZy0+c2l6ZSwKLQkJCQkgICAgUEFHRV9TSVpFKTsKLQlzdHJ1Y3Qg
ZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqOwotCWJvb2wgcmV0ID0gZmFsc2U7Ci0KLQlzaXplX2Fs
aWduZWQgLT0gYmFzZV9hbGlnbmVkOwotCi0JaWYgKHBsYW5lX2NvbmZpZy0+c2l6ZSA9PSAwKQot
CQlyZXR1cm4gZmFsc2U7Ci0KLQkvKiBJZiB0aGUgRkIgaXMgdG9vIGJpZywganVzdCBkb24ndCB1
c2UgaXQgc2luY2UgZmJkZXYgaXMgbm90IHZlcnkKLQkgKiBpbXBvcnRhbnQgYW5kIHdlIHNob3Vs
ZCBwcm9iYWJseSB1c2UgdGhhdCBzcGFjZSB3aXRoIEZCQyBvciBvdGhlcgotCSAqIGZlYXR1cmVz
LiAqLwotCWlmIChzaXplX2FsaWduZWQgKiAyID4gZGV2X3ByaXYtPnN0b2xlbl91c2FibGVfc2l6
ZSkKLQkJcmV0dXJuIGZhbHNlOworCXN0cnVjdCBpOTE1X3ZtYSAqdm1hOwogCiAJc3dpdGNoIChm
Yi0+bW9kaWZpZXIpIHsKIAljYXNlIERSTV9GT1JNQVRfTU9EX0xJTkVBUjoKQEAgLTMwNzcsMjcg
KzMxMjcsMTAgQEAgaW50ZWxfYWxsb2NfaW5pdGlhbF9wbGFuZV9vYmooc3RydWN0IGludGVsX2Ny
dGMgKmNydGMsCiAJCXJldHVybiBmYWxzZTsKIAl9CiAKLQltdXRleF9sb2NrKCZkZXYtPnN0cnVj
dF9tdXRleCk7Ci0Jb2JqID0gaTkxNV9nZW1fb2JqZWN0X2NyZWF0ZV9zdG9sZW5fZm9yX3ByZWFs
bG9jYXRlZChkZXZfcHJpdiwKLQkJCQkJCQkgICAgIGJhc2VfYWxpZ25lZCwKLQkJCQkJCQkgICAg
IGJhc2VfYWxpZ25lZCwKLQkJCQkJCQkgICAgIHNpemVfYWxpZ25lZCk7Ci0JbXV0ZXhfdW5sb2Nr
KCZkZXYtPnN0cnVjdF9tdXRleCk7Ci0JaWYgKCFvYmopCisJdm1hID0gaW5pdGlhbF9wbGFuZV92
bWEoZGV2X3ByaXYsIHBsYW5lX2NvbmZpZyk7CisJaWYgKCF2bWEpCiAJCXJldHVybiBmYWxzZTsK
IAotCXN3aXRjaCAocGxhbmVfY29uZmlnLT50aWxpbmcpIHsKLQljYXNlIEk5MTVfVElMSU5HX05P
TkU6Ci0JCWJyZWFrOwotCWNhc2UgSTkxNV9USUxJTkdfWDoKLQljYXNlIEk5MTVfVElMSU5HX1k6
Ci0JCW9iai0+dGlsaW5nX2FuZF9zdHJpZGUgPSBmYi0+cGl0Y2hlc1swXSB8IHBsYW5lX2NvbmZp
Zy0+dGlsaW5nOwotCQlicmVhazsKLQlkZWZhdWx0OgotCQlNSVNTSU5HX0NBU0UocGxhbmVfY29u
ZmlnLT50aWxpbmcpOwotCQlnb3RvIG91dDsKLQl9Ci0KIAltb2RlX2NtZC5waXhlbF9mb3JtYXQg
PSBmYi0+Zm9ybWF0LT5mb3JtYXQ7CiAJbW9kZV9jbWQud2lkdGggPSBmYi0+d2lkdGg7CiAJbW9k
ZV9jbWQuaGVpZ2h0ID0gZmItPmhlaWdodDsKQEAgLTMxMDUsMTcgKzMxMzgsMTggQEAgaW50ZWxf
YWxsb2NfaW5pdGlhbF9wbGFuZV9vYmooc3RydWN0IGludGVsX2NydGMgKmNydGMsCiAJbW9kZV9j
bWQubW9kaWZpZXJbMF0gPSBmYi0+bW9kaWZpZXI7CiAJbW9kZV9jbWQuZmxhZ3MgPSBEUk1fTU9E
RV9GQl9NT0RJRklFUlM7CiAKLQlpZiAoaW50ZWxfZnJhbWVidWZmZXJfaW5pdCh0b19pbnRlbF9m
cmFtZWJ1ZmZlcihmYiksIG9iaiwgJm1vZGVfY21kKSkgeworCWlmIChpbnRlbF9mcmFtZWJ1ZmZl
cl9pbml0KHRvX2ludGVsX2ZyYW1lYnVmZmVyKGZiKSwKKwkJCQkgICB2bWEtPm9iaiwgJm1vZGVf
Y21kKSkgewogCQlEUk1fREVCVUdfS01TKCJpbnRlbCBmYiBpbml0IGZhaWxlZFxuIik7Ci0JCWdv
dG8gb3V0OworCQlnb3RvIGVycl92bWE7CiAJfQogCisJcGxhbmVfY29uZmlnLT52bWEgPSB2bWE7
CisJcmV0dXJuIHRydWU7CiAKLQlEUk1fREVCVUdfS01TKCJpbml0aWFsIHBsYW5lIGZiIG9iaiAl
cFxuIiwgb2JqKTsKLQlyZXQgPSB0cnVlOwotb3V0OgotCWk5MTVfZ2VtX29iamVjdF9wdXQob2Jq
KTsKLQlyZXR1cm4gcmV0OworZXJyX3ZtYToKKwlpOTE1X3ZtYV9wdXQodm1hKTsKKwlyZXR1cm4g
ZmFsc2U7CiB9CiAKIHN0YXRpYyB2b2lkCkBAIC0zMTkxLDEyICszMjI1LDE0IEBAIGludGVsX2Zp
bmRfaW5pdGlhbF9wbGFuZV9vYmooc3RydWN0IGludGVsX2NydGMgKmludGVsX2NydGMsCiAJc3Ry
dWN0IGludGVsX3BsYW5lX3N0YXRlICppbnRlbF9zdGF0ZSA9CiAJCXRvX2ludGVsX3BsYW5lX3N0
YXRlKHBsYW5lX3N0YXRlKTsKIAlzdHJ1Y3QgZHJtX2ZyYW1lYnVmZmVyICpmYjsKKwlzdHJ1Y3Qg
aTkxNV92bWEgKnZtYTsKIAogCWlmICghcGxhbmVfY29uZmlnLT5mYikKIAkJcmV0dXJuOwogCiAJ
aWYgKGludGVsX2FsbG9jX2luaXRpYWxfcGxhbmVfb2JqKGludGVsX2NydGMsIHBsYW5lX2NvbmZp
ZykpIHsKIAkJZmIgPSAmcGxhbmVfY29uZmlnLT5mYi0+YmFzZTsKKwkJdm1hID0gcGxhbmVfY29u
ZmlnLT52bWE7CiAJCWdvdG8gdmFsaWRfZmI7CiAJfQogCkBAIC0zMjE5LDYgKzMyNTUsNyBAQCBp
bnRlbF9maW5kX2luaXRpYWxfcGxhbmVfb2JqKHN0cnVjdCBpbnRlbF9jcnRjICppbnRlbF9jcnRj
LAogCiAJCWlmIChpbnRlbF9wbGFuZV9nZ3R0X29mZnNldChzdGF0ZSkgPT0gcGxhbmVfY29uZmln
LT5iYXNlKSB7CiAJCQlmYiA9IHN0YXRlLT5iYXNlLmZiOworCQkJdm1hID0gc3RhdGUtPnZtYTsK
IAkJCWdvdG8gdmFsaWRfZmI7CiAJCX0KIAl9CkBAIC0zMjQyLDIxICszMjc5LDEzIEBAIGludGVs
X2ZpbmRfaW5pdGlhbF9wbGFuZV9vYmooc3RydWN0IGludGVsX2NydGMgKmludGVsX2NydGMsCiAJ
CWludGVsX2ZiX3BpdGNoKGZiLCAwLCBpbnRlbF9zdGF0ZS0+YmFzZS5yb3RhdGlvbik7CiAKIAlt
dXRleF9sb2NrKCZkZXYtPnN0cnVjdF9tdXRleCk7Ci0JaW50ZWxfc3RhdGUtPnZtYSA9Ci0JCWlu
dGVsX3Bpbl9hbmRfZmVuY2VfZmJfb2JqKGZiLAotCQkJCQkgICAmaW50ZWxfc3RhdGUtPnZpZXcs
Ci0JCQkJCSAgIGludGVsX3BsYW5lX3VzZXNfZmVuY2UoaW50ZWxfc3RhdGUpLAotCQkJCQkgICAm
aW50ZWxfc3RhdGUtPmZsYWdzKTsKKwlpbnRlbF9zdGF0ZS0+dm1hID0gaTkxNV92bWFfZ2V0KHBs
YW5lX2NvbmZpZy0+dm1hKTsKKwlfX2k5MTVfdm1hX3BpbihpbnRlbF9zdGF0ZS0+dm1hKTsKKwlp
ZiAoaW50ZWxfcGxhbmVfdXNlc19mZW5jZShpbnRlbF9zdGF0ZSkgJiYKKwkgICAgaTkxNV92bWFf
cGluX2ZlbmNlKGludGVsX3N0YXRlLT52bWEpID09IDApCisJCWludGVsX3N0YXRlLT5mbGFncyB8
PSBQTEFORV9IQVNfRkVOQ0U7CisJdm1hLT5vYmotPnBpbl9nbG9iYWwrKzsKIAltdXRleF91bmxv
Y2soJmRldi0+c3RydWN0X211dGV4KTsKLQlpZiAoSVNfRVJSKGludGVsX3N0YXRlLT52bWEpKSB7
Ci0JCURSTV9FUlJPUigiZmFpbGVkIHRvIHBpbiBib290IGZiIG9uIHBpcGUgJWQ6ICVsaVxuIiwK
LQkJCSAgaW50ZWxfY3J0Yy0+cGlwZSwgUFRSX0VSUihpbnRlbF9zdGF0ZS0+dm1hKSk7Ci0KLQkJ
aW50ZWxfc3RhdGUtPnZtYSA9IE5VTEw7Ci0JCXJldHVybjsKLQl9Ci0KLQlpbnRlbF9mcm9udGJ1
ZmZlcl9mbHVzaCh0b19pbnRlbF9mcm9udGJ1ZmZlcihmYiksIE9SSUdJTl9ESVJUWUZCKTsKIAog
CXBsYW5lX3N0YXRlLT5zcmNfeCA9IDA7CiAJcGxhbmVfc3RhdGUtPnNyY195ID0gMDsKQEAgLTMy
NzgsNiArMzMwNyw4IEBAIGludGVsX2ZpbmRfaW5pdGlhbF9wbGFuZV9vYmooc3RydWN0IGludGVs
X2NydGMgKmludGVsX2NydGMsCiAJcGxhbmVfc3RhdGUtPmZiID0gZmI7CiAJZHJtX2ZyYW1lYnVm
ZmVyX2dldChmYik7CiAKKwlpbnRlbF9mcm9udGJ1ZmZlcl9mbHVzaCh0b19pbnRlbF9mcm9udGJ1
ZmZlcihmYiksIE9SSUdJTl9ESVJUWUZCKTsKKwogCWF0b21pY19vcih0b19pbnRlbF9wbGFuZShw
cmltYXJ5KS0+ZnJvbnRidWZmZXJfYml0LAogCQkgICZ0b19pbnRlbF9mcm9udGJ1ZmZlcihmYikt
PmJpdHMpOwogfQpAQCAtMTU5MTgsNiArMTU5NDksOSBAQCBzdGF0aWMgdm9pZCBwbGFuZV9jb25m
aWdfZmluaShzdHJ1Y3QgaW50ZWxfaW5pdGlhbF9wbGFuZV9jb25maWcgKnBsYW5lX2NvbmZpZykK
IAkJZWxzZQogCQkJa2ZyZWUoZmIpOwogCX0KKworCWlmIChwbGFuZV9jb25maWctPnZtYSkKKwkJ
aTkxNV92bWFfcHV0KHBsYW5lX2NvbmZpZy0+dm1hKTsKIH0KIAogaW50IGludGVsX21vZGVzZXRf
aW5pdChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2KQpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJt
L2k5MTUvaW50ZWxfZHJ2LmggYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pbnRlbF9kcnYuaAppbmRl
eCBhNTI1M2ZkODM4YmMuLjNhMTE5ZDAxMDViNSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJt
L2k5MTUvaW50ZWxfZHJ2LmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfZHJ2LmgK
QEAgLTU0OCw2ICs1NDgsNyBAQCBzdHJ1Y3QgaW50ZWxfcGxhbmVfc3RhdGUgewogCiBzdHJ1Y3Qg
aW50ZWxfaW5pdGlhbF9wbGFuZV9jb25maWcgewogCXN0cnVjdCBpbnRlbF9mcmFtZWJ1ZmZlciAq
ZmI7CisJc3RydWN0IGk5MTVfdm1hICp2bWE7CiAJdW5zaWduZWQgaW50IHRpbGluZzsKIAlpbnQg
c2l6ZTsKIAl1MzIgYmFzZTsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2ludGVs
X3BtLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pbnRlbF9wbS5jCmluZGV4IDJjN2YzZWJjMDEx
Ny4uNjI0MTY3OThkNWZlIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pbnRlbF9w
bS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2ludGVsX3BtLmMKQEAgLTc3MjIsNyArNzcy
Miw2IEBAIHN0YXRpYyB2b2lkIHZhbGxleXZpZXdfc2V0dXBfcGN0eChzdHJ1Y3QgZHJtX2k5MTVf
cHJpdmF0ZSAqZGV2X3ByaXYpCiAJCXBjYnJfb2Zmc2V0ID0gKHBjYnIgJiAofjQwOTUpKSAtIGRl
dl9wcml2LT5kc20uc3RhcnQ7CiAJCXBjdHggPSBpOTE1X2dlbV9vYmplY3RfY3JlYXRlX3N0b2xl
bl9mb3JfcHJlYWxsb2NhdGVkKGRldl9wcml2LAogCQkJCQkJCQkgICAgICBwY2JyX29mZnNldCwK
LQkJCQkJCQkJICAgICAgSTkxNV9HVFRfT0ZGU0VUX05PTkUsCiAJCQkJCQkJCSAgICAgIHBjdHhf
c2l6ZSk7CiAJCWdvdG8gb3V0OwogCX0KLS0gCjIuMjAuMQoKX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1n
ZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21h
aWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

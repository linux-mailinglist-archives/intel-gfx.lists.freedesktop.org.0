Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id B369C4555E
	for <lists+intel-gfx@lfdr.de>; Fri, 14 Jun 2019 09:11:07 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 0DB568938F;
	Fri, 14 Jun 2019 07:10:58 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 3174389338
 for <intel-gfx@lists.freedesktop.org>; Fri, 14 Jun 2019 07:10:44 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 16897542-1500050 
 for multiple; Fri, 14 Jun 2019 08:10:41 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Fri, 14 Jun 2019 08:10:15 +0100
Message-Id: <20190614071023.17929-32-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190614071023.17929-1-chris@chris-wilson.co.uk>
References: <20190614071023.17929-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 31/39] drm/i915: Allow page pinning to be in the
 background
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Matthew Auld <matthew.auld@intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

QXNzdW1lIHRoYXQgcGFnZXMgbWF5IGJlIHBpbm5lZCBpbiBhIGJhY2tncm91bmQgdGFzayBhbmQg
dXNlIGEKY29tcGxldGlvbiBldmVudCB0byBzeW5jaHJvbmlzZSB3aXRoIGNhbGxlcnMgdGhhdCBt
dXN0IGFjY2VzcyB0aGUgcGFnZXMKaW1tZWRpYXRlbHkuCgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBX
aWxzb24gPGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KUmV2aWV3ZWQtYnk6IE1hdHRoZXcgQXVs
ZCA8bWF0dGhldy5hdWxkQGludGVsLmNvbT4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0v
aTkxNV9nZW1fb2JqZWN0LmMgICAgfCAgMSArCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkx
NV9nZW1fb2JqZWN0LmggICAgfCAgNyArLS0KIC4uLi9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2Vt
X29iamVjdF90eXBlcy5oICB8ICAzICsrCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9n
ZW1fcGFnZXMuYyAgICAgfCA1MyArKysrKysrKysrKysrKystLS0tCiA0IGZpbGVzIGNoYW5nZWQs
IDUyIGluc2VydGlvbnMoKyksIDEyIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9vYmplY3QuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2dlbS9pOTE1X2dlbV9vYmplY3QuYwppbmRleCAxYWQ1M2NkZGQ0MjUuLjU4OGUwY2EyODVlMSAx
MDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX29iamVjdC5jCisr
KyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9vYmplY3QuYwpAQCAtNjUsNiAr
NjUsNyBAQCB2b2lkIGk5MTVfZ2VtX29iamVjdF9pbml0KHN0cnVjdCBkcm1faTkxNV9nZW1fb2Jq
ZWN0ICpvYmosCiAJb2JqLT5tbS5tYWR2ID0gSTkxNV9NQURWX1dJTExORUVEOwogCUlOSVRfUkFE
SVhfVFJFRSgmb2JqLT5tbS5nZXRfcGFnZS5yYWRpeCwgR0ZQX0tFUk5FTCB8IF9fR0ZQX05PV0FS
Tik7CiAJbXV0ZXhfaW5pdCgmb2JqLT5tbS5nZXRfcGFnZS5sb2NrKTsKKwlpbml0X2NvbXBsZXRp
b24oJm9iai0+bW0uY29tcGxldGlvbik7CiB9CiAKIC8qKgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9n
cHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX29iamVjdC5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUv
Z2VtL2k5MTVfZ2VtX29iamVjdC5oCmluZGV4IDY3ZDcwZDE0NGJkOS4uN2VhODAxM2QxMDhmIDEw
MDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fb2JqZWN0LmgKKysr
IGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX29iamVjdC5oCkBAIC0yMzQsNyAr
MjM0LDcgQEAgaW50IF9fX19pOTE1X2dlbV9vYmplY3RfZ2V0X3BhZ2VzKHN0cnVjdCBkcm1faTkx
NV9nZW1fb2JqZWN0ICpvYmopOwogaW50IF9faTkxNV9nZW1fb2JqZWN0X2dldF9wYWdlcyhzdHJ1
Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqKTsKIAogc3RhdGljIGlubGluZSBpbnQgX19tdXN0
X2NoZWNrCi1pOTE1X2dlbV9vYmplY3RfcGluX3BhZ2VzKHN0cnVjdCBkcm1faTkxNV9nZW1fb2Jq
ZWN0ICpvYmopCitpOTE1X2dlbV9vYmplY3RfcGluX3BhZ2VzX2FzeW5jKHN0cnVjdCBkcm1faTkx
NV9nZW1fb2JqZWN0ICpvYmopCiB7CiAJbWlnaHRfbG9jaygmb2JqLT5tbS5sb2NrKTsKIApAQCAt
MjQ0LDYgKzI0NCw5IEBAIGk5MTVfZ2VtX29iamVjdF9waW5fcGFnZXMoc3RydWN0IGRybV9pOTE1
X2dlbV9vYmplY3QgKm9iaikKIAlyZXR1cm4gX19pOTE1X2dlbV9vYmplY3RfZ2V0X3BhZ2VzKG9i
aik7CiB9CiAKK2ludCBfX211c3RfY2hlY2sKK2k5MTVfZ2VtX29iamVjdF9waW5fcGFnZXMoc3Ry
dWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaik7CisKIHN0YXRpYyBpbmxpbmUgYm9vbAogaTkx
NV9nZW1fb2JqZWN0X2hhc19wYWdlcyhzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqKQog
ewpAQCAtMjY3LDkgKzI3MCw3IEBAIGk5MTVfZ2VtX29iamVjdF9oYXNfcGlubmVkX3BhZ2VzKHN0
cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmopCiBzdGF0aWMgaW5saW5lIHZvaWQKIF9faTkx
NV9nZW1fb2JqZWN0X3VucGluX3BhZ2VzKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmop
CiB7Ci0JR0VNX0JVR19PTighaTkxNV9nZW1fb2JqZWN0X2hhc19wYWdlcyhvYmopKTsKIAlHRU1f
QlVHX09OKCFpOTE1X2dlbV9vYmplY3RfaGFzX3Bpbm5lZF9wYWdlcyhvYmopKTsKLQogCWF0b21p
Y19kZWMoJm9iai0+bW0ucGFnZXNfcGluX2NvdW50KTsKIH0KIApkaWZmIC0tZ2l0IGEvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX29iamVjdF90eXBlcy5oIGIvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX29iamVjdF90eXBlcy5oCmluZGV4IGU4N2ZjYTRkODE5NC4u
OGY2MWQ3YTkzMDc4IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9n
ZW1fb2JqZWN0X3R5cGVzLmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2Vt
X29iamVjdF90eXBlcy5oCkBAIC03LDYgKzcsNyBAQAogI2lmbmRlZiBfX0k5MTVfR0VNX09CSkVD
VF9UWVBFU19IX18KICNkZWZpbmUgX19JOTE1X0dFTV9PQkpFQ1RfVFlQRVNfSF9fCiAKKyNpbmNs
dWRlIDxsaW51eC9jb21wbGV0aW9uLmg+CiAjaW5jbHVkZSA8bGludXgvcmVzZXJ2YXRpb24uaD4K
IAogI2luY2x1ZGUgPGRybS9kcm1fZ2VtLmg+CkBAIC0yMTAsNiArMjExLDggQEAgc3RydWN0IGRy
bV9pOTE1X2dlbV9vYmplY3QgewogCQkgKi8KIAkJc3RydWN0IGxpc3RfaGVhZCBsaW5rOwogCisJ
CXN0cnVjdCBjb21wbGV0aW9uIGNvbXBsZXRpb247CisKIAkJLyoqCiAJCSAqIEFkdmljZTogYXJl
IHRoZSBiYWNraW5nIHBhZ2VzIHB1cmdlYWJsZT8KIAkJICovCmRpZmYgLS1naXQgYS9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fcGFnZXMuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2dlbS9pOTE1X2dlbV9wYWdlcy5jCmluZGV4IGIzNmFkMjY5ZjRlYS4uNmJlYzMwMWNlZTc5IDEw
MDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fcGFnZXMuYworKysg
Yi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fcGFnZXMuYwpAQCAtNzMsMjEgKzcz
LDE4IEBAIHZvaWQgX19pOTE1X2dlbV9vYmplY3Rfc2V0X3BhZ2VzKHN0cnVjdCBkcm1faTkxNV9n
ZW1fb2JqZWN0ICpvYmosCiAKIAkJc3Bpbl91bmxvY2tfaXJxcmVzdG9yZSgmaTkxNS0+bW0ub2Jq
X2xvY2ssIGZsYWdzKTsKIAl9CisKKwljb21wbGV0ZV9hbGwoJm9iai0+bW0uY29tcGxldGlvbik7
CiB9CiAKIGludCBfX19faTkxNV9nZW1fb2JqZWN0X2dldF9wYWdlcyhzdHJ1Y3QgZHJtX2k5MTVf
Z2VtX29iamVjdCAqb2JqKQogewotCWludCBlcnI7Ci0KIAlpZiAodW5saWtlbHkob2JqLT5tbS5t
YWR2ICE9IEk5MTVfTUFEVl9XSUxMTkVFRCkpIHsKIAkJRFJNX0RFQlVHKCJBdHRlbXB0aW5nIHRv
IG9idGFpbiBhIHB1cmdlYWJsZSBvYmplY3RcbiIpOwogCQlyZXR1cm4gLUVGQVVMVDsKIAl9CiAK
LQllcnIgPSBvYmotPm9wcy0+Z2V0X3BhZ2VzKG9iaik7Ci0JR0VNX0JVR19PTighZXJyICYmICFp
OTE1X2dlbV9vYmplY3RfaGFzX3BhZ2VzKG9iaikpOwotCi0JcmV0dXJuIGVycjsKKwlyZXR1cm4g
b2JqLT5vcHMtPmdldF9wYWdlcyhvYmopOwogfQogCiAvKiBFbnN1cmUgdGhhdCB0aGUgYXNzb2Np
YXRlZCBwYWdlcyBhcmUgZ2F0aGVyZWQgZnJvbSB0aGUgYmFja2luZyBzdG9yYWdlCkBAIC0xMDUs
NyArMTAyLDcgQEAgaW50IF9faTkxNV9nZW1fb2JqZWN0X2dldF9wYWdlcyhzdHJ1Y3QgZHJtX2k5
MTVfZ2VtX29iamVjdCAqb2JqKQogCWlmIChlcnIpCiAJCXJldHVybiBlcnI7CiAKLQlpZiAodW5s
aWtlbHkoIWk5MTVfZ2VtX29iamVjdF9oYXNfcGFnZXMob2JqKSkpIHsKKwlpZiAoIW9iai0+bW0u
cGFnZXMpIHsKIAkJR0VNX0JVR19PTihpOTE1X2dlbV9vYmplY3RfaGFzX3Bpbm5lZF9wYWdlcyhv
YmopKTsKIAogCQllcnIgPSBfX19faTkxNV9nZW1fb2JqZWN0X2dldF9wYWdlcyhvYmopOwpAQCAt
MTIxLDYgKzExOCwzMiBAQCBpbnQgX19pOTE1X2dlbV9vYmplY3RfZ2V0X3BhZ2VzKHN0cnVjdCBk
cm1faTkxNV9nZW1fb2JqZWN0ICpvYmopCiAJcmV0dXJuIGVycjsKIH0KIAoraW50IGk5MTVfZ2Vt
X29iamVjdF9waW5fcGFnZXMoc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaikKK3sKKwlp
bnQgZXJyOworCisJZXJyID0gaTkxNV9nZW1fb2JqZWN0X3Bpbl9wYWdlc19hc3luYyhvYmopOwor
CWlmIChlcnIpCisJCXJldHVybiBlcnI7CisKKwllcnIgPSB3YWl0X2Zvcl9jb21wbGV0aW9uX2lu
dGVycnVwdGlibGUoJm9iai0+bW0uY29tcGxldGlvbik7CisJaWYgKGVycikKKwkJZ290byBlcnJf
dW5waW47CisKKwlpZiAoSVNfRVJSKG9iai0+bW0ucGFnZXMpKSB7CisJCWVyciA9IFBUUl9FUlIo
b2JqLT5tbS5wYWdlcyk7CisJCWdvdG8gZXJyX3VucGluOworCX0KKworCUdFTV9CVUdfT04oIWk5
MTVfZ2VtX29iamVjdF9oYXNfcGFnZXMob2JqKSk7CisJcmV0dXJuIDA7CisKK2Vycl91bnBpbjoK
KwlHRU1fQlVHX09OKCFpOTE1X2dlbV9vYmplY3RfaGFzX3Bpbm5lZF9wYWdlcyhvYmopKTsKKwlh
dG9taWNfZGVjKCZvYmotPm1tLnBhZ2VzX3Bpbl9jb3VudCk7CisJcmV0dXJuIGVycjsKK30KKwog
LyogSW1tZWRpYXRlbHkgZGlzY2FyZCB0aGUgYmFja2luZyBzdG9yYWdlICovCiB2b2lkIGk5MTVf
Z2VtX29iamVjdF90cnVuY2F0ZShzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqKQogewpA
QCAtMjAxLDYgKzIyNCw5IEBAIGludCBfX2k5MTVfZ2VtX29iamVjdF9wdXRfcGFnZXMoc3RydWN0
IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiwKIAogCUdFTV9CVUdfT04oYXRvbWljX3JlYWQoJm9i
ai0+YmluZF9jb3VudCkpOwogCisJaWYgKG9iai0+bW0ucGFnZXMgPT0gRVJSX1BUUigtRUFHQUlO
KSkKKwkJd2FpdF9mb3JfY29tcGxldGlvbigmb2JqLT5tbS5jb21wbGV0aW9uKTsKKwogCS8qIE1h
eSBiZSBjYWxsZWQgYnkgc2hyaW5rZXIgZnJvbSB3aXRoaW4gZ2V0X3BhZ2VzKCkgKG9uIGFub3Ro
ZXIgYm8pICovCiAJbXV0ZXhfbG9ja19uZXN0ZWQoJm9iai0+bW0ubG9jaywgc3ViY2xhc3MpOwog
CWlmICh1bmxpa2VseShhdG9taWNfcmVhZCgmb2JqLT5tbS5wYWdlc19waW5fY291bnQpKSkgewpA
QCAtMjI3LDYgKzI1Myw3IEBAIGludCBfX2k5MTVfZ2VtX29iamVjdF9wdXRfcGFnZXMoc3RydWN0
IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiwKIAlpZiAoIUlTX0VSUihwYWdlcykpCiAJCW9iai0+
b3BzLT5wdXRfcGFnZXMob2JqLCBwYWdlcyk7CiAKKwlyZWluaXRfY29tcGxldGlvbigmb2JqLT5t
bS5jb21wbGV0aW9uKTsKIAllcnIgPSAwOwogdW5sb2NrOgogCW11dGV4X3VubG9jaygmb2JqLT5t
bS5sb2NrKTsKQEAgLTMwNCw3ICszMzEsNyBAQCB2b2lkICppOTE1X2dlbV9vYmplY3RfcGluX21h
cChzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqLAogCXR5cGUgJj0gfkk5MTVfTUFQX09W
RVJSSURFOwogCiAJaWYgKCFhdG9taWNfaW5jX25vdF96ZXJvKCZvYmotPm1tLnBhZ2VzX3Bpbl9j
b3VudCkpIHsKLQkJaWYgKHVubGlrZWx5KCFpOTE1X2dlbV9vYmplY3RfaGFzX3BhZ2VzKG9iaikp
KSB7CisJCWlmICghb2JqLT5tbS5wYWdlcykgewogCQkJR0VNX0JVR19PTihpOTE1X2dlbV9vYmpl
Y3RfaGFzX3Bpbm5lZF9wYWdlcyhvYmopKTsKIAogCQkJZXJyID0gX19fX2k5MTVfZ2VtX29iamVj
dF9nZXRfcGFnZXMob2JqKTsKQEAgLTMxNiw3ICszNDMsNiBAQCB2b2lkICppOTE1X2dlbV9vYmpl
Y3RfcGluX21hcChzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqLAogCQlhdG9taWNfaW5j
KCZvYmotPm1tLnBhZ2VzX3Bpbl9jb3VudCk7CiAJCXBpbm5lZCA9IGZhbHNlOwogCX0KLQlHRU1f
QlVHX09OKCFpOTE1X2dlbV9vYmplY3RfaGFzX3BhZ2VzKG9iaikpOwogCiAJcHRyID0gcGFnZV91
bnBhY2tfYml0cyhvYmotPm1tLm1hcHBpbmcsICZoYXNfdHlwZSk7CiAJaWYgKHB0ciAmJiBoYXNf
dHlwZSAhPSB0eXBlKSB7CkBAIC0zMzQsNiArMzYwLDE1IEBAIHZvaWQgKmk5MTVfZ2VtX29iamVj
dF9waW5fbWFwKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmosCiAJfQogCiAJaWYgKCFw
dHIpIHsKKwkJZXJyID0gd2FpdF9mb3JfY29tcGxldGlvbl9pbnRlcnJ1cHRpYmxlKCZvYmotPm1t
LmNvbXBsZXRpb24pOworCQlpZiAoZXJyKQorCQkJZ290byBlcnJfdW5waW47CisKKwkJaWYgKElT
X0VSUihvYmotPm1tLnBhZ2VzKSkgeworCQkJZXJyID0gUFRSX0VSUihvYmotPm1tLnBhZ2VzKTsK
KwkJCWdvdG8gZXJyX3VucGluOworCQl9CisKIAkJcHRyID0gaTkxNV9nZW1fb2JqZWN0X21hcChv
YmosIHR5cGUpOwogCQlpZiAoIXB0cikgewogCQkJZXJyID0gLUVOT01FTTsKLS0gCjIuMjAuMQoK
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4
IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlz
dHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

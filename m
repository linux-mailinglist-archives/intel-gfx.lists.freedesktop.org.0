Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 176302C709B
	for <lists+intel-gfx@lfdr.de>; Sat, 28 Nov 2020 19:40:58 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 3571F6ECE9;
	Sat, 28 Nov 2020 18:40:52 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (unknown [77.68.26.236])
 by gabe.freedesktop.org (Postfix) with ESMTPS id F1B966ECE2
 for <intel-gfx@lists.freedesktop.org>; Sat, 28 Nov 2020 18:40:49 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from build.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 23146439-1500050 
 for multiple; Sat, 28 Nov 2020 18:40:41 +0000
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Sat, 28 Nov 2020 18:40:40 +0000
Message-Id: <20201128184040.20150-4-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20201128184040.20150-1-chris@chris-wilson.co.uk>
References: <20201128184040.20150-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [RFC 4/4] drm/i915/gt: Pipelined page migration
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Chris Wilson <chris@chris-wilson.co.uk>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SWYgd2UgcGlwZWxpbmUgdGhlIFBURSB1cGRhdGVzIGFuZCB0aGVuIGRvIHRoZSBjb3B5IG9mIHRo
b3NlIHBhZ2VzCndpdGhpbiBhIHNpbmdsZSB1bnByZWVtcHRpYmxlIGNvbW1hbmQgcGFja2V0LCB3
ZSBjYW4gc3VibWl0IHRoZSBjb3BpZXMKYW5kIGxlYXZlIHRoZW0gdG8gYmUgc2NoZWR1bGVkIHdp
dGhvdXQgaGF2aW5nIHRvIHN5bmNocm9ub3VzbHkgd2FpdAp1bmRlciBhIGdsb2JhbCBsb2NrLgoK
U2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28udWs+Ci0t
LQogZHJpdmVycy9ncHUvZHJtL2k5MTUvTWFrZWZpbGUgICAgICAgICAgICAgICAgIHwgICAxICsK
IGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZS5oICAgICAgICB8ICAgMSArCiBk
cml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9taWdyYXRlLmMgICAgICAgfCAzNzAgKysrKysr
KysrKysrKysrKysrCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9taWdyYXRlLmggICAg
ICAgfCAgMzMgKysKIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L3NlbGZ0ZXN0X21pZ3JhdGUuYyAg
ICB8IDEwNSArKysrKwogLi4uL2RybS9pOTE1L3NlbGZ0ZXN0cy9pOTE1X2xpdmVfc2VsZnRlc3Rz
LmggIHwgICAxICsKIDYgZmlsZXMgY2hhbmdlZCwgNTExIGluc2VydGlvbnMoKykKIGNyZWF0ZSBt
b2RlIDEwMDY0NCBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9taWdyYXRlLmMKIGNyZWF0
ZSBtb2RlIDEwMDY0NCBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9taWdyYXRlLmgKIGNy
ZWF0ZSBtb2RlIDEwMDY0NCBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVzdF9taWdyYXRl
LmMKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9NYWtlZmlsZSBiL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L01ha2VmaWxlCmluZGV4IGU1NTc0ZTUwNmE1Yy4uMGIyZTEyYzg3ZjlkIDEw
MDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9NYWtlZmlsZQorKysgYi9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9NYWtlZmlsZQpAQCAtMTAzLDYgKzEwMyw3IEBAIGd0LXkgKz0gXAogCWd0L2lu
dGVsX2d0dC5vIFwKIAlndC9pbnRlbF9sbGMubyBcCiAJZ3QvaW50ZWxfbHJjLm8gXAorCWd0L2lu
dGVsX21pZ3JhdGUubyBcCiAJZ3QvaW50ZWxfbW9jcy5vIFwKIAlndC9pbnRlbF9wcGd0dC5vIFwK
IAlndC9pbnRlbF9yYzYubyBcCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9p
bnRlbF9lbmdpbmUuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZS5oCmlu
ZGV4IGFjNThmY2RhNDkyNy4uMDc5ZDI2YjQ3YTk3IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9ndC9pbnRlbF9lbmdpbmUuaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9p
bnRlbF9lbmdpbmUuaApAQCAtMTg4LDYgKzE4OCw3IEBAIGludGVsX3dyaXRlX3N0YXR1c19wYWdl
KHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSwgaW50IHJlZywgdTMyIHZhbHVlKQogI2Rl
ZmluZSBJOTE1X0dFTV9IV1NfUFJFRU1QVF9BRERSCShJOTE1X0dFTV9IV1NfUFJFRU1QVCAqIHNp
emVvZih1MzIpKQogI2RlZmluZSBJOTE1X0dFTV9IV1NfU0VRTk8JCTB4NDAKICNkZWZpbmUgSTkx
NV9HRU1fSFdTX1NFUU5PX0FERFIJCShJOTE1X0dFTV9IV1NfU0VRTk8gKiBzaXplb2YodTMyKSkK
KyNkZWZpbmUgSTkxNV9HRU1fSFdTX01JR1JBVEUJCSgweDQyICogc2l6ZW9mKHUzMikpCiAjZGVm
aW5lIEk5MTVfR0VNX0hXU19TQ1JBVENICQkweDgwCiAKICNkZWZpbmUgSTkxNV9IV1NfQ1NCX0JV
RjBfSU5ERVgJCTB4MTAKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVs
X21pZ3JhdGUuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX21pZ3JhdGUuYwpuZXcg
ZmlsZSBtb2RlIDEwMDY0NAppbmRleCAwMDAwMDAwMDAwMDAuLjRkN2JkMzJlYjhkNAotLS0gL2Rl
di9udWxsCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX21pZ3JhdGUuYwpAQCAt
MCwwICsxLDM3MCBAQAorLy8gU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IE1JVAorLyoKKyAqIENv
cHlyaWdodCDCqSAyMDIwIEludGVsIENvcnBvcmF0aW9uCisgKi8KKworI2luY2x1ZGUgImk5MTVf
ZHJ2LmgiCisjaW5jbHVkZSAiaW50ZWxfY29udGV4dC5oIgorI2luY2x1ZGUgImludGVsX2d0Lmgi
CisjaW5jbHVkZSAiaW50ZWxfZ3R0LmgiCisjaW5jbHVkZSAiaW50ZWxfbHJjLmgiIC8qIHZpcnR1
YWwgZW5naW5lICovCisjaW5jbHVkZSAiaW50ZWxfbWlncmF0ZS5oIgorI2luY2x1ZGUgImludGVs
X3JpbmcuaCIKKworI2RlZmluZSBDSFVOS19TWiBTWl84TSAvKiB+MW1zIGF0IDhHaUIvcyBwcmVl
bXB0aW9uIGRlbGF5ICovCisKK3N0YXRpYyB2b2lkIGluc2VydF9wdGUoc3RydWN0IGk5MTVfYWRk
cmVzc19zcGFjZSAqdm0sCisJCSAgICAgICBzdHJ1Y3QgaTkxNV9wYWdlX3RhYmxlICpwdCwKKwkJ
ICAgICAgIHZvaWQgKmRhdGEpCit7CisJdTY0ICpvZmZzZXQgPSBkYXRhOworCisJdm0tPmluc2Vy
dF9wYWdlKHZtLCBweF9kbWEocHQpLCAqb2Zmc2V0LCBJOTE1X0NBQ0hFX05PTkUsIDApOworCSpv
ZmZzZXQgKz0gUEFHRV9TSVpFOworfQorCitzdGF0aWMgc3RydWN0IGk5MTVfYWRkcmVzc19zcGFj
ZSAqbWlncmF0ZV92bShzdHJ1Y3QgaW50ZWxfZ3QgKmd0KQoreworCXN0cnVjdCBpOTE1X3ZtX3B0
X3N0YXNoIHN0YXNoID0ge307CisJc3RydWN0IGk5MTVfcHBndHQgKnZtOworCXU2NCBvZmZzZXQs
IHN6OworCWludCBlcnI7CisKKwl2bSA9IGk5MTVfcHBndHRfY3JlYXRlKGd0KTsKKwlpZiAoSVNf
RVJSKHZtKSkKKwkJcmV0dXJuIEVSUl9DQVNUKHZtKTsKKworCWlmICghdm0tPnZtLmFsbG9jYXRl
X3ZhX3JhbmdlIHx8ICF2bS0+dm0uZm9yZWFjaCkgeworCQllcnIgPSAtRU5PREVWOworCQlnb3Rv
IGVycl92bTsKKwl9CisKKwkvKgorCSAqIFdlIGNvcHkgaW4gOE1pQiBjaHVua3MuIEVhY2ggUERF
IGNvdmVycyAyTWlCLCBzbyB3ZSBuZWVkCisJICogNHgyIHBhZ2UgZGlyZWN0b3JpZXMgZm9yIHNv
dXJjZS9kZXN0aW5hdGlvbi4KKwkgKi8KKwlzeiA9IDIgKiBDSFVOS19TWjsKKwlvZmZzZXQgPSBz
ejsKKworCS8qCisJICogV2UgbmVlZCBhbm90aGVyIHBhZ2UgZGlyZWN0b3J5IHNldHVwIHNvIHRo
YXQgd2UgY2FuIHdyaXRlCisJICogdGhlIDh4NTEyIFBURSBpbiBlYWNoIGNodW5rLgorCSAqLwor
CXN6ICs9IChzeiA+PiAxMikgKiBzaXplb2YodTY0KTsKKworCWVyciA9IGk5MTVfdm1fYWxsb2Nf
cHRfc3Rhc2goJnZtLT52bSwgJnN0YXNoLCBzeik7CisJaWYgKGVycikKKwkJZ290byBlcnJfdm07
CisKKwllcnIgPSBpOTE1X3ZtX3Bpbl9wdF9zdGFzaCgmdm0tPnZtLCAmc3Rhc2gpOworCWlmIChl
cnIpIHsKKwkJaTkxNV92bV9mcmVlX3B0X3N0YXNoKCZ2bS0+dm0sICZzdGFzaCk7CisJCWdvdG8g
ZXJyX3ZtOworCX0KKworCXZtLT52bS5hbGxvY2F0ZV92YV9yYW5nZSgmdm0tPnZtLCAmc3Rhc2gs
IDAsIHN6KTsKKwlpOTE1X3ZtX2ZyZWVfcHRfc3Rhc2goJnZtLT52bSwgJnN0YXNoKTsKKworCS8q
IE5vdyBhbGxvdyB0aGUgR1BVIHRvIHJld3JpdGUgdGhlIFBURSB2aWEgaXRzIG93biBwcEdUVCAq
LworCXZtLT52bS5mb3JlYWNoKCZ2bS0+dm0sIDAsIHN6LCBpbnNlcnRfcHRlLCAmb2Zmc2V0KTsK
KworCXJldHVybiAmdm0tPnZtOworCitlcnJfdm06CisJaTkxNV92bV9wdXQoJnZtLT52bSk7CisJ
cmV0dXJuIEVSUl9QVFIoZXJyKTsKK30KKworc3RhdGljIHN0cnVjdCBpbnRlbF9lbmdpbmVfY3Mg
KmZpcnN0X2NvcHlfZW5naW5lKHN0cnVjdCBpbnRlbF9ndCAqZ3QpCit7CisJc3RydWN0IGludGVs
X2VuZ2luZV9jcyAqZW5naW5lOworCWludCBpOworCisJZm9yIChpID0gMDsgaSA8IEFSUkFZX1NJ
WkUoZ3QtPmVuZ2luZV9jbGFzc1tDT1BZX0VOR0lORV9DTEFTU10pOyBpKyspIHsKKwkJZW5naW5l
ID0gZ3QtPmVuZ2luZV9jbGFzc1tDT1BZX0VOR0lORV9DTEFTU11baV07CisJCWlmIChlbmdpbmUp
CisJCQlyZXR1cm4gZW5naW5lOworCX0KKworCXJldHVybiBOVUxMOworfQorCitzdGF0aWMgc3Ry
dWN0IGludGVsX2NvbnRleHQgKnBpbm5lZF9jb250ZXh0KHN0cnVjdCBpbnRlbF9ndCAqZ3QpCit7
CisJc3RhdGljIHN0cnVjdCBsb2NrX2NsYXNzX2tleSBrZXk7CisJc3RydWN0IGludGVsX2VuZ2lu
ZV9jcyAqZW5naW5lOworCXN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtOworCXN0cnVjdCBp
bnRlbF9jb250ZXh0ICpjZTsKKwlpbnQgZXJyOworCisJZW5naW5lID0gZmlyc3RfY29weV9lbmdp
bmUoZ3QpOworCWlmICghZW5naW5lKQorCQlyZXR1cm4gRVJSX1BUUigtRU5PREVWKTsKKworCWNl
ID0gaW50ZWxfZW5naW5lX2NyZWF0ZV9waW5uZWRfY29udGV4dChlbmdpbmUsIFNaXzUxMkssCisJ
CQkJCQlJOTE1X0dFTV9IV1NfTUlHUkFURSwKKwkJCQkJCSZrZXksICJtaWdyYXRlIik7CisJaWYg
KElTX0VSUihjZSkpCisJCXJldHVybiBjZTsKKworCXZtID0gbWlncmF0ZV92bShndCk7CisJaWYg
KElTX0VSUih2bSkpIHsKKwkJZXJyID0gUFRSX0VSUih2bSk7CisJCWdvdG8gZXJyX2NlOworCX0K
KwlpOTE1X3ZtX3B1dChjZS0+dm0pOworCWNlLT52bSA9IHZtOworCisJcmV0dXJuIGNlOworCitl
cnJfY2U6CisJaW50ZWxfY29udGV4dF9wdXQoY2UpOworCXJldHVybiBFUlJfUFRSKGVycik7Cit9
CisKK2ludCBpbnRlbF9taWdyYXRlX2luaXQoc3RydWN0IGludGVsX21pZ3JhdGUgKm0sIHN0cnVj
dCBpbnRlbF9ndCAqZ3QpCit7CisJc3RydWN0IGludGVsX2NvbnRleHQgKmNlOworCisJY2UgPSBw
aW5uZWRfY29udGV4dChndCk7CisJaWYgKElTX0VSUihjZSkpCisJCXJldHVybiBQVFJfRVJSKGNl
KTsKKworCW0tPmNlID0gY2U7CisJcmV0dXJuIDA7Cit9CisKK3N0YXRpYyBzdHJ1Y3QgaW50ZWxf
Y29udGV4dCAqX19taWdyYXRlX2VuZ2luZXMoc3RydWN0IGludGVsX2d0ICpndCkKK3sKKwlzdHJ1
Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmVzW01BWF9FTkdJTkVfSU5TVEFOQ0VdOworCXN0cnVj
dCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZTsKKwl1bnNpZ25lZCBpbnQgY291bnQsIGk7CisKKwlj
b3VudCA9IDA7CisJZm9yIChpID0gMDsgaSA8IEFSUkFZX1NJWkUoZ3QtPmVuZ2luZV9jbGFzc1tD
T1BZX0VOR0lORV9DTEFTU10pOyBpKyspIHsKKwkJZW5naW5lID0gZ3QtPmVuZ2luZV9jbGFzc1tD
T1BZX0VOR0lORV9DTEFTU11baV07CisJCWlmIChlbmdpbmUpCisJCQllbmdpbmVzW2NvdW50Kytd
ID0gZW5naW5lOworCX0KKworCXJldHVybiBpbnRlbF9leGVjbGlzdHNfY3JlYXRlX3ZpcnR1YWwo
ZW5naW5lcywgY291bnQpOworfQorCitzdHJ1Y3QgaW50ZWxfY29udGV4dCAqaW50ZWxfbWlncmF0
ZV9jcmVhdGVfY29udGV4dChzdHJ1Y3QgaW50ZWxfbWlncmF0ZSAqbSkKK3sKKwlzdHJ1Y3QgaW50
ZWxfY29udGV4dCAqY2U7CisKKwljZSA9IF9fbWlncmF0ZV9lbmdpbmVzKG0tPmNlLT5lbmdpbmUt
Pmd0KTsKKwlpZiAoSVNfRVJSKGNlKSkKKwkJcmV0dXJuIGNlOworCisJY2UtPnJpbmcgPSBfX2lu
dGVsX2NvbnRleHRfcmluZ19zaXplKFNaXzUxMkspOworCisJaTkxNV92bV9wdXQoY2UtPnZtKTsK
KwljZS0+dm0gPSBpOTE1X3ZtX2dldChtLT5jZS0+dm0pOworCisJcmV0dXJuIGNlOworfQorCitz
dGF0aWMgaW5saW5lIHN0cnVjdCBzZ3RfZG1hIHNnX3NndChzdHJ1Y3Qgc2NhdHRlcmxpc3QgKnNn
KQoreworCWRtYV9hZGRyX3QgYWRkciA9IHNnX2RtYV9hZGRyZXNzKHNnKTsKKworCXJldHVybiAo
c3RydWN0IHNndF9kbWEpeyBzZywgYWRkciwgYWRkciArIHNnX2RtYV9sZW4oc2cpIH07Cit9CisK
K3N0YXRpYyBpbnQgZW1pdF9wdGUoc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEsCisJCSAgICBzdHJ1
Y3Qgc2d0X2RtYSAqaXQsCisJCSAgICB1NjQgZW5jb2RlLAorCQkgICAgaW50IG9mZnNldCwKKwkJ
ICAgIGludCBsZW5ndGgpCit7CisJaW50IHRvdGFsID0gMDsKKworCW9mZnNldCA+Pj0gMTI7CisJ
b2Zmc2V0ICo9IHNpemVvZih1NjQpOworCW9mZnNldCArPSAyICogQ0hVTktfU1o7CisKKwlkbyB7
CisJCXUzMiAqY3M7CisKKwkJY3MgPSBpbnRlbF9yaW5nX2JlZ2luKHJxLCA4KTsKKwkJaWYgKElT
X0VSUihjcykpCisJCQlyZXR1cm4gUFRSX0VSUihjcyk7CisKKwkJKmNzKysgPSBNSV9TVE9SRV9E
V09SRF9JTU1fR0VONDsKKwkJKmNzKysgPSBvZmZzZXQ7CisJCSpjcysrID0gMDsKKwkJKmNzKysg
PSBsb3dlcl8zMl9iaXRzKGVuY29kZSB8IGl0LT5kbWEpOworCQkqY3MrKyA9IE1JX1NUT1JFX0RX
T1JEX0lNTV9HRU40OworCQkqY3MrKyA9IG9mZnNldCArIDQ7CisJCSpjcysrID0gMDsKKwkJKmNz
KysgPSB1cHBlcl8zMl9iaXRzKGVuY29kZSB8IGl0LT5kbWEpOworCQlpbnRlbF9yaW5nX2FkdmFu
Y2UocnEsIGNzKTsKKworCQlvZmZzZXQgKz0gODsKKwkJdG90YWwgKz0gSTkxNV9HVFRfUEFHRV9T
SVpFOworCisJCWl0LT5kbWEgKz0gSTkxNV9HVFRfUEFHRV9TSVpFOworCQlpZiAoaXQtPmRtYSA+
PSBpdC0+bWF4KSB7CisJCQlpdC0+c2cgPSBfX3NnX25leHQoaXQtPnNnKTsKKwkJCWlmICghaXQt
PnNnIHx8IHNnX2RtYV9sZW4oaXQtPnNnKSA9PSAwKQorCQkJCWJyZWFrOworCisJCQlpdC0+ZG1h
ID0gc2dfZG1hX2FkZHJlc3MoaXQtPnNnKTsKKwkJCWl0LT5tYXggPSBpdC0+ZG1hICsgc2dfZG1h
X2xlbihpdC0+c2cpOworCQl9CisKKwkJaWYgKHRvdGFsID09IGxlbmd0aCkKKwkJCWJyZWFrOwor
CX0gd2hpbGUgKDEpOworCisJcmV0dXJuIHRvdGFsOworfQorCitzdGF0aWMgYm9vbCB3YV8xMjA5
NjQ0NjExX2FwcGxpZXMoaW50IGdlbiwgdTMyIHNpemUpCit7CisJdTMyIGhlaWdodCA9IHNpemUg
Pj4gUEFHRV9TSElGVDsKKworCWlmIChnZW4gIT0gMTEpCisJCXJldHVybiBmYWxzZTsKKworCXJl
dHVybiBoZWlnaHQgJSA0ID09IDMgJiYgaGVpZ2h0IDw9IDg7Cit9CisKK3N0YXRpYyBpbnQgZW1p
dF9jb3B5KHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxLCBpbnQgc2l6ZSkKK3sKKwljb25zdCBpbnQg
Z2VuID0gSU5URUxfR0VOKHJxLT5lbmdpbmUtPmk5MTUpOworCXUzMiAqY3M7CisKKwljcyA9IGlu
dGVsX3JpbmdfYmVnaW4ocnEsIGdlbiA+PSA4ID8gMTAgOiA2KTsKKwlpZiAoSVNfRVJSKGNzKSkK
KwkJcmV0dXJuIFBUUl9FUlIoY3MpOworCisJaWYgKGdlbiA+PSA5ICYmICF3YV8xMjA5NjQ0NjEx
X2FwcGxpZXMoZ2VuLCBzaXplKSkgeworCQkqY3MrKyA9IEdFTjlfWFlfRkFTVF9DT1BZX0JMVF9D
TUQgfCAoMTAgLSAyKTsKKwkJKmNzKysgPSBCTFRfREVQVEhfMzIgfCBQQUdFX1NJWkU7CisJCSpj
cysrID0gMDsKKwkJKmNzKysgPSBzaXplID4+IFBBR0VfU0hJRlQgPDwgMTYgfCBQQUdFX1NJWkUg
LyA0OworCQkqY3MrKyA9IENIVU5LX1NaOyAvKiBkc3Qgb2Zmc2V0ICovCisJCSpjcysrID0gMDsK
KwkJKmNzKysgPSAwOworCQkqY3MrKyA9IFBBR0VfU0laRTsKKwkJKmNzKysgPSAwOyAvKiBzcmMg
b2Zmc2V0ICovCisJCSpjcysrID0gMDsKKwl9IGVsc2UgaWYgKGdlbiA+PSA4KSB7CisJCSpjcysr
ID0gWFlfU1JDX0NPUFlfQkxUX0NNRCB8IEJMVF9XUklURV9SR0JBIHwgKDEwIC0gMik7CisJCSpj
cysrID0gQkxUX0RFUFRIXzMyIHwgQkxUX1JPUF9TUkNfQ09QWSB8IFBBR0VfU0laRTsKKwkJKmNz
KysgPSAwOworCQkqY3MrKyA9IHNpemUgPj4gUEFHRV9TSElGVCA8PCAxNiB8IFBBR0VfU0laRSAv
IDQ7CisJCSpjcysrID0gQ0hVTktfU1o7IC8qIGRzdCBvZmZzZXQgKi8KKwkJKmNzKysgPSAwOwor
CQkqY3MrKyA9IDA7CisJCSpjcysrID0gUEFHRV9TSVpFOworCQkqY3MrKyA9IDA7IC8qIHNyYyBv
ZmZzZXQgKi8KKwkJKmNzKysgPSAwOworCX0gZWxzZSB7CisJCSpjcysrID0gU1JDX0NPUFlfQkxU
X0NNRCB8IEJMVF9XUklURV9SR0JBIHwgKDYgLSAyKTsKKwkJKmNzKysgPSBCTFRfREVQVEhfMzIg
fCBCTFRfUk9QX1NSQ19DT1BZIHwgUEFHRV9TSVpFOworCQkqY3MrKyA9IHNpemUgPj4gUEFHRV9T
SElGVCA8PCAxNiB8IFBBR0VfU0laRTsKKwkJKmNzKysgPSBDSFVOS19TWjsgLyogZHN0IG9mZnNl
dCAqLworCQkqY3MrKyA9IFBBR0VfU0laRTsKKwkJKmNzKysgPSAwOyAvKiBzcmMgb2Zmc2V0ICov
CisJfQorCisJaW50ZWxfcmluZ19hZHZhbmNlKHJxLCBjcyk7CisJcmV0dXJuIDA7Cit9CisKK3N0
cnVjdCBpOTE1X3JlcXVlc3QgKgoraW50ZWxfY29udGV4dF9taWdyYXRlX3BhZ2VzKHN0cnVjdCBp
bnRlbF9jb250ZXh0ICpjZSwKKwkJCSAgICBzdHJ1Y3Qgc2NhdHRlcmxpc3QgKnNyYywKKwkJCSAg
ICBzdHJ1Y3Qgc2NhdHRlcmxpc3QgKmRzdCkKK3sKKwlzdHJ1Y3Qgc2d0X2RtYSBpdF9zID0gc2df
c2d0KHNyYyksIGl0X2QgPSBzZ19zZ3QoZHN0KTsKKwl1NjQgZW5jb2RlID0gY2UtPnZtLT5wdGVf
ZW5jb2RlKDAsIEk5MTVfQ0FDSEVfTExDLCAwKTsgLyogZmxhZ3MgKi8KKwlzdHJ1Y3QgaTkxNV9y
ZXF1ZXN0ICpycTsKKwlpbnQgbGVuOworCWludCBlcnI7CisKKwkvKiBHRU1fQlVHX09OKGNlLT52
bSAhPSBtaWdyYXRlX3ZtKTsgKi8KKworCWVyciA9IGludGVsX2NvbnRleHRfcGluKGNlKTsKKwlp
ZiAoZXJyKQorCQlyZXR1cm4gRVJSX1BUUihlcnIpOworCisJR0VNX0JVR19PTihjZS0+cmluZy0+
c2l6ZSA8IFNaXzY0Syk7CisKKwlkbyB7CisJCXJxID0gaTkxNV9yZXF1ZXN0X2NyZWF0ZShjZSk7
CisJCWlmIChJU19FUlIocnEpKSB7CisJCQllcnIgPSBQVFJfRVJSKHJxKTsKKwkJCWdvdG8gb3V0
X2NlOworCQl9CisKKwkJbGVuID0gZW1pdF9wdGUocnEsICZpdF9zLCBlbmNvZGUsIDAsIENIVU5L
X1NaKTsKKwkJaWYgKGxlbiA8PSAwKSB7CisJCQllcnIgPSBsZW47CisJCQlnb3RvIG91dF9ycTsK
KwkJfQorCisJCWlmIChlbWl0X3B0ZShycSwgJml0X2QsIGVuY29kZSwgQ0hVTktfU1osIGxlbikg
PCBsZW4pIHsKKwkJCWVyciA9IC1FSU5WQUw7CisJCQlnb3RvIG91dF9ycTsKKwkJfQorCisJCWVy
ciA9IHJxLT5lbmdpbmUtPmVtaXRfZmx1c2gocnEsIEVNSVRfSU5WQUxJREFURSk7CisJCWlmIChl
cnIpCisJCQlnb3RvIG91dF9ycTsKKworCQllcnIgPSBlbWl0X2NvcHkocnEsIGxlbik7CisJCWlm
IChlcnIpCisJCQlnb3RvIG91dF9ycTsKKworCQlpZiAoIWl0X3Muc2cpCisJCQlpOTE1X3JlcXVl
c3RfZ2V0KHJxKTsKK291dF9ycToKKwkJaTkxNV9yZXF1ZXN0X2FkZChycSk7CisJCWlmIChpdF9z
LnNnKQorCQkJY29uZF9yZXNjaGVkKCk7CisJfSB3aGlsZSAoZXJyID09IDAgJiYgaXRfcy5zZyk7
CisKK291dF9jZToKKwlpbnRlbF9jb250ZXh0X3VucGluKGNlKTsKKwlyZXR1cm4gZXJyID8gRVJS
X1BUUihlcnIpIDogcnE7Cit9CisKK3N0cnVjdCBpOTE1X3JlcXVlc3QgKgoraW50ZWxfbWlncmF0
ZV9wYWdlcyhzdHJ1Y3QgaW50ZWxfbWlncmF0ZSAqbSwKKwkJICAgIHN0cnVjdCBzY2F0dGVybGlz
dCAqc3JjLAorCQkgICAgc3RydWN0IHNjYXR0ZXJsaXN0ICpkc3QpCit7CisJc3RydWN0IGludGVs
X2NvbnRleHQgKmNlOworCXN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxOworCisJaWYgKCFtLT5jZSkK
KwkJcmV0dXJuIEVSUl9QVFIoLUVOT0RFVik7CisKKwljZSA9IGludGVsX21pZ3JhdGVfY3JlYXRl
X2NvbnRleHQobSk7CisJaWYgKElTX0VSUihjZSkpCisJCWNlID0gaW50ZWxfY29udGV4dF9nZXQo
bS0+Y2UpOworCUdFTV9CVUdfT04oSVNfRVJSKGNlKSk7CisKKwlycSA9IGludGVsX2NvbnRleHRf
bWlncmF0ZV9wYWdlcyhjZSwgc3JjLCBkc3QpOworCisJaW50ZWxfY29udGV4dF9wdXQoY2UpOwor
CXJldHVybiBycTsKK30KKwordm9pZCBpbnRlbF9taWdyYXRlX2Zpbmkoc3RydWN0IGludGVsX21p
Z3JhdGUgKm0pCit7CisJaWYgKCFtLT5jZSkKKwkJcmV0dXJuOworCisJaW50ZWxfY29udGV4dF91
bnBpbihtLT5jZSk7CisJaW50ZWxfY29udGV4dF9wdXQobS0+Y2UpOworfQorCisjaWYgSVNfRU5B
QkxFRChDT05GSUdfRFJNX0k5MTVfU0VMRlRFU1QpCisjaW5jbHVkZSAic2VsZnRlc3RfbWlncmF0
ZS5jIgorI2VuZGlmCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9t
aWdyYXRlLmggYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9taWdyYXRlLmgKbmV3IGZp
bGUgbW9kZSAxMDA2NDQKaW5kZXggMDAwMDAwMDAwMDAwLi44YzNjNDQ2ZmJkMzMKLS0tIC9kZXYv
bnVsbAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9taWdyYXRlLmgKQEAgLTAs
MCArMSwzMyBAQAorLyogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IE1JVCAqLworLyoKKyAqIENv
cHlyaWdodCDCqSAyMDIwIEludGVsIENvcnBvcmF0aW9uCisgKi8KKworI2lmbmRlZiBfX0lOVEVM
X01JR1JBVEVfXworI2RlZmluZSBfX0lOVEVMX01JR1JBVEVfXworCitzdHJ1Y3QgaTkxNV9yZXF1
ZXN0Oworc3RydWN0IGludGVsX2NvbnRleHQ7CitzdHJ1Y3QgaW50ZWxfZ3Q7CitzdHJ1Y3Qgc2Nh
dHRlcmxpc3Q7CisKK3N0cnVjdCBpbnRlbF9taWdyYXRlIHsKKwlzdHJ1Y3QgaW50ZWxfY29udGV4
dCAqY2U7Cit9OworCitpbnQgaW50ZWxfbWlncmF0ZV9pbml0KHN0cnVjdCBpbnRlbF9taWdyYXRl
ICptLCBzdHJ1Y3QgaW50ZWxfZ3QgKmd0KTsKKworc3RydWN0IGk5MTVfcmVxdWVzdCAqCitpbnRl
bF9taWdyYXRlX3BhZ2VzKHN0cnVjdCBpbnRlbF9taWdyYXRlICptLAorCQkgICAgc3RydWN0IHNj
YXR0ZXJsaXN0ICpzcmMsCisJCSAgICBzdHJ1Y3Qgc2NhdHRlcmxpc3QgKmRzdCk7CisKK3N0cnVj
dCBpbnRlbF9jb250ZXh0ICppbnRlbF9taWdyYXRlX2NyZWF0ZV9jb250ZXh0KHN0cnVjdCBpbnRl
bF9taWdyYXRlICptKTsKK3N0cnVjdCBpOTE1X3JlcXVlc3QgKgoraW50ZWxfY29udGV4dF9taWdy
YXRlX3BhZ2VzKHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSwKKwkJCSAgICBzdHJ1Y3Qgc2NhdHRl
cmxpc3QgKnNyYywKKwkJCSAgICBzdHJ1Y3Qgc2NhdHRlcmxpc3QgKmRzdCk7CisKK3ZvaWQgaW50
ZWxfbWlncmF0ZV9maW5pKHN0cnVjdCBpbnRlbF9taWdyYXRlICptKTsKKworI2VuZGlmIC8qIF9f
SU5URUxfTUlHUkFURV9fICovCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9z
ZWxmdGVzdF9taWdyYXRlLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVzdF9taWdy
YXRlLmMKbmV3IGZpbGUgbW9kZSAxMDA2NDQKaW5kZXggMDAwMDAwMDAwMDAwLi5kNTEwMjA1OGZl
M2IKLS0tIC9kZXYvbnVsbAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVzdF9t
aWdyYXRlLmMKQEAgLTAsMCArMSwxMDUgQEAKKy8vIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBN
SVQKKy8qCisgKiBDb3B5cmlnaHQgwqkgMjAyMCBJbnRlbCBDb3Jwb3JhdGlvbgorICovCisKK3N0
YXRpYyBpbnQgbGl2ZV9taWdyYXRlKHZvaWQgKmFyZykKK3sKKwlzdHJ1Y3QgaW50ZWxfbWlncmF0
ZSAqbSA9IGFyZzsKKwlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSA9IG0tPmNlLT5lbmdp
bmUtPmk5MTU7CisJY29uc3QgdW5zaWduZWQgaW50IHNpemVzW10gPSB7CisJCVNaXzRLLAorCQlT
Wl82NEssCisJCVNaXzJNLAorCQlTWl82NE0sCisJCS8vU1pfMkcsCisJfTsKKwlpbnQgZXJyID0g
MDsKKwlpbnQgaSwgajsKKworCWZvciAoaSA9IDA7IGkgPCBBUlJBWV9TSVpFKHNpemVzKTsgaSsr
KSB7CisJCXN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpzcmMsICpkc3Q7CisJCXN0cnVjdCBp
OTE1X3JlcXVlc3QgKnJxOworCQl1MzIgKnZhZGRyOworCisJCXNyYyA9IGk5MTVfZ2VtX29iamVj
dF9jcmVhdGVfaW50ZXJuYWwoaTkxNSwgc2l6ZXNbaV0pOworCQlpZiAoSVNfRVJSKHNyYykpCisJ
CQlicmVhazsKKworCQl2YWRkciA9IGk5MTVfZ2VtX29iamVjdF9waW5fbWFwKHNyYywgSTkxNV9N
QVBfV0MpOworCQlpZiAoSVNfRVJSKHZhZGRyKSkgeworCQkJaTkxNV9nZW1fb2JqZWN0X3B1dChz
cmMpOworCQkJYnJlYWs7CisJCX0KKworCQlmb3IgKGogPSAwOyBqIDwgc2l6ZXNbaV0gLyBzaXpl
b2YodTMyKTsgaisrKQorCQkJdmFkZHJbal0gPSBqOworCQlpOTE1X2dlbV9vYmplY3RfZmx1c2hf
bWFwKHNyYyk7CisKKwkJZHN0ID0gaTkxNV9nZW1fb2JqZWN0X2NyZWF0ZV9pbnRlcm5hbChpOTE1
LCBzaXplc1tpXSk7CisJCWlmIChJU19FUlIoZHN0KSkgeworCQkJaTkxNV9nZW1fb2JqZWN0X3B1
dChkc3QpOworCQkJYnJlYWs7CisJCX0KKworCQl2YWRkciA9IGk5MTVfZ2VtX29iamVjdF9waW5f
bWFwKGRzdCwgSTkxNV9NQVBfV0MpOworCQlpZiAoSVNfRVJSKHZhZGRyKSkgeworCQkJaTkxNV9n
ZW1fb2JqZWN0X3B1dChkc3QpOworCQkJaTkxNV9nZW1fb2JqZWN0X3B1dChzcmMpOworCQkJYnJl
YWs7CisJCX0KKworCQlmb3IgKGogPSAwOyBqIDwgc2l6ZXNbaV0gLyBzaXplb2YodTMyKTsgaisr
KQorCQkJdmFkZHJbal0gPSB+ajsKKwkJaTkxNV9nZW1fb2JqZWN0X2ZsdXNoX21hcChkc3QpOwor
CisJCXJxID0gaW50ZWxfbWlncmF0ZV9wYWdlcyhtLAorCQkJCQkgc3JjLT5tbS5wYWdlcy0+c2ds
LAorCQkJCQkgZHN0LT5tbS5wYWdlcy0+c2dsKTsKKwkJaWYgKElTX0VSUihycSkpIHsKKwkJCXBy
X2VycigiTWlncmF0aW9uIGZhaWxlZCwgc2l6ZTogJXVcbiIsIHNpemVzW2ldKTsKKwkJCWVyciA9
IFBUUl9FUlIocnEpOworCQl9CisKKwkJaWYgKGk5MTVfcmVxdWVzdF93YWl0KHJxLCAwLCBIWikg
PCAwKSB7CisJCQlwcl9lcnIoIk1pZ3JhdGlvbiB0aW1lZCBvdXQsIHNpemU6ICV1XG4iLCBzaXpl
c1tpXSk7CisJCQllcnIgPSAtRVRJTUU7CisJCX0KKwkJaTkxNV9yZXF1ZXN0X3B1dChycSk7CisK
KwkJZm9yIChqID0gMDsgaiA8IHNpemVzW2ldIC8gc2l6ZW9mKHUzMik7IGorKykgeworCQkJaWYg
KHZhZGRyW2pdICE9IGopIHsKKwkJCQlwcl9lcnIoIkNvcHkgZmFpbGVkLCBzaXplOiAldSwgb2Zm
c2V0OiAlenVcbiIsCisJCQkJICAgICAgIHNpemVzW2ldLCBqICogc2l6ZW9mKHUzMikpOworCQkJ
CWlndF9oZXhkdW1wKHZhZGRyICsgcm91bmRfZG93bihqLCAxMDI0KSwgNDA5Nik7CisJCQkJZXJy
ID0gLUVJTlZBTDsKKwkJCQlicmVhazsKKwkJCX0KKwkJfQorCisJCWk5MTVfZ2VtX29iamVjdF9w
dXQoZHN0KTsKKwkJaTkxNV9nZW1fb2JqZWN0X3B1dChzcmMpOworCQlpOTE1X2dlbV9kcmFpbl9m
cmVlZF9vYmplY3RzKGk5MTUpOworCQlpZiAoZXJyKQorCQkJYnJlYWs7CisJfQorCisJcmV0dXJu
IGVycjsKK30KKworaW50IGludGVsX21pZ3JhdGVfbGl2ZV9zZWxmdGVzdHMoc3RydWN0IGRybV9p
OTE1X3ByaXZhdGUgKmk5MTUpCit7CisJc3RhdGljIGNvbnN0IHN0cnVjdCBpOTE1X3N1YnRlc3Qg
dGVzdHNbXSA9IHsKKwkJU1VCVEVTVChsaXZlX21pZ3JhdGUpLAorCX07CisJc3RydWN0IGludGVs
X21pZ3JhdGUgbTsKKwlpbnQgZXJyOworCisJaWYgKGludGVsX21pZ3JhdGVfaW5pdCgmbSwgJmk5
MTUtPmd0KSkKKwkJcmV0dXJuIDA7CisKKwllcnIgPSBpOTE1X3N1YnRlc3RzKHRlc3RzLCAmbSk7
CisJaW50ZWxfbWlncmF0ZV9maW5pKCZtKTsKKworCXJldHVybiBlcnI7Cit9CmRpZmYgLS1naXQg
YS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9zZWxmdGVzdHMvaTkxNV9saXZlX3NlbGZ0ZXN0cy5oIGIv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvc2VsZnRlc3RzL2k5MTVfbGl2ZV9zZWxmdGVzdHMuaAppbmRl
eCBhOTJjMGU5YjdlNmIuLmJlNWUwMTkxZWFlYSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJt
L2k5MTUvc2VsZnRlc3RzL2k5MTVfbGl2ZV9zZWxmdGVzdHMuaAorKysgYi9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9zZWxmdGVzdHMvaTkxNV9saXZlX3NlbGZ0ZXN0cy5oCkBAIC0yNiw2ICsyNiw3IEBA
IHNlbGZ0ZXN0KGd0X21vY3MsIGludGVsX21vY3NfbGl2ZV9zZWxmdGVzdHMpCiBzZWxmdGVzdChn
dF9wbSwgaW50ZWxfZ3RfcG1fbGl2ZV9zZWxmdGVzdHMpCiBzZWxmdGVzdChndF9oZWFydGJlYXQs
IGludGVsX2hlYXJ0YmVhdF9saXZlX3NlbGZ0ZXN0cykKIHNlbGZ0ZXN0KHJlcXVlc3RzLCBpOTE1
X3JlcXVlc3RfbGl2ZV9zZWxmdGVzdHMpCitzZWxmdGVzdChtaWdyYXRlLCBpbnRlbF9taWdyYXRl
X2xpdmVfc2VsZnRlc3RzKQogc2VsZnRlc3QoYWN0aXZlLCBpOTE1X2FjdGl2ZV9saXZlX3NlbGZ0
ZXN0cykKIHNlbGZ0ZXN0KG9iamVjdHMsIGk5MTVfZ2VtX29iamVjdF9saXZlX3NlbGZ0ZXN0cykK
IHNlbGZ0ZXN0KG1tYW4sIGk5MTVfZ2VtX21tYW5fbGl2ZV9zZWxmdGVzdHMpCi0tIAoyLjIwLjEK
Cl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCkludGVsLWdm
eCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xp
c3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWdmeAo=

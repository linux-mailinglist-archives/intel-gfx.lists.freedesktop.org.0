Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 480AF45560
	for <lists+intel-gfx@lfdr.de>; Fri, 14 Jun 2019 09:11:09 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 8E00989369;
	Fri, 14 Jun 2019 07:10:59 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 9F3B88935B
 for <intel-gfx@lists.freedesktop.org>; Fri, 14 Jun 2019 07:10:44 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 16897546-1500050 
 for multiple; Fri, 14 Jun 2019 08:10:42 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Fri, 14 Jun 2019 08:10:19 +0100
Message-Id: <20190614071023.17929-36-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190614071023.17929-1-chris@chris-wilson.co.uk>
References: <20190614071023.17929-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 35/39] drm/i915: Pin pages before waiting
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SW4gb3JkZXIgdG8gYWxsb3cgZm9yIGFzeW5jaHJvbm91cyBnYXRoZXJpbmcgb2YgcGFnZXMgdHJh
Y2tlZCBieSB0aGUKb2JqLT5yZXN2LCB3ZSB0YWtlIGFkdmFudGFnZSBvZiBwaW5uaW5nIHRoZSBw
YWdlcyBiZWZvcmUgZG9pbmcgd2FpdGluZwpvbiB0aGUgcmVzZXJ2YXRpb24sIGFuZCB3aGVyZSBw
b3NzaWJsZSBkbyBhbiBlYXJseSB3YWl0IGJlZm9yZSBhY3F1aXJpbmcKdGhlIG9iamVjdCBsb2Nr
ICh3aXRoIGEgZm9sbG93IHVwIGxvY2tlZCB3YWl0ZWQgdG8gZW5zdXJlIHdlIGhhdmUKZXhjbHVz
aXZlIGFjY2VzcyB3aGVyZSBuZWNlc3NhcnkpLgoKU2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29u
IDxjaHJpc0BjaHJpcy13aWxzb24uY28udWs+Ci0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2Vt
L2k5MTVfZ2VtX2RtYWJ1Zi5jIHwgICA0ICstCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkx
NV9nZW1fZG9tYWluLmMgfCAxMDQgKysrKysrKysrKystLS0tLS0tLS0tCiBkcml2ZXJzL2dwdS9k
cm0vaTkxNS9pOTE1X2dlbS5jICAgICAgICAgICAgfCAgMjIgKysrLS0KIDMgZmlsZXMgY2hhbmdl
ZCwgNjggaW5zZXJ0aW9ucygrKSwgNjIgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2RtYWJ1Zi5jIGIvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ2VtL2k5MTVfZ2VtX2RtYWJ1Zi5jCmluZGV4IGE5M2UyMzNjZmFhOS4uODQ5OTJkNTkwZGE1
IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fZG1hYnVmLmMK
KysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2RtYWJ1Zi5jCkBAIC0xNTQs
NyArMTU0LDcgQEAgc3RhdGljIGludCBpOTE1X2dlbV9iZWdpbl9jcHVfYWNjZXNzKHN0cnVjdCBk
bWFfYnVmICpkbWFfYnVmLCBlbnVtIGRtYV9kYXRhX2RpcmUKIAlib29sIHdyaXRlID0gKGRpcmVj
dGlvbiA9PSBETUFfQklESVJFQ1RJT05BTCB8fCBkaXJlY3Rpb24gPT0gRE1BX1RPX0RFVklDRSk7
CiAJaW50IGVycjsKIAotCWVyciA9IGk5MTVfZ2VtX29iamVjdF9waW5fcGFnZXMob2JqKTsKKwll
cnIgPSBpOTE1X2dlbV9vYmplY3RfcGluX3BhZ2VzX2FzeW5jKG9iaik7CiAJaWYgKGVycikKIAkJ
cmV0dXJuIGVycjsKIApAQCAtMTc1LDcgKzE3NSw3IEBAIHN0YXRpYyBpbnQgaTkxNV9nZW1fZW5k
X2NwdV9hY2Nlc3Moc3RydWN0IGRtYV9idWYgKmRtYV9idWYsIGVudW0gZG1hX2RhdGFfZGlyZWN0
CiAJc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiA9IGRtYV9idWZfdG9fb2JqKGRtYV9i
dWYpOwogCWludCBlcnI7CiAKLQllcnIgPSBpOTE1X2dlbV9vYmplY3RfcGluX3BhZ2VzKG9iaik7
CisJZXJyID0gaTkxNV9nZW1fb2JqZWN0X3Bpbl9wYWdlc19hc3luYyhvYmopOwogCWlmIChlcnIp
CiAJCXJldHVybiBlcnI7CiAKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9p
OTE1X2dlbV9kb21haW4uYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9kb21h
aW4uYwppbmRleCBmOTA0NGJiZGQ0MjkuLmJkYTk5MDExMzEyNCAxMDA2NDQKLS0tIGEvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2RvbWFpbi5jCisrKyBiL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2dlbS9pOTE1X2dlbV9kb21haW4uYwpAQCAtNDksMTcgKzQ5LDExIEBAIGk5MTVfZ2Vt
X29iamVjdF9zZXRfdG9fd2NfZG9tYWluKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmos
IGJvb2wgd3JpdGUpCiAKIAlhc3NlcnRfb2JqZWN0X2hlbGQob2JqKTsKIAotCXJldCA9IGk5MTVf
Z2VtX29iamVjdF93YWl0KG9iaiwKLQkJCQkgICBJOTE1X1dBSVRfSU5URVJSVVBUSUJMRSB8Ci0J
CQkJICAgKHdyaXRlID8gSTkxNV9XQUlUX0FMTCA6IDApLAotCQkJCSAgIE1BWF9TQ0hFRFVMRV9U
SU1FT1VUKTsKLQlpZiAocmV0KQotCQlyZXR1cm4gcmV0OwotCiAJaWYgKG9iai0+d3JpdGVfZG9t
YWluID09IEk5MTVfR0VNX0RPTUFJTl9XQykKIAkJcmV0dXJuIDA7CiAKLQkvKiBGbHVzaCBhbmQg
YWNxdWlyZSBvYmotPnBhZ2VzIHNvIHRoYXQgd2UgYXJlIGNvaGVyZW50IHRocm91Z2gKKwkvKgor
CSAqIEZsdXNoIGFuZCBhY3F1aXJlIG9iai0+cGFnZXMgc28gdGhhdCB3ZSBhcmUgY29oZXJlbnQg
dGhyb3VnaAogCSAqIGRpcmVjdCBhY2Nlc3MgaW4gbWVtb3J5IHdpdGggcHJldmlvdXMgY2FjaGVk
IHdyaXRlcyB0aHJvdWdoCiAJICogc2htZW1mcyBhbmQgdGhhdCBvdXIgY2FjaGUgZG9tYWluIHRy
YWNraW5nIHJlbWFpbnMgdmFsaWQuCiAJICogRm9yIGV4YW1wbGUsIGlmIHRoZSBvYmotPmZpbHAg
d2FzIG1vdmVkIHRvIHN3YXAgd2l0aG91dCB1cwpAQCAtNjcsMTAgKzYxLDE3IEBAIGk5MTVfZ2Vt
X29iamVjdF9zZXRfdG9fd2NfZG9tYWluKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmos
IGJvb2wgd3JpdGUpCiAJICogY29udGludWUgdG8gYXNzdW1lIHRoYXQgdGhlIG9iaiByZW1haW5l
ZCBvdXQgb2YgdGhlIENQVSBjYWNoZWQKIAkgKiBkb21haW4uCiAJICovCi0JcmV0ID0gaTkxNV9n
ZW1fb2JqZWN0X3Bpbl9wYWdlcyhvYmopOworCXJldCA9IGk5MTVfZ2VtX29iamVjdF9waW5fcGFn
ZXNfYXN5bmMob2JqKTsKIAlpZiAocmV0KQogCQlyZXR1cm4gcmV0OwogCisJcmV0ID0gaTkxNV9n
ZW1fb2JqZWN0X3dhaXQob2JqLAorCQkJCSAgIEk5MTVfV0FJVF9JTlRFUlJVUFRJQkxFIHwKKwkJ
CQkgICAod3JpdGUgPyBJOTE1X1dBSVRfQUxMIDogMCksCisJCQkJICAgTUFYX1NDSEVEVUxFX1RJ
TUVPVVQpOworCWlmIChyZXQpCisJCWdvdG8gb3V0X3VucGluOworCiAJaTkxNV9nZW1fb2JqZWN0
X2ZsdXNoX3dyaXRlX2RvbWFpbihvYmosIH5JOTE1X0dFTV9ET01BSU5fV0MpOwogCiAJLyogU2Vy
aWFsaXNlIGRpcmVjdCBhY2Nlc3MgdG8gdGhpcyBvYmplY3Qgd2l0aCB0aGUgYmFycmllcnMgZm9y
CkBAIC05MSw4ICs5Miw5IEBAIGk5MTVfZ2VtX29iamVjdF9zZXRfdG9fd2NfZG9tYWluKHN0cnVj
dCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmosIGJvb2wgd3JpdGUpCiAJCW9iai0+bW0uZGlydHkg
PSB0cnVlOwogCX0KIAorb3V0X3VucGluOgogCWk5MTVfZ2VtX29iamVjdF91bnBpbl9wYWdlcyhv
YmopOwotCXJldHVybiAwOworCXJldHVybiByZXQ7CiB9CiAKIC8qKgpAQCAtMTEwLDE3ICsxMTIs
MTEgQEAgaTkxNV9nZW1fb2JqZWN0X3NldF90b19ndHRfZG9tYWluKHN0cnVjdCBkcm1faTkxNV9n
ZW1fb2JqZWN0ICpvYmosIGJvb2wgd3JpdGUpCiAKIAlhc3NlcnRfb2JqZWN0X2hlbGQob2JqKTsK
IAotCXJldCA9IGk5MTVfZ2VtX29iamVjdF93YWl0KG9iaiwKLQkJCQkgICBJOTE1X1dBSVRfSU5U
RVJSVVBUSUJMRSB8Ci0JCQkJICAgKHdyaXRlID8gSTkxNV9XQUlUX0FMTCA6IDApLAotCQkJCSAg
IE1BWF9TQ0hFRFVMRV9USU1FT1VUKTsKLQlpZiAocmV0KQotCQlyZXR1cm4gcmV0OwotCiAJaWYg
KG9iai0+d3JpdGVfZG9tYWluID09IEk5MTVfR0VNX0RPTUFJTl9HVFQpCiAJCXJldHVybiAwOwog
Ci0JLyogRmx1c2ggYW5kIGFjcXVpcmUgb2JqLT5wYWdlcyBzbyB0aGF0IHdlIGFyZSBjb2hlcmVu
dCB0aHJvdWdoCisJLyoKKwkgKiBGbHVzaCBhbmQgYWNxdWlyZSBvYmotPnBhZ2VzIHNvIHRoYXQg
d2UgYXJlIGNvaGVyZW50IHRocm91Z2gKIAkgKiBkaXJlY3QgYWNjZXNzIGluIG1lbW9yeSB3aXRo
IHByZXZpb3VzIGNhY2hlZCB3cml0ZXMgdGhyb3VnaAogCSAqIHNobWVtZnMgYW5kIHRoYXQgb3Vy
IGNhY2hlIGRvbWFpbiB0cmFja2luZyByZW1haW5zIHZhbGlkLgogCSAqIEZvciBleGFtcGxlLCBp
ZiB0aGUgb2JqLT5maWxwIHdhcyBtb3ZlZCB0byBzd2FwIHdpdGhvdXQgdXMKQEAgLTEyOCwxMCAr
MTI0LDE3IEBAIGk5MTVfZ2VtX29iamVjdF9zZXRfdG9fZ3R0X2RvbWFpbihzdHJ1Y3QgZHJtX2k5
MTVfZ2VtX29iamVjdCAqb2JqLCBib29sIHdyaXRlKQogCSAqIGNvbnRpbnVlIHRvIGFzc3VtZSB0
aGF0IHRoZSBvYmogcmVtYWluZWQgb3V0IG9mIHRoZSBDUFUgY2FjaGVkCiAJICogZG9tYWluLgog
CSAqLwotCXJldCA9IGk5MTVfZ2VtX29iamVjdF9waW5fcGFnZXMob2JqKTsKKwlyZXQgPSBpOTE1
X2dlbV9vYmplY3RfcGluX3BhZ2VzX2FzeW5jKG9iaik7CiAJaWYgKHJldCkKIAkJcmV0dXJuIHJl
dDsKIAorCXJldCA9IGk5MTVfZ2VtX29iamVjdF93YWl0KG9iaiwKKwkJCQkgICBJOTE1X1dBSVRf
SU5URVJSVVBUSUJMRSB8CisJCQkJICAgKHdyaXRlID8gSTkxNV9XQUlUX0FMTCA6IDApLAorCQkJ
CSAgIE1BWF9TQ0hFRFVMRV9USU1FT1VUKTsKKwlpZiAocmV0KQorCQlnb3RvIG91dF91bnBpbjsK
KwogCWk5MTVfZ2VtX29iamVjdF9mbHVzaF93cml0ZV9kb21haW4ob2JqLCB+STkxNV9HRU1fRE9N
QUlOX0dUVCk7CiAKIAkvKiBTZXJpYWxpc2UgZGlyZWN0IGFjY2VzcyB0byB0aGlzIG9iamVjdCB3
aXRoIHRoZSBiYXJyaWVycyBmb3IKQEAgLTE1Miw4ICsxNTUsOSBAQCBpOTE1X2dlbV9vYmplY3Rf
c2V0X3RvX2d0dF9kb21haW4oc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiwgYm9vbCB3
cml0ZSkKIAkJb2JqLT5tbS5kaXJ0eSA9IHRydWU7CiAJfQogCitvdXRfdW5waW46CiAJaTkxNV9n
ZW1fb2JqZWN0X3VucGluX3BhZ2VzKG9iaik7Ci0JcmV0dXJuIDA7CisJcmV0dXJuIHJldDsKIH0K
IAogLyoqCkBAIC02MDMsMTkgKzYwNyw2IEBAIGk5MTVfZ2VtX3NldF9kb21haW5faW9jdGwoc3Ry
dWN0IGRybV9kZXZpY2UgKmRldiwgdm9pZCAqZGF0YSwKIAkJZ290byBvdXQ7CiAJfQogCi0JLyoK
LQkgKiBUcnkgdG8gZmx1c2ggdGhlIG9iamVjdCBvZmYgdGhlIEdQVSB3aXRob3V0IGhvbGRpbmcg
dGhlIGxvY2suCi0JICogV2Ugd2lsbCByZXBlYXQgdGhlIGZsdXNoIGhvbGRpbmcgdGhlIGxvY2sg
aW4gdGhlIG5vcm1hbCBtYW5uZXIKLQkgKiB0byBjYXRjaCBjYXNlcyB3aGVyZSB3ZSBhcmUgZ2F6
dW1wZWQuCi0JICovCi0JZXJyID0gaTkxNV9nZW1fb2JqZWN0X3dhaXQob2JqLAotCQkJCSAgIEk5
MTVfV0FJVF9JTlRFUlJVUFRJQkxFIHwKLQkJCQkgICBJOTE1X1dBSVRfUFJJT1JJVFkgfAotCQkJ
CSAgICh3cml0ZV9kb21haW4gPyBJOTE1X1dBSVRfQUxMIDogMCksCi0JCQkJICAgTUFYX1NDSEVE
VUxFX1RJTUVPVVQpOwotCWlmIChlcnIpCi0JCWdvdG8gb3V0OwotCiAJLyoKIAkgKiBQcm94eSBv
YmplY3RzIGRvIG5vdCBjb250cm9sIGFjY2VzcyB0byB0aGUgYmFja2luZyBzdG9yYWdlLCBlcmdv
CiAJICogdGhleSBjYW5ub3QgYmUgdXNlZCBhcyBhIG1lYW5zIHRvIG1hbmlwdWxhdGUgdGhlIGNh
Y2hlIGRvbWFpbgpAQCAtNjM2LDEwICs2MjcsMjMgQEAgaTkxNV9nZW1fc2V0X2RvbWFpbl9pb2N0
bChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LCB2b2lkICpkYXRhLAogCSAqIGNvbnRpbnVlIHRvIGFz
c3VtZSB0aGF0IHRoZSBvYmogcmVtYWluZWQgb3V0IG9mIHRoZSBDUFUgY2FjaGVkCiAJICogZG9t
YWluLgogCSAqLwotCWVyciA9IGk5MTVfZ2VtX29iamVjdF9waW5fcGFnZXMob2JqKTsKKwllcnIg
PSBpOTE1X2dlbV9vYmplY3RfcGluX3BhZ2VzX2FzeW5jKG9iaik7CiAJaWYgKGVycikKIAkJZ290
byBvdXQ7CiAKKwkvKgorCSAqIFRyeSB0byBmbHVzaCB0aGUgb2JqZWN0IG9mZiB0aGUgR1BVIHdp
dGhvdXQgaG9sZGluZyB0aGUgbG9jay4KKwkgKiBXZSB3aWxsIHJlcGVhdCB0aGUgZmx1c2ggaG9s
ZGluZyB0aGUgbG9jayBpbiB0aGUgbm9ybWFsIG1hbm5lcgorCSAqIHRvIGNhdGNoIGNhc2VzIHdo
ZXJlIHdlIGFyZSBnYXp1bXBlZC4KKwkgKi8KKwllcnIgPSBpOTE1X2dlbV9vYmplY3Rfd2FpdChv
YmosCisJCQkJICAgSTkxNV9XQUlUX0lOVEVSUlVQVElCTEUgfAorCQkJCSAgIEk5MTVfV0FJVF9Q
UklPUklUWSB8CisJCQkJICAgKHdyaXRlX2RvbWFpbiA/IEk5MTVfV0FJVF9BTEwgOiAwKSwKKwkJ
CQkgICBNQVhfU0NIRURVTEVfVElNRU9VVCk7CisJaWYgKGVycikKKwkJZ290byBvdXRfdW5waW47
CisKIAllcnIgPSBpOTE1X2dlbV9vYmplY3RfbG9ja19pbnRlcnJ1cHRpYmxlKG9iaik7CiAJaWYg
KGVycikKIAkJZ290byBvdXRfdW5waW47CkBAIC02ODAsMjUgKzY4NCwyNSBAQCBpbnQgaTkxNV9n
ZW1fb2JqZWN0X3ByZXBhcmVfcmVhZChzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqLAog
CWlmICghaTkxNV9nZW1fb2JqZWN0X2hhc19zdHJ1Y3RfcGFnZShvYmopKQogCQlyZXR1cm4gLUVO
T0RFVjsKIAotCXJldCA9IGk5MTVfZ2VtX29iamVjdF9sb2NrX2ludGVycnVwdGlibGUob2JqKTsK
KwlyZXQgPSBpOTE1X2dlbV9vYmplY3RfcGluX3BhZ2VzX2FzeW5jKG9iaik7CiAJaWYgKHJldCkK
IAkJcmV0dXJuIHJldDsKIAorCXJldCA9IGk5MTVfZ2VtX29iamVjdF9sb2NrX2ludGVycnVwdGli
bGUob2JqKTsKKwlpZiAocmV0KQorCQlnb3RvIGVycl91bnBpbjsKKwogCXJldCA9IGk5MTVfZ2Vt
X29iamVjdF93YWl0KG9iaiwKIAkJCQkgICBJOTE1X1dBSVRfSU5URVJSVVBUSUJMRSwKIAkJCQkg
ICBNQVhfU0NIRURVTEVfVElNRU9VVCk7CiAJaWYgKHJldCkKIAkJZ290byBlcnJfdW5sb2NrOwog
Ci0JcmV0ID0gaTkxNV9nZW1fb2JqZWN0X3Bpbl9wYWdlcyhvYmopOwotCWlmIChyZXQpCi0JCWdv
dG8gZXJyX3VubG9jazsKLQogCWlmIChvYmotPmNhY2hlX2NvaGVyZW50ICYgSTkxNV9CT19DQUNI
RV9DT0hFUkVOVF9GT1JfUkVBRCB8fAogCSAgICAhc3RhdGljX2NwdV9oYXMoWDg2X0ZFQVRVUkVf
Q0xGTFVTSCkpIHsKIAkJcmV0ID0gaTkxNV9nZW1fb2JqZWN0X3NldF90b19jcHVfZG9tYWluKG9i
aiwgZmFsc2UpOwogCQlpZiAocmV0KQotCQkJZ290byBlcnJfdW5waW47CisJCQlnb3RvIGVycl91
bmxvY2s7CiAJCWVsc2UKIAkJCWdvdG8gb3V0OwogCX0KQEAgLTcxOCwxMCArNzIyLDEwIEBAIGlu
dCBpOTE1X2dlbV9vYmplY3RfcHJlcGFyZV9yZWFkKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0
ICpvYmosCiAJLyogcmV0dXJuIHdpdGggdGhlIHBhZ2VzIHBpbm5lZCAqLwogCXJldHVybiAwOwog
Ci1lcnJfdW5waW46Ci0JaTkxNV9nZW1fb2JqZWN0X3VucGluX3BhZ2VzKG9iaik7CiBlcnJfdW5s
b2NrOgogCWk5MTVfZ2VtX29iamVjdF91bmxvY2sob2JqKTsKK2Vycl91bnBpbjoKKwlpOTE1X2dl
bV9vYmplY3RfdW5waW5fcGFnZXMob2JqKTsKIAlyZXR1cm4gcmV0OwogfQogCkBAIC03MzQsMTAg
KzczOCwxNCBAQCBpbnQgaTkxNV9nZW1fb2JqZWN0X3ByZXBhcmVfd3JpdGUoc3RydWN0IGRybV9p
OTE1X2dlbV9vYmplY3QgKm9iaiwKIAlpZiAoIWk5MTVfZ2VtX29iamVjdF9oYXNfc3RydWN0X3Bh
Z2Uob2JqKSkKIAkJcmV0dXJuIC1FTk9ERVY7CiAKLQlyZXQgPSBpOTE1X2dlbV9vYmplY3RfbG9j
a19pbnRlcnJ1cHRpYmxlKG9iaik7CisJcmV0ID0gaTkxNV9nZW1fb2JqZWN0X3Bpbl9wYWdlc19h
c3luYyhvYmopOwogCWlmIChyZXQpCiAJCXJldHVybiByZXQ7CiAKKwlyZXQgPSBpOTE1X2dlbV9v
YmplY3RfbG9ja19pbnRlcnJ1cHRpYmxlKG9iaik7CisJaWYgKHJldCkKKwkJZ290byBlcnJfdW5w
aW47CisKIAlyZXQgPSBpOTE1X2dlbV9vYmplY3Rfd2FpdChvYmosCiAJCQkJICAgSTkxNV9XQUlU
X0lOVEVSUlVQVElCTEUgfAogCQkJCSAgIEk5MTVfV0FJVF9BTEwsCkBAIC03NDUsMTUgKzc1Mywx
MSBAQCBpbnQgaTkxNV9nZW1fb2JqZWN0X3ByZXBhcmVfd3JpdGUoc3RydWN0IGRybV9pOTE1X2dl
bV9vYmplY3QgKm9iaiwKIAlpZiAocmV0KQogCQlnb3RvIGVycl91bmxvY2s7CiAKLQlyZXQgPSBp
OTE1X2dlbV9vYmplY3RfcGluX3BhZ2VzKG9iaik7Ci0JaWYgKHJldCkKLQkJZ290byBlcnJfdW5s
b2NrOwotCiAJaWYgKG9iai0+Y2FjaGVfY29oZXJlbnQgJiBJOTE1X0JPX0NBQ0hFX0NPSEVSRU5U
X0ZPUl9XUklURSB8fAogCSAgICAhc3RhdGljX2NwdV9oYXMoWDg2X0ZFQVRVUkVfQ0xGTFVTSCkp
IHsKIAkJcmV0ID0gaTkxNV9nZW1fb2JqZWN0X3NldF90b19jcHVfZG9tYWluKG9iaiwgdHJ1ZSk7
CiAJCWlmIChyZXQpCi0JCQlnb3RvIGVycl91bnBpbjsKKwkJCWdvdG8gZXJyX3VubG9jazsKIAkJ
ZWxzZQogCQkJZ290byBvdXQ7CiAJfQpAQCAtNzgyLDkgKzc4Niw5IEBAIGludCBpOTE1X2dlbV9v
YmplY3RfcHJlcGFyZV93cml0ZShzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqLAogCS8q
IHJldHVybiB3aXRoIHRoZSBwYWdlcyBwaW5uZWQgKi8KIAlyZXR1cm4gMDsKIAotZXJyX3VucGlu
OgotCWk5MTVfZ2VtX29iamVjdF91bnBpbl9wYWdlcyhvYmopOwogZXJyX3VubG9jazoKIAlpOTE1
X2dlbV9vYmplY3RfdW5sb2NrKG9iaik7CitlcnJfdW5waW46CisJaTkxNV9nZW1fb2JqZWN0X3Vu
cGluX3BhZ2VzKG9iaik7CiAJcmV0dXJuIHJldDsKIH0KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L2k5MTVfZ2VtLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbS5jCmlu
ZGV4IDllODM1MzU1ZWI5My4uMjE0MTZiODc5MDVlIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9pOTE1X2dlbS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtLmMK
QEAgLTUxMiwyMCArNTEyLDIxIEBAIGk5MTVfZ2VtX3ByZWFkX2lvY3RsKHN0cnVjdCBkcm1fZGV2
aWNlICpkZXYsIHZvaWQgKmRhdGEsCiAKIAl0cmFjZV9pOTE1X2dlbV9vYmplY3RfcHJlYWQob2Jq
LCBhcmdzLT5vZmZzZXQsIGFyZ3MtPnNpemUpOwogCi0JcmV0ID0gaTkxNV9nZW1fb2JqZWN0X3dh
aXQob2JqLAotCQkJCSAgIEk5MTVfV0FJVF9JTlRFUlJVUFRJQkxFLAotCQkJCSAgIE1BWF9TQ0hF
RFVMRV9USU1FT1VUKTsKKwlyZXQgPSBpOTE1X2dlbV9vYmplY3RfcGluX3BhZ2VzX2FzeW5jKG9i
aik7CiAJaWYgKHJldCkKIAkJZ290byBvdXQ7CiAKLQlyZXQgPSBpOTE1X2dlbV9vYmplY3RfcGlu
X3BhZ2VzKG9iaik7CisJcmV0ID0gaTkxNV9nZW1fb2JqZWN0X3dhaXQob2JqLAorCQkJCSAgIEk5
MTVfV0FJVF9JTlRFUlJVUFRJQkxFLAorCQkJCSAgIE1BWF9TQ0hFRFVMRV9USU1FT1VUKTsKIAlp
ZiAocmV0KQotCQlnb3RvIG91dDsKKwkJZ290byBvdXRfdW5waW47CiAKIAlyZXQgPSBpOTE1X2dl
bV9zaG1lbV9wcmVhZChvYmosIGFyZ3MpOwogCWlmIChyZXQgPT0gLUVGQVVMVCB8fCByZXQgPT0g
LUVOT0RFVikKIAkJcmV0ID0gaTkxNV9nZW1fZ3R0X3ByZWFkKG9iaiwgYXJncyk7CiAKK291dF91
bnBpbjoKIAlpOTE1X2dlbV9vYmplY3RfdW5waW5fcGFnZXMob2JqKTsKIG91dDoKIAlpOTE1X2dl
bV9vYmplY3RfcHV0KG9iaik7CkBAIC04MTIsMTYgKzgxMywxNiBAQCBpOTE1X2dlbV9wd3JpdGVf
aW9jdGwoc3RydWN0IGRybV9kZXZpY2UgKmRldiwgdm9pZCAqZGF0YSwKIAlpZiAocmV0ICE9IC1F
Tk9ERVYpCiAJCWdvdG8gZXJyOwogCisJcmV0ID0gaTkxNV9nZW1fb2JqZWN0X3Bpbl9wYWdlc19h
c3luYyhvYmopOworCWlmIChyZXQpCisJCWdvdG8gZXJyOworCiAJcmV0ID0gaTkxNV9nZW1fb2Jq
ZWN0X3dhaXQob2JqLAogCQkJCSAgIEk5MTVfV0FJVF9JTlRFUlJVUFRJQkxFIHwKIAkJCQkgICBJ
OTE1X1dBSVRfQUxMLAogCQkJCSAgIE1BWF9TQ0hFRFVMRV9USU1FT1VUKTsKIAlpZiAocmV0KQot
CQlnb3RvIGVycjsKLQotCXJldCA9IGk5MTVfZ2VtX29iamVjdF9waW5fcGFnZXMob2JqKTsKLQlp
ZiAocmV0KQotCQlnb3RvIGVycjsKKwkJZ290byBlcnJfdW5waW47CiAKIAlyZXQgPSAtRUZBVUxU
OwogCS8qIFdlIGNhbiBvbmx5IGRvIHRoZSBHVFQgcHdyaXRlIG9uIHVudGlsZWQgYnVmZmVycywg
YXMgb3RoZXJ3aXNlCkBAIC04NDUsNiArODQ2LDcgQEAgaTkxNV9nZW1fcHdyaXRlX2lvY3RsKHN0
cnVjdCBkcm1fZGV2aWNlICpkZXYsIHZvaWQgKmRhdGEsCiAJCQlyZXQgPSBpOTE1X2dlbV9zaG1l
bV9wd3JpdGUob2JqLCBhcmdzKTsKIAl9CiAKK2Vycl91bnBpbjoKIAlpOTE1X2dlbV9vYmplY3Rf
dW5waW5fcGFnZXMob2JqKTsKIGVycjoKIAlpOTE1X2dlbV9vYmplY3RfcHV0KG9iaik7Ci0tIAoy
LjIwLjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCklu
dGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRw
czovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWdmeA==

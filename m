Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 3B8FA33639
	for <lists+intel-gfx@lfdr.de>; Mon,  3 Jun 2019 19:11:46 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 1DFC189213;
	Mon,  3 Jun 2019 17:11:44 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 97B2E89213
 for <intel-gfx@lists.freedesktop.org>; Mon,  3 Jun 2019 17:11:42 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 16778417-1500050 
 for multiple; Mon, 03 Jun 2019 18:11:34 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon,  3 Jun 2019 18:11:30 +0100
Message-Id: <20190603171130.3186-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH] drm/i915/gtt: Replace struct_mutex
 serialisation for allocation
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Mika Kuoppala <mika.kuoppala@intel.com>,
 Matthew Auld <matthew.auld@intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SW5zdGVhZCBvZiByZWx5aW5nIG9uIHRoZSBjYWxsZXIgaG9sZGluZyBzdHJ1Y3RfbXV0ZXggYWNy
b3NzIHRoZQphbGxvY2F0aW9uLCBwdXNoIHRoZSBhbGxvY2F0aW9uIHVuZGVyIGEgdHJlZSBvZiBz
cGlubG9ja3Mgc3RvcmVkIGluc2lkZQp0aGUgcGFnZSB0YWJsZXMuIE5vdCBvbmx5IHNob3VsZCB0
aGlzIGFsbG93IHVzIHRvIGF2b2lkIHN0cnVjdF9tdXRleApoZXJlLCBidXQgaXQgd2lsbCBhbGxv
dyBtdWx0aXBsZSB1c2VycyB0byBsb2NrIGluZGVwZW5kZW50IHJhbmdlcyBmb3IKY29uY3VycmVu
dCBhbGxvY2F0aW9ucywgYW5kIG9wZXJhdGUgaW5kZXBlbmRlbnRseS4gVGhpcyBpcyB2aXRhbCBm
b3IKcHVzaGluZyB0aGUgR1RUIG1hbmlwdWxhdGlvbiBpbnRvIGEgYmFja2dyb3VuZCB0aHJlYWQg
d2hlcmUgZGVwZW5kZW5jeQpvbiBzdHJ1Y3RfbXV0ZXggaXMgdmVyYm90ZW4sIGFuZCBmb3IgYWxs
b3dpbmcgb3RoZXIgY2FsbGVycyB0byBhdm9pZApzdHJ1Y3RfbXV0ZXggYWx0b2dldGhlci4KClNp
Z25lZC1vZmYtYnk6IENocmlzIFdpbHNvbiA8Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPgpDYzog
TWF0dGhldyBBdWxkIDxtYXR0aGV3LmF1bGRAaW50ZWwuY29tPgpDYzogTWlrYSBLdW9wcGFsYSA8
bWlrYS5rdW9wcGFsYUBpbnRlbC5jb20+Ci0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9n
ZW1fZ3R0LmMgfCAyMTIgKysrKysrKysrKysrKysrKysrKy0tLS0tLS0tLQogZHJpdmVycy9ncHUv
ZHJtL2k5MTUvaTkxNV9nZW1fZ3R0LmggfCAgIDkgKy0KIDIgZmlsZXMgY2hhbmdlZCwgMTUyIGlu
c2VydGlvbnMoKyksIDY5IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2k5MTVfZ2VtX2d0dC5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW1fZ3R0
LmMKaW5kZXggY2E4YTY5ZThiMDk4Li41MDAwYTk5MGRkZjMgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2k5MTVfZ2VtX2d0dC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5
MTVfZ2VtX2d0dC5jCkBAIC02NTUsNyArNjU1LDcgQEAgc3RhdGljIHN0cnVjdCBpOTE1X3BhZ2Vf
dGFibGUgKmFsbG9jX3B0KHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtKQogCQlyZXR1cm4g
RVJSX1BUUigtRU5PTUVNKTsKIAl9CiAKLQlwdC0+dXNlZF9wdGVzID0gMDsKKwlhdG9taWNfc2V0
KCZwdC0+dXNlZF9wdGVzLCAwKTsKIAlyZXR1cm4gcHQ7CiB9CiAKQEAgLTY5MCw3ICs2OTAsOCBA
QCBzdGF0aWMgc3RydWN0IGk5MTVfcGFnZV9kaXJlY3RvcnkgKmFsbG9jX3BkKHN0cnVjdCBpOTE1
X2FkZHJlc3Nfc3BhY2UgKnZtKQogCQlyZXR1cm4gRVJSX1BUUigtRU5PTUVNKTsKIAl9CiAKLQlw
ZC0+dXNlZF9wZGVzID0gMDsKKwlhdG9taWNfc2V0KCZwZC0+dXNlZF9wZGVzLCAwKTsKKwlzcGlu
X2xvY2tfaW5pdCgmcGQtPmxvY2spOwogCXJldHVybiBwZDsKIH0KIApAQCAtNzIxLDYgKzcyMiw4
IEBAIHN0YXRpYyBpbnQgX19wZHBfaW5pdChzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwK
IAogCW1lbXNldF9wKCh2b2lkICoqKXBkcC0+cGFnZV9kaXJlY3RvcnksIHZtLT5zY3JhdGNoX3Bk
LCBwZHBlcyk7CiAKKwlhdG9taWNfc2V0KCZwZHAtPnVzZWRfcGRwZXMsIDApOworCXNwaW5fbG9j
a19pbml0KCZwZHAtPmxvY2spOwogCXJldHVybiAwOwogfQogCkBAIC03NzUsMTEgKzc3OCw4IEBA
IHN0YXRpYyB2b2lkIGZyZWVfcGRwKHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAogc3Rh
dGljIHZvaWQgZ2VuOF9pbml0aWFsaXplX3BkcChzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2
bSwKIAkJCQlzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeV9wb2ludGVyICpwZHApCiB7Ci0JZ2Vu
OF9wcGd0dF9wZHBlX3Qgc2NyYXRjaF9wZHBlOwotCi0Jc2NyYXRjaF9wZHBlID0gZ2VuOF9wZHBl
X2VuY29kZShweF9kbWEodm0tPnNjcmF0Y2hfcGQpLCBJOTE1X0NBQ0hFX0xMQyk7Ci0KLQlmaWxs
X3B4KHZtLCBwZHAsIHNjcmF0Y2hfcGRwZSk7CisJZmlsbF9weCh2bSwgcGRwLAorCQlnZW44X3Bk
cGVfZW5jb2RlKHB4X2RtYSh2bS0+c2NyYXRjaF9wZCksIEk5MTVfQ0FDSEVfTExDKSk7CiB9CiAK
IHN0YXRpYyB2b2lkIGdlbjhfaW5pdGlhbGl6ZV9wbWw0KHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3Bh
Y2UgKnZtLApAQCAtNzg4LDYgKzc4OCw3IEBAIHN0YXRpYyB2b2lkIGdlbjhfaW5pdGlhbGl6ZV9w
bWw0KHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAogCWZpbGxfcHgodm0sIHBtbDQsCiAJ
CWdlbjhfcG1sNGVfZW5jb2RlKHB4X2RtYSh2bS0+c2NyYXRjaF9wZHApLCBJOTE1X0NBQ0hFX0xM
QykpOwogCW1lbXNldF9wKCh2b2lkICoqKXBtbDQtPnBkcHMsIHZtLT5zY3JhdGNoX3BkcCwgR0VO
OF9QTUw0RVNfUEVSX1BNTDQpOworCXNwaW5fbG9ja19pbml0KCZwbWw0LT5sb2NrKTsKIH0KIAog
LyoKQEAgLTgxMSwxNyArODEyLDEyIEBAIHN0YXRpYyBib29sIGdlbjhfcHBndHRfY2xlYXJfcHQo
Y29uc3Qgc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCiAJdW5zaWduZWQgaW50IG51bV9l
bnRyaWVzID0gZ2VuOF9wdGVfY291bnQoc3RhcnQsIGxlbmd0aCk7CiAJZ2VuOF9wdGVfdCAqdmFk
ZHI7CiAKLQlHRU1fQlVHX09OKG51bV9lbnRyaWVzID4gcHQtPnVzZWRfcHRlcyk7Ci0KLQlwdC0+
dXNlZF9wdGVzIC09IG51bV9lbnRyaWVzOwotCWlmICghcHQtPnVzZWRfcHRlcykKLQkJcmV0dXJu
IHRydWU7Ci0KIAl2YWRkciA9IGttYXBfYXRvbWljX3B4KHB0KTsKIAltZW1zZXQ2NCh2YWRkciAr
IGdlbjhfcHRlX2luZGV4KHN0YXJ0KSwgdm0tPnNjcmF0Y2hfcHRlLCBudW1fZW50cmllcyk7CiAJ
a3VubWFwX2F0b21pYyh2YWRkcik7CiAKLQlyZXR1cm4gZmFsc2U7CisJR0VNX0JVR19PTihudW1f
ZW50cmllcyA+IGF0b21pY19yZWFkKCZwdC0+dXNlZF9wdGVzKSk7CisJcmV0dXJuICFhdG9taWNf
c3ViX3JldHVybihudW1fZW50cmllcywgJnB0LT51c2VkX3B0ZXMpOwogfQogCiBzdGF0aWMgdm9p
ZCBnZW44X3BwZ3R0X3NldF9wZGUoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCkBAIC04
MzEsOCArODI3LDYgQEAgc3RhdGljIHZvaWQgZ2VuOF9wcGd0dF9zZXRfcGRlKHN0cnVjdCBpOTE1
X2FkZHJlc3Nfc3BhY2UgKnZtLAogewogCWdlbjhfcGRlX3QgKnZhZGRyOwogCi0JcGQtPnBhZ2Vf
dGFibGVbcGRlXSA9IHB0OwotCiAJdmFkZHIgPSBrbWFwX2F0b21pY19weChwZCk7CiAJdmFkZHJb
cGRlXSA9IGdlbjhfcGRlX2VuY29kZShweF9kbWEocHQpLCBJOTE1X0NBQ0hFX0xMQyk7CiAJa3Vu
bWFwX2F0b21pYyh2YWRkcik7CkBAIC04NDYsMTkgKzg0MCwyOCBAQCBzdGF0aWMgYm9vbCBnZW44
X3BwZ3R0X2NsZWFyX3BkKHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAogCXUzMiBwZGU7
CiAKIAlnZW44X2Zvcl9lYWNoX3BkZShwdCwgcGQsIHN0YXJ0LCBsZW5ndGgsIHBkZSkgeworCQli
b29sIGZyZWUgPSBmYWxzZTsKKwogCQlHRU1fQlVHX09OKHB0ID09IHZtLT5zY3JhdGNoX3B0KTsK
IAogCQlpZiAoIWdlbjhfcHBndHRfY2xlYXJfcHQodm0sIHB0LCBzdGFydCwgbGVuZ3RoKSkKIAkJ
CWNvbnRpbnVlOwogCi0JCWdlbjhfcHBndHRfc2V0X3BkZSh2bSwgcGQsIHZtLT5zY3JhdGNoX3B0
LCBwZGUpOwotCQlHRU1fQlVHX09OKCFwZC0+dXNlZF9wZGVzKTsKLQkJcGQtPnVzZWRfcGRlcy0t
OworCQlzcGluX2xvY2soJnBkLT5sb2NrKTsKKwkJaWYgKCFhdG9taWNfcmVhZCgmcHQtPnVzZWRf
cHRlcykpIHsKKwkJCWdlbjhfcHBndHRfc2V0X3BkZSh2bSwgcGQsIHZtLT5zY3JhdGNoX3B0LCBw
ZGUpOworCQkJcGQtPnBhZ2VfdGFibGVbcGRlXSA9IHZtLT5zY3JhdGNoX3B0OwogCi0JCWZyZWVf
cHQodm0sIHB0KTsKKwkJCUdFTV9CVUdfT04oIWF0b21pY19yZWFkKCZwZC0+dXNlZF9wZGVzKSk7
CisJCQlhdG9taWNfZGVjKCZwZC0+dXNlZF9wZGVzKTsKKwkJCWZyZWUgPSB0cnVlOworCQl9CisJ
CXNwaW5fdW5sb2NrKCZwZC0+bG9jayk7CisJCWlmIChmcmVlKQorCQkJZnJlZV9wdCh2bSwgcHQp
OwogCX0KIAotCXJldHVybiAhcGQtPnVzZWRfcGRlczsKKwlyZXR1cm4gIWF0b21pY19yZWFkKCZw
ZC0+dXNlZF9wZGVzKTsKIH0KIAogc3RhdGljIHZvaWQgZ2VuOF9wcGd0dF9zZXRfcGRwZShzdHJ1
Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKQEAgLTg2OCw3ICs4NzEsNiBAQCBzdGF0aWMgdm9p
ZCBnZW44X3BwZ3R0X3NldF9wZHBlKHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAogewog
CWdlbjhfcHBndHRfcGRwZV90ICp2YWRkcjsKIAotCXBkcC0+cGFnZV9kaXJlY3RvcnlbcGRwZV0g
PSBwZDsKIAlpZiAoIWk5MTVfdm1faXNfNGx2bCh2bSkpCiAJCXJldHVybjsKIApAQCAtODg4LDE5
ICs4OTAsMjggQEAgc3RhdGljIGJvb2wgZ2VuOF9wcGd0dF9jbGVhcl9wZHAoc3RydWN0IGk5MTVf
YWRkcmVzc19zcGFjZSAqdm0sCiAJdW5zaWduZWQgaW50IHBkcGU7CiAKIAlnZW44X2Zvcl9lYWNo
X3BkcGUocGQsIHBkcCwgc3RhcnQsIGxlbmd0aCwgcGRwZSkgeworCQlib29sIGZyZWUgPSBmYWxz
ZTsKKwogCQlHRU1fQlVHX09OKHBkID09IHZtLT5zY3JhdGNoX3BkKTsKIAogCQlpZiAoIWdlbjhf
cHBndHRfY2xlYXJfcGQodm0sIHBkLCBzdGFydCwgbGVuZ3RoKSkKIAkJCWNvbnRpbnVlOwogCi0J
CWdlbjhfcHBndHRfc2V0X3BkcGUodm0sIHBkcCwgdm0tPnNjcmF0Y2hfcGQsIHBkcGUpOwotCQlH
RU1fQlVHX09OKCFwZHAtPnVzZWRfcGRwZXMpOwotCQlwZHAtPnVzZWRfcGRwZXMtLTsKKwkJc3Bp
bl9sb2NrKCZwZHAtPmxvY2spOworCQlpZiAoIWF0b21pY19yZWFkKCZwZC0+dXNlZF9wZGVzKSkg
eworCQkJZ2VuOF9wcGd0dF9zZXRfcGRwZSh2bSwgcGRwLCB2bS0+c2NyYXRjaF9wZCwgcGRwZSk7
CisJCQlwZHAtPnBhZ2VfZGlyZWN0b3J5W3BkcGVdID0gdm0tPnNjcmF0Y2hfcGQ7CiAKLQkJZnJl
ZV9wZCh2bSwgcGQpOworCQkJR0VNX0JVR19PTighYXRvbWljX3JlYWQoJnBkcC0+dXNlZF9wZHBl
cykpOworCQkJYXRvbWljX2RlYygmcGRwLT51c2VkX3BkcGVzKTsKKwkJCWZyZWUgPSB0cnVlOwor
CQl9CisJCXNwaW5fdW5sb2NrKCZwZHAtPmxvY2spOworCQlpZiAoZnJlZSkKKwkJCWZyZWVfcGQo
dm0sIHBkKTsKIAl9CiAKLQlyZXR1cm4gIXBkcC0+dXNlZF9wZHBlczsKKwlyZXR1cm4gIWF0b21p
Y19yZWFkKCZwZHAtPnVzZWRfcGRwZXMpOwogfQogCiBzdGF0aWMgdm9pZCBnZW44X3BwZ3R0X2Ns
ZWFyXzNsdmwoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCkBAIC05MTUsOCArOTI2LDYg
QEAgc3RhdGljIHZvaWQgZ2VuOF9wcGd0dF9zZXRfcG1sNGUoc3RydWN0IGk5MTVfcG1sNCAqcG1s
NCwKIHsKIAlnZW44X3BwZ3R0X3BtbDRlX3QgKnZhZGRyOwogCi0JcG1sNC0+cGRwc1twbWw0ZV0g
PSBwZHA7Ci0KIAl2YWRkciA9IGttYXBfYXRvbWljX3B4KHBtbDQpOwogCXZhZGRyW3BtbDRlXSA9
IGdlbjhfcG1sNGVfZW5jb2RlKHB4X2RtYShwZHApLCBJOTE1X0NBQ0hFX0xMQyk7CiAJa3VubWFw
X2F0b21pYyh2YWRkcik7CkBAIC05MzcsMTQgKzk0NiwyMSBAQCBzdGF0aWMgdm9pZCBnZW44X3Bw
Z3R0X2NsZWFyXzRsdmwoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCiAJR0VNX0JVR19P
TighaTkxNV92bV9pc180bHZsKHZtKSk7CiAKIAlnZW44X2Zvcl9lYWNoX3BtbDRlKHBkcCwgcG1s
NCwgc3RhcnQsIGxlbmd0aCwgcG1sNGUpIHsKKwkJYm9vbCBmcmVlID0gZmFsc2U7CiAJCUdFTV9C
VUdfT04ocGRwID09IHZtLT5zY3JhdGNoX3BkcCk7CiAKIAkJaWYgKCFnZW44X3BwZ3R0X2NsZWFy
X3BkcCh2bSwgcGRwLCBzdGFydCwgbGVuZ3RoKSkKIAkJCWNvbnRpbnVlOwogCi0JCWdlbjhfcHBn
dHRfc2V0X3BtbDRlKHBtbDQsIHZtLT5zY3JhdGNoX3BkcCwgcG1sNGUpOwotCi0JCWZyZWVfcGRw
KHZtLCBwZHApOworCQlzcGluX2xvY2soJnBtbDQtPmxvY2spOworCQlpZiAoIWF0b21pY19yZWFk
KCZwZHAtPnVzZWRfcGRwZXMpKSB7CisJCQlnZW44X3BwZ3R0X3NldF9wbWw0ZShwbWw0LCB2bS0+
c2NyYXRjaF9wZHAsIHBtbDRlKTsKKwkJCXBtbDQtPnBkcHNbcG1sNGVdID0gdm0tPnNjcmF0Y2hf
cGRwOworCQkJZnJlZSA9IHRydWU7CisJCX0KKwkJc3Bpbl91bmxvY2soJnBtbDQtPmxvY2spOwor
CQlpZiAoZnJlZSkKKwkJCWZyZWVfcGRwKHZtLCBwZHApOwogCX0KIH0KIApAQCAtMTM2OSwyNyAr
MTM4NSwzOCBAQCBzdGF0aWMgaW50IGdlbjhfcHBndHRfYWxsb2NfcGQoc3RydWN0IGk5MTVfYWRk
cmVzc19zcGFjZSAqdm0sCiAJdTY0IGZyb20gPSBzdGFydDsKIAl1bnNpZ25lZCBpbnQgcGRlOwog
CisJc3Bpbl9sb2NrKCZwZC0+bG9jayk7CiAJZ2VuOF9mb3JfZWFjaF9wZGUocHQsIHBkLCBzdGFy
dCwgbGVuZ3RoLCBwZGUpIHsKLQkJaW50IGNvdW50ID0gZ2VuOF9wdGVfY291bnQoc3RhcnQsIGxl
bmd0aCk7CisJCWNvbnN0IGludCBjb3VudCA9IGdlbjhfcHRlX2NvdW50KHN0YXJ0LCBsZW5ndGgp
OwogCiAJCWlmIChwdCA9PSB2bS0+c2NyYXRjaF9wdCkgewotCQkJcGQtPnVzZWRfcGRlcysrOwor
CQkJc3RydWN0IGk5MTVfcGFnZV90YWJsZSAqb2xkOworCisJCQlzcGluX3VubG9jaygmcGQtPmxv
Y2spOwogCiAJCQlwdCA9IGFsbG9jX3B0KHZtKTsKLQkJCWlmIChJU19FUlIocHQpKSB7Ci0JCQkJ
cGQtPnVzZWRfcGRlcy0tOworCQkJaWYgKElTX0VSUihwdCkpCiAJCQkJZ290byB1bndpbmQ7Ci0J
CQl9CiAKIAkJCWlmIChjb3VudCA8IEdFTjhfUFRFUyB8fCBpbnRlbF92Z3B1X2FjdGl2ZSh2bS0+
aTkxNSkpCiAJCQkJZ2VuOF9pbml0aWFsaXplX3B0KHZtLCBwdCk7CiAKLQkJCWdlbjhfcHBndHRf
c2V0X3BkZSh2bSwgcGQsIHB0LCBwZGUpOwotCQkJR0VNX0JVR19PTihwZC0+dXNlZF9wZGVzID4g
STkxNV9QREVTKTsKKwkJCW9sZCA9IGNtcHhjaGcoJnBkLT5wYWdlX3RhYmxlW3BkZV0sIHZtLT5z
Y3JhdGNoX3B0LCBwdCk7CisJCQlpZiAob2xkID09IHZtLT5zY3JhdGNoX3B0KSB7CisJCQkJZ2Vu
OF9wcGd0dF9zZXRfcGRlKHZtLCBwZCwgcHQsIHBkZSk7CisJCQkJYXRvbWljX2luYygmcGQtPnVz
ZWRfcGRlcyk7CisJCQl9IGVsc2UgeworCQkJCWZyZWVfcHQodm0sIHB0KTsKKwkJCQlwdCA9IG9s
ZDsKKwkJCX0KKworCQkJc3Bpbl9sb2NrKCZwZC0+bG9jayk7CiAJCX0KIAotCQlwdC0+dXNlZF9w
dGVzICs9IGNvdW50OworCQlhdG9taWNfYWRkKGNvdW50LCAmcHQtPnVzZWRfcHRlcyk7CiAJfQor
CXNwaW5fdW5sb2NrKCZwZC0+bG9jayk7CisKIAlyZXR1cm4gMDsKIAogdW53aW5kOgpAQCAtMTQw
NiwzNSArMTQzMyw1NCBAQCBzdGF0aWMgaW50IGdlbjhfcHBndHRfYWxsb2NfcGRwKHN0cnVjdCBp
OTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAogCXVuc2lnbmVkIGludCBwZHBlOwogCWludCByZXQ7CiAK
KwlzcGluX2xvY2soJnBkcC0+bG9jayk7CiAJZ2VuOF9mb3JfZWFjaF9wZHBlKHBkLCBwZHAsIHN0
YXJ0LCBsZW5ndGgsIHBkcGUpIHsKIAkJaWYgKHBkID09IHZtLT5zY3JhdGNoX3BkKSB7Ci0JCQlw
ZHAtPnVzZWRfcGRwZXMrKzsKKwkJCXN0cnVjdCBpOTE1X3BhZ2VfZGlyZWN0b3J5ICpvbGQ7CisK
KwkJCXNwaW5fdW5sb2NrKCZwZHAtPmxvY2spOwogCiAJCQlwZCA9IGFsbG9jX3BkKHZtKTsKLQkJ
CWlmIChJU19FUlIocGQpKSB7Ci0JCQkJcGRwLT51c2VkX3BkcGVzLS07CisJCQlpZiAoSVNfRVJS
KHBkKSkKIAkJCQlnb3RvIHVud2luZDsKLQkJCX0KIAogCQkJZ2VuOF9pbml0aWFsaXplX3BkKHZt
LCBwZCk7Ci0JCQlnZW44X3BwZ3R0X3NldF9wZHBlKHZtLCBwZHAsIHBkLCBwZHBlKTsKLQkJCUdF
TV9CVUdfT04ocGRwLT51c2VkX3BkcGVzID4gaTkxNV9wZHBlc19wZXJfcGRwKHZtKSk7CisKKwkJ
CW9sZCA9IGNtcHhjaGcoJnBkcC0+cGFnZV9kaXJlY3RvcnlbcGRwZV0sCisJCQkJICAgICAgdm0t
PnNjcmF0Y2hfcGQsIHBkKTsKKwkJCWlmIChvbGQgPT0gdm0tPnNjcmF0Y2hfcGQpIHsKKwkJCQln
ZW44X3BwZ3R0X3NldF9wZHBlKHZtLCBwZHAsIHBkLCBwZHBlKTsKKwkJCQlhdG9taWNfaW5jKCZw
ZHAtPnVzZWRfcGRwZXMpOworCQkJfSBlbHNlIHsKKwkJCQlmcmVlX3BkKHZtLCBwZCk7CisJCQkJ
cGQgPSBvbGQ7CisJCQl9CisKKwkJCXNwaW5fbG9jaygmcGRwLT5sb2NrKTsKIAkJfQorCQlhdG9t
aWNfaW5jKCZwZC0+dXNlZF9wZGVzKTsKKwkJc3Bpbl91bmxvY2soJnBkcC0+bG9jayk7CiAKIAkJ
cmV0ID0gZ2VuOF9wcGd0dF9hbGxvY19wZCh2bSwgcGQsIHN0YXJ0LCBsZW5ndGgpOwogCQlpZiAo
dW5saWtlbHkocmV0KSkKIAkJCWdvdG8gdW53aW5kX3BkOworCisJCXNwaW5fbG9jaygmcGRwLT5s
b2NrKTsKKwkJYXRvbWljX2RlYygmcGQtPnVzZWRfcGRlcyk7CiAJfQorCXNwaW5fdW5sb2NrKCZw
ZHAtPmxvY2spOwogCiAJcmV0dXJuIDA7CiAKIHVud2luZF9wZDoKLQlpZiAoIXBkLT51c2VkX3Bk
ZXMpIHsKKwlzcGluX2xvY2soJnBkcC0+bG9jayk7CisJaWYgKGF0b21pY19kZWNfYW5kX3Rlc3Qo
JnBkLT51c2VkX3BkZXMpKSB7CiAJCWdlbjhfcHBndHRfc2V0X3BkcGUodm0sIHBkcCwgdm0tPnNj
cmF0Y2hfcGQsIHBkcGUpOwotCQlHRU1fQlVHX09OKCFwZHAtPnVzZWRfcGRwZXMpOwotCQlwZHAt
PnVzZWRfcGRwZXMtLTsKKwkJR0VNX0JVR19PTighYXRvbWljX3JlYWQoJnBkcC0+dXNlZF9wZHBl
cykpOworCQlhdG9taWNfZGVjKCZwZHAtPnVzZWRfcGRwZXMpOwogCQlmcmVlX3BkKHZtLCBwZCk7
CiAJfQorCXNwaW5fdW5sb2NrKCZwZHAtPmxvY2spOwogdW53aW5kOgogCWdlbjhfcHBndHRfY2xl
YXJfcGRwKHZtLCBwZHAsIGZyb20sIHN0YXJ0IC0gZnJvbSk7CiAJcmV0dXJuIC1FTk9NRU07CkBA
IC0xNDU3LDI4ICsxNTAzLDUwIEBAIHN0YXRpYyBpbnQgZ2VuOF9wcGd0dF9hbGxvY180bHZsKHN0
cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAogCXUzMiBwbWw0ZTsKIAlpbnQgcmV0OwogCisJ
c3Bpbl9sb2NrKCZwbWw0LT5sb2NrKTsKIAlnZW44X2Zvcl9lYWNoX3BtbDRlKHBkcCwgcG1sNCwg
c3RhcnQsIGxlbmd0aCwgcG1sNGUpIHsKLQkJaWYgKHBtbDQtPnBkcHNbcG1sNGVdID09IHZtLT5z
Y3JhdGNoX3BkcCkgeworCQlpZiAocGRwID09IHZtLT5zY3JhdGNoX3BkcCkgeworCQkJc3RydWN0
IGk5MTVfcGFnZV9kaXJlY3RvcnlfcG9pbnRlciAqb2xkOworCisJCQlzcGluX3VubG9jaygmcG1s
NC0+bG9jayk7CisKIAkJCXBkcCA9IGFsbG9jX3BkcCh2bSk7CiAJCQlpZiAoSVNfRVJSKHBkcCkp
CiAJCQkJZ290byB1bndpbmQ7CiAKIAkJCWdlbjhfaW5pdGlhbGl6ZV9wZHAodm0sIHBkcCk7Ci0J
CQlnZW44X3BwZ3R0X3NldF9wbWw0ZShwbWw0LCBwZHAsIHBtbDRlKTsKKworCQkJb2xkID0gY21w
eGNoZygmcG1sNC0+cGRwc1twbWw0ZV0sIHZtLT5zY3JhdGNoX3BkcCwgcGRwKTsKKwkJCWlmIChv
bGQgPT0gdm0tPnNjcmF0Y2hfcGRwKSB7CisJCQkJZ2VuOF9wcGd0dF9zZXRfcG1sNGUocG1sNCwg
cGRwLCBwbWw0ZSk7CisJCQl9IGVsc2UgeworCQkJCWZyZWVfcGRwKHZtLCBwZHApOworCQkJCXBk
cCA9IG9sZDsKKwkJCX0KKworCQkJc3Bpbl9sb2NrKCZwbWw0LT5sb2NrKTsKIAkJfQorCQlhdG9t
aWNfaW5jKCZwZHAtPnVzZWRfcGRwZXMpOworCQlzcGluX3VubG9jaygmcG1sNC0+bG9jayk7CiAK
IAkJcmV0ID0gZ2VuOF9wcGd0dF9hbGxvY19wZHAodm0sIHBkcCwgc3RhcnQsIGxlbmd0aCk7CiAJ
CWlmICh1bmxpa2VseShyZXQpKQogCQkJZ290byB1bndpbmRfcGRwOworCisJCXNwaW5fbG9jaygm
cG1sNC0+bG9jayk7CisJCWF0b21pY19kZWMoJnBkcC0+dXNlZF9wZHBlcyk7CiAJfQorCXNwaW5f
dW5sb2NrKCZwbWw0LT5sb2NrKTsKIAogCXJldHVybiAwOwogCiB1bndpbmRfcGRwOgotCWlmICgh
cGRwLT51c2VkX3BkcGVzKSB7CisJc3Bpbl9sb2NrKCZwbWw0LT5sb2NrKTsKKwlpZiAoYXRvbWlj
X2RlY19hbmRfdGVzdCgmcGRwLT51c2VkX3BkcGVzKSkgewogCQlnZW44X3BwZ3R0X3NldF9wbWw0
ZShwbWw0LCB2bS0+c2NyYXRjaF9wZHAsIHBtbDRlKTsKIAkJZnJlZV9wZHAodm0sIHBkcCk7CiAJ
fQorCXNwaW5fdW5sb2NrKCZwbWw0LT5sb2NrKTsKIHVud2luZDoKIAlnZW44X3BwZ3R0X2NsZWFy
XzRsdmwodm0sIGZyb20sIHN0YXJ0IC0gZnJvbSk7CiAJcmV0dXJuIC1FTk9NRU07CkBAIC0xNTAw
LDEwICsxNTY4LDEwIEBAIHN0YXRpYyBpbnQgZ2VuOF9wcmVhbGxvY2F0ZV90b3BfbGV2ZWxfcGRw
KHN0cnVjdCBpOTE1X2h3X3BwZ3R0ICpwcGd0dCkKIAogCQlnZW44X2luaXRpYWxpemVfcGQodm0s
IHBkKTsKIAkJZ2VuOF9wcGd0dF9zZXRfcGRwZSh2bSwgcGRwLCBwZCwgcGRwZSk7Ci0JCXBkcC0+
dXNlZF9wZHBlcysrOworCQlhdG9taWNfaW5jKCZwZHAtPnVzZWRfcGRwZXMpOwogCX0KIAotCXBk
cC0+dXNlZF9wZHBlcysrOyAvKiBuZXZlciByZW1vdmUgKi8KKwlhdG9taWNfaW5jKCZwZHAtPnVz
ZWRfcGRwZXMpOyAvKiBuZXZlciByZW1vdmUgKi8KIAlyZXR1cm4gMDsKIAogdW53aW5kOgpAQCAt
MTUxMiw3ICsxNTgwLDcgQEAgc3RhdGljIGludCBnZW44X3ByZWFsbG9jYXRlX3RvcF9sZXZlbF9w
ZHAoc3RydWN0IGk5MTVfaHdfcHBndHQgKnBwZ3R0KQogCQlnZW44X3BwZ3R0X3NldF9wZHBlKHZt
LCBwZHAsIHZtLT5zY3JhdGNoX3BkLCBwZHBlKTsKIAkJZnJlZV9wZCh2bSwgcGQpOwogCX0KLQlw
ZHAtPnVzZWRfcGRwZXMgPSAwOworCWF0b21pY19zZXQoJnBkcC0+dXNlZF9wZHBlcywgMCk7CiAJ
cmV0dXJuIC1FTk9NRU07CiB9CiAKQEAgLTE2ODQsOSArMTc1Miw3IEBAIHN0YXRpYyB2b2lkIGdl
bjZfcHBndHRfY2xlYXJfcmFuZ2Uoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCiAKIAkJ
bnVtX2VudHJpZXMgLT0gY291bnQ7CiAKLQkJR0VNX0JVR19PTihjb3VudCA+IHB0LT51c2VkX3B0
ZXMpOwotCQlwdC0+dXNlZF9wdGVzIC09IGNvdW50OwotCQlpZiAoIXB0LT51c2VkX3B0ZXMpCisJ
CWlmICghYXRvbWljX3N1Yl9yZXR1cm4oY291bnQsICZwdC0+dXNlZF9wdGVzKSkKIAkJCXBwZ3R0
LT5zY2FuX2Zvcl91bnVzZWRfcHQgPSB0cnVlOwogCiAJCS8qCkBAIC0xNzU2LDI4ICsxODIyLDQx
IEBAIHN0YXRpYyBpbnQgZ2VuNl9hbGxvY192YV9yYW5nZShzdHJ1Y3QgaTkxNV9hZGRyZXNzX3Nw
YWNlICp2bSwKIAogCXdha2VyZWYgPSBpbnRlbF9ydW50aW1lX3BtX2dldCh2bS0+aTkxNSk7CiAK
KwlzcGluX2xvY2soJnBwZ3R0LT5iYXNlLnBkLmxvY2spOwogCWdlbjZfZm9yX2VhY2hfcGRlKHB0
LCAmcHBndHQtPmJhc2UucGQsIHN0YXJ0LCBsZW5ndGgsIHBkZSkgewogCQljb25zdCB1bnNpZ25l
ZCBpbnQgY291bnQgPSBnZW42X3B0ZV9jb3VudChzdGFydCwgbGVuZ3RoKTsKIAogCQlpZiAocHQg
PT0gdm0tPnNjcmF0Y2hfcHQpIHsKKwkJCXN0cnVjdCBpOTE1X3BhZ2VfdGFibGUgKm9sZDsKKwor
CQkJc3Bpbl91bmxvY2soJnBwZ3R0LT5iYXNlLnBkLmxvY2spOworCiAJCQlwdCA9IGFsbG9jX3B0
KHZtKTsKIAkJCWlmIChJU19FUlIocHQpKQogCQkJCWdvdG8gdW53aW5kX291dDsKIAogCQkJZ2Vu
Nl9pbml0aWFsaXplX3B0KHZtLCBwdCk7Ci0JCQlwcGd0dC0+YmFzZS5wZC5wYWdlX3RhYmxlW3Bk
ZV0gPSBwdDsKIAotCQkJaWYgKGk5MTVfdm1hX2lzX2JvdW5kKHBwZ3R0LT52bWEsCi0JCQkJCSAg
ICAgIEk5MTVfVk1BX0dMT0JBTF9CSU5EKSkgewotCQkJCWdlbjZfd3JpdGVfcGRlKHBwZ3R0LCBw
ZGUsIHB0KTsKLQkJCQlmbHVzaCA9IHRydWU7CisJCQlvbGQgPSBjbXB4Y2hnKCZwcGd0dC0+YmFz
ZS5wZC5wYWdlX3RhYmxlW3BkZV0sCisJCQkJICAgICAgdm0tPnNjcmF0Y2hfcHQsIHB0KTsKKwkJ
CWlmIChvbGQgPT0gdm0tPnNjcmF0Y2hfcHQpIHsKKwkJCQlwcGd0dC0+YmFzZS5wZC5wYWdlX3Rh
YmxlW3BkZV0gPSBwdDsKKwkJCQlpZiAoaTkxNV92bWFfaXNfYm91bmQocHBndHQtPnZtYSwKKwkJ
CQkJCSAgICAgIEk5MTVfVk1BX0dMT0JBTF9CSU5EKSkgeworCQkJCQlnZW42X3dyaXRlX3BkZShw
cGd0dCwgcGRlLCBwdCk7CisJCQkJCWZsdXNoID0gdHJ1ZTsKKwkJCQl9CisJCQl9IGVsc2Ugewor
CQkJCWZyZWVfcHQodm0sIHB0KTsKKwkJCQlwdCA9IG9sZDsKIAkJCX0KIAotCQkJR0VNX0JVR19P
TihwdC0+dXNlZF9wdGVzKTsKKwkJCXNwaW5fbG9jaygmcHBndHQtPmJhc2UucGQubG9jayk7CiAJ
CX0KIAotCQlwdC0+dXNlZF9wdGVzICs9IGNvdW50OworCQlhdG9taWNfYWRkKGNvdW50LCAmcHQt
PnVzZWRfcHRlcyk7CiAJfQorCXNwaW5fdW5sb2NrKCZwcGd0dC0+YmFzZS5wZC5sb2NrKTsKIAog
CWlmIChmbHVzaCkgewogCQltYXJrX3RsYnNfZGlydHkoJnBwZ3R0LT5iYXNlKTsKQEAgLTE4MTgs
NiArMTg5Nyw3IEBAIHN0YXRpYyBpbnQgZ2VuNl9wcGd0dF9pbml0X3NjcmF0Y2goc3RydWN0IGdl
bjZfaHdfcHBndHQgKnBwZ3R0KQogCWdlbjZfaW5pdGlhbGl6ZV9wdCh2bSwgdm0tPnNjcmF0Y2hf
cHQpOwogCWdlbjZfZm9yX2FsbF9wZGVzKHVudXNlZCwgJnBwZ3R0LT5iYXNlLnBkLCBwZGUpCiAJ
CXBwZ3R0LT5iYXNlLnBkLnBhZ2VfdGFibGVbcGRlXSA9IHZtLT5zY3JhdGNoX3B0OworCXNwaW5f
bG9ja19pbml0KCZwcGd0dC0+YmFzZS5wZC5sb2NrKTsKIAogCXJldHVybiAwOwogfQpAQCAtMTk0
Niw3ICsyMDI2LDcgQEAgc3RhdGljIHZvaWQgcGRfdm1hX3VuYmluZChzdHJ1Y3QgaTkxNV92bWEg
KnZtYSkKIAogCS8qIEZyZWUgYWxsIG5vIGxvbmdlciB1c2VkIHBhZ2UgdGFibGVzICovCiAJZ2Vu
Nl9mb3JfYWxsX3BkZXMocHQsICZwcGd0dC0+YmFzZS5wZCwgcGRlKSB7Ci0JCWlmIChwdC0+dXNl
ZF9wdGVzIHx8IHB0ID09IHNjcmF0Y2hfcHQpCisJCWlmIChhdG9taWNfcmVhZCgmcHQtPnVzZWRf
cHRlcykgfHwgcHQgPT0gc2NyYXRjaF9wdCkKIAkJCWNvbnRpbnVlOwogCiAJCWZyZWVfcHQoJnBw
Z3R0LT5iYXNlLnZtLCBwdCk7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1
X2dlbV9ndHQuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtX2d0dC5oCmluZGV4IDcz
YjY2MDg3NDBmMi4uMTUyYTAzNTYwYzIyIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9pOTE1X2dlbV9ndHQuaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQu
aApAQCAtMjQ4LDI1ICsyNDgsMjggQEAgc3RydWN0IGk5MTVfcGFnZV9kbWEgewogCiBzdHJ1Y3Qg
aTkxNV9wYWdlX3RhYmxlIHsKIAlzdHJ1Y3QgaTkxNV9wYWdlX2RtYSBiYXNlOwotCXVuc2lnbmVk
IGludCB1c2VkX3B0ZXM7CisJYXRvbWljX3QgdXNlZF9wdGVzOwogfTsKIAogc3RydWN0IGk5MTVf
cGFnZV9kaXJlY3RvcnkgewogCXN0cnVjdCBpOTE1X3BhZ2VfZG1hIGJhc2U7CiAKIAlzdHJ1Y3Qg
aTkxNV9wYWdlX3RhYmxlICpwYWdlX3RhYmxlW0k5MTVfUERFU107IC8qIFBERXMgKi8KLQl1bnNp
Z25lZCBpbnQgdXNlZF9wZGVzOworCWF0b21pY190IHVzZWRfcGRlczsKKwlzcGlubG9ja190IGxv
Y2s7CiB9OwogCiBzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeV9wb2ludGVyIHsKIAlzdHJ1Y3Qg
aTkxNV9wYWdlX2RtYSBiYXNlOwogCXN0cnVjdCBpOTE1X3BhZ2VfZGlyZWN0b3J5ICoqcGFnZV9k
aXJlY3Rvcnk7Ci0JdW5zaWduZWQgaW50IHVzZWRfcGRwZXM7CisJYXRvbWljX3QgdXNlZF9wZHBl
czsKKwlzcGlubG9ja190IGxvY2s7CiB9OwogCiBzdHJ1Y3QgaTkxNV9wbWw0IHsKIAlzdHJ1Y3Qg
aTkxNV9wYWdlX2RtYSBiYXNlOwogCXN0cnVjdCBpOTE1X3BhZ2VfZGlyZWN0b3J5X3BvaW50ZXIg
KnBkcHNbR0VOOF9QTUw0RVNfUEVSX1BNTDRdOworCXNwaW5sb2NrX3QgbG9jazsKIH07CiAKIHN0
cnVjdCBpOTE1X3ZtYV9vcHMgewotLSAKMi4yMC4xCgpfX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fXwpJbnRlbC1nZnggbWFpbGluZyBsaXN0CkludGVsLWdmeEBs
aXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1h
bi9saXN0aW5mby9pbnRlbC1nZng=

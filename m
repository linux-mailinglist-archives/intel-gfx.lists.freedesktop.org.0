Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 27F8CFB0D7
	for <lists+intel-gfx@lfdr.de>; Wed, 13 Nov 2019 13:53:04 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 959276E0F4;
	Wed, 13 Nov 2019 12:52:55 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 5C61B8909F;
 Wed, 13 Nov 2019 12:52:52 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 19187133-1500050 
 for multiple; Wed, 13 Nov 2019 12:52:42 +0000
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Wed, 13 Nov 2019 12:52:36 +0000
Message-Id: <20191113125240.3781-5-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.24.0
In-Reply-To: <20191113125240.3781-1-chris@chris-wilson.co.uk>
References: <20191113125240.3781-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH i-g-t 5/9] i915/gem_ctx_isolation: Check engine
 relative registers
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: igt-dev@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

U29tZSBvZiB0aGUgbm9uLXByaXZpbGVnZWQgcmVnaXN0ZXJzIGFyZSBhdCB0aGUgc2FtZSBvZmZz
ZXQgb24gZWFjaAplbmdpbmUuIFdlIGNhbiBpbXByb3ZlIG91ciBjb3ZlcmFnZSBmb3IgdW5rbm93
biBIVyBsYXlvdXQgYnkgdXNpbmcgdGhlCnJlcG9ydGVkIGVuZ2luZS0+bW1pb19iYXNlIGZvciBy
ZWxhdGl2ZSBvZmZzZXRzLgoKU2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJp
cy13aWxzb24uY28udWs+Ci0tLQogdGVzdHMvaTkxNS9nZW1fY3R4X2lzb2xhdGlvbi5jIHwgMTY0
ICsrKysrKysrKysrKysrKysrKysrLS0tLS0tLS0tLS0tLQogMSBmaWxlIGNoYW5nZWQsIDEwMCBp
bnNlcnRpb25zKCspLCA2NCBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS90ZXN0cy9pOTE1L2dl
bV9jdHhfaXNvbGF0aW9uLmMgYi90ZXN0cy9pOTE1L2dlbV9jdHhfaXNvbGF0aW9uLmMKaW5kZXgg
NmFhMjcxMzNjLi41NDZmZmFjM2EgMTAwNjQ0Ci0tLSBhL3Rlc3RzL2k5MTUvZ2VtX2N0eF9pc29s
YXRpb24uYworKysgYi90ZXN0cy9pOTE1L2dlbV9jdHhfaXNvbGF0aW9uLmMKQEAgLTcwLDYgKzcw
LDcgQEAgc3RhdGljIGNvbnN0IHN0cnVjdCBuYW1lZF9yZWdpc3RlciB7CiAJdWludDMyX3QgaWdu
b3JlX2JpdHM7CiAJdWludDMyX3Qgd3JpdGVfbWFzazsgLyogc29tZSByZWdpc3RlcnMgYml0cyBk
byBub3QgZXhpc3QgKi8KIAlib29sIG1hc2tlZDsKKwlib29sIHJlbGF0aXZlOwogfSBub25wcml2
X3JlZ2lzdGVyc1tdID0gewogCXsgIk5PUElEIiwgTk9DVFgsIFJDUzAsIDB4MjA5NCB9LAogCXsg
Ik1JX1BSRURJQ0FURV9SRVNVTFRfMiIsIE5PQ1RYLCBSQ1MwLCAweDIzYmMgfSwKQEAgLTEwOSw3
ICsxMTAsNiBAQCBzdGF0aWMgY29uc3Qgc3RydWN0IG5hbWVkX3JlZ2lzdGVyIHsKIAl7ICJQU19E
RVBUSF9DT1VOVF8xIiwgR0VOOCwgUkNTMCwgMHgyMmY4LCAyIH0sCiAJeyAiQkJfT0ZGU0VUIiwg
R0VOOCwgUkNTMCwgMHgyMTU4LCAuaWdub3JlX2JpdHMgPSAweDcgfSwKIAl7ICJNSV9QUkVESUNB
VEVfUkVTVUxUXzEiLCBHRU44LCBSQ1MwLCAweDI0MWMgfSwKLQl7ICJDU19HUFIiLCBHRU44LCBS
Q1MwLCAweDI2MDAsIDMyIH0sCiAJeyAiT0FfQ1RYX0NPTlRST0wiLCBHRU44LCBSQ1MwLCAweDIz
NjAgfSwKIAl7ICJPQUNUWElEIiwgR0VOOCwgUkNTMCwgMHgyMzY0IH0sCiAJeyAiUFNfSU5WT0NB
VElPTl9DT1VOVF8yIiwgR0VOOCwgUkNTMCwgMHgyNDQ4LCAyLCAud3JpdGVfbWFzayA9IH4weDMg
fSwKQEAgLTEzOCw3OSArMTM4LDU2IEBAIHN0YXRpYyBjb25zdCBzdHJ1Y3QgbmFtZWRfcmVnaXN0
ZXIgewogCiAJeyAiQ1RYX1BSRUVNUFQiLCBOT0NUWCAvKiBHRU4xMCAqLywgUkNTMCwgMHgyMjQ4
IH0sCiAJeyAiQ1NfQ0hJQ0tFTjEiLCBHRU4xMSwgUkNTMCwgMHgyNTgwLCAubWFza2VkID0gdHJ1
ZSB9LAotCXsgIkhEQ19DSElDS0VOMSIsIEdFTl9SQU5HRSgxMCwgMTApLCBSQ1MwLCAweDczMDQs
IC5tYXNrZWQgPSB0cnVlIH0sCiAKIAkvKiBQcml2aWxlZ2VkIChlbmFibGVkIGJ5IHcvYSArIEZP
UkNFX1RPX05PTlBSSVYpICovCiAJeyAiQ1RYX1BSRUVNUFQiLCBOT0NUWCAvKiBHRU45ICovLCBS
Q1MwLCAweDIyNDggfSwKIAl7ICJDU19DSElDS0VOMSIsIEdFTl9SQU5HRSg5LCAxMCksIFJDUzAs
IDB4MjU4MCwgLm1hc2tlZCA9IHRydWUgfSwKIAl7ICJDT01NT05fU0xJQ0VfQ0hJQ0tFTjIiLCBH
RU5fUkFOR0UoOSwgOSksIFJDUzAsIDB4NzAxNCwgLm1hc2tlZCA9IHRydWUgfSwKLQl7ICJIRENf
Q0hJQ0tFTjEiLCBHRU5fUkFOR0UoOSwgOSksIFJDUzAsIDB4NzMwNCwgLm1hc2tlZCA9IHRydWUg
fSwKKwl7ICJIRENfQ0hJQ0tFTjEiLCBHRU5fUkFOR0UoOSwgMTApLCBSQ1MwLCAweDczMDQsIC5t
YXNrZWQgPSB0cnVlIH0sCiAJeyAiU0xJQ0VfQ09NTU9OX0VDT19DSElDS0VOMSIsIEdFTl9SQU5H
RSgxMSwgMTEpIC8qICsgZ2xrICovLCBSQ1MwLCAgMHg3MzFjLCAubWFza2VkID0gdHJ1ZSB9LAog
CXsgIkwzU1FSRUc0IiwgTk9DVFggLyogR0VOOTpza2wsa2JsICovLCBSQ1MwLCAweGIxMTgsIC53
cml0ZV9tYXNrID0gfjB4MWZmZmYwIH0sCiAJeyAiSEFMRl9TTElDRV9DSElDS0VONyIsIEdFTl9S
QU5HRSgxMSwgMTEpLCBSQ1MwLCAweGUxOTQsIC5tYXNrZWQgPSB0cnVlIH0sCiAJeyAiU0FNUExF
Ul9NT0RFIiwgR0VOX1JBTkdFKDExLCAxMSksIFJDUzAsIDB4ZTE4YywgLm1hc2tlZCA9IHRydWUg
fSwKIAotCXsgIkJDU19HUFIiLCBHRU45LCBCQ1MwLCAweDIyNjAwLCAzMiB9LAogCXsgIkJDU19T
V0NUUkwiLCBHRU44LCBCQ1MwLCAweDIyMjAwLCAud3JpdGVfbWFzayA9IDB4MywgLm1hc2tlZCA9
IHRydWUgfSwKIAogCXsgIk1GQ19WREJPWDEiLCBOT0NUWCwgVkNTMCwgMHgxMjgwMCwgNjQgfSwK
IAl7ICJNRkNfVkRCT1gyIiwgTk9DVFgsIFZDUzEsIDB4MWM4MDAsIDY0IH0sCiAKLQl7ICJWQ1Mw
X0dQUiIsIEdFTl9SQU5HRSg5LCAxMCksIFZDUzAsIDB4MTI2MDAsIDMyIH0sCi0JeyAiVkNTMV9H
UFIiLCBHRU5fUkFOR0UoOSwgMTApLCBWQ1MxLCAweDFjNjAwLCAzMiB9LAotCXsgIlZFQ1NfR1BS
IiwgR0VOX1JBTkdFKDksIDEwKSwgVkVDUzAsIDB4MWE2MDAsIDMyIH0sCi0KLQl7ICJWQ1MwX0dQ
UiIsIEdFTjExLCBWQ1MwLCAweDFjMDYwMCwgMzIgfSwKLQl7ICJWQ1MxX0dQUiIsIEdFTjExLCBW
Q1MxLCAweDFjNDYwMCwgMzIgfSwKLQl7ICJWQ1MyX0dQUiIsIEdFTjExLCBWQ1MyLCAweDFkMDYw
MCwgMzIgfSwKLQl7ICJWQ1MzX0dQUiIsIEdFTjExLCBWQ1MzLCAweDFkNDYwMCwgMzIgfSwKLQl7
ICJWRUNTX0dQUiIsIEdFTjExLCBWRUNTMCwgMHgxYzg2MDAsIDMyIH0sCisJeyAieENTX0dQUiIs
IEdFTjksIEFMTCwgMHg2MDAsIDMyLCAucmVsYXRpdmUgPSB0cnVlIH0sCiAKIAl7fQogfSwgaWdu
b3JlX3JlZ2lzdGVyc1tdID0gewogCXsgIlJDUyB0aW1lc3RhbXAiLCBHRU42LCB+MHUsIDB4MjM1
OCB9LAogCXsgIkJDUyB0aW1lc3RhbXAiLCBHRU43LCB+MHUsIDB4MjIzNTggfSwKIAotCXsgIlZD
UzAgdGltZXN0YW1wIiwgR0VOX1JBTkdFKDcsIDEwKSwgfjB1LCAweDEyMzU4IH0sCi0JeyAiVkNT
MSB0aW1lc3RhbXAiLCBHRU5fUkFOR0UoNywgMTApLCB+MHUsIDB4MWMzNTggfSwKLQl7ICJWRUNT
IHRpbWVzdGFtcCIsIEdFTl9SQU5HRSg4LCAxMCksIH4wdSwgMHgxYTM1OCB9LAotCi0JeyAiVkNT
MCB0aW1lc3RhbXAiLCBHRU4xMSwgfjB1LCAweDFjMDM1OCB9LAotCXsgIlZDUzEgdGltZXN0YW1w
IiwgR0VOMTEsIH4wdSwgMHgxYzQzNTggfSwKLQl7ICJWQ1MyIHRpbWVzdGFtcCIsIEdFTjExLCB+
MHUsIDB4MWQwMzU4IH0sCi0JeyAiVkNTMyB0aW1lc3RhbXAiLCBHRU4xMSwgfjB1LCAweDFkNDM1
OCB9LAotCXsgIlZFQ1MgdGltZXN0YW1wIiwgR0VOMTEsIH4wdSwgMHgxYzgzNTggfSwKKwl7ICJ4
Q1MgdGltZXN0YW1wIiwgR0VOOCwgQUxMLCAweDM1OCwgLnJlbGF0aXZlID0gdHJ1ZSB9LAogCiAJ
LyogaHVjIHJlYWQgb25seSAqLwotCXsgIkJTRDAgMHgyMDAwIiwgR0VOMTEsIH4wdSwgMHgxYzAw
MDAgKyAweDIwMDAgfSwKLQl7ICJCU0QwIDB4MjAwMCIsIEdFTjExLCB+MHUsIDB4MWMwMDAwICsg
MHgyMDE0IH0sCi0JeyAiQlNEMCAweDIwMDAiLCBHRU4xMSwgfjB1LCAweDFjMDAwMCArIDB4MjNi
MCB9LAotCi0JeyAiQlNEMSAweDIwMDAiLCBHRU4xMSwgfjB1LCAweDFjNDAwMCArIDB4MjAwMCB9
LAotCXsgIkJTRDEgMHgyMDAwIiwgR0VOMTEsIH4wdSwgMHgxYzQwMDAgKyAweDIwMTQgfSwKLQl7
ICJCU0QxIDB4MjAwMCIsIEdFTjExLCB+MHUsIDB4MWM0MDAwICsgMHgyM2IwIH0sCi0KLQl7ICJC
U0QyIDB4MjAwMCIsIEdFTjExLCB+MHUsIDB4MWQwMDAwICsgMHgyMDAwIH0sCi0JeyAiQlNEMiAw
eDIwMDAiLCBHRU4xMSwgfjB1LCAweDFkMDAwMCArIDB4MjAxNCB9LAotCXsgIkJTRDIgMHgyMDAw
IiwgR0VOMTEsIH4wdSwgMHgxZDAwMDAgKyAweDIzYjAgfSwKLQotCXsgIkJTRDMgMHgyMDAwIiwg
R0VOMTEsIH4wdSwgMHgxZDQwMDAgKyAweDIwMDAgfSwKLQl7ICJCU0QzIDB4MjAwMCIsIEdFTjEx
LCB+MHUsIDB4MWQ0MDAwICsgMHgyMDE0IH0sCi0JeyAiQlNEMyAweDIwMDAiLCBHRU4xMSwgfjB1
LCAweDFkNDAwMCArIDB4MjNiMCB9LAorCXsgIkJTRCAweDIwMDAiLCBHRU4xMSwgQUxMLCAweDIw
MDAsIC5yZWxhdGl2ZSA9IHRydWUgfSwKKwl7ICJCU0QgMHgyMDE0IiwgR0VOMTEsIEFMTCwgMHgy
MDE0LCAucmVsYXRpdmUgPSB0cnVlIH0sCisJeyAiQlNEIDB4MjNiMCIsIEdFTjExLCBBTEwsIDB4
MjNiMCwgLnJlbGF0aXZlID0gdHJ1ZSB9LAogCiAJe30KIH07CiAKLXN0YXRpYyBjb25zdCBjaGFy
ICpyZWdpc3Rlcl9uYW1lKHVpbnQzMl90IG9mZnNldCwgY2hhciAqYnVmLCBzaXplX3QgbGVuKQor
c3RhdGljIGNvbnN0IGNoYXIgKgorcmVnaXN0ZXJfbmFtZSh1aW50MzJfdCBvZmZzZXQsIHVpbnQz
Ml90IG1taW9fYmFzZSwgY2hhciAqYnVmLCBzaXplX3QgbGVuKQogewogCWZvciAoY29uc3Qgc3Ry
dWN0IG5hbWVkX3JlZ2lzdGVyICpyID0gbm9ucHJpdl9yZWdpc3RlcnM7IHItPm5hbWU7IHIrKykg
ewogCQl1bnNpZ25lZCBpbnQgd2lkdGggPSByLT5jb3VudCA/IDQqci0+Y291bnQgOiA0OwotCQlp
ZiAob2Zmc2V0ID49IHItPm9mZnNldCAmJiBvZmZzZXQgPCByLT5vZmZzZXQgKyB3aWR0aCkgewor
CQl1aW50MzJfdCBiYXNlOworCisJCWJhc2UgPSByLT5vZmZzZXQ7CisJCWlmIChyLT5yZWxhdGl2
ZSkKKwkJCWJhc2UgKz0gbW1pb19iYXNlOworCisJCWlmIChvZmZzZXQgPj0gYmFzZSAmJiBvZmZz
ZXQgPCBiYXNlICsgd2lkdGgpIHsKIAkJCWlmIChyLT5jb3VudCA8PSAxKQogCQkJCXJldHVybiBy
LT5uYW1lOwogCiAJCQlzbnByaW50ZihidWYsIGxlbiwgIiVzWyVkXSIsCi0JCQkJIHItPm5hbWUs
IChvZmZzZXQgLSByLT5vZmZzZXQpLzQpOworCQkJCSByLT5uYW1lLCAob2Zmc2V0IC0gYmFzZSkg
LyA0KTsKIAkJCXJldHVybiBidWY7CiAJCX0KIAl9CkBAIC0yMTgsMjIgKzE5NSwzNSBAQCBzdGF0
aWMgY29uc3QgY2hhciAqcmVnaXN0ZXJfbmFtZSh1aW50MzJfdCBvZmZzZXQsIGNoYXIgKmJ1Ziwg
c2l6ZV90IGxlbikKIAlyZXR1cm4gInVua25vd24iOwogfQogCi1zdGF0aWMgY29uc3Qgc3RydWN0
IG5hbWVkX3JlZ2lzdGVyICpsb29rdXBfcmVnaXN0ZXIodWludDMyX3Qgb2Zmc2V0KQorc3RhdGlj
IGNvbnN0IHN0cnVjdCBuYW1lZF9yZWdpc3RlciAqCitsb29rdXBfcmVnaXN0ZXIodWludDMyX3Qg
b2Zmc2V0LCB1aW50MzJfdCBtbWlvX2Jhc2UpCiB7CiAJZm9yIChjb25zdCBzdHJ1Y3QgbmFtZWRf
cmVnaXN0ZXIgKnIgPSBub25wcml2X3JlZ2lzdGVyczsgci0+bmFtZTsgcisrKSB7CiAJCXVuc2ln
bmVkIGludCB3aWR0aCA9IHItPmNvdW50ID8gNCpyLT5jb3VudCA6IDQ7Ci0JCWlmIChvZmZzZXQg
Pj0gci0+b2Zmc2V0ICYmIG9mZnNldCA8IHItPm9mZnNldCArIHdpZHRoKQorCQl1aW50MzJfdCBi
YXNlOworCisJCWJhc2UgPSByLT5vZmZzZXQ7CisJCWlmIChyLT5yZWxhdGl2ZSkKKwkJCWJhc2Ug
Kz0gbW1pb19iYXNlOworCisJCWlmIChvZmZzZXQgPj0gYmFzZSAmJiBvZmZzZXQgPCBiYXNlICsg
d2lkdGgpCiAJCQlyZXR1cm4gcjsKIAl9CiAKIAlyZXR1cm4gTlVMTDsKIH0KIAotc3RhdGljIGJv
b2wgaWdub3JlX3JlZ2lzdGVyKHVpbnQzMl90IG9mZnNldCkKK3N0YXRpYyBib29sIGlnbm9yZV9y
ZWdpc3Rlcih1aW50MzJfdCBvZmZzZXQsIHVpbnQzMl90IG1taW9fYmFzZSkKIHsKIAlmb3IgKGNv
bnN0IHN0cnVjdCBuYW1lZF9yZWdpc3RlciAqciA9IGlnbm9yZV9yZWdpc3RlcnM7IHItPm5hbWU7
IHIrKykgewogCQl1bnNpZ25lZCBpbnQgd2lkdGggPSByLT5jb3VudCA/IDQqci0+Y291bnQgOiA0
OwotCQlpZiAob2Zmc2V0ID49IHItPm9mZnNldCAmJiBvZmZzZXQgPCByLT5vZmZzZXQgKyB3aWR0
aCkKKwkJdWludDMyX3QgYmFzZTsKKworCQliYXNlID0gci0+b2Zmc2V0OworCQlpZiAoci0+cmVs
YXRpdmUpCisJCQliYXNlICs9IG1taW9fYmFzZTsKKworCQlpZiAob2Zmc2V0ID49IGJhc2UgJiYg
b2Zmc2V0IDwgYmFzZSArIHdpZHRoKQogCQkJcmV0dXJuIHRydWU7CiAJfQogCkBAIC0yNDgsNiAr
MjM4LDcgQEAgc3RhdGljIHZvaWQgdG1wbF9yZWdzKGludCBmZCwKIHsKIAljb25zdCB1bnNpZ25l
ZCBpbnQgZ2VuX2JpdCA9IDEgPDwgaW50ZWxfZ2VuKGludGVsX2dldF9kcm1fZGV2aWQoZmQpKTsK
IAljb25zdCB1bnNpZ25lZCBpbnQgZW5naW5lX2JpdCA9IEVOR0lORShlLT5jbGFzcywgZS0+aW5z
dGFuY2UpOworCWNvbnN0IHVpbnQzMl90IG1taW9fYmFzZSA9IGdlbV9lbmdpbmVfbW1pb19iYXNl
KGZkLCBlLT5uYW1lKTsKIAl1bnNpZ25lZCBpbnQgcmVnc19zaXplOwogCXVpbnQzMl90ICpyZWdz
OwogCkBAIC0yNTksMTIgKzI1MCwyMCBAQCBzdGF0aWMgdm9pZCB0bXBsX3JlZ3MoaW50IGZkLAog
CQkgICAgICAgSTkxNV9HRU1fRE9NQUlOX0NQVSwgSTkxNV9HRU1fRE9NQUlOX0NQVSk7CiAKIAlm
b3IgKGNvbnN0IHN0cnVjdCBuYW1lZF9yZWdpc3RlciAqciA9IG5vbnByaXZfcmVnaXN0ZXJzOyBy
LT5uYW1lOyByKyspIHsKKwkJdWludDMyX3Qgb2Zmc2V0OworCiAJCWlmICghKHItPmVuZ2luZV9t
YXNrICYgZW5naW5lX2JpdCkpCiAJCQljb250aW51ZTsKIAkJaWYgKCEoci0+Z2VuX21hc2sgJiBn
ZW5fYml0KSkKIAkJCWNvbnRpbnVlOwotCQlmb3IgKHVuc2lnbmVkIGNvdW50ID0gci0+Y291bnQg
PzogMSwgb2Zmc2V0ID0gci0+b2Zmc2V0OwotCQkgICAgIGNvdW50LS07IG9mZnNldCArPSA0KSB7
CisJCWlmIChyLT5yZWxhdGl2ZSAmJiAhbW1pb19iYXNlKQorCQkJY29udGludWU7CisKKwkJb2Zm
c2V0ID0gci0+b2Zmc2V0OworCQlpZiAoci0+cmVsYXRpdmUpCisJCQlvZmZzZXQgKz0gbW1pb19i
YXNlOworCisJCWZvciAodW5zaWduZWQgY291bnQgPSByLT5jb3VudCA/OiAxOyBjb3VudC0tOyBv
ZmZzZXQgKz0gNCkgewogCQkJdWludDMyX3QgeCA9IHZhbHVlOwogCQkJaWYgKHItPndyaXRlX21h
c2spCiAJCQkJeCAmPSByLT53cml0ZV9tYXNrOwpAQCAtMjg0LDYgKzI4Myw3IEBAIHN0YXRpYyB1
aW50MzJfdCByZWFkX3JlZ3MoaW50IGZkLAogCWNvbnN0IHVuc2lnbmVkIGludCBnZW4gPSBpbnRl
bF9nZW4oaW50ZWxfZ2V0X2RybV9kZXZpZChmZCkpOwogCWNvbnN0IHVuc2lnbmVkIGludCBnZW5f
Yml0ID0gMSA8PCBnZW47CiAJY29uc3QgdW5zaWduZWQgaW50IGVuZ2luZV9iaXQgPSBFTkdJTkUo
ZS0+Y2xhc3MsIGUtPmluc3RhbmNlKTsKKwljb25zdCB1aW50MzJfdCBtbWlvX2Jhc2UgPSBnZW1f
ZW5naW5lX21taW9fYmFzZShmZCwgZS0+bmFtZSk7CiAJY29uc3QgYm9vbCByNjRiID0gZ2VuID49
IDg7CiAJc3RydWN0IGRybV9pOTE1X2dlbV9leGVjX29iamVjdDIgb2JqWzJdOwogCXN0cnVjdCBk
cm1faTkxNV9nZW1fcmVsb2NhdGlvbl9lbnRyeSAqcmVsb2M7CkBAIC0zMTEsMTMgKzMxMSwyMCBA
QCBzdGF0aWMgdWludDMyX3QgcmVhZF9yZWdzKGludCBmZCwKIAogCW4gPSAwOwogCWZvciAoY29u
c3Qgc3RydWN0IG5hbWVkX3JlZ2lzdGVyICpyID0gbm9ucHJpdl9yZWdpc3RlcnM7IHItPm5hbWU7
IHIrKykgeworCQl1aW50MzJfdCBvZmZzZXQ7CisKIAkJaWYgKCEoci0+ZW5naW5lX21hc2sgJiBl
bmdpbmVfYml0KSkKIAkJCWNvbnRpbnVlOwogCQlpZiAoIShyLT5nZW5fbWFzayAmIGdlbl9iaXQp
KQogCQkJY29udGludWU7CisJCWlmIChyLT5yZWxhdGl2ZSAmJiAhbW1pb19iYXNlKQorCQkJY29u
dGludWU7CisKKwkJb2Zmc2V0ID0gci0+b2Zmc2V0OworCQlpZiAoci0+cmVsYXRpdmUpCisJCQlv
ZmZzZXQgKz0gbW1pb19iYXNlOwogCi0JCWZvciAodW5zaWduZWQgY291bnQgPSByLT5jb3VudCA/
OiAxLCBvZmZzZXQgPSByLT5vZmZzZXQ7Ci0JCSAgICAgY291bnQtLTsgb2Zmc2V0ICs9IDQpIHsK
KwkJZm9yICh1bnNpZ25lZCBjb3VudCA9IHItPmNvdW50ID86IDE7IGNvdW50LS07IG9mZnNldCAr
PSA0KSB7CiAJCQkqYisrID0gMHgyNCA8PCAyMyB8ICgxICsgcjY0Yik7IC8qIFNSTSAqLwogCQkJ
KmIrKyA9IG9mZnNldDsKIAkJCXJlbG9jW25dLnRhcmdldF9oYW5kbGUgPSBvYmpbMF0uaGFuZGxl
OwpAQCAtMzU3LDYgKzM2NCw3IEBAIHN0YXRpYyB2b2lkIHdyaXRlX3JlZ3MoaW50IGZkLAogewog
CWNvbnN0IHVuc2lnbmVkIGludCBnZW5fYml0ID0gMSA8PCBpbnRlbF9nZW4oaW50ZWxfZ2V0X2Ry
bV9kZXZpZChmZCkpOwogCWNvbnN0IHVuc2lnbmVkIGludCBlbmdpbmVfYml0ID0gRU5HSU5FKGUt
PmNsYXNzLCBlLT5pbnN0YW5jZSk7CisJY29uc3QgdWludDMyX3QgbW1pb19iYXNlID0gZ2VtX2Vu
Z2luZV9tbWlvX2Jhc2UoZmQsIGUtPm5hbWUpOwogCXN0cnVjdCBkcm1faTkxNV9nZW1fZXhlY19v
YmplY3QyIG9iajsKIAlzdHJ1Y3QgZHJtX2k5MTVfZ2VtX2V4ZWNidWZmZXIyIGV4ZWNidWY7CiAJ
dW5zaWduZWQgaW50IGJhdGNoX3NpemU7CkBAIC0zNzIsMTIgKzM4MCwyMCBAQCBzdGF0aWMgdm9p
ZCB3cml0ZV9yZWdzKGludCBmZCwKIAlnZW1fc2V0X2RvbWFpbihmZCwgb2JqLmhhbmRsZSwKIAkJ
ICAgICAgIEk5MTVfR0VNX0RPTUFJTl9DUFUsIEk5MTVfR0VNX0RPTUFJTl9DUFUpOwogCWZvciAo
Y29uc3Qgc3RydWN0IG5hbWVkX3JlZ2lzdGVyICpyID0gbm9ucHJpdl9yZWdpc3RlcnM7IHItPm5h
bWU7IHIrKykgeworCQl1aW50MzJfdCBvZmZzZXQ7CisKIAkJaWYgKCEoci0+ZW5naW5lX21hc2sg
JiBlbmdpbmVfYml0KSkKIAkJCWNvbnRpbnVlOwogCQlpZiAoIShyLT5nZW5fbWFzayAmIGdlbl9i
aXQpKQogCQkJY29udGludWU7Ci0JCWZvciAodW5zaWduZWQgY291bnQgPSByLT5jb3VudCA/OiAx
LCBvZmZzZXQgPSByLT5vZmZzZXQ7Ci0JCSAgICAgY291bnQtLTsgb2Zmc2V0ICs9IDQpIHsKKwkJ
aWYgKHItPnJlbGF0aXZlICYmICFtbWlvX2Jhc2UpCisJCQljb250aW51ZTsKKworCQlvZmZzZXQg
PSByLT5vZmZzZXQ7CisJCWlmIChyLT5yZWxhdGl2ZSkKKwkJCW9mZnNldCArPSBtbWlvX2Jhc2U7
CisKKwkJZm9yICh1bnNpZ25lZCBjb3VudCA9IHItPmNvdW50ID86IDE7IGNvdW50LS07IG9mZnNl
dCArPSA0KSB7CiAJCQl1aW50MzJfdCB4ID0gdmFsdWU7CiAJCQlpZiAoci0+d3JpdGVfbWFzaykK
IAkJCQl4ICY9IHItPndyaXRlX21hc2s7CkBAIC00MTAsNiArNDI2LDcgQEAgc3RhdGljIHZvaWQg
cmVzdG9yZV9yZWdzKGludCBmZCwKIAljb25zdCB1bnNpZ25lZCBpbnQgZ2VuID0gaW50ZWxfZ2Vu
KGludGVsX2dldF9kcm1fZGV2aWQoZmQpKTsKIAljb25zdCB1bnNpZ25lZCBpbnQgZ2VuX2JpdCA9
IDEgPDwgZ2VuOwogCWNvbnN0IHVuc2lnbmVkIGludCBlbmdpbmVfYml0ID0gRU5HSU5FKGUtPmNs
YXNzLCBlLT5pbnN0YW5jZSk7CisJY29uc3QgdWludDMyX3QgbW1pb19iYXNlID0gZ2VtX2VuZ2lu
ZV9tbWlvX2Jhc2UoZmQsIGUtPm5hbWUpOwogCWNvbnN0IGJvb2wgcjY0YiA9IGdlbiA+PSA4Owog
CXN0cnVjdCBkcm1faTkxNV9nZW1fZXhlY19vYmplY3QyIG9ialsyXTsKIAlzdHJ1Y3QgZHJtX2k5
MTVfZ2VtX2V4ZWNidWZmZXIyIGV4ZWNidWY7CkBAIC00MzcsMTMgKzQ1NCwyMCBAQCBzdGF0aWMg
dm9pZCByZXN0b3JlX3JlZ3MoaW50IGZkLAogCiAJbiA9IDA7CiAJZm9yIChjb25zdCBzdHJ1Y3Qg
bmFtZWRfcmVnaXN0ZXIgKnIgPSBub25wcml2X3JlZ2lzdGVyczsgci0+bmFtZTsgcisrKSB7CisJ
CXVpbnQzMl90IG9mZnNldDsKKwogCQlpZiAoIShyLT5lbmdpbmVfbWFzayAmIGVuZ2luZV9iaXQp
KQogCQkJY29udGludWU7CiAJCWlmICghKHItPmdlbl9tYXNrICYgZ2VuX2JpdCkpCiAJCQljb250
aW51ZTsKKwkJaWYgKHItPnJlbGF0aXZlICYmICFtbWlvX2Jhc2UpCisJCQljb250aW51ZTsKKwor
CQlvZmZzZXQgPSByLT5vZmZzZXQ7CisJCWlmIChyLT5yZWxhdGl2ZSkKKwkJCW9mZnNldCArPSBt
bWlvX2Jhc2U7CiAKLQkJZm9yICh1bnNpZ25lZCBjb3VudCA9IHItPmNvdW50ID86IDEsIG9mZnNl
dCA9IHItPm9mZnNldDsKLQkJICAgICBjb3VudC0tOyBvZmZzZXQgKz0gNCkgeworCQlmb3IgKHVu
c2lnbmVkIGNvdW50ID0gci0+Y291bnQgPzogMTsgY291bnQtLTsgb2Zmc2V0ICs9IDQpIHsKIAkJ
CSpiKysgPSAweDI5IDw8IDIzIHwgKDEgKyByNjRiKTsgLyogTFJNICovCiAJCQkqYisrID0gb2Zm
c2V0OwogCQkJcmVsb2Nbbl0udGFyZ2V0X2hhbmRsZSA9IG9ialswXS5oYW5kbGU7CkBAIC00Nzks
NiArNTAzLDcgQEAgc3RhdGljIHZvaWQgZHVtcF9yZWdzKGludCBmZCwKIAljb25zdCBpbnQgZ2Vu
ID0gaW50ZWxfZ2VuKGludGVsX2dldF9kcm1fZGV2aWQoZmQpKTsKIAljb25zdCB1bnNpZ25lZCBp
bnQgZ2VuX2JpdCA9IDEgPDwgZ2VuOwogCWNvbnN0IHVuc2lnbmVkIGludCBlbmdpbmVfYml0ID0g
RU5HSU5FKGUtPmNsYXNzLCBlLT5pbnN0YW5jZSk7CisJY29uc3QgdWludDMyX3QgbW1pb19iYXNl
ID0gZ2VtX2VuZ2luZV9tbWlvX2Jhc2UoZmQsIGUtPm5hbWUpOwogCXVuc2lnbmVkIGludCByZWdz
X3NpemU7CiAJdWludDMyX3QgKm91dDsKIApAQCAtNDg5LDI2ICs1MTQsMzYgQEAgc3RhdGljIHZv
aWQgZHVtcF9yZWdzKGludCBmZCwKIAlnZW1fc2V0X2RvbWFpbihmZCwgcmVncywgSTkxNV9HRU1f
RE9NQUlOX0NQVSwgMCk7CiAKIAlmb3IgKGNvbnN0IHN0cnVjdCBuYW1lZF9yZWdpc3RlciAqciA9
IG5vbnByaXZfcmVnaXN0ZXJzOyByLT5uYW1lOyByKyspIHsKKwkJdWludDMyX3Qgb2Zmc2V0Owor
CiAJCWlmICghKHItPmVuZ2luZV9tYXNrICYgZW5naW5lX2JpdCkpCiAJCQljb250aW51ZTsKIAkJ
aWYgKCEoci0+Z2VuX21hc2sgJiBnZW5fYml0KSkKIAkJCWNvbnRpbnVlOworCQlpZiAoci0+cmVs
YXRpdmUgJiYgIW1taW9fYmFzZSkKKwkJCWNvbnRpbnVlOworCisJCW9mZnNldCA9IHItPm9mZnNl
dDsKKwkJaWYgKHItPnJlbGF0aXZlKQorCQkJb2Zmc2V0ICs9IG1taW9fYmFzZTsKIAogCQlpZiAo
ci0+Y291bnQgPD0gMSkgewogCQkJaWd0X2RlYnVnKCIweCUwNHggKCVzKTogMHglMDh4XG4iLAot
CQkJCSAgci0+b2Zmc2V0LCByLT5uYW1lLCBvdXRbci0+b2Zmc2V0LzRdKTsKKwkJCQkgIG9mZnNl
dCwgci0+bmFtZSwgb3V0W29mZnNldCAvIDRdKTsKIAkJfSBlbHNlIHsKIAkJCWZvciAodW5zaWdu
ZWQgeCA9IDA7IHggPCByLT5jb3VudDsgeCsrKQogCQkJCWlndF9kZWJ1ZygiMHglMDR4ICglc1sl
ZF0pOiAweCUwOHhcbiIsCi0JCQkJCSAgci0+b2Zmc2V0KzQqeCwgci0+bmFtZSwgeCwKLQkJCQkJ
ICBvdXRbci0+b2Zmc2V0LzQgKyB4XSk7CisJCQkJCSAgb2Zmc2V0ICsgNCAqIHgsIHItPm5hbWUs
IHgsCisJCQkJCSAgb3V0W29mZnNldCAvIDQgKyB4XSk7CiAJCX0KIAl9CiAJbXVubWFwKG91dCwg
cmVnc19zaXplKTsKIH0KIAotc3RhdGljIHZvaWQgY29tcGFyZV9yZWdzKGludCBmZCwgdWludDMy
X3QgQSwgdWludDMyX3QgQiwgY29uc3QgY2hhciAqd2hvKQorc3RhdGljIHZvaWQgY29tcGFyZV9y
ZWdzKGludCBmZCwgY29uc3Qgc3RydWN0IGludGVsX2V4ZWN1dGlvbl9lbmdpbmUyICplLAorCQkJ
IHVpbnQzMl90IEEsIHVpbnQzMl90IEIsIGNvbnN0IGNoYXIgKndobykKIHsKKwljb25zdCB1aW50
MzJfdCBtbWlvX2Jhc2UgPSBnZW1fZW5naW5lX21taW9fYmFzZShmZCwgZS0+bmFtZSk7CiAJdW5z
aWduZWQgaW50IG51bV9lcnJvcnM7CiAJdW5zaWduZWQgaW50IHJlZ3Nfc2l6ZTsKIAl1aW50MzJf
dCAqYSwgKmI7CkBAIC01MzIsMTEgKzU2NywxMSBAQCBzdGF0aWMgdm9pZCBjb21wYXJlX3JlZ3Mo
aW50IGZkLCB1aW50MzJfdCBBLCB1aW50MzJfdCBCLCBjb25zdCBjaGFyICp3aG8pCiAJCWlmIChh
W25dID09IGJbbl0pCiAJCQljb250aW51ZTsKIAotCQlpZiAoaWdub3JlX3JlZ2lzdGVyKG9mZnNl
dCkpCisJCWlmIChpZ25vcmVfcmVnaXN0ZXIob2Zmc2V0LCBtbWlvX2Jhc2UpKQogCQkJY29udGlu
dWU7CiAKIAkJbWFzayA9IH4wdTsKLQkJciA9IGxvb2t1cF9yZWdpc3RlcihvZmZzZXQpOworCQly
ID0gbG9va3VwX3JlZ2lzdGVyKG9mZnNldCwgbW1pb19iYXNlKTsKIAkJaWYgKHIgJiYgci0+bWFz
a2VkKQogCQkJbWFzayA+Pj0gMTY7CiAJCWlmIChyICYmIHItPmlnbm9yZV9iaXRzKQpAQCAtNTQ3
LDcgKzU4Miw3IEBAIHN0YXRpYyB2b2lkIGNvbXBhcmVfcmVncyhpbnQgZmQsIHVpbnQzMl90IEEs
IHVpbnQzMl90IEIsIGNvbnN0IGNoYXIgKndobykKIAogCQlpZ3Rfd2FybigiUmVnaXN0ZXIgMHgl
MDR4ICglcyk6IEE9JTA4eCBCPSUwOHhcbiIsCiAJCQkgb2Zmc2V0LAotCQkJIHJlZ2lzdGVyX25h
bWUob2Zmc2V0LCBidWYsIHNpemVvZihidWYpKSwKKwkJCSByZWdpc3Rlcl9uYW1lKG9mZnNldCwg
bW1pb19iYXNlLCBidWYsIHNpemVvZihidWYpKSwKIAkJCSBhW25dICYgbWFzaywgYltuXSAmIG1h
c2spOwogCQludW1fZXJyb3JzKys7CiAJfQpAQCAtNjM4LDcgKzY3Myw3IEBAIHN0YXRpYyB2b2lk
IG5vbnByaXYoaW50IGZkLAogCiAJCWlndF9zcGluX2ZyZWUoZmQsIHNwaW4pOwogCi0JCWNvbXBh
cmVfcmVncyhmZCwgdG1wbCwgcmVnc1sxXSwgIm5vbnByaXYgcmVhZC93cml0ZXMiKTsKKwkJY29t
cGFyZV9yZWdzKGZkLCBlLCB0bXBsLCByZWdzWzFdLCAibm9ucHJpdiByZWFkL3dyaXRlcyIpOwog
CiAJCWZvciAoaW50IG4gPSAwOyBuIDwgQVJSQVlfU0laRShyZWdzKTsgbisrKQogCQkJZ2VtX2Ns
b3NlKGZkLCByZWdzW25dKTsKQEAgLTcwOCw4ICs3NDMsOSBAQCBzdGF0aWMgdm9pZCBpc29sYXRp
b24oaW50IGZkLAogCQlpZ3Rfc3Bpbl9mcmVlKGZkLCBzcGluKTsKIAogCQlpZiAoIShmbGFncyAm
IERJUlRZMSkpCi0JCQljb21wYXJlX3JlZ3MoZmQsIHJlZ3NbMF0sIHRtcCwgInR3byByZWFkcyBv
ZiB0aGUgc2FtZSBjdHgiKTsKLQkJY29tcGFyZV9yZWdzKGZkLCByZWdzWzBdLCByZWdzWzFdLCAi
dHdvIHZpcmdpbiBjb250ZXh0cyIpOworCQkJY29tcGFyZV9yZWdzKGZkLCBlLCByZWdzWzBdLCB0
bXAsCisJCQkJICAgICAidHdvIHJlYWRzIG9mIHRoZSBzYW1lIGN0eCIpOworCQljb21wYXJlX3Jl
Z3MoZmQsIGUsIHJlZ3NbMF0sIHJlZ3NbMV0sICJ0d28gdmlyZ2luIGNvbnRleHRzIik7CiAKIAkJ
Zm9yIChpbnQgbiA9IDA7IG4gPCBBUlJBWV9TSVpFKGN0eCk7IG4rKykgewogCQkJZ2VtX2Nsb3Nl
KGZkLCByZWdzW25dKTsKQEAgLTgyOSwxMyArODY1LDEzIEBAIHN0YXRpYyB2b2lkIHByZXNlcnZh
dGlvbihpbnQgZmQsCiAJCWNoYXIgYnVmWzgwXTsKIAogCQlzbnByaW50ZihidWYsIHNpemVvZihi
dWYpLCAiZGlydHkgJXggY29udGV4dFxuIiwgdmFsdWVzW3ZdKTsKLQkJY29tcGFyZV9yZWdzKGZk
LCByZWdzW3ZdWzBdLCByZWdzW3ZdWzFdLCBidWYpOworCQljb21wYXJlX3JlZ3MoZmQsIGUsIHJl
Z3Nbdl1bMF0sIHJlZ3Nbdl1bMV0sIGJ1Zik7CiAKIAkJZ2VtX2Nsb3NlKGZkLCByZWdzW3ZdWzBd
KTsKIAkJZ2VtX2Nsb3NlKGZkLCByZWdzW3ZdWzFdKTsKIAkJZ2VtX2NvbnRleHRfZGVzdHJveShm
ZCwgY3R4W3ZdKTsKIAl9Ci0JY29tcGFyZV9yZWdzKGZkLCByZWdzW251bV92YWx1ZXNdWzBdLCBy
ZWdzW251bV92YWx1ZXNdWzFdLCAiY2xlYW4iKTsKKwljb21wYXJlX3JlZ3MoZmQsIGUsIHJlZ3Nb
bnVtX3ZhbHVlc11bMF0sIHJlZ3NbbnVtX3ZhbHVlc11bMV0sICJjbGVhbiIpOwogCWdlbV9jb250
ZXh0X2Rlc3Ryb3koZmQsIGN0eFtudW1fdmFsdWVzXSk7CiB9CiAKLS0gCjIuMjQuMAoKX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxp
bmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJl
ZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

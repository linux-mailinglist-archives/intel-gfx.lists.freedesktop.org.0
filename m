Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 48570F5195
	for <lists+intel-gfx@lfdr.de>; Fri,  8 Nov 2019 17:51:06 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 87E7D6FA0E;
	Fri,  8 Nov 2019 16:51:04 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 0CF426FA0E
 for <intel-gfx@lists.freedesktop.org>; Fri,  8 Nov 2019 16:51:02 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 19131622-1500050 
 for multiple; Fri, 08 Nov 2019 16:50:47 +0000
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Fri,  8 Nov 2019 16:50:46 +0000
Message-Id: <20191108165046.25545-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.24.0
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH i-g-t] tools: Add a simple rapl wrapper
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

UnVuIGEgY29tbWFuZDsgcHJpbnQgaG93IG11Y2ggcG93ZXIgcmFwbCByZXBvcnRlZCB0aGUgc3lz
dGVtIHVzaW5nLgoKU2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxz
b24uY28udWs+CkNjOiBBbmRpIFNoeXRpIDxhbmRpLnNoeXRpQGludGVsLmNvbT4KQ2M6IFR2cnRr
byBVcnN1bGluIDx0dnJ0a28udXJzdWxpbkBpbnRlbC5jb20+Ci0tLQogdG9vbHMvaWd0X3JhcGwu
YyAgfCAyMDIgKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKwog
dG9vbHMvbWVzb24uYnVpbGQgfCAgIDUgKysKIDIgZmlsZXMgY2hhbmdlZCwgMjA3IGluc2VydGlv
bnMoKykKIGNyZWF0ZSBtb2RlIDEwMDY0NCB0b29scy9pZ3RfcmFwbC5jCgpkaWZmIC0tZ2l0IGEv
dG9vbHMvaWd0X3JhcGwuYyBiL3Rvb2xzL2lndF9yYXBsLmMKbmV3IGZpbGUgbW9kZSAxMDA2NDQK
aW5kZXggMDAwMDAwMDAwLi44ZDk4NTY4MWYKLS0tIC9kZXYvbnVsbAorKysgYi90b29scy9pZ3Rf
cmFwbC5jCkBAIC0wLDAgKzEsMjAyIEBACisjaW5jbHVkZSA8Y3R5cGUuaD4KKyNpbmNsdWRlIDxl
cnJuby5oPgorI2luY2x1ZGUgPGZjbnRsLmg+CisjaW5jbHVkZSA8aW50dHlwZXMuaD4KKyNpbmNs
dWRlIDxsb2NhbGUuaD4KKyNpbmNsdWRlIDxtYXRoLmg+CisjaW5jbHVkZSA8c3RkYXJnLmg+Cisj
aW5jbHVkZSA8c3RkYm9vbC5oPgorI2luY2x1ZGUgPHN0ZGlvLmg+CisjaW5jbHVkZSA8c3RyaW5n
Lmg+CisjaW5jbHVkZSA8c3lzL3dhaXQuaD4KKyNpbmNsdWRlIDx1bmlzdGQuaD4KKworI2luY2x1
ZGUgImlndF9wZXJmLmgiCisKK3N0cnVjdCBwYXJzZSB7CisJdWludDY0X3QgY29uZmlnLCB0eXBl
OworfTsKKworc3RydWN0IHJhcGwgeworCWNvbnN0IGNoYXIgKm5hbWU7CisJZG91YmxlIHNjYWxl
OworCWludCBmZDsKK307CisKK19fYXR0cmlidXRlX18oKGZvcm1hdChzY2FuZiwzLDQpKSkKK3N0
YXRpYyBpbnQgZGlyX3NjYW5mKGludCBkaXIsIGNvbnN0IGNoYXIgKmF0dHIsIGNvbnN0IGNoYXIg
KmZtdCwgLi4uKQoreworCUZJTEUgKmZpbGU7CisJaW50IGZkOworCWludCByZXQgPSAtMTsKKwor
CWZkID0gb3BlbmF0KGRpciwgYXR0ciwgT19SRE9OTFkpOworCWlmIChmZCA8IDApCisJCXJldHVy
biAtMTsKKworCWZpbGUgPSBmZG9wZW4oZmQsICJyIik7CisJaWYgKGZpbGUpIHsKKwkJdmFfbGlz
dCBhcDsKKworCQl2YV9zdGFydChhcCwgZm10KTsKKwkJcmV0ID0gdmZzY2FuZihmaWxlLCBmbXQs
IGFwKTsKKwkJdmFfZW5kKGFwKTsKKworCQlmY2xvc2UoZmlsZSk7CisJfSBlbHNlIHsKKwkJY2xv
c2UoZmQpOworCX0KKworCXJldHVybiByZXQ7Cit9CisKK3N0YXRpYyBpbnQgcmFwbF9wYXJzZShz
dHJ1Y3QgcGFyc2UgKnIsIGNvbnN0IGNoYXIgKnN0ciwgZG91YmxlICpzY2FsZSkKK3sKKwlsb2Nh
bGVfdCBsb2NhbGUsIG9sZGxvY2FsZTsKKwlib29sIHJlc3VsdCA9IHRydWU7CisJY2hhciBidWZb
MTI4XTsKKwlpbnQgZGlyOworCisJbWVtc2V0KHIsIDAsIHNpemVvZigqcikpOworCisJZGlyID0g
b3BlbigiL3N5cy9kZXZpY2VzL3Bvd2VyIiwgT19SRE9OTFkpOworCWlmIChkaXIgPCAwKQorCQly
ZXR1cm4gLWVycm5vOworCisJLyogUmVwbGFjZSB1c2VyIGVudmlyb25tZW50IHdpdGggcGxhaW4g
QyB0byBtYXRjaCBrZXJuZWwgZm9ybWF0ICovCisJbG9jYWxlID0gbmV3bG9jYWxlKExDX0FMTCwg
IkMiLCAwKTsKKwlvbGRsb2NhbGUgPSB1c2Vsb2NhbGUobG9jYWxlKTsKKworCXJlc3VsdCAmPSBk
aXJfc2NhbmYoZGlyLCAidHlwZSIsICIlIlBSSXU2NCwgJnItPnR5cGUpID09IDE7CisKKwlzbnBy
aW50ZihidWYsIHNpemVvZihidWYpLCAiZXZlbnRzL2VuZXJneS0lcyIsIHN0cik7CisJcmVzdWx0
ICY9IGRpcl9zY2FuZihkaXIsIGJ1ZiwgImV2ZW50PSUiUFJJeDY0LCAmci0+Y29uZmlnKSA9PSAx
OworCisJc25wcmludGYoYnVmLCBzaXplb2YoYnVmKSwgImV2ZW50cy9lbmVyZ3ktJXMuc2NhbGUi
LCBzdHIpOworCXJlc3VsdCAmPSBkaXJfc2NhbmYoZGlyLCBidWYsICIlbGYiLCBzY2FsZSkgPT0g
MTsKKworCXVzZWxvY2FsZShvbGRsb2NhbGUpOworCWZyZWVsb2NhbGUobG9jYWxlKTsKKworCWNs
b3NlKGRpcik7CisKKwlpZiAoIXJlc3VsdCkKKwkJcmV0dXJuIC1FSU5WQUw7CisKKwlpZiAoaXNu
YW4oKnNjYWxlKSB8fCAhKnNjYWxlKQorCQlyZXR1cm4gLUVSQU5HRTsKKworCXJldHVybiAwOwor
fQorCitzdGF0aWMgaW50IHJhcGxfb3BlbihpbnQgZmQsIGNvbnN0IGNoYXIgKmRvbWFpbiwgZG91
YmxlICpzY2FsZSkKK3sKKwlzdHJ1Y3QgcGFyc2UgcjsKKwlpbnQgZXJyOworCisJZXJyID0gcmFw
bF9wYXJzZSgmciwgZG9tYWluLCBzY2FsZSk7CisJaWYgKGVyciA8IDApCisJCWdvdG8gZXJyOwor
CisJcmV0dXJuIGlndF9wZXJmX29wZW5fZ3JvdXAoci50eXBlLCByLmNvbmZpZywgZmQpOworCitl
cnI6CisJZXJybm8gPSAwOworCXJldHVybiBlcnI7Cit9CisKK3N0YXRpYyBpbnQgcnVuaXQoc3Ry
dWN0IHJhcGwgKnIsIGludCBjb3VudCwgaW50IGFyZ2MsIGNoYXIgKiphcmd2KQoreworCWludCBy
ZXQsIHN0YXR1czsKKworCXN3aXRjaCAocmV0ID0gZm9yaygpKSB7CisJY2FzZSAtMTogcmV0dXJu
IGVycm5vOworCWNhc2UgMDogLyogY2hpbGQgKi8KKwkJIHdoaWxlIChjb3VudC0tKQorCQkJIGNs
b3NlKHJbY291bnRdLmZkKTsKKwkJIGV4ZWN2cChhcmd2WzBdLCBhcmd2KTsKKwkJIGV4aXQoMSk7
CisJCSBicmVhazsKKwlkZWZhdWx0OiAvKiBwYXJlbnQgKi8KKwkJIGlmICh3YWl0KCZzdGF0dXMp
IDwgMCkgeworCQkJIGtpbGwocmV0LCBTSUdLSUxMKTsKKwkJCSByZXR1cm4gZXJybm87CisJCSB9
CisKKwkJIHJldHVybiBzdGF0dXM7CisJfQorfQorCitzdGF0aWMgaW5saW5lIGRvdWJsZSBwb3dl
cl9KKGNvbnN0IHVpbnQ2NF90IHAwLAorCQkJICAgICBjb25zdCB1aW50NjRfdCBwMSwKKwkJCSAg
ICAgY29uc3QgZG91YmxlIHNjYWxlKQoreworCXJldHVybiAocDEgLSBwMCkgKiBzY2FsZTsKK30K
Kworc3RhdGljIGlubGluZSBkb3VibGUgcG93ZXJfcyhjb25zdCB1aW50NjRfdCB0MCwKKwkJCSAg
ICAgY29uc3QgdWludDY0X3QgdDEpCit7CisJcmV0dXJuICh0MSAtIHQwKSAqIDFlLTk7Cit9CisK
K3N0YXRpYyBpbmxpbmUgZG91YmxlIHBvd2VyX1coY29uc3QgdWludDY0X3QgKnMwLAorCQkJICAg
ICBjb25zdCB1aW50NjRfdCAqczEsCisJCQkgICAgIGludCBpZHgsCisJCQkgICAgIGNvbnN0IGRv
dWJsZSBzY2FsZSkKK3sKKwlyZXR1cm4gcG93ZXJfSihzMFtpZHgrMl0sIHMxW2lkeCsyXSwgc2Nh
bGUpIC8gcG93ZXJfcyhzMFsxXSwgczFbMV0pOworfQorCitzdGF0aWMgaW50IHJhcGxfcmVhZChp
bnQgZmQsIHVpbnQ2NF90ICpkYXRhLCBpbnQgY291bnQpCit7CisJaWYgKHJlYWQoZmQsIGRhdGEs
IChjb3VudCArIDIpICogc2l6ZW9mKGRhdGFbMF0pKSA8IDApCisJCXJldHVybiAtZXJybm87CisK
KwlyZXR1cm4gMDsKK30KKworaW50IG1haW4oaW50IGFyZ2MsIGNoYXIgKiphcmd2KQoreworCXN0
YXRpYyBjb25zdCBjaGFyICpkb21haW5zW10gPSB7ICJncHUiLCAicGtnIiwgLyogInJhbSIgICov
fTsKKwl1aW50NjRfdCBiZWZvcmVbOF0gPSB7fSwgYWZ0ZXJbOF0gPSB7fTsKKwlzdHJ1Y3QgcmFw
bCByWzRdOworCWludCBjb3VudCA9IDA7CisJaW50IHJldDsKKwlpbnQgaTsKKworCXJbMF0uZmQg
PSAtMTsKKwlmb3IgKGkgPSAwOyBpIDwgc2l6ZW9mKGRvbWFpbnMpL3NpemVvZigqZG9tYWlucyk7
IGkrKykgeworCQlyW2NvdW50XS5mZCA9IHJhcGxfb3BlbihyWzBdLmZkLCBkb21haW5zW2ldLCAm
cltjb3VudF0uc2NhbGUpOworCQlpZiAocltjb3VudF0uZmQgPCAwKQorCQkJY29udGludWU7CisK
KwkJcltjb3VudCsrXS5uYW1lID0gZG9tYWluc1tpXTsKKwl9CisJaWYgKCFjb3VudCkgeworCQlm
cHJpbnRmKHN0ZGVyciwgIlVuYWJsZSB0byBvcGVuIGFueSByYXBsIHBvd2VyIGRvbWFpbnNcbiIp
OworCQlyZXR1cm4gMTsKKwl9CisKKwlyZXQgPSByYXBsX3JlYWQoclswXS5mZCwgYmVmb3JlLCBj
b3VudCk7CisJaWYgKHJldCA8IDApIHsKKwkJZnByaW50ZihzdGRlcnIsICJVbmFibGUgdG8gcmVh
ZCBwZXJmIGV2ZW50XG4iKTsKKwkJcmV0dXJuIDE7CisJfQorCisJcmV0ID0gcnVuaXQociwgY291
bnQsIGFyZ2MgLSAxLCBhcmd2ICsgMSk7CisKKwlyZXQgPSByYXBsX3JlYWQoclswXS5mZCwgYWZ0
ZXIsIGNvdW50KTsKKwlpZiAocmV0IDwgMCkgeworCQlmcHJpbnRmKHN0ZGVyciwgIlVuYWJsZSB0
byByZWFkIHBlcmYgZXZlbnRcbiIpOworCQlyZXR1cm4gMTsKKwl9CisKKwlwcmludGYoInRpbWU6
JS4yZm1zIiwgcG93ZXJfcyhiZWZvcmVbMV0sIGFmdGVyWzFdKSAqIDFlMyk7CisJZm9yIChpID0g
MDsgaSA8IGNvdW50OyBpKyspCisJCXByaW50ZigiLCAlczolLjJmbXMiLAorCQkgICAgICAgcltp
XS5uYW1lLCBwb3dlcl9XKGJlZm9yZSwgYWZ0ZXIsIGksIHJbaV0uc2NhbGUpICogMWUzKTsKKwlw
cmludGYoIlxuIik7CisKKwlyZXR1cm4gcmV0OworfQpkaWZmIC0tZ2l0IGEvdG9vbHMvbWVzb24u
YnVpbGQgYi90b29scy9tZXNvbi5idWlsZAppbmRleCBlZWNiMTIyYmMuLjViNDYyYzEzMSAxMDA2
NDQKLS0tIGEvdG9vbHMvbWVzb24uYnVpbGQKKysrIGIvdG9vbHMvbWVzb24uYnVpbGQKQEAgLTEw
MCw2ICsxMDAsMTEgQEAgZXhlY3V0YWJsZSgnaW50ZWxfZ3B1X3RvcCcsICdpbnRlbF9ncHVfdG9w
LmMnLAogCSAgIGluc3RhbGxfcnBhdGggOiBiaW5kaXJfcnBhdGhkaXIsCiAJICAgZGVwZW5kZW5j
aWVzIDogbGliX2lndF9wZXJmKQogCitleGVjdXRhYmxlKCdpZ3RfcmFwbCcsICdpZ3RfcmFwbC5j
JywKKwkgICBpbnN0YWxsIDogdHJ1ZSwKKwkgICBpbnN0YWxsX3JwYXRoIDogYmluZGlyX3JwYXRo
ZGlyLAorCSAgIGRlcGVuZGVuY2llcyA6IGxpYl9pZ3RfcGVyZikKKwogZXhlY3V0YWJsZSgnYW1k
X2hkbWlfY29tcGxpYW5jZScsICdhbWRfaGRtaV9jb21wbGlhbmNlLmMnLAogCSAgIGRlcGVuZGVu
Y2llcyA6IFt0b29sX2RlcHNdLAogCSAgIGluc3RhbGxfcnBhdGggOiBiaW5kaXJfcnBhdGhkaXIs
Ci0tIAoyLjI0LjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9y
ZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWdm
eA==

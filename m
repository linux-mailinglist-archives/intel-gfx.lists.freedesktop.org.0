Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 9493C47B80
	for <lists+intel-gfx@lfdr.de>; Mon, 17 Jun 2019 09:41:45 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id E070A89067;
	Mon, 17 Jun 2019 07:41:43 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 2568589067
 for <intel-gfx@lists.freedesktop.org>; Mon, 17 Jun 2019 07:41:41 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 16923037-1500050 
 for multiple; Mon, 17 Jun 2019 08:19:12 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 17 Jun 2019 08:18:52 +0100
Message-Id: <20190617071912.20256-2-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190617071912.20256-1-chris@chris-wilson.co.uk>
References: <20190617071912.20256-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 02/22] drm/i915/gtt: Serialise both updates to
 PDE and our shadow
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: matthew.auld@intel.com, mika.kuoppala@intel.com
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

Q3VycmVudGx5LCB3ZSBwZXJmb3JtIGEgbG9ja2VkIHVwZGF0ZSBvZiB0aGUgc2hhZG93IGVudHJ5
IHdoZW4KYWxsb2NhdGluZyBhIHBhZ2UgZGlyZWN0b3J5IGVudHJ5IHN1Y2ggdGhhdCBpZiB0d28g
Y2xpZW50cyBhcmUKY29uY3VycmVudGx5IGFsbG9jYXRpbmcgbmVpZ2hib3VyaW5nIHJhbmdlcyB3
ZSBvbmx5IGluc2VydCBvbmUgbmV3IGVudHJ5CmZvciB0aGUgcGFpciBvZiB0aGVtLiBIb3dldmVy
LCB3ZSBhbHNvIG5lZWQgdG8gc2VyaWFsaXNlIGJvdGggY2xpZW50cwp3cnQgdG8gdGhlIGFjdHVh
bCBlbnRyeSBpbiB0aGUgSFcgdGFibGUsIG9yIGVsc2Ugd2UgbWF5IGFsbG93IG9uZSBjbGllbnQK
b3IgZXZlbiBhIHRoaXJkIGNsaWVudCB0byBwcm9jZWVkIGFoZWFkIG9mIHRoZSBIVyB3cml0ZS4g
TXkgaGFuZHdhdmUKYmVmb3JlIHdhcyB0aGF0IHVuZGVyIHRoZSBfcGF0aG9sb2dpY2FsXyBjb25k
aXRpb24gd2Ugd291bGQgc2VlIHRoZQpzY3JhdGNoIGVudHJ5IGluc3RlYWQgb2YgdGhlIGV4cGVj
dGVkIGVudHJ5LCBjYXVzaW5nIGEgdGVtcG9yYXJ5CmdsaXRjaC4gVGhhdCBzdGFydmF0aW9uIGNv
bmRpdGlvbiB3aWxsIGV2ZW50dWFsbHkgc2hvdyB1cCBpbiBwcmFjdGljZSwgc28KZml4IGl0LgoK
VGhlIHJlYXNvbiBmb3IgdGhlIHByZXZpb3VzIGNoZWF0IHdhcyB0byBhdm9pZCBoYXZpbmcgdG8g
ZnJlZSB0aGUgZXh0cmEKYWxsb2NhdGlvbiB3aGlsZSB1bmRlciB0aGUgc3BpbmxvY2suIE5vdywg
d2Uga2VlcCB0aGUgZXh0cmEgZW50cnkKYWxsb2NhdGVkIHVudGlsIHRoZSBlbmQgaW5zdGVhZC4K
CkZpeGVzOiAxZDFiNTQ5MGI5MWMgKCJkcm0vaTkxNS9ndHQ6IFJlcGxhY2Ugc3RydWN0X211dGV4
IHNlcmlhbGlzYXRpb24gZm9yIGFsbG9jYXRpb24iKQpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxz
b24gPGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KQ2M6IE1hdHRoZXcgQXVsZCA8bWF0dGhldy5h
dWxkQGludGVsLmNvbT4KQ2M6IE1pa2EgS3VvcHBhbGEgPG1pa2Eua3VvcHBhbGFAaW50ZWwuY29t
PgotLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtX2d0dC5jIHwgMTI2ICsrKysrKysr
KysrKysrKy0tLS0tLS0tLS0tLS0KIDEgZmlsZSBjaGFuZ2VkLCA2OSBpbnNlcnRpb25zKCspLCA1
NyBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dl
bV9ndHQuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtX2d0dC5jCmluZGV4IDI3OGRl
MDRhOTZhYS4uN2NjMjBjYWZiZTFlIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9p
OTE1X2dlbV9ndHQuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuYwpA
QCAtMTM4Niw4MiArMTM4Niw4OCBAQCBzdGF0aWMgaW50IGdlbjhfcHBndHRfYWxsb2NfcGQoc3Ry
dWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCiAJCQkgICAgICAgc3RydWN0IGk5MTVfcGFnZV9k
aXJlY3RvcnkgKnBkLAogCQkJICAgICAgIHU2NCBzdGFydCwgdTY0IGxlbmd0aCkKIHsKKwlzdHJ1
Y3QgaTkxNV9wYWdlX3RhYmxlICphbGxvYyA9IE5VTEw7CiAJc3RydWN0IGk5MTVfcGFnZV90YWJs
ZSAqcHQ7CiAJdTY0IGZyb20gPSBzdGFydDsKIAl1bnNpZ25lZCBpbnQgcGRlOworCWludCByZXQg
PSAwOwogCiAJc3Bpbl9sb2NrKCZwZC0+bG9jayk7CiAJZ2VuOF9mb3JfZWFjaF9wZGUocHQsIHBk
LCBzdGFydCwgbGVuZ3RoLCBwZGUpIHsKIAkJY29uc3QgaW50IGNvdW50ID0gZ2VuOF9wdGVfY291
bnQoc3RhcnQsIGxlbmd0aCk7CiAKIAkJaWYgKHB0ID09IHZtLT5zY3JhdGNoX3B0KSB7Ci0JCQlz
dHJ1Y3QgaTkxNV9wYWdlX3RhYmxlICpvbGQ7Ci0KIAkJCXNwaW5fdW5sb2NrKCZwZC0+bG9jayk7
CiAKLQkJCXB0ID0gYWxsb2NfcHQodm0pOwotCQkJaWYgKElTX0VSUihwdCkpCisJCQlwdCA9IGZl
dGNoX2FuZF96ZXJvKCZhbGxvYyk7CisJCQlpZiAoIXB0KQorCQkJCXB0ID0gYWxsb2NfcHQodm0p
OworCQkJaWYgKElTX0VSUihwdCkpIHsKKwkJCQlyZXQgPSBQVFJfRVJSKHB0KTsKIAkJCQlnb3Rv
IHVud2luZDsKKwkJCX0KIAogCQkJaWYgKGNvdW50IDwgR0VOOF9QVEVTIHx8IGludGVsX3ZncHVf
YWN0aXZlKHZtLT5pOTE1KSkKIAkJCQlnZW44X2luaXRpYWxpemVfcHQodm0sIHB0KTsKIAotCQkJ
b2xkID0gY21weGNoZygmcGQtPnBhZ2VfdGFibGVbcGRlXSwgdm0tPnNjcmF0Y2hfcHQsIHB0KTsK
LQkJCWlmIChvbGQgPT0gdm0tPnNjcmF0Y2hfcHQpIHsKKwkJCXNwaW5fbG9jaygmcGQtPmxvY2sp
OworCQkJaWYgKHBkLT5wYWdlX3RhYmxlW3BkZV0gPT0gdm0tPnNjcmF0Y2hfcHQpIHsKIAkJCQln
ZW44X3BwZ3R0X3NldF9wZGUodm0sIHBkLCBwdCwgcGRlKTsKKwkJCQlwZC0+cGFnZV90YWJsZVtw
ZGVdID0gcHQ7CiAJCQkJYXRvbWljX2luYygmcGQtPnVzZWRfcGRlcyk7CiAJCQl9IGVsc2Ugewot
CQkJCWZyZWVfcHQodm0sIHB0KTsKLQkJCQlwdCA9IG9sZDsKKwkJCQlhbGxvYyA9IHB0OworCQkJ
CXB0ID0gcGQtPnBhZ2VfdGFibGVbcGRlXTsKIAkJCX0KLQotCQkJc3Bpbl9sb2NrKCZwZC0+bG9j
ayk7CiAJCX0KIAogCQlhdG9taWNfYWRkKGNvdW50LCAmcHQtPnVzZWRfcHRlcyk7CiAJfQogCXNw
aW5fdW5sb2NrKCZwZC0+bG9jayk7Ci0KLQlyZXR1cm4gMDsKKwlnb3RvIG91dDsKIAogdW53aW5k
OgogCWdlbjhfcHBndHRfY2xlYXJfcGQodm0sIHBkLCBmcm9tLCBzdGFydCAtIGZyb20pOwotCXJl
dHVybiAtRU5PTUVNOworb3V0OgorCWlmIChhbGxvYykKKwkJZnJlZV9wdCh2bSwgYWxsb2MpOwor
CXJldHVybiByZXQ7CiB9CiAKIHN0YXRpYyBpbnQgZ2VuOF9wcGd0dF9hbGxvY19wZHAoc3RydWN0
IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCiAJCQkJc3RydWN0IGk5MTVfcGFnZV9kaXJlY3Rvcnlf
cG9pbnRlciAqcGRwLAogCQkJCXU2NCBzdGFydCwgdTY0IGxlbmd0aCkKIHsKKwlzdHJ1Y3QgaTkx
NV9wYWdlX2RpcmVjdG9yeSAqYWxsb2MgPSBOVUxMOwogCXN0cnVjdCBpOTE1X3BhZ2VfZGlyZWN0
b3J5ICpwZDsKIAl1NjQgZnJvbSA9IHN0YXJ0OwogCXVuc2lnbmVkIGludCBwZHBlOwotCWludCBy
ZXQ7CisJaW50IHJldCA9IDA7CiAKIAlzcGluX2xvY2soJnBkcC0+bG9jayk7CiAJZ2VuOF9mb3Jf
ZWFjaF9wZHBlKHBkLCBwZHAsIHN0YXJ0LCBsZW5ndGgsIHBkcGUpIHsKIAkJaWYgKHBkID09IHZt
LT5zY3JhdGNoX3BkKSB7Ci0JCQlzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeSAqb2xkOwotCiAJ
CQlzcGluX3VubG9jaygmcGRwLT5sb2NrKTsKIAotCQkJcGQgPSBhbGxvY19wZCh2bSk7Ci0JCQlp
ZiAoSVNfRVJSKHBkKSkKKwkJCXBkID0gZmV0Y2hfYW5kX3plcm8oJmFsbG9jKTsKKwkJCWlmICgh
cGQpCisJCQkJcGQgPSBhbGxvY19wZCh2bSk7CisJCQlpZiAoSVNfRVJSKHBkKSkgeworCQkJCXJl
dCA9IFBUUl9FUlIocGQpOwogCQkJCWdvdG8gdW53aW5kOworCQkJfQogCiAJCQlnZW44X2luaXRp
YWxpemVfcGQodm0sIHBkKTsKIAotCQkJb2xkID0gY21weGNoZygmcGRwLT5wYWdlX2RpcmVjdG9y
eVtwZHBlXSwKLQkJCQkgICAgICB2bS0+c2NyYXRjaF9wZCwgcGQpOwotCQkJaWYgKG9sZCA9PSB2
bS0+c2NyYXRjaF9wZCkgeworCQkJc3Bpbl9sb2NrKCZwZHAtPmxvY2spOworCQkJaWYgKHBkcC0+
cGFnZV9kaXJlY3RvcnlbcGRwZV0gPT0gdm0tPnNjcmF0Y2hfcGQpIHsKIAkJCQlnZW44X3BwZ3R0
X3NldF9wZHBlKHZtLCBwZHAsIHBkLCBwZHBlKTsKKwkJCQlwZHAtPnBhZ2VfZGlyZWN0b3J5W3Bk
cGVdID0gcGQ7CiAJCQkJYXRvbWljX2luYygmcGRwLT51c2VkX3BkcGVzKTsKIAkJCX0gZWxzZSB7
Ci0JCQkJZnJlZV9wZCh2bSwgcGQpOwotCQkJCXBkID0gb2xkOworCQkJCWFsbG9jID0gcGQ7CisJ
CQkJcGQgPSBwZHAtPnBhZ2VfZGlyZWN0b3J5W3BkcGVdOwogCQkJfQotCi0JCQlzcGluX2xvY2so
JnBkcC0+bG9jayk7CiAJCX0KIAkJYXRvbWljX2luYygmcGQtPnVzZWRfcGRlcyk7CiAJCXNwaW5f
dW5sb2NrKCZwZHAtPmxvY2spOwpAQCAtMTQ3NCw4ICsxNDgwLDcgQEAgc3RhdGljIGludCBnZW44
X3BwZ3R0X2FsbG9jX3BkcChzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKIAkJYXRvbWlj
X2RlYygmcGQtPnVzZWRfcGRlcyk7CiAJfQogCXNwaW5fdW5sb2NrKCZwZHAtPmxvY2spOwotCi0J
cmV0dXJuIDA7CisJZ290byBvdXQ7CiAKIHVud2luZF9wZDoKIAlzcGluX2xvY2soJnBkcC0+bG9j
ayk7CkBAIC0xNDg4LDcgKzE0OTMsMTAgQEAgc3RhdGljIGludCBnZW44X3BwZ3R0X2FsbG9jX3Bk
cChzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKIAlzcGluX3VubG9jaygmcGRwLT5sb2Nr
KTsKIHVud2luZDoKIAlnZW44X3BwZ3R0X2NsZWFyX3BkcCh2bSwgcGRwLCBmcm9tLCBzdGFydCAt
IGZyb20pOwotCXJldHVybiAtRU5PTUVNOworb3V0OgorCWlmIChhbGxvYykKKwkJZnJlZV9wZCh2
bSwgYWxsb2MpOworCXJldHVybiByZXQ7CiB9CiAKIHN0YXRpYyBpbnQgZ2VuOF9wcGd0dF9hbGxv
Y18zbHZsKHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLApAQCAtMTUwMywzMyArMTUxMSwz
NSBAQCBzdGF0aWMgaW50IGdlbjhfcHBndHRfYWxsb2NfNGx2bChzdHJ1Y3QgaTkxNV9hZGRyZXNz
X3NwYWNlICp2bSwKIHsKIAlzdHJ1Y3QgaTkxNV9wcGd0dCAqcHBndHQgPSBpOTE1X3ZtX3RvX3Bw
Z3R0KHZtKTsKIAlzdHJ1Y3QgaTkxNV9wbWw0ICpwbWw0ID0gJnBwZ3R0LT5wbWw0OworCXN0cnVj
dCBpOTE1X3BhZ2VfZGlyZWN0b3J5X3BvaW50ZXIgKmFsbG9jID0gTlVMTDsKIAlzdHJ1Y3QgaTkx
NV9wYWdlX2RpcmVjdG9yeV9wb2ludGVyICpwZHA7CiAJdTY0IGZyb20gPSBzdGFydDsKKwlpbnQg
cmV0ID0gMDsKIAl1MzIgcG1sNGU7Ci0JaW50IHJldDsKIAogCXNwaW5fbG9jaygmcG1sNC0+bG9j
ayk7CiAJZ2VuOF9mb3JfZWFjaF9wbWw0ZShwZHAsIHBtbDQsIHN0YXJ0LCBsZW5ndGgsIHBtbDRl
KSB7CiAJCWlmIChwZHAgPT0gdm0tPnNjcmF0Y2hfcGRwKSB7Ci0JCQlzdHJ1Y3QgaTkxNV9wYWdl
X2RpcmVjdG9yeV9wb2ludGVyICpvbGQ7Ci0KIAkJCXNwaW5fdW5sb2NrKCZwbWw0LT5sb2NrKTsK
IAotCQkJcGRwID0gYWxsb2NfcGRwKHZtKTsKLQkJCWlmIChJU19FUlIocGRwKSkKKwkJCXBkcCA9
IGZldGNoX2FuZF96ZXJvKCZhbGxvYyk7CisJCQlpZiAoIXBkcCkKKwkJCQlwZHAgPSBhbGxvY19w
ZHAodm0pOworCQkJaWYgKElTX0VSUihwZHApKSB7CisJCQkJcmV0ID0gUFRSX0VSUihwZHApOwog
CQkJCWdvdG8gdW53aW5kOworCQkJfQogCiAJCQlnZW44X2luaXRpYWxpemVfcGRwKHZtLCBwZHAp
OwogCi0JCQlvbGQgPSBjbXB4Y2hnKCZwbWw0LT5wZHBzW3BtbDRlXSwgdm0tPnNjcmF0Y2hfcGRw
LCBwZHApOwotCQkJaWYgKG9sZCA9PSB2bS0+c2NyYXRjaF9wZHApIHsKKwkJCXNwaW5fbG9jaygm
cG1sNC0+bG9jayk7CisJCQlpZiAocG1sNC0+cGRwc1twbWw0ZV0gPT0gdm0tPnNjcmF0Y2hfcGRw
KSB7CiAJCQkJZ2VuOF9wcGd0dF9zZXRfcG1sNGUocG1sNCwgcGRwLCBwbWw0ZSk7CisJCQkJcG1s
NC0+cGRwc1twbWw0ZV0gPSBwZHA7CiAJCQl9IGVsc2UgewotCQkJCWZyZWVfcGRwKHZtLCBwZHAp
OwotCQkJCXBkcCA9IG9sZDsKKwkJCQlhbGxvYyA9IHBkcDsKKwkJCQlwZHAgPSBwbWw0LT5wZHBz
W3BtbDRlXTsKIAkJCX0KLQotCQkJc3Bpbl9sb2NrKCZwbWw0LT5sb2NrKTsKIAkJfQogCQlhdG9t
aWNfaW5jKCZwZHAtPnVzZWRfcGRwZXMpOwogCQlzcGluX3VubG9jaygmcG1sNC0+bG9jayk7CkBA
IC0xNTQyLDggKzE1NTIsNyBAQCBzdGF0aWMgaW50IGdlbjhfcHBndHRfYWxsb2NfNGx2bChzdHJ1
Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKIAkJYXRvbWljX2RlYygmcGRwLT51c2VkX3BkcGVz
KTsKIAl9CiAJc3Bpbl91bmxvY2soJnBtbDQtPmxvY2spOwotCi0JcmV0dXJuIDA7CisJZ290byBv
dXQ7CiAKIHVud2luZF9wZHA6CiAJc3Bpbl9sb2NrKCZwbWw0LT5sb2NrKTsKQEAgLTE1NTQsNyAr
MTU2MywxMCBAQCBzdGF0aWMgaW50IGdlbjhfcHBndHRfYWxsb2NfNGx2bChzdHJ1Y3QgaTkxNV9h
ZGRyZXNzX3NwYWNlICp2bSwKIAlzcGluX3VubG9jaygmcG1sNC0+bG9jayk7CiB1bndpbmQ6CiAJ
Z2VuOF9wcGd0dF9jbGVhcl80bHZsKHZtLCBmcm9tLCBzdGFydCAtIGZyb20pOwotCXJldHVybiAt
RU5PTUVNOworb3V0OgorCWlmIChhbGxvYykKKwkJZnJlZV9wZHAodm0sIGFsbG9jKTsKKwlyZXR1
cm4gcmV0OwogfQogCiBzdGF0aWMgaW50IGdlbjhfcHJlYWxsb2NhdGVfdG9wX2xldmVsX3BkcChz
dHJ1Y3QgaTkxNV9wcGd0dCAqcHBndHQpCkBAIC0xODE5LDExICsxODMxLDEzIEBAIHN0YXRpYyBp
bnQgZ2VuNl9hbGxvY192YV9yYW5nZShzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKIAkJ
CSAgICAgICB1NjQgc3RhcnQsIHU2NCBsZW5ndGgpCiB7CiAJc3RydWN0IGdlbjZfcHBndHQgKnBw
Z3R0ID0gdG9fZ2VuNl9wcGd0dChpOTE1X3ZtX3RvX3BwZ3R0KHZtKSk7CisJc3RydWN0IGk5MTVf
cGFnZV90YWJsZSAqYWxsb2MgPSBOVUxMOwogCXN0cnVjdCBpOTE1X3BhZ2VfdGFibGUgKnB0Owog
CWludGVsX3dha2VyZWZfdCB3YWtlcmVmOwogCXU2NCBmcm9tID0gc3RhcnQ7CiAJdW5zaWduZWQg
aW50IHBkZTsKIAlib29sIGZsdXNoID0gZmFsc2U7CisJaW50IHJldDsKIAogCXdha2VyZWYgPSBp
bnRlbF9ydW50aW1lX3BtX2dldCgmdm0tPmk5MTUtPnJ1bnRpbWVfcG0pOwogCkBAIC0xODMyLDE5
ICsxODQ2LDE4IEBAIHN0YXRpYyBpbnQgZ2VuNl9hbGxvY192YV9yYW5nZShzdHJ1Y3QgaTkxNV9h
ZGRyZXNzX3NwYWNlICp2bSwKIAkJY29uc3QgdW5zaWduZWQgaW50IGNvdW50ID0gZ2VuNl9wdGVf
Y291bnQoc3RhcnQsIGxlbmd0aCk7CiAKIAkJaWYgKHB0ID09IHZtLT5zY3JhdGNoX3B0KSB7Ci0J
CQlzdHJ1Y3QgaTkxNV9wYWdlX3RhYmxlICpvbGQ7Ci0KIAkJCXNwaW5fdW5sb2NrKCZwcGd0dC0+
YmFzZS5wZC5sb2NrKTsKIAotCQkJcHQgPSBhbGxvY19wdCh2bSk7CisJCQlwdCA9IGFsbG9jOwor
CQkJaWYgKCFwdCkKKwkJCQlwdCA9IGFsbG9jX3B0KHZtKTsKIAkJCWlmIChJU19FUlIocHQpKQog
CQkJCWdvdG8gdW53aW5kX291dDsKIAogCQkJZ2VuNl9pbml0aWFsaXplX3B0KHZtLCBwdCk7CiAK
LQkJCW9sZCA9IGNtcHhjaGcoJnBwZ3R0LT5iYXNlLnBkLnBhZ2VfdGFibGVbcGRlXSwKLQkJCQkg
ICAgICB2bS0+c2NyYXRjaF9wdCwgcHQpOwotCQkJaWYgKG9sZCA9PSB2bS0+c2NyYXRjaF9wdCkg
eworCQkJc3Bpbl9sb2NrKCZwcGd0dC0+YmFzZS5wZC5sb2NrKTsKKwkJCWlmIChwcGd0dC0+YmFz
ZS5wZC5wYWdlX3RhYmxlW3BkZV0gPT0gdm0tPnNjcmF0Y2hfcHQpIHsKIAkJCQlwcGd0dC0+YmFz
ZS5wZC5wYWdlX3RhYmxlW3BkZV0gPSBwdDsKIAkJCQlpZiAoaTkxNV92bWFfaXNfYm91bmQocHBn
dHQtPnZtYSwKIAkJCQkJCSAgICAgIEk5MTVfVk1BX0dMT0JBTF9CSU5EKSkgewpAQCAtMTg1Miwx
MSArMTg2NSw5IEBAIHN0YXRpYyBpbnQgZ2VuNl9hbGxvY192YV9yYW5nZShzdHJ1Y3QgaTkxNV9h
ZGRyZXNzX3NwYWNlICp2bSwKIAkJCQkJZmx1c2ggPSB0cnVlOwogCQkJCX0KIAkJCX0gZWxzZSB7
Ci0JCQkJZnJlZV9wdCh2bSwgcHQpOwotCQkJCXB0ID0gb2xkOworCQkJCWFsbG9jID0gcHQ7CisJ
CQkJcHQgPSBwcGd0dC0+YmFzZS5wZC5wYWdlX3RhYmxlW3BkZV07CiAJCQl9Ci0KLQkJCXNwaW5f
bG9jaygmcHBndHQtPmJhc2UucGQubG9jayk7CiAJCX0KIAogCQlhdG9taWNfYWRkKGNvdW50LCAm
cHQtPnVzZWRfcHRlcyk7CkBAIC0xODY4LDE0ICsxODc5LDE1IEBAIHN0YXRpYyBpbnQgZ2VuNl9h
bGxvY192YV9yYW5nZShzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKIAkJZ2VuNl9nZ3R0
X2ludmFsaWRhdGUodm0tPmk5MTUpOwogCX0KIAotCWludGVsX3J1bnRpbWVfcG1fcHV0KCZ2bS0+
aTkxNS0+cnVudGltZV9wbSwgd2FrZXJlZik7Ci0KLQlyZXR1cm4gMDsKKwlnb3RvIG91dDsKIAog
dW53aW5kX291dDoKLQlpbnRlbF9ydW50aW1lX3BtX3B1dCgmdm0tPmk5MTUtPnJ1bnRpbWVfcG0s
IHdha2VyZWYpOwogCWdlbjZfcHBndHRfY2xlYXJfcmFuZ2Uodm0sIGZyb20sIHN0YXJ0IC0gZnJv
bSk7Ci0JcmV0dXJuIC1FTk9NRU07CitvdXQ6CisJaWYgKGFsbG9jKQorCQlmcmVlX3B0KHZtLCBh
bGxvYyk7CisJaW50ZWxfcnVudGltZV9wbV9wdXQoJnZtLT5pOTE1LT5ydW50aW1lX3BtLCB3YWtl
cmVmKTsKKwlyZXR1cm4gcmV0OwogfQogCiBzdGF0aWMgaW50IGdlbjZfcHBndHRfaW5pdF9zY3Jh
dGNoKHN0cnVjdCBnZW42X3BwZ3R0ICpwcGd0dCkKLS0gCjIuMjAuMQoKX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJ
bnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Au
b3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

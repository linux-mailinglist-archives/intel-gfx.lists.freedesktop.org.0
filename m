Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 5BB651155AA
	for <lists+intel-gfx@lfdr.de>; Fri,  6 Dec 2019 17:43:29 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id D3B746FA5F;
	Fri,  6 Dec 2019 16:43:26 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mblankhorst.nl (mblankhorst.nl
 [IPv6:2a02:2308::216:3eff:fe92:dfa3])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 044656FA55
 for <intel-gfx@lists.freedesktop.org>; Fri,  6 Dec 2019 16:43:22 +0000 (UTC)
From: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
To: intel-gfx@lists.freedesktop.org
Date: Fri,  6 Dec 2019 17:43:17 +0100
Message-Id: <20191206164317.2489743-6-maarten.lankhorst@linux.intel.com>
X-Mailer: git-send-email 2.24.0
In-Reply-To: <20191206164317.2489743-1-maarten.lankhorst@linux.intel.com>
References: <20191206164317.2489743-1-maarten.lankhorst@linux.intel.com>
MIME-Version: 1.0
Subject: [Intel-gfx] [RFC PATCH 5/5] drm/i915: Parallel execbuf wip
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

RG9lc24ndCB3b3JrIHlldCwgYnV0IHNob3dzIHRoZSBkaXJlY3Rpb24gSSdtIGdvaW5nLgoKSW5z
dGVhZCBvZiByZWx5aW5nIG9uIHN0cnVjdF9tdXRleCwgd2UgcmVseSBvbiB0aGUgb2JqZWN0IGxv
Y2tzIHRvCnBhcmFsZWxsaXplIHN1Ym1pc3Npb24uCgpDdXJyZW50bHkgd2Ugc3RpbGwgaGF2ZSBz
b21lIGlzc3VlcyBiZWNhdXNlIGViX2xvb2t1cF92bWFzKCkgcGlucyB0aGUKdm1hLCBhbmQgcGFy
YWxsZWwgc3VibWlzc2lvbiBkb2Vzbid0IHdvcmsgeWV0IGNvbXBsZXRlbHkuIEknbSBob3BpbmcK
dG8gZmluZCBvdXQgYSBnb29kIHdheSB0byBoYW5kbGUgdGhpcy4gSWRlYWxseSB3ZSBkcm9wIHRo
ZSBwaW5uaW5nLAphbmQgcmVseSBvbmx5IG9uIG9iamVjdCBsb2NrLCBidXQgdW5mb3J0dW5hdGVs
eSB0aGUgZHJpdmVyIGRvZXNuJ3QKc3VwcG9ydCBpdCB5ZXQuCgpQb3N0aW5nIHRoaXMgYXMgYSBS
RkMsIHRvIGdldCBzb21lIGZlZWRiYWNrIG9uIHRoZSBkaXJlY3Rpb24gd2Ugc2hvdWxkIGJlIGdv
aW5nLgoKU2lnbmVkLW9mZi1ieTogTWFhcnRlbiBMYW5raG9yc3QgPG1hYXJ0ZW4ubGFua2hvcnN0
QGxpbnV4LmludGVsLmNvbT4KLS0tCiAuLi4vZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9leGVj
YnVmZmVyLmMgICAgfCAyOTUgKysrKysrKysrKy0tLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkx
NS9pOTE1X2NtZF9wYXJzZXIuYyAgICAgICAgfCAgMTUgKy0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1
L2k5MTVfZHJ2LmggICAgICAgICAgICAgICB8ICAgNiAtCiAzIGZpbGVzIGNoYW5nZWQsIDE3MSBp
bnNlcnRpb25zKCspLCAxNDUgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2V4ZWNidWZmZXIuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2dlbS9pOTE1X2dlbV9leGVjYnVmZmVyLmMKaW5kZXggMDJmZGYwODFjMWJlLi5lZTc1MzY4NGYw
YmEgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9leGVjYnVm
ZmVyLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2V4ZWNidWZmZXIu
YwpAQCAtMjM0LDYgKzIzNCw4IEBAIHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgewogCXN0cnVjdCBk
cm1faTkxNV9nZW1fZXhlY19vYmplY3QyICpleGVjOyAvKiogaW9jdGwgZXhlY29ialtdICovCiAJ
c3RydWN0IGViX3ZtYSAqdm1hOwogCisJc3RydWN0IGk5MTVfZ2VtX3d3X2N0eCB3dzsKKwogCXN0
cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZTsgLyoqIGVuZ2luZSB0byBxdWV1ZSB0aGUgcmVx
dWVzdCB0byAqLwogCXN0cnVjdCBpbnRlbF9jb250ZXh0ICpjb250ZXh0OyAvKiBsb2dpY2FsIHN0
YXRlIGZvciB0aGUgcmVxdWVzdCAqLwogCXN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICpnZW1fY29u
dGV4dDsgLyoqIGNhbGxlcidzIGNvbnRleHQgKi8KQEAgLTI4Niw2ICsyODgsOSBAQCBzdHJ1Y3Qg
aTkxNV9leGVjYnVmZmVyIHsKIAlzdHJ1Y3QgaGxpc3RfaGVhZCAqYnVja2V0czsgLyoqIGh0IGZv
ciByZWxvY2F0aW9uIGhhbmRsZXMgKi8KIH07CiAKK3N0YXRpYyBpbnQgZWJfcGFyc2Uoc3RydWN0
IGk5MTVfZXhlY2J1ZmZlciAqZWIsCisJCSAgICBzdHJ1Y3QgaW50ZWxfZW5naW5lX3Bvb2xfbm9k
ZSAqcG9vbCk7CisKIC8qCiAgKiBVc2VkIHRvIGNvbnZlcnQgYW55IGFkZHJlc3MgdG8gY2Fub25p
Y2FsIGZvcm0uCiAgKiBTdGFydGluZyBmcm9tIGdlbjgsIHNvbWUgY29tbWFuZHMgKGUuZy4gU1RB
VEVfQkFTRV9BRERSRVNTLApAQCAtNTA0LDggKzUwOSwxMCBAQCBlYl9hZGRfdm1hKHN0cnVjdCBp
OTE1X2V4ZWNidWZmZXIgKmViLAogCiAJaWYgKCEoZWItPmFyZ3MtPmZsYWdzICYgX19FWEVDX1ZB
TElEQVRFRCkpIHsKIAkJZXJyID0gZWJfdmFsaWRhdGVfdm1hKGViLCBlbnRyeSwgdm1hKTsKLQkJ
aWYgKHVubGlrZWx5KGVycikpCisJCWlmICh1bmxpa2VseShlcnIpKSB7CisJCQlEUk1fREVCVUdf
RFJJVkVSKCJlYl92YWxpZGF0ZV92bWEgPT4gJWlcbiIsIGVycik7CiAJCQlyZXR1cm4gZXJyOwor
CQl9CiAJfQogCiAJZXYtPnZtYSA9IHZtYTsKQEAgLTU1MSw4ICs1NTgsMTAgQEAgZWJfYWRkX3Zt
YShzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYiwKIAkJZWJfdW5yZXNlcnZlX3ZtYShldik7CiAK
IAkJbGlzdF9hZGRfdGFpbCgmZXYtPmJpbmRfbGluaywgJmViLT51bmJvdW5kKTsKLQkJaWYgKGRy
bV9tbV9ub2RlX2FsbG9jYXRlZCgmdm1hLT5ub2RlKSkKKwkJaWYgKGRybV9tbV9ub2RlX2FsbG9j
YXRlZCgmdm1hLT5ub2RlKSkgewogCQkJZXJyID0gaTkxNV92bWFfdW5iaW5kKHZtYSk7CisJCQlX
QVJOKGVyciwgImk5MTVfdm1hX3VuYmluZCA9PiAlaVxuIiwgZXJyKTsKKwkJfQogCX0KIAlyZXR1
cm4gZXJyOwogfQpAQCAtNTc0LDcgKzU4Myw3IEBAIHN0YXRpYyBpbmxpbmUgaW50IHVzZV9jcHVf
cmVsb2MoY29uc3Qgc3RydWN0IHJlbG9jX2NhY2hlICpjYWNoZSwKIAkJb2JqLT5jYWNoZV9sZXZl
bCAhPSBJOTE1X0NBQ0hFX05PTkUpOwogfQogCi1zdGF0aWMgaW50IGViX3Jlc2VydmVfdm1hKGNv
bnN0IHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViLCBzdHJ1Y3QgZWJfdm1hICpldikKK3N0YXRp
YyBpbnQgZWJfcmVzZXJ2ZV92bWEoc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIsIHN0cnVjdCBl
Yl92bWEgKmV2KQogewogCXN0cnVjdCBkcm1faTkxNV9nZW1fZXhlY19vYmplY3QyICplbnRyeSA9
IGV2LT5leGVjOwogCXVuc2lnbmVkIGludCBleGVjX2ZsYWdzID0gZXYtPmZsYWdzOwpAQCAtNTgy
LDYgKzU5MSwxMCBAQCBzdGF0aWMgaW50IGViX3Jlc2VydmVfdm1hKGNvbnN0IHN0cnVjdCBpOTE1
X2V4ZWNidWZmZXIgKmViLCBzdHJ1Y3QgZWJfdm1hICpldikKIAl1NjQgcGluX2ZsYWdzOwogCWlu
dCBlcnI7CiAKKwllcnIgPSBpOTE1X2dlbV9vYmplY3RfbG9jaygmZWItPnd3LCB2bWEtPm9iaik7
CisJaWYgKGVycikKKwkJcmV0dXJuIGVycjsKKwogCXBpbl9mbGFncyA9IFBJTl9VU0VSIHwgUElO
X05PTkJMT0NLOwogCWlmIChleGVjX2ZsYWdzICYgRVhFQ19PQkpFQ1RfTkVFRFNfR1RUKQogCQlw
aW5fZmxhZ3MgfD0gUElOX0dMT0JBTDsKQEAgLTc5Nyw5ICs4MTAsNyBAQCBzdGF0aWMgaW50IGVi
X2xvb2t1cF92bWFzKHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViKQogCQlsdXQtPmhhbmRsZSA9
IGhhbmRsZTsKIAkJbHV0LT5jdHggPSBlYi0+Z2VtX2NvbnRleHQ7CiAKLQkJaTkxNV9nZW1fb2Jq
ZWN0X2xvY2soTlVMTCwgb2JqKTsKIAkJbGlzdF9hZGQoJmx1dC0+b2JqX2xpbmssICZvYmotPmx1
dF9saXN0KTsKLQkJaTkxNV9nZW1fb2JqZWN0X3VubG9jayhvYmopOwogCiBhZGRfdm1hOgogCQll
cnIgPSBlYl9hZGRfdm1hKGViLCBpLCBiYXRjaCwgdm1hKTsKQEAgLTgxMiwxNSArODIzLDMzIEBA
IHN0YXRpYyBpbnQgZWJfbG9va3VwX3ZtYXMoc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIpCiAK
IAltdXRleF91bmxvY2soJmViLT5nZW1fY29udGV4dC0+bXV0ZXgpOwogCisJaWYgKHVubGlrZWx5
KGViLT5iYXRjaC0+ZmxhZ3MgJiBFWEVDX09CSkVDVF9XUklURSkpIHsKKwkJRFJNX0RFQlVHKCJB
dHRlbXB0aW5nIHRvIHVzZSBzZWxmLW1vZGlmeWluZyBiYXRjaCBidWZmZXJcbiIpOworCQlyZXR1
cm4gLUVJTlZBTDsKKwl9CisKKwlpZiAocmFuZ2Vfb3ZlcmZsb3dzX3QodTY0LAorCQkJICAgICAg
ZWItPmJhdGNoX3N0YXJ0X29mZnNldCwgZWItPmJhdGNoX2xlbiwKKwkJCSAgICAgIGViLT5iYXRj
aC0+dm1hLT5zaXplKSkgeworCQlEUk1fREVCVUcoIkF0dGVtcHRpbmcgdG8gdXNlIG91dC1vZi1i
b3VuZHMgYmF0Y2hcbiIpOworCQlyZXR1cm4gLUVJTlZBTDsKKwl9CisKKwlpZiAoZWItPmJhdGNo
X2xlbiA9PSAwKQorCQllYi0+YmF0Y2hfbGVuID0gZWItPmJhdGNoLT52bWEtPnNpemUgLSBlYi0+
YmF0Y2hfc3RhcnRfb2Zmc2V0OworCiAJZWItPmFyZ3MtPmZsYWdzIHw9IF9fRVhFQ19WQUxJREFU
RUQ7CiAJcmV0dXJuIGViX3Jlc2VydmUoZWIpOwogCiBlcnJfb2JqOgogCWk5MTVfZ2VtX29iamVj
dF9wdXQob2JqKTsKKwlEUk1fREVCVUdfRFJJVkVSKCJlcnJfb2JqKCkgPT4gJWlcbiIsIGVycik7
CiBlcnJfdm1hOgogCWViLT52bWFbaV0udm1hID0gTlVMTDsKKwlEUk1fREVCVUdfRFJJVkVSKCJl
cnJfdm1hKCkgPT4gJWlcbiIsIGVycik7CiBlcnJfY3R4OgogCW11dGV4X3VubG9jaygmZWItPmdl
bV9jb250ZXh0LT5tdXRleCk7CisJRFJNX0RFQlVHX0RSSVZFUigiZXJyX2N0eCgpID0+ICVpXG4i
LCBlcnIpOwogCXJldHVybiBlcnI7CiB9CiAKQEAgLTg2Niw2ICs4OTUsMTUgQEAgc3RhdGljIHZv
aWQgZWJfcmVsZWFzZV92bWFzKGNvbnN0IHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViKQogCX0K
IH0KIAorc3RhdGljIHZvaWQgZWJfdW5yZXNlcnZlX3ZtYXMoc3RydWN0IGk5MTVfZXhlY2J1ZmZl
ciAqZWIpCit7CisJY29uc3QgdW5zaWduZWQgaW50IGNvdW50ID0gZWItPmJ1ZmZlcl9jb3VudDsK
Kwl1bnNpZ25lZCBpbnQgaTsKKworCWZvciAoaSA9IDA7IGkgPCBjb3VudDsgaSsrKQorCQllYl91
bnJlc2VydmVfdm1hKCZlYi0+dm1hW2ldKTsKK30KKwogc3RhdGljIHZvaWQgZWJfcmVzZXRfdm1h
cyhjb25zdCBzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYikKIHsKIAllYl9yZWxlYXNlX3ZtYXMo
ZWIpOwpAQCAtMTEyMSw3ICsxMTU5LDcgQEAgc3RhdGljIGludCByZWxvY19tb3ZlX3RvX2dwdShz
dHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSwgc3RydWN0IGk5MTVfdm1hICp2bWEpCiAJc3RydWN0IGRy
bV9pOTE1X2dlbV9vYmplY3QgKm9iaiA9IHZtYS0+b2JqOwogCWludCBlcnI7CiAKLQlpOTE1X3Zt
YV9sb2NrKHZtYSk7CisJYXNzZXJ0X3ZtYV9oZWxkKHZtYSk7CiAKIAlpZiAob2JqLT5jYWNoZV9k
aXJ0eSAmIH5vYmotPmNhY2hlX2NvaGVyZW50KQogCQlpOTE1X2dlbV9jbGZsdXNoX29iamVjdChv
YmosIDApOwpAQCAtMTEzMSw4ICsxMTY5LDYgQEAgc3RhdGljIGludCByZWxvY19tb3ZlX3RvX2dw
dShzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSwgc3RydWN0IGk5MTVfdm1hICp2bWEpCiAJaWYgKGVy
ciA9PSAwKQogCQllcnIgPSBpOTE1X3ZtYV9tb3ZlX3RvX2FjdGl2ZSh2bWEsIHJxLCBFWEVDX09C
SkVDVF9XUklURSk7CiAKLQlpOTE1X3ZtYV91bmxvY2sodm1hKTsKLQogCXJldHVybiBlcnI7CiB9
CiAKQEAgLTExOTAsMTEgKzEyMjYsMTAgQEAgc3RhdGljIGludCBfX3JlbG9jX2dwdV9hbGxvYyhz
dHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYiwKIAlpZiAoZXJyKQogCQlnb3RvIHNraXBfcmVxdWVz
dDsKIAotCWk5MTVfdm1hX2xvY2soYmF0Y2gpOworCWFzc2VydF92bWFfaGVsZChiYXRjaCk7CiAJ
ZXJyID0gaTkxNV9yZXF1ZXN0X2F3YWl0X29iamVjdChycSwgYmF0Y2gtPm9iaiwgZmFsc2UpOwog
CWlmIChlcnIgPT0gMCkKIAkJZXJyID0gaTkxNV92bWFfbW92ZV90b19hY3RpdmUoYmF0Y2gsIHJx
LCAwKTsKLQlpOTE1X3ZtYV91bmxvY2soYmF0Y2gpOwogCWlmIChlcnIpCiAJCWdvdG8gc2tpcF9y
ZXF1ZXN0OwogCkBAIC0xNDQ1LDYgKzE0ODAsMTEgQEAgc3RhdGljIGludCBlYl9yZWxvY2F0ZV92
bWEoc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIsIHN0cnVjdCBlYl92bWEgKmV2KQogCXN0cnVj
dCBkcm1faTkxNV9nZW1fcmVsb2NhdGlvbl9lbnRyeSBfX3VzZXIgKnVyZWxvY3M7CiAJY29uc3Qg
c3RydWN0IGRybV9pOTE1X2dlbV9leGVjX29iamVjdDIgKmVudHJ5ID0gZXYtPmV4ZWM7CiAJdW5z
aWduZWQgaW50IHJlbWFpbjsKKwlpbnQgZXJyOworCisJZXJyID0gaTkxNV9nZW1fb2JqZWN0X2xv
Y2soJmViLT53dywgZXYtPnZtYS0+b2JqKTsKKwlpZiAoZXJyKQorCQlyZXR1cm4gZXJyOwogCiAJ
dXJlbG9jcyA9IHU2NF90b191c2VyX3B0cihlbnRyeS0+cmVsb2NzX3B0cik7CiAJcmVtYWluID0g
ZW50cnktPnJlbG9jYXRpb25fY291bnQ7CkBAIC0xNjc1LDE0ICsxNzE1LDM1IEBAIHN0YXRpYyBp
bnQgZWJfcHJlZmF1bHRfcmVsb2NhdGlvbnMoY29uc3Qgc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAq
ZWIpCiAJcmV0dXJuIDA7CiB9CiAKK3N0YXRpYyBpbnQgZWJfbG9ja19hbmRfcGFyc2VfY21kYnVm
ZmVyKHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViKQoreworCXN0cnVjdCBpbnRlbF9lbmdpbmVf
cG9vbF9ub2RlICpwb29sOworCWludCBlcnI7CisKKwlpZiAoIWViX3VzZV9jbWRwYXJzZXIoZWIp
KQorCQlyZXR1cm4gMDsKKworCXBvb2wgPSBpbnRlbF9lbmdpbmVfZ2V0X3Bvb2woZWItPmVuZ2lu
ZSwgZWItPmJhdGNoX2xlbik7CisJaWYgKElTX0VSUihwb29sKSkKKwkJcmV0dXJuIFBUUl9FUlIo
cG9vbCk7CisKKwllcnIgPSBpOTE1X2dlbV9vYmplY3RfbG9jaygmZWItPnd3LCBwb29sLT5vYmop
OworCWlmICghZXJyKQorCQllcnIgPSBlYl9wYXJzZShlYiwgcG9vbCk7CisKKwlpZiAoZXJyKQor
CQlpbnRlbF9lbmdpbmVfcG9vbF9wdXQocG9vbCk7CisKKwlyZXR1cm4gZXJyOworfQorCiBzdGF0
aWMgbm9pbmxpbmUgaW50IGViX3JlbG9jYXRlX3Nsb3coc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAq
ZWIpCiB7Ci0Jc3RydWN0IGRybV9kZXZpY2UgKmRldiA9ICZlYi0+aTkxNS0+ZHJtOwogCWJvb2wg
aGF2ZV9jb3B5ID0gZmFsc2U7CiAJc3RydWN0IGViX3ZtYSAqZXY7CiAJaW50IGVyciA9IDA7CiAK
LXJlcGVhdDoKK3JlcGVhdF9wYXNzOgogCWlmIChzaWduYWxfcGVuZGluZyhjdXJyZW50KSkgewog
CQllcnIgPSAtRVJFU1RBUlRTWVM7CiAJCWdvdG8gb3V0OwpAQCAtMTY5MCwxMCArMTc1MSwxMCBA
QCBzdGF0aWMgbm9pbmxpbmUgaW50IGViX3JlbG9jYXRlX3Nsb3coc3RydWN0IGk5MTVfZXhlY2J1
ZmZlciAqZWIpCiAKIAkvKiBXZSBtYXkgcHJvY2VzcyBhbm90aGVyIGV4ZWNidWZmZXIgZHVyaW5n
IHRoZSB1bmxvY2suLi4gKi8KIAllYl9yZXNldF92bWFzKGViKTsKLQltdXRleF91bmxvY2soJmRl
di0+c3RydWN0X211dGV4KTsKKwlpOTE1X2dlbV93d19jdHhfZmluaSgmZWItPnd3KTsKIAogCS8q
Ci0JICogV2UgdGFrZSAzIHBhc3NlcyB0aHJvdWdoIHRoZSBzbG93cGF0Y2guCisJICogV2UgdGFr
ZSAzIHBhc3NlcyB0aHJvdWdoIHRoZSBzbG93cGF0aC4KIAkgKgogCSAqIDEgLSB3ZSB0cnkgdG8g
anVzdCBwcmVmYXVsdCBhbGwgdGhlIHVzZXIgcmVsb2NhdGlvbiBlbnRyaWVzIGFuZAogCSAqIHRo
ZW4gYXR0ZW1wdCB0byByZXVzZSB0aGUgYXRvbWljIHBhZ2VmYXVsdCBkaXNhYmxlZCBmYXN0IHBh
dGggYWdhaW4uCkBAIC0xNzE0LDIwICsxNzc1LDE0IEBAIHN0YXRpYyBub2lubGluZSBpbnQgZWJf
cmVsb2NhdGVfc2xvdyhzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYikKIAkJY29uZF9yZXNjaGVk
KCk7CiAJCWVyciA9IDA7CiAJfQotCWlmIChlcnIpIHsKLQkJbXV0ZXhfbG9jaygmZGV2LT5zdHJ1
Y3RfbXV0ZXgpOworCWk5MTVfZ2VtX3d3X2N0eF9pbml0KCZlYi0+d3csIHRydWUpOworCWlmIChl
cnIpCiAJCWdvdG8gb3V0OwotCX0KIAogCS8qIEEgZnJlcXVlbnQgY2F1c2UgZm9yIEVBR0FJTiBh
cmUgY3VycmVudGx5IHVuYXZhaWxhYmxlIGNsaWVudCBwYWdlcyAqLwogCWZsdXNoX3dvcmtxdWV1
ZShlYi0+aTkxNS0+bW0udXNlcnB0cl93cSk7CiAKLQllcnIgPSBpOTE1X211dGV4X2xvY2tfaW50
ZXJydXB0aWJsZShkZXYpOwotCWlmIChlcnIpIHsKLQkJbXV0ZXhfbG9jaygmZGV2LT5zdHJ1Y3Rf
bXV0ZXgpOwotCQlnb3RvIG91dDsKLQl9Ci0KK3JlcGVhdF9yZWxvYzoKIAkvKiByZWFjcXVpcmUg
dGhlIG9iamVjdHMgKi8KIAllcnIgPSBlYl9sb29rdXBfdm1hcyhlYik7CiAJaWYgKGVycikKQEAg
LTE3NDAsOCArMTc5NSwxMCBAQCBzdGF0aWMgbm9pbmxpbmUgaW50IGViX3JlbG9jYXRlX3Nsb3co
c3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIpCiAJCQlwYWdlZmF1bHRfZGlzYWJsZSgpOwogCQkJ
ZXJyID0gZWJfcmVsb2NhdGVfdm1hKGViLCBldik7CiAJCQlwYWdlZmF1bHRfZW5hYmxlKCk7Ci0J
CQlpZiAoZXJyKQotCQkJCWdvdG8gcmVwZWF0OworCQkJaWYgKGVyciA9PSAtRURFQURMSykKKwkJ
CQlnb3RvIGVycjsKKwkJCWVsc2UgaWYgKGVycikKKwkJCQlnb3RvIHJlcGVhdF9wYXNzOwogCQl9
IGVsc2UgewogCQkJZXJyID0gZWJfcmVsb2NhdGVfdm1hX3Nsb3coZWIsIGV2KTsKIAkJCWlmIChl
cnIpCkBAIC0xNzQ5LDYgKzE4MDYsOSBAQCBzdGF0aWMgbm9pbmxpbmUgaW50IGViX3JlbG9jYXRl
X3Nsb3coc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIpCiAJCX0KIAl9CiAKKwlpZiAoIWVycikK
KwkJZXJyID0gZWJfbG9ja19hbmRfcGFyc2VfY21kYnVmZmVyKGViKTsKKwogCS8qCiAJICogTGVh
dmUgdGhlIHVzZXIgcmVsb2NhdGlvbnMgYXMgYXJlLCB0aGlzIGlzIHRoZSBwYWluZnVsbHkgc2xv
dyBwYXRoLAogCSAqIGFuZCB3ZSB3YW50IHRvIGF2b2lkIHRoZSBjb21wbGljYXRpb24gb2YgZHJv
cHBpbmcgdGhlIGxvY2sgd2hpbHN0CkBAIC0xNzU3LDggKzE4MTcsMTUgQEAgc3RhdGljIG5vaW5s
aW5lIGludCBlYl9yZWxvY2F0ZV9zbG93KHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViKQogCSAq
LwogCiBlcnI6CisJaWYgKGVyciA9PSAtRURFQURMSykgeworCQllYl9yZXNldF92bWFzKGViKTsK
KworCQllcnIgPSBpOTE1X2dlbV93d19jdHhfYmFja29mZigmZWItPnd3KTsKKwkJaWYgKCFlcnIp
CisJCQlnb3RvIHJlcGVhdF9yZWxvYzsKKwl9CiAJaWYgKGVyciA9PSAtRUFHQUlOKQotCQlnb3Rv
IHJlcGVhdDsKKwkJZ290byByZXBlYXRfcGFzczsKIAogb3V0OgogCWlmIChoYXZlX2NvcHkpIHsK
QEAgLTE3ODEsNjAgKzE4NDgsNzkgQEAgc3RhdGljIG5vaW5saW5lIGludCBlYl9yZWxvY2F0ZV9z
bG93KHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViKQogCXJldHVybiBlcnI7CiB9CiAKLXN0YXRp
YyBpbnQgZWJfcmVsb2NhdGUoc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIpCitzdGF0aWMgaW50
IGViX3JlbG9jYXRlX2Zhc3Qoc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIpCiB7Ci0JaWYgKGVi
X2xvb2t1cF92bWFzKGViKSkKLQkJZ290byBzbG93OworCWludCBlcnI7CiAKIAkvKiBUaGUgb2Jq
ZWN0cyBhcmUgaW4gdGhlaXIgZmluYWwgbG9jYXRpb25zLCBhcHBseSB0aGUgcmVsb2NhdGlvbnMu
ICovCiAJaWYgKGViLT5hcmdzLT5mbGFncyAmIF9fRVhFQ19IQVNfUkVMT0MpIHsKIAkJc3RydWN0
IGViX3ZtYSAqZXY7CiAKIAkJbGlzdF9mb3JfZWFjaF9lbnRyeShldiwgJmViLT5yZWxvY3MsIHJl
bG9jX2xpbmspIHsKLQkJCWlmIChlYl9yZWxvY2F0ZV92bWEoZWIsIGV2KSkKLQkJCQlnb3RvIHNs
b3c7CisJCQllcnIgPSBlYl9yZWxvY2F0ZV92bWEoZWIsIGV2KTsKKwkJCWlmIChlcnIpCisJCQkJ
cmV0dXJuIGVycjsKIAkJfQogCX0KIAogCXJldHVybiAwOwotCi1zbG93OgotCXJldHVybiBlYl9y
ZWxvY2F0ZV9zbG93KGViKTsKIH0KIAotc3RhdGljIGludCBlYl9tb3ZlX3RvX2dwdShzdHJ1Y3Qg
aTkxNV9leGVjYnVmZmVyICplYikKK3N0YXRpYyBpbnQgZWJfcmVsb2NhdGVfYW5kX3BhcnNlX2Nt
ZGJ1Zl9iYWNrb2ZmKHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViKQogewotCWNvbnN0IHVuc2ln
bmVkIGludCBjb3VudCA9IGViLT5idWZmZXJfY291bnQ7Ci0Jc3RydWN0IHd3X2FjcXVpcmVfY3R4
IGFjcXVpcmU7Ci0JdW5zaWduZWQgaW50IGk7Ci0JaW50IGVyciA9IDA7CisJaW50IGVycjsKIAot
CXd3X2FjcXVpcmVfaW5pdCgmYWNxdWlyZSwgJnJlc2VydmF0aW9uX3d3X2NsYXNzKTsKKwllcnIg
PSBlYl9sb29rdXBfdm1hcyhlYik7CisJaWYgKGVycikgeworCQlEUk1fREVCVUdfRFJJVkVSKCJl
Yl9sb29rdXBfdm1hcygpID0+ICVpXG4iLCBlcnIpOworCQlyZXR1cm4gZXJyOworCX0KIAotCWZv
ciAoaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7Ci0JCXN0cnVjdCBlYl92bWEgKmV2ID0gJmViLT52
bWFbaV07Ci0JCXN0cnVjdCBpOTE1X3ZtYSAqdm1hID0gZXYtPnZtYTsKKwlEUk1fREVCVUdfRFJJ
VkVSKCJlYl9yZXNlcnZlKCkgPT4gJWlcbiIsIGVycik7CiAKLQkJZXJyID0gd3dfbXV0ZXhfbG9j
a19pbnRlcnJ1cHRpYmxlKCZ2bWEtPnJlc3YtPmxvY2ssICZhY3F1aXJlKTsKLQkJaWYgKGVyciA9
PSAtRURFQURMSykgewotCQkJR0VNX0JVR19PTihpID09IDApOwotCQkJZG8gewotCQkJCWludCBq
ID0gaSAtIDE7CityZXRyeV9mYXN0OgorCWlmICghZXJyKQorCQllcnIgPSBlYl9yZWxvY2F0ZV9m
YXN0KGViKTsKKwlpZiAoIWVycikgeworCQllcnIgPSBlYl9sb2NrX2FuZF9wYXJzZV9jbWRidWZm
ZXIoZWIpOworCQlEUk1fREVCVUdfRFJJVkVSKCJQYXJzaW5nIGNtZGJ1ZiByZXR1cm5zICVpXG4i
LCBlcnIpOwogCi0JCQkJd3dfbXV0ZXhfdW5sb2NrKCZlYi0+dm1hW2pdLnZtYS0+cmVzdi0+bG9j
ayk7CisJCS8qIHJldHVybiBvbiBzdWNjZXNzLCBvciBhbnkgZXJyb3IgZXhjZXB0IC1FREVBRExL
ICovCisJCWlmIChlcnIgIT0gLUVERUFETEspCisJCQlyZXR1cm4gZXJyOworCX0KIAotCQkJCXN3
YXAoZWItPnZtYVtpXSwgIGViLT52bWFbal0pOwotCQkJfSB3aGlsZSAoLS1pKTsKKwlpZiAoZXJy
ID09IC1FREVBRExLKSB7CisJCWViX3VucmVzZXJ2ZV92bWFzKGViKTsKIAotCQkJZXJyID0gd3df
bXV0ZXhfbG9ja19zbG93X2ludGVycnVwdGlibGUoJnZtYS0+cmVzdi0+bG9jaywKLQkJCQkJCQkg
ICAgICAgJmFjcXVpcmUpOwotCQl9Ci0JCWlmIChlcnIgPT0gLUVBTFJFQURZKQotCQkJZXJyID0g
MDsKKwkJZXJyID0gaTkxNV9nZW1fd3dfY3R4X2JhY2tvZmYoJmViLT53dyk7CiAJCWlmIChlcnIp
Ci0JCQlicmVhazsKKwkJCXJldHVybiBlcnI7CisKKwkJZ290byByZXRyeV9mYXN0OwogCX0KLQl3
d19hY3F1aXJlX2RvbmUoJmFjcXVpcmUpOworCisJZXJyID0gZWJfcmVsb2NhdGVfc2xvdyhlYik7
CisJaWYgKGVycikKKwkJLyoKKwkJICogSWYgdGhlIHVzZXIgZXhwZWN0cyB0aGUgZXhlY29iamVj
dC5vZmZzZXQgYW5kCisJCSAqIHJlbG9jLnByZXN1bWVkX29mZnNldCB0byBiZSBhbiBleGFjdCBt
YXRjaCwKKwkJICogYXMgZm9yIHVzaW5nIE5PX1JFTE9DLCB0aGVuIHdlIGNhbm5vdCB1cGRhdGUK
KwkJICogdGhlIGV4ZWNvYmplY3Qub2Zmc2V0IHVudGlsIHdlIGhhdmUgY29tcGxldGVkCisJCSAq
IHJlbG9jYXRpb24uCisJCSAqLworCQllYi0+YXJncy0+ZmxhZ3MgJj0gfl9fRVhFQ19IQVNfUkVM
T0M7CisKKwlEUk1fREVCVUdfRFJJVkVSKCJTbG93IHJlbG9jYXRpb24gcmV0dXJucyAlaVxuIiwg
ZXJyKTsKKwlyZXR1cm4gZXJyOworfQorCitzdGF0aWMgaW50IGViX21vdmVfdG9fZ3B1KHN0cnVj
dCBpOTE1X2V4ZWNidWZmZXIgKmViKQoreworCXVuc2lnbmVkIGludCBpOworCWludCBlcnIgPSAw
OworCisJd3dfYWNxdWlyZV9kb25lKCZlYi0+d3cuY3R4KTsKIAogCXdoaWxlIChpLS0pIHsKIAkJ
c3RydWN0IGViX3ZtYSAqZXYgPSAmZWItPnZtYVtpXTsKQEAgLTE4ODAsMTUgKzE5NjYsMTIgQEAg
c3RhdGljIGludCBlYl9tb3ZlX3RvX2dwdShzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYikKIAkJ
aWYgKGVyciA9PSAwKQogCQkJZXJyID0gaTkxNV92bWFfbW92ZV90b19hY3RpdmUodm1hLCBlYi0+
cmVxdWVzdCwgZmxhZ3MpOwogCi0JCWk5MTVfdm1hX3VubG9jayh2bWEpOwotCiAJCV9fZWJfdW5y
ZXNlcnZlX3ZtYSh2bWEsIGZsYWdzKTsKIAkJaWYgKHVubGlrZWx5KGZsYWdzICYgX19FWEVDX09C
SkVDVF9IQVNfUkVGKSkKIAkJCWk5MTVfdm1hX3B1dCh2bWEpOwogCiAJCWV2LT52bWEgPSBOVUxM
OwogCX0KLQl3d19hY3F1aXJlX2ZpbmkoJmFjcXVpcmUpOwogCiAJaWYgKHVubGlrZWx5KGVycikp
CiAJCWdvdG8gZXJyX3NraXA7CkBAIC0xOTkwLDIxICsyMDczLDE3IEBAIHNoYWRvd19iYXRjaF9w
aW4oc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIsIHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0
ICpvYmopCiAJcmV0dXJuIHZtYTsKIH0KIAotc3RhdGljIHN0cnVjdCBpOTE1X3ZtYSAqZWJfcGFy
c2Uoc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIpCitzdGF0aWMgaW50IGViX3BhcnNlKHN0cnVj
dCBpOTE1X2V4ZWNidWZmZXIgKmViLAorCQkgICAgc3RydWN0IGludGVsX2VuZ2luZV9wb29sX25v
ZGUgKnBvb2wpCiB7Ci0Jc3RydWN0IGludGVsX2VuZ2luZV9wb29sX25vZGUgKnBvb2w7CiAJc3Ry
dWN0IGk5MTVfdm1hICp2bWE7CiAJdTY0IGJhdGNoX3N0YXJ0OwogCXU2NCBzaGFkb3dfYmF0Y2hf
c3RhcnQ7CiAJaW50IGVycjsKIAotCXBvb2wgPSBpbnRlbF9lbmdpbmVfZ2V0X3Bvb2woZWItPmVu
Z2luZSwgZWItPmJhdGNoX2xlbik7Ci0JaWYgKElTX0VSUihwb29sKSkKLQkJcmV0dXJuIEVSUl9D
QVNUKHBvb2wpOwotCiAJdm1hID0gc2hhZG93X2JhdGNoX3BpbihlYiwgcG9vbC0+b2JqKTsKIAlp
ZiAoSVNfRVJSKHZtYSkpCi0JCWdvdG8gZXJyOworCQlyZXR1cm4gUFRSX0VSUih2bWEpOwogCiAJ
YmF0Y2hfc3RhcnQgPSBnZW44X2Nhbm9uaWNhbF9hZGRyKGViLT5iYXRjaC0+dm1hLT5ub2RlLnN0
YXJ0KSArCiAJCSAgICAgIGViLT5iYXRjaF9zdGFydF9vZmZzZXQ7CkBAIC0yMDI4LDEyICsyMTA3
LDEzIEBAIHN0YXRpYyBzdHJ1Y3QgaTkxNV92bWEgKmViX3BhcnNlKHN0cnVjdCBpOTE1X2V4ZWNi
dWZmZXIgKmViKQogCQkgKiBGb3IgUFBHVFQgYmFja2luZyBob3dldmVyLCB3ZSBoYXZlIG5vIGNo
b2ljZSBidXQgdG8gZm9yY2libHkKIAkJICogcmVqZWN0IHVuc2FmZSBidWZmZXJzCiAJCSAqLwot
CQlpZiAoaTkxNV92bWFfaXNfZ2d0dCh2bWEpICYmIGVyciA9PSAtRUFDQ0VTKQorCQlpZiAoaTkx
NV92bWFfaXNfZ2d0dCh2bWEpICYmIGVyciA9PSAtRUFDQ0VTKSB7CiAJCQkvKiBFeGVjdXRlIG9y
aWdpbmFsIGJ1ZmZlciBub24tc2VjdXJlICovCi0JCQl2bWEgPSBOVUxMOwotCQllbHNlCi0JCQl2
bWEgPSBFUlJfUFRSKGVycik7Ci0JCWdvdG8gZXJyOworCQkJaW50ZWxfZW5naW5lX3Bvb2xfcHV0
KHBvb2wpOworCQkJcmV0dXJuIDA7CisJCX0KKworCQlyZXR1cm4gZXJyOwogCX0KIAogCWViLT52
bWFbZWItPmJ1ZmZlcl9jb3VudF0udm1hID0gaTkxNV92bWFfZ2V0KHZtYSk7CkBAIC0yMDQ5LDEx
ICsyMTI5LDcgQEAgc3RhdGljIHN0cnVjdCBpOTE1X3ZtYSAqZWJfcGFyc2Uoc3RydWN0IGk5MTVf
ZXhlY2J1ZmZlciAqZWIpCiAJLyogZWItPmJhdGNoX2xlbiB1bmNoYW5nZWQgKi8KIAogCXZtYS0+
cHJpdmF0ZSA9IHBvb2w7Ci0JcmV0dXJuIHZtYTsKLQotZXJyOgotCWludGVsX2VuZ2luZV9wb29s
X3B1dChwb29sKTsKLQlyZXR1cm4gdm1hOworCXJldHVybiAwOwogfQogCiBzdGF0aWMgdm9pZApA
QCAtMjQ4NSw2ICsyNTYxLDcgQEAgaTkxNV9nZW1fZG9fZXhlY2J1ZmZlcihzdHJ1Y3QgZHJtX2Rl
dmljZSAqZGV2LAogCWViLmJhdGNoX2xlbiA9IGFyZ3MtPmJhdGNoX2xlbjsKIAogCWViLmJhdGNo
X2ZsYWdzID0gMDsKKwogCWlmIChhcmdzLT5mbGFncyAmIEk5MTVfRVhFQ19TRUNVUkUpIHsKIAkJ
aWYgKElOVEVMX0dFTihpOTE1KSA+PSAxMSkKIAkJCXJldHVybiAtRU5PREVWOwpAQCAtMjUyOSw2
OCArMjYwNiwzNiBAQCBpOTE1X2dlbV9kb19leGVjYnVmZmVyKHN0cnVjdCBkcm1fZGV2aWNlICpk
ZXYsCiAJfQogCiAJZXJyID0gZWJfY3JlYXRlKCZlYik7Ci0JaWYgKGVycikKKwlpZiAoZXJyKSB7
CisJCURSTV9ERUJVR19EUklWRVIoImViX2NyZWF0ZSgpID0+ICVpXG4iLCBlcnIpOwogCQlnb3Rv
IGVycl9vdXRfZmVuY2U7CisJfQogCiAJR0VNX0JVR19PTighZWIubHV0X3NpemUpOwogCiAJZXJy
ID0gZWJfc2VsZWN0X2NvbnRleHQoJmViKTsKLQlpZiAodW5saWtlbHkoZXJyKSkKKwlpZiAodW5s
aWtlbHkoZXJyKSkgeworCQlEUk1fREVCVUdfRFJJVkVSKCJlYl9zZWxlY3RfY29udGV4dCgpID0+
ICVpXG4iLCBlcnIpOwogCQlnb3RvIGVycl9kZXN0cm95OworCX0KIAogCWVyciA9IGViX3Bpbl9l
bmdpbmUoJmViLCBmaWxlLCBhcmdzKTsKLQlpZiAodW5saWtlbHkoZXJyKSkKKwlpZiAodW5saWtl
bHkoZXJyKSkgeworCQlEUk1fREVCVUdfRFJJVkVSKCJlYl9waW5fZW5naW5lKCkgPT4gJWlcbiIs
IGVycik7CiAJCWdvdG8gZXJyX2NvbnRleHQ7Ci0KLQllcnIgPSBpOTE1X211dGV4X2xvY2tfaW50
ZXJydXB0aWJsZShkZXYpOwotCWlmIChlcnIpCi0JCWdvdG8gZXJyX2VuZ2luZTsKLQotCWVyciA9
IGViX3JlbG9jYXRlKCZlYik7Ci0JaWYgKGVycikgewotCQkvKgotCQkgKiBJZiB0aGUgdXNlciBl
eHBlY3RzIHRoZSBleGVjb2JqZWN0Lm9mZnNldCBhbmQKLQkJICogcmVsb2MucHJlc3VtZWRfb2Zm
c2V0IHRvIGJlIGFuIGV4YWN0IG1hdGNoLAotCQkgKiBhcyBmb3IgdXNpbmcgTk9fUkVMT0MsIHRo
ZW4gd2UgY2Fubm90IHVwZGF0ZQotCQkgKiB0aGUgZXhlY29iamVjdC5vZmZzZXQgdW50aWwgd2Ug
aGF2ZSBjb21wbGV0ZWQKLQkJICogcmVsb2NhdGlvbi4KLQkJICovCi0JCWFyZ3MtPmZsYWdzICY9
IH5fX0VYRUNfSEFTX1JFTE9DOwotCQlnb3RvIGVycl92bWE7CiAJfQogCi0JaWYgKHVubGlrZWx5
KGViLmJhdGNoLT5mbGFncyAmIEVYRUNfT0JKRUNUX1dSSVRFKSkgewotCQlEUk1fREVCVUcoIkF0
dGVtcHRpbmcgdG8gdXNlIHNlbGYtbW9kaWZ5aW5nIGJhdGNoIGJ1ZmZlclxuIik7Ci0JCWVyciA9
IC1FSU5WQUw7Ci0JCWdvdG8gZXJyX3ZtYTsKLQl9CisJaTkxNV9nZW1fd3dfY3R4X2luaXQoJmVi
Lnd3LCB0cnVlKTsKIAotCWJhdGNoID0gZWIuYmF0Y2gtPnZtYTsKLQlpZiAocmFuZ2Vfb3ZlcmZs
b3dzX3QodTY0LAotCQkJICAgICAgZWIuYmF0Y2hfc3RhcnRfb2Zmc2V0LCBlYi5iYXRjaF9sZW4s
Ci0JCQkgICAgICBiYXRjaC0+c2l6ZSkpIHsKLQkJRFJNX0RFQlVHKCJBdHRlbXB0aW5nIHRvIHVz
ZSBvdXQtb2YtYm91bmRzIGJhdGNoXG4iKTsKLQkJZXJyID0gLUVJTlZBTDsKKwllcnIgPSBlYl9y
ZWxvY2F0ZV9hbmRfcGFyc2VfY21kYnVmX2JhY2tvZmYoJmViKTsKKwlpZiAoZXJyKQogCQlnb3Rv
IGVycl92bWE7Ci0JfQotCi0JaWYgKGViLmJhdGNoX2xlbiA9PSAwKQotCQllYi5iYXRjaF9sZW4g
PSBlYi5iYXRjaC0+dm1hLT5zaXplIC0gZWIuYmF0Y2hfc3RhcnRfb2Zmc2V0OwotCi0JaWYgKGVi
X3VzZV9jbWRwYXJzZXIoJmViKSkgewotCQlzdHJ1Y3QgaTkxNV92bWEgKnZtYTsKLQotCQl2bWEg
PSBlYl9wYXJzZSgmZWIpOwotCQlpZiAoSVNfRVJSKHZtYSkpIHsKLQkJCWVyciA9IFBUUl9FUlIo
dm1hKTsKLQkJCWdvdG8gZXJyX3ZtYTsKLQkJfQotCX0KIAogCS8qCiAJICogc25iL2l2Yi92bHYg
Y29uZmxhdGUgdGhlICJiYXRjaCBpbiBwcGd0dCIgYml0IHdpdGggdGhlICJub24tc2VjdXJlCiAJ
ICogYmF0Y2giIGJpdC4gSGVuY2Ugd2UgbmVlZCB0byBwaW4gc2VjdXJlIGJhdGNoZXMgaW50byB0
aGUgZ2xvYmFsIGd0dC4KIAkgKiBoc3cgc2hvdWxkIGhhdmUgdGhpcyBmaXhlZCwgYnV0IGJkdyBt
dWNrcyBpdCB1cCBhZ2Fpbi4gKi8KKwliYXRjaCA9IGViLmJhdGNoLT52bWE7CiAJaWYgKGViLmJh
dGNoX2ZsYWdzICYgSTkxNV9ESVNQQVRDSF9TRUNVUkUpIHsKIAkJc3RydWN0IGk5MTVfdm1hICp2
bWE7CiAKQEAgLTI2MDcsNyArMjY1Miw3IEBAIGk5MTVfZ2VtX2RvX2V4ZWNidWZmZXIoc3RydWN0
IGRybV9kZXZpY2UgKmRldiwKIAkJdm1hID0gaTkxNV9nZW1fb2JqZWN0X2dndHRfcGluKGJhdGNo
LT5vYmosIE5VTEwsIDAsIDAsIDApOwogCQlpZiAoSVNfRVJSKHZtYSkpIHsKIAkJCWVyciA9IFBU
Ul9FUlIodm1hKTsKLQkJCWdvdG8gZXJyX3ZtYTsKKwkJCWdvdG8gZXJyX3Bvb2w7CiAJCX0KIAog
CQliYXRjaCA9IHZtYTsKQEAgLTI2ODQsMTMgKzI3MjksMTMgQEAgaTkxNV9nZW1fZG9fZXhlY2J1
ZmZlcihzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LAogZXJyX2JhdGNoX3VucGluOgogCWlmIChlYi5i
YXRjaF9mbGFncyAmIEk5MTVfRElTUEFUQ0hfU0VDVVJFKQogCQlpOTE1X3ZtYV91bnBpbihiYXRj
aCk7CitlcnJfcG9vbDoKIAlpZiAoYmF0Y2gtPnByaXZhdGUpCiAJCWludGVsX2VuZ2luZV9wb29s
X3B1dChiYXRjaC0+cHJpdmF0ZSk7CiBlcnJfdm1hOgogCWlmIChlYi5leGVjKQogCQllYl9yZWxl
YXNlX3ZtYXMoJmViKTsKLQltdXRleF91bmxvY2soJmRldi0+c3RydWN0X211dGV4KTsKLWVycl9l
bmdpbmU6CisJaTkxNV9nZW1fd3dfY3R4X2ZpbmkoJmViLnd3KTsKIAllYl91bnBpbl9lbmdpbmUo
JmViKTsKIGVycl9jb250ZXh0OgogCWk5MTVfZ2VtX2NvbnRleHRfcHV0KGViLmdlbV9jb250ZXh0
KTsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfY21kX3BhcnNlci5jIGIv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9jbWRfcGFyc2VyLmMKaW5kZXggYzViOWVjNWIzZDI1
Li5mNWU4MjFiZjVkNTkgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfY21k
X3BhcnNlci5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfY21kX3BhcnNlci5jCkBA
IC0xMTM2LDMxICsxMTM2LDE5IEBAIHN0YXRpYyB1MzIgKmNvcHlfYmF0Y2goc3RydWN0IGRybV9p
OTE1X2dlbV9vYmplY3QgKmRzdF9vYmosCiAJdm9pZCAqZHN0LCAqc3JjOwogCWludCByZXQ7CiAK
LQlyZXQgPSBpOTE1X2dlbV9vYmplY3RfbG9ja19pbnRlcnJ1cHRpYmxlKE5VTEwsIGRzdF9vYmop
OworCXJldCA9IGk5MTVfZ2VtX29iamVjdF9wcmVwYXJlX3dyaXRlKGRzdF9vYmosICZkc3RfbmVl
ZHNfY2xmbHVzaCk7CiAJaWYgKHJldCkKIAkJcmV0dXJuIEVSUl9QVFIocmV0KTsKIAotCXJldCA9
IGk5MTVfZ2VtX29iamVjdF9wcmVwYXJlX3dyaXRlKGRzdF9vYmosICZkc3RfbmVlZHNfY2xmbHVz
aCk7Ci0JaWYgKHJldCkgewotCQlpOTE1X2dlbV9vYmplY3RfdW5sb2NrKGRzdF9vYmopOwotCQly
ZXR1cm4gRVJSX1BUUihyZXQpOwotCX0KLQogCWRzdCA9IGk5MTVfZ2VtX29iamVjdF9waW5fbWFw
KGRzdF9vYmosIEk5MTVfTUFQX0ZPUkNFX1dCKTsKIAlpOTE1X2dlbV9vYmplY3RfZmluaXNoX2Fj
Y2Vzcyhkc3Rfb2JqKTsKLQlpOTE1X2dlbV9vYmplY3RfdW5sb2NrKGRzdF9vYmopOwogCiAJaWYg
KElTX0VSUihkc3QpKQogCQlyZXR1cm4gZHN0OwogCi0JcmV0ID0gaTkxNV9nZW1fb2JqZWN0X2xv
Y2tfaW50ZXJydXB0aWJsZShOVUxMLCBzcmNfb2JqKTsKLQlpZiAocmV0KQotCQlyZXR1cm4gRVJS
X1BUUihyZXQpOwotCiAJcmV0ID0gaTkxNV9nZW1fb2JqZWN0X3ByZXBhcmVfcmVhZChzcmNfb2Jq
LCAmc3JjX25lZWRzX2NsZmx1c2gpOwogCWlmIChyZXQpIHsKIAkJaTkxNV9nZW1fb2JqZWN0X3Vu
cGluX21hcChkc3Rfb2JqKTsKLQkJaTkxNV9nZW1fb2JqZWN0X3VubG9jayhzcmNfb2JqKTsKIAkJ
cmV0dXJuIEVSUl9QVFIocmV0KTsKIAl9CiAKQEAgLTEyMDksNyArMTE5Nyw2IEBAIHN0YXRpYyB1
MzIgKmNvcHlfYmF0Y2goc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKmRzdF9vYmosCiAJfQog
CiAJaTkxNV9nZW1fb2JqZWN0X2ZpbmlzaF9hY2Nlc3Moc3JjX29iaik7Ci0JaTkxNV9nZW1fb2Jq
ZWN0X3VubG9jayhzcmNfb2JqKTsKIAogCS8qIGRzdF9vYmogaXMgcmV0dXJuZWQgd2l0aCB2bWFw
IHBpbm5lZCAqLwogCSpuZWVkc19jbGZsdXNoX2FmdGVyID0gZHN0X25lZWRzX2NsZmx1c2ggJiBD
TEZMVVNIX0FGVEVSOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYu
aCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZHJ2LmgKaW5kZXggYzNkOGFmMjhiZmMxLi5h
YjhjYjBjODUxZjYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZHJ2LmgK
KysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYuaApAQCAtMTg0OCwxMiArMTg0OCw2
IEBAIGludCBpOTE1X2dlbV9vYmplY3RfdW5iaW5kKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0
ICpvYmosCiAKIHZvaWQgaTkxNV9nZW1fcnVudGltZV9zdXNwZW5kKHN0cnVjdCBkcm1faTkxNV9w
cml2YXRlICpkZXZfcHJpdik7CiAKLXN0YXRpYyBpbmxpbmUgaW50IF9fbXVzdF9jaGVjawotaTkx
NV9tdXRleF9sb2NrX2ludGVycnVwdGlibGUoc3RydWN0IGRybV9kZXZpY2UgKmRldikKLXsKLQly
ZXR1cm4gbXV0ZXhfbG9ja19pbnRlcnJ1cHRpYmxlKCZkZXYtPnN0cnVjdF9tdXRleCk7Ci19Ci0K
IGludCBpOTE1X2dlbV9kdW1iX2NyZWF0ZShzdHJ1Y3QgZHJtX2ZpbGUgKmZpbGVfcHJpdiwKIAkJ
CSBzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LAogCQkJIHN0cnVjdCBkcm1fbW9kZV9jcmVhdGVfZHVt
YiAqYXJncyk7Ci0tIAoyLjI0LjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVk
ZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZv
L2ludGVsLWdmeA==

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 510C868533
	for <lists+intel-gfx@lfdr.de>; Mon, 15 Jul 2019 10:29:28 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 6821589369;
	Mon, 15 Jul 2019 08:29:26 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id C165F89369
 for <intel-gfx@lists.freedesktop.org>; Mon, 15 Jul 2019 08:29:25 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17303239-1500050 
 for multiple; Mon, 15 Jul 2019 09:09:51 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 15 Jul 2019 09:09:25 +0100
Message-Id: <20190715080946.15593-3-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.22.0
In-Reply-To: <20190715080946.15593-1-chris@chris-wilson.co.uk>
References: <20190715080946.15593-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 03/24] drm/i915/gtt: Recursive ppgtt alloc for
 gen8
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

UmVmYWN0b3IgdGhlIHNlcGFyYXRlIGFsbG9jYXRpb24gcm91dGluZXMgaW50byBhIHNpbmdsZSBy
ZWN1cnNpdmUKZnVuY3Rpb24uCgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNocmlzQGNo
cmlzLXdpbHNvbi5jby51az4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQu
YyB8IDI3MiArKysrKysrKysrLS0tLS0tLS0tLS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgOTcg
aW5zZXJ0aW9ucygrKSwgMTc1IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L2k5MTVfZ2VtX2d0dC5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW1f
Z3R0LmMKaW5kZXggMWUzY2NkZjdmZTFiLi40OWRlNmQzOTQ4OGYgMTAwNjQ0Ci0tLSBhL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtX2d0dC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2k5MTVfZ2VtX2d0dC5jCkBAIC0xMDA3LDE5OSArMTAwNywxMTkgQEAgc3RhdGljIHZvaWQgZ2Vu
OF9wcGd0dF9jbGVhcihzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKIAkJCSAgIHN0YXJ0
LCBzdGFydCArIGxlbmd0aCwgdm0tPnRvcCk7CiB9CiAKLXN0YXRpYyB2b2lkIGdlbjhfcHBndHRf
Y2xlYXJfcGQoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCi0JCQkJc3RydWN0IGk5MTVf
cGFnZV9kaXJlY3RvcnkgKnBkLAotCQkJCXU2NCBzdGFydCwgdTY0IGxlbmd0aCkKLXsKLQlHRU1f
QlVHX09OKCFJU19BTElHTkVEKHN0YXJ0LCBCSVRfVUxMKEdFTjhfUFRFX1NISUZUKSkpOwotCUdF
TV9CVUdfT04oIUlTX0FMSUdORUQobGVuZ3RoLCBCSVRfVUxMKEdFTjhfUFRFX1NISUZUKSkpOwot
Ci0Jc3RhcnQgPj49IEdFTjhfUFRFX1NISUZUOwotCWxlbmd0aCA+Pj0gR0VOOF9QVEVfU0hJRlQ7
Ci0KLQlfX2dlbjhfcHBndHRfY2xlYXIodm0sIHBkLCBzdGFydCwgc3RhcnQgKyBsZW5ndGgsIDEp
OwotfQotCi1zdGF0aWMgdm9pZCBnZW44X3BwZ3R0X2NsZWFyX3BkcChzdHJ1Y3QgaTkxNV9hZGRy
ZXNzX3NwYWNlICp2bSwKLQkJCQkgc3RydWN0IGk5MTVfcGFnZV9kaXJlY3RvcnkgKiBjb25zdCBw
ZHAsCi0JCQkJIHU2NCBzdGFydCwgdTY0IGxlbmd0aCkKLXsKLQlHRU1fQlVHX09OKCFJU19BTElH
TkVEKHN0YXJ0LCBCSVRfVUxMKEdFTjhfUFRFX1NISUZUKSkpOwotCUdFTV9CVUdfT04oIUlTX0FM
SUdORUQobGVuZ3RoLCBCSVRfVUxMKEdFTjhfUFRFX1NISUZUKSkpOwotCi0Jc3RhcnQgPj49IEdF
TjhfUFRFX1NISUZUOwotCWxlbmd0aCA+Pj0gR0VOOF9QVEVfU0hJRlQ7Ci0KLQlfX2dlbjhfcHBn
dHRfY2xlYXIodm0sIHBkcCwgc3RhcnQsIHN0YXJ0ICsgbGVuZ3RoLCAyKTsKLX0KLQotc3RhdGlj
IGludCBnZW44X3BwZ3R0X2FsbG9jX3BkKHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAot
CQkJICAgICAgIHN0cnVjdCBpOTE1X3BhZ2VfZGlyZWN0b3J5ICpwZCwKLQkJCSAgICAgICB1NjQg
c3RhcnQsIHU2NCBsZW5ndGgpCitzdGF0aWMgaW50IF9fZ2VuOF9wcGd0dF9hbGxvYyhzdHJ1Y3Qg
aTkxNV9hZGRyZXNzX3NwYWNlICogY29uc3Qgdm0sCisJCQkgICAgICBzdHJ1Y3QgaTkxNV9wYWdl
X2RpcmVjdG9yeSAqIGNvbnN0IHBkLAorCQkJICAgICAgdTY0ICogY29uc3Qgc3RhcnQsIHU2NCBl
bmQsIGludCBsdmwpCiB7Ci0Jc3RydWN0IGk5MTVfcGFnZV90YWJsZSAqcHQsICphbGxvYyA9IE5V
TEw7Ci0JdTY0IGZyb20gPSBzdGFydDsKLQl1bnNpZ25lZCBpbnQgcGRlOworCWNvbnN0IHN0cnVj
dCBpOTE1X3BhZ2Vfc2NyYXRjaCAqIGNvbnN0IHNjcmF0Y2ggPSAmdm0tPnNjcmF0Y2hbbHZsXTsK
KwlzdHJ1Y3QgaTkxNV9wYWdlX3RhYmxlICphbGxvYyA9IE5VTEw7CisJdW5zaWduZWQgaW50IGlk
eCwgbGVuOwogCWludCByZXQgPSAwOwogCisJbGVuID0gZ2VuOF9wZF9yYW5nZSgqc3RhcnQsIGVu
ZCwgbHZsLS0sICZpZHgpOworCURCRygiJXMoJXApOntsdmw6JWQsIHN0YXJ0OiVsbHgsIGVuZDol
bGx4LCBpZHg6JWQsIGxlbjolZCwgdXNlZDolZH1cbiIsCisJICAgIF9fZnVuY19fLCB2bSwgbHZs
ICsgMSwgKnN0YXJ0LCBlbmQsCisJICAgIGlkeCwgbGVuLCBhdG9taWNfcmVhZChweF91c2VkKHBk
KSkpOworCUdFTV9CVUdfT04oIWxlbiB8fCAoaWR4ICsgbGVuIC0gMSkgPj4gZ2VuOF9wZF9zaGlm
dCgxKSk7CisKIAlzcGluX2xvY2soJnBkLT5sb2NrKTsKLQlnZW44X2Zvcl9lYWNoX3BkZShwdCwg
cGQsIHN0YXJ0LCBsZW5ndGgsIHBkZSkgewotCQljb25zdCBpbnQgY291bnQgPSBnZW44X3B0ZV9j
b3VudChzdGFydCwgbGVuZ3RoKTsKKwlHRU1fQlVHX09OKCFhdG9taWNfcmVhZChweF91c2VkKHBk
KSkpOyAvKiBNdXN0IGJlIHBpbm5lZCEgKi8KKwlkbyB7CisJCXN0cnVjdCBpOTE1X3BhZ2VfdGFi
bGUgKnB0ID0gcGQtPmVudHJ5W2lkeF07CiAKIAkJaWYgKCFwdCkgewogCQkJc3Bpbl91bmxvY2so
JnBkLT5sb2NrKTsKIAotCQkJcHQgPSBmZXRjaF9hbmRfemVybygmYWxsb2MpOwotCQkJaWYgKCFw
dCkKLQkJCQlwdCA9IGFsbG9jX3B0KHZtKTsKLQkJCWlmIChJU19FUlIocHQpKSB7Ci0JCQkJcmV0
ID0gUFRSX0VSUihwdCk7Ci0JCQkJZ290byB1bndpbmQ7Ci0JCQl9CisJCQlEQkcoIiVzKCVwKTp7
IGx2bDolZCwgaWR4OiVkIH0gYWxsb2NhdGluZyBuZXcgdHJlZVxuIiwKKwkJCSAgICBfX2Z1bmNf
Xywgdm0sIGx2bCArIDEsIGlkeCk7CiAKLQkJCWlmIChjb3VudCA8IEdFTjhfUFRFUyB8fCBpbnRl
bF92Z3B1X2FjdGl2ZSh2bS0+aTkxNSkpCi0JCQkJZmlsbF9weChwdCwgdm0tPnNjcmF0Y2hbMF0u
ZW5jb2RlKTsKKwkJCXB0ID0gZmV0Y2hfYW5kX3plcm8oJmFsbG9jKTsKKwkJCWlmIChsdmwpIHsK
KwkJCQlpZiAoIXB0KSB7CisJCQkJCXB0ID0gJmFsbG9jX3BkKHZtKS0+cHQ7CisJCQkJCWlmIChJ
U19FUlIocHQpKSB7CisJCQkJCQlyZXQgPSBQVFJfRVJSKHB0KTsKKwkJCQkJCWdvdG8gb3V0Owor
CQkJCQl9CisJCQkJfQogCi0JCQlzcGluX2xvY2soJnBkLT5sb2NrKTsKLQkJCWlmICghcGQtPmVu
dHJ5W3BkZV0pIHsKLQkJCQlzZXRfcGRfZW50cnkocGQsIHBkZSwgcHQpOworCQkJCWZpbGxfcHgo
cHQsIHZtLT5zY3JhdGNoW2x2bF0uZW5jb2RlKTsKIAkJCX0gZWxzZSB7Ci0JCQkJYWxsb2MgPSBw
dDsKLQkJCQlwdCA9IHBkLT5lbnRyeVtwZGVdOwotCQkJfQotCQl9Ci0KLQkJYXRvbWljX2FkZChj
b3VudCwgJnB0LT51c2VkKTsKLQl9Ci0Jc3Bpbl91bmxvY2soJnBkLT5sb2NrKTsKLQlnb3RvIG91
dDsKLQotdW53aW5kOgotCWdlbjhfcHBndHRfY2xlYXJfcGQodm0sIHBkLCBmcm9tLCBzdGFydCAt
IGZyb20pOwotb3V0OgotCWlmIChhbGxvYykKLQkJZnJlZV9weCh2bSwgYWxsb2MpOwotCXJldHVy
biByZXQ7Ci19Ci0KLXN0YXRpYyBpbnQgZ2VuOF9wcGd0dF9hbGxvY19wZHAoc3RydWN0IGk5MTVf
YWRkcmVzc19zcGFjZSAqdm0sCi0JCQkJc3RydWN0IGk5MTVfcGFnZV9kaXJlY3RvcnkgKnBkcCwK
LQkJCQl1NjQgc3RhcnQsIHU2NCBsZW5ndGgpCi17Ci0Jc3RydWN0IGk5MTVfcGFnZV9kaXJlY3Rv
cnkgKnBkLCAqYWxsb2MgPSBOVUxMOwotCXU2NCBmcm9tID0gc3RhcnQ7Ci0JdW5zaWduZWQgaW50
IHBkcGU7Ci0JaW50IHJldCA9IDA7CisJCQkJaWYgKCFwdCkgeworCQkJCQlwdCA9IGFsbG9jX3B0
KHZtKTsKKwkJCQkJaWYgKElTX0VSUihwdCkpIHsKKwkJCQkJCXJldCA9IFBUUl9FUlIocHQpOwor
CQkJCQkJZ290byBvdXQ7CisJCQkJCX0KKwkJCQl9CiAKLQlzcGluX2xvY2soJnBkcC0+bG9jayk7
Ci0JZ2VuOF9mb3JfZWFjaF9wZHBlKHBkLCBwZHAsIHN0YXJ0LCBsZW5ndGgsIHBkcGUpIHsKLQkJ
aWYgKCFwZCkgewotCQkJc3Bpbl91bmxvY2soJnBkcC0+bG9jayk7Ci0KLQkJCXBkID0gZmV0Y2hf
YW5kX3plcm8oJmFsbG9jKTsKLQkJCWlmICghcGQpCi0JCQkJcGQgPSBhbGxvY19wZCh2bSk7Ci0J
CQlpZiAoSVNfRVJSKHBkKSkgewotCQkJCXJldCA9IFBUUl9FUlIocGQpOwotCQkJCWdvdG8gdW53
aW5kOworCQkJCWlmIChpbnRlbF92Z3B1X2FjdGl2ZSh2bS0+aTkxNSkgfHwKKwkJCQkgICAgZ2Vu
OF9wdF9jb3VudCgqc3RhcnQsIGVuZCkgPCBJOTE1X1BERVMpCisJCQkJCWZpbGxfcHgocHQsIHZt
LT5zY3JhdGNoW2x2bF0uZW5jb2RlKTsKIAkJCX0KIAotCQkJZmlsbF9weChwZCwgdm0tPnNjcmF0
Y2hbMV0uZW5jb2RlKTsKKwkJCXNwaW5fbG9jaygmcGQtPmxvY2spOworCQkJaWYgKGxpa2VseSgh
cGQtPmVudHJ5W2lkeF0pKQorCQkJCXNldF9wZF9lbnRyeShwZCwgaWR4LCBwdCk7CisJCQllbHNl
CisJCQkJYWxsb2MgPSBwdCwgcHQgPSBwZC0+ZW50cnlbaWR4XTsKKwkJfQogCi0JCQlzcGluX2xv
Y2soJnBkcC0+bG9jayk7Ci0JCQlpZiAoIXBkcC0+ZW50cnlbcGRwZV0pIHsKLQkJCQlzZXRfcGRf
ZW50cnkocGRwLCBwZHBlLCBwZCk7Ci0JCQl9IGVsc2UgewotCQkJCWFsbG9jID0gcGQ7Ci0JCQkJ
cGQgPSBwZHAtPmVudHJ5W3BkcGVdOworCQlpZiAobHZsKSB7CisJCQlhdG9taWNfaW5jKCZwdC0+
dXNlZCk7CisJCQlzcGluX3VubG9jaygmcGQtPmxvY2spOworCisJCQlyZXQgPSBfX2dlbjhfcHBn
dHRfYWxsb2Modm0sIGFzX3BkKHB0KSwKKwkJCQkJCSBzdGFydCwgZW5kLCBsdmwpOworCQkJaWYg
KHVubGlrZWx5KHJldCkpIHsKKwkJCQlpZiAocmVsZWFzZV9wZF9lbnRyeShwZCwgaWR4LCBwdCwg
c2NyYXRjaCkpCisJCQkJCWZyZWVfcHgodm0sIHB0KTsKKwkJCQlnb3RvIG91dDsKIAkJCX0KLQkJ
fQotCQlhdG9taWNfaW5jKHB4X3VzZWQocGQpKTsKLQkJc3Bpbl91bmxvY2soJnBkcC0+bG9jayk7
CiAKLQkJcmV0ID0gZ2VuOF9wcGd0dF9hbGxvY19wZCh2bSwgcGQsIHN0YXJ0LCBsZW5ndGgpOwot
CQlpZiAodW5saWtlbHkocmV0KSkKLQkJCWdvdG8gdW53aW5kX3BkOworCQkJc3Bpbl9sb2NrKCZw
ZC0+bG9jayk7CisJCQlhdG9taWNfZGVjKCZwdC0+dXNlZCk7CisJCQlHRU1fQlVHX09OKCFhdG9t
aWNfcmVhZCgmcHQtPnVzZWQpKTsKKwkJfSBlbHNlIHsKKwkJCXVuc2lnbmVkIGludCBjb3VudCA9
IGdlbjhfcHRfY291bnQoKnN0YXJ0LCBlbmQpOwogCi0JCXNwaW5fbG9jaygmcGRwLT5sb2NrKTsK
LQkJYXRvbWljX2RlYyhweF91c2VkKHBkKSk7Ci0JfQotCXNwaW5fdW5sb2NrKCZwZHAtPmxvY2sp
OwotCWdvdG8gb3V0OworCQkJREJHKCIlcyglcCk6e2x2bDolZCwgc3RhcnQ6JWxseCwgZW5kOiVs
bHgsIGlkeDolZCwgbGVuOiVkLCB1c2VkOiVkfSBpbnNlcnRpbmcgcHRlXG4iLAorCQkJICAgIF9f
ZnVuY19fLCB2bSwgbHZsLCAqc3RhcnQsIGVuZCwKKwkJCSAgICBnZW44X3BkX2luZGV4KCpzdGFy
dCwgMCksIGNvdW50LAorCQkJICAgIGF0b21pY19yZWFkKCZwdC0+dXNlZCkpOwogCi11bndpbmRf
cGQ6Ci0JaWYgKHJlbGVhc2VfcGRfZW50cnkocGRwLCBwZHBlLCAmcGQtPnB0LCAmdm0tPnNjcmF0
Y2hbMl0pKQotCQlmcmVlX3B4KHZtLCBwZCk7Ci11bndpbmQ6Ci0JZ2VuOF9wcGd0dF9jbGVhcl9w
ZHAodm0sIHBkcCwgZnJvbSwgc3RhcnQgLSBmcm9tKTsKKwkJCWF0b21pY19hZGQoY291bnQsICZw
dC0+dXNlZCk7CisJCQlHRU1fQlVHX09OKGF0b21pY19yZWFkKCZwdC0+dXNlZCkgPiBJOTE1X1BE
RVMpOworCQkJKnN0YXJ0ICs9IGNvdW50OworCQl9CisJfSB3aGlsZSAoaWR4KyssIC0tbGVuKTsK
KwlzcGluX3VubG9jaygmcGQtPmxvY2spOwogb3V0OgogCWlmIChhbGxvYykKIAkJZnJlZV9weCh2
bSwgYWxsb2MpOwogCXJldHVybiByZXQ7CiB9CiAKLXN0YXRpYyBpbnQgZ2VuOF9wcGd0dF9hbGxv
Y18zbHZsKHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAotCQkJCSB1NjQgc3RhcnQsIHU2
NCBsZW5ndGgpCi17Ci0JcmV0dXJuIGdlbjhfcHBndHRfYWxsb2NfcGRwKHZtLAotCQkJCSAgICBp
OTE1X3ZtX3RvX3BwZ3R0KHZtKS0+cGQsIHN0YXJ0LCBsZW5ndGgpOwotfQotCi1zdGF0aWMgaW50
IGdlbjhfcHBndHRfYWxsb2NfNGx2bChzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKLQkJ
CQkgdTY0IHN0YXJ0LCB1NjQgbGVuZ3RoKQorc3RhdGljIGludCBnZW44X3BwZ3R0X2FsbG9jKHN0
cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAorCQkJICAgIHU2NCBzdGFydCwgdTY0IGxlbmd0
aCkKIHsKLQlzdHJ1Y3QgaTkxNV9wcGd0dCAqcHBndHQgPSBpOTE1X3ZtX3RvX3BwZ3R0KHZtKTsK
LQlzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeSAqIGNvbnN0IHBtbDQgPSBwcGd0dC0+cGQ7Ci0J
c3RydWN0IGk5MTVfcGFnZV9kaXJlY3RvcnkgKnBkcCwgKmFsbG9jID0gTlVMTDsKIAl1NjQgZnJv
bSA9IHN0YXJ0OwotCWludCByZXQgPSAwOwotCXUzMiBwbWw0ZTsKLQotCXNwaW5fbG9jaygmcG1s
NC0+bG9jayk7Ci0JZ2VuOF9mb3JfZWFjaF9wbWw0ZShwZHAsIHBtbDQsIHN0YXJ0LCBsZW5ndGgs
IHBtbDRlKSB7Ci0JCWlmICghcGRwKSB7Ci0JCQlzcGluX3VubG9jaygmcG1sNC0+bG9jayk7Ci0K
LQkJCXBkcCA9IGZldGNoX2FuZF96ZXJvKCZhbGxvYyk7Ci0JCQlpZiAoIXBkcCkKLQkJCQlwZHAg
PSBhbGxvY19wZCh2bSk7Ci0JCQlpZiAoSVNfRVJSKHBkcCkpIHsKLQkJCQlyZXQgPSBQVFJfRVJS
KHBkcCk7Ci0JCQkJZ290byB1bndpbmQ7Ci0JCQl9Ci0KLQkJCWZpbGxfcHgocGRwLCB2bS0+c2Ny
YXRjaFsyXS5lbmNvZGUpOworCWludCBlcnI7CiAKLQkJCXNwaW5fbG9jaygmcG1sNC0+bG9jayk7
Ci0JCQlpZiAoIXBtbDQtPmVudHJ5W3BtbDRlXSkgewotCQkJCXNldF9wZF9lbnRyeShwbWw0LCBw
bWw0ZSwgcGRwKTsKLQkJCX0gZWxzZSB7Ci0JCQkJYWxsb2MgPSBwZHA7Ci0JCQkJcGRwID0gcG1s
NC0+ZW50cnlbcG1sNGVdOwotCQkJfQotCQl9Ci0JCWF0b21pY19pbmMocHhfdXNlZChwZHApKTsK
LQkJc3Bpbl91bmxvY2soJnBtbDQtPmxvY2spOworCUdFTV9CVUdfT04oIUlTX0FMSUdORUQoc3Rh
cnQsIEJJVF9VTEwoR0VOOF9QVEVfU0hJRlQpKSk7CisJR0VNX0JVR19PTighSVNfQUxJR05FRChs
ZW5ndGgsIEJJVF9VTEwoR0VOOF9QVEVfU0hJRlQpKSk7CiAKLQkJcmV0ID0gZ2VuOF9wcGd0dF9h
bGxvY19wZHAodm0sIHBkcCwgc3RhcnQsIGxlbmd0aCk7Ci0JCWlmICh1bmxpa2VseShyZXQpKQot
CQkJZ290byB1bndpbmRfcGRwOworCXN0YXJ0ID4+PSBHRU44X1BURV9TSElGVDsKKwlsZW5ndGgg
Pj49IEdFTjhfUFRFX1NISUZUOworCUdFTV9CVUdfT04obGVuZ3RoID09IDApOwogCi0JCXNwaW5f
bG9jaygmcG1sNC0+bG9jayk7Ci0JCWF0b21pY19kZWMocHhfdXNlZChwZHApKTsKLQl9Ci0Jc3Bp
bl91bmxvY2soJnBtbDQtPmxvY2spOwotCWdvdG8gb3V0OworCWVyciA9IF9fZ2VuOF9wcGd0dF9h
bGxvYyh2bSwgaTkxNV92bV90b19wcGd0dCh2bSktPnBkLAorCQkJCSAmc3RhcnQsIHN0YXJ0ICsg
bGVuZ3RoLCB2bS0+dG9wKTsKKwlpZiAodW5saWtlbHkoZXJyKSkKKwkJX19nZW44X3BwZ3R0X2Ns
ZWFyKHZtLCBpOTE1X3ZtX3RvX3BwZ3R0KHZtKS0+cGQsCisJCQkJICAgZnJvbSwgc3RhcnQsIHZt
LT50b3ApOwogCi11bndpbmRfcGRwOgotCWlmIChyZWxlYXNlX3BkX2VudHJ5KHBtbDQsIHBtbDRl
LCAmcGRwLT5wdCwgJnZtLT5zY3JhdGNoWzNdKSkKLQkJZnJlZV9weCh2bSwgcGRwKTsKLXVud2lu
ZDoKLQlnZW44X3BwZ3R0X2NsZWFyKHZtLCBmcm9tLCBzdGFydCAtIGZyb20pOwotb3V0OgotCWlm
IChhbGxvYykKLQkJZnJlZV9weCh2bSwgYWxsb2MpOwotCXJldHVybiByZXQ7CisJcmV0dXJuIGVy
cjsKIH0KIAogc3RhdGljIGlubGluZSBzdHJ1Y3Qgc2d0X2RtYSB7CkBAIC0xNDk2LDE5ICsxNDE2
LDIyIEBAIHN0YXRpYyBpbnQgZ2VuOF9pbml0X3NjcmF0Y2goc3RydWN0IGk5MTVfYWRkcmVzc19z
cGFjZSAqdm0pCiBzdGF0aWMgaW50IGdlbjhfcHJlYWxsb2NhdGVfdG9wX2xldmVsX3BkcChzdHJ1
Y3QgaTkxNV9wcGd0dCAqcHBndHQpCiB7CiAJc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0g
PSAmcHBndHQtPnZtOwotCXN0cnVjdCBpOTE1X3BhZ2VfZGlyZWN0b3J5ICpwZHAgPSBwcGd0dC0+
cGQ7Ci0Jc3RydWN0IGk5MTVfcGFnZV9kaXJlY3RvcnkgKnBkOwotCXU2NCBzdGFydCA9IDAsIGxl
bmd0aCA9IHBwZ3R0LT52bS50b3RhbDsKLQl1bnNpZ25lZCBpbnQgcGRwZTsKKwlzdHJ1Y3QgaTkx
NV9wYWdlX2RpcmVjdG9yeSAqcGQgPSBwcGd0dC0+cGQ7CisJdW5zaWduZWQgaW50IGlkeDsKKwor
CUdFTV9CVUdfT04odm0tPnRvcCAhPSAyKTsKKwlHRU1fQlVHX09OKCh2bS0+dG90YWwgPj4gX19n
ZW44X3B0ZV9zaGlmdCgyKSkgIT0gR0VOOF8zTFZMX1BEUEVTKTsKKworCWZvciAoaWR4ID0gMDsg
aWR4IDwgR0VOOF8zTFZMX1BEUEVTOyBpZHgrKykgeworCQlzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVj
dG9yeSAqcGRlOwogCi0JZ2VuOF9mb3JfZWFjaF9wZHBlKHBkLCBwZHAsIHN0YXJ0LCBsZW5ndGgs
IHBkcGUpIHsKLQkJcGQgPSBhbGxvY19wZCh2bSk7Ci0JCWlmIChJU19FUlIocGQpKQotCQkJcmV0
dXJuIFBUUl9FUlIocGQpOworCQlwZGUgPSBhbGxvY19wZCh2bSk7CisJCWlmIChJU19FUlIocGRl
KSkKKwkJCXJldHVybiBQVFJfRVJSKHBkZSk7CiAKLQkJZmlsbF9weChwZCwgdm0tPnNjcmF0Y2hb
MV0uZW5jb2RlKTsKLQkJc2V0X3BkX2VudHJ5KHBkcCwgcGRwZSwgcGQpOwotCQlhdG9taWNfaW5j
KHB4X3VzZWQocGQpKTsgLyoga2VlcCBwaW5uZWQgKi8KKwkJZmlsbF9weChwZGUsIHZtLT5zY3Jh
dGNoWzFdLmVuY29kZSk7CisJCXNldF9wZF9lbnRyeShwZCwgaWR4LCBwZGUpOworCQlhdG9taWNf
aW5jKHB4X3VzZWQocGRlKSk7IC8qIGtlZXAgcGlubmVkICovCiAJfQogCiAJcmV0dXJuIDA7CkBA
IC0xNTk3LDcgKzE1MjAsNiBAQCBzdGF0aWMgc3RydWN0IGk5MTVfcHBndHQgKmdlbjhfcHBndHRf
Y3JlYXRlKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQogCX0KIAogCWlmIChpOTE1X3Zt
X2lzXzRsdmwoJnBwZ3R0LT52bSkpIHsKLQkJcHBndHQtPnZtLmFsbG9jYXRlX3ZhX3JhbmdlID0g
Z2VuOF9wcGd0dF9hbGxvY180bHZsOwogCQlwcGd0dC0+dm0uaW5zZXJ0X2VudHJpZXMgPSBnZW44
X3BwZ3R0X2luc2VydF80bHZsOwogCX0gZWxzZSB7CiAJCWlmIChpbnRlbF92Z3B1X2FjdGl2ZShp
OTE1KSkgewpAQCAtMTYwNiwxMCArMTUyOCwxMCBAQCBzdGF0aWMgc3RydWN0IGk5MTVfcHBndHQg
KmdlbjhfcHBndHRfY3JlYXRlKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQogCQkJCWdv
dG8gZXJyX2ZyZWVfcGQ7CiAJCX0KIAotCQlwcGd0dC0+dm0uYWxsb2NhdGVfdmFfcmFuZ2UgPSBn
ZW44X3BwZ3R0X2FsbG9jXzNsdmw7CiAJCXBwZ3R0LT52bS5pbnNlcnRfZW50cmllcyA9IGdlbjhf
cHBndHRfaW5zZXJ0XzNsdmw7CiAJfQogCisJcHBndHQtPnZtLmFsbG9jYXRlX3ZhX3JhbmdlID0g
Z2VuOF9wcGd0dF9hbGxvYzsKIAlwcGd0dC0+dm0uY2xlYXJfcmFuZ2UgPSBnZW44X3BwZ3R0X2Ns
ZWFyOwogCiAJaWYgKGludGVsX3ZncHVfYWN0aXZlKGk5MTUpKQotLSAKMi4yMi4wCgpfX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpJbnRlbC1nZnggbWFpbGlu
ZyBsaXN0CkludGVsLWdmeEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVl
ZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9pbnRlbC1nZng=

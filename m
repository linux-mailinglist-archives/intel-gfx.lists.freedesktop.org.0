Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 3A53160D59
	for <lists+intel-gfx@lfdr.de>; Fri,  5 Jul 2019 23:52:14 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 465646E55F;
	Fri,  5 Jul 2019 21:52:10 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 9E32D6E55E
 for <intel-gfx@lists.freedesktop.org>; Fri,  5 Jul 2019 21:52:08 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17148575-1500050 
 for <intel-gfx@lists.freedesktop.org>; Fri, 05 Jul 2019 22:52:05 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Fri,  5 Jul 2019 22:52:04 +0100
Message-Id: <20190705215204.4559-4-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190705215204.4559-1-chris@chris-wilson.co.uk>
References: <20190705215204.4559-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [CI 4/4] drm/i915/gtt: Introduce release_pd_entry
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

RnJvbTogTWlrYSBLdW9wcGFsYSA8bWlrYS5rdW9wcGFsYUBsaW51eC5pbnRlbC5jb20+CgpCeSBl
bmNhcHN1bGF0aW5nIHRoZSBsb2NraW5nIHVwcGVyIGxldmVsIGFuZCB1c2VkIGNoZWNrIGZvciBl
bnRyeQppbnRvIGEgaGVscGVyIGZ1bmN0aW9uLCB3ZSBjYW4gdXNlIGl0IGluIGFsbCBjYWxsc2l0
ZXMuCgp2MjogZ2V0IHJpZCBvZiBhdG9taWNfcmVhZHMgb24gbG93ZXIgbGV2ZWwgY2xlYXJzIChD
aHJpcykKCkNjOiBDaHJpcyBXaWxzb24gPGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KU2lnbmVk
LW9mZi1ieTogTWlrYSBLdW9wcGFsYSA8bWlrYS5rdW9wcGFsYUBsaW51eC5pbnRlbC5jb20+ClJl
dmlld2VkLWJ5OiBDaHJpcyBXaWxzb24gPGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KLS0tCiBk
cml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuYyB8IDExNCArKysrKysrKysrLS0tLS0t
LS0tLS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgNDIgaW5zZXJ0aW9ucygrKSwgNzIgZGVsZXRp
b25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW1fZ3R0LmMg
Yi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuYwppbmRleCAwYTU1YjA5MzJjODYu
LjIzNmM5NjRkZDc2MSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW1f
Z3R0LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW1fZ3R0LmMKQEAgLTgxMSw3
ICs4MTEsMjUgQEAgX19jbGVhcl9wZF9lbnRyeShzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeSAq
IGNvbnN0IHBkLAogCV9fc2V0X3BkX2VudHJ5KChwZCksIChwZGUpLCBweF9iYXNlKHRvKSwgZ2Vu
OF9wZGVfZW5jb2RlKQogCiAjZGVmaW5lIGNsZWFyX3BkX2VudHJ5KHBkLCBwZGUsIHRvKSBcCi0J
X19jbGVhcl9wZF9lbnRyeSgocGQpLCAocGRlKSwgcHhfYmFzZSh0byksIGdlbjhfcGRlX2VuY29k
ZSkKKwlfX2NsZWFyX3BkX2VudHJ5KChwZCksIChwZGUpLCAodG8pLCBnZW44X3BkZV9lbmNvZGUp
CisKK3N0YXRpYyBib29sCityZWxlYXNlX3BkX2VudHJ5KHN0cnVjdCBpOTE1X3BhZ2VfZGlyZWN0
b3J5ICogY29uc3QgcGQsCisJCSBjb25zdCB1bnNpZ25lZCBzaG9ydCBwZGUsCisJCSBhdG9taWNf
dCAqY291bnRlciwKKwkJIHN0cnVjdCBpOTE1X3BhZ2VfZG1hICogY29uc3Qgc2NyYXRjaCkKK3sK
Kwlib29sIGZyZWUgPSBmYWxzZTsKKworCXNwaW5fbG9jaygmcGQtPmxvY2spOworCWlmIChhdG9t
aWNfZGVjX2FuZF90ZXN0KGNvdW50ZXIpKSB7CisJCWNsZWFyX3BkX2VudHJ5KHBkLCBwZGUsIHNj
cmF0Y2gpOworCQlmcmVlID0gdHJ1ZTsKKwl9CisJc3Bpbl91bmxvY2soJnBkLT5sb2NrKTsKKwor
CXJldHVybiBmcmVlOworfQogCiAvKgogICogUERFIFRMQnMgYXJlIGEgcGFpbiB0byBpbnZhbGlk
YXRlIG9uIEdFTjgrLiBXaGVuIHdlIG1vZGlmeQpAQCAtODI3LDExICs4NDUsMTEgQEAgc3RhdGlj
IHZvaWQgbWFya190bGJzX2RpcnR5KHN0cnVjdCBpOTE1X3BwZ3R0ICpwcGd0dCkKIC8qIFJlbW92
ZXMgZW50cmllcyBmcm9tIGEgc2luZ2xlIHBhZ2UgdGFibGUsIHJlbGVhc2luZyBpdCBpZiBpdCdz
IGVtcHR5LgogICogQ2FsbGVyIGNhbiB1c2UgdGhlIHJldHVybiB2YWx1ZSB0byB1cGRhdGUgaGln
aGVyLWxldmVsIGVudHJpZXMuCiAgKi8KLXN0YXRpYyBib29sIGdlbjhfcHBndHRfY2xlYXJfcHQo
Y29uc3Qgc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCitzdGF0aWMgdm9pZCBnZW44X3Bw
Z3R0X2NsZWFyX3B0KGNvbnN0IHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAogCQkJCXN0
cnVjdCBpOTE1X3BhZ2VfdGFibGUgKnB0LAogCQkJCXU2NCBzdGFydCwgdTY0IGxlbmd0aCkKIHsK
LQl1bnNpZ25lZCBpbnQgbnVtX2VudHJpZXMgPSBnZW44X3B0ZV9jb3VudChzdGFydCwgbGVuZ3Ro
KTsKKwljb25zdCB1bnNpZ25lZCBpbnQgbnVtX2VudHJpZXMgPSBnZW44X3B0ZV9jb3VudChzdGFy
dCwgbGVuZ3RoKTsKIAlnZW44X3B0ZV90ICp2YWRkcjsKIAogCXZhZGRyID0ga21hcF9hdG9taWNf
cHgocHQpOwpAQCAtODM5LDEwICs4NTcsMTEgQEAgc3RhdGljIGJvb2wgZ2VuOF9wcGd0dF9jbGVh
cl9wdChjb25zdCBzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKIAlrdW5tYXBfYXRvbWlj
KHZhZGRyKTsKIAogCUdFTV9CVUdfT04obnVtX2VudHJpZXMgPiBhdG9taWNfcmVhZCgmcHQtPnVz
ZWQpKTsKLQlyZXR1cm4gIWF0b21pY19zdWJfcmV0dXJuKG51bV9lbnRyaWVzLCAmcHQtPnVzZWQp
OworCisJYXRvbWljX3N1YihudW1fZW50cmllcywgJnB0LT51c2VkKTsKIH0KIAotc3RhdGljIGJv
b2wgZ2VuOF9wcGd0dF9jbGVhcl9wZChzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKK3N0
YXRpYyB2b2lkIGdlbjhfcHBndHRfY2xlYXJfcGQoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAq
dm0sCiAJCQkJc3RydWN0IGk5MTVfcGFnZV9kaXJlY3RvcnkgKnBkLAogCQkJCXU2NCBzdGFydCwg
dTY0IGxlbmd0aCkKIHsKQEAgLTg1MCwzMCArODY5LDIwIEBAIHN0YXRpYyBib29sIGdlbjhfcHBn
dHRfY2xlYXJfcGQoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCiAJdTMyIHBkZTsKIAog
CWdlbjhfZm9yX2VhY2hfcGRlKHB0LCBwZCwgc3RhcnQsIGxlbmd0aCwgcGRlKSB7Ci0JCWJvb2wg
ZnJlZSA9IGZhbHNlOwotCiAJCUdFTV9CVUdfT04ocHQgPT0gdm0tPnNjcmF0Y2hfcHQpOwogCi0J
CWlmICghZ2VuOF9wcGd0dF9jbGVhcl9wdCh2bSwgcHQsIHN0YXJ0LCBsZW5ndGgpKQotCQkJY29u
dGludWU7Ci0KLQkJc3Bpbl9sb2NrKCZwZC0+bG9jayk7Ci0JCWlmICghYXRvbWljX3JlYWQoJnB0
LT51c2VkKSkgewotCQkJY2xlYXJfcGRfZW50cnkocGQsIHBkZSwgdm0tPnNjcmF0Y2hfcHQpOwot
CQkJZnJlZSA9IHRydWU7Ci0JCX0KLQkJc3Bpbl91bmxvY2soJnBkLT5sb2NrKTsKLQkJaWYgKGZy
ZWUpCisJCWF0b21pY19pbmMoJnB0LT51c2VkKTsKKwkJZ2VuOF9wcGd0dF9jbGVhcl9wdCh2bSwg
cHQsIHN0YXJ0LCBsZW5ndGgpOworCQlpZiAocmVsZWFzZV9wZF9lbnRyeShwZCwgcGRlLCAmcHQt
PnVzZWQsCisJCQkJICAgICBweF9iYXNlKHZtLT5zY3JhdGNoX3B0KSkpCiAJCQlmcmVlX3B0KHZt
LCBwdCk7CiAJfQotCi0JcmV0dXJuICFhdG9taWNfcmVhZCgmcGQtPnVzZWQpOwogfQogCiAvKiBS
ZW1vdmVzIGVudHJpZXMgZnJvbSBhIHNpbmdsZSBwYWdlIGRpciBwb2ludGVyLCByZWxlYXNpbmcg
aXQgaWYgaXQncyBlbXB0eS4KICAqIENhbGxlciBjYW4gdXNlIHRoZSByZXR1cm4gdmFsdWUgdG8g
dXBkYXRlIGhpZ2hlci1sZXZlbCBlbnRyaWVzCiAgKi8KLXN0YXRpYyBib29sIGdlbjhfcHBndHRf
Y2xlYXJfcGRwKHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAorc3RhdGljIHZvaWQgZ2Vu
OF9wcGd0dF9jbGVhcl9wZHAoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCiAJCQkJIHN0
cnVjdCBpOTE1X3BhZ2VfZGlyZWN0b3J5ICogY29uc3QgcGRwLAogCQkJCSB1NjQgc3RhcnQsIHU2
NCBsZW5ndGgpCiB7CkBAIC04ODEsMjQgKzg5MCwxNCBAQCBzdGF0aWMgYm9vbCBnZW44X3BwZ3R0
X2NsZWFyX3BkcChzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKIAl1bnNpZ25lZCBpbnQg
cGRwZTsKIAogCWdlbjhfZm9yX2VhY2hfcGRwZShwZCwgcGRwLCBzdGFydCwgbGVuZ3RoLCBwZHBl
KSB7Ci0JCWJvb2wgZnJlZSA9IGZhbHNlOwotCiAJCUdFTV9CVUdfT04ocGQgPT0gdm0tPnNjcmF0
Y2hfcGQpOwogCi0JCWlmICghZ2VuOF9wcGd0dF9jbGVhcl9wZCh2bSwgcGQsIHN0YXJ0LCBsZW5n
dGgpKQotCQkJY29udGludWU7Ci0KLQkJc3Bpbl9sb2NrKCZwZHAtPmxvY2spOwotCQlpZiAoIWF0
b21pY19yZWFkKCZwZC0+dXNlZCkpIHsKLQkJCWNsZWFyX3BkX2VudHJ5KHBkcCwgcGRwZSwgdm0t
PnNjcmF0Y2hfcGQpOwotCQkJZnJlZSA9IHRydWU7Ci0JCX0KLQkJc3Bpbl91bmxvY2soJnBkcC0+
bG9jayk7Ci0JCWlmIChmcmVlKQorCQlhdG9taWNfaW5jKCZwZC0+dXNlZCk7CisJCWdlbjhfcHBn
dHRfY2xlYXJfcGQodm0sIHBkLCBzdGFydCwgbGVuZ3RoKTsKKwkJaWYgKHJlbGVhc2VfcGRfZW50
cnkocGRwLCBwZHBlLCAmcGQtPnVzZWQsCisJCQkJICAgICBweF9iYXNlKHZtLT5zY3JhdGNoX3Bk
KSkpCiAJCQlmcmVlX3BkKHZtLCBwZCk7CiAJfQotCi0JcmV0dXJuICFhdG9taWNfcmVhZCgmcGRw
LT51c2VkKTsKIH0KIAogc3RhdGljIHZvaWQgZ2VuOF9wcGd0dF9jbGVhcl8zbHZsKHN0cnVjdCBp
OTE1X2FkZHJlc3Nfc3BhY2UgKnZtLApAQCAtOTIyLDE5ICs5MjEsMTIgQEAgc3RhdGljIHZvaWQg
Z2VuOF9wcGd0dF9jbGVhcl80bHZsKHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAogCUdF
TV9CVUdfT04oIWk5MTVfdm1faXNfNGx2bCh2bSkpOwogCiAJZ2VuOF9mb3JfZWFjaF9wbWw0ZShw
ZHAsIHBtbDQsIHN0YXJ0LCBsZW5ndGgsIHBtbDRlKSB7Ci0JCWJvb2wgZnJlZSA9IGZhbHNlOwog
CQlHRU1fQlVHX09OKHBkcCA9PSB2bS0+c2NyYXRjaF9wZHApOwogCi0JCWlmICghZ2VuOF9wcGd0
dF9jbGVhcl9wZHAodm0sIHBkcCwgc3RhcnQsIGxlbmd0aCkpCi0JCQljb250aW51ZTsKLQotCQlz
cGluX2xvY2soJnBtbDQtPmxvY2spOwotCQlpZiAoIWF0b21pY19yZWFkKCZwZHAtPnVzZWQpKSB7
Ci0JCQljbGVhcl9wZF9lbnRyeShwbWw0LCBwbWw0ZSwgdm0tPnNjcmF0Y2hfcGRwKTsKLQkJCWZy
ZWUgPSB0cnVlOwotCQl9Ci0JCXNwaW5fdW5sb2NrKCZwbWw0LT5sb2NrKTsKLQkJaWYgKGZyZWUp
CisJCWF0b21pY19pbmMoJnBkcC0+dXNlZCk7CisJCWdlbjhfcHBndHRfY2xlYXJfcGRwKHZtLCBw
ZHAsIHN0YXJ0LCBsZW5ndGgpOworCQlpZiAocmVsZWFzZV9wZF9lbnRyeShwbWw0LCBwbWw0ZSwg
JnBkcC0+dXNlZCwKKwkJCQkgICAgIHB4X2Jhc2Uodm0tPnNjcmF0Y2hfcGRwKSkpCiAJCQlmcmVl
X3BkKHZtLCBwZHApOwogCX0KIH0KQEAgLTE0NTcsMTcgKzE0NDksOCBAQCBzdGF0aWMgaW50IGdl
bjhfcHBndHRfYWxsb2NfcGRwKHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAogCWdvdG8g
b3V0OwogCiB1bndpbmRfcGQ6Ci0JaWYgKGFsbG9jKSB7Ci0JCWZyZWVfcGQodm0sIGFsbG9jKTsK
LQkJYWxsb2MgPSBOVUxMOwotCX0KLQlzcGluX2xvY2soJnBkcC0+bG9jayk7Ci0JaWYgKGF0b21p
Y19kZWNfYW5kX3Rlc3QoJnBkLT51c2VkKSkgewotCQlHRU1fQlVHX09OKGFsbG9jKTsKLQkJYWxs
b2MgPSBwZDsgLyogZGVmZXIgdGhlIGZyZWUgdG8gYWZ0ZXIgdGhlIGxvY2sgKi8KLQkJY2xlYXJf
cGRfZW50cnkocGRwLCBwZHBlLCB2bS0+c2NyYXRjaF9wZCk7Ci0JfQotCXNwaW5fdW5sb2NrKCZw
ZHAtPmxvY2spOworCWlmIChyZWxlYXNlX3BkX2VudHJ5KHBkcCwgcGRwZSwgJnBkLT51c2VkLCBw
eF9iYXNlKHZtLT5zY3JhdGNoX3BkKSkpCisJCWZyZWVfcGQodm0sIHBkKTsKIHVud2luZDoKIAln
ZW44X3BwZ3R0X2NsZWFyX3BkcCh2bSwgcGRwLCBmcm9tLCBzdGFydCAtIGZyb20pOwogb3V0OgpA
QCAtMTUzMCwxNyArMTUxMyw4IEBAIHN0YXRpYyBpbnQgZ2VuOF9wcGd0dF9hbGxvY180bHZsKHN0
cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAogCWdvdG8gb3V0OwogCiB1bndpbmRfcGRwOgot
CWlmIChhbGxvYykgewotCQlmcmVlX3BkKHZtLCBhbGxvYyk7Ci0JCWFsbG9jID0gTlVMTDsKLQl9
Ci0Jc3Bpbl9sb2NrKCZwbWw0LT5sb2NrKTsKLQlpZiAoYXRvbWljX2RlY19hbmRfdGVzdCgmcGRw
LT51c2VkKSkgewotCQlHRU1fQlVHX09OKGFsbG9jKTsKLQkJYWxsb2MgPSBwZHA7IC8qIGRlZmVy
IHRoZSBmcmVlIHVudGlsIGFmdGVyIHRoZSBsb2NrICovCi0JCWNsZWFyX3BkX2VudHJ5KHBtbDQs
IHBtbDRlLCB2bS0+c2NyYXRjaF9wZHApOwotCX0KLQlzcGluX3VubG9jaygmcG1sNC0+bG9jayk7
CisJaWYgKHJlbGVhc2VfcGRfZW50cnkocG1sNCwgcG1sNGUsICZwZHAtPnVzZWQsIHB4X2Jhc2Uo
dm0tPnNjcmF0Y2hfcGRwKSkpCisJCWZyZWVfcGQodm0sIHBkcCk7CiB1bndpbmQ6CiAJZ2VuOF9w
cGd0dF9jbGVhcl80bHZsKHZtLCBmcm9tLCBzdGFydCAtIGZyb20pOwogb3V0OgpAQCAtMTU3MCwx
MSArMTU0NCw3IEBAIHN0YXRpYyBpbnQgZ2VuOF9wcmVhbGxvY2F0ZV90b3BfbGV2ZWxfcGRwKHN0
cnVjdCBpOTE1X3BwZ3R0ICpwcGd0dCkKIAlyZXR1cm4gMDsKIAogdW53aW5kOgotCXN0YXJ0IC09
IGZyb207Ci0JZ2VuOF9mb3JfZWFjaF9wZHBlKHBkLCBwZHAsIGZyb20sIHN0YXJ0LCBwZHBlKSB7
Ci0JCWNsZWFyX3BkX2VudHJ5KHBkcCwgcGRwZSwgdm0tPnNjcmF0Y2hfcGQpOwotCQlmcmVlX3Bk
KHZtLCBwZCk7Ci0JfQorCWdlbjhfcHBndHRfY2xlYXJfcGRwKHZtLCBwZHAsIGZyb20sIHN0YXJ0
IC0gZnJvbSk7CiAJYXRvbWljX3NldCgmcGRwLT51c2VkLCAwKTsKIAlyZXR1cm4gLUVOT01FTTsK
IH0KLS0gCjIuMjAuMQoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Au
b3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwt
Z2Z4

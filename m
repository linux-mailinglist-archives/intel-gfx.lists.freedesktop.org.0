Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id EDD66F8BC0
	for <lists+intel-gfx@lfdr.de>; Tue, 12 Nov 2019 10:29:37 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 740016EAC2;
	Tue, 12 Nov 2019 09:29:20 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 2DAFF6EA98
 for <intel-gfx@lists.freedesktop.org>; Tue, 12 Nov 2019 09:29:17 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 19170027-1500050 
 for multiple; Tue, 12 Nov 2019 09:28:59 +0000
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Tue, 12 Nov 2019 09:28:48 +0000
Message-Id: <20191112092854.869-21-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.24.0
In-Reply-To: <20191112092854.869-1-chris@chris-wilson.co.uk>
References: <20191112092854.869-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 21/27] drm/i915: Flush idle barriers when waiting
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SWYgd2UgZG8gZmluZCBvdXJzZWx2ZXMgd2l0aCBhbiBpZGxlIGJhcnJpZXIgaW5zaWRlIG91ciBh
Y3RpdmUgd2hpbGUKd2FpdGluZywgYXR0ZW1wdCB0byBmbHVzaCBpdCBieSBlbWl0dGluZyBhIHB1
bHNlIHVzaW5nIHRoZSBrZXJuZWwKY29udGV4dC4KClNpZ25lZC1vZmYtYnk6IENocmlzIFdpbHNv
biA8Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5
MTVfYWN0aXZlLmMgICAgICAgICAgIHwgMjEgKysrKysrKystCiBkcml2ZXJzL2dwdS9kcm0vaTkx
NS9zZWxmdGVzdHMvaTkxNV9hY3RpdmUuYyB8IDQ2ICsrKysrKysrKysrKysrKysrKysrCiAyIGZp
bGVzIGNoYW5nZWQsIDY1IGluc2VydGlvbnMoKyksIDIgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0
IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9hY3RpdmUuYyBiL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2k5MTVfYWN0aXZlLmMKaW5kZXggOTUzMzU5ZmI4MmYyLi5jNzk1NzdmMDhiZTggMTAwNjQ0
Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfYWN0aXZlLmMKKysrIGIvZHJpdmVycy9n
cHUvZHJtL2k5MTUvaTkxNV9hY3RpdmUuYwpAQCAtNyw2ICs3LDcgQEAKICNpbmNsdWRlIDxsaW51
eC9kZWJ1Z29iamVjdHMuaD4KIAogI2luY2x1ZGUgImd0L2ludGVsX2NvbnRleHQuaCIKKyNpbmNs
dWRlICJndC9pbnRlbF9lbmdpbmVfaGVhcnRiZWF0LmgiCiAjaW5jbHVkZSAiZ3QvaW50ZWxfZW5n
aW5lX3BtLmgiCiAjaW5jbHVkZSAiZ3QvaW50ZWxfcmluZy5oIgogCkBAIC00MzcsNiArNDM4LDIx
IEBAIHN0YXRpYyB2b2lkIGVuYWJsZV9zaWduYWxpbmcoc3RydWN0IGk5MTVfYWN0aXZlX2ZlbmNl
ICphY3RpdmUpCiAJZG1hX2ZlbmNlX3B1dChmZW5jZSk7CiB9CiAKK3N0YXRpYyBpbnQgZmx1c2hf
YmFycmllcihzdHJ1Y3QgYWN0aXZlX25vZGUgKml0KQoreworCXN0cnVjdCBpbnRlbF9lbmdpbmVf
Y3MgKmVuZ2luZTsKKworCWlmICghaXNfYmFycmllcigmaXQtPmJhc2UpKQorCQlyZXR1cm4gMDsK
KworCWVuZ2luZSA9IF9fYmFycmllcl90b19lbmdpbmUoaXQpOworCXNtcF9ybWIoKTsgLyogc2Vy
aWFsaXNlIHdpdGggYWRkX2FjdGl2ZV9iYXJyaWVycyAqLworCWlmICghaXNfYmFycmllcigmaXQt
PmJhc2UpKQorCQlyZXR1cm4gMDsKKworCXJldHVybiBpbnRlbF9lbmdpbmVfZmx1c2hfYmFycmll
cnMoZW5naW5lKTsKK30KKwogaW50IGk5MTVfYWN0aXZlX3dhaXQoc3RydWN0IGk5MTVfYWN0aXZl
ICpyZWYpCiB7CiAJc3RydWN0IGFjdGl2ZV9ub2RlICppdCwgKm47CkBAIC00NTAsOCArNDY2LDkg
QEAgaW50IGk5MTVfYWN0aXZlX3dhaXQoc3RydWN0IGk5MTVfYWN0aXZlICpyZWYpCiAJLyogRmx1
c2ggbGF6eSBzaWduYWxzICovCiAJZW5hYmxlX3NpZ25hbGluZygmcmVmLT5leGNsKTsKIAlyYnRy
ZWVfcG9zdG9yZGVyX2Zvcl9lYWNoX2VudHJ5X3NhZmUoaXQsIG4sICZyZWYtPnRyZWUsIG5vZGUp
IHsKLQkJaWYgKGlzX2JhcnJpZXIoJml0LT5iYXNlKSkgLyogdW5jb25uZWN0ZWQgaWRsZSBiYXJy
aWVyICovCi0JCQljb250aW51ZTsKKwkJZXJyID0gZmx1c2hfYmFycmllcihpdCk7IC8qIHVuY29u
bmVjdGVkIGlkbGUgYmFycmllcj8gKi8KKwkJaWYgKGVycikKKwkJCWJyZWFrOwogCiAJCWVuYWJs
ZV9zaWduYWxpbmcoJml0LT5iYXNlKTsKIAl9CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9zZWxmdGVzdHMvaTkxNV9hY3RpdmUuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L3NlbGZ0
ZXN0cy9pOTE1X2FjdGl2ZS5jCmluZGV4IGYzZmEwNWM3OGQ3OC4uNjYxZTI5M2IzN2IwIDEwMDY0
NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9zZWxmdGVzdHMvaTkxNV9hY3RpdmUuYworKysg
Yi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9zZWxmdGVzdHMvaTkxNV9hY3RpdmUuYwpAQCAtMTkzLDEx
ICsxOTMsNTcgQEAgc3RhdGljIGludCBsaXZlX2FjdGl2ZV9yZXRpcmUodm9pZCAqYXJnKQogCXJl
dHVybiBlcnI7CiB9CiAKK3N0YXRpYyBpbnQgbGl2ZV9hY3RpdmVfYmFycmllcih2b2lkICphcmcp
Cit7CisJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUgPSBhcmc7CisJc3RydWN0IGludGVs
X2VuZ2luZV9jcyAqZW5naW5lOworCXN0cnVjdCBsaXZlX2FjdGl2ZSAqYWN0aXZlOworCWludCBl
cnIgPSAwOworCisJLyogQ2hlY2sgdGhhdCB3ZSBnZXQgYSBjYWxsYmFjayB3aGVuIHJlcXVlc3Rz
IHJldGlyZSB1cG9uIHdhaXRpbmcgKi8KKworCWFjdGl2ZSA9IF9fbGl2ZV9hbGxvYyhpOTE1KTsK
KwlpZiAoIWFjdGl2ZSkKKwkJcmV0dXJuIC1FTk9NRU07CisKKwllcnIgPSBpOTE1X2FjdGl2ZV9h
Y3F1aXJlKCZhY3RpdmUtPmJhc2UpOworCWlmIChlcnIpCisJCWdvdG8gb3V0OworCisJZm9yX2Vh
Y2hfdWFiaV9lbmdpbmUoZW5naW5lLCBpOTE1KSB7CisJCWVyciA9IGk5MTVfYWN0aXZlX2FjcXVp
cmVfcHJlYWxsb2NhdGVfYmFycmllcigmYWN0aXZlLT5iYXNlLAorCQkJCQkJCSAgICAgIGVuZ2lu
ZSk7CisJCWlmIChlcnIpCisJCQlicmVhazsKKworCQlpOTE1X2FjdGl2ZV9hY3F1aXJlX2JhcnJp
ZXIoJmFjdGl2ZS0+YmFzZSk7CisJfQorCisJaTkxNV9hY3RpdmVfcmVsZWFzZSgmYWN0aXZlLT5i
YXNlKTsKKworCWlmIChlcnIgPT0gMCkKKwkJZXJyID0gaTkxNV9hY3RpdmVfd2FpdCgmYWN0aXZl
LT5iYXNlKTsKKworCWlmIChlcnIgPT0gMCAmJiAhUkVBRF9PTkNFKGFjdGl2ZS0+cmV0aXJlZCkp
IHsKKwkJcHJfZXJyKCJpOTE1X2FjdGl2ZSBub3QgcmV0aXJlZCBhZnRlciBmbHVzaGluZyBiYXJy
aWVycyFcbiIpOworCQllcnIgPSAtRUlOVkFMOworCX0KKworb3V0OgorCV9fbGl2ZV9wdXQoYWN0
aXZlKTsKKworCWlmIChpZ3RfZmx1c2hfdGVzdChpOTE1KSkKKwkJZXJyID0gLUVJTzsKKworCXJl
dHVybiBlcnI7Cit9CisKIGludCBpOTE1X2FjdGl2ZV9saXZlX3NlbGZ0ZXN0cyhzdHJ1Y3QgZHJt
X2k5MTVfcHJpdmF0ZSAqaTkxNSkKIHsKIAlzdGF0aWMgY29uc3Qgc3RydWN0IGk5MTVfc3VidGVz
dCB0ZXN0c1tdID0gewogCQlTVUJURVNUKGxpdmVfYWN0aXZlX3dhaXQpLAogCQlTVUJURVNUKGxp
dmVfYWN0aXZlX3JldGlyZSksCisJCVNVQlRFU1QobGl2ZV9hY3RpdmVfYmFycmllciksCiAJfTsK
IAogCWlmIChpbnRlbF9ndF9pc193ZWRnZWQoJmk5MTUtPmd0KSkKLS0gCjIuMjQuMAoKX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxp
bmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJl
ZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 184A82664E
	for <lists+intel-gfx@lfdr.de>; Wed, 22 May 2019 16:52:21 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 52FD9899E8;
	Wed, 22 May 2019 14:52:19 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 9C1A6899E8
 for <intel-gfx@lists.freedesktop.org>; Wed, 22 May 2019 14:52:17 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from localhost (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP (TLS) id
 16642484-1500050 for multiple; Wed, 22 May 2019 15:52:14 +0100
MIME-Version: 1.0
From: Chris Wilson <chris@chris-wilson.co.uk>
User-Agent: alot/0.6
To: Mika Kuoppala <mika.kuoppala@linux.intel.com>,
 intel-gfx@lists.freedesktop.org
References: <20190520080127.18255-1-chris@chris-wilson.co.uk>
 <20190520080127.18255-25-chris@chris-wilson.co.uk>
 <87mujepnjx.fsf@gaia.fi.intel.com>
In-Reply-To: <87mujepnjx.fsf@gaia.fi.intel.com>
Message-ID: <155853673288.28319.12696768527763712185@skylake-alporthouse-com>
Date: Wed, 22 May 2019 15:52:12 +0100
Subject: Re: [Intel-gfx] [PATCH 25/33] drm/i915: Move object close under its
 own lock
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

UXVvdGluZyBNaWthIEt1b3BwYWxhICgyMDE5LTA1LTIyIDE1OjMyOjM0KQo+IENocmlzIFdpbHNv
biA8Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPiB3cml0ZXM6Cj4gPiBkaWZmIC0tZ2l0IGEvZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRleHQuYyBiL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2dlbS9pOTE1X2dlbV9jb250ZXh0LmMKPiA+IGluZGV4IDUwMTZhM2UxZjg2My4uYTk2
MDhkOWNlZDZhIDEwMDY0NAo+ID4gLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVf
Z2VtX2NvbnRleHQuYwo+ID4gKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2Vt
X2NvbnRleHQuYwo+ID4gQEAgLTk1LDI0ICs5NSw0MiBAQCB2b2lkIGk5MTVfbHV0X2hhbmRsZV9m
cmVlKHN0cnVjdCBpOTE1X2x1dF9oYW5kbGUgKmx1dCkKPiA+ICAKPiA+ICBzdGF0aWMgdm9pZCBs
dXRfY2xvc2Uoc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCkKPiA+ICB7Cj4gPiAtICAgICBz
dHJ1Y3QgaTkxNV9sdXRfaGFuZGxlICpsdXQsICpsbjsKPiA+ICAgICAgIHN0cnVjdCByYWRpeF90
cmVlX2l0ZXIgaXRlcjsKPiA+ICAgICAgIHZvaWQgX19yY3UgKipzbG90Owo+ID4gIAo+ID4gLSAg
ICAgbGlzdF9mb3JfZWFjaF9lbnRyeV9zYWZlKGx1dCwgbG4sICZjdHgtPmhhbmRsZXNfbGlzdCwg
Y3R4X2xpbmspIHsKPiA+IC0gICAgICAgICAgICAgbGlzdF9kZWwoJmx1dC0+b2JqX2xpbmspOwo+
ID4gLSAgICAgICAgICAgICBpOTE1X2x1dF9oYW5kbGVfZnJlZShsdXQpOwo+ID4gLSAgICAgfQo+
ID4gLSAgICAgSU5JVF9MSVNUX0hFQUQoJmN0eC0+aGFuZGxlc19saXN0KTsKPiA+ICsgICAgIGxv
Y2tkZXBfYXNzZXJ0X2hlbGQoJmN0eC0+bXV0ZXgpOwo+ID4gIAo+ID4gICAgICAgcmN1X3JlYWRf
bG9jaygpOwo+ID4gICAgICAgcmFkaXhfdHJlZV9mb3JfZWFjaF9zbG90KHNsb3QsICZjdHgtPmhh
bmRsZXNfdm1hLCAmaXRlciwgMCkgewo+ID4gICAgICAgICAgICAgICBzdHJ1Y3QgaTkxNV92bWEg
KnZtYSA9IHJjdV9kZXJlZmVyZW5jZV9yYXcoKnNsb3QpOwo+ID4gLQo+ID4gLSAgICAgICAgICAg
ICByYWRpeF90cmVlX2l0ZXJfZGVsZXRlKCZjdHgtPmhhbmRsZXNfdm1hLCAmaXRlciwgc2xvdCk7
Cj4gPiAtCj4gPiAtICAgICAgICAgICAgIHZtYS0+b3Blbl9jb3VudC0tOwo+ID4gLSAgICAgICAg
ICAgICBpOTE1X3ZtYV9wdXQodm1hKTsKPiA+ICsgICAgICAgICAgICAgc3RydWN0IGRybV9pOTE1
X2dlbV9vYmplY3QgKm9iaiA9IHZtYS0+b2JqOwo+ID4gKyAgICAgICAgICAgICBzdHJ1Y3QgaTkx
NV9sdXRfaGFuZGxlICpsdXQ7Cj4gPiArICAgICAgICAgICAgIGJvb2wgZm91bmQgPSBmYWxzZTsK
PiA+ICsKPiA+ICsgICAgICAgICAgICAgcmN1X3JlYWRfdW5sb2NrKCk7Cj4gPiArICAgICAgICAg
ICAgIGk5MTVfZ2VtX29iamVjdF9sb2NrKG9iaik7Cj4gPiArICAgICAgICAgICAgIGxpc3RfZm9y
X2VhY2hfZW50cnkobHV0LCAmb2JqLT5sdXRfbGlzdCwgb2JqX2xpbmspIHsKPiA+ICsgICAgICAg
ICAgICAgICAgICAgICBpZiAobHV0LT5jdHggIT0gY3R4KQo+ID4gKyAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgY29udGludWU7Cj4gPiArCj4gPiArICAgICAgICAgICAgICAgICAgICAgaWYg
KGx1dC0+aGFuZGxlICE9IGl0ZXIuaW5kZXgpCj4gPiArICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICBjb250aW51ZTsKPiA+ICsKPiA+ICsgICAgICAgICAgICAgICAgICAgICBsaXN0X2RlbCgm
bHV0LT5vYmpfbGluayk7Cj4gPiArICAgICAgICAgICAgICAgICAgICAgaTkxNV9sdXRfaGFuZGxl
X2ZyZWUobHV0KTsKPiAKPiBZb3UgY291bGQgZnJlZSB0aGlzIGFmdGVyIG9iamVjdF91bmxvY2sg
aWYgeW91IHdhbnQuIFNocnVnLgo+IAo+ID4gKyAgICAgICAgICAgICAgICAgICAgIGZvdW5kID0g
dHJ1ZTsKPiA+ICsgICAgICAgICAgICAgICAgICAgICBicmVhazsKPiA+ICsgICAgICAgICAgICAg
fQo+ID4gKyAgICAgICAgICAgICBpOTE1X2dlbV9vYmplY3RfdW5sb2NrKG9iaik7Cj4gPiArICAg
ICAgICAgICAgIHJjdV9yZWFkX2xvY2soKTsKPiA+ICsKPiA+ICsgICAgICAgICAgICAgaWYgKGZv
dW5kKSB7Cj4gPiArICAgICAgICAgICAgICAgICAgICAgcmFkaXhfdHJlZV9pdGVyX2RlbGV0ZSgm
Y3R4LT5oYW5kbGVzX3ZtYSwgJml0ZXIsIHNsb3QpOwo+ID4gKyAgICAgICAgICAgICAgICAgICAg
IGlmIChhdG9taWNfZGVjX2FuZF90ZXN0KCZ2bWEtPm9wZW5fY291bnQpICYmCj4gPiArICAgICAg
ICAgICAgICAgICAgICAgICAgICFpOTE1X3ZtYV9pc19nZ3R0KHZtYSkpCj4gPiArICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICBpOTE1X3ZtYV9jbG9zZSh2bWEpOwo+ID4gKyAgICAgICAgICAg
ICAgICAgICAgIGk5MTVfZ2VtX29iamVjdF9wdXQob2JqKTsKPiAKPiBJIGFtIHN0cnVnZ2luZyB0
byBwYWlyIHRoaXMgd2l0aCBnZXQuCgpbc25pcF0KCj4gPiAgI2VuZGlmIC8qIF9fSTkxNV9HRU1f
Q09OVEVYVF9UWVBFU19IX18gKi8KPiA+IGRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9nZW0vaTkxNV9nZW1fZXhlY2J1ZmZlci5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5
MTVfZ2VtX2V4ZWNidWZmZXIuYwo+ID4gaW5kZXggMTNhYjJhMmUwMDk5Li5mYTBhODgwY2E0ZGUg
MTAwNjQ0Cj4gPiAtLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fZXhlY2J1
ZmZlci5jCj4gPiArKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fZXhlY2J1
ZmZlci5jCj4gPiBAQCAtODAxLDkgKzgwMSw2IEBAIHN0YXRpYyBpbnQgZWJfbG9va3VwX3ZtYXMo
c3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIpCj4gPiAgICAgICB1bnNpZ25lZCBpbnQgaSwgYmF0
Y2g7Cj4gPiAgICAgICBpbnQgZXJyOwo+ID4gIAo+ID4gLSAgICAgaWYgKHVubGlrZWx5KGk5MTVf
Z2VtX2NvbnRleHRfaXNfY2xvc2VkKGViLT5nZW1fY29udGV4dCkpKQo+ID4gLSAgICAgICAgICAg
ICByZXR1cm4gLUVOT0VOVDsKPiA+IC0KPiA+ICAgICAgIGlmICh1bmxpa2VseShpOTE1X2dlbV9j
b250ZXh0X2lzX2Jhbm5lZChlYi0+Z2VtX2NvbnRleHQpKSkKPiA+ICAgICAgICAgICAgICAgcmV0
dXJuIC1FSU87Cj4gPiAgCj4gPiBAQCAtODEyLDYgKzgwOSwxMiBAQCBzdGF0aWMgaW50IGViX2xv
b2t1cF92bWFzKHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViKQo+ID4gIAo+ID4gICAgICAgYmF0
Y2ggPSBlYl9iYXRjaF9pbmRleChlYik7Cj4gPiAgCj4gPiArICAgICBtdXRleF9sb2NrKCZlYi0+
Z2VtX2NvbnRleHQtPm11dGV4KTsKPiA+ICsgICAgIGlmICh1bmxpa2VseShpOTE1X2dlbV9jb250
ZXh0X2lzX2Nsb3NlZChlYi0+Z2VtX2NvbnRleHQpKSkgewo+ID4gKyAgICAgICAgICAgICBlcnIg
PSAtRU5PRU5UOwo+ID4gKyAgICAgICAgICAgICBnb3RvIGVycl9jdHg7Cj4gPiArICAgICB9Cj4g
PiArCj4gPiAgICAgICBmb3IgKGkgPSAwOyBpIDwgZWItPmJ1ZmZlcl9jb3VudDsgaSsrKSB7Cj4g
PiAgICAgICAgICAgICAgIHUzMiBoYW5kbGUgPSBlYi0+ZXhlY1tpXS5oYW5kbGU7Cj4gPiAgICAg
ICAgICAgICAgIHN0cnVjdCBpOTE1X2x1dF9oYW5kbGUgKmx1dDsKPiA+IEBAIC04NDYsMTIgKzg0
OSwxNCBAQCBzdGF0aWMgaW50IGViX2xvb2t1cF92bWFzKHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIg
KmViKQo+ID4gICAgICAgICAgICAgICB9Cj4gPiAgCj4gPiAgICAgICAgICAgICAgIC8qIHRyYW5z
ZmVyIHJlZiB0byBjdHggKi8KCkl0IGlzIHRoaXMgcmVmZXJlbmNlIHRoYXQgd2UgdHJhbnNmZXIg
ZnJvbSB0aGUgb2JqZWN0IGxvb2t1cCBpbnRvIHRoZQpsdXQsIHRoYXQgd2UgbXVzdCByZWxlYXNl
IGlmIHdlIHRocm93YXdheSB0aGUgbHV0LgoKPiA+IC0gICAgICAgICAgICAgaWYgKCF2bWEtPm9w
ZW5fY291bnQrKykKPiA+ICsgICAgICAgICAgICAgaWYgKCFhdG9taWNfZmV0Y2hfaW5jKCZ2bWEt
Pm9wZW5fY291bnQpKQo+ID4gICAgICAgICAgICAgICAgICAgICAgIGk5MTVfdm1hX3Jlb3Blbih2
bWEpOwo+ID4gLSAgICAgICAgICAgICBsaXN0X2FkZCgmbHV0LT5vYmpfbGluaywgJm9iai0+bHV0
X2xpc3QpOwo+ID4gLSAgICAgICAgICAgICBsaXN0X2FkZCgmbHV0LT5jdHhfbGluaywgJmViLT5n
ZW1fY29udGV4dC0+aGFuZGxlc19saXN0KTsKPiA+IC0gICAgICAgICAgICAgbHV0LT5jdHggPSBl
Yi0+Z2VtX2NvbnRleHQ7Cj4gPiAgICAgICAgICAgICAgIGx1dC0+aGFuZGxlID0gaGFuZGxlOwo+
ID4gKyAgICAgICAgICAgICBsdXQtPmN0eCA9IGViLT5nZW1fY29udGV4dDsKPiA+ICsKPiA+ICsg
ICAgICAgICAgICAgaTkxNV9nZW1fb2JqZWN0X2xvY2sob2JqKTsKPiA+ICsgICAgICAgICAgICAg
bGlzdF9hZGQoJmx1dC0+b2JqX2xpbmssICZvYmotPmx1dF9saXN0KTsKPiA+ICsgICAgICAgICAg
ICAgaTkxNV9nZW1fb2JqZWN0X3VubG9jayhvYmopOwoKX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhA
bGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxt
YW4vbGlzdGluZm8vaW50ZWwtZ2Z4

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 41B3AFB0DE
	for <lists+intel-gfx@lfdr.de>; Wed, 13 Nov 2019 13:53:13 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 8699B6ED0E;
	Wed, 13 Nov 2019 12:53:11 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 083676E09A;
 Wed, 13 Nov 2019 12:53:03 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 19187130-1500050 
 for multiple; Wed, 13 Nov 2019 12:52:42 +0000
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Wed, 13 Nov 2019 12:52:33 +0000
Message-Id: <20191113125240.3781-2-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.24.0
In-Reply-To: <20191113125240.3781-1-chris@chris-wilson.co.uk>
References: <20191113125240.3781-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH i-g-t 2/9] i915/gem_exec_schedule: Exercise
 priority inversion from resource contention
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: igt-dev@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

T25lIG9mIHRoZSBoYXJkZXN0IHByaW9yaXR5IGludmVyc2lvbiB0YXNrcyB0byBib3RoIGhhbmRs
ZSBhbmQgdG8Kc2ltdWxhdGUgaW4gdGVzdGluZyBpcyBpbnZlcnNpb24gZHVlIHRvIHJlc291cmNl
IGNvbnRlbnRpb24uIFRoZQpjaGFsbGVuZ2UgaXMgdGhhdCBhIGhpZ2ggcHJpb3JpdHkgY29udGV4
dCBzaG91bGQgbmV2ZXIgYmUgYmxvY2tlZCBieSBhCmxvdyBwcmlvcml0eSBjb250ZXh0LCBldmVu
IGlmIGJvdGggYXJlIHN0YXJ2aW5nIGZvciByZXNvdXJjZXMgLS0KaWRlYWxseSwgYXQgbGVhc3Qg
Zm9yIHNvbWUgUlQgT1NlcywgdGhlIGhpZ2hlciBwcmlvcml0eSBjb250ZXh0IGhhcwpmaXJzdCBw
aWNrIG9mIHRoZSBtZWFncmUgcmVzb3VyY2VzIHNvIHRoYXQgaXQgY2FuIGJlIGV4ZWN1dGVkIHdp
dGgKbWluaW11bSBsYXRlbmN5LgoKdXNlcmZhdWx0ZmQgYWxsb3dzIHVzIHRvIGhhbmRsZSBhIHBh
Z2UgZmF1bHQgaW4gdXNlcnNwYWNlLCBhbmQgc28KYXJiaXRyYXJ5IGltcG9zZSBhIGRlbGF5IG9u
IHRoZSBmYXVsdCBoYW5kbGVyLCBjcmVhdGluZyBhIHNpdHVhdGlvbgp3aGVyZSBhIGxvdyBwcmlv
cml0eSBjb250ZXh0IGlzIGJsb2NrZWQgd2FpdGluZyBmb3IgdGhlIGZhdWx0LiBUaGlzCmJsb2Nr
ZWQgY29udGV4dCBzaG91bGQgbm90IHByZXZlbnQgYSBoaWdoIHByaW9yaXR5IGNvbnRleHQgZnJv
bSBiZWluZwpleGVjdXRlZC4gV2hpbGUgdGhlIHVzZXJmYXVsdCB0cmllcyB0byBlbXVsYXRlIGEg
c2xvdyBmYXVsdCAoZS5nLiBmcm9tIGEKZmFpbGluZyBzd2FwIGRldmljZSksIGl0IGlzIHVuZm9y
dHVuYXRlbHkgbGltaXRlZCB0byBhIHNpbmdsZSBvYmplY3QKdHlwZTogdGhlIHVzZXJwdHIuIEhv
cGVmdWxseSwgd2Ugd2lsbCBmaW5kIG90aGVyIHdheXMgdG8gaW1wb3NlIG90aGVyCnN0YXJ2YXRp
b24gY29uZGl0aW9ucyBvbiBnbG9iYWwgcmVzb3VyY2VzLgoKU2lnbmVkLW9mZi1ieTogQ2hyaXMg
V2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28udWs+CkNjOiBKb29uYXMgTGFodGluZW4gPGpv
b25hcy5sYWh0aW5lbkBsaW51eC5pbnRlbC5jb20+CkNjOiBUdnJ0a28gVXJzdWxpbiA8dHZydGtv
LnVyc3VsaW5AaW50ZWwuY29tPgotLS0KIHRlc3RzL2k5MTUvZ2VtX2V4ZWNfc2NoZWR1bGUuYyB8
IDE1NSArKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysKIDEgZmlsZSBjaGFuZ2VkLCAx
NTUgaW5zZXJ0aW9ucygrKQoKZGlmZiAtLWdpdCBhL3Rlc3RzL2k5MTUvZ2VtX2V4ZWNfc2NoZWR1
bGUuYyBiL3Rlc3RzL2k5MTUvZ2VtX2V4ZWNfc2NoZWR1bGUuYwppbmRleCA4NDU4MWJmZmUuLmQ5
ODQzNDEyMyAxMDA2NDQKLS0tIGEvdGVzdHMvaTkxNS9nZW1fZXhlY19zY2hlZHVsZS5jCisrKyBi
L3Rlc3RzL2k5MTUvZ2VtX2V4ZWNfc2NoZWR1bGUuYwpAQCAtMjMsMTAgKzIzLDE2IEBACiAKICNp
bmNsdWRlICJjb25maWcuaCIKIAorI2luY2x1ZGUgPGxpbnV4L3VzZXJmYXVsdGZkLmg+CisKKyNp
bmNsdWRlIDxwdGhyZWFkLmg+CiAjaW5jbHVkZSA8c3lzL3BvbGwuaD4KICNpbmNsdWRlIDxzeXMv
aW9jdGwuaD4KKyNpbmNsdWRlIDxzeXMvbW1hbi5oPgorI2luY2x1ZGUgPHN5cy9zeXNjYWxsLmg+
CiAjaW5jbHVkZSA8c2NoZWQuaD4KICNpbmNsdWRlIDxzaWduYWwuaD4KKyNpbmNsdWRlIDx1bmlz
dGQuaD4KIAogI2luY2x1ZGUgImlndC5oIgogI2luY2x1ZGUgImlndF9yYW5kLmgiCkBAIC0xNjI1
LDYgKzE2MzEsMTUyIEBAIHN0YXRpYyB2b2lkIHRlc3RfcGlfcmluZ2Z1bGwoaW50IGZkLCB1bnNp
Z25lZCBpbnQgZW5naW5lLCB1bnNpZ25lZCBpbnQgZmxhZ3MpCiAJbXVubWFwKHJlc3VsdCwgNDA5
Nik7CiB9CiAKK3N0YXRpYyBpbnQgdXNlcmZhdWx0ZmQoaW50IGZsYWdzKQoreworCXJldHVybiBz
eXNjYWxsKFNZU191c2VyZmF1bHRmZCwgZmxhZ3MpOworfQorCitzdHJ1Y3QgdWZkX3RocmVhZCB7
CisJdWludDMyX3QgYmF0Y2g7CisJdWludDMyX3QgKnBhZ2U7CisJdW5zaWduZWQgaW50IGVuZ2lu
ZTsKKwlpbnQgaTkxNTsKK307CisKK3N0YXRpYyB1aW50MzJfdCBjcmVhdGVfdXNlcnB0cihpbnQg
aTkxNSwgdm9pZCAqcGFnZSkKK3sKKwl1aW50MzJfdCBoYW5kbGU7CisKKwlnZW1fdXNlcnB0cihp
OTE1LCBwYWdlLCA0MDk2LCAwLCAwLCAmaGFuZGxlKTsKKwlyZXR1cm4gaGFuZGxlOworfQorCitz
dGF0aWMgdm9pZCAqdWZkX3RocmVhZCh2b2lkICphcmcpCit7CisJc3RydWN0IHVmZF90aHJlYWQg
KnQgPSBhcmc7CisJc3RydWN0IGRybV9pOTE1X2dlbV9leGVjX29iamVjdDIgb2JqWzJdID0gewor
CQl7IC5oYW5kbGUgPSBjcmVhdGVfdXNlcnB0cih0LT5pOTE1LCB0LT5wYWdlKSB9LAorCQl7IC5o
YW5kbGUgPSB0LT5iYXRjaCB9LAorCX07CisJc3RydWN0IGRybV9pOTE1X2dlbV9leGVjYnVmZmVy
MiBlYiA9IHsKKwkJLmJ1ZmZlcnNfcHRyID0gdG9fdXNlcl9wb2ludGVyKG9iaiksCisJCS5idWZm
ZXJfY291bnQgPSBBUlJBWV9TSVpFKG9iaiksCisJCS5mbGFncyA9IHQtPmVuZ2luZSwKKwkJLnJz
dmQxID0gZ2VtX2NvbnRleHRfY3JlYXRlKHQtPmk5MTUpLAorCX07CisJZ2VtX2NvbnRleHRfc2V0
X3ByaW9yaXR5KHQtPmk5MTUsIGViLnJzdmQxLCBNSU5fUFJJTyk7CisKKwlpZ3RfZGVidWcoInN1
Ym1pdHRpbmcgZmF1bHRcbiIpOworCWdlbV9leGVjYnVmKHQtPmk5MTUsICZlYik7CisJZ2VtX3N5
bmModC0+aTkxNSwgb2JqWzBdLmhhbmRsZSk7CisJZ2VtX2Nsb3NlKHQtPmk5MTUsIG9ialswXS5o
YW5kbGUpOworCisJZ2VtX2NvbnRleHRfZGVzdHJveSh0LT5pOTE1LCBlYi5yc3ZkMSk7CisKKwl0
LT5pOTE1ID0gLTE7CisJcmV0dXJuIE5VTEw7Cit9CisKK3N0YXRpYyB2b2lkIHRlc3RfcGlfdXNl
cmZhdWx0KGludCBpOTE1LCB1bnNpZ25lZCBpbnQgZW5naW5lKQoreworCXN0cnVjdCB1ZmZkaW9f
YXBpIGFwaSA9IHsgLmFwaSA9IFVGRkRfQVBJIH07CisJc3RydWN0IHVmZmRpb19yZWdpc3RlciBy
ZWc7CisJc3RydWN0IHVmZmRpb19jb3B5IGNvcHk7CisJc3RydWN0IHVmZmRfbXNnIG1zZzsKKwlz
dHJ1Y3QgdWZkX3RocmVhZCB0OworCXB0aHJlYWRfdCB0aHJlYWQ7CisJY2hhciBwb2lzb25bNDA5
Nl07CisJaW50IHVmZDsKKworCS8qCisJICogUmVzb3VyY2UgY29udGVudGlvbiBjYW4gZWFzaWx5
IGxlYWQgdG8gcHJpb3JpdHkgaW52ZXJzaW9uIHByb2JsZW1zLAorCSAqIHRoYXQgd2Ugd2lzaCB0
byBhdm9pZC4gSGVyZSwgd2Ugc2ltdWxhdGUgb25lIHNpbXBsZSBmb3JtIG9mIHJlc291cmNlCisJ
ICogc3RhcnZhdGlvbiBieSB1c2luZyBhbiBhcmJpdHJhcnkgc2xvdyB1c2Vyc3BhY2UgZmF1bHQg
aGFuZGxlciB0byBjYXVzZQorCSAqIHRoZSBsb3cgcHJpb3JpdHkgY29udGV4dCB0byBibG9jayB3
YWl0aW5nIGZvciBpdHMgcmVzb3VyY2UuIFdoaWxlIGl0CisJICogaXMgYmxvY2tlZCwgaXQgc2hv
dWxkIG5vdCBwcmV2ZW50IGEgaGlnaGVyIHByaW9yaXR5IGNvbnRleHQgZnJvbQorCSAqIGV4ZWN1
dGluZy4KKwkgKgorCSAqIFRoaXMgaXMgb25seSBhIHZlcnkgc2ltcGxlIHNjZW5hcmlvLCBpbiBt
b3JlIGdlbmVyYWwgdGVzdHMgd2Ugd2lsbAorCSAqIG5lZWQgdG8gc2ltdWxhdGUgY29udGVudGlv
biBvbiB0aGUgc2hhcmVkIHJlc291cmNlIHN1Y2ggdGhhdCBib3RoCisJICogbG93IGFuZCBoaWdo
IHByaW9yaXR5IGNvbnRleHRzIGFyZSBzdGFydmluZyBhbmQgbXVzdCBmaWdodCBvdmVyCisJICog
dGhlIG1lYWdyZSByZXNvdXJjZXMuIE9uZSBzdGVwIGF0IGEgdGltZS4KKwkgKi8KKworCXVmZCA9
IHVzZXJmYXVsdGZkKDApOworCWlndF9yZXF1aXJlX2YodWZkICE9IC0xLCAia2VybmVsIHN1cHBv
cnQgZm9yIHVzZXJmYXVsdGZkXG4iKTsKKwlpZ3RfcmVxdWlyZV9mKGlvY3RsKHVmZCwgVUZGRElP
X0FQSSwgJmFwaSkgPT0gMCAmJiBhcGkuYXBpID09IFVGRkRfQVBJLAorCQkgICAgICAidXNlcmZh
dWx0ZmQgQVBJIHYlbGxkOiVsbGRcbiIsIFVGRkRfQVBJLCBhcGkuYXBpKTsKKworCXQuaTkxNSA9
IGk5MTU7CisJdC5lbmdpbmUgPSBlbmdpbmU7CisKKwl0LnBhZ2UgPSBtbWFwKE5VTEwsIDQwOTYs
IFBST1RfV1JJVEUsIE1BUF9TSEFSRUQgfCBNQVBfQU5PTiwgMCwgMCk7CisJaWd0X2Fzc2VydCh0
LnBhZ2UgIT0gTUFQX0ZBSUxFRCk7CisKKwl0LmJhdGNoID0gZ2VtX2NyZWF0ZShpOTE1LCA0MDk2
KTsKKwltZW1zZXQocG9pc29uLCAweGZmLCBzaXplb2YocG9pc29uKSk7CisJZ2VtX3dyaXRlKGk5
MTUsIHQuYmF0Y2gsIDAsIHBvaXNvbiwgNDA5Nik7CisKKwkvKiBSZWdpc3RlciBvdXIgZmF1bHQg
aGFuZGxlciBmb3IgdC5wYWdlICovCisJbWVtc2V0KCZyZWcsIDAsIHNpemVvZihyZWcpKTsKKwly
ZWcubW9kZSA9IFVGRkRJT19SRUdJU1RFUl9NT0RFX01JU1NJTkc7CisJcmVnLnJhbmdlLnN0YXJ0
ID0gdG9fdXNlcl9wb2ludGVyKHQucGFnZSk7CisJcmVnLnJhbmdlLmxlbiA9IDQwOTY7CisJZG9f
aW9jdGwodWZkLCBVRkZESU9fUkVHSVNURVIsICZyZWcpOworCWlndF9hc3NlcnQocmVnLmlvY3Rs
cyA9PSBVRkZEX0FQSV9SQU5HRV9JT0NUTFMpOworCisJLyogS2ljayBvZmYgdGhlIGxvdyBwcmlv
cml0eSBzdWJtaXNzaW9uICovCisJaWd0X2Fzc2VydChwdGhyZWFkX2NyZWF0ZSgmdGhyZWFkLCBO
VUxMLCB1ZmRfdGhyZWFkLCAmdCkgPT0gMCk7CisKKwkvKiBXYWl0IHVudGlsIHRoZSBsb3cgcHJp
b3JpdHkgdGhyZWFkIGlzIGJsb2NrZWQgb24gYSBmYXVsdCAqLworCWlndF9hc3NlcnRfZXEocmVh
ZCh1ZmQsICZtc2csIHNpemVvZihtc2cpKSwgc2l6ZW9mKG1zZykpOworCWlndF9hc3NlcnRfZXEo
bXNnLmV2ZW50LCBVRkZEX0VWRU5UX1BBR0VGQVVMVCk7CisJaWd0X2Fzc2VydChmcm9tX3VzZXJf
cG9pbnRlcihtc2cuYXJnLnBhZ2VmYXVsdC5hZGRyZXNzKSA9PSB0LnBhZ2UpOworCisJLyogV2hp
bGUgdGhlIGxvdyBwcmlvcml0eSBjb250ZXh0IGlzIGJsb2NrZWQ7IGV4ZWN1dGUgYSB2aXAgKi8K
KwlpZiAoMSkgeworCQljb25zdCB1aW50MzJfdCBiYmUgPSBNSV9CQVRDSF9CVUZGRVJfRU5EOwor
CQlzdHJ1Y3QgZHJtX2k5MTVfZ2VtX2V4ZWNfb2JqZWN0MiBvYmogPSB7CisJCQkuaGFuZGxlID0g
dC5iYXRjaCwKKwkJfTsKKwkJc3RydWN0IHBvbGxmZCBwZmQ7CisJCXN0cnVjdCBkcm1faTkxNV9n
ZW1fZXhlY2J1ZmZlcjIgZWIgPSB7CisJCQkuYnVmZmVyc19wdHIgPSB0b191c2VyX3BvaW50ZXIo
Jm9iaiksCisJCQkuYnVmZmVyX2NvdW50ID0gMSwKKwkJCS5mbGFncyA9IGVuZ2luZSB8IEk5MTVf
RVhFQ19GRU5DRV9PVVQsCisJCQkucnN2ZDEgPSBnZW1fY29udGV4dF9jcmVhdGUoaTkxNSksCisJ
CX07CisJCWdlbV9jb250ZXh0X3NldF9wcmlvcml0eShpOTE1LCBlYi5yc3ZkMSwgTUFYX1BSSU8p
OworCQlnZW1fd3JpdGUoaTkxNSwgb2JqLmhhbmRsZSwgMCwgJmJiZSwgc2l6ZW9mKGJiZSkpOwor
CQlnZW1fZXhlY2J1Zl93cihpOTE1LCAmZWIpOworCisJCW1lbXNldCgmcGZkLCAwLCBzaXplb2Yo
cGZkKSk7CisJCXBmZC5mZCA9IGViLnJzdmQyID4+IDMyOworCQlwZmQuZXZlbnRzID0gUE9MTElO
OworCQlwb2xsKCZwZmQsIDEsIC0xKTsKKwkJaWd0X2Fzc2VydF9lcShzeW5jX2ZlbmNlX3N0YXR1
cyhwZmQuZmQpLCAxKTsKKwkJY2xvc2UocGZkLmZkKTsKKworCQlnZW1fY29udGV4dF9kZXN0cm95
KGk5MTUsIGViLnJzdmQxKTsKKwl9CisKKwkvKiBDb25maXJtIHRoZSBsb3cgcHJpb3JpdHkgY29u
dGV4dCBpcyBzdGlsbCB3YWl0aW5nICovCisJaWd0X2Fzc2VydF9lcSh0Lmk5MTUsIGk5MTUpOwor
CisJLyogU2VydmljZSB0aGUgZmF1bHQ7IHJlbGVhc2luZyB0aGUgbG93IHByaW9yaXR5IGNvbnRl
eHQgKi8KKwltZW1zZXQoJmNvcHksIDAsIHNpemVvZihjb3B5KSk7CisJY29weS5kc3QgPSBtc2cu
YXJnLnBhZ2VmYXVsdC5hZGRyZXNzOworCWNvcHkuc3JjID0gdG9fdXNlcl9wb2ludGVyKG1lbXNl
dChwb2lzb24sIDB4YzUsIHNpemVvZihwb2lzb24pKSk7CisJY29weS5sZW4gPSA0MDk2OworCWRv
X2lvY3RsKHVmZCwgVUZGRElPX0NPUFksICZjb3B5KTsKKworCXB0aHJlYWRfam9pbih0aHJlYWQs
IE5VTEwpOworCisJZ2VtX2Nsb3NlKGk5MTUsIHQuYmF0Y2gpOworCW11bm1hcCh0LnBhZ2UsIDQw
OTYpOworCWNsb3NlKHVmZCk7Cit9CisKIHN0YXRpYyB2b2lkIG1lYXN1cmVfc2VtYXBob3JlX3Bv
d2VyKGludCBpOTE1KQogewogCXN0cnVjdCByYXBsIGdwdSwgcGtnOwpAQCAtMTg2NCw2ICsyMDE2
LDkgQEAgaWd0X21haW4KIAogCQkJCWlndF9zdWJ0ZXN0X2YoInBpLWNvbW1vbi0lcyIsIGUtPm5h
bWUpCiAJCQkJCXRlc3RfcGlfcmluZ2Z1bGwoZmQsIGViX3JpbmcoZSksIFNIQVJFRCk7CisKKwkJ
CQlpZ3Rfc3VidGVzdF9mKCJwaS11c2VyZmF1bHQtJXMiLCBlLT5uYW1lKQorCQkJCQl0ZXN0X3Bp
X3VzZXJmYXVsdChmZCwgZWJfcmluZyhlKSk7CiAJCQl9CiAJCX0KIAl9Ci0tIAoyLjI0LjAKCl9f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCkludGVsLWdmeCBt
YWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3Rz
LmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWdmeA==

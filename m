Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 3C151B6679
	for <lists+intel-gfx@lfdr.de>; Wed, 18 Sep 2019 16:55:20 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id ED0A56F3C9;
	Wed, 18 Sep 2019 14:55:15 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 2FD5C6F3BF
 for <intel-gfx@lists.freedesktop.org>; Wed, 18 Sep 2019 14:55:14 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18533832-1500050 
 for multiple; Wed, 18 Sep 2019 15:54:54 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Wed, 18 Sep 2019 15:54:52 +0100
Message-Id: <20190918145453.8800-3-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20190918145453.8800-1-chris@chris-wilson.co.uk>
References: <20190918145453.8800-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 3/4] drm/i915: Lock signaler timeline while
 navigating
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

QXMgd2UgbmVlZCB0byB0YWtlIGEgd2FsayBiYWNrIGFsb25nIHRoZSBzaWduYWxlciB0aW1lbGlu
ZSB0byBmaW5kIHRoZQpmZW5jZSBiZWZvcmUgdXBvbiB3aGljaCB3ZSB3YW50IHRvIHdhaXQsIHdl
IG5lZWQgdG8gbG9jayB0aGF0IHRpbWVsaW5lCnRvIHByZXZlbnQgaXQgYmVpbmcgbW9kaWZpZWQg
YXMgd2Ugd2Fsay4gU2ltaWxhcmx5LCB3ZSBhbHNvIG5lZWQgdG8KYWNxdWlyZSBhIHJlZmVyZW5j
ZSB0byB0aGUgZWFybGllciBmZW5jZSB3aGlsZSBpdCBzdGlsbCBleGlzdHMhCgpUaG91Z2ggd2Ug
bGFjayB0aGUgY29ycmVjdCBsb2NraW5nIHRvZGF5LCB3ZSBhcmUgc2F2ZWQgYnkgdGhlCm92ZXJh
cmNoaW5nIHN0cnVjdF9tdXRleCAtLSBidXQgdGhhdCBwcm90ZWN0aW9uIGlzIGJlaW5nIHJlbW92
ZWQuCgp2MjogVHZydGtvIG1hZGUgbWUgcmVhbGlzZSBJIHdhcyBiZWluZyBsYXggYW5kIHVzaW5n
IGFubm90YXRpb25zIHRvCmlnbm9yZSB0aGUgQUItQkEgZGVhZGxvY2sgZnJvbSB0aGUgdGltZWxp
bmUgb3ZlcmxhcC4gQXMgaXQgd291bGQgYmUKcG9zc2libGUgdG8gY29uc3RydWN0IGEgc2Vjb25k
IHJlcXVlc3QgdGhhdCB3YXMgdXNpbmcgYSBzZW1hcGhvcmUgZnJvbSB0aGUKc2FtZSB0aW1lbGlu
ZSBhcyBvdXJzZWx2ZXMsIHdlIGNvdWxkIHF1aXRlIGVhc2lseSBlbmQgdXAgaW4gYSBzaXR1YXRp
b24Kd2hlcmUgd2UgZGVhZGxvY2tlZCBpbiBvdXIgbXV0ZXggd2FpdHMuIEF2b2lkIHRoYXQgYnkg
dXNpbmcgYSB0cnlsb2NrCmFuZCBmYWxsaW5nIGJhY2sgdG8gYSBub3JtYWwgZG1hLWZlbmNlIGF3
YWl0IGlmIGNvbnRlbmRlZC4KCnYzOiBFZWssIHRoZSBzaWduYWwtPnRpbWVsaW5lIGlzIHZvbGF0
aWxlIGFuZCBtdXN0IGJlIGNhcmVmdWxseQpkZXJlZmVyZW5jZWQgdG8gZW5zdXJlIGl0IGlzIHZh
bGlkLgoKU2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28u
dWs+CkNjOiBUdnJ0a28gVXJzdWxpbiA8dHZydGtvLnVyc3VsaW5AbGludXguaW50ZWwuY29tPgpS
ZXZpZXdlZC1ieTogVHZydGtvIFVyc3VsaW4gPHR2cnRrby51cnN1bGluQGxpbnV4LmludGVsLmNv
bT4gI3YyCi0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9yZXF1ZXN0LmMgfCA2OCArKysr
KysrKysrKysrKysrKysrLS0tLS0tLS0tLQogMSBmaWxlIGNoYW5nZWQsIDQ2IGluc2VydGlvbnMo
KyksIDIyIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5
MTVfcmVxdWVzdC5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9yZXF1ZXN0LmMKaW5kZXgg
ZmI2ZjIxYzQxOTM0Li45YmQ4NTM4YjE5MDcgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2k5MTVfcmVxdWVzdC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcmVxdWVz
dC5jCkBAIC03NjgsMTcgKzc2OCw0MyBAQCBpOTE1X3JlcXVlc3RfY3JlYXRlKHN0cnVjdCBpbnRl
bF9jb250ZXh0ICpjZSkKIHN0YXRpYyBpbnQKIGk5MTVfcmVxdWVzdF9hd2FpdF9zdGFydChzdHJ1
Y3QgaTkxNV9yZXF1ZXN0ICpycSwgc3RydWN0IGk5MTVfcmVxdWVzdCAqc2lnbmFsKQogewotCWlm
IChsaXN0X2lzX2ZpcnN0KCZzaWduYWwtPmxpbmssICZzaWduYWwtPnRpbWVsaW5lLT5yZXF1ZXN0
cykpCi0JCXJldHVybiAwOworCXN0cnVjdCBpbnRlbF90aW1lbGluZSAqdGw7CisJc3RydWN0IGRt
YV9mZW5jZSAqZmVuY2U7CisJaW50IGVycjsKKworCUdFTV9CVUdfT04oaTkxNV9yZXF1ZXN0X3Rp
bWVsaW5lKHJxKSA9PQorCQkgICByY3VfYWNjZXNzX3BvaW50ZXIoc2lnbmFsLT50aW1lbGluZSkp
OwogCi0Jc2lnbmFsID0gbGlzdF9wcmV2X2VudHJ5KHNpZ25hbCwgbGluayk7Ci0JaWYgKGludGVs
X3RpbWVsaW5lX3N5bmNfaXNfbGF0ZXIoaTkxNV9yZXF1ZXN0X3RpbWVsaW5lKHJxKSwKLQkJCQkJ
ICZzaWduYWwtPmZlbmNlKSkKKwlyY3VfcmVhZF9sb2NrKCk7CisJdGwgPSByY3VfZGVyZWZlcmVu
Y2Uoc2lnbmFsLT50aW1lbGluZSk7CisJaWYgKGk5MTVfcmVxdWVzdF9zdGFydGVkKHNpZ25hbCkg
fHwgIWtyZWZfZ2V0X3VubGVzc196ZXJvKCZ0bC0+a3JlZikpCisJCXRsID0gTlVMTDsKKwlyY3Vf
cmVhZF91bmxvY2soKTsKKwlpZiAoIXRsKSAvKiBhbHJlYWR5IHN0YXJ0ZWQgb3IgbWF5YmUgZXZl
biBjb21wbGV0ZWQgKi8KIAkJcmV0dXJuIDA7CiAKLQlyZXR1cm4gaTkxNV9zd19mZW5jZV9hd2Fp
dF9kbWFfZmVuY2UoJnJxLT5zdWJtaXQsCi0JCQkJCSAgICAgJnNpZ25hbC0+ZmVuY2UsIDAsCi0J
CQkJCSAgICAgSTkxNV9GRU5DRV9HRlApOworCWZlbmNlID0gRVJSX1BUUigtRUJVU1kpOworCWlm
IChtdXRleF90cnlsb2NrKCZ0bC0+bXV0ZXgpKSB7CisJCWZlbmNlID0gTlVMTDsKKwkJaWYgKCFp
OTE1X3JlcXVlc3Rfc3RhcnRlZChzaWduYWwpICYmCisJCSAgICAhbGlzdF9pc19maXJzdCgmc2ln
bmFsLT5saW5rLCAmdGwtPnJlcXVlc3RzKSkgeworCQkJc2lnbmFsID0gbGlzdF9wcmV2X2VudHJ5
KHNpZ25hbCwgbGluayk7CisJCQlmZW5jZSA9IGRtYV9mZW5jZV9nZXQoJnNpZ25hbC0+ZmVuY2Up
OworCQl9CisJCW11dGV4X3VubG9jaygmdGwtPm11dGV4KTsKKwl9CisJaW50ZWxfdGltZWxpbmVf
cHV0KHRsKTsKKwlpZiAoSVNfRVJSX09SX05VTEwoZmVuY2UpKQorCQlyZXR1cm4gUFRSX0VSUl9P
Ul9aRVJPKGZlbmNlKTsKKworCWVyciA9IDA7CisJaWYgKGludGVsX3RpbWVsaW5lX3N5bmNfaXNf
bGF0ZXIoaTkxNV9yZXF1ZXN0X3RpbWVsaW5lKHJxKSwgZmVuY2UpKQorCQllcnIgPSBpOTE1X3N3
X2ZlbmNlX2F3YWl0X2RtYV9mZW5jZSgmcnEtPnN1Ym1pdCwKKwkJCQkJCSAgICBmZW5jZSwgMCwK
KwkJCQkJCSAgICBJOTE1X0ZFTkNFX0dGUCk7CisJZG1hX2ZlbmNlX3B1dChmZW5jZSk7CisKKwly
ZXR1cm4gZXJyOwogfQogCiBzdGF0aWMgaW50ZWxfZW5naW5lX21hc2tfdApAQCAtODA4LDMwICs4
MzQsMjMgQEAgZW1pdF9zZW1hcGhvcmVfd2FpdChzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICp0bywKIAl1
MzIgaHdzcF9vZmZzZXQ7CiAJaW50IGxlbjsKIAl1MzIgKmNzOwotCWludCBlcnI7CiAKLQlHRU1f
QlVHX09OKCFmcm9tLT50aW1lbGluZS0+aGFzX2luaXRpYWxfYnJlYWRjcnVtYik7CiAJR0VNX0JV
R19PTihJTlRFTF9HRU4odG8tPmk5MTUpIDwgOCk7CiAKIAkvKiBKdXN0IGVtaXQgdGhlIGZpcnN0
IHNlbWFwaG9yZSB3ZSBzZWUgYXMgcmVxdWVzdCBzcGFjZSBpcyBsaW1pdGVkLiAqLwogCWlmIChh
bHJlYWR5X2J1c3l3YWl0aW5nKHRvKSAmIGZyb20tPmVuZ2luZS0+bWFzaykKLQkJcmV0dXJuIGk5
MTVfc3dfZmVuY2VfYXdhaXRfZG1hX2ZlbmNlKCZ0by0+c3VibWl0LAotCQkJCQkJICAgICAmZnJv
bS0+ZmVuY2UsIDAsCi0JCQkJCQkgICAgIEk5MTVfRkVOQ0VfR0ZQKTsKKwkJZ290byBhd2FpdF9m
ZW5jZTsKIAotCWVyciA9IGk5MTVfcmVxdWVzdF9hd2FpdF9zdGFydCh0bywgZnJvbSk7Ci0JaWYg
KGVyciA8IDApCi0JCXJldHVybiBlcnI7CisJaWYgKGk5MTVfcmVxdWVzdF9hd2FpdF9zdGFydCh0
bywgZnJvbSkgPCAwKQorCQlnb3RvIGF3YWl0X2ZlbmNlOwogCiAJLyogT25seSBzdWJtaXQgb3Vy
IHNwaW5uZXIgYWZ0ZXIgdGhlIHNpZ25hbGVyIGlzIHJ1bm5pbmchICovCi0JZXJyID0gX19pOTE1
X3JlcXVlc3RfYXdhaXRfZXhlY3V0aW9uKHRvLCBmcm9tLCBOVUxMLCBnZnApOwotCWlmIChlcnIp
Ci0JCXJldHVybiBlcnI7CisJaWYgKF9faTkxNV9yZXF1ZXN0X2F3YWl0X2V4ZWN1dGlvbih0bywg
ZnJvbSwgTlVMTCwgZ2ZwKSkKKwkJZ290byBhd2FpdF9mZW5jZTsKIAogCS8qIFdlIG5lZWQgdG8g
cGluIHRoZSBzaWduYWxlcidzIEhXU1AgdW50aWwgd2UgYXJlIGZpbmlzaGVkIHJlYWRpbmcuICov
Ci0JZXJyID0gaW50ZWxfdGltZWxpbmVfcmVhZF9od3NwKGZyb20sIHRvLCAmaHdzcF9vZmZzZXQp
OwotCWlmIChlcnIpCi0JCXJldHVybiBlcnI7CisJaWYgKGludGVsX3RpbWVsaW5lX3JlYWRfaHdz
cChmcm9tLCB0bywgJmh3c3Bfb2Zmc2V0KSkKKwkJZ290byBhd2FpdF9mZW5jZTsKIAogCWxlbiA9
IDQ7CiAJaWYgKGhhc190b2tlbikKQEAgLTg2Niw2ICs4ODUsMTEgQEAgZW1pdF9zZW1hcGhvcmVf
d2FpdChzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICp0bywKIAl0by0+c2NoZWQuc2VtYXBob3JlcyB8PSBm
cm9tLT5lbmdpbmUtPm1hc2s7CiAJdG8tPnNjaGVkLmZsYWdzIHw9IEk5MTVfU0NIRURfSEFTX1NF
TUFQSE9SRV9DSEFJTjsKIAlyZXR1cm4gMDsKKworYXdhaXRfZmVuY2U6CisJcmV0dXJuIGk5MTVf
c3dfZmVuY2VfYXdhaXRfZG1hX2ZlbmNlKCZ0by0+c3VibWl0LAorCQkJCQkgICAgICZmcm9tLT5m
ZW5jZSwgMCwKKwkJCQkJICAgICBJOTE1X0ZFTkNFX0dGUCk7CiB9CiAKIHN0YXRpYyBpbnQKLS0g
CjIuMjMuMAoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18K
SW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0
dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

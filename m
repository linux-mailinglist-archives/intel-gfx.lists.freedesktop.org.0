Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 3C14D86094
	for <lists+intel-gfx@lfdr.de>; Thu,  8 Aug 2019 13:06:29 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id B07CE6E482;
	Thu,  8 Aug 2019 11:06:27 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id B005B6E824
 for <intel-gfx@lists.freedesktop.org>; Thu,  8 Aug 2019 11:06:26 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17929167-1500050 
 for multiple; Thu, 08 Aug 2019 12:06:14 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Thu,  8 Aug 2019 12:06:11 +0100
Message-Id: <20190808110612.23539-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0.rc1
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 1/2] drm/i915: Allocate kernel_contexts directly
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SWdub3JlIHRoZSBjZW50cmFsIGk5MTUtPmtlcm5lbF9jb250ZXh0IGZvciBhbGxvY2F0aW5nIGFu
IGVuZ2luZSwgYXMKdGhhdCBHRU0gY29udGV4dCBpcyBiZWluZyBwaGFzZWQgb3V0LiBGb3IgaW50
ZXJuYWwgY2xpZW50cywgd2UganVzdCBuZWVkCnRoZSBwZXItZW5naW5lIGxvZ2ljYWwgc3RhdGUs
IHNvIGFsbG9jYXRlIGl0IGF0IHRoZSBwb2ludCBvZiB1c2UuCgpTaWduZWQtb2ZmLWJ5OiBDaHJp
cyBXaWxzb24gPGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KLS0tCiBkcml2ZXJzL2dwdS9kcm0v
aTkxNS9NYWtlZmlsZSAgICAgICAgICAgICB8ICAyIC0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0
L2ludGVsX2VuZ2luZV9jcy5jIHwgNTggKysrKysrKystLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0v
aTkxNS9ndC9tb2NrX2VuZ2luZS5jICAgICB8IDE1ICsrLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1
L2d2dC9zY2hlZHVsZXIuYyAgICAgIHwgIDMgKy0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVf
Z2VtLmMgICAgICAgICAgIHwgODcgKysrKysrKysrKysrKystLS0tLS0tLS0KIDUgZmlsZXMgY2hh
bmdlZCwgOTAgaW5zZXJ0aW9ucygrKSwgNzUgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJp
dmVycy9ncHUvZHJtL2k5MTUvTWFrZWZpbGUgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9NYWtlZmls
ZQppbmRleCBhYjdmYWVlZTg4ZDcuLjMyOWM5NDU0NDE0NyAxMDA2NDQKLS0tIGEvZHJpdmVycy9n
cHUvZHJtL2k5MTUvTWFrZWZpbGUKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvTWFrZWZpbGUK
QEAgLTk0LDggKzk0LDYgQEAgZ3QteSArPSBcCiAJZ3QvZ2VuN19yZW5kZXJzdGF0ZS5vIFwKIAln
dC9nZW44X3JlbmRlcnN0YXRlLm8gXAogCWd0L2dlbjlfcmVuZGVyc3RhdGUubwotZ3QtJChDT05G
SUdfRFJNX0k5MTVfU0VMRlRFU1QpICs9IFwKLQlndC9tb2NrX2VuZ2luZS5vCiBpOTE1LXkgKz0g
JChndC15KQogCiAjIEdFTSAoR3JhcGhpY3MgRXhlY3V0aW9uIE1hbmFnZW1lbnQpIGNvZGUKZGlm
ZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZV9jcy5jIGIvZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZW5naW5lX2NzLmMKaW5kZXggODYyNDdlZWI2ZjJi
Li44ZDQ0ZDBkOGE3NTggMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVs
X2VuZ2luZV9jcy5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZV9j
cy5jCkBAIC03MDcsMjYgKzcwNyw2IEBAIHN0YXRpYyBpbnQgbWVhc3VyZV9icmVhZGNydW1iX2R3
KHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKIAlyZXR1cm4gZHc7CiB9CiAKLXN0YXRp
YyBpbnQgcGluX2NvbnRleHQoc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCwKLQkJICAgICAg
IHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSwKLQkJICAgICAgIHN0cnVjdCBpbnRlbF9j
b250ZXh0ICoqb3V0KQotewotCXN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZTsKLQlpbnQgZXJyOwot
Ci0JY2UgPSBpOTE1X2dlbV9jb250ZXh0X2dldF9lbmdpbmUoY3R4LCBlbmdpbmUtPmlkKTsKLQlp
ZiAoSVNfRVJSKGNlKSkKLQkJcmV0dXJuIFBUUl9FUlIoY2UpOwotCi0JZXJyID0gaW50ZWxfY29u
dGV4dF9waW4oY2UpOwotCWludGVsX2NvbnRleHRfcHV0KGNlKTsKLQlpZiAoZXJyKQotCQlyZXR1
cm4gZXJyOwotCi0JKm91dCA9IGNlOwotCXJldHVybiAwOwotfQotCiB2b2lkCiBpbnRlbF9lbmdp
bmVfaW5pdF9hY3RpdmUoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lLCB1bnNpZ25lZCBp
bnQgc3ViY2xhc3MpCiB7CkBAIC03NDgsNiArNzI4LDI1IEBAIGludGVsX2VuZ2luZV9pbml0X2Fj
dGl2ZShzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUsIHVuc2lnbmVkIGludCBzdWJjbGFz
cykKICNlbmRpZgogfQogCitzdGF0aWMgc3RydWN0IGludGVsX2NvbnRleHQgKgorY3JlYXRlX2tl
cm5lbF9jb250ZXh0KHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKK3sKKwlzdHJ1Y3Qg
aW50ZWxfY29udGV4dCAqY2U7CisJaW50IGVycjsKKworCWNlID0gaW50ZWxfY29udGV4dF9jcmVh
dGUoZW5naW5lLT5pOTE1LT5rZXJuZWxfY29udGV4dCwgZW5naW5lKTsKKwlpZiAoSVNfRVJSKGNl
KSkKKwkJcmV0dXJuIGNlOworCisJZXJyID0gaW50ZWxfY29udGV4dF9waW4oY2UpOworCWlmIChl
cnIpIHsKKwkJaW50ZWxfY29udGV4dF9wdXQoY2UpOworCQlyZXR1cm4gRVJSX1BUUihlcnIpOwor
CX0KKworCXJldHVybiBjZTsKK30KKwogLyoqCiAgKiBpbnRlbF9lbmdpbmVzX2luaXRfY29tbW9u
IC0gaW5pdGlhbGl6ZSBjZW5naW5lIHN0YXRlIHdoaWNoIG1pZ2h0IHJlcXVpcmUgaHcgYWNjZXNz
CiAgKiBAZW5naW5lOiBFbmdpbmUgdG8gaW5pdGlhbGl6ZS4KQEAgLTc2MSwyMiArNzYwLDI0IEBA
IGludGVsX2VuZ2luZV9pbml0X2FjdGl2ZShzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUs
IHVuc2lnbmVkIGludCBzdWJjbGFzcykKICAqLwogaW50IGludGVsX2VuZ2luZV9pbml0X2NvbW1v
bihzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUpCiB7Ci0Jc3RydWN0IGRybV9pOTE1X3By
aXZhdGUgKmk5MTUgPSBlbmdpbmUtPmk5MTU7CisJc3RydWN0IGludGVsX2NvbnRleHQgKmNlOwog
CWludCByZXQ7CiAKIAllbmdpbmUtPnNldF9kZWZhdWx0X3N1Ym1pc3Npb24oZW5naW5lKTsKIAot
CS8qIFdlIG1heSBuZWVkIHRvIGRvIHRoaW5ncyB3aXRoIHRoZSBzaHJpbmtlciB3aGljaAorCS8q
CisJICogV2UgbWF5IG5lZWQgdG8gZG8gdGhpbmdzIHdpdGggdGhlIHNocmlua2VyIHdoaWNoCiAJ
ICogcmVxdWlyZSB1cyB0byBpbW1lZGlhdGVseSBzd2l0Y2ggYmFjayB0byB0aGUgZGVmYXVsdAog
CSAqIGNvbnRleHQuIFRoaXMgY2FuIGNhdXNlIGEgcHJvYmxlbSBhcyBwaW5uaW5nIHRoZQogCSAq
IGRlZmF1bHQgY29udGV4dCBhbHNvIHJlcXVpcmVzIEdUVCBzcGFjZSB3aGljaCBtYXkgbm90CiAJ
ICogYmUgYXZhaWxhYmxlLiBUbyBhdm9pZCB0aGlzIHdlIGFsd2F5cyBwaW4gdGhlIGRlZmF1bHQK
IAkgKiBjb250ZXh0LgogCSAqLwotCXJldCA9IHBpbl9jb250ZXh0KGk5MTUtPmtlcm5lbF9jb250
ZXh0LCBlbmdpbmUsCi0JCQkgICZlbmdpbmUtPmtlcm5lbF9jb250ZXh0KTsKLQlpZiAocmV0KQot
CQlyZXR1cm4gcmV0OworCWNlID0gY3JlYXRlX2tlcm5lbF9jb250ZXh0KGVuZ2luZSk7CisJaWYg
KElTX0VSUihjZSkpCisJCXJldHVybiBQVFJfRVJSKGNlKTsKKworCWVuZ2luZS0+a2VybmVsX2Nv
bnRleHQgPSBjZTsKIAogCXJldCA9IG1lYXN1cmVfYnJlYWRjcnVtYl9kdyhlbmdpbmUpOwogCWlm
IChyZXQgPCAwKQpAQCAtNzg3LDcgKzc4OCw4IEBAIGludCBpbnRlbF9lbmdpbmVfaW5pdF9jb21t
b24oc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lKQogCXJldHVybiAwOwogCiBlcnJfdW5w
aW46Ci0JaW50ZWxfY29udGV4dF91bnBpbihlbmdpbmUtPmtlcm5lbF9jb250ZXh0KTsKKwlpbnRl
bF9jb250ZXh0X3VucGluKGNlKTsKKwlpbnRlbF9jb250ZXh0X3B1dChjZSk7CiAJcmV0dXJuIHJl
dDsKIH0KIApAQCAtODEyLDYgKzgxNCw3IEBAIHZvaWQgaW50ZWxfZW5naW5lX2NsZWFudXBfY29t
bW9uKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKIAkJaTkxNV9nZW1fb2JqZWN0X3B1
dChlbmdpbmUtPmRlZmF1bHRfc3RhdGUpOwogCiAJaW50ZWxfY29udGV4dF91bnBpbihlbmdpbmUt
Pmtlcm5lbF9jb250ZXh0KTsKKwlpbnRlbF9jb250ZXh0X3B1dChlbmdpbmUtPmtlcm5lbF9jb250
ZXh0KTsKIAlHRU1fQlVHX09OKCFsbGlzdF9lbXB0eSgmZW5naW5lLT5iYXJyaWVyX3Rhc2tzKSk7
CiAKIAlpbnRlbF93YV9saXN0X2ZyZWUoJmVuZ2luZS0+Y3R4X3dhX2xpc3QpOwpAQCAtMTU3Myw1
ICsxNTc2LDYgQEAgaW50ZWxfZW5naW5lX2ZpbmRfYWN0aXZlX3JlcXVlc3Qoc3RydWN0IGludGVs
X2VuZ2luZV9jcyAqZW5naW5lKQogfQogCiAjaWYgSVNfRU5BQkxFRChDT05GSUdfRFJNX0k5MTVf
U0VMRlRFU1QpCisjaW5jbHVkZSAibW9ja19lbmdpbmUuYyIKICNpbmNsdWRlICJzZWxmdGVzdF9l
bmdpbmVfY3MuYyIKICNlbmRpZgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Qv
bW9ja19lbmdpbmUuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L21vY2tfZW5naW5lLmMKaW5k
ZXggOGE1ZjA3OTM1Yjg0Li5jNjQ3OTA4NjQ3OTUgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2d0L21vY2tfZW5naW5lLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvbW9j
a19lbmdpbmUuYwpAQCAtMjg2LDggKzI4Niw3IEBAIHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKm1v
Y2tfZW5naW5lKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1LAogCiBpbnQgbW9ja19lbmdp
bmVfaW5pdChzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUpCiB7Ci0Jc3RydWN0IGRybV9p
OTE1X3ByaXZhdGUgKmk5MTUgPSBlbmdpbmUtPmk5MTU7Ci0JaW50IGVycjsKKwlzdHJ1Y3QgaW50
ZWxfY29udGV4dCAqY2U7CiAKIAlpbnRlbF9lbmdpbmVfaW5pdF9hY3RpdmUoZW5naW5lLCBFTkdJ
TkVfTU9DSyk7CiAJaW50ZWxfZW5naW5lX2luaXRfYnJlYWRjcnVtYnMoZW5naW5lKTsKQEAgLTI5
NSwxNiArMjk0LDExIEBAIGludCBtb2NrX2VuZ2luZV9pbml0KHN0cnVjdCBpbnRlbF9lbmdpbmVf
Y3MgKmVuZ2luZSkKIAlpbnRlbF9lbmdpbmVfaW5pdF9fcG0oZW5naW5lKTsKIAlpbnRlbF9lbmdp
bmVfcG9vbF9pbml0KCZlbmdpbmUtPnBvb2wpOwogCi0JZW5naW5lLT5rZXJuZWxfY29udGV4dCA9
Ci0JCWk5MTVfZ2VtX2NvbnRleHRfZ2V0X2VuZ2luZShpOTE1LT5rZXJuZWxfY29udGV4dCwgZW5n
aW5lLT5pZCk7Ci0JaWYgKElTX0VSUihlbmdpbmUtPmtlcm5lbF9jb250ZXh0KSkKLQkJZ290byBl
cnJfYnJlYWRjcnVtYnM7Ci0KLQllcnIgPSBpbnRlbF9jb250ZXh0X3BpbihlbmdpbmUtPmtlcm5l
bF9jb250ZXh0KTsKLQlpbnRlbF9jb250ZXh0X3B1dChlbmdpbmUtPmtlcm5lbF9jb250ZXh0KTsK
LQlpZiAoZXJyKQorCWNlID0gY3JlYXRlX2tlcm5lbF9jb250ZXh0KGVuZ2luZSk7CisJaWYgKElT
X0VSUihjZSkpCiAJCWdvdG8gZXJyX2JyZWFkY3J1bWJzOwogCisJZW5naW5lLT5rZXJuZWxfY29u
dGV4dCA9IGNlOwogCXJldHVybiAwOwogCiBlcnJfYnJlYWRjcnVtYnM6CkBAIC0zMzgsNiArMzMy
LDcgQEAgdm9pZCBtb2NrX2VuZ2luZV9mcmVlKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2lu
ZSkKIAlHRU1fQlVHX09OKHRpbWVyX3BlbmRpbmcoJm1vY2stPmh3X2RlbGF5KSk7CiAKIAlpbnRl
bF9jb250ZXh0X3VucGluKGVuZ2luZS0+a2VybmVsX2NvbnRleHQpOworCWludGVsX2NvbnRleHRf
cHV0KGVuZ2luZS0+a2VybmVsX2NvbnRleHQpOwogCiAJaW50ZWxfZW5naW5lX2ZpbmlfYnJlYWRj
cnVtYnMoZW5naW5lKTsKIApkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Z0L3Nj
aGVkdWxlci5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Z0L3NjaGVkdWxlci5jCmluZGV4IDNl
ZjhiZWZhODkwYS4uNWIyOWYyMmRjNzVhIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9ndnQvc2NoZWR1bGVyLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Z0L3NjaGVkdWxl
ci5jCkBAIC0xMjMwLDcgKzEyMzAsNyBAQCBpbnQgaW50ZWxfdmdwdV9zZXR1cF9zdWJtaXNzaW9u
KHN0cnVjdCBpbnRlbF92Z3B1ICp2Z3B1KQogCQlJTklUX0xJU1RfSEVBRCgmcy0+d29ya2xvYWRf
cV9oZWFkW2ldKTsKIAkJcy0+c2hhZG93W2ldID0gRVJSX1BUUigtRUlOVkFMKTsKIAotCQljZSA9
IGk5MTVfZ2VtX2NvbnRleHRfZ2V0X2VuZ2luZShjdHgsIGkpOworCQljZSA9IGludGVsX2NvbnRl
eHRfY3JlYXRlKGN0eCwgZW5naW5lKTsKIAkJaWYgKElTX0VSUihjZSkpIHsKIAkJCXJldCA9IFBU
Ul9FUlIoY2UpOwogCQkJZ290byBvdXRfc2hhZG93X2N0eDsKQEAgLTEyNzEsNiArMTI3MSw3IEBA
IGludCBpbnRlbF92Z3B1X3NldHVwX3N1Ym1pc3Npb24oc3RydWN0IGludGVsX3ZncHUgKnZncHUp
CiAJCQlicmVhazsKIAogCQlpbnRlbF9jb250ZXh0X3VucGluKHMtPnNoYWRvd1tpXSk7CisJCWlu
dGVsX2NvbnRleHRfcHV0KHMtPnNoYWRvd1tpXSk7CiAJfQogCWk5MTVfZ2VtX2NvbnRleHRfcHV0
KGN0eCk7CiAJcmV0dXJuIHJldDsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5
MTVfZ2VtLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbS5jCmluZGV4IDNmODg4ZDZk
NmE3Ny4uNmJhZTA3M2ZiNTcwIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1
X2dlbS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtLmMKQEAgLTEyNTYsOSAr
MTI1Niw4IEBAIGludCBpOTE1X2dlbV9pbml0X2h3KHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpp
OTE1KQogCiBzdGF0aWMgaW50IF9faW50ZWxfZW5naW5lc19yZWNvcmRfZGVmYXVsdHMoc3RydWN0
IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCiB7CisJc3RydWN0IGk5MTVfcmVxdWVzdCAqcmVxdWVz
dHNbSTkxNV9OVU1fRU5HSU5FU10gPSB7fTsKIAlzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdp
bmU7Ci0Jc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eDsKLQlzdHJ1Y3QgaTkxNV9nZW1fZW5n
aW5lcyAqZTsKIAllbnVtIGludGVsX2VuZ2luZV9pZCBpZDsKIAlpbnQgZXJyID0gMDsKIApAQCAt
MTI3MSwyMCArMTI3MCwyNSBAQCBzdGF0aWMgaW50IF9faW50ZWxfZW5naW5lc19yZWNvcmRfZGVm
YXVsdHMoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCiAJICogZnJvbSB0aGUgc2FtZSBk
ZWZhdWx0IEhXIHZhbHVlcy4KIAkgKi8KIAotCWN0eCA9IGk5MTVfZ2VtX2NvbnRleHRfY3JlYXRl
X2tlcm5lbChpOTE1LCAwKTsKLQlpZiAoSVNfRVJSKGN0eCkpCi0JCXJldHVybiBQVFJfRVJSKGN0
eCk7Ci0KLQllID0gaTkxNV9nZW1fY29udGV4dF9sb2NrX2VuZ2luZXMoY3R4KTsKLQogCWZvcl9l
YWNoX2VuZ2luZShlbmdpbmUsIGk5MTUsIGlkKSB7Ci0JCXN0cnVjdCBpbnRlbF9jb250ZXh0ICpj
ZSA9IGUtPmVuZ2luZXNbaWRdOworCQlzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2U7CiAJCXN0cnVj
dCBpOTE1X3JlcXVlc3QgKnJxOwogCisJCS8qIFdlIG11c3QgYmUgYWJsZSB0byBzd2l0Y2ggdG8g
c29tZXRoaW5nISAqLworCQlHRU1fQlVHX09OKCFlbmdpbmUtPmtlcm5lbF9jb250ZXh0KTsKKwkJ
ZW5naW5lLT5zZXJpYWwrKzsgLyogZm9yY2UgdGhlIGtlcm5lbCBjb250ZXh0IHN3aXRjaCAqLwor
CisJCWNlID0gaW50ZWxfY29udGV4dF9jcmVhdGUoaTkxNS0+a2VybmVsX2NvbnRleHQsIGVuZ2lu
ZSk7CisJCWlmIChJU19FUlIoY2UpKSB7CisJCQllcnIgPSBQVFJfRVJSKGNlKTsKKwkJCWdvdG8g
b3V0OworCQl9CisKIAkJcnEgPSBpbnRlbF9jb250ZXh0X2NyZWF0ZV9yZXF1ZXN0KGNlKTsKIAkJ
aWYgKElTX0VSUihycSkpIHsKIAkJCWVyciA9IFBUUl9FUlIocnEpOwotCQkJZ290byBlcnJfYWN0
aXZlOworCQkJaW50ZWxfY29udGV4dF9wdXQoY2UpOworCQkJZ290byBvdXQ7CiAJCX0KIAogCQll
cnIgPSBpbnRlbF9lbmdpbmVfZW1pdF9jdHhfd2EocnEpOwpAQCAtMTMwNSwyNiArMTMwOSwzMyBA
QCBzdGF0aWMgaW50IF9faW50ZWxfZW5naW5lc19yZWNvcmRfZGVmYXVsdHMoc3RydWN0IGRybV9p
OTE1X3ByaXZhdGUgKmk5MTUpCiAJCQlnb3RvIGVycl9ycTsKIAogZXJyX3JxOgorCQlyZXF1ZXN0
c1tpZF0gPSBpOTE1X3JlcXVlc3RfZ2V0KHJxKTsKIAkJaTkxNV9yZXF1ZXN0X2FkZChycSk7CiAJ
CWlmIChlcnIpCi0JCQlnb3RvIGVycl9hY3RpdmU7CisJCQlnb3RvIG91dDsKIAl9CiAKIAkvKiBG
bHVzaCB0aGUgZGVmYXVsdCBjb250ZXh0IGltYWdlIHRvIG1lbW9yeSwgYW5kIGVuYWJsZSBwb3dl
cnNhdmluZy4gKi8KIAlpZiAoIWk5MTVfZ2VtX2xvYWRfcG93ZXJfY29udGV4dChpOTE1KSkgewog
CQllcnIgPSAtRUlPOwotCQlnb3RvIGVycl9hY3RpdmU7CisJCWdvdG8gb3V0OwogCX0KIAotCWZv
cl9lYWNoX2VuZ2luZShlbmdpbmUsIGk5MTUsIGlkKSB7Ci0JCXN0cnVjdCBpbnRlbF9jb250ZXh0
ICpjZSA9IGUtPmVuZ2luZXNbaWRdOwotCQlzdHJ1Y3QgaTkxNV92bWEgKnN0YXRlID0gY2UtPnN0
YXRlOworCWZvciAoaWQgPSAwOyBpZCA8IEFSUkFZX1NJWkUocmVxdWVzdHMpOyBpZCsrKSB7CisJ
CXN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxOworCQlzdHJ1Y3QgaTkxNV92bWEgKnN0YXRlOwogCQl2
b2lkICp2YWRkcjsKIAotCQlpZiAoIXN0YXRlKQorCQlycSA9IHJlcXVlc3RzW2lkXTsKKwkJaWYg
KCFycSkKIAkJCWNvbnRpbnVlOwogCi0JCUdFTV9CVUdfT04oaW50ZWxfY29udGV4dF9pc19waW5u
ZWQoY2UpKTsKKwkJLyogV2Ugd2FudCB0byBiZSBhYmxlIHRvIHVuYmluZCB0aGUgc3RhdGUgZnJv
bSB0aGUgR0dUVCAqLworCQlHRU1fQlVHX09OKGludGVsX2NvbnRleHRfaXNfcGlubmVkKHJxLT5o
d19jb250ZXh0KSk7CisKKwkJc3RhdGUgPSBycS0+aHdfY29udGV4dC0+c3RhdGU7CisJCWlmICgh
c3RhdGUpCisJCQljb250aW51ZTsKIAogCQkvKgogCQkgKiBBcyB3ZSB3aWxsIGhvbGQgYSByZWZl
cmVuY2UgdG8gdGhlIGxvZ2ljYWwgc3RhdGUsIGl0IHdpbGwKQEAgLTEzMzYsNDMgKzEzNDcsNDkg
QEAgc3RhdGljIGludCBfX2ludGVsX2VuZ2luZXNfcmVjb3JkX2RlZmF1bHRzKHN0cnVjdCBkcm1f
aTkxNV9wcml2YXRlICppOTE1KQogCQkgKi8KIAkJZXJyID0gaTkxNV92bWFfdW5iaW5kKHN0YXRl
KTsKIAkJaWYgKGVycikKLQkJCWdvdG8gZXJyX2FjdGl2ZTsKKwkJCWdvdG8gb3V0OwogCiAJCWk5
MTVfZ2VtX29iamVjdF9sb2NrKHN0YXRlLT5vYmopOwogCQllcnIgPSBpOTE1X2dlbV9vYmplY3Rf
c2V0X3RvX2NwdV9kb21haW4oc3RhdGUtPm9iaiwgZmFsc2UpOwogCQlpOTE1X2dlbV9vYmplY3Rf
dW5sb2NrKHN0YXRlLT5vYmopOwogCQlpZiAoZXJyKQotCQkJZ290byBlcnJfYWN0aXZlOworCQkJ
Z290byBvdXQ7CiAKLQkJZW5naW5lLT5kZWZhdWx0X3N0YXRlID0gaTkxNV9nZW1fb2JqZWN0X2dl
dChzdGF0ZS0+b2JqKTsKLQkJaTkxNV9nZW1fb2JqZWN0X3NldF9jYWNoZV9jb2hlcmVuY3koZW5n
aW5lLT5kZWZhdWx0X3N0YXRlLAotCQkJCQkJICAgIEk5MTVfQ0FDSEVfTExDKTsKKwkJaTkxNV9n
ZW1fb2JqZWN0X3NldF9jYWNoZV9jb2hlcmVuY3koc3RhdGUtPm9iaiwgSTkxNV9DQUNIRV9MTEMp
OwogCiAJCS8qIENoZWNrIHdlIGNhbiBhY3F1aXJlIHRoZSBpbWFnZSBvZiB0aGUgY29udGV4dCBz
dGF0ZSAqLwotCQl2YWRkciA9IGk5MTVfZ2VtX29iamVjdF9waW5fbWFwKGVuZ2luZS0+ZGVmYXVs
dF9zdGF0ZSwKLQkJCQkJCUk5MTVfTUFQX0ZPUkNFX1dCKTsKKwkJdmFkZHIgPSBpOTE1X2dlbV9v
YmplY3RfcGluX21hcChzdGF0ZS0+b2JqLCBJOTE1X01BUF9GT1JDRV9XQik7CiAJCWlmIChJU19F
UlIodmFkZHIpKSB7CiAJCQllcnIgPSBQVFJfRVJSKHZhZGRyKTsKLQkJCWdvdG8gZXJyX2FjdGl2
ZTsKKwkJCWdvdG8gb3V0OwogCQl9CiAKLQkJaTkxNV9nZW1fb2JqZWN0X3VucGluX21hcChlbmdp
bmUtPmRlZmF1bHRfc3RhdGUpOworCQlycS0+ZW5naW5lLT5kZWZhdWx0X3N0YXRlID0gaTkxNV9n
ZW1fb2JqZWN0X2dldChzdGF0ZS0+b2JqKTsKKwkJaTkxNV9nZW1fb2JqZWN0X3VucGluX21hcChz
dGF0ZS0+b2JqKTsKIAl9CiAKLW91dF9jdHg6Ci0JaTkxNV9nZW1fY29udGV4dF91bmxvY2tfZW5n
aW5lcyhjdHgpOwotCWk5MTVfZ2VtX2NvbnRleHRfc2V0X2Nsb3NlZChjdHgpOwotCWk5MTVfZ2Vt
X2NvbnRleHRfcHV0KGN0eCk7Ci0JcmV0dXJuIGVycjsKLQotZXJyX2FjdGl2ZToKK291dDoKIAkv
KgogCSAqIElmIHdlIGhhdmUgdG8gYWJhbmRvbiBub3csIHdlIGV4cGVjdCB0aGUgZW5naW5lcyB0
byBiZSBpZGxlCiAJICogYW5kIHJlYWR5IHRvIGJlIHRvcm4tZG93bi4gVGhlIHF1aWNrZXN0IHdh
eSB3ZSBjYW4gYWNjb21wbGlzaAogCSAqIHRoaXMgaXMgYnkgZGVjbGFyaW5nIG91cnNlbHZlcyB3
ZWRnZWQuCiAJICovCi0JaW50ZWxfZ3Rfc2V0X3dlZGdlZCgmaTkxNS0+Z3QpOwotCWdvdG8gb3V0
X2N0eDsKKwlpZiAoZXJyKQorCQlpbnRlbF9ndF9zZXRfd2VkZ2VkKCZpOTE1LT5ndCk7CisKKwlm
b3IgKGlkID0gMDsgaWQgPCBBUlJBWV9TSVpFKHJlcXVlc3RzKTsgaWQrKykgeworCQlzdHJ1Y3Qg
aW50ZWxfY29udGV4dCAqY2U7CisJCXN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxOworCisJCXJxID0g
cmVxdWVzdHNbaWRdOworCQlpZiAoIXJxKQorCQkJY29udGludWU7CisKKwkJY2UgPSBycS0+aHdf
Y29udGV4dDsKKwkJaTkxNV9yZXF1ZXN0X3B1dChycSk7CisJCWludGVsX2NvbnRleHRfcHV0KGNl
KTsKKwl9CisJcmV0dXJuIGVycjsKIH0KIAogc3RhdGljIGludAotLSAKMi4yMy4wLnJjMQoKX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1h
aWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMu
ZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 2A97572F1F
	for <lists+intel-gfx@lfdr.de>; Wed, 24 Jul 2019 14:44:06 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 47A876E4AE;
	Wed, 24 Jul 2019 12:44:04 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id B64A96E4AE
 for <intel-gfx@lists.freedesktop.org>; Wed, 24 Jul 2019 12:44:02 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17565379-1500050 
 for multiple; Wed, 24 Jul 2019 13:43:43 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Wed, 24 Jul 2019 13:43:42 +0100
Message-Id: <20190724124342.27796-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.22.0
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH] drm/i915: Unshare the idle-barrier from other
 kernel requests
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

VW5kZXIgc29tZSBjaXJjdW1zdGFuY2VzIChzZWUgaW50ZWxfY29udGV4dF9wcmVwYXJlX3JlbW90
ZV9yZXF1ZXN0KSwgd2UKbWF5IHVzZSBhIHJlcXVzdCBhbG9uZyBhIGtlcm5lbCBjb250ZXh0IHRv
IG1vZGlmeSB0aGUgbG9naWNhbCBzdGF0ZSBvZgphbm90aGVyLiBUbyBrZWVwIHRoZSB0YXJnZXQg
Y29udGV4dCBpbiBwbGFjZSB3aGlsZSB0aGUgcmVxdWVzdCBleGVjdXRlcywKd2UgdGFrZSBhbiBh
Y3RpdmUgcmVmZXJlbmNlIG9uIGl0IHVzaW5nIHRoZSBrZXJuZWwgdGltZWxpbmUuIFRoaXMgaXMg
dGhlCnNhbWUgdGltZWxpbmUgYXMgd2UgdXNlIGZvciB0aGUgaWRsZS1iYXJyaWVyLCBhbmQgc28g
d2UgZW5kIHVwIHJldXNpbmcKdGhlIHNhbWUgYWN0aXZlIG5vZGUuIEV4Y2VwdCB0aGF0IHRoZSBp
ZGxlIGJhcnJpZXIgaXMgc3BlY2lhbCBhbmQgY2Fubm90CmJlIHJldXNlZCBpbiB0aGlzIG1hbm5l
ciEgR2l2ZSB0aGUgaWRsZS1iYXJyaWVyIGEgcmVzZXJ2ZWQgdGltZWxpbmUKaW5kZXggKDApIHNv
IHRoYXQgaXMgd2lsbCBhbHdheXMgYmUgdW5pcXVlIChnaXZlIG9yIHRha2Ugd2UgbWF5IGlzc3Vl
Cm11bHRpcGxlIGlkbGUgYmFycmllcnMgYWNyb3NzIG11bHRpcGxlIGVuZ2luZXMpLgoKUmVwb3J0
ZWQtYnk6IExpb25lbCBMYW5kd2VybGluIDxsaW9uZWwuZy5sYW5kd2VybGluQGludGVsLmNvbT4K
Rml4ZXM6IGNlNDc2YzgwYjhiZiAoImRybS9pOTE1OiBLZWVwIGNvbnRleHRzIHBpbm5lZCB1bnRp
bCBhZnRlciB0aGUgbmV4dCBrZXJuZWwgY29udGV4dCBzd2l0Y2giKQpGaXhlczogYTk4NzdkYTJk
NjI5ICgiZHJtL2k5MTUvb2E6IFJlY29uZmlndXJlIGNvbnRleHRzIG9uIHRoZSBmbHkiKQpTaWdu
ZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KQ2M6IExp
b25lbCBMYW5kd2VybGluIDxsaW9uZWwuZy5sYW5kd2VybGluQGludGVsLmNvbT4KQ2M6IFR2cnRr
byBVcnN1bGluIDx0dnJ0a28udXJzdWxpbkBpbnRlbC5jb20+Ci0tLQogZHJpdmVycy9ncHUvZHJt
L2k5MTUvaTkxNV9hY3RpdmUuYyB8IDYzICsrKysrKysrKysrKysrKysrKysrKystLS0tLS0tLQog
MSBmaWxlIGNoYW5nZWQsIDQ3IGluc2VydGlvbnMoKyksIDE2IGRlbGV0aW9ucygtKQoKZGlmZiAt
LWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfYWN0aXZlLmMgYi9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9pOTE1X2FjdGl2ZS5jCmluZGV4IDEzZjMwNGEyOWZjOC4uNGY3ZjY5OGJmZjE1IDEw
MDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2FjdGl2ZS5jCisrKyBiL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L2k5MTVfYWN0aXZlLmMKQEAgLTE4NCw2ICsxODQsNyBAQCBhY3RpdmVf
aW5zdGFuY2Uoc3RydWN0IGk5MTVfYWN0aXZlICpyZWYsIHU2NCBpZHgpCiAJcmVmLT5jYWNoZSA9
IG5vZGU7CiAJbXV0ZXhfdW5sb2NrKCZyZWYtPm11dGV4KTsKIAorCUJVSUxEX0JVR19PTihvZmZz
ZXRvZih0eXBlb2YoKm5vZGUpLCBiYXNlKSk7CiAJcmV0dXJuICZub2RlLT5iYXNlOwogfQogCkBA
IC0yMTIsNiArMjEzLDggQEAgaW50IGk5MTVfYWN0aXZlX3JlZihzdHJ1Y3QgaTkxNV9hY3RpdmUg
KnJlZiwKIAlzdHJ1Y3QgaTkxNV9hY3RpdmVfcmVxdWVzdCAqYWN0aXZlOwogCWludCBlcnI7CiAK
KwlHRU1fQlVHX09OKCF0aW1lbGluZSk7IC8qIHJlc2VydmVkIGZvciBpZGxlLWJhcnJpZXIgKi8K
KwogCS8qIFByZXZlbnQgcmVhcGluZyBpbiBjYXNlIHdlIG1hbGxvYy93YWl0IHdoaWxlIGJ1aWxk
aW5nIHRoZSB0cmVlICovCiAJZXJyID0gaTkxNV9hY3RpdmVfYWNxdWlyZShyZWYpOwogCWlmIChl
cnIpCkBAIC0zNDIsNiArMzQ1LDMxIEBAIHZvaWQgaTkxNV9hY3RpdmVfZmluaShzdHJ1Y3QgaTkx
NV9hY3RpdmUgKnJlZikKIH0KICNlbmRpZgogCitzdGF0aWMgc3RydWN0IGFjdGl2ZV9ub2RlICpp
ZGxlX2JhcnJpZXIoc3RydWN0IGk5MTVfYWN0aXZlICpyZWYpCit7CisJc3RydWN0IGFjdGl2ZV9u
b2RlICpub2RlID0gTlVMTDsKKwlzdHJ1Y3QgcmJfbm9kZSAqcmI7CisKKwltdXRleF9sb2NrKCZy
ZWYtPm11dGV4KTsKKworCXJiID0gcmJfZmlyc3QoJnJlZi0+dHJlZSk7CisJaWYgKCFyYikKKwkJ
Z290byB1bmxvY2s7CisKKwlub2RlID0gcmJfZW50cnkocmIsIHR5cGVvZigqbm9kZSksIG5vZGUp
OworCWlmIChub2RlLT50aW1lbGluZSB8fCBpOTE1X2FjdGl2ZV9yZXF1ZXN0X2lzc2V0KCZub2Rl
LT5iYXNlKSkgeworCQlub2RlID0gTlVMTDsKKwkJZ290byB1bmxvY2s7CisJfQorCisJR0VNX0JV
R19PTighbGlzdF9lbXB0eSgmbm9kZS0+YmFzZS5saW5rKSk7CisJcmJfZXJhc2UocmIsICZyZWYt
PnRyZWUpOworCit1bmxvY2s6CisJbXV0ZXhfdW5sb2NrKCZyZWYtPm11dGV4KTsKKwlyZXR1cm4g
bm9kZTsKK30KKwogaW50IGk5MTVfYWN0aXZlX2FjcXVpcmVfcHJlYWxsb2NhdGVfYmFycmllcihz
dHJ1Y3QgaTkxNV9hY3RpdmUgKnJlZiwKIAkJCQkJICAgIHN0cnVjdCBpbnRlbF9lbmdpbmVfY3Mg
KmVuZ2luZSkKIHsKQEAgLTM1MiwyMiArMzgwLDI5IEBAIGludCBpOTE1X2FjdGl2ZV9hY3F1aXJl
X3ByZWFsbG9jYXRlX2JhcnJpZXIoc3RydWN0IGk5MTVfYWN0aXZlICpyZWYsCiAKIAlHRU1fQlVH
X09OKCFlbmdpbmUtPm1hc2spOwogCWZvcl9lYWNoX2VuZ2luZV9tYXNrZWQoZW5naW5lLCBpOTE1
LCBlbmdpbmUtPm1hc2ssIHRtcCkgewotCQlzdHJ1Y3QgaW50ZWxfY29udGV4dCAqa2N0eCA9IGVu
Z2luZS0+a2VybmVsX2NvbnRleHQ7CiAJCXN0cnVjdCBhY3RpdmVfbm9kZSAqbm9kZTsKIAotCQlu
b2RlID0ga21lbV9jYWNoZV9hbGxvYyhnbG9iYWwuc2xhYl9jYWNoZSwgR0ZQX0tFUk5FTCk7Ci0J
CWlmICh1bmxpa2VseSghbm9kZSkpIHsKLQkJCWVyciA9IC1FTk9NRU07Ci0JCQlnb3RvIHVud2lu
ZDsKKwkJbm9kZSA9IGlkbGVfYmFycmllcihyZWYpOworCQlpZiAoIW5vZGUpIHsKKwkJCW5vZGUg
PSBrbWVtX2NhY2hlX2FsbG9jKGdsb2JhbC5zbGFiX2NhY2hlLAorCQkJCQkJR0ZQX0tFUk5FTCB8
CisJCQkJCQlfX0dGUF9SRVRSWV9NQVlGQUlMIHwKKwkJCQkJCV9fR0ZQX05PV0FSTik7CisJCQlp
ZiAodW5saWtlbHkoIW5vZGUpKSB7CisJCQkJZXJyID0gLUVOT01FTTsKKwkJCQlnb3RvIHVud2lu
ZDsKKwkJCX0KKworCQkJbm9kZS0+cmVmID0gcmVmOworCQkJbm9kZS0+dGltZWxpbmUgPSAwOwor
CQkJbm9kZS0+YmFzZS5yZXRpcmUgPSBub2RlX3JldGlyZTsKIAkJfQogCi0JCWk5MTVfYWN0aXZl
X3JlcXVlc3RfaW5pdCgmbm9kZS0+YmFzZSwKLQkJCQkJICh2b2lkICopZW5naW5lLCBub2RlX3Jl
dGlyZSk7Ci0JCW5vZGUtPnRpbWVsaW5lID0ga2N0eC0+cmluZy0+dGltZWxpbmUtPmZlbmNlX2Nv
bnRleHQ7Ci0JCW5vZGUtPnJlZiA9IHJlZjsKKwkJaW50ZWxfZW5naW5lX3BtX2dldChlbmdpbmUp
OworCisJCVJDVV9JTklUX1BPSU5URVIobm9kZS0+YmFzZS5yZXF1ZXN0LCAodm9pZCAqKWVuZ2lu
ZSk7CiAJCWF0b21pY19pbmMoJnJlZi0+Y291bnQpOwogCi0JCWludGVsX2VuZ2luZV9wbV9nZXQo
ZW5naW5lKTsKIAkJbGxpc3RfYWRkKChzdHJ1Y3QgbGxpc3Rfbm9kZSAqKSZub2RlLT5iYXNlLmxp
bmssCiAJCQkgICZyZWYtPmJhcnJpZXJzKTsKIAl9CkBAIC00MDIsNiArNDM3LDcgQEAgdm9pZCBp
OTE1X2FjdGl2ZV9hY3F1aXJlX2JhcnJpZXIoc3RydWN0IGk5MTVfYWN0aXZlICpyZWYpCiAKIAkJ
bm9kZSA9IGNvbnRhaW5lcl9vZigoc3RydWN0IGxpc3RfaGVhZCAqKXBvcywKIAkJCQkgICAgdHlw
ZW9mKCpub2RlKSwgYmFzZS5saW5rKTsKKwkJR0VNX0JVR19PTihub2RlLT50aW1lbGluZSk7CiAK
IAkJZW5naW5lID0gKHZvaWQgKilyY3VfYWNjZXNzX3BvaW50ZXIobm9kZS0+YmFzZS5yZXF1ZXN0
KTsKIAkJUkNVX0lOSVRfUE9JTlRFUihub2RlLT5iYXNlLnJlcXVlc3QsIEVSUl9QVFIoLUVBR0FJ
TikpOwpAQCAtNDEwLDEyICs0NDYsNyBAQCB2b2lkIGk5MTVfYWN0aXZlX2FjcXVpcmVfYmFycmll
cihzdHJ1Y3QgaTkxNV9hY3RpdmUgKnJlZikKIAkJcCA9ICZyZWYtPnRyZWUucmJfbm9kZTsKIAkJ
d2hpbGUgKCpwKSB7CiAJCQlwYXJlbnQgPSAqcDsKLQkJCWlmIChyYl9lbnRyeShwYXJlbnQsCi0J
CQkJICAgICBzdHJ1Y3QgYWN0aXZlX25vZGUsCi0JCQkJICAgICBub2RlKS0+dGltZWxpbmUgPCBu
b2RlLT50aW1lbGluZSkKLQkJCQlwID0gJnBhcmVudC0+cmJfcmlnaHQ7Ci0JCQllbHNlCi0JCQkJ
cCA9ICZwYXJlbnQtPnJiX2xlZnQ7CisJCQlwID0gJnBhcmVudC0+cmJfbGVmdDsKIAkJfQogCQly
Yl9saW5rX25vZGUoJm5vZGUtPm5vZGUsIHBhcmVudCwgcCk7CiAJCXJiX2luc2VydF9jb2xvcigm
bm9kZS0+bm9kZSwgJnJlZi0+dHJlZSk7Ci0tIAoyLjIyLjAKCl9fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwt
Z2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9t
YWlsbWFuL2xpc3RpbmZvL2ludGVsLWdmeA==

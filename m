Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id C36365F9B14
	for <lists+intel-gfx@lfdr.de>; Mon, 10 Oct 2022 10:35:28 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 0B7EA10E6CA;
	Mon, 10 Oct 2022 08:35:26 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mga17.intel.com (mga17.intel.com [192.55.52.151])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 5845110E4A5
 for <intel-gfx@lists.freedesktop.org>; Mon, 10 Oct 2022 08:35:14 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
 d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
 t=1665390914; x=1696926914;
 h=from:to:cc:subject:date:message-id:in-reply-to:
 references:mime-version:content-transfer-encoding;
 bh=xWtnsIffFFDFB4x+KlgWCt4nk9cFUuF0D6C5HOdbK5g=;
 b=nZ2fw3PKzM5TmImUuriW/k8LNu3ER1LNEYVAHVMHXaI+wXBbOMl+oZd+
 fRBm/LHiwG4N0UJYM3tmp4e2da56KuQz/ojWpZTUeszxzA+xMpRJyqepv
 ynBMD6ARwXCTUQkCdzTNoz6eiheg8lEZQzs5Q8M3xAENFr6DDIFtIo26A
 OumbIR/LOfs6QS14yuWgZLwflFXUNIkZ7St2q2G2kphNGtMhJ3v/rh111
 KhXaEL7TT0d3wUC5WJtxEdexLX7yhizZxBGxB+vqh9q+rjROPa39/4AbO
 2Eo7bPLMZmUl2csPbHRR7hnJ3nKj7qROI2VKVzvnDt39aHWqCousKZhe9 w==;
X-IronPort-AV: E=McAfee;i="6500,9779,10495"; a="284553086"
X-IronPort-AV: E=Sophos;i="5.95,173,1661842800"; d="scan'208";a="284553086"
Received: from fmsmga005.fm.intel.com ([10.253.24.32])
 by fmsmga107.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 10 Oct 2022 01:35:14 -0700
X-IronPort-AV: E=McAfee;i="6500,9779,10495"; a="954839347"
X-IronPort-AV: E=Sophos;i="5.95,173,1661842800"; d="scan'208";a="954839347"
Received: from vgovind2-mobl3.tm.intel.com ([10.237.50.39])
 by fmsmga005-auth.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 10 Oct 2022 01:35:12 -0700
From: Vinod Govindapillai <vinod.govindapillai@intel.com>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 10 Oct 2022 11:34:47 +0300
Message-Id: <20221010083447.139768-3-vinod.govindapillai@intel.com>
X-Mailer: git-send-email 2.34.1
In-Reply-To: <20221010083447.139768-1-vinod.govindapillai@intel.com>
References: <20221010083447.139768-1-vinod.govindapillai@intel.com>
MIME-Version: 1.0
Organization: Intel Finland Oy - BIC 0357606-4 - Westendinkatu 7, 02160 Espoo
Content-Transfer-Encoding: 8bit
Subject: [Intel-gfx] [PATCH v2 2/2] drm/i915/display: debugfs entry to
 control ignore long hpd flag
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: jani.nikula@intel.com
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

Knob to control ignoring the long hpds. Set this to true will
start ignoring the long HPDs generated by the displays. Useful
for use cases like CI systems where we dont expect to disconnect
the panels.

v2: Address patch styling comments (Jani Nikula)

Signed-off-by: Vinod Govindapillai <vinod.govindapillai@intel.com>
---
 drivers/gpu/drm/i915/display/intel_hotplug.c | 25 ++++++++++++++++++++
 1 file changed, 25 insertions(+)

diff --git a/drivers/gpu/drm/i915/display/intel_hotplug.c b/drivers/gpu/drm/i915/display/intel_hotplug.c
index 352a1b53b63e..45c67f0f1c9f 100644
--- a/drivers/gpu/drm/i915/display/intel_hotplug.c
+++ b/drivers/gpu/drm/i915/display/intel_hotplug.c
@@ -936,6 +936,29 @@ static const struct file_operations i915_hpd_short_storm_ctl_fops = {
 	.write = i915_hpd_short_storm_ctl_write,
 };
 
+static int i915_ignore_long_hpd_set(void *data, u64 val)
+{
+	struct drm_i915_private *i915 = data;
+
+	drm_dbg_kms(&i915->drm, "Ignoring long HPDs: %s\n", str_yes_no(val));
+
+	i915->display.hotplug.ignore_long_hpd = val;
+
+	return 0;
+}
+
+static int i915_ignore_long_hpd_get(void *data, u64 *val)
+{
+	struct drm_i915_private *i915 = data;
+
+	*val = i915->display.hotplug.ignore_long_hpd;
+
+	return 0;
+}
+
+DEFINE_SIMPLE_ATTRIBUTE(i915_ignore_long_hpd_fops, i915_ignore_long_hpd_get,
+			i915_ignore_long_hpd_set, "%llu\n");
+
 void intel_hpd_debugfs_register(struct drm_i915_private *i915)
 {
 	struct drm_minor *minor = i915->drm.primary;
@@ -944,4 +967,6 @@ void intel_hpd_debugfs_register(struct drm_i915_private *i915)
 			    i915, &i915_hpd_storm_ctl_fops);
 	debugfs_create_file("i915_hpd_short_storm_ctl", 0644, minor->debugfs_root,
 			    i915, &i915_hpd_short_storm_ctl_fops);
+	debugfs_create_file("i915_ignore_long_hpd", 0644, minor->debugfs_root,
+			    i915, &i915_ignore_long_hpd_fops);
 }
-- 
2.34.1


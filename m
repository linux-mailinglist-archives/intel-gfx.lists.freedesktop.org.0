Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 70B10D5E32
	for <lists+intel-gfx@lfdr.de>; Mon, 14 Oct 2019 11:08:34 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 853E26E17E;
	Mon, 14 Oct 2019 09:08:31 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 147C76E178
 for <intel-gfx@lists.freedesktop.org>; Mon, 14 Oct 2019 09:08:20 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18828692-1500050 
 for multiple; Mon, 14 Oct 2019 10:08:01 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 14 Oct 2019 10:07:53 +0100
Message-Id: <20191014090757.32111-11-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20191014090757.32111-1-chris@chris-wilson.co.uk>
References: <20191014090757.32111-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 11/15] drm/i915/execlists: Cancel banned
 contexts on schedule-out
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

T24gc2NoZWR1bGUtb3V0IChDUyBjb21wbGV0aW9uKSBvZiBhIGJhbm5lZCBjb250ZXh0LCBzY3J1
YiB0aGUgY29udGV4dAppbWFnZSBzbyB0aGF0IHdlIGRvIG5vdCByZXBsYXkgdGhlIGFjdGl2ZSBw
YXlsb2FkLiBUaGUgaW50ZW50IGlzIHRoYXQgd2UKc2tpcCBiYW5uZWQgcGF5bG9hZHMgb24gcmVx
dWVzdCBzdWJtaXNzaW9uIHNvIHRoYXQgdGhlIHRpbWVsaW5lCmFkdmFuY2VtZW50IGNvbnRpbnVl
cyBvbiBpbiB0aGUgYmFja2dyb3VuZC4gSG93ZXZlciwgaWYgd2UgYXJlIHJldHVybmluZwp0byBh
IHByZWVtcHRlZCByZXF1ZXN0LCBpOTE1X3JlcXVlc3Rfc2tpcCgpIGlzIGluZWZmZWN0aXZlIGFu
ZCBpbnN0ZWFkIHdlCm5lZWQgdG8gcGF0Y2ggdXAgdGhlIGNvbnRleHQgaW1hZ2Ugc28gdGhhdCBp
dCBjb250aW51ZXMgZnJvbSB0aGUgc3RhcnQKb2YgdGhlIG5leHQgcmVxdWVzdC4KCnYyOiBGaXh1
cCBjYW5jZWxsYXRpb24gc28gdGhhdCB3ZSBvbmx5IHNjcnViIHRoZSBwYXlsb2FkIG9mIHRoZSBh
Y3RpdmUKcmVxdWVzdCBhbmQgZG8gbm90IHNob3J0LWNpcmN1aXQgdGhlIGJyZWFkY3J1bWJzICh3
aGljaCBtaWdodCBjYXVzZQpvdGhlciBjb250ZXh0cyB0byBleGVjdXRlIG91dCBvZiBvcmRlciku
CgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNocmlzQGNocmlzLXdpbHNvbi5jby51az4K
Q2M6IFR2cnRrbyBVcnN1bGluIDx0dnJ0a28udXJzdWxpbkBpbnRlbC5jb20+Ci0tLQogZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjLmMgICAgfCAxMjkgKysrKysrKystLS0tCiBkcml2
ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVzdF9scmMuYyB8IDI3MyArKysrKysrKysrKysrKysr
KysrKysrKysrCiAyIGZpbGVzIGNoYW5nZWQsIDM2MSBpbnNlcnRpb25zKCspLCA0MSBkZWxldGlv
bnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9scmMuYyBi
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2xyYy5jCmluZGV4IGUxNmVkZTc1NDEyYi4u
Yjc2YjM1MTk0MTE0IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9s
cmMuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9scmMuYwpAQCAtMjM0LDYg
KzIzNCw5IEBAIHN0YXRpYyB2b2lkIGV4ZWNsaXN0c19pbml0X3JlZ19zdGF0ZSh1MzIgKnJlZ19z
dGF0ZSwKIAkJCQkgICAgIGNvbnN0IHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSwKIAkJ
CQkgICAgIGNvbnN0IHN0cnVjdCBpbnRlbF9yaW5nICpyaW5nLAogCQkJCSAgICAgYm9vbCBjbG9z
ZSk7CitzdGF0aWMgdm9pZAorX19leGVjbGlzdHNfdXBkYXRlX3JlZ19zdGF0ZShjb25zdCBzdHJ1
Y3QgaW50ZWxfY29udGV4dCAqY2UsCisJCQkgICAgIGNvbnN0IHN0cnVjdCBpbnRlbF9lbmdpbmVf
Y3MgKmVuZ2luZSk7CiAKIHN0YXRpYyB2b2lkIGNhbmNlbF90aW1lcihzdHJ1Y3QgdGltZXJfbGlz
dCAqdCkKIHsKQEAgLTI3MCw2ICsyNzMsMzEgQEAgc3RhdGljIHZvaWQgbWFya19laW8oc3RydWN0
IGk5MTVfcmVxdWVzdCAqcnEpCiAJaTkxNV9yZXF1ZXN0X21hcmtfY29tcGxldGUocnEpOwogfQog
CitzdGF0aWMgc3RydWN0IGk5MTVfcmVxdWVzdCAqYWN0aXZlX3JlcXVlc3Qoc3RydWN0IGk5MTVf
cmVxdWVzdCAqcnEpCit7CisJY29uc3Qgc3RydWN0IGludGVsX2NvbnRleHQgKiBjb25zdCBjZSA9
IHJxLT5od19jb250ZXh0OworCXN0cnVjdCBpOTE1X3JlcXVlc3QgKmFjdGl2ZSA9IE5VTEw7CisJ
c3RydWN0IGxpc3RfaGVhZCAqbGlzdDsKKworCWlmICghaTkxNV9yZXF1ZXN0X2lzX2FjdGl2ZShy
cSkpIC8qIHVud291bmQsIGJ1dCBpbmNvbXBsZXRlISAqLworCQlyZXR1cm4gcnE7CisKKwlyY3Vf
cmVhZF9sb2NrKCk7CisJbGlzdCA9ICZyY3VfZGVyZWZlcmVuY2UocnEtPnRpbWVsaW5lKS0+cmVx
dWVzdHM7CisJbGlzdF9mb3JfZWFjaF9lbnRyeV9mcm9tX3JldmVyc2UocnEsIGxpc3QsIGxpbmsp
IHsKKwkJaWYgKGk5MTVfcmVxdWVzdF9jb21wbGV0ZWQocnEpKQorCQkJYnJlYWs7CisKKwkJaWYg
KHJxLT5od19jb250ZXh0ICE9IGNlKQorCQkJYnJlYWs7CisKKwkJYWN0aXZlID0gcnE7CisJfQor
CXJjdV9yZWFkX3VubG9jaygpOworCisJcmV0dXJuIGFjdGl2ZTsKK30KKwogc3RhdGljIGlubGlu
ZSB1MzIgaW50ZWxfaHdzX3ByZWVtcHRfYWRkcmVzcyhzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICpl
bmdpbmUpCiB7CiAJcmV0dXJuIChpOTE1X2dndHRfb2Zmc2V0KGVuZ2luZS0+c3RhdHVzX3BhZ2Uu
dm1hKSArCkBAIC05OTEsNiArMTAxOSw1NiBAQCBzdGF0aWMgdm9pZCBraWNrX3NpYmxpbmdzKHN0
cnVjdCBpOTE1X3JlcXVlc3QgKnJxLCBzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UpCiAJCXRhc2ts
ZXRfc2NoZWR1bGUoJnZlLT5iYXNlLmV4ZWNsaXN0cy50YXNrbGV0KTsKIH0KIAorc3RhdGljIHZv
aWQgcmVzdG9yZV9kZWZhdWx0X3N0YXRlKHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSwKKwkJCQkg
IHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKK3sKKwl1MzIgKnJlZ3MgPSBjZS0+bHJj
X3JlZ19zdGF0ZTsKKworCWlmIChlbmdpbmUtPnBpbm5lZF9kZWZhdWx0X3N0YXRlKQorCQltZW1j
cHkocmVncywgLyogc2tpcCByZXN0b3JpbmcgdGhlIHZhbmlsbGEgUFBIV1NQICovCisJCSAgICAg
ICBlbmdpbmUtPnBpbm5lZF9kZWZhdWx0X3N0YXRlICsgTFJDX1NUQVRFX1BOICogUEFHRV9TSVpF
LAorCQkgICAgICAgZW5naW5lLT5jb250ZXh0X3NpemUgLSBQQUdFX1NJWkUpOworCisJZXhlY2xp
c3RzX2luaXRfcmVnX3N0YXRlKHJlZ3MsIGNlLCBlbmdpbmUsIGNlLT5yaW5nLCBmYWxzZSk7Cit9
CisKK3N0YXRpYyB2b2lkIGNhbmNlbF9hY3RpdmUoc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEsCisJ
CQkgIHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKK3sKKwlzdHJ1Y3QgaW50ZWxfY29u
dGV4dCAqIGNvbnN0IGNlID0gcnEtPmh3X2NvbnRleHQ7CisKKwkvKgorCSAqIFRoZSBleGVjdXRp
bmcgY29udGV4dCBoYXMgYmVlbiBjYW5jZWxsZWQuIEZpeHVwIHRoZSBjb250ZXh0IHNvIHRoYXQK
KwkgKiBpdCB3aWxsIGJlIG1hcmtlZCBhcyBpbmNvbXBsZXRlIFstRUlPXSB1cG9uIHJlc3VibWlz
c2lvbiBhbmQgbm90CisJICogZXhlY3V0ZSBhbnkgdXNlciBwYXlsb2Fkcy4gV2UgcHJlc2VydmUg
dGhlIGJyZWFkY3J1bWJzIGFuZAorCSAqIHNlbWFwaG9yZXMgb2YgdGhlIGluY29tcGxldGUgcmVx
dWVzdHMgc28gdGhhdCBpbnRlci10aW1lbGluZQorCSAqIGRlcGVuZGVuY2llcyAoaS5lIG90aGVy
IHRpbWVsaW5lcykgcmVtYWluIGNvcnJlY3RseSBvcmRlcmVkLgorCSAqCisJICogU2VlIF9faTkx
NV9yZXF1ZXN0X3N1Ym1pdCgpIGZvciBhcHBseWluZyAtRUlPIGFuZCByZW1vdmluZyB0aGUKKwkg
KiBwYXlsb2FkIG9uIHJlc3VibWlzc2lvbi4KKwkgKi8KKwlHRU1fVFJBQ0UoIiVzKCVzKTogeyBy
cT0lbGx4OiVsbGQgfVxuIiwKKwkJICBfX2Z1bmNfXywgZW5naW5lLT5uYW1lLCBycS0+ZmVuY2Uu
Y29udGV4dCwgcnEtPmZlbmNlLnNlcW5vKTsKKwlfX2NvbnRleHRfcGluX2FjcXVpcmUoY2UpOwor
CisJLyogT24gcmVzdWJtaXNzaW9uIG9mIHRoZSBhY3RpdmUgcmVxdWVzdCwgcGF5bG9hZCB3aWxs
IGJlIHNjcnViYmVkICovCisJcnEgPSBhY3RpdmVfcmVxdWVzdChycSk7CisJaWYgKHJxKQorCQlj
ZS0+cmluZy0+aGVhZCA9IGludGVsX3Jpbmdfd3JhcChjZS0+cmluZywgcnEtPmhlYWQpOworCWVs
c2UKKwkJY2UtPnJpbmctPmhlYWQgPSBjZS0+cmluZy0+dGFpbDsKKwlpbnRlbF9yaW5nX3VwZGF0
ZV9zcGFjZShjZS0+cmluZyk7CisKKwkvKiBTY3J1YiB0aGUgY29udGV4dCBpbWFnZSB0byBwcmV2
ZW50IHJlcGxheWluZyB0aGUgcHJldmlvdXMgYmF0Y2ggKi8KKwlyZXN0b3JlX2RlZmF1bHRfc3Rh
dGUoY2UsIGVuZ2luZSk7CisJX19leGVjbGlzdHNfdXBkYXRlX3JlZ19zdGF0ZShjZSwgZW5naW5l
KTsKKworCS8qIFdlJ3ZlIHN3aXRjaGVkIGF3YXksIHNvIHRoaXMgc2hvdWxkIGJlIGEgbm8tb3As
IGJ1dCBpbnRlbnQgbWF0dGVycyAqLworCWNlLT5scmNfZGVzYyB8PSBDVFhfREVTQ19GT1JDRV9S
RVNUT1JFOworCisJX19jb250ZXh0X3Bpbl9yZWxlYXNlKGNlKTsKK30KKwogc3RhdGljIGlubGlu
ZSB2b2lkCiBfX2V4ZWNsaXN0c19zY2hlZHVsZV9vdXQoc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEs
CiAJCQkgc3RydWN0IGludGVsX2VuZ2luZV9jcyAqIGNvbnN0IGVuZ2luZSkKQEAgLTEwMDEsNiAr
MTA3OSw5IEBAIF9fZXhlY2xpc3RzX3NjaGVkdWxlX291dChzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpy
cSwKIAlleGVjbGlzdHNfY29udGV4dF9zdGF0dXNfY2hhbmdlKHJxLCBJTlRFTF9DT05URVhUX1ND
SEVEVUxFX09VVCk7CiAJaW50ZWxfZ3RfcG1fcHV0KGVuZ2luZS0+Z3QpOwogCisJaWYgKHVubGlr
ZWx5KGk5MTVfZ2VtX2NvbnRleHRfaXNfYmFubmVkKGNlLT5nZW1fY29udGV4dCkpKQorCQljYW5j
ZWxfYWN0aXZlKHJxLCBlbmdpbmUpOworCiAJLyoKIAkgKiBJZiB0aGlzIGlzIHBhcnQgb2YgYSB2
aXJ0dWFsIGVuZ2luZSwgaXRzIG5leHQgcmVxdWVzdCBtYXkKIAkgKiBoYXZlIGJlZW4gYmxvY2tl
ZCB3YWl0aW5nIGZvciBhY2Nlc3MgdG8gdGhlIGFjdGl2ZSBjb250ZXh0LgpAQCAtMTM5NSw2ICsx
NDc2LDEwIEBAIHN0YXRpYyB1bnNpZ25lZCBsb25nIGFjdGl2ZV9wcmVlbXB0X3RpbWVvdXQoc3Ry
dWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lKQogCWlmICghcnEpCiAJCXJldHVybiAwOwogCisJ
LyogRm9yY2UgYSBmYXN0IHJlc2V0IGZvciB0ZXJtaW5hdGVkIGNvbnRleHRzIChpZ25vcmluZyBz
eXNmcyEpICovCisJaWYgKHVubGlrZWx5KGk5MTVfZ2VtX2NvbnRleHRfaXNfYmFubmVkKHJxLT5n
ZW1fY29udGV4dCkpKQorCQlyZXR1cm4gMTsKKwogCXJldHVybiBSRUFEX09OQ0UoZW5naW5lLT5w
cm9wcy5wcmVlbXB0X3RpbWVvdXQpOwogfQogCkBAIC0yODEwLDI5ICsyODk1LDYgQEAgc3RhdGlj
IHZvaWQgcmVzZXRfY3NiX3BvaW50ZXJzKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkK
IAkJCSAgICAgICAmZXhlY2xpc3RzLT5jc2Jfc3RhdHVzW3Jlc2V0X3ZhbHVlXSk7CiB9CiAKLXN0
YXRpYyBzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICphY3RpdmVfcmVxdWVzdChzdHJ1Y3QgaTkxNV9yZXF1
ZXN0ICpycSkKLXsKLQljb25zdCBzdHJ1Y3QgaW50ZWxfY29udGV4dCAqIGNvbnN0IGNlID0gcnEt
Pmh3X2NvbnRleHQ7Ci0Jc3RydWN0IGk5MTVfcmVxdWVzdCAqYWN0aXZlID0gTlVMTDsKLQlzdHJ1
Y3QgbGlzdF9oZWFkICpsaXN0OwotCi0JaWYgKCFpOTE1X3JlcXVlc3RfaXNfYWN0aXZlKHJxKSkg
LyogdW53b3VuZCwgYnV0IGluY29tcGxldGUhICovCi0JCXJldHVybiBycTsKLQotCWxpc3QgPSAm
aTkxNV9yZXF1ZXN0X2FjdGl2ZV90aW1lbGluZShycSktPnJlcXVlc3RzOwotCWxpc3RfZm9yX2Vh
Y2hfZW50cnlfZnJvbV9yZXZlcnNlKHJxLCBsaXN0LCBsaW5rKSB7Ci0JCWlmIChpOTE1X3JlcXVl
c3RfY29tcGxldGVkKHJxKSkKLQkJCWJyZWFrOwotCi0JCWlmIChycS0+aHdfY29udGV4dCAhPSBj
ZSkKLQkJCWJyZWFrOwotCi0JCWFjdGl2ZSA9IHJxOwotCX0KLQotCXJldHVybiBhY3RpdmU7Ci19
Ci0KIHN0YXRpYyB2b2lkIF9fZXhlY2xpc3RzX3Jlc2V0X3JlZ19zdGF0ZShjb25zdCBzdHJ1Y3Qg
aW50ZWxfY29udGV4dCAqY2UsCiAJCQkJCWNvbnN0IHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVu
Z2luZSkKIHsKQEAgLTI4NDksNyArMjkxMSw2IEBAIHN0YXRpYyB2b2lkIF9fZXhlY2xpc3RzX3Jl
c2V0KHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSwgYm9vbCBzdGFsbGVkKQogCXN0cnVj
dCBpbnRlbF9lbmdpbmVfZXhlY2xpc3RzICogY29uc3QgZXhlY2xpc3RzID0gJmVuZ2luZS0+ZXhl
Y2xpc3RzOwogCXN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZTsKIAlzdHJ1Y3QgaTkxNV9yZXF1ZXN0
ICpycTsKLQl1MzIgKnJlZ3M7CiAKIAltYigpOyAvKiBwYXJhbm9pYTogcmVhZCB0aGUgQ1NCIHBv
aW50ZXJzIGZyb20gYWZ0ZXIgdGhlIHJlc2V0ICovCiAJY2xmbHVzaChleGVjbGlzdHMtPmNzYl93
cml0ZSk7CkBAIC0yOTI4LDEzICsyOTg5LDcgQEAgc3RhdGljIHZvaWQgX19leGVjbGlzdHNfcmVz
ZXQoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lLCBib29sIHN0YWxsZWQpCiAJICogdG8g
cmVjcmVhdGUgaXRzIG93biBzdGF0ZS4KIAkgKi8KIAlHRU1fQlVHX09OKCFpbnRlbF9jb250ZXh0
X2lzX3Bpbm5lZChjZSkpOwotCXJlZ3MgPSBjZS0+bHJjX3JlZ19zdGF0ZTsKLQlpZiAoZW5naW5l
LT5waW5uZWRfZGVmYXVsdF9zdGF0ZSkgewotCQltZW1jcHkocmVncywgLyogc2tpcCByZXN0b3Jp
bmcgdGhlIHZhbmlsbGEgUFBIV1NQICovCi0JCSAgICAgICBlbmdpbmUtPnBpbm5lZF9kZWZhdWx0
X3N0YXRlICsgTFJDX1NUQVRFX1BOICogUEFHRV9TSVpFLAotCQkgICAgICAgZW5naW5lLT5jb250
ZXh0X3NpemUgLSBQQUdFX1NJWkUpOwotCX0KLQlleGVjbGlzdHNfaW5pdF9yZWdfc3RhdGUocmVn
cywgY2UsIGVuZ2luZSwgY2UtPnJpbmcsIGZhbHNlKTsKKwlyZXN0b3JlX2RlZmF1bHRfc3RhdGUo
Y2UsIGVuZ2luZSk7CiAKIG91dF9yZXBsYXk6CiAJR0VNX1RSQUNFKCIlcyByZXBsYXkge2hlYWQ6
JTA0eCwgdGFpbDolMDR4XG4iLApAQCAtNDU3MSwxNiArNDYyNiw4IEBAIHZvaWQgaW50ZWxfbHJf
Y29udGV4dF9yZXNldChzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUsCiAJICogZnV0dXJl
IHJlcXVlc3Qgd2lsbCBiZSBhZnRlciB1c2Vyc3BhY2UgaGFzIGhhZCB0aGUgb3Bwb3J0dW5pdHkK
IAkgKiB0byByZWNyZWF0ZSBpdHMgb3duIHN0YXRlLgogCSAqLwotCWlmIChzY3J1YikgewotCQl1
MzIgKnJlZ3MgPSBjZS0+bHJjX3JlZ19zdGF0ZTsKLQotCQlpZiAoZW5naW5lLT5waW5uZWRfZGVm
YXVsdF9zdGF0ZSkgewotCQkJbWVtY3B5KHJlZ3MsIC8qIHNraXAgcmVzdG9yaW5nIHRoZSB2YW5p
bGxhIFBQSFdTUCAqLwotCQkJICAgICAgIGVuZ2luZS0+cGlubmVkX2RlZmF1bHRfc3RhdGUgKyBM
UkNfU1RBVEVfUE4gKiBQQUdFX1NJWkUsCi0JCQkgICAgICAgZW5naW5lLT5jb250ZXh0X3NpemUg
LSBQQUdFX1NJWkUpOwotCQl9Ci0JCWV4ZWNsaXN0c19pbml0X3JlZ19zdGF0ZShyZWdzLCBjZSwg
ZW5naW5lLCBjZS0+cmluZywgZmFsc2UpOwotCX0KKwlpZiAoc2NydWIpCisJCXJlc3RvcmVfZGVm
YXVsdF9zdGF0ZShjZSwgZW5naW5lKTsKIAogCS8qIFJlcnVuIHRoZSByZXF1ZXN0OyBpdHMgcGF5
bG9hZCBoYXMgYmVlbiBuZXV0ZXJlZCAoaWYgZ3VpbHR5KS4gKi8KIAljZS0+cmluZy0+aGVhZCA9
IGhlYWQ7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVzdF9scmMu
YyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L3NlbGZ0ZXN0X2xyYy5jCmluZGV4IGU3YTg2ZjYw
Y2Y4Mi4uZGQzZTdiNDdiNzZkIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9z
ZWxmdGVzdF9scmMuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVzdF9scmMu
YwpAQCAtNyw2ICs3LDcgQEAKICNpbmNsdWRlIDxsaW51eC9wcmltZV9udW1iZXJzLmg+CiAKICNp
bmNsdWRlICJnZW0vaTkxNV9nZW1fcG0uaCIKKyNpbmNsdWRlICJndC9pbnRlbF9lbmdpbmVfaGVh
cnRiZWF0LmgiCiAjaW5jbHVkZSAiZ3QvaW50ZWxfcmVzZXQuaCIKIAogI2luY2x1ZGUgImk5MTVf
c2VsZnRlc3QuaCIKQEAgLTEwMTYsNiArMTAxNywyNzcgQEAgc3RhdGljIGludCBsaXZlX25vcHJl
ZW1wdCh2b2lkICphcmcpCiAJZ290byBlcnJfY2xpZW50X2I7CiB9CiAKK3N0cnVjdCBsaXZlX3By
ZWVtcHRfY2FuY2VsIHsKKwlzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmU7CisJc3RydWN0
IHByZWVtcHRfY2xpZW50IGEsIGI7Cit9OworCitzdGF0aWMgaW50IF9fY2FuY2VsX2FjdGl2ZTAo
c3RydWN0IGxpdmVfcHJlZW1wdF9jYW5jZWwgKmFyZykKK3sKKwlzdHJ1Y3QgaTkxNV9yZXF1ZXN0
ICpycTsKKwlzdHJ1Y3QgaWd0X2xpdmVfdGVzdCB0OworCWludCBlcnI7CisKKwkvKiBQcmVlbXB0
IGNhbmNlbCBvZiBFTFNQMCAqLworCUdFTV9UUkFDRSgiJXMoJXMpXG4iLCBfX2Z1bmNfXywgYXJn
LT5lbmdpbmUtPm5hbWUpOworCisJaWYgKGlndF9saXZlX3Rlc3RfYmVnaW4oJnQsIGFyZy0+ZW5n
aW5lLT5pOTE1LAorCQkJCV9fZnVuY19fLCBhcmctPmVuZ2luZS0+bmFtZSkpCisJCXJldHVybiAt
RUlPOworCisJY2xlYXJfYml0KENPTlRFWFRfQkFOTkVELCAmYXJnLT5hLmN0eC0+ZmxhZ3MpOwor
CXJxID0gc3Bpbm5lcl9jcmVhdGVfcmVxdWVzdCgmYXJnLT5hLnNwaW4sCisJCQkJICAgIGFyZy0+
YS5jdHgsIGFyZy0+ZW5naW5lLAorCQkJCSAgICBNSV9BUkJfQ0hFQ0spOworCWlmIChJU19FUlIo
cnEpKQorCQlyZXR1cm4gUFRSX0VSUihycSk7CisKKwlpOTE1X3JlcXVlc3RfZ2V0KHJxKTsKKwlp
OTE1X3JlcXVlc3RfYWRkKHJxKTsKKwlpZiAoIWlndF93YWl0X2Zvcl9zcGlubmVyKCZhcmctPmEu
c3BpbiwgcnEpKSB7CisJCWVyciA9IC1FSU87CisJCWdvdG8gb3V0OworCX0KKworCWk5MTVfZ2Vt
X2NvbnRleHRfc2V0X2Jhbm5lZChhcmctPmEuY3R4KTsKKwllcnIgPSBpbnRlbF9lbmdpbmVfcHVs
c2UoYXJnLT5lbmdpbmUpOworCWlmIChlcnIpCisJCWdvdG8gb3V0OworCisJaWYgKGk5MTVfcmVx
dWVzdF93YWl0KHJxLCAwLCBIWiAvIDUpIDwgMCkgeworCQllcnIgPSAtRUlPOworCQlnb3RvIG91
dDsKKwl9CisKKwlpZiAocnEtPmZlbmNlLmVycm9yICE9IC1FSU8pIHsKKwkJcHJfZXJyKCJDYW5j
ZWxsZWQgaW5mbGlnaHQwIHJlcXVlc3QgZGlkIG5vdCByZXBvcnQgLUVJT1xuIik7CisJCWVyciA9
IC1FSU5WQUw7CisJCWdvdG8gb3V0OworCX0KKworb3V0OgorCWk5MTVfcmVxdWVzdF9wdXQocnEp
OworCWlmIChpZ3RfbGl2ZV90ZXN0X2VuZCgmdCkpCisJCWVyciA9IC1FSU87CisJcmV0dXJuIGVy
cjsKK30KKworc3RhdGljIGludCBfX2NhbmNlbF9hY3RpdmUxKHN0cnVjdCBsaXZlX3ByZWVtcHRf
Y2FuY2VsICphcmcpCit7CisJc3RydWN0IGk5MTVfcmVxdWVzdCAqcnFbMl0gPSB7fTsKKwlzdHJ1
Y3QgaWd0X2xpdmVfdGVzdCB0OworCWludCBlcnI7CisKKwkvKiBQcmVlbXB0IGNhbmNlbCBvZiBF
TFNQMSAqLworCUdFTV9UUkFDRSgiJXMoJXMpXG4iLCBfX2Z1bmNfXywgYXJnLT5lbmdpbmUtPm5h
bWUpOworCisJaWYgKGlndF9saXZlX3Rlc3RfYmVnaW4oJnQsIGFyZy0+ZW5naW5lLT5pOTE1LAor
CQkJCV9fZnVuY19fLCBhcmctPmVuZ2luZS0+bmFtZSkpCisJCXJldHVybiAtRUlPOworCisJY2xl
YXJfYml0KENPTlRFWFRfQkFOTkVELCAmYXJnLT5hLmN0eC0+ZmxhZ3MpOworCXJxWzBdID0gc3Bp
bm5lcl9jcmVhdGVfcmVxdWVzdCgmYXJnLT5hLnNwaW4sCisJCQkJICAgICAgIGFyZy0+YS5jdHgs
IGFyZy0+ZW5naW5lLAorCQkJCSAgICAgICBNSV9OT09QKTsgLyogbm8gcHJlZW1wdGlvbiAqLwor
CWlmIChJU19FUlIocnFbMF0pKQorCQlyZXR1cm4gUFRSX0VSUihycVswXSk7CisKKwlpOTE1X3Jl
cXVlc3RfZ2V0KHJxWzBdKTsKKwlpOTE1X3JlcXVlc3RfYWRkKHJxWzBdKTsKKwlpZiAoIWlndF93
YWl0X2Zvcl9zcGlubmVyKCZhcmctPmEuc3BpbiwgcnFbMF0pKSB7CisJCWVyciA9IC1FSU87CisJ
CWdvdG8gb3V0OworCX0KKworCWNsZWFyX2JpdChDT05URVhUX0JBTk5FRCwgJmFyZy0+Yi5jdHgt
PmZsYWdzKTsKKwlycVsxXSA9IHNwaW5uZXJfY3JlYXRlX3JlcXVlc3QoJmFyZy0+Yi5zcGluLAor
CQkJCSAgICAgICBhcmctPmIuY3R4LCBhcmctPmVuZ2luZSwKKwkJCQkgICAgICAgTUlfQVJCX0NI
RUNLKTsKKwlpZiAoSVNfRVJSKHJxWzFdKSkgeworCQllcnIgPSBQVFJfRVJSKHJxWzFdKTsKKwkJ
Z290byBvdXQ7CisJfQorCisJaTkxNV9yZXF1ZXN0X2dldChycVsxXSk7CisJZXJyID0gaTkxNV9y
ZXF1ZXN0X2F3YWl0X2RtYV9mZW5jZShycVsxXSwgJnJxWzBdLT5mZW5jZSk7CisJaTkxNV9yZXF1
ZXN0X2FkZChycVsxXSk7CisJaWYgKGVycikKKwkJZ290byBvdXQ7CisKKwlpOTE1X2dlbV9jb250
ZXh0X3NldF9iYW5uZWQoYXJnLT5iLmN0eCk7CisJZXJyID0gaW50ZWxfZW5naW5lX3B1bHNlKGFy
Zy0+ZW5naW5lKTsKKwlpZiAoZXJyKQorCQlnb3RvIG91dDsKKworCWlndF9zcGlubmVyX2VuZCgm
YXJnLT5hLnNwaW4pOworCWlmIChpOTE1X3JlcXVlc3Rfd2FpdChycVsxXSwgMCwgSFogLyA1KSA8
IDApIHsKKwkJZXJyID0gLUVJTzsKKwkJZ290byBvdXQ7CisJfQorCisJaWYgKHJxWzBdLT5mZW5j
ZS5lcnJvciAhPSAwKSB7CisJCXByX2VycigiTm9ybWFsIGluZmxpZ2h0MCByZXF1ZXN0IGRpZCBu
b3QgY29tcGxldGVcbiIpOworCQllcnIgPSAtRUlOVkFMOworCQlnb3RvIG91dDsKKwl9CisKKwlp
ZiAocnFbMV0tPmZlbmNlLmVycm9yICE9IC1FSU8pIHsKKwkJcHJfZXJyKCJDYW5jZWxsZWQgaW5m
bGlnaHQxIHJlcXVlc3QgZGlkIG5vdCByZXBvcnQgLUVJT1xuIik7CisJCWVyciA9IC1FSU5WQUw7
CisJCWdvdG8gb3V0OworCX0KKworb3V0OgorCWk5MTVfcmVxdWVzdF9wdXQocnFbMV0pOworCWk5
MTVfcmVxdWVzdF9wdXQocnFbMF0pOworCWlmIChpZ3RfbGl2ZV90ZXN0X2VuZCgmdCkpCisJCWVy
ciA9IC1FSU87CisJcmV0dXJuIGVycjsKK30KKworc3RhdGljIGludCBfX2NhbmNlbF9xdWV1ZWQo
c3RydWN0IGxpdmVfcHJlZW1wdF9jYW5jZWwgKmFyZykKK3sKKwlzdHJ1Y3QgaTkxNV9yZXF1ZXN0
ICpycVszXSA9IHt9OworCXN0cnVjdCBpZ3RfbGl2ZV90ZXN0IHQ7CisJaW50IGVycjsKKworCS8q
IEZ1bGwgRUxTUCBhbmQgb25lIGluIHRoZSB3aW5ncyAqLworCUdFTV9UUkFDRSgiJXMoJXMpXG4i
LCBfX2Z1bmNfXywgYXJnLT5lbmdpbmUtPm5hbWUpOworCisJaWYgKGlndF9saXZlX3Rlc3RfYmVn
aW4oJnQsIGFyZy0+ZW5naW5lLT5pOTE1LAorCQkJCV9fZnVuY19fLCBhcmctPmVuZ2luZS0+bmFt
ZSkpCisJCXJldHVybiAtRUlPOworCisJY2xlYXJfYml0KENPTlRFWFRfQkFOTkVELCAmYXJnLT5h
LmN0eC0+ZmxhZ3MpOworCXJxWzBdID0gc3Bpbm5lcl9jcmVhdGVfcmVxdWVzdCgmYXJnLT5hLnNw
aW4sCisJCQkJICAgICAgIGFyZy0+YS5jdHgsIGFyZy0+ZW5naW5lLAorCQkJCSAgICAgICBNSV9B
UkJfQ0hFQ0spOworCWlmIChJU19FUlIocnFbMF0pKQorCQlyZXR1cm4gUFRSX0VSUihycVswXSk7
CisKKwlpOTE1X3JlcXVlc3RfZ2V0KHJxWzBdKTsKKwlpOTE1X3JlcXVlc3RfYWRkKHJxWzBdKTsK
KwlpZiAoIWlndF93YWl0X2Zvcl9zcGlubmVyKCZhcmctPmEuc3BpbiwgcnFbMF0pKSB7CisJCWVy
ciA9IC1FSU87CisJCWdvdG8gb3V0OworCX0KKworCWNsZWFyX2JpdChDT05URVhUX0JBTk5FRCwg
JmFyZy0+Yi5jdHgtPmZsYWdzKTsKKwlycVsxXSA9IGlndF9yZXF1ZXN0X2FsbG9jKGFyZy0+Yi5j
dHgsIGFyZy0+ZW5naW5lKTsKKwlpZiAoSVNfRVJSKHJxWzFdKSkgeworCQllcnIgPSBQVFJfRVJS
KHJxWzFdKTsKKwkJZ290byBvdXQ7CisJfQorCisJaTkxNV9yZXF1ZXN0X2dldChycVsxXSk7CisJ
ZXJyID0gaTkxNV9yZXF1ZXN0X2F3YWl0X2RtYV9mZW5jZShycVsxXSwgJnJxWzBdLT5mZW5jZSk7
CisJaTkxNV9yZXF1ZXN0X2FkZChycVsxXSk7CisJaWYgKGVycikKKwkJZ290byBvdXQ7CisKKwly
cVsyXSA9IHNwaW5uZXJfY3JlYXRlX3JlcXVlc3QoJmFyZy0+Yi5zcGluLAorCQkJCSAgICAgICBh
cmctPmEuY3R4LCBhcmctPmVuZ2luZSwKKwkJCQkgICAgICAgTUlfQVJCX0NIRUNLKTsKKwlpZiAo
SVNfRVJSKHJxWzJdKSkgeworCQllcnIgPSBQVFJfRVJSKHJxWzJdKTsKKwkJZ290byBvdXQ7CisJ
fQorCisJaTkxNV9yZXF1ZXN0X2dldChycVsyXSk7CisJZXJyID0gaTkxNV9yZXF1ZXN0X2F3YWl0
X2RtYV9mZW5jZShycVsyXSwgJnJxWzFdLT5mZW5jZSk7CisJaTkxNV9yZXF1ZXN0X2FkZChycVsy
XSk7CisJaWYgKGVycikKKwkJZ290byBvdXQ7CisKKwlpOTE1X2dlbV9jb250ZXh0X3NldF9iYW5u
ZWQoYXJnLT5hLmN0eCk7CisJZXJyID0gaW50ZWxfZW5naW5lX3B1bHNlKGFyZy0+ZW5naW5lKTsK
KwlpZiAoZXJyKQorCQlnb3RvIG91dDsKKworCWlmIChpOTE1X3JlcXVlc3Rfd2FpdChycVsyXSwg
MCwgSFogLyA1KSA8IDApIHsKKwkJZXJyID0gLUVJTzsKKwkJZ290byBvdXQ7CisJfQorCisJaWYg
KHJxWzBdLT5mZW5jZS5lcnJvciAhPSAtRUlPKSB7CisJCXByX2VycigiQ2FuY2VsbGVkIGluZmxp
Z2h0MCByZXF1ZXN0IGRpZCBub3QgcmVwb3J0IC1FSU9cbiIpOworCQllcnIgPSAtRUlOVkFMOwor
CQlnb3RvIG91dDsKKwl9CisKKwlpZiAocnFbMV0tPmZlbmNlLmVycm9yICE9IDApIHsKKwkJcHJf
ZXJyKCJOb3JtYWwgaW5mbGlnaHQxIHJlcXVlc3QgZGlkIG5vdCBjb21wbGV0ZVxuIik7CisJCWVy
ciA9IC1FSU5WQUw7CisJCWdvdG8gb3V0OworCX0KKworCWlmIChycVsyXS0+ZmVuY2UuZXJyb3Ig
IT0gLUVJTykgeworCQlwcl9lcnIoIkNhbmNlbGxlZCBxdWV1ZWQgcmVxdWVzdCBkaWQgbm90IHJl
cG9ydCAtRUlPXG4iKTsKKwkJZXJyID0gLUVJTlZBTDsKKwkJZ290byBvdXQ7CisJfQorCitvdXQ6
CisJaTkxNV9yZXF1ZXN0X3B1dChycVsyXSk7CisJaTkxNV9yZXF1ZXN0X3B1dChycVsxXSk7CisJ
aTkxNV9yZXF1ZXN0X3B1dChycVswXSk7CisJaWYgKGlndF9saXZlX3Rlc3RfZW5kKCZ0KSkKKwkJ
ZXJyID0gLUVJTzsKKwlyZXR1cm4gZXJyOworfQorCitzdGF0aWMgaW50IGxpdmVfcHJlZW1wdF9j
YW5jZWwodm9pZCAqYXJnKQoreworCXN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1ID0gYXJn
OworCXN0cnVjdCBsaXZlX3ByZWVtcHRfY2FuY2VsIGRhdGE7CisJZW51bSBpbnRlbF9lbmdpbmVf
aWQgaWQ7CisJaW50IGVyciA9IC1FTk9NRU07CisKKwkvKgorCSAqIFRvIGNhbmNlbCBhbiBpbmZs
aWdodCBjb250ZXh0LCB3ZSBuZWVkIHRvIGZpcnN0IHJlbW92ZSBpdCBmcm9tIHRoZQorCSAqIEdQ
VS4gVGhhdCBzb3VuZHMgbGlrZSBwcmVlbXB0aW9uISBQbHVzIGEgbGl0dGxlIGJpdCBvZiBib29r
a2VlcGluZy4KKwkgKi8KKworCWlmICghSEFTX0xPR0lDQUxfUklOR19QUkVFTVBUSU9OKGk5MTUp
KQorCQlyZXR1cm4gMDsKKworCWlmIChwcmVlbXB0X2NsaWVudF9pbml0KGk5MTUsICZkYXRhLmEp
KQorCQlyZXR1cm4gLUVOT01FTTsKKwlpZiAocHJlZW1wdF9jbGllbnRfaW5pdChpOTE1LCAmZGF0
YS5iKSkKKwkJZ290byBlcnJfY2xpZW50X2E7CisKKwlmb3JfZWFjaF9lbmdpbmUoZGF0YS5lbmdp
bmUsIGk5MTUsIGlkKSB7CisJCWlmICghaW50ZWxfZW5naW5lX2hhc19wcmVlbXB0aW9uKGRhdGEu
ZW5naW5lKSkKKwkJCWNvbnRpbnVlOworCisJCWVyciA9IF9fY2FuY2VsX2FjdGl2ZTAoJmRhdGEp
OworCQlpZiAoZXJyKQorCQkJZ290byBlcnJfd2VkZ2VkOworCisJCWVyciA9IF9fY2FuY2VsX2Fj
dGl2ZTEoJmRhdGEpOworCQlpZiAoZXJyKQorCQkJZ290byBlcnJfd2VkZ2VkOworCisJCWVyciA9
IF9fY2FuY2VsX3F1ZXVlZCgmZGF0YSk7CisJCWlmIChlcnIpCisJCQlnb3RvIGVycl93ZWRnZWQ7
CisJfQorCisJZXJyID0gMDsKK2Vycl9jbGllbnRfYjoKKwlwcmVlbXB0X2NsaWVudF9maW5pKCZk
YXRhLmIpOworZXJyX2NsaWVudF9hOgorCXByZWVtcHRfY2xpZW50X2ZpbmkoJmRhdGEuYSk7CisJ
cmV0dXJuIGVycjsKKworZXJyX3dlZGdlZDoKKwlHRU1fVFJBQ0VfRFVNUCgpOworCWlndF9zcGlu
bmVyX2VuZCgmZGF0YS5iLnNwaW4pOworCWlndF9zcGlubmVyX2VuZCgmZGF0YS5hLnNwaW4pOwor
CWludGVsX2d0X3NldF93ZWRnZWQoJmk5MTUtPmd0KTsKKwlnb3RvIGVycl9jbGllbnRfYjsKK30K
Kwogc3RhdGljIGludCBsaXZlX3N1cHByZXNzX3NlbGZfcHJlZW1wdCh2b2lkICphcmcpCiB7CiAJ
c3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUgPSBhcmc7CkBAIC0yNTQ5LDYgKzI4MjEsNyBA
QCBpbnQgaW50ZWxfZXhlY2xpc3RzX2xpdmVfc2VsZnRlc3RzKHN0cnVjdCBkcm1faTkxNV9wcml2
YXRlICppOTE1KQogCQlTVUJURVNUKGxpdmVfcHJlZW1wdCksCiAJCVNVQlRFU1QobGl2ZV9sYXRl
X3ByZWVtcHQpLAogCQlTVUJURVNUKGxpdmVfbm9wcmVlbXB0KSwKKwkJU1VCVEVTVChsaXZlX3By
ZWVtcHRfY2FuY2VsKSwKIAkJU1VCVEVTVChsaXZlX3N1cHByZXNzX3NlbGZfcHJlZW1wdCksCiAJ
CVNVQlRFU1QobGl2ZV9zdXBwcmVzc193YWl0X3ByZWVtcHQpLAogCQlTVUJURVNUKGxpdmVfY2hh
aW5fcHJlZW1wdCksCi0tIAoyLjIzLjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZy
ZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3Rp
bmZvL2ludGVsLWdmeA==

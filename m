Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 4AF79175671
	for <lists+intel-gfx@lfdr.de>; Mon,  2 Mar 2020 09:59:10 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 278636E1B3;
	Mon,  2 Mar 2020 08:58:53 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 18FCC6E150
 for <intel-gfx@lists.freedesktop.org>; Mon,  2 Mar 2020 08:58:49 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 20409423-1500050 
 for multiple; Mon, 02 Mar 2020 08:58:24 +0000
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon,  2 Mar 2020 08:58:07 +0000
Message-Id: <20200302085812.4172450-17-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20200302085812.4172450-1-chris@chris-wilson.co.uk>
References: <20200302085812.4172450-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 17/22] dma-buf: Proxy fence,
 an unsignaled fence placeholder
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

T2Z0ZW4gd2UgbmVlZCB0byBjcmVhdGUgYSBmZW5jZSBmb3IgYSBmdXR1cmUgZXZlbnQgdGhhdCBo
YXMgbm90IHlldCBiZWVuCmFzc29jaWF0ZWQgd2l0aCBhIGZlbmNlLiBXZSBjYW4gc3RvcmUgYSBw
cm94eSBmZW5jZSwgYSBwbGFjZWhvbGRlciwgaW4KdGhlIHRpbWVsaW5lIGFuZCByZXBsYWNlIGl0
IGxhdGVyIHdoZW4gdGhlIHJlYWwgZmVuY2UgaXMga25vd24uIEFueQpsaXN0ZW5lcnMgdGhhdCBh
dHRhY2ggdG8gdGhlIHByb3h5IGZlbmNlIHdpbGwgYXV0b21hdGljYWxseSBiZSBzaWduYWxlZAp3
aGVuIHRoZSByZWFsIGZlbmNlIGNvbXBsZXRlcywgYW5kIGFueSBmdXR1cmUgbGlzdGVuZXJzIHdp
bGwgaW5zdGVhZCBiZQphdHRhY2ggZGlyZWN0bHkgdG8gdGhlIHJlYWwgZmVuY2UgYXZvaWRpbmcg
YW55IGluZGlyZWN0aW9uIG92ZXJoZWFkLgoKU2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxj
aHJpc0BjaHJpcy13aWxzb24uY28udWs+CkNjOiBMaW9uZWwgTGFuZHdlcmxpbiA8bGlvbmVsLmcu
bGFuZHdlcmxpbkBpbnRlbC5jb20+Ci0tLQogZHJpdmVycy9kbWEtYnVmL01ha2VmaWxlICAgICAg
ICAgICAgIHwgIDEzICstCiBkcml2ZXJzL2RtYS1idWYvZG1hLWZlbmNlLXByaXZhdGUuaCAgfCAg
MjAgKwogZHJpdmVycy9kbWEtYnVmL2RtYS1mZW5jZS1wcm94eS5jICAgIHwgMTg4ICsrKysrKysr
KysKIGRyaXZlcnMvZG1hLWJ1Zi9kbWEtZmVuY2UuYyAgICAgICAgICB8ICAgNCArLQogZHJpdmVy
cy9kbWEtYnVmL3NlbGZ0ZXN0cy5oICAgICAgICAgIHwgICAxICsKIGRyaXZlcnMvZG1hLWJ1Zi9z
dC1kbWEtZmVuY2UtcHJveHkuYyB8IDU0MSArKysrKysrKysrKysrKysrKysrKysrKysrKysKIGlu
Y2x1ZGUvbGludXgvZG1hLWZlbmNlLXByb3h5LmggICAgICB8ICAyMCArCiA3IGZpbGVzIGNoYW5n
ZWQsIDc4MyBpbnNlcnRpb25zKCspLCA0IGRlbGV0aW9ucygtKQogY3JlYXRlIG1vZGUgMTAwNjQ0
IGRyaXZlcnMvZG1hLWJ1Zi9kbWEtZmVuY2UtcHJpdmF0ZS5oCiBjcmVhdGUgbW9kZSAxMDA2NDQg
ZHJpdmVycy9kbWEtYnVmL2RtYS1mZW5jZS1wcm94eS5jCiBjcmVhdGUgbW9kZSAxMDA2NDQgZHJp
dmVycy9kbWEtYnVmL3N0LWRtYS1mZW5jZS1wcm94eS5jCiBjcmVhdGUgbW9kZSAxMDA2NDQgaW5j
bHVkZS9saW51eC9kbWEtZmVuY2UtcHJveHkuaAoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZG1hLWJ1
Zi9NYWtlZmlsZSBiL2RyaXZlcnMvZG1hLWJ1Zi9NYWtlZmlsZQppbmRleCA5OTVlMDVmNjA5ZmYu
LmFmYWY2ZGFkZDlhMyAxMDA2NDQKLS0tIGEvZHJpdmVycy9kbWEtYnVmL01ha2VmaWxlCisrKyBi
L2RyaXZlcnMvZG1hLWJ1Zi9NYWtlZmlsZQpAQCAtMSw2ICsxLDEyIEBACiAjIFNQRFgtTGljZW5z
ZS1JZGVudGlmaWVyOiBHUEwtMi4wLW9ubHkKLW9iai15IDo9IGRtYS1idWYubyBkbWEtZmVuY2Uu
byBkbWEtZmVuY2UtYXJyYXkubyBkbWEtZmVuY2UtY2hhaW4ubyBcCi0JIGRtYS1yZXN2Lm8gc2Vx
bm8tZmVuY2Uubworb2JqLXkgOj0gXAorCWRtYS1idWYubyBcCisJZG1hLWZlbmNlLm8gXAorCWRt
YS1mZW5jZS1hcnJheS5vIFwKKwlkbWEtZmVuY2UtY2hhaW4ubyBcCisJZG1hLWZlbmNlLXByb3h5
Lm8gXAorCWRtYS1yZXN2Lm8gXAorCXNlcW5vLWZlbmNlLm8KIG9iai0kKENPTkZJR19ETUFCVUZf
SEVBUFMpCSs9IGRtYS1oZWFwLm8KIG9iai0kKENPTkZJR19ETUFCVUZfSEVBUFMpCSs9IGhlYXBz
Lwogb2JqLSQoQ09ORklHX1NZTkNfRklMRSkJCSs9IHN5bmNfZmlsZS5vCkBAIC0xMCw2ICsxNiw3
IEBAIG9iai0kKENPTkZJR19VRE1BQlVGKQkJKz0gdWRtYWJ1Zi5vCiBkbWFidWZfc2VsZnRlc3Rz
LXkgOj0gXAogCXNlbGZ0ZXN0Lm8gXAogCXN0LWRtYS1mZW5jZS5vIFwKLQlzdC1kbWEtZmVuY2Ut
Y2hhaW4ubworCXN0LWRtYS1mZW5jZS1jaGFpbi5vIFwKKwlzdC1kbWEtZmVuY2UtcHJveHkubwog
CiBvYmotJChDT05GSUdfRE1BQlVGX1NFTEZURVNUUykJKz0gZG1hYnVmX3NlbGZ0ZXN0cy5vCmRp
ZmYgLS1naXQgYS9kcml2ZXJzL2RtYS1idWYvZG1hLWZlbmNlLXByaXZhdGUuaCBiL2RyaXZlcnMv
ZG1hLWJ1Zi9kbWEtZmVuY2UtcHJpdmF0ZS5oCm5ldyBmaWxlIG1vZGUgMTAwNjQ0CmluZGV4IDAw
MDAwMDAwMDAwMC4uNjkyNGQyOGFmMGZhCi0tLSAvZGV2L251bGwKKysrIGIvZHJpdmVycy9kbWEt
YnVmL2RtYS1mZW5jZS1wcml2YXRlLmgKQEAgLTAsMCArMSwyMCBAQAorLyogU1BEWC1MaWNlbnNl
LUlkZW50aWZpZXI6IEdQTC0yLjAtb25seSAqLworLyoKKyAqIEZlbmNlIG1lY2hhbmlzbSBmb3Ig
ZG1hLWJ1ZiBhbmQgdG8gYWxsb3cgZm9yIGFzeW5jaHJvbm91cyBkbWEgYWNjZXNzCisgKgorICog
Q29weXJpZ2h0IChDKSAyMDEyIENhbm9uaWNhbCBMdGQKKyAqIENvcHlyaWdodCAoQykgMjAxMiBU
ZXhhcyBJbnN0cnVtZW50cworICoKKyAqIEF1dGhvcnM6CisgKiBSb2IgQ2xhcmsgPHJvYmRjbGFy
a0BnbWFpbC5jb20+CisgKiBNYWFydGVuIExhbmtob3JzdCA8bWFhcnRlbi5sYW5raG9yc3RAY2Fu
b25pY2FsLmNvbT4KKyAqLworCisjaWZuZGVmIERNQV9GRU5DRV9QUklWQVRFX0gKKyNkZWZpbmUg
RE1BX0ZFTkNFX1BSSUFWVEVfSAorCitzdHJ1Y3QgZG1hX2ZlbmNlOworCitib29sIF9fZG1hX2Zl
bmNlX2VuYWJsZV9zaWduYWxpbmcoc3RydWN0IGRtYV9mZW5jZSAqZmVuY2UpOworCisjZW5kaWYg
LyogRE1BX0ZFTkNFX1BSSUFWVEVfSCAqLwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9kbWEtYnVmL2Rt
YS1mZW5jZS1wcm94eS5jIGIvZHJpdmVycy9kbWEtYnVmL2RtYS1mZW5jZS1wcm94eS5jCm5ldyBm
aWxlIG1vZGUgMTAwNjQ0CmluZGV4IDAwMDAwMDAwMDAwMC4uMmNjMDAwMmRjNDdmCi0tLSAvZGV2
L251bGwKKysrIGIvZHJpdmVycy9kbWEtYnVmL2RtYS1mZW5jZS1wcm94eS5jCkBAIC0wLDAgKzEs
MTg4IEBACisvLyBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogR1BMLTIuMC1vbmx5CisvKgorICog
ZG1hLWZlbmNlLXByb3h5OiBwbGFjZWhvbGRlciB1bnNpZ25hbGVkIGZlbmNlCisgKgorICogQ29w
eXJpZ2h0IChDKSAyMDE3LTIwMTkgSW50ZWwgQ29ycG9yYXRpb24KKyAqLworCisjaW5jbHVkZSA8
bGludXgvZG1hLWZlbmNlLmg+CisjaW5jbHVkZSA8bGludXgvZG1hLWZlbmNlLXByb3h5Lmg+Cisj
aW5jbHVkZSA8bGludXgvZXhwb3J0Lmg+CisjaW5jbHVkZSA8bGludXgvaXJxX3dvcmsuaD4KKyNp
bmNsdWRlIDxsaW51eC9zbGFiLmg+CisKKyNpbmNsdWRlICJkbWEtZmVuY2UtcHJpdmF0ZS5oIgor
CitzdHJ1Y3QgZG1hX2ZlbmNlX3Byb3h5IHsKKwlzdHJ1Y3QgZG1hX2ZlbmNlIGJhc2U7CisJc3Bp
bmxvY2tfdCBsb2NrOworCisJc3RydWN0IGRtYV9mZW5jZSAqcmVhbDsKKwlzdHJ1Y3QgZG1hX2Zl
bmNlX2NiIGNiOworCXN0cnVjdCBpcnFfd29yayB3b3JrOworfTsKKworc3RhdGljIGNvbnN0IGNo
YXIgKnByb3h5X2dldF9kcml2ZXJfbmFtZShzdHJ1Y3QgZG1hX2ZlbmNlICpmZW5jZSkKK3sKKwlz
dHJ1Y3QgZG1hX2ZlbmNlX3Byb3h5ICpwID0gY29udGFpbmVyX29mKGZlbmNlLCB0eXBlb2YoKnAp
LCBiYXNlKTsKKwlzdHJ1Y3QgZG1hX2ZlbmNlICpyZWFsID0gUkVBRF9PTkNFKHAtPnJlYWwpOwor
CisJcmV0dXJuIHJlYWwgPyByZWFsLT5vcHMtPmdldF9kcml2ZXJfbmFtZShyZWFsKSA6ICJwcm94
eSI7Cit9CisKK3N0YXRpYyBjb25zdCBjaGFyICpwcm94eV9nZXRfdGltZWxpbmVfbmFtZShzdHJ1
Y3QgZG1hX2ZlbmNlICpmZW5jZSkKK3sKKwlzdHJ1Y3QgZG1hX2ZlbmNlX3Byb3h5ICpwID0gY29u
dGFpbmVyX29mKGZlbmNlLCB0eXBlb2YoKnApLCBiYXNlKTsKKwlzdHJ1Y3QgZG1hX2ZlbmNlICpy
ZWFsID0gUkVBRF9PTkNFKHAtPnJlYWwpOworCisJcmV0dXJuIHJlYWwgPyByZWFsLT5vcHMtPmdl
dF90aW1lbGluZV9uYW1lKHJlYWwpIDogInVuc2V0IjsKK30KKworc3RhdGljIHZvaWQgcHJveHlf
aXJxX3dvcmsoc3RydWN0IGlycV93b3JrICp3b3JrKQoreworCXN0cnVjdCBkbWFfZmVuY2VfcHJv
eHkgKnAgPSBjb250YWluZXJfb2Yod29yaywgdHlwZW9mKCpwKSwgd29yayk7CisKKwlkbWFfZmVu
Y2Vfc2lnbmFsKCZwLT5iYXNlKTsKKwlkbWFfZmVuY2VfcHV0KCZwLT5iYXNlKTsKK30KKworc3Rh
dGljIHZvaWQgcHJveHlfY2FsbGJhY2soc3RydWN0IGRtYV9mZW5jZSAqcmVhbCwgc3RydWN0IGRt
YV9mZW5jZV9jYiAqY2IpCit7CisJc3RydWN0IGRtYV9mZW5jZV9wcm94eSAqcCA9IGNvbnRhaW5l
cl9vZihjYiwgdHlwZW9mKCpwKSwgY2IpOworCisJaWYgKHJlYWwtPmVycm9yKQorCQlkbWFfZmVu
Y2Vfc2V0X2Vycm9yKCZwLT5iYXNlLCByZWFsLT5lcnJvcik7CisKKwlpcnFfd29ya19xdWV1ZSgm
cC0+d29yayk7Cit9CisKK3N0YXRpYyBib29sIHByb3h5X2VuYWJsZV9zaWduYWxpbmcoc3RydWN0
IGRtYV9mZW5jZSAqZmVuY2UpCit7CisJc3RydWN0IGRtYV9mZW5jZV9wcm94eSAqcCA9IGNvbnRh
aW5lcl9vZihmZW5jZSwgdHlwZW9mKCpwKSwgYmFzZSk7CisJc3RydWN0IGRtYV9mZW5jZSAqcmVh
bCA9IFJFQURfT05DRShwLT5yZWFsKTsKKwlib29sIHJldCA9IHRydWU7CisKKwlpZiAocmVhbCkg
eworCQlzcGluX2xvY2tfbmVzdGVkKHJlYWwtPmxvY2ssIFNJTkdMRV9ERVBUSF9ORVNUSU5HKTsK
KwkJcmV0ID0gX19kbWFfZmVuY2VfZW5hYmxlX3NpZ25hbGluZyhyZWFsKTsKKwkJc3Bpbl91bmxv
Y2socmVhbC0+bG9jayk7CisJfQorCisJcmV0dXJuIHJldDsKK30KKworc3RhdGljIHZvaWQgcHJv
eHlfcmVsZWFzZShzdHJ1Y3QgZG1hX2ZlbmNlICpmZW5jZSkKK3sKKwlzdHJ1Y3QgZG1hX2ZlbmNl
X3Byb3h5ICpwID0gY29udGFpbmVyX29mKGZlbmNlLCB0eXBlb2YoKnApLCBiYXNlKTsKKworCWRt
YV9mZW5jZV9wdXQocC0+cmVhbCk7CisJZG1hX2ZlbmNlX2ZyZWUoJnAtPmJhc2UpOworfQorCitz
dGF0aWMgY29uc3Qgc3RydWN0IGRtYV9mZW5jZV9vcHMgZG1hX2ZlbmNlX3Byb3h5X29wcyA9IHsK
KwkuZ2V0X2RyaXZlcl9uYW1lID0gcHJveHlfZ2V0X2RyaXZlcl9uYW1lLAorCS5nZXRfdGltZWxp
bmVfbmFtZSA9IHByb3h5X2dldF90aW1lbGluZV9uYW1lLAorCS5lbmFibGVfc2lnbmFsaW5nID0g
cHJveHlfZW5hYmxlX3NpZ25hbGluZywKKwkud2FpdCA9IGRtYV9mZW5jZV9kZWZhdWx0X3dhaXQs
CisJLnJlbGVhc2UgPSBwcm94eV9yZWxlYXNlLAorfTsKKworLyoqCisgKiBkbWFfZmVuY2VfY3Jl
YXRlX3Byb3h5IC0gQ3JlYXRlIGFuIHVuc2V0IGRtYS1mZW5jZQorICoKKyAqIGRtYV9mZW5jZV9j
cmVhdGVfcHJveHkoKSBjcmVhdGVzIGEgbmV3IGRtYV9mZW5jZSBzdHViIHRoYXQgaXMgaW5pdGlh
bGx5CisgKiB1bnNpZ25hbGVkIGFuZCBtYXkgbGF0ZXIgYmUgcmVwbGFjZWQgd2l0aCBhIHJlYWwg
ZmVuY2UuIEFueSBsaXN0ZW5lcnMKKyAqIHRvIHRoZSBwcm94eSBmZW5jZSB3aWxsIGJlIHNpZ25h
bGVkIHdoZW4gdGhlIHRhcmdldCBmZW5jZSBzaWduYWxzIGl0cworICogY29tcGxldGlvbi4KKyAq
Lworc3RydWN0IGRtYV9mZW5jZSAqZG1hX2ZlbmNlX2NyZWF0ZV9wcm94eSh2b2lkKQoreworCXN0
cnVjdCBkbWFfZmVuY2VfcHJveHkgKnA7CisKKwlwID0ga3phbGxvYyhzaXplb2YoKnApLCBHRlBf
S0VSTkVMKTsKKwlpZiAoIXApCisJCXJldHVybiBOVUxMOworCisJc3Bpbl9sb2NrX2luaXQoJnAt
PmxvY2spOworCWRtYV9mZW5jZV9pbml0KCZwLT5iYXNlLCAmZG1hX2ZlbmNlX3Byb3h5X29wcywg
JnAtPmxvY2ssCisJCSAgICAgICBkbWFfZmVuY2VfY29udGV4dF9hbGxvYygxKSwgMCk7CisJaW5p
dF9pcnFfd29yaygmcC0+d29yaywgcHJveHlfaXJxX3dvcmspOworCisJcmV0dXJuICZwLT5iYXNl
OworfQorRVhQT1JUX1NZTUJPTChkbWFfZmVuY2VfY3JlYXRlX3Byb3h5KTsKKworc3RhdGljIHZv
aWQgd3JhcF9zaWduYWxfbG9ja2VkKHN0cnVjdCBkbWFfZmVuY2UgKmZlbmNlLCBzdHJ1Y3QgZG1h
X2ZlbmNlICpyZWFsKQoreworCWlmIChyZWFsLT5lcnJvcikKKwkJZG1hX2ZlbmNlX3NldF9lcnJv
cihmZW5jZSwgcmVhbC0+ZXJyb3IpOworCWRtYV9mZW5jZV9zaWduYWxfbG9ja2VkKGZlbmNlKTsK
K30KKworc3RhdGljIHZvaWQgcHJveHlfYXNzaWduKHN0cnVjdCBkbWFfZmVuY2UgKmZlbmNlLCBz
dHJ1Y3QgZG1hX2ZlbmNlICpyZWFsKQoreworCXN0cnVjdCBkbWFfZmVuY2VfcHJveHkgKnAgPSBj
b250YWluZXJfb2YoZmVuY2UsIHR5cGVvZigqcCksIGJhc2UpOworCXVuc2lnbmVkIGxvbmcgZmxh
Z3M7CisKKwlpZiAoV0FSTl9PTihmZW5jZSA9PSByZWFsKSkKKwkJcmV0dXJuOworCisJaWYgKFdB
Uk5fT04odGVzdF9iaXQoRE1BX0ZFTkNFX0ZMQUdfU0lHTkFMRURfQklULCAmZmVuY2UtPmZsYWdz
KSkpCisJCXJldHVybjsKKworCWlmIChXQVJOX09OKHAtPnJlYWwpKQorCQlyZXR1cm47CisKKwlz
cGluX2xvY2tfaXJxc2F2ZShwLT5iYXNlLmxvY2ssIGZsYWdzKTsKKworCWlmICh1bmxpa2VseSgh
cmVhbCkpIHsKKwkJZG1hX2ZlbmNlX3NpZ25hbF9sb2NrZWQoJnAtPmJhc2UpOworCQlnb3RvIHVu
bG9jazsKKwl9CisKKwlwLT5yZWFsID0gZG1hX2ZlbmNlX2dldChyZWFsKTsKKworCXNwaW5fbG9j
a19uZXN0ZWQocmVhbC0+bG9jaywgU0lOR0xFX0RFUFRIX05FU1RJTkcpOworCWlmIChkbWFfZmVu
Y2VfaXNfc2lnbmFsZWQocmVhbCkpIHsKKwkJd3JhcF9zaWduYWxfbG9ja2VkKCZwLT5iYXNlLCBy
ZWFsKTsKKwl9IGVsc2UgaWYgKHRlc3RfYml0KERNQV9GRU5DRV9GTEFHX0VOQUJMRV9TSUdOQUxf
QklULAorCQkJICAgICZwLT5iYXNlLmZsYWdzKSAmJgorCQkgICAhX19kbWFfZmVuY2VfZW5hYmxl
X3NpZ25hbGluZyhyZWFsKSkgeworCQl3cmFwX3NpZ25hbF9sb2NrZWQoJnAtPmJhc2UsIHJlYWwp
OworCX0gZWxzZSB7CisJCWRtYV9mZW5jZV9nZXQoJnAtPmJhc2UpOworCQlwLT5jYi5mdW5jID0g
cHJveHlfY2FsbGJhY2s7CisJCWxpc3RfYWRkX3RhaWwoJnAtPmNiLm5vZGUsICZyZWFsLT5jYl9s
aXN0KTsKKwl9CisJc3Bpbl91bmxvY2socmVhbC0+bG9jayk7CisKK3VubG9jazoKKwlzcGluX3Vu
bG9ja19pcnFyZXN0b3JlKHAtPmJhc2UubG9jaywgZmxhZ3MpOworfQorCisvKioKKyAqIGRtYV9m
ZW5jZV9yZXBsYWNlX3Byb3h5IC0gUmVwbGFjZSB0aGUgcHJveHkgZmVuY2Ugd2l0aCB0aGUgcmVh
bCB0YXJnZXQKKyAqIEBzbG90OiBwb2ludGVyIHRvIGxvY2F0aW9uIG9mIGZlbmNlIHRvIHVwZGF0
ZQorICogQGZlbmNlOiB0aGUgbmV3IGZlbmNlIHRvIHN0b3JlIGluIEBzbG90CisgKgorICogT25j
ZSB0aGUgcmVhbCBkbWFfZmVuY2UgaXMga25vd24sIHdlIGNhbiByZXBsYWNlIHRoZSBwcm94eSBm
ZW5jZSBob2xkZXIKKyAqIHdpdGggYSBwb2ludGVyIHRvIHRoZSByZWFsIGRtYSBmZW5jZS4gRnV0
dXJlIGxpc3RlbmVycyB3aWxsIGF0dGFjaCB0bworICogdGhlIHJlYWwgZmVuY2UsIGF2b2lkaW5n
IGFueSBpbmRpcmVjdGlvbiBvdmVyaGVhZC4gUHJldmlvdXMgbGlzdGVuZXJzCisgKiB3aWxsIHJl
bWFpbiBhdHRhY2hlZCB0byB0aGUgcHJveHkgZmVuY2UsIGFuZCBiZSBzaWduYWxlZCBpbiB0dXJu
IHdoZW4KKyAqIHRoZSB0YXJnZXQgZmVuY2UgY29tcGxldGVzLgorICovCitzdHJ1Y3QgZG1hX2Zl
bmNlICoKK2RtYV9mZW5jZV9yZXBsYWNlX3Byb3h5KHN0cnVjdCBkbWFfZmVuY2UgX19yY3UgKipz
bG90LCBzdHJ1Y3QgZG1hX2ZlbmNlICpmZW5jZSkKK3sKKwlzdHJ1Y3QgZG1hX2ZlbmNlICpvbGQ7
CisKKwlpZiAoZmVuY2UpCisJCWRtYV9mZW5jZV9nZXQoZmVuY2UpOworCisJb2xkID0gcmN1X3Jl
cGxhY2VfcG9pbnRlcigqc2xvdCwgZmVuY2UsIHRydWUpOworCWlmIChvbGQgJiYgb2xkLT5vcHMg
PT0gJmRtYV9mZW5jZV9wcm94eV9vcHMpCisJCXByb3h5X2Fzc2lnbihvbGQsIGZlbmNlKTsKKwor
CXJldHVybiBvbGQ7Cit9CitFWFBPUlRfU1lNQk9MKGRtYV9mZW5jZV9yZXBsYWNlX3Byb3h5KTsK
ZGlmZiAtLWdpdCBhL2RyaXZlcnMvZG1hLWJ1Zi9kbWEtZmVuY2UuYyBiL2RyaXZlcnMvZG1hLWJ1
Zi9kbWEtZmVuY2UuYwppbmRleCAwNTJhNDFlMjQ1MWMuLmZhN2JlZGM2NzAzZCAxMDA2NDQKLS0t
IGEvZHJpdmVycy9kbWEtYnVmL2RtYS1mZW5jZS5jCisrKyBiL2RyaXZlcnMvZG1hLWJ1Zi9kbWEt
ZmVuY2UuYwpAQCAtMTksNiArMTksOCBAQAogI2RlZmluZSBDUkVBVEVfVFJBQ0VfUE9JTlRTCiAj
aW5jbHVkZSA8dHJhY2UvZXZlbnRzL2RtYV9mZW5jZS5oPgogCisjaW5jbHVkZSAiZG1hLWZlbmNl
LXByaXZhdGUuaCIKKwogRVhQT1JUX1RSQUNFUE9JTlRfU1lNQk9MKGRtYV9mZW5jZV9lbWl0KTsK
IEVYUE9SVF9UUkFDRVBPSU5UX1NZTUJPTChkbWFfZmVuY2VfZW5hYmxlX3NpZ25hbCk7CiBFWFBP
UlRfVFJBQ0VQT0lOVF9TWU1CT0woZG1hX2ZlbmNlX3NpZ25hbGVkKTsKQEAgLTI3Myw3ICsyNzUs
NyBAQCB2b2lkIGRtYV9mZW5jZV9mcmVlKHN0cnVjdCBkbWFfZmVuY2UgKmZlbmNlKQogfQogRVhQ
T1JUX1NZTUJPTChkbWFfZmVuY2VfZnJlZSk7CiAKLXN0YXRpYyBib29sIF9fZG1hX2ZlbmNlX2Vu
YWJsZV9zaWduYWxpbmcoc3RydWN0IGRtYV9mZW5jZSAqZmVuY2UpCitib29sIF9fZG1hX2ZlbmNl
X2VuYWJsZV9zaWduYWxpbmcoc3RydWN0IGRtYV9mZW5jZSAqZmVuY2UpCiB7CiAJYm9vbCB3YXNf
c2V0OwogCmRpZmYgLS1naXQgYS9kcml2ZXJzL2RtYS1idWYvc2VsZnRlc3RzLmggYi9kcml2ZXJz
L2RtYS1idWYvc2VsZnRlc3RzLmgKaW5kZXggNTU5MThlZjlhZGFiLi42MTZlY2E3MGUyZDggMTAw
NjQ0Ci0tLSBhL2RyaXZlcnMvZG1hLWJ1Zi9zZWxmdGVzdHMuaAorKysgYi9kcml2ZXJzL2RtYS1i
dWYvc2VsZnRlc3RzLmgKQEAgLTEyLDMgKzEyLDQgQEAKIHNlbGZ0ZXN0KHNhbml0eWNoZWNrLCBf
X3Nhbml0eWNoZWNrX18pIC8qIGtlZXAgZmlyc3QgKGlndCBzZWxmY2hlY2spICovCiBzZWxmdGVz
dChkbWFfZmVuY2UsIGRtYV9mZW5jZSkKIHNlbGZ0ZXN0KGRtYV9mZW5jZV9jaGFpbiwgZG1hX2Zl
bmNlX2NoYWluKQorc2VsZnRlc3QoZG1hX2ZlbmNlX3Byb3h5LCBkbWFfZmVuY2VfcHJveHkpCmRp
ZmYgLS1naXQgYS9kcml2ZXJzL2RtYS1idWYvc3QtZG1hLWZlbmNlLXByb3h5LmMgYi9kcml2ZXJz
L2RtYS1idWYvc3QtZG1hLWZlbmNlLXByb3h5LmMKbmV3IGZpbGUgbW9kZSAxMDA2NDQKaW5kZXgg
MDAwMDAwMDAwMDAwLi40ZTA2NmI4ZTVhN2YKLS0tIC9kZXYvbnVsbAorKysgYi9kcml2ZXJzL2Rt
YS1idWYvc3QtZG1hLWZlbmNlLXByb3h5LmMKQEAgLTAsMCArMSw1NDEgQEAKKy8vIFNQRFgtTGlj
ZW5zZS1JZGVudGlmaWVyOiBNSVQKKy8qCisgKiBDb3B5cmlnaHQgwqkgMjAxOSBJbnRlbCBDb3Jw
b3JhdGlvbgorICovCisKKyNpbmNsdWRlIDxsaW51eC9kZWxheS5oPgorI2luY2x1ZGUgPGxpbnV4
L2RtYS1mZW5jZS5oPgorI2luY2x1ZGUgPGxpbnV4L2RtYS1mZW5jZS1wcm94eS5oPgorI2luY2x1
ZGUgPGxpbnV4L2tlcm5lbC5oPgorI2luY2x1ZGUgPGxpbnV4L3NjaGVkL3NpZ25hbC5oPgorI2lu
Y2x1ZGUgPGxpbnV4L3NsYWIuaD4KKyNpbmNsdWRlIDxsaW51eC9zcGlubG9jay5oPgorCisjaW5j
bHVkZSAic2VsZnRlc3QuaCIKKworc3RhdGljIHN0cnVjdCBrbWVtX2NhY2hlICpzbGFiX2ZlbmNl
czsKKworc3RhdGljIHN0cnVjdCBtb2NrX2ZlbmNlIHsKKwlzdHJ1Y3QgZG1hX2ZlbmNlIGJhc2U7
CisJc3BpbmxvY2tfdCBsb2NrOworfSAqdG9fbW9ja19mZW5jZShzdHJ1Y3QgZG1hX2ZlbmNlICpm
KSB7CisJcmV0dXJuIGNvbnRhaW5lcl9vZihmLCBzdHJ1Y3QgbW9ja19mZW5jZSwgYmFzZSk7Cit9
CisKK3N0YXRpYyBjb25zdCBjaGFyICptb2NrX25hbWUoc3RydWN0IGRtYV9mZW5jZSAqZikKK3sK
KwlyZXR1cm4gIm1vY2siOworfQorCitzdGF0aWMgdm9pZCBtb2NrX2ZlbmNlX3JlbGVhc2Uoc3Ry
dWN0IGRtYV9mZW5jZSAqZikKK3sKKwlrbWVtX2NhY2hlX2ZyZWUoc2xhYl9mZW5jZXMsIHRvX21v
Y2tfZmVuY2UoZikpOworfQorCitzdGF0aWMgY29uc3Qgc3RydWN0IGRtYV9mZW5jZV9vcHMgbW9j
a19vcHMgPSB7CisJLmdldF9kcml2ZXJfbmFtZSA9IG1vY2tfbmFtZSwKKwkuZ2V0X3RpbWVsaW5l
X25hbWUgPSBtb2NrX25hbWUsCisJLnJlbGVhc2UgPSBtb2NrX2ZlbmNlX3JlbGVhc2UsCit9Owor
CitzdGF0aWMgc3RydWN0IGRtYV9mZW5jZSAqbW9ja19mZW5jZSh2b2lkKQoreworCXN0cnVjdCBt
b2NrX2ZlbmNlICpmOworCisJZiA9IGttZW1fY2FjaGVfYWxsb2Moc2xhYl9mZW5jZXMsIEdGUF9L
RVJORUwpOworCWlmICghZikKKwkJcmV0dXJuIE5VTEw7CisKKwlzcGluX2xvY2tfaW5pdCgmZi0+
bG9jayk7CisJZG1hX2ZlbmNlX2luaXQoJmYtPmJhc2UsICZtb2NrX29wcywgJmYtPmxvY2ssIDAs
IDApOworCisJcmV0dXJuICZmLT5iYXNlOworfQorCitzdGF0aWMgaW50IHNhbml0eWNoZWNrKHZv
aWQgKmFyZykKK3sKKwlzdHJ1Y3QgZG1hX2ZlbmNlICpmOworCisJZiA9IGRtYV9mZW5jZV9jcmVh
dGVfcHJveHkoKTsKKwlpZiAoIWYpCisJCXJldHVybiAtRU5PTUVNOworCisJZG1hX2ZlbmNlX3Np
Z25hbChmKTsKKwlkbWFfZmVuY2VfcHV0KGYpOworCisJcmV0dXJuIDA7Cit9CisKK3N0cnVjdCBm
ZW5jZXMgeworCXN0cnVjdCBkbWFfZmVuY2UgKnJlYWw7CisJc3RydWN0IGRtYV9mZW5jZSAqcHJv
eHk7CisJc3RydWN0IGRtYV9mZW5jZSBfX3JjdSAqc2xvdDsKK307CisKK3N0YXRpYyBpbnQgY3Jl
YXRlX2ZlbmNlcyhzdHJ1Y3QgZmVuY2VzICpmLCBib29sIGF0dGFjaCkKK3sKKwlmLT5wcm94eSA9
IGRtYV9mZW5jZV9jcmVhdGVfcHJveHkoKTsKKwlpZiAoIWYtPnByb3h5KQorCQlyZXR1cm4gLUVO
T01FTTsKKworCVJDVV9JTklUX1BPSU5URVIoZi0+c2xvdCwgZi0+cHJveHkpOworCisJZi0+cmVh
bCA9IG1vY2tfZmVuY2UoKTsKKwlpZiAoIWYtPnJlYWwpIHsKKwkJZG1hX2ZlbmNlX3B1dChmLT5w
cm94eSk7CisJCXJldHVybiAtRU5PTUVNOworCX0KKworCWlmIChhdHRhY2gpCisJCWRtYV9mZW5j
ZV9yZXBsYWNlX3Byb3h5KCZmLT5zbG90LCBmLT5yZWFsKTsKKworCXJldHVybiAwOworfQorCitz
dGF0aWMgdm9pZCBmcmVlX2ZlbmNlcyhzdHJ1Y3QgZmVuY2VzICpmKQoreworCWRtYV9mZW5jZV9w
dXQoZG1hX2ZlbmNlX3JlcGxhY2VfcHJveHkoJmYtPnNsb3QsIE5VTEwpKTsKKwlkbWFfZmVuY2Vf
cHV0KGYtPnJlYWwpOworCWRtYV9mZW5jZV9wdXQoZi0+cHJveHkpOworfQorCitzdGF0aWMgaW50
IHdyYXBfc2lnbmFsaW5nKHZvaWQgKmFyZykKK3sKKwlzdHJ1Y3QgZmVuY2VzIGY7CisJaW50IGVy
ciA9IC1FSU5WQUw7CisKKwlpZiAoY3JlYXRlX2ZlbmNlcygmZiwgdHJ1ZSkpCisJCXJldHVybiAt
RU5PTUVNOworCisJaWYgKGRtYV9mZW5jZV9pc19zaWduYWxlZChmLnByb3h5KSkgeworCQlwcl9l
cnIoIkZlbmNlIHVuZXhwZWN0ZWRseSBzaWduYWxlZCBvbiBjcmVhdGlvblxuIik7CisJCWdvdG8g
ZXJyX2ZyZWU7CisJfQorCisJaWYgKGRtYV9mZW5jZV9zaWduYWwoZi5yZWFsKSkgeworCQlwcl9l
cnIoIkZlbmNlIHJlcG9ydGVkIGJlaW5nIGFscmVhZHkgc2lnbmFsZWRcbiIpOworCQlnb3RvIGVy
cl9mcmVlOworCX0KKworCWlmICghZG1hX2ZlbmNlX2lzX3NpZ25hbGVkKGYucHJveHkpKSB7CisJ
CXByX2VycigiRmVuY2Ugbm90IHJlcG9ydGluZyBzaWduYWxlZFxuIik7CisJCWdvdG8gZXJyX2Zy
ZWU7CisJfQorCisJZXJyID0gMDsKK2Vycl9mcmVlOgorCWZyZWVfZmVuY2VzKCZmKTsKKwlyZXR1
cm4gZXJyOworfQorCitzdGF0aWMgaW50IHdyYXBfc2lnbmFsaW5nX3JlY3Vyc2Uodm9pZCAqYXJn
KQoreworCXN0cnVjdCBmZW5jZXMgZjsKKwlzdHJ1Y3QgZG1hX2ZlbmNlICpjaGFpbjsKKwlpbnQg
ZXJyID0gLUVJTlZBTDsKKworCWlmIChjcmVhdGVfZmVuY2VzKCZmLCBmYWxzZSkpCisJCXJldHVy
biAtRU5PTUVNOworCisJY2hhaW4gPSBkbWFfZmVuY2VfY3JlYXRlX3Byb3h5KCk7CisJaWYgKCFj
aGFpbikgeworCQllcnIgPSAtRU5PTUVNOworCQlnb3RvIGVycl9mcmVlOworCX0KKworCWRtYV9m
ZW5jZV9yZXBsYWNlX3Byb3h5KCZmLnNsb3QsIGNoYWluKTsKKwlkbWFfZmVuY2VfcHV0KGRtYV9m
ZW5jZV9yZXBsYWNlX3Byb3h5KCZmLnNsb3QsIGYucmVhbCkpOworCWRtYV9mZW5jZV9wdXQoY2hh
aW4pOworCisJLyogZi5yZWFsIDwtIGNoYWluIDwtIGYucHJveHkgKi8KKworCWlmIChkbWFfZmVu
Y2VfaXNfc2lnbmFsZWQoZi5wcm94eSkpIHsKKwkJcHJfZXJyKCJGZW5jZSB1bmV4cGVjdGVkbHkg
c2lnbmFsZWQgb24gY3JlYXRpb25cbiIpOworCQlnb3RvIGVycl9mcmVlOworCX0KKworCWlmIChk
bWFfZmVuY2Vfc2lnbmFsKGYucmVhbCkpIHsKKwkJcHJfZXJyKCJGZW5jZSByZXBvcnRlZCBiZWlu
ZyBhbHJlYWR5IHNpZ25hbGVkXG4iKTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwlpZiAoIWRt
YV9mZW5jZV9pc19zaWduYWxlZChmLnByb3h5KSkgeworCQlwcl9lcnIoIkZlbmNlIG5vdCByZXBv
cnRpbmcgc2lnbmFsZWRcbiIpOworCQlnb3RvIGVycl9mcmVlOworCX0KKworCWVyciA9IDA7Citl
cnJfZnJlZToKKwlmcmVlX2ZlbmNlcygmZik7CisJcmV0dXJuIGVycjsKK30KKworc3RydWN0IHNp
bXBsZV9jYiB7CisJc3RydWN0IGRtYV9mZW5jZV9jYiBjYjsKKwlib29sIHNlZW47Cit9OworCitz
dGF0aWMgdm9pZCBzaW1wbGVfY2FsbGJhY2soc3RydWN0IGRtYV9mZW5jZSAqZiwgc3RydWN0IGRt
YV9mZW5jZV9jYiAqY2IpCit7CisJc21wX3N0b3JlX21iKGNvbnRhaW5lcl9vZihjYiwgc3RydWN0
IHNpbXBsZV9jYiwgY2IpLT5zZWVuLCB0cnVlKTsKK30KKworc3RhdGljIGludCB3cmFwX2FkZF9j
YWxsYmFjayh2b2lkICphcmcpCit7CisJc3RydWN0IHNpbXBsZV9jYiBjYiA9IHt9OworCXN0cnVj
dCBmZW5jZXMgZjsKKwlpbnQgZXJyID0gLUVJTlZBTDsKKworCWlmIChjcmVhdGVfZmVuY2VzKCZm
LCB0cnVlKSkKKwkJcmV0dXJuIC1FTk9NRU07CisKKwlpZiAoZG1hX2ZlbmNlX2FkZF9jYWxsYmFj
ayhmLnByb3h5LCAmY2IuY2IsIHNpbXBsZV9jYWxsYmFjaykpIHsKKwkJcHJfZXJyKCJGYWlsZWQg
dG8gYWRkIGNhbGxiYWNrLCBmZW5jZSBhbHJlYWR5IHNpZ25hbGVkIVxuIik7CisJCWdvdG8gZXJy
X2ZyZWU7CisJfQorCisJZG1hX2ZlbmNlX3NpZ25hbChmLnJlYWwpOworCWlmICghY2Iuc2Vlbikg
eworCQlwcl9lcnIoIkNhbGxiYWNrIGZhaWxlZCFcbiIpOworCQlnb3RvIGVycl9mcmVlOworCX0K
KworCWVyciA9IDA7CitlcnJfZnJlZToKKwlmcmVlX2ZlbmNlcygmZik7CisJcmV0dXJuIGVycjsK
K30KKworc3RhdGljIGludCB3cmFwX2xhdGVfYWRkX2NhbGxiYWNrKHZvaWQgKmFyZykKK3sKKwlz
dHJ1Y3Qgc2ltcGxlX2NiIGNiID0ge307CisJc3RydWN0IGZlbmNlcyBmOworCWludCBlcnIgPSAt
RUlOVkFMOworCisJaWYgKGNyZWF0ZV9mZW5jZXMoJmYsIHRydWUpKQorCQlyZXR1cm4gLUVOT01F
TTsKKworCWRtYV9mZW5jZV9zaWduYWwoZi5yZWFsKTsKKworCWlmICghZG1hX2ZlbmNlX2FkZF9j
YWxsYmFjayhmLnByb3h5LCAmY2IuY2IsIHNpbXBsZV9jYWxsYmFjaykpIHsKKwkJcHJfZXJyKCJB
ZGRlZCBjYWxsYmFjaywgYnV0IGZlbmNlIHdhcyBhbHJlYWR5IHNpZ25hbGVkIVxuIik7CisJCWdv
dG8gZXJyX2ZyZWU7CisJfQorCisJZG1hX2ZlbmNlX3NpZ25hbChmLnJlYWwpOworCWlmIChjYi5z
ZWVuKSB7CisJCXByX2VycigiQ2FsbGJhY2sgY2FsbGVkIGFmdGVyIGZhaWxlZCBhdHRhY2htZW50
IVxuIik7CisJCWdvdG8gZXJyX2ZyZWU7CisJfQorCisJZXJyID0gMDsKK2Vycl9mcmVlOgorCWZy
ZWVfZmVuY2VzKCZmKTsKKwlyZXR1cm4gZXJyOworfQorCitzdGF0aWMgaW50IHdyYXBfZWFybHlf
YWRkX2NhbGxiYWNrKHZvaWQgKmFyZykKK3sKKwlzdHJ1Y3Qgc2ltcGxlX2NiIGNiID0ge307CisJ
c3RydWN0IGZlbmNlcyBmOworCWludCBlcnIgPSAtRUlOVkFMOworCisJaWYgKGNyZWF0ZV9mZW5j
ZXMoJmYsIGZhbHNlKSkKKwkJcmV0dXJuIC1FTk9NRU07CisKKwlpZiAoZG1hX2ZlbmNlX2FkZF9j
YWxsYmFjayhmLnByb3h5LCAmY2IuY2IsIHNpbXBsZV9jYWxsYmFjaykpIHsKKwkJcHJfZXJyKCJG
YWlsZWQgdG8gYWRkIGNhbGxiYWNrLCBmZW5jZSBhbHJlYWR5IHNpZ25hbGVkIVxuIik7CisJCWdv
dG8gZXJyX2ZyZWU7CisJfQorCisJZG1hX2ZlbmNlX3JlcGxhY2VfcHJveHkoJmYuc2xvdCwgZi5y
ZWFsKTsKKwlkbWFfZmVuY2Vfc2lnbmFsKGYucmVhbCk7CisJaWYgKCFjYi5zZWVuKSB7CisJCXBy
X2VycigiQ2FsbGJhY2sgZmFpbGVkIVxuIik7CisJCWdvdG8gZXJyX2ZyZWU7CisJfQorCisJZXJy
ID0gMDsKK2Vycl9mcmVlOgorCWZyZWVfZmVuY2VzKCZmKTsKKwlyZXR1cm4gZXJyOworfQorCitz
dGF0aWMgaW50IHdyYXBfZWFybHlfYWRkX2NhbGxiYWNrX2xhdGUodm9pZCAqYXJnKQoreworCXN0
cnVjdCBzaW1wbGVfY2IgY2IgPSB7fTsKKwlzdHJ1Y3QgZmVuY2VzIGY7CisJaW50IGVyciA9IC1F
SU5WQUw7CisKKwlpZiAoY3JlYXRlX2ZlbmNlcygmZiwgZmFsc2UpKQorCQlyZXR1cm4gLUVOT01F
TTsKKworCWRtYV9mZW5jZV9zaWduYWwoZi5yZWFsKTsKKworCWlmIChkbWFfZmVuY2VfYWRkX2Nh
bGxiYWNrKGYucHJveHksICZjYi5jYiwgc2ltcGxlX2NhbGxiYWNrKSkgeworCQlwcl9lcnIoIkZh
aWxlZCB0byBhZGQgY2FsbGJhY2ssIGZlbmNlIGFscmVhZHkgc2lnbmFsZWQhXG4iKTsKKwkJZ290
byBlcnJfZnJlZTsKKwl9CisKKwlkbWFfZmVuY2VfcmVwbGFjZV9wcm94eSgmZi5zbG90LCBmLnJl
YWwpOworCWRtYV9mZW5jZV9zaWduYWwoZi5yZWFsKTsKKwlpZiAoIWNiLnNlZW4pIHsKKwkJcHJf
ZXJyKCJDYWxsYmFjayBmYWlsZWQhXG4iKTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwllcnIg
PSAwOworZXJyX2ZyZWU6CisJZnJlZV9mZW5jZXMoJmYpOworCXJldHVybiBlcnI7Cit9CisKK3N0
YXRpYyBpbnQgd3JhcF9lYXJseV9hZGRfY2FsbGJhY2tfZWFybHkodm9pZCAqYXJnKQoreworCXN0
cnVjdCBzaW1wbGVfY2IgY2IgPSB7fTsKKwlzdHJ1Y3QgZmVuY2VzIGY7CisJaW50IGVyciA9IC1F
SU5WQUw7CisKKwlpZiAoY3JlYXRlX2ZlbmNlcygmZiwgZmFsc2UpKQorCQlyZXR1cm4gLUVOT01F
TTsKKworCWlmIChkbWFfZmVuY2VfYWRkX2NhbGxiYWNrKGYucHJveHksICZjYi5jYiwgc2ltcGxl
X2NhbGxiYWNrKSkgeworCQlwcl9lcnIoIkZhaWxlZCB0byBhZGQgY2FsbGJhY2ssIGZlbmNlIGFs
cmVhZHkgc2lnbmFsZWQhXG4iKTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwlkbWFfZmVuY2Vf
cmVwbGFjZV9wcm94eSgmZi5zbG90LCBmLnJlYWwpOworCWRtYV9mZW5jZV9zaWduYWwoZi5yZWFs
KTsKKwlpZiAoIWNiLnNlZW4pIHsKKwkJcHJfZXJyKCJDYWxsYmFjayBmYWlsZWQhXG4iKTsKKwkJ
Z290byBlcnJfZnJlZTsKKwl9CisKKwllcnIgPSAwOworZXJyX2ZyZWU6CisJZnJlZV9mZW5jZXMo
JmYpOworCXJldHVybiBlcnI7Cit9CisKK3N0YXRpYyBpbnQgd3JhcF9ybV9jYWxsYmFjayh2b2lk
ICphcmcpCit7CisJc3RydWN0IHNpbXBsZV9jYiBjYiA9IHt9OworCXN0cnVjdCBmZW5jZXMgZjsK
KwlpbnQgZXJyID0gLUVJTlZBTDsKKworCWlmIChjcmVhdGVfZmVuY2VzKCZmLCB0cnVlKSkKKwkJ
cmV0dXJuIC1FTk9NRU07CisKKwlpZiAoZG1hX2ZlbmNlX2FkZF9jYWxsYmFjayhmLnByb3h5LCAm
Y2IuY2IsIHNpbXBsZV9jYWxsYmFjaykpIHsKKwkJcHJfZXJyKCJGYWlsZWQgdG8gYWRkIGNhbGxi
YWNrLCBmZW5jZSBhbHJlYWR5IHNpZ25hbGVkIVxuIik7CisJCWdvdG8gZXJyX2ZyZWU7CisJfQor
CisJaWYgKCFkbWFfZmVuY2VfcmVtb3ZlX2NhbGxiYWNrKGYucHJveHksICZjYi5jYikpIHsKKwkJ
cHJfZXJyKCJGYWlsZWQgdG8gcmVtb3ZlIGNhbGxiYWNrIVxuIik7CisJCWdvdG8gZXJyX2ZyZWU7
CisJfQorCisJZG1hX2ZlbmNlX3NpZ25hbChmLnJlYWwpOworCWlmIChjYi5zZWVuKSB7CisJCXBy
X2VycigiQ2FsbGJhY2sgc3RpbGwgc2lnbmFsZWQgYWZ0ZXIgcmVtb3ZhbCFcbiIpOworCQlnb3Rv
IGVycl9mcmVlOworCX0KKworCWVyciA9IDA7CitlcnJfZnJlZToKKwlmcmVlX2ZlbmNlcygmZik7
CisJcmV0dXJuIGVycjsKK30KKworc3RhdGljIGludCB3cmFwX2xhdGVfcm1fY2FsbGJhY2sodm9p
ZCAqYXJnKQoreworCXN0cnVjdCBzaW1wbGVfY2IgY2IgPSB7fTsKKwlzdHJ1Y3QgZmVuY2VzIGY7
CisJaW50IGVyciA9IC1FSU5WQUw7CisKKwlpZiAoY3JlYXRlX2ZlbmNlcygmZiwgdHJ1ZSkpCisJ
CXJldHVybiAtRU5PTUVNOworCisJaWYgKGRtYV9mZW5jZV9hZGRfY2FsbGJhY2soZi5wcm94eSwg
JmNiLmNiLCBzaW1wbGVfY2FsbGJhY2spKSB7CisJCXByX2VycigiRmFpbGVkIHRvIGFkZCBjYWxs
YmFjaywgZmVuY2UgYWxyZWFkeSBzaWduYWxlZCFcbiIpOworCQlnb3RvIGVycl9mcmVlOworCX0K
KworCWRtYV9mZW5jZV9zaWduYWwoZi5yZWFsKTsKKwlpZiAoIWNiLnNlZW4pIHsKKwkJcHJfZXJy
KCJDYWxsYmFjayBmYWlsZWQhXG4iKTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwlpZiAoZG1h
X2ZlbmNlX3JlbW92ZV9jYWxsYmFjayhmLnByb3h5LCAmY2IuY2IpKSB7CisJCXByX2VycigiQ2Fs
bGJhY2sgcmVtb3ZhbCBzdWNjZWVkIGFmdGVyIGJlaW5nIGV4ZWN1dGVkIVxuIik7CisJCWdvdG8g
ZXJyX2ZyZWU7CisJfQorCisJZXJyID0gMDsKK2Vycl9mcmVlOgorCWZyZWVfZmVuY2VzKCZmKTsK
KwlyZXR1cm4gZXJyOworfQorCitzdGF0aWMgaW50IHdyYXBfc3RhdHVzKHZvaWQgKmFyZykKK3sK
KwlzdHJ1Y3QgZmVuY2VzIGY7CisJaW50IGVyciA9IC1FSU5WQUw7CisKKwlpZiAoY3JlYXRlX2Zl
bmNlcygmZiwgdHJ1ZSkpCisJCXJldHVybiAtRU5PTUVNOworCisJaWYgKGRtYV9mZW5jZV9nZXRf
c3RhdHVzKGYucHJveHkpKSB7CisJCXByX2VycigiRmVuY2UgdW5leHBlY3RlZGx5IGhhcyBzaWdu
YWxlZCBzdGF0dXMgb24gY3JlYXRpb25cbiIpOworCQlnb3RvIGVycl9mcmVlOworCX0KKworCWRt
YV9mZW5jZV9zaWduYWwoZi5yZWFsKTsKKwlpZiAoIWRtYV9mZW5jZV9nZXRfc3RhdHVzKGYucHJv
eHkpKSB7CisJCXByX2VycigiRmVuY2Ugbm90IHJlcG9ydGluZyBzaWduYWxlZCBzdGF0dXNcbiIp
OworCQlnb3RvIGVycl9mcmVlOworCX0KKworCWVyciA9IDA7CitlcnJfZnJlZToKKwlmcmVlX2Zl
bmNlcygmZik7CisJcmV0dXJuIGVycjsKK30KKworc3RhdGljIGludCB3cmFwX2Vycm9yKHZvaWQg
KmFyZykKK3sKKwlzdHJ1Y3QgZmVuY2VzIGY7CisJaW50IGVyciA9IC1FSU5WQUw7CisKKwlpZiAo
Y3JlYXRlX2ZlbmNlcygmZiwgdHJ1ZSkpCisJCXJldHVybiAtRU5PTUVNOworCisJZG1hX2ZlbmNl
X3NldF9lcnJvcihmLnJlYWwsIC1FSU8pOworCisJaWYgKGRtYV9mZW5jZV9nZXRfc3RhdHVzKGYu
cHJveHkpKSB7CisJCXByX2VycigiRmVuY2UgdW5leHBlY3RlZGx5IGhhcyBlcnJvciBzdGF0dXMg
YmVmb3JlIHNpZ25hbFxuIik7CisJCWdvdG8gZXJyX2ZyZWU7CisJfQorCisJZG1hX2ZlbmNlX3Np
Z25hbChmLnJlYWwpOworCWlmIChkbWFfZmVuY2VfZ2V0X3N0YXR1cyhmLnByb3h5KSAhPSAtRUlP
KSB7CisJCXByX2VycigiRmVuY2Ugbm90IHJlcG9ydGluZyBlcnJvciBzdGF0dXMsIGdvdCAlZFxu
IiwKKwkJICAgICAgIGRtYV9mZW5jZV9nZXRfc3RhdHVzKGYucHJveHkpKTsKKwkJZ290byBlcnJf
ZnJlZTsKKwl9CisKKwllcnIgPSAwOworZXJyX2ZyZWU6CisJZnJlZV9mZW5jZXMoJmYpOworCXJl
dHVybiBlcnI7Cit9CisKK3N0YXRpYyBpbnQgd3JhcF93YWl0KHZvaWQgKmFyZykKK3sKKwlzdHJ1
Y3QgZmVuY2VzIGY7CisJaW50IGVyciA9IC1FSU5WQUw7CisKKwlpZiAoY3JlYXRlX2ZlbmNlcygm
ZiwgdHJ1ZSkpCisJCXJldHVybiAtRU5PTUVNOworCisJaWYgKGRtYV9mZW5jZV93YWl0X3RpbWVv
dXQoZi5wcm94eSwgZmFsc2UsIDApICE9IDApIHsKKwkJcHJfZXJyKCJXYWl0IHJlcG9ydGVkIGNv
bXBsZXRlIGJlZm9yZSBiZWluZyBzaWduYWxlZFxuIik7CisJCWdvdG8gZXJyX2ZyZWU7CisJfQor
CisJZG1hX2ZlbmNlX3NpZ25hbChmLnJlYWwpOworCisJaWYgKGRtYV9mZW5jZV93YWl0X3RpbWVv
dXQoZi5wcm94eSwgZmFsc2UsIDApID09IDApIHsKKwkJcHJfZXJyKCJXYWl0IHJlcG9ydGVkIGlu
Y29tcGxldGUgYWZ0ZXIgYmVpbmcgc2lnbmFsZWRcbiIpOworCQlnb3RvIGVycl9mcmVlOworCX0K
KworCWVyciA9IDA7CitlcnJfZnJlZToKKwlkbWFfZmVuY2Vfc2lnbmFsKGYucmVhbCk7CisJZnJl
ZV9mZW5jZXMoJmYpOworCXJldHVybiBlcnI7Cit9CisKK3N0cnVjdCB3YWl0X3RpbWVyIHsKKwlz
dHJ1Y3QgdGltZXJfbGlzdCB0aW1lcjsKKwlzdHJ1Y3QgZmVuY2VzIGY7Cit9OworCitzdGF0aWMg
dm9pZCB3YWl0X3RpbWVyKHN0cnVjdCB0aW1lcl9saXN0ICp0aW1lcikKK3sKKwlzdHJ1Y3Qgd2Fp
dF90aW1lciAqd3QgPSBmcm9tX3RpbWVyKHd0LCB0aW1lciwgdGltZXIpOworCisJZG1hX2ZlbmNl
X3NpZ25hbCh3dC0+Zi5yZWFsKTsKK30KKworc3RhdGljIGludCB3cmFwX3dhaXRfdGltZW91dCh2
b2lkICphcmcpCit7CisJc3RydWN0IHdhaXRfdGltZXIgd3Q7CisJaW50IGVyciA9IC1FSU5WQUw7
CisKKwlpZiAoY3JlYXRlX2ZlbmNlcygmd3QuZiwgdHJ1ZSkpCisJCXJldHVybiAtRU5PTUVNOwor
CisJdGltZXJfc2V0dXBfb25fc3RhY2soJnd0LnRpbWVyLCB3YWl0X3RpbWVyLCAwKTsKKworCWlm
IChkbWFfZmVuY2Vfd2FpdF90aW1lb3V0KHd0LmYucHJveHksIGZhbHNlLCAxKSAhPSAwKSB7CisJ
CXByX2VycigiV2FpdCByZXBvcnRlZCBjb21wbGV0ZSBiZWZvcmUgYmVpbmcgc2lnbmFsZWRcbiIp
OworCQlnb3RvIGVycl9mcmVlOworCX0KKworCW1vZF90aW1lcigmd3QudGltZXIsIGppZmZpZXMg
KyAxKTsKKworCWlmIChkbWFfZmVuY2Vfd2FpdF90aW1lb3V0KHd0LmYucHJveHksIGZhbHNlLCAy
KSAhPSAwKSB7CisJCWlmICh0aW1lcl9wZW5kaW5nKCZ3dC50aW1lcikpIHsKKwkJCXByX25vdGlj
ZSgiVGltZXIgZGlkIG5vdCBmaXJlIHdpdGhpbiB0aGUgamlmZmllIVxuIik7CisJCQllcnIgPSAw
OyAvKiBub3Qgb3VyIGZhdWx0ISAqLworCQl9IGVsc2UgeworCQkJcHJfZXJyKCJXYWl0IHJlcG9y
dGVkIGluY29tcGxldGUgYWZ0ZXIgdGltZW91dFxuIik7CisJCX0KKwkJZ290byBlcnJfZnJlZTsK
Kwl9CisKKwllcnIgPSAwOworZXJyX2ZyZWU6CisJZGVsX3RpbWVyX3N5bmMoJnd0LnRpbWVyKTsK
KwlkZXN0cm95X3RpbWVyX29uX3N0YWNrKCZ3dC50aW1lcik7CisJZG1hX2ZlbmNlX3NpZ25hbCh3
dC5mLnJlYWwpOworCWZyZWVfZmVuY2VzKCZ3dC5mKTsKKwlyZXR1cm4gZXJyOworfQorCitpbnQg
ZG1hX2ZlbmNlX3Byb3h5KHZvaWQpCit7CisJc3RhdGljIGNvbnN0IHN0cnVjdCBzdWJ0ZXN0IHRl
c3RzW10gPSB7CisJCVNVQlRFU1Qoc2FuaXR5Y2hlY2spLAorCQlTVUJURVNUKHdyYXBfc2lnbmFs
aW5nKSwKKwkJU1VCVEVTVCh3cmFwX3NpZ25hbGluZ19yZWN1cnNlKSwKKwkJU1VCVEVTVCh3cmFw
X2FkZF9jYWxsYmFjayksCisJCVNVQlRFU1Qod3JhcF9sYXRlX2FkZF9jYWxsYmFjayksCisJCVNV
QlRFU1Qod3JhcF9lYXJseV9hZGRfY2FsbGJhY2spLAorCQlTVUJURVNUKHdyYXBfZWFybHlfYWRk
X2NhbGxiYWNrX2xhdGUpLAorCQlTVUJURVNUKHdyYXBfZWFybHlfYWRkX2NhbGxiYWNrX2Vhcmx5
KSwKKwkJU1VCVEVTVCh3cmFwX3JtX2NhbGxiYWNrKSwKKwkJU1VCVEVTVCh3cmFwX2xhdGVfcm1f
Y2FsbGJhY2spLAorCQlTVUJURVNUKHdyYXBfc3RhdHVzKSwKKwkJU1VCVEVTVCh3cmFwX2Vycm9y
KSwKKwkJU1VCVEVTVCh3cmFwX3dhaXQpLAorCQlTVUJURVNUKHdyYXBfd2FpdF90aW1lb3V0KSwK
Kwl9OworCWludCByZXQ7CisKKwlzbGFiX2ZlbmNlcyA9IEtNRU1fQ0FDSEUobW9ja19mZW5jZSwK
KwkJCQkgU0xBQl9UWVBFU0FGRV9CWV9SQ1UgfAorCQkJCSBTTEFCX0hXQ0FDSEVfQUxJR04pOwor
CWlmICghc2xhYl9mZW5jZXMpCisJCXJldHVybiAtRU5PTUVNOworCisJcmV0ID0gc3VidGVzdHMo
dGVzdHMsIE5VTEwpOworCisJa21lbV9jYWNoZV9kZXN0cm95KHNsYWJfZmVuY2VzKTsKKworCXJl
dHVybiByZXQ7Cit9CmRpZmYgLS1naXQgYS9pbmNsdWRlL2xpbnV4L2RtYS1mZW5jZS1wcm94eS5o
IGIvaW5jbHVkZS9saW51eC9kbWEtZmVuY2UtcHJveHkuaApuZXcgZmlsZSBtb2RlIDEwMDY0NApp
bmRleCAwMDAwMDAwMDAwMDAuLjU4N2Q1MDQ0ZjBiZgotLS0gL2Rldi9udWxsCisrKyBiL2luY2x1
ZGUvbGludXgvZG1hLWZlbmNlLXByb3h5LmgKQEAgLTAsMCArMSwyMCBAQAorLyogU1BEWC1MaWNl
bnNlLUlkZW50aWZpZXI6IEdQTC0yLjAtb25seSAqLworLyoKKyAqIGRtYS1mZW5jZS1wcm94eTog
YWxsb3dzIHdhaXRpbmcgdXBvbiB1bnNldCBhbmQgZnV0dXJlIGZlbmNlcworICoKKyAqIENvcHly
aWdodCAoQykgMjAxNyBJbnRlbCBDb3Jwb3JhdGlvbgorICovCisKKyNpZm5kZWYgX19MSU5VWF9E
TUFfRkVOQ0VfUFJPWFlfSAorI2RlZmluZSBfX0xJTlVYX0RNQV9GRU5DRV9QUk9YWV9ICisKKyNp
bmNsdWRlIDxsaW51eC9rZXJuZWwuaD4KKworc3RydWN0IGRtYV9mZW5jZTsKKworc3RydWN0IGRt
YV9mZW5jZSAqZG1hX2ZlbmNlX2NyZWF0ZV9wcm94eSh2b2lkKTsKKworc3RydWN0IGRtYV9mZW5j
ZSAqCitkbWFfZmVuY2VfcmVwbGFjZV9wcm94eShzdHJ1Y3QgZG1hX2ZlbmNlIF9fcmN1ICoqc2xv
dCwgc3RydWN0IGRtYV9mZW5jZSAqZmVuY2UpOworCisjZW5kaWYgLyogX19MSU5VWF9ETUFfRkVO
Q0VfUFJPWFlfSCAqLwotLSAKMi4yNS4xCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fXwpJbnRlbC1nZnggbWFpbGluZyBsaXN0CkludGVsLWdmeEBsaXN0cy5m
cmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0
aW5mby9pbnRlbC1nZngK

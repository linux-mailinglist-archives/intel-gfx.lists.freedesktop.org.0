Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 05AB1EADD0
	for <lists+intel-gfx@lfdr.de>; Thu, 31 Oct 2019 11:48:12 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id D19766EC03;
	Thu, 31 Oct 2019 10:48:09 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 58C3C6EC03
 for <intel-gfx@lists.freedesktop.org>; Thu, 31 Oct 2019 10:48:08 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 19030694-1500050 
 for multiple; Thu, 31 Oct 2019 10:47:48 +0000
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Thu, 31 Oct 2019 10:47:47 +0000
Message-Id: <20191031104747.5308-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.24.0.rc1
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH] drm/i915/execlists: Verify context register
 state before execution
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

Q2hlY2sgdGhhdCB0aGUgY29udGV4dCdzIHJpbmcgcmVnaXN0ZXIgc3RhdGUgc3RpbGwgbWF0Y2hl
cyBvdXIKZXhwZWN0YXRpb25zIHByaW9yIHRvIGV4ZWN1dGlvbi4KClNpZ25lZC1vZmYtYnk6IENo
cmlzIFdpbHNvbiA8Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPgpDYzogTWlrYSBLdW9wcGFsYSA8
bWlrYS5rdW9wcGFsYUBsaW51eC5pbnRlbC5jb20+Ci0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUv
Z3QvaW50ZWxfbHJjLmMgICAgIHwgNzMgKysrKysrKysrKysrKysrKysrKystLS0tLQogZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjX3JlZy5oIHwgIDQgKy0KIGRyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2d0L3NlbGZ0ZXN0X2xyYy5jICB8ICA0ICstCiAzIGZpbGVzIGNoYW5nZWQsIDYzIGlu
c2VydGlvbnMoKyksIDE4IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2d0L2ludGVsX2xyYy5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJj
LmMKaW5kZXggNWY2MWNkMTI4ZDljLi42NjZlNzA5MzE1MjQgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2d0L2ludGVsX2xyYy5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0
L2ludGVsX2xyYy5jCkBAIC0xMTQ2LDYgKzExNDYsNjAgQEAgZXhlY2xpc3RzX3NjaGVkdWxlX291
dChzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSkKIAlpOTE1X3JlcXVlc3RfcHV0KHJxKTsKIH0KIAor
c3RhdGljIGludCBscmNfcmluZ19taV9tb2RlKGNvbnN0IHN0cnVjdCBpbnRlbF9lbmdpbmVfY3Mg
KmVuZ2luZSkKK3sKKwlpZiAoSU5URUxfR0VOKGVuZ2luZS0+aTkxNSkgPj0gMTIpCisJCXJldHVy
biAweDYwOworCWVsc2UgaWYgKElOVEVMX0dFTihlbmdpbmUtPmk5MTUpID49IDkpCisJCXJldHVy
biAweDU0OworCWVsc2UgaWYgKGVuZ2luZS0+Y2xhc3MgPT0gUkVOREVSX0NMQVNTKQorCQlyZXR1
cm4gMHg1ODsKKwllbHNlCisJCXJldHVybiAtMTsKK30KKworc3RhdGljIHZvaWQKK2V4ZWNsaXN0
c19jaGVja19jb250ZXh0KGNvbnN0IHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSwKKwkJCWNvbnN0
IHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKK3sKKwljb25zdCBzdHJ1Y3QgaW50ZWxf
cmluZyAqcmluZyA9IGNlLT5yaW5nOworCXUzMiAqcmVncyA9IGNlLT5scmNfcmVnX3N0YXRlOwor
CWludCB4OworCisJaWYgKHJlZ3NbQ1RYX1JJTkdfU1RBUlRdICE9IGk5MTVfZ2d0dF9vZmZzZXQo
cmluZy0+dm1hKSkgeworCQlwcl9lcnJfb25jZSgiJXM6IGNvbnRleHQgc3VibWl0dGVkIHdpdGgg
aW5jb3JyZWN0IFJJTkdfQlVGRkVSX1NUQVJUIFslMDh4XSwgZXhwZWN0ZWQgJTA4eFxuIiwKKwkJ
CSAgICBlbmdpbmUtPm5hbWUsCisJCQkgICAgcmVnc1tDVFhfUklOR19TVEFSVF0sCisJCQkgICAg
aTkxNV9nZ3R0X29mZnNldChyaW5nLT52bWEpKTsKKwkJcmVnc1tDVFhfUklOR19TVEFSVF0gPSBp
OTE1X2dndHRfb2Zmc2V0KHJpbmctPnZtYSk7CisJfQorCisJaWYgKChyZWdzW0NUWF9SSU5HX0NU
TF0gJiB+KFJJTkdfV0FJVCB8IFJJTkdfV0FJVF9TRU1BUEhPUkUpKSAhPQorCSAgICAoUklOR19D
VExfU0laRShyaW5nLT5zaXplKSB8IFJJTkdfVkFMSUQpKSB7CisJCXByX2Vycl9vbmNlKCIlczog
Y29udGV4dCBzdWJtaXR0ZWQgd2l0aCBpbmNvcnJlY3QgUklOR19CVUZGRVJfQ09OVFJPTCBbJTA4
eF0sIGV4cGVjdGVkICUwOHhcbiIsCisJCQkgICAgZW5naW5lLT5uYW1lLAorCQkJICAgIHJlZ3Nb
Q1RYX1JJTkdfQ1RMXSwKKwkJCSAgICAodTMyKShSSU5HX0NUTF9TSVpFKHJpbmctPnNpemUpIHwg
UklOR19WQUxJRCkpOworCQlyZWdzW0NUWF9SSU5HX0NUTF0gPSBSSU5HX0NUTF9TSVpFKHJpbmct
PnNpemUpIHwgUklOR19WQUxJRDsKKwl9CisKKwlpZiAocmVnc1tDVFhfQkJfU1RBVEVdICE9IFJJ
TkdfQkJfUFBHVFQpIHsKKwkJcHJfZXJyX29uY2UoIiVzOiBjb250ZXh0IHN1Ym1pdHRlZCB3aXRo
IGluY29ycmVjdCBCQl9TVEFURSBbJTA4eF0sIGV4cGVjdGVkICUwOHhcbiIsCisJCQkgICAgZW5n
aW5lLT5uYW1lLAorCQkJICAgIHJlZ3NbQ1RYX0JCX1NUQVRFXSwKKwkJCSAgICBSSU5HX0JCX1BQ
R1RUKTsKKwkJcmVnc1tDVFhfQkJfU1RBVEVdID0gUklOR19CQl9QUEdUVDsKKwl9CisKKwl4ID0g
bHJjX3JpbmdfbWlfbW9kZShlbmdpbmUpOworCWlmICh4ICE9IC0xICYmIHJlZ3NbeCArIDFdICYg
U1RPUF9SSU5HKSB7CisJCXByX2Vycl9vbmNlKCIlczogY29udGV4dCBzdWJtaXR0ZWQgd2l0aCBT
VE9QX1JJTkcgWyUwOHhdIGluIFJJTkdfTUlfTU9ERVxuIiwKKwkJCSAgICBlbmdpbmUtPm5hbWUs
IHJlZ3NbeCArIDFdKTsKKwkJcmVnc1t4ICsgMV0gJj0gflNUT1BfUklORzsKKwkJcmVnc1t4ICsg
MV0gfD0gU1RPUF9SSU5HIDw8IDE2OworCX0KK30KKwogc3RhdGljIHU2NCBleGVjbGlzdHNfdXBk
YXRlX2NvbnRleHQoY29uc3Qgc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEpCiB7CiAJc3RydWN0IGlu
dGVsX2NvbnRleHQgKmNlID0gcnEtPmNvbnRleHQ7CkBAIC0xMTU0LDYgKzEyMDgsOSBAQCBzdGF0
aWMgdTY0IGV4ZWNsaXN0c191cGRhdGVfY29udGV4dChjb25zdCBzdHJ1Y3QgaTkxNV9yZXF1ZXN0
ICpycSkKIAljZS0+bHJjX3JlZ19zdGF0ZVtDVFhfUklOR19UQUlMXSA9CiAJCWludGVsX3Jpbmdf
c2V0X3RhaWwocnEtPnJpbmcsIHJxLT50YWlsKTsKIAorCWlmIChJU19FTkFCTEVEKENPTkZJR19E
Uk1fSTkxNV9ERUJVR19HRU0pKQorCQlleGVjbGlzdHNfY2hlY2tfY29udGV4dChjZSwgcnEtPmVu
Z2luZSk7CisKIAkvKgogCSAqIE1ha2Ugc3VyZSB0aGUgY29udGV4dCBpbWFnZSBpcyBjb21wbGV0
ZSBiZWZvcmUgd2Ugc3VibWl0IGl0IHRvIEhXLgogCSAqCkBAIC0yMzU1LDcgKzI0MTIsNyBAQCBf
X2V4ZWNsaXN0c191cGRhdGVfcmVnX3N0YXRlKGNvbnN0IHN0cnVjdCBpbnRlbF9jb250ZXh0ICpj
ZSwKIAlHRU1fQlVHX09OKCFpbnRlbF9yaW5nX29mZnNldF92YWxpZChyaW5nLCByaW5nLT5oZWFk
KSk7CiAJR0VNX0JVR19PTighaW50ZWxfcmluZ19vZmZzZXRfdmFsaWQocmluZywgcmluZy0+dGFp
bCkpOwogCi0JcmVnc1tDVFhfUklOR19CVUZGRVJfU1RBUlRdID0gaTkxNV9nZ3R0X29mZnNldChy
aW5nLT52bWEpOworCXJlZ3NbQ1RYX1JJTkdfU1RBUlRdID0gaTkxNV9nZ3R0X29mZnNldChyaW5n
LT52bWEpOwogCXJlZ3NbQ1RYX1JJTkdfSEVBRF0gPSByaW5nLT5oZWFkOwogCXJlZ3NbQ1RYX1JJ
TkdfVEFJTF0gPSByaW5nLT50YWlsOwogCkBAIC0yOTQyLDE4ICsyOTk5LDYgQEAgc3RhdGljIHZv
aWQgcmVzZXRfY3NiX3BvaW50ZXJzKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKIAkJ
CSAgICAgICAmZXhlY2xpc3RzLT5jc2Jfc3RhdHVzW3Jlc2V0X3ZhbHVlXSk7CiB9CiAKLXN0YXRp
YyBpbnQgbHJjX3JpbmdfbWlfbW9kZShjb25zdCBzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdp
bmUpCi17Ci0JaWYgKElOVEVMX0dFTihlbmdpbmUtPmk5MTUpID49IDEyKQotCQlyZXR1cm4gMHg2
MDsKLQllbHNlIGlmIChJTlRFTF9HRU4oZW5naW5lLT5pOTE1KSA+PSA5KQotCQlyZXR1cm4gMHg1
NDsKLQllbHNlIGlmIChlbmdpbmUtPmNsYXNzID09IFJFTkRFUl9DTEFTUykKLQkJcmV0dXJuIDB4
NTg7Ci0JZWxzZQotCQlyZXR1cm4gLTE7Ci19Ci0KIHN0YXRpYyB2b2lkIF9fZXhlY2xpc3RzX3Jl
c2V0X3JlZ19zdGF0ZShjb25zdCBzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UsCiAJCQkJCWNvbnN0
IHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKIHsKQEAgLTM4ODEsNyArMzkyNiw3IEBA
IHN0YXRpYyB2b2lkIGluaXRfY29tbW9uX3JlZ19zdGF0ZSh1MzIgKiBjb25zdCByZWdzLAogCQkJ
X01BU0tFRF9CSVRfRElTQUJMRShDVFhfQ1RSTF9FTkdJTkVfQ1RYX1NBVkVfSU5ISUJJVCB8CiAJ
CQkJCSAgICBDVFhfQ1RSTF9SU19DVFhfRU5BQkxFKTsKIAotCXJlZ3NbQ1RYX1JJTkdfQlVGRkVS
X0NPTlRST0xdID0gUklOR19DVExfU0laRShyaW5nLT5zaXplKSB8IFJJTkdfVkFMSUQ7CisJcmVn
c1tDVFhfUklOR19DVExdID0gUklOR19DVExfU0laRShyaW5nLT5zaXplKSB8IFJJTkdfVkFMSUQ7
CiAJcmVnc1tDVFhfQkJfU1RBVEVdID0gUklOR19CQl9QUEdUVDsKIH0KIApkaWZmIC0tZ2l0IGEv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjX3JlZy5oIGIvZHJpdmVycy9ncHUvZHJt
L2k5MTUvZ3QvaW50ZWxfbHJjX3JlZy5oCmluZGV4IDA2YWIwMjc2ZTEwZS4uMDhhM2JlNjVmNzAw
IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9scmNfcmVnLmgKKysr
IGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjX3JlZy5oCkBAIC0xMyw4ICsxMyw4
IEBACiAjZGVmaW5lIENUWF9DT05URVhUX0NPTlRST0wJCSgweDAyICsgMSkKICNkZWZpbmUgQ1RY
X1JJTkdfSEVBRAkJCSgweDA0ICsgMSkKICNkZWZpbmUgQ1RYX1JJTkdfVEFJTAkJCSgweDA2ICsg
MSkKLSNkZWZpbmUgQ1RYX1JJTkdfQlVGRkVSX1NUQVJUCQkoMHgwOCArIDEpCi0jZGVmaW5lIENU
WF9SSU5HX0JVRkZFUl9DT05UUk9MCQkoMHgwYSArIDEpCisjZGVmaW5lIENUWF9SSU5HX1NUQVJU
CQkJKDB4MDggKyAxKQorI2RlZmluZSBDVFhfUklOR19DVEwJCQkoMHgwYSArIDEpCiAjZGVmaW5l
IENUWF9CQl9TVEFURQkJCSgweDEwICsgMSkKICNkZWZpbmUgQ1RYX0JCX1BFUl9DVFhfUFRSCQko
MHgxOCArIDEpCiAjZGVmaW5lIENUWF9QRFAzX1VEVwkJCSgweDI0ICsgMSkKZGlmZiAtLWdpdCBh
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L3NlbGZ0ZXN0X2xyYy5jIGIvZHJpdmVycy9ncHUvZHJt
L2k5MTUvZ3Qvc2VsZnRlc3RfbHJjLmMKaW5kZXggMDRkMGRkNmE5MzhhLi43ZDNjN2NhODExYjMg
MTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L3NlbGZ0ZXN0X2xyYy5jCisrKyBi
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L3NlbGZ0ZXN0X2xyYy5jCkBAIC0zMTc4LDEyICszMTc4
LDEyIEBAIHN0YXRpYyBpbnQgbGl2ZV9scmNfZml4ZWQodm9pZCAqYXJnKQogCQl9IHRibFtdID0g
ewogCQkJewogCQkJCWk5MTVfbW1pb19yZWdfb2Zmc2V0KFJJTkdfU1RBUlQoZW5naW5lLT5tbWlv
X2Jhc2UpKSwKLQkJCQlDVFhfUklOR19CVUZGRVJfU1RBUlQgLSAxLAorCQkJCUNUWF9SSU5HX1NU
QVJUIC0gMSwKIAkJCQkiUklOR19TVEFSVCIKIAkJCX0sCiAJCQl7CiAJCQkJaTkxNV9tbWlvX3Jl
Z19vZmZzZXQoUklOR19DVEwoZW5naW5lLT5tbWlvX2Jhc2UpKSwKLQkJCQlDVFhfUklOR19CVUZG
RVJfQ09OVFJPTCAtIDEsCisJCQkJQ1RYX1JJTkdfQ1RMIC0gMSwKIAkJCQkiUklOR19DVEwiCiAJ
CQl9LAogCQkJewotLSAKMi4yNC4wLnJjMQoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMu
ZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlz
dGluZm8vaW50ZWwtZ2Z4

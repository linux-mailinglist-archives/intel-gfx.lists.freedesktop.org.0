Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id A36C989FE2
	for <lists+intel-gfx@lfdr.de>; Mon, 12 Aug 2019 15:41:12 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 7C0466E514;
	Mon, 12 Aug 2019 13:41:10 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 7BB6189CAA
 for <intel-gfx@lists.freedesktop.org>; Mon, 12 Aug 2019 13:41:03 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17969929-1500050 
 for multiple; Mon, 12 Aug 2019 14:39:19 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 12 Aug 2019 14:39:12 +0100
Message-Id: <20190812133915.18824-15-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0.rc1
In-Reply-To: <20190812133915.18824-1-chris@chris-wilson.co.uk>
References: <20190812133915.18824-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 15/18] drm/i915: Move context management under
 GEM
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

S2VlcCB0cmFjayBvZiB0aGUgR0VNIGNvbnRleHRzIHVuZGVybmVhdGggaTkxNS0+Z2VtLmNvbnRl
eHRzIGFuZCBhc3NpZ24KdGhlbSB0aGVpciBvd24gbG9jayBmb3IgdGhlIHB1cnBvc2VzIG9mIGxp
c3QgbWFuYWdlbWVudC4KClNpZ25lZC1vZmYtYnk6IENocmlzIFdpbHNvbiA8Y2hyaXNAY2hyaXMt
d2lsc29uLmNvLnVrPgpDYzogVHZydGtvIFVyc3VsaW4gPHR2cnRrby51cnN1bGluQGludGVsLmNv
bT4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fY29udGV4dC5jICAgfCAx
MDggKysrKysrKy0tLS0tLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1f
Y29udGV4dC5oICAgfCAgIDQgKy0KIC4uLi9ncHUvZHJtL2k5MTUvZ2VtL3NlbGZ0ZXN0cy9tb2Nr
X2NvbnRleHQuYyB8ICAgMiArLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kZWJ1Z2ZzLmMg
ICAgICAgICAgIHwgIDE2ICstLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYuYyAgICAg
ICAgICAgICAgIHwgICAyIC0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZHJ2LmggICAgICAg
ICAgICAgICB8ICAyNCArKy0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbS5jICAgICAg
ICAgICAgICAgfCAgIDggKy0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcGVyZi5jICAgICAg
ICAgICAgICB8ICAxMyArKy0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfc3lzZnMuYyAgICAg
ICAgICAgICB8ICAzOCArKystLS0KIC4uLi9ncHUvZHJtL2k5MTUvc2VsZnRlc3RzL21vY2tfZ2Vt
X2RldmljZS5jICB8ICAgNCArLQogMTAgZmlsZXMgY2hhbmdlZCwgOTMgaW5zZXJ0aW9ucygrKSwg
MTI2IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9p
OTE1X2dlbV9jb250ZXh0LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fY29u
dGV4dC5jCmluZGV4IDc3NGEzYWM4NTNhOC4uNTFiODEwMWU5ODM2IDEwMDY0NAotLS0gYS9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fY29udGV4dC5jCisrKyBiL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jb250ZXh0LmMKQEAgLTIxOCw5ICsyMTgsMTIgQEAgc3Rh
dGljIHN0cnVjdCBpOTE1X2dlbV9lbmdpbmVzICpkZWZhdWx0X2VuZ2luZXMoc3RydWN0IGk5MTVf
Z2VtX2NvbnRleHQgKmN0eCkKIAogc3RhdGljIHZvaWQgaTkxNV9nZW1fY29udGV4dF9mcmVlKHN0
cnVjdCBpOTE1X2dlbV9jb250ZXh0ICpjdHgpCiB7Ci0JbG9ja2RlcF9hc3NlcnRfaGVsZCgmY3R4
LT5pOTE1LT5kcm0uc3RydWN0X211dGV4KTsKIAlHRU1fQlVHX09OKCFpOTE1X2dlbV9jb250ZXh0
X2lzX2Nsb3NlZChjdHgpKTsKIAorCW11dGV4X2xvY2soJmN0eC0+aTkxNS0+Z2VtLmNvbnRleHRz
Lm11dGV4KTsKKwlsaXN0X2RlbCgmY3R4LT5saW5rKTsKKwltdXRleF91bmxvY2soJmN0eC0+aTkx
NS0+Z2VtLmNvbnRleHRzLm11dGV4KTsKKwogCWlmIChjdHgtPnZtKQogCQlpOTE1X3ZtX3B1dChj
dHgtPnZtKTsKIApAQCAtMjMzLDU2ICsyMzYsNDAgQEAgc3RhdGljIHZvaWQgaTkxNV9nZW1fY29u
dGV4dF9mcmVlKHN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICpjdHgpCiAJa2ZyZWUoY3R4LT5uYW1l
KTsKIAlwdXRfcGlkKGN0eC0+cGlkKTsKIAotCWxpc3RfZGVsKCZjdHgtPmxpbmspOwogCW11dGV4
X2Rlc3Ryb3koJmN0eC0+bXV0ZXgpOwogCiAJa2ZyZWVfcmN1KGN0eCwgcmN1KTsKIH0KIAotc3Rh
dGljIHZvaWQgY29udGV4dHNfZnJlZShzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKK3N0
YXRpYyB2b2lkIGNvbnRleHRzX2ZyZWVfYWxsKHN0cnVjdCBsbGlzdF9ub2RlICpsaXN0KQogewot
CXN0cnVjdCBsbGlzdF9ub2RlICpmcmVlZCA9IGxsaXN0X2RlbF9hbGwoJmk5MTUtPmNvbnRleHRz
LmZyZWVfbGlzdCk7CiAJc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCwgKmNuOwogCi0JbG9j
a2RlcF9hc3NlcnRfaGVsZCgmaTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7Ci0KLQlsbGlzdF9mb3Jf
ZWFjaF9lbnRyeV9zYWZlKGN0eCwgY24sIGZyZWVkLCBmcmVlX2xpbmspCisJbGxpc3RfZm9yX2Vh
Y2hfZW50cnlfc2FmZShjdHgsIGNuLCBsaXN0LCBmcmVlX2xpbmspCiAJCWk5MTVfZ2VtX2NvbnRl
eHRfZnJlZShjdHgpOwogfQogCi1zdGF0aWMgdm9pZCBjb250ZXh0c19mcmVlX2ZpcnN0KHN0cnVj
dCBkcm1faTkxNV9wcml2YXRlICppOTE1KQorc3RhdGljIHZvaWQgY29udGV4dHNfZmx1c2hfZnJl
ZShzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dHMgKmdjKQogewotCXN0cnVjdCBpOTE1X2dlbV9jb250
ZXh0ICpjdHg7Ci0Jc3RydWN0IGxsaXN0X25vZGUgKmZyZWVkOwotCi0JbG9ja2RlcF9hc3NlcnRf
aGVsZCgmaTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7Ci0KLQlmcmVlZCA9IGxsaXN0X2RlbF9maXJz
dCgmaTkxNS0+Y29udGV4dHMuZnJlZV9saXN0KTsKLQlpZiAoIWZyZWVkKQotCQlyZXR1cm47Ci0K
LQljdHggPSBjb250YWluZXJfb2YoZnJlZWQsIHR5cGVvZigqY3R4KSwgZnJlZV9saW5rKTsKLQlp
OTE1X2dlbV9jb250ZXh0X2ZyZWUoY3R4KTsKKwljb250ZXh0c19mcmVlX2FsbChsbGlzdF9kZWxf
YWxsKCZnYy0+ZnJlZV9saXN0KSk7CiB9CiAKIHN0YXRpYyB2b2lkIGNvbnRleHRzX2ZyZWVfd29y
a2VyKHN0cnVjdCB3b3JrX3N0cnVjdCAqd29yaykKIHsKLQlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0
ZSAqaTkxNSA9Ci0JCWNvbnRhaW5lcl9vZih3b3JrLCB0eXBlb2YoKmk5MTUpLCBjb250ZXh0cy5m
cmVlX3dvcmspOworCXN0cnVjdCBpOTE1X2dlbV9jb250ZXh0cyAqZ2MgPQorCQljb250YWluZXJf
b2Yod29yaywgdHlwZW9mKCpnYyksIGZyZWVfd29yayk7CiAKLQltdXRleF9sb2NrKCZpOTE1LT5k
cm0uc3RydWN0X211dGV4KTsKLQljb250ZXh0c19mcmVlKGk5MTUpOwotCW11dGV4X3VubG9jaygm
aTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CisJY29udGV4dHNfZmx1c2hfZnJlZShnYyk7CiB9CiAK
IHZvaWQgaTkxNV9nZW1fY29udGV4dF9yZWxlYXNlKHN0cnVjdCBrcmVmICpyZWYpCiB7CiAJc3Ry
dWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCA9IGNvbnRhaW5lcl9vZihyZWYsIHR5cGVvZigqY3R4
KSwgcmVmKTsKLQlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSA9IGN0eC0+aTkxNTsKKwlz
dHJ1Y3QgaTkxNV9nZW1fY29udGV4dHMgKmdjID0gJmN0eC0+aTkxNS0+Z2VtLmNvbnRleHRzOwog
CiAJdHJhY2VfaTkxNV9jb250ZXh0X2ZyZWUoY3R4KTsKLQlpZiAobGxpc3RfYWRkKCZjdHgtPmZy
ZWVfbGluaywgJmk5MTUtPmNvbnRleHRzLmZyZWVfbGlzdCkpCi0JCXF1ZXVlX3dvcmsoaTkxNS0+
d3EsICZpOTE1LT5jb250ZXh0cy5mcmVlX3dvcmspOworCWlmIChsbGlzdF9hZGQoJmN0eC0+ZnJl
ZV9saW5rLCAmZ2MtPmZyZWVfbGlzdCkpCisJCXF1ZXVlX3dvcmsoY3R4LT5pOTE1LT53cSwgJmdj
LT5mcmVlX3dvcmspOwogfQogCiBzdGF0aWMgdm9pZCBjb250ZXh0X2Nsb3NlKHN0cnVjdCBpOTE1
X2dlbV9jb250ZXh0ICpjdHgpCkBAIC0zMTYsNyArMzAzLDYgQEAgX19jcmVhdGVfY29udGV4dChz
dHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKIAkJcmV0dXJuIEVSUl9QVFIoLUVOT01FTSk7
CiAKIAlrcmVmX2luaXQoJmN0eC0+cmVmKTsKLQlsaXN0X2FkZF90YWlsKCZjdHgtPmxpbmssICZp
OTE1LT5jb250ZXh0cy5saXN0KTsKIAljdHgtPmk5MTUgPSBpOTE1OwogCWN0eC0+c2NoZWQucHJp
b3JpdHkgPSBJOTE1X1VTRVJfUFJJT1JJVFkoSTkxNV9QUklPUklUWV9OT1JNQUwpOwogCW11dGV4
X2luaXQoJmN0eC0+bXV0ZXgpOwpAQCAtMzQyLDYgKzMyOCwxMCBAQCBfX2NyZWF0ZV9jb250ZXh0
KHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQogCWZvciAoaSA9IDA7IGkgPCBBUlJBWV9T
SVpFKGN0eC0+aGFuZ190aW1lc3RhbXApOyBpKyspCiAJCWN0eC0+aGFuZ190aW1lc3RhbXBbaV0g
PSBqaWZmaWVzIC0gQ09OVEVYVF9GQVNUX0hBTkdfSklGRklFUzsKIAorCW11dGV4X2xvY2soJmk5
MTUtPmdlbS5jb250ZXh0cy5tdXRleCk7CisJbGlzdF9hZGRfdGFpbCgmY3R4LT5saW5rLCAmaTkx
NS0+Z2VtLmNvbnRleHRzLmxpc3QpOworCW11dGV4X3VubG9jaygmaTkxNS0+Z2VtLmNvbnRleHRz
Lm11dGV4KTsKKwogCXJldHVybiBjdHg7CiAKIGVycl9mcmVlOgpAQCAtNDE2LDI3ICs0MDYsMjUg
QEAgc3RhdGljIHZvaWQgX19hc3NpZ25fdGltZWxpbmUoc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQg
KmN0eCwKIH0KIAogc3RhdGljIHN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICoKLWk5MTVfZ2VtX2Ny
ZWF0ZV9jb250ZXh0KHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiwgdW5zaWduZWQg
aW50IGZsYWdzKQoraTkxNV9nZW1fY3JlYXRlX2NvbnRleHQoc3RydWN0IGRybV9pOTE1X3ByaXZh
dGUgKmk5MTUsIHVuc2lnbmVkIGludCBmbGFncykKIHsKIAlzdHJ1Y3QgaTkxNV9nZW1fY29udGV4
dCAqY3R4OwogCi0JbG9ja2RlcF9hc3NlcnRfaGVsZCgmZGV2X3ByaXYtPmRybS5zdHJ1Y3RfbXV0
ZXgpOwotCiAJaWYgKGZsYWdzICYgSTkxNV9DT05URVhUX0NSRUFURV9GTEFHU19TSU5HTEVfVElN
RUxJTkUgJiYKLQkgICAgIUhBU19FWEVDTElTVFMoZGV2X3ByaXYpKQorCSAgICAhSEFTX0VYRUNM
SVNUUyhpOTE1KSkKIAkJcmV0dXJuIEVSUl9QVFIoLUVJTlZBTCk7CiAKLQkvKiBSZWFwIHRoZSBt
b3N0IHN0YWxlIGNvbnRleHQgKi8KLQljb250ZXh0c19mcmVlX2ZpcnN0KGRldl9wcml2KTsKKwkv
KiBSZWFwIHRoZSBzdGFsZSBjb250ZXh0cyAqLworCWNvbnRleHRzX2ZsdXNoX2ZyZWUoJmk5MTUt
PmdlbS5jb250ZXh0cyk7CiAKLQljdHggPSBfX2NyZWF0ZV9jb250ZXh0KGRldl9wcml2KTsKKwlj
dHggPSBfX2NyZWF0ZV9jb250ZXh0KGk5MTUpOwogCWlmIChJU19FUlIoY3R4KSkKIAkJcmV0dXJu
IGN0eDsKIAotCWlmIChIQVNfRlVMTF9QUEdUVChkZXZfcHJpdikpIHsKKwlpZiAoSEFTX0ZVTExf
UFBHVFQoaTkxNSkpIHsKIAkJc3RydWN0IGk5MTVfcHBndHQgKnBwZ3R0OwogCi0JCXBwZ3R0ID0g
aTkxNV9wcGd0dF9jcmVhdGUoZGV2X3ByaXYpOworCQlwcGd0dCA9IGk5MTVfcHBndHRfY3JlYXRl
KGk5MTUpOwogCQlpZiAoSVNfRVJSKHBwZ3R0KSkgewogCQkJRFJNX0RFQlVHX0RSSVZFUigiUFBH
VFQgc2V0dXAgZmFpbGVkICglbGQpXG4iLAogCQkJCQkgUFRSX0VSUihwcGd0dCkpOwpAQCAtNDUx
LDcgKzQzOSw3IEBAIGk5MTVfZ2VtX2NyZWF0ZV9jb250ZXh0KHN0cnVjdCBkcm1faTkxNV9wcml2
YXRlICpkZXZfcHJpdiwgdW5zaWduZWQgaW50IGZsYWdzKQogCWlmIChmbGFncyAmIEk5MTVfQ09O
VEVYVF9DUkVBVEVfRkxBR1NfU0lOR0xFX1RJTUVMSU5FKSB7CiAJCXN0cnVjdCBpbnRlbF90aW1l
bGluZSAqdGltZWxpbmU7CiAKLQkJdGltZWxpbmUgPSBpbnRlbF90aW1lbGluZV9jcmVhdGUoJmRl
dl9wcml2LT5ndCwgTlVMTCk7CisJCXRpbWVsaW5lID0gaW50ZWxfdGltZWxpbmVfY3JlYXRlKCZp
OTE1LT5ndCwgTlVMTCk7CiAJCWlmIChJU19FUlIodGltZWxpbmUpKSB7CiAJCQljb250ZXh0X2Ns
b3NlKGN0eCk7CiAJCQlyZXR1cm4gRVJSX0NBU1QodGltZWxpbmUpOwpAQCAtNDk2LDQ1ICs0ODQs
MzkgQEAgaTkxNV9nZW1fY29udGV4dF9jcmVhdGVfa2VybmVsKHN0cnVjdCBkcm1faTkxNV9wcml2
YXRlICppOTE1LCBpbnQgcHJpbykKIAlyZXR1cm4gY3R4OwogfQogCi1zdGF0aWMgdm9pZCBpbml0
X2NvbnRleHRzKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQorc3RhdGljIHZvaWQgaW5p
dF9jb250ZXh0cyhzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dHMgKmdjKQogewotCW11dGV4X2luaXQo
Jmk5MTUtPmNvbnRleHRzLm11dGV4KTsKLQlJTklUX0xJU1RfSEVBRCgmaTkxNS0+Y29udGV4dHMu
bGlzdCk7Ci0KLQkvKiBVc2luZyB0aGUgc2ltcGxlIGlkYSBpbnRlcmZhY2UsIHRoZSBtYXggaXMg
bGltaXRlZCBieSBzaXplb2YoaW50KSAqLwotCUJVSUxEX0JVR19PTihNQVhfQ09OVEVYVF9IV19J
RCA+IElOVF9NQVgpOwotCUJVSUxEX0JVR19PTihHRU4xMV9NQVhfQ09OVEVYVF9IV19JRCA+IElO
VF9NQVgpOwotCWlkYV9pbml0KCZpOTE1LT5jb250ZXh0cy5od19pZGEpOwotCUlOSVRfTElTVF9I
RUFEKCZpOTE1LT5jb250ZXh0cy5od19pZF9saXN0KTsKKwltdXRleF9pbml0KCZnYy0+bXV0ZXgp
OworCUlOSVRfTElTVF9IRUFEKCZnYy0+bGlzdCk7CiAKLQlJTklUX1dPUksoJmk5MTUtPmNvbnRl
eHRzLmZyZWVfd29yaywgY29udGV4dHNfZnJlZV93b3JrZXIpOwotCWluaXRfbGxpc3RfaGVhZCgm
aTkxNS0+Y29udGV4dHMuZnJlZV9saXN0KTsKKwlJTklUX1dPUksoJmdjLT5mcmVlX3dvcmssIGNv
bnRleHRzX2ZyZWVfd29ya2VyKTsKKwlpbml0X2xsaXN0X2hlYWQoJmdjLT5mcmVlX2xpc3QpOwog
fQogCi1pbnQgaTkxNV9nZW1fY29udGV4dHNfaW5pdChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAq
ZGV2X3ByaXYpCitpbnQgaTkxNV9nZW1faW5pdF9jb250ZXh0cyhzdHJ1Y3QgZHJtX2k5MTVfcHJp
dmF0ZSAqaTkxNSkKIHsKIAlzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4OwogCiAJLyogUmVh
c3N1cmUgb3Vyc2VsdmVzIHdlIGFyZSBvbmx5IGNhbGxlZCBvbmNlICovCi0JR0VNX0JVR19PTihk
ZXZfcHJpdi0+a2VybmVsX2NvbnRleHQpOworCUdFTV9CVUdfT04oaTkxNS0+a2VybmVsX2NvbnRl
eHQpOwogCi0JaW5pdF9jb250ZXh0cyhkZXZfcHJpdik7CisJaW5pdF9jb250ZXh0cygmaTkxNS0+
Z2VtLmNvbnRleHRzKTsKIAogCS8qIGxvd2VzdCBwcmlvcml0eTsgaWRsZSB0YXNrICovCi0JY3R4
ID0gaTkxNV9nZW1fY29udGV4dF9jcmVhdGVfa2VybmVsKGRldl9wcml2LCBJOTE1X1BSSU9SSVRZ
X01JTik7CisJY3R4ID0gaTkxNV9nZW1fY29udGV4dF9jcmVhdGVfa2VybmVsKGk5MTUsIEk5MTVf
UFJJT1JJVFlfTUlOKTsKIAlpZiAoSVNfRVJSKGN0eCkpIHsKIAkJRFJNX0VSUk9SKCJGYWlsZWQg
dG8gY3JlYXRlIGRlZmF1bHQgZ2xvYmFsIGNvbnRleHRcbiIpOwogCQlyZXR1cm4gUFRSX0VSUihj
dHgpOwogCX0KLQlkZXZfcHJpdi0+a2VybmVsX2NvbnRleHQgPSBjdHg7CisJaTkxNS0+a2VybmVs
X2NvbnRleHQgPSBjdHg7CiAKIAlEUk1fREVCVUdfRFJJVkVSKCIlcyBjb250ZXh0IHN1cHBvcnQg
aW5pdGlhbGl6ZWRcbiIsCi0JCQkgRFJJVkVSX0NBUFMoZGV2X3ByaXYpLT5oYXNfbG9naWNhbF9j
b250ZXh0cyA/CisJCQkgRFJJVkVSX0NBUFMoaTkxNSktPmhhc19sb2dpY2FsX2NvbnRleHRzID8K
IAkJCSAibG9naWNhbCIgOiAiZmFrZSIpOwogCXJldHVybiAwOwogfQogCi12b2lkIGk5MTVfZ2Vt
X2NvbnRleHRzX2Zpbmkoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCit2b2lkIGk5MTVf
Z2VtX2RyaXZlcl9yZWxlYXNlX19jb250ZXh0cyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkx
NSkKIHsKIAlsb2NrZGVwX2Fzc2VydF9oZWxkKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKIApA
QCAtNTk3LDkgKzU3OSw3IEBAIGludCBpOTE1X2dlbV9jb250ZXh0X29wZW4oc3RydWN0IGRybV9p
OTE1X3ByaXZhdGUgKmk5MTUsCiAJaWRyX2luaXQoJmZpbGVfcHJpdi0+Y29udGV4dF9pZHIpOwog
CWlkcl9pbml0X2Jhc2UoJmZpbGVfcHJpdi0+dm1faWRyLCAxKTsKIAotCW11dGV4X2xvY2soJmk5
MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOwogCWN0eCA9IGk5MTVfZ2VtX2NyZWF0ZV9jb250ZXh0KGk5
MTUsIDApOwotCW11dGV4X3VubG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CiAJaWYgKElT
X0VSUihjdHgpKSB7CiAJCWVyciA9IFBUUl9FUlIoY3R4KTsKIAkJZ290byBlcnI7CkBAIC02Mjcs
NiArNjA3LDcgQEAgaW50IGk5MTVfZ2VtX2NvbnRleHRfb3BlbihzdHJ1Y3QgZHJtX2k5MTVfcHJp
dmF0ZSAqaTkxNSwKIHZvaWQgaTkxNV9nZW1fY29udGV4dF9jbG9zZShzdHJ1Y3QgZHJtX2ZpbGUg
KmZpbGUpCiB7CiAJc3RydWN0IGRybV9pOTE1X2ZpbGVfcHJpdmF0ZSAqZmlsZV9wcml2ID0gZmls
ZS0+ZHJpdmVyX3ByaXY7CisJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUgPSBmaWxlX3By
aXYtPmRldl9wcml2OwogCiAJaWRyX2Zvcl9lYWNoKCZmaWxlX3ByaXYtPmNvbnRleHRfaWRyLCBj
b250ZXh0X2lkcl9jbGVhbnVwLCBOVUxMKTsKIAlpZHJfZGVzdHJveSgmZmlsZV9wcml2LT5jb250
ZXh0X2lkcik7CkBAIC02MzUsNiArNjE2LDggQEAgdm9pZCBpOTE1X2dlbV9jb250ZXh0X2Nsb3Nl
KHN0cnVjdCBkcm1fZmlsZSAqZmlsZSkKIAlpZHJfZm9yX2VhY2goJmZpbGVfcHJpdi0+dm1faWRy
LCB2bV9pZHJfY2xlYW51cCwgTlVMTCk7CiAJaWRyX2Rlc3Ryb3koJmZpbGVfcHJpdi0+dm1faWRy
KTsKIAltdXRleF9kZXN0cm95KCZmaWxlX3ByaXYtPnZtX2lkcl9sb2NrKTsKKworCWNvbnRleHRz
X2ZsdXNoX2ZyZWUoJmk5MTUtPmdlbS5jb250ZXh0cyk7CiB9CiAKIGludCBpOTE1X2dlbV92bV9j
cmVhdGVfaW9jdGwoc3RydWN0IGRybV9kZXZpY2UgKmRldiwgdm9pZCAqZGF0YSwKQEAgLTE5NzUs
MTIgKzE5NTgsNyBAQCBpbnQgaTkxNV9nZW1fY29udGV4dF9jcmVhdGVfaW9jdGwoc3RydWN0IGRy
bV9kZXZpY2UgKmRldiwgdm9pZCAqZGF0YSwKIAkJcmV0dXJuIC1FSU87CiAJfQogCi0JcmV0ID0g
aTkxNV9tdXRleF9sb2NrX2ludGVycnVwdGlibGUoZGV2KTsKLQlpZiAocmV0KQotCQlyZXR1cm4g
cmV0OwotCiAJZXh0X2RhdGEuY3R4ID0gaTkxNV9nZW1fY3JlYXRlX2NvbnRleHQoaTkxNSwgYXJn
cy0+ZmxhZ3MpOwotCW11dGV4X3VubG9jaygmZGV2LT5zdHJ1Y3RfbXV0ZXgpOwogCWlmIChJU19F
UlIoZXh0X2RhdGEuY3R4KSkKIAkJcmV0dXJuIFBUUl9FUlIoZXh0X2RhdGEuY3R4KTsKIApAQCAt
MjE3OCw3ICsyMTU2LDcgQEAgaW50IGk5MTVfZ2VtX2NvbnRleHRfc2V0cGFyYW1faW9jdGwoc3Ry
dWN0IGRybV9kZXZpY2UgKmRldiwgdm9pZCAqZGF0YSwKIGludCBpOTE1X2dlbV9jb250ZXh0X3Jl
c2V0X3N0YXRzX2lvY3RsKHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsCiAJCQkJICAgICAgIHZvaWQg
KmRhdGEsIHN0cnVjdCBkcm1fZmlsZSAqZmlsZSkKIHsKLQlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0
ZSAqZGV2X3ByaXYgPSB0b19pOTE1KGRldik7CisJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5
MTUgPSB0b19pOTE1KGRldik7CiAJc3RydWN0IGRybV9pOTE1X3Jlc2V0X3N0YXRzICphcmdzID0g
ZGF0YTsKIAlzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4OwogCWludCByZXQ7CkBAIC0yMjAw
LDcgKzIxNzgsNyBAQCBpbnQgaTkxNV9nZW1fY29udGV4dF9yZXNldF9zdGF0c19pb2N0bChzdHJ1
Y3QgZHJtX2RldmljZSAqZGV2LAogCSAqLwogCiAJaWYgKGNhcGFibGUoQ0FQX1NZU19BRE1JTikp
Ci0JCWFyZ3MtPnJlc2V0X2NvdW50ID0gaTkxNV9yZXNldF9jb3VudCgmZGV2X3ByaXYtPmdwdV9l
cnJvcik7CisJCWFyZ3MtPnJlc2V0X2NvdW50ID0gaTkxNV9yZXNldF9jb3VudCgmaTkxNS0+Z3B1
X2Vycm9yKTsKIAllbHNlCiAJCWFyZ3MtPnJlc2V0X2NvdW50ID0gMDsKIApkaWZmIC0tZ2l0IGEv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRleHQuaCBiL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jb250ZXh0LmgKaW5kZXggNTBiYzI3ZDMwYzAzLi40NDE3
MTVmOWVlM2EgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9j
b250ZXh0LmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRleHQu
aApAQCAtMTE4LDggKzExOCw4IEBAIHN0YXRpYyBpbmxpbmUgYm9vbCBpOTE1X2dlbV9jb250ZXh0
X2lzX2tlcm5lbChzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4KQogfQogCiAvKiBpOTE1X2dl
bV9jb250ZXh0LmMgKi8KLWludCBfX211c3RfY2hlY2sgaTkxNV9nZW1fY29udGV4dHNfaW5pdChz
dHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYpOwotdm9pZCBpOTE1X2dlbV9jb250ZXh0
c19maW5pKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdik7CitpbnQgX19tdXN0X2No
ZWNrIGk5MTVfZ2VtX2luaXRfY29udGV4dHMoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUp
Owordm9pZCBpOTE1X2dlbV9kcml2ZXJfcmVsZWFzZV9fY29udGV4dHMoc3RydWN0IGRybV9pOTE1
X3ByaXZhdGUgKmk5MTUpOwogCiBpbnQgaTkxNV9nZW1fY29udGV4dF9vcGVuKHN0cnVjdCBkcm1f
aTkxNV9wcml2YXRlICppOTE1LAogCQkJICBzdHJ1Y3QgZHJtX2ZpbGUgKmZpbGUpOwpkaWZmIC0t
Z2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL3NlbGZ0ZXN0cy9tb2NrX2NvbnRleHQuYyBi
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMvbW9ja19jb250ZXh0LmMKaW5kZXgg
MDEwNGYxNmIxMzI3Li5lMzZhZjVhNWNlNDIgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2dlbS9zZWxmdGVzdHMvbW9ja19jb250ZXh0LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ2VtL3NlbGZ0ZXN0cy9tb2NrX2NvbnRleHQuYwpAQCAtNjUsNyArNjUsNyBAQCB2b2lkIG1v
Y2tfY29udGV4dF9jbG9zZShzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4KQogCiB2b2lkIG1v
Y2tfaW5pdF9jb250ZXh0cyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKIHsKLQlpbml0
X2NvbnRleHRzKGk5MTUpOworCWluaXRfY29udGV4dHMoJmk5MTUtPmdlbS5jb250ZXh0cyk7CiB9
CiAKIHN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2k5MTVfZGVidWdmcy5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kZWJ1Z2Zz
LmMKaW5kZXggYTMzOTNkOWZhODRlLi5hZWQ1NDk5MDY0MTAgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2k5MTVfZGVidWdmcy5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5
MTVfZGVidWdmcy5jCkBAIC0zMTEsNyArMzExLDggQEAgc3RhdGljIHZvaWQgcHJpbnRfY29udGV4
dF9zdGF0cyhzdHJ1Y3Qgc2VxX2ZpbGUgKm0sCiAJc3RydWN0IGZpbGVfc3RhdHMga3N0YXRzID0g
e307CiAJc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eDsKIAotCWxpc3RfZm9yX2VhY2hfZW50
cnkoY3R4LCAmaTkxNS0+Y29udGV4dHMubGlzdCwgbGluaykgeworCWxvY2tkZXBfYXNzZXJ0X2hl
bGQoJmk5MTUtPmdlbS5jb250ZXh0cy5tdXRleCk7CisJbGlzdF9mb3JfZWFjaF9lbnRyeShjdHgs
ICZpOTE1LT5nZW0uY29udGV4dHMubGlzdCwgbGluaykgewogCQlzdHJ1Y3QgaTkxNV9nZW1fZW5n
aW5lc19pdGVyIGl0OwogCQlzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2U7CiAKQEAgLTM2MywxMiAr
MzY0LDEyIEBAIHN0YXRpYyBpbnQgaTkxNV9nZW1fb2JqZWN0X2luZm8oc3RydWN0IHNlcV9maWxl
ICptLCB2b2lkICpkYXRhKQogCiAJc2VxX3B1dGMobSwgJ1xuJyk7CiAKLQlyZXQgPSBtdXRleF9s
b2NrX2ludGVycnVwdGlibGUoJmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOworCXJldCA9IG11dGV4
X2xvY2tfaW50ZXJydXB0aWJsZSgmaTkxNS0+Z2VtLmNvbnRleHRzLm11dGV4KTsKIAlpZiAocmV0
KQogCQlyZXR1cm4gcmV0OwogCiAJcHJpbnRfY29udGV4dF9zdGF0cyhtLCBpOTE1KTsKLQltdXRl
eF91bmxvY2soJmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOworCW11dGV4X3VubG9jaygmaTkxNS0+
Z2VtLmNvbnRleHRzLm11dGV4KTsKIAogCXJldHVybiAwOwogfQpAQCAtMTU2MywxNiArMTU2NCwx
NSBAQCBzdGF0aWMgdm9pZCBkZXNjcmliZV9jdHhfcmluZyhzdHJ1Y3Qgc2VxX2ZpbGUgKm0sIHN0
cnVjdCBpbnRlbF9yaW5nICpyaW5nKQogCiBzdGF0aWMgaW50IGk5MTVfY29udGV4dF9zdGF0dXMo
c3RydWN0IHNlcV9maWxlICptLCB2b2lkICp1bnVzZWQpCiB7Ci0Jc3RydWN0IGRybV9pOTE1X3By
aXZhdGUgKmRldl9wcml2ID0gbm9kZV90b19pOTE1KG0tPnByaXZhdGUpOwotCXN0cnVjdCBkcm1f
ZGV2aWNlICpkZXYgPSAmZGV2X3ByaXYtPmRybTsKKwlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAq
aTkxNSA9IG5vZGVfdG9faTkxNShtLT5wcml2YXRlKTsKIAlzdHJ1Y3QgaTkxNV9nZW1fY29udGV4
dCAqY3R4OwogCWludCByZXQ7CiAKLQlyZXQgPSBtdXRleF9sb2NrX2ludGVycnVwdGlibGUoJmRl
di0+c3RydWN0X211dGV4KTsKKwlyZXQgPSBtdXRleF9sb2NrX2ludGVycnVwdGlibGUoJmk5MTUt
PmdlbS5jb250ZXh0cy5tdXRleCk7CiAJaWYgKHJldCkKIAkJcmV0dXJuIHJldDsKIAotCWxpc3Rf
Zm9yX2VhY2hfZW50cnkoY3R4LCAmZGV2X3ByaXYtPmNvbnRleHRzLmxpc3QsIGxpbmspIHsKKwls
aXN0X2Zvcl9lYWNoX2VudHJ5KGN0eCwgJmk5MTUtPmdlbS5jb250ZXh0cy5saXN0LCBsaW5rKSB7
CiAJCXN0cnVjdCBpOTE1X2dlbV9lbmdpbmVzX2l0ZXIgaXQ7CiAJCXN0cnVjdCBpbnRlbF9jb250
ZXh0ICpjZTsKIApAQCAtMTYxMiw3ICsxNjEyLDcgQEAgc3RhdGljIGludCBpOTE1X2NvbnRleHRf
c3RhdHVzKHN0cnVjdCBzZXFfZmlsZSAqbSwgdm9pZCAqdW51c2VkKQogCQlzZXFfcHV0YyhtLCAn
XG4nKTsKIAl9CiAKLQltdXRleF91bmxvY2soJmRldi0+c3RydWN0X211dGV4KTsKKwltdXRleF91
bmxvY2soJmk5MTUtPmdlbS5jb250ZXh0cy5tdXRleCk7CiAKIAlyZXR1cm4gMDsKIH0KZGlmZiAt
LWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZHJ2LmMgYi9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9pOTE1X2Rydi5jCmluZGV4IGE3YzYyYmM3OTUwYi4uOGNiZjI0NjE2MTVmIDEwMDY0NAot
LS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2Rydi5jCisrKyBiL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2k5MTVfZHJ2LmMKQEAgLTE2MzIsMTAgKzE2MzIsOCBAQCBzdGF0aWMgdm9pZCBpOTE1
X2RyaXZlcl9wb3N0Y2xvc2Uoc3RydWN0IGRybV9kZXZpY2UgKmRldiwgc3RydWN0IGRybV9maWxl
ICpmaWxlKQogewogCXN0cnVjdCBkcm1faTkxNV9maWxlX3ByaXZhdGUgKmZpbGVfcHJpdiA9IGZp
bGUtPmRyaXZlcl9wcml2OwogCi0JbXV0ZXhfbG9jaygmZGV2LT5zdHJ1Y3RfbXV0ZXgpOwogCWk5
MTVfZ2VtX2NvbnRleHRfY2xvc2UoZmlsZSk7CiAJaTkxNV9nZW1fcmVsZWFzZShkZXYsIGZpbGUp
OwotCW11dGV4X3VubG9jaygmZGV2LT5zdHJ1Y3RfbXV0ZXgpOwogCiAJa2ZyZWUoZmlsZV9wcml2
KTsKIApkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYuaCBiL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L2k5MTVfZHJ2LmgKaW5kZXggNTI1ZTYzNjZkNDZjLi45MDk3ZGY5ODZi
MzIgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZHJ2LmgKKysrIGIvZHJp
dmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYuaApAQCAtMTU5MCwyMyArMTU5MCw2IEBAIHN0cnVj
dCBkcm1faTkxNV9wcml2YXRlIHsKIAlzdHJ1Y3QgbXV0ZXggYXZfbXV0ZXg7CiAJaW50IGF1ZGlv
X3Bvd2VyX3JlZmNvdW50OwogCi0Jc3RydWN0IHsKLQkJc3RydWN0IG11dGV4IG11dGV4OwotCQlz
dHJ1Y3QgbGlzdF9oZWFkIGxpc3Q7Ci0JCXN0cnVjdCBsbGlzdF9oZWFkIGZyZWVfbGlzdDsKLQkJ
c3RydWN0IHdvcmtfc3RydWN0IGZyZWVfd29yazsKLQotCQkvKiBUaGUgaHcgd2FudHMgdG8gaGF2
ZSBhIHN0YWJsZSBjb250ZXh0IGlkZW50aWZpZXIgZm9yIHRoZQotCQkgKiBsaWZldGltZSBvZiB0
aGUgY29udGV4dCAoZm9yIE9BLCBQQVNJRCwgZmF1bHRzLCBldGMpLgotCQkgKiBUaGlzIGlzIGxp
bWl0ZWQgaW4gZXhlY2xpc3RzIHRvIDIxIGJpdHMuCi0JCSAqLwotCQlzdHJ1Y3QgaWRhIGh3X2lk
YTsKLSNkZWZpbmUgTUFYX0NPTlRFWFRfSFdfSUQgKDE8PDIxKSAvKiBleGNsdXNpdmUgKi8KLSNk
ZWZpbmUgTUFYX0dVQ19DT05URVhUX0hXX0lEICgxIDw8IDIwKSAvKiBleGNsdXNpdmUgKi8KLSNk
ZWZpbmUgR0VOMTFfTUFYX0NPTlRFWFRfSFdfSUQgKDE8PDExKSAvKiBleGNsdXNpdmUgKi8KLQkJ
c3RydWN0IGxpc3RfaGVhZCBod19pZF9saXN0OwotCX0gY29udGV4dHM7Ci0KIAl1MzIgZmRpX3J4
X2NvbmZpZzsKIAogCS8qIFNoYWRvdyBmb3IgRElTUExBWV9QSFlfQ09OVFJPTCB3aGljaCBjYW4n
dCBiZSBzYWZlbHkgcmVhZCAqLwpAQCAtMTc4MCw2ICsxNzYzLDEzIEBAIHN0cnVjdCBkcm1faTkx
NV9wcml2YXRlIHsKIAkJICogb2ZmIHRoZSBpZGxlX3dvcmsuCiAJCSAqLwogCQlzdHJ1Y3Qgd29y
a19zdHJ1Y3QgaWRsZV93b3JrOworCisJCXN0cnVjdCBpOTE1X2dlbV9jb250ZXh0cyB7CisJCQlz
dHJ1Y3QgbXV0ZXggbXV0ZXg7CisJCQlzdHJ1Y3QgbGlzdF9oZWFkIGxpc3Q7CisJCQlzdHJ1Y3Qg
bGxpc3RfaGVhZCBmcmVlX2xpc3Q7CisJCQlzdHJ1Y3Qgd29ya19zdHJ1Y3QgZnJlZV93b3JrOwor
CQl9IGNvbnRleHRzOwogCX0gZ2VtOwogCiAJLyogRm9yIGk5NDVnbSB2YmxhbmsgaXJxIHZzLiBD
MyB3b3JrYXJvdW5kICovCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dl
bS5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW0uYwppbmRleCA3MWVlNGM3MTAyNTIu
LmQ1N2U0MzgxN2EwZCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW0u
YworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbS5jCkBAIC0xNDUwLDcgKzE0NTAs
NyBAQCBpbnQgaTkxNV9nZW1faW5pdChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYp
CiAJCWdvdG8gZXJyX3VubG9jazsKIAl9CiAKLQlyZXQgPSBpOTE1X2dlbV9jb250ZXh0c19pbml0
KGRldl9wcml2KTsKKwlyZXQgPSBpOTE1X2dlbV9pbml0X2NvbnRleHRzKGRldl9wcml2KTsKIAlp
ZiAocmV0KSB7CiAJCUdFTV9CVUdfT04ocmV0ID09IC1FSU8pOwogCQlnb3RvIGVycl9zY3JhdGNo
OwpAQCAtMTUzOSw3ICsxNTM5LDcgQEAgaW50IGk5MTVfZ2VtX2luaXQoc3RydWN0IGRybV9pOTE1
X3ByaXZhdGUgKmRldl9wcml2KQogCX0KIGVycl9jb250ZXh0OgogCWlmIChyZXQgIT0gLUVJTykK
LQkJaTkxNV9nZW1fY29udGV4dHNfZmluaShkZXZfcHJpdik7CisJCWk5MTVfZ2VtX2RyaXZlcl9y
ZWxlYXNlX19jb250ZXh0cyhkZXZfcHJpdik7CiBlcnJfc2NyYXRjaDoKIAlpOTE1X2dlbV9maW5p
X3NjcmF0Y2goZGV2X3ByaXYpOwogZXJyX2dndHQ6CkBAIC0xNjE2LDcgKzE2MTYsNyBAQCB2b2lk
IGk5MTVfZ2VtX2RyaXZlcl9yZWxlYXNlKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJp
dikKIHsKIAltdXRleF9sb2NrKCZkZXZfcHJpdi0+ZHJtLnN0cnVjdF9tdXRleCk7CiAJaW50ZWxf
ZW5naW5lc19jbGVhbnVwKGRldl9wcml2KTsKLQlpOTE1X2dlbV9jb250ZXh0c19maW5pKGRldl9w
cml2KTsKKwlpOTE1X2dlbV9kcml2ZXJfcmVsZWFzZV9fY29udGV4dHMoZGV2X3ByaXYpOwogCWk5
MTVfZ2VtX2Zpbmlfc2NyYXRjaChkZXZfcHJpdik7CiAJbXV0ZXhfdW5sb2NrKCZkZXZfcHJpdi0+
ZHJtLnN0cnVjdF9tdXRleCk7CiAKQEAgLTE2MzAsNyArMTYzMCw3IEBAIHZvaWQgaTkxNV9nZW1f
ZHJpdmVyX3JlbGVhc2Uoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2KQogCiAJaTkx
NV9nZW1fZHJhaW5fZnJlZWRfb2JqZWN0cyhkZXZfcHJpdik7CiAKLQlXQVJOX09OKCFsaXN0X2Vt
cHR5KCZkZXZfcHJpdi0+Y29udGV4dHMubGlzdCkpOworCVdBUk5fT04oIWxpc3RfZW1wdHkoJmRl
dl9wcml2LT5nZW0uY29udGV4dHMubGlzdCkpOwogfQogCiB2b2lkIGk5MTVfZ2VtX2luaXRfbW1p
byhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L2k5MTVfcGVyZi5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wZXJmLmMK
aW5kZXggM2Q0M2NkZTNlYzUwLi4wYzZhYjdiMTQxYmMgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L2k5MTVfcGVyZi5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcGVy
Zi5jCkBAIC0xODgyLDcgKzE4ODIsNyBAQCBzdGF0aWMgaW50IGdlbjhfY29uZmlndXJlX2FsbF9j
b250ZXh0cyhzdHJ1Y3QgaTkxNV9wZXJmX3N0cmVhbSAqc3RyZWFtLAogI3VuZGVmIGN0eF9mbGV4
ZXVOCiAJc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lOwogCXN0cnVjdCBpOTE1X2dlbV9j
b250ZXh0ICpjdHg7Ci0JaW50IGk7CisJaW50IGksIGVycjsKIAogCWZvciAoaSA9IDI7IGkgPCBB
UlJBWV9TSVpFKHJlZ3MpOyBpKyspCiAJCXJlZ3NbaV0udmFsdWUgPSBvYV9jb25maWdfZmxleF9y
ZWcob2FfY29uZmlnLCByZWdzW2ldLnJlZyk7CkBAIC0xOTA1LDE2ICsxOTA1LDE4IEBAIHN0YXRp
YyBpbnQgZ2VuOF9jb25maWd1cmVfYWxsX2NvbnRleHRzKHN0cnVjdCBpOTE1X3BlcmZfc3RyZWFt
ICpzdHJlYW0sCiAJICogY29udGV4dC4gQ29udGV4dHMgaWRsZSBhdCB0aGUgdGltZSBvZiByZWNv
bmZpZ3VyYXRpb24gYXJlIG5vdAogCSAqIHRyYXBwZWQgYmVoaW5kIHRoZSBiYXJyaWVyLgogCSAq
LwotCWxpc3RfZm9yX2VhY2hfZW50cnkoY3R4LCAmaTkxNS0+Y29udGV4dHMubGlzdCwgbGluaykg
ewotCQlpbnQgZXJyOwotCisJbXV0ZXhfbG9jaygmaTkxNS0+Z2VtLmNvbnRleHRzLm11dGV4KTsK
KwlsaXN0X2Zvcl9lYWNoX2VudHJ5KGN0eCwgJmk5MTUtPmdlbS5jb250ZXh0cy5saXN0LCBsaW5r
KSB7CiAJCWlmIChjdHggPT0gaTkxNS0+a2VybmVsX2NvbnRleHQpCiAJCQljb250aW51ZTsKIAog
CQllcnIgPSBnZW44X2NvbmZpZ3VyZV9jb250ZXh0KGN0eCwgcmVncywgQVJSQVlfU0laRShyZWdz
KSk7CiAJCWlmIChlcnIpCi0JCQlyZXR1cm4gZXJyOworCQkJYnJlYWs7CiAJfQorCW11dGV4X3Vu
bG9jaygmaTkxNS0+Z2VtLmNvbnRleHRzLm11dGV4KTsKKwlpZiAoZXJyKQorCQlyZXR1cm4gZXJy
OwogCiAJLyoKIAkgKiBBZnRlciB1cGRhdGluZyBhbGwgb3RoZXIgY29udGV4dHMsIHdlIG5lZWQg
dG8gbW9kaWZ5IG91cnNlbHZlcy4KQEAgLTE5MjMsNyArMTkyNSw2IEBAIHN0YXRpYyBpbnQgZ2Vu
OF9jb25maWd1cmVfYWxsX2NvbnRleHRzKHN0cnVjdCBpOTE1X3BlcmZfc3RyZWFtICpzdHJlYW0s
CiAJICovCiAJZm9yX2VhY2hfdWFiaV9lbmdpbmUoZW5naW5lLCBpOTE1KSB7CiAJCXN0cnVjdCBp
bnRlbF9jb250ZXh0ICpjZSA9IGVuZ2luZS0+a2VybmVsX2NvbnRleHQ7Ci0JCWludCBlcnI7CiAK
IAkJaWYgKGVuZ2luZS0+Y2xhc3MgIT0gUkVOREVSX0NMQVNTKQogCQkJY29udGludWU7CmRpZmYg
LS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3N5c2ZzLmMgYi9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9pOTE1X3N5c2ZzLmMKaW5kZXggZDhhM2IxODBjMDg0Li5iMjBmMGIyYjUzOGEgMTAw
NjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfc3lzZnMuYworKysgYi9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9pOTE1X3N5c2ZzLmMKQEAgLTE0Miw5ICsxNDIsOSBAQCBzdGF0aWMgY29u
c3Qgc3RydWN0IGF0dHJpYnV0ZV9ncm91cCBtZWRpYV9yYzZfYXR0cl9ncm91cCA9IHsKIH07CiAj
ZW5kaWYKIAotc3RhdGljIGludCBsM19hY2Nlc3NfdmFsaWQoc3RydWN0IGRybV9pOTE1X3ByaXZh
dGUgKmRldl9wcml2LCBsb2ZmX3Qgb2Zmc2V0KQorc3RhdGljIGludCBsM19hY2Nlc3NfdmFsaWQo
c3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUsIGxvZmZfdCBvZmZzZXQpCiB7Ci0JaWYgKCFI
QVNfTDNfRFBGKGRldl9wcml2KSkKKwlpZiAoIUhBU19MM19EUEYoaTkxNSkpCiAJCXJldHVybiAt
RVBFUk07CiAKIAlpZiAob2Zmc2V0ICUgNCAhPSAwKQpAQCAtMTYyLDMxICsxNjIsMzAgQEAgaTkx
NV9sM19yZWFkKHN0cnVjdCBmaWxlICpmaWxwLCBzdHJ1Y3Qga29iamVjdCAqa29iaiwKIAkgICAg
IGxvZmZfdCBvZmZzZXQsIHNpemVfdCBjb3VudCkKIHsKIAlzdHJ1Y3QgZGV2aWNlICprZGV2ID0g
a29ial90b19kZXYoa29iaik7Ci0Jc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2ID0g
a2Rldl9taW5vcl90b19pOTE1KGtkZXYpOwotCXN0cnVjdCBkcm1fZGV2aWNlICpkZXYgPSAmZGV2
X3ByaXYtPmRybTsKKwlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSA9IGtkZXZfbWlub3Jf
dG9faTkxNShrZGV2KTsKIAlpbnQgc2xpY2UgPSAoaW50KSh1aW50cHRyX3QpYXR0ci0+cHJpdmF0
ZTsKIAlpbnQgcmV0OwogCiAJY291bnQgPSByb3VuZF9kb3duKGNvdW50LCA0KTsKIAotCXJldCA9
IGwzX2FjY2Vzc192YWxpZChkZXZfcHJpdiwgb2Zmc2V0KTsKKwlyZXQgPSBsM19hY2Nlc3NfdmFs
aWQoaTkxNSwgb2Zmc2V0KTsKIAlpZiAocmV0KQogCQlyZXR1cm4gcmV0OwogCiAJY291bnQgPSBt
aW5fdChzaXplX3QsIEdFTjdfTDNMT0dfU0laRSAtIG9mZnNldCwgY291bnQpOwogCi0JcmV0ID0g
aTkxNV9tdXRleF9sb2NrX2ludGVycnVwdGlibGUoZGV2KTsKKwlyZXQgPSBtdXRleF9sb2NrX2lu
dGVycnVwdGlibGUoJmk5MTUtPmdlbS5jb250ZXh0cy5tdXRleCk7CiAJaWYgKHJldCkKIAkJcmV0
dXJuIHJldDsKIAotCWlmIChkZXZfcHJpdi0+bDNfcGFyaXR5LnJlbWFwX2luZm9bc2xpY2VdKQor
CWlmIChpOTE1LT5sM19wYXJpdHkucmVtYXBfaW5mb1tzbGljZV0pCiAJCW1lbWNweShidWYsCi0J
CSAgICAgICBkZXZfcHJpdi0+bDNfcGFyaXR5LnJlbWFwX2luZm9bc2xpY2VdICsgKG9mZnNldC80
KSwKKwkJICAgICAgIGk5MTUtPmwzX3Bhcml0eS5yZW1hcF9pbmZvW3NsaWNlXSArIG9mZnNldCAv
IDQsCiAJCSAgICAgICBjb3VudCk7CiAJZWxzZQogCQltZW1zZXQoYnVmLCAwLCBjb3VudCk7CiAK
LQltdXRleF91bmxvY2soJmRldi0+c3RydWN0X211dGV4KTsKKwltdXRleF91bmxvY2soJmk5MTUt
PmdlbS5jb250ZXh0cy5tdXRleCk7CiAKIAlyZXR1cm4gY291bnQ7CiB9CkBAIC0xOTcsMjIgKzE5
NiwyMyBAQCBpOTE1X2wzX3dyaXRlKHN0cnVjdCBmaWxlICpmaWxwLCBzdHJ1Y3Qga29iamVjdCAq
a29iaiwKIAkgICAgICBsb2ZmX3Qgb2Zmc2V0LCBzaXplX3QgY291bnQpCiB7CiAJc3RydWN0IGRl
dmljZSAqa2RldiA9IGtvYmpfdG9fZGV2KGtvYmopOwotCXN0cnVjdCBkcm1faTkxNV9wcml2YXRl
ICpkZXZfcHJpdiA9IGtkZXZfbWlub3JfdG9faTkxNShrZGV2KTsKLQlzdHJ1Y3QgZHJtX2Rldmlj
ZSAqZGV2ID0gJmRldl9wcml2LT5kcm07CisJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUg
PSBrZGV2X21pbm9yX3RvX2k5MTUoa2Rldik7CiAJc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0
eDsKIAlpbnQgc2xpY2UgPSAoaW50KSh1aW50cHRyX3QpYXR0ci0+cHJpdmF0ZTsKIAl1MzIgKipy
ZW1hcF9pbmZvOwogCWludCByZXQ7CiAKLQlyZXQgPSBsM19hY2Nlc3NfdmFsaWQoZGV2X3ByaXYs
IG9mZnNldCk7CisJY291bnQgPSByb3VuZF9kb3duKGNvdW50LCA0KTsKKworCXJldCA9IGwzX2Fj
Y2Vzc192YWxpZChpOTE1LCBvZmZzZXQpOwogCWlmIChyZXQpCiAJCXJldHVybiByZXQ7CiAKLQly
ZXQgPSBpOTE1X211dGV4X2xvY2tfaW50ZXJydXB0aWJsZShkZXYpOworCXJldCA9IG11dGV4X2xv
Y2tfaW50ZXJydXB0aWJsZSgmaTkxNS0+Z2VtLmNvbnRleHRzLm11dGV4KTsKIAlpZiAocmV0KQog
CQlyZXR1cm4gcmV0OwogCi0JcmVtYXBfaW5mbyA9ICZkZXZfcHJpdi0+bDNfcGFyaXR5LnJlbWFw
X2luZm9bc2xpY2VdOworCXJlbWFwX2luZm8gPSAmaTkxNS0+bDNfcGFyaXR5LnJlbWFwX2luZm9b
c2xpY2VdOwogCWlmICghKnJlbWFwX2luZm8pIHsKIAkJKnJlbWFwX2luZm8gPSBremFsbG9jKEdF
TjdfTDNMT0dfU0laRSwgR0ZQX0tFUk5FTCk7CiAJCWlmICghKnJlbWFwX2luZm8pIHsKQEAgLTIy
MSwyMCArMjIxLDIwIEBAIGk5MTVfbDNfd3JpdGUoc3RydWN0IGZpbGUgKmZpbHAsIHN0cnVjdCBr
b2JqZWN0ICprb2JqLAogCQl9CiAJfQogCi0JLyogVE9ETzogSWRlYWxseSB3ZSByZWFsbHkgd2Fu
dCBhIEdQVSByZXNldCBoZXJlIHRvIG1ha2Ugc3VyZSBlcnJvcnMKKwkvKgorCSAqIFRPRE86IElk
ZWFsbHkgd2UgcmVhbGx5IHdhbnQgYSBHUFUgcmVzZXQgaGVyZSB0byBtYWtlIHN1cmUgZXJyb3Jz
CiAJICogYXJlbid0IHByb3BhZ2F0ZWQuIFNpbmNlIEkgY2Fubm90IGZpbmQgYSBzdGFibGUgd2F5
IHRvIHJlc2V0IHRoZSBHUFUKIAkgKiBhdCB0aGlzIHBvaW50IGl0IGlzIGxlZnQgYXMgYSBUT0RP
LgogCSovCiAJbWVtY3B5KCpyZW1hcF9pbmZvICsgKG9mZnNldC80KSwgYnVmLCBjb3VudCk7CiAK
IAkvKiBOQjogV2UgZGVmZXIgdGhlIHJlbWFwcGluZyB1bnRpbCB3ZSBzd2l0Y2ggdG8gdGhlIGNv
bnRleHQgKi8KLQlsaXN0X2Zvcl9lYWNoX2VudHJ5KGN0eCwgJmRldl9wcml2LT5jb250ZXh0cy5s
aXN0LCBsaW5rKQotCQljdHgtPnJlbWFwX3NsaWNlIHw9ICgxPDxzbGljZSk7CisJbGlzdF9mb3Jf
ZWFjaF9lbnRyeShjdHgsICZpOTE1LT5nZW0uY29udGV4dHMubGlzdCwgbGluaykKKwkJY3R4LT5y
ZW1hcF9zbGljZSB8PSBCSVQoc2xpY2UpOwogCiAJcmV0ID0gY291bnQ7Ci0KIG91dDoKLQltdXRl
eF91bmxvY2soJmRldi0+c3RydWN0X211dGV4KTsKKwltdXRleF91bmxvY2soJmk5MTUtPmdlbS5j
b250ZXh0cy5tdXRleCk7CiAKIAlyZXR1cm4gcmV0OwogfQpkaWZmIC0tZ2l0IGEvZHJpdmVycy9n
cHUvZHJtL2k5MTUvc2VsZnRlc3RzL21vY2tfZ2VtX2RldmljZS5jIGIvZHJpdmVycy9ncHUvZHJt
L2k5MTUvc2VsZnRlc3RzL21vY2tfZ2VtX2RldmljZS5jCmluZGV4IDAxYTg5YzA3MWJmNS4uMWZm
YWQ4YzRiMTVkIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9zZWxmdGVzdHMvbW9j
a19nZW1fZGV2aWNlLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvc2VsZnRlc3RzL21vY2tf
Z2VtX2RldmljZS5jCkBAIC02NSw3ICs2NSw3IEBAIHN0YXRpYyB2b2lkIG1vY2tfZGV2aWNlX3Jl
bGVhc2Uoc3RydWN0IGRybV9kZXZpY2UgKmRldikKIAltdXRleF9sb2NrKCZpOTE1LT5kcm0uc3Ry
dWN0X211dGV4KTsKIAlmb3JfZWFjaF9lbmdpbmUoZW5naW5lLCBpOTE1LCBpZCkKIAkJbW9ja19l
bmdpbmVfZnJlZShlbmdpbmUpOwotCWk5MTVfZ2VtX2NvbnRleHRzX2ZpbmkoaTkxNSk7CisJaTkx
NV9nZW1fZHJpdmVyX3JlbGVhc2VfX2NvbnRleHRzKGk5MTUpOwogCW11dGV4X3VubG9jaygmaTkx
NS0+ZHJtLnN0cnVjdF9tdXRleCk7CiAKIAlpbnRlbF90aW1lbGluZXNfZmluaShpOTE1KTsKQEAg
LTIyMSw3ICsyMjEsNyBAQCBzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqbW9ja19nZW1fZGV2aWNl
KHZvaWQpCiAJcmV0dXJuIGk5MTU7CiAKIGVycl9jb250ZXh0OgotCWk5MTVfZ2VtX2NvbnRleHRz
X2ZpbmkoaTkxNSk7CisJaTkxNV9nZW1fZHJpdmVyX3JlbGVhc2VfX2NvbnRleHRzKGk5MTUpOwog
ZXJyX2VuZ2luZToKIAltb2NrX2VuZ2luZV9mcmVlKGk5MTUtPmVuZ2luZVtSQ1MwXSk7CiBlcnJf
dW5sb2NrOgotLSAKMi4yMy4wLnJjMQoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJl
ZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGlu
Zm8vaW50ZWwtZ2Z4

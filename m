Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id BE3CBBA248
	for <lists+intel-gfx@lfdr.de>; Sun, 22 Sep 2019 14:06:12 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id E4BBC6E220;
	Sun, 22 Sep 2019 12:04:23 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id A92D46E06E
 for <intel-gfx@lists.freedesktop.org>; Sat, 21 Sep 2019 09:55:55 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18568189-1500050 
 for multiple; Sat, 21 Sep 2019 10:55:47 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Sat, 21 Sep 2019 10:55:39 +0100
Message-Id: <20190921095542.23205-2-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20190921095542.23205-1-chris@chris-wilson.co.uk>
References: <20190921095542.23205-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 2/5] drm/i915: Only enqueue already completed
 requests
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SWYgd2UgYXJlIGFza2VkIHRvIHN1Ym1pdCBhIGNvbXBsZXRlZCByZXF1ZXN0LCBqdXN0IG1vdmUg
aXQgb250byB0aGUKYWN0aXZlLWxpc3Qgd2l0aG91dCBtb2RpZnlpbmcgaXQncyBwYXlsb2FkLiBJ
ZiB3ZSB0cnkgdG8gZW1pdCB0aGUKbW9kaWZpZWQgcGF5bG9hZCBvZiBhIGNvbXBsZXRlZCByZXF1
ZXN0LCB3ZSByaXNrIHJhY2luZyB3aXRoIHRoZQpyaW5nLT5oZWFkIHVwZGF0ZSBkdXJpbmcgcmV0
aXJlbWVudCB3aGljaCBtYXkgYWR2YW5jZSB0aGUgaGVhZCBwYXN0IG91cgpicmVhZGNydW1iIGFu
ZCBzbyB3ZSBnZW5lcmF0ZSBhIHdhcm5pbmcgZm9yIHRoZSBlbWlzc2lvbiBiZWluZyBiZWhpbmQK
dGhlIFJJTkdfSEVBRC4KClNpZ25lZC1vZmYtYnk6IENocmlzIFdpbHNvbiA8Y2hyaXNAY2hyaXMt
d2lsc29uLmNvLnVrPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2xyYy5jIHwg
NDUgKysrKysrKysrKysrKy0tLS0tLS0tLS0tLS0tLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5
MTVfcmVxdWVzdC5jIHwgMjggKysrKysrKysrKy0tLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkx
NS9pOTE1X3JlcXVlc3QuaCB8ICAyICstCiAzIGZpbGVzIGNoYW5nZWQsIDM3IGluc2VydGlvbnMo
KyksIDM4IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0
L2ludGVsX2xyYy5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjLmMKaW5kZXgg
NTNlODIzZDM2YjI4Li41M2JjNDMwODc5M2MgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2d0L2ludGVsX2xyYy5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2xy
Yy5jCkBAIC04MDYsNiArODA2LDkgQEAgc3RhdGljIGJvb2wgY2FuX21lcmdlX3JxKGNvbnN0IHN0
cnVjdCBpOTE1X3JlcXVlc3QgKnByZXYsCiAJR0VNX0JVR19PTihwcmV2ID09IG5leHQpOwogCUdF
TV9CVUdfT04oIWFzc2VydF9wcmlvcml0eV9xdWV1ZShwcmV2LCBuZXh0KSk7CiAKKwlpZiAoaTkx
NV9yZXF1ZXN0X2NvbXBsZXRlZChuZXh0KSkKKwkJcmV0dXJuIHRydWU7CisKIAlpZiAoIWNhbl9t
ZXJnZV9jdHgocHJldi0+aHdfY29udGV4dCwgbmV4dC0+aHdfY29udGV4dCkpCiAJCXJldHVybiBm
YWxzZTsKIApAQCAtMTE4OCwyMSArMTE5MSw2IEBAIHN0YXRpYyB2b2lkIGV4ZWNsaXN0c19kZXF1
ZXVlKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKIAkJCQljb250aW51ZTsKIAkJCX0K
IAotCQkJaWYgKGk5MTVfcmVxdWVzdF9jb21wbGV0ZWQocnEpKSB7Ci0JCQkJdmUtPnJlcXVlc3Qg
PSBOVUxMOwotCQkJCXZlLT5iYXNlLmV4ZWNsaXN0cy5xdWV1ZV9wcmlvcml0eV9oaW50ID0gSU5U
X01JTjsKLQkJCQlyYl9lcmFzZV9jYWNoZWQocmIsICZleGVjbGlzdHMtPnZpcnR1YWwpOwotCQkJ
CVJCX0NMRUFSX05PREUocmIpOwotCi0JCQkJcnEtPmVuZ2luZSA9IGVuZ2luZTsKLQkJCQlfX2k5
MTVfcmVxdWVzdF9zdWJtaXQocnEpOwotCi0JCQkJc3Bpbl91bmxvY2soJnZlLT5iYXNlLmFjdGl2
ZS5sb2NrKTsKLQotCQkJCXJiID0gcmJfZmlyc3RfY2FjaGVkKCZleGVjbGlzdHMtPnZpcnR1YWwp
OwotCQkJCWNvbnRpbnVlOwotCQkJfQotCiAJCQlpZiAobGFzdCAmJiAhY2FuX21lcmdlX3JxKGxh
c3QsIHJxKSkgewogCQkJCXNwaW5fdW5sb2NrKCZ2ZS0+YmFzZS5hY3RpdmUubG9jayk7CiAJCQkJ
cmV0dXJuOyAvKiBsZWF2ZSB0aGlzIGZvciBhbm90aGVyICovCkBAIC0xMjU2LDExICsxMjQ0LDE2
IEBAIHN0YXRpYyB2b2lkIGV4ZWNsaXN0c19kZXF1ZXVlKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3Mg
KmVuZ2luZSkKIAkJCQlHRU1fQlVHX09OKHZlLT5zaWJsaW5nc1swXSAhPSBlbmdpbmUpOwogCQkJ
fQogCi0JCQlfX2k5MTVfcmVxdWVzdF9zdWJtaXQocnEpOwotCQkJaWYgKCFpOTE1X3JlcXVlc3Rf
Y29tcGxldGVkKHJxKSkgeworCQkJaWYgKF9faTkxNV9yZXF1ZXN0X3N1Ym1pdChycSkpIHsKIAkJ
CQlzdWJtaXQgPSB0cnVlOwogCQkJCWxhc3QgPSBycTsKIAkJCX0KKworCQkJaWYgKCFzdWJtaXQp
IHsKKwkJCQlzcGluX3VubG9jaygmdmUtPmJhc2UuYWN0aXZlLmxvY2spOworCQkJCXJiID0gcmJf
Zmlyc3RfY2FjaGVkKCZleGVjbGlzdHMtPnZpcnR1YWwpOworCQkJCWNvbnRpbnVlOworCQkJfQog
CQl9CiAKIAkJc3Bpbl91bmxvY2soJnZlLT5iYXNlLmFjdGl2ZS5sb2NrKTsKQEAgLTEyNzMsOCAr
MTI2Niw3IEBAIHN0YXRpYyB2b2lkIGV4ZWNsaXN0c19kZXF1ZXVlKHN0cnVjdCBpbnRlbF9lbmdp
bmVfY3MgKmVuZ2luZSkKIAkJaW50IGk7CiAKIAkJcHJpb2xpc3RfZm9yX2VhY2hfcmVxdWVzdF9j
b25zdW1lKHJxLCBybiwgcCwgaSkgewotCQkJaWYgKGk5MTVfcmVxdWVzdF9jb21wbGV0ZWQocnEp
KQotCQkJCWdvdG8gc2tpcDsKKwkJCWJvb2wgbWVyZ2UgPSB0cnVlOwogCiAJCQkvKgogCQkJICog
Q2FuIHdlIGNvbWJpbmUgdGhpcyByZXF1ZXN0IHdpdGggdGhlIGN1cnJlbnQgcG9ydD8KQEAgLTEz
MTUsMTQgKzEzMDcsMTcgQEAgc3RhdGljIHZvaWQgZXhlY2xpc3RzX2RlcXVldWUoc3RydWN0IGlu
dGVsX2VuZ2luZV9jcyAqZW5naW5lKQogCQkJCSAgICBjdHhfc2luZ2xlX3BvcnRfc3VibWlzc2lv
bihycS0+aHdfY29udGV4dCkpCiAJCQkJCWdvdG8gZG9uZTsKIAotCQkJCSpwb3J0ID0gZXhlY2xp
c3RzX3NjaGVkdWxlX2luKGxhc3QsIHBvcnQgLSBleGVjbGlzdHMtPnBlbmRpbmcpOwotCQkJCXBv
cnQrKzsKKwkJCQltZXJnZSA9IGZhbHNlOwogCQkJfQogCi0JCQlsYXN0ID0gcnE7Ci0JCQlzdWJt
aXQgPSB0cnVlOwotc2tpcDoKLQkJCV9faTkxNV9yZXF1ZXN0X3N1Ym1pdChycSk7CisJCQlpZiAo
X19pOTE1X3JlcXVlc3Rfc3VibWl0KHJxKSkgeworCQkJCWlmICghbWVyZ2UpIHsKKwkJCQkJKnBv
cnQgPSBleGVjbGlzdHNfc2NoZWR1bGVfaW4obGFzdCwgcG9ydCAtIGV4ZWNsaXN0cy0+cGVuZGlu
Zyk7CisJCQkJCXBvcnQrKzsKKwkJCQl9CisJCQkJc3VibWl0ID0gdHJ1ZTsKKwkJCQlsYXN0ID0g
cnE7CisJCQl9CiAJCX0KIAogCQlyYl9lcmFzZV9jYWNoZWQoJnAtPm5vZGUsICZleGVjbGlzdHMt
PnF1ZXVlKTsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcmVxdWVzdC5j
IGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9yZXF1ZXN0LmMKaW5kZXggOWJkODUzOGIxOTA3
Li5kYjFhMDA0OGE3NTMgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcmVx
dWVzdC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcmVxdWVzdC5jCkBAIC0zNzcs
OSArMzc3LDEwIEBAIF9faTkxNV9yZXF1ZXN0X2F3YWl0X2V4ZWN1dGlvbihzdHJ1Y3QgaTkxNV9y
ZXF1ZXN0ICpycSwKIAlyZXR1cm4gMDsKIH0KIAotdm9pZCBfX2k5MTVfcmVxdWVzdF9zdWJtaXQo
c3RydWN0IGk5MTVfcmVxdWVzdCAqcmVxdWVzdCkKK2Jvb2wgX19pOTE1X3JlcXVlc3Rfc3VibWl0
KHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJlcXVlc3QpCiB7CiAJc3RydWN0IGludGVsX2VuZ2luZV9j
cyAqZW5naW5lID0gcmVxdWVzdC0+ZW5naW5lOworCWJvb2wgcmVzdWx0ID0gZmFsc2U7CiAKIAlH
RU1fVFJBQ0UoIiVzIGZlbmNlICVsbHg6JWxsZCwgY3VycmVudCAlZFxuIiwKIAkJICBlbmdpbmUt
Pm5hbWUsCkBAIC0zODksNiArMzkwLDkgQEAgdm9pZCBfX2k5MTVfcmVxdWVzdF9zdWJtaXQoc3Ry
dWN0IGk5MTVfcmVxdWVzdCAqcmVxdWVzdCkKIAlHRU1fQlVHX09OKCFpcnFzX2Rpc2FibGVkKCkp
OwogCWxvY2tkZXBfYXNzZXJ0X2hlbGQoJmVuZ2luZS0+YWN0aXZlLmxvY2spOwogCisJaWYgKGk5
MTVfcmVxdWVzdF9jb21wbGV0ZWQocmVxdWVzdCkpCisJCWdvdG8geGZlcjsKKwogCWlmIChpOTE1
X2dlbV9jb250ZXh0X2lzX2Jhbm5lZChyZXF1ZXN0LT5nZW1fY29udGV4dCkpCiAJCWk5MTVfcmVx
dWVzdF9za2lwKHJlcXVlc3QsIC1FSU8pOwogCkBAIC00MTIsMTMgKzQxNiwxOCBAQCB2b2lkIF9f
aTkxNV9yZXF1ZXN0X3N1Ym1pdChzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpyZXF1ZXN0KQogCSAgICBp
OTE1X3N3X2ZlbmNlX3NpZ25hbGVkKCZyZXF1ZXN0LT5zZW1hcGhvcmUpKQogCQllbmdpbmUtPnNh
dHVyYXRlZCB8PSByZXF1ZXN0LT5zY2hlZC5zZW1hcGhvcmVzOwogCi0JLyogV2UgbWF5IGJlIHJl
Y3Vyc2luZyBmcm9tIHRoZSBzaWduYWwgY2FsbGJhY2sgb2YgYW5vdGhlciBpOTE1IGZlbmNlICov
Ci0Jc3Bpbl9sb2NrX25lc3RlZCgmcmVxdWVzdC0+bG9jaywgU0lOR0xFX0RFUFRIX05FU1RJTkcp
OworCWVuZ2luZS0+ZW1pdF9maW5pX2JyZWFkY3J1bWIocmVxdWVzdCwKKwkJCQkgICAgIHJlcXVl
c3QtPnJpbmctPnZhZGRyICsgcmVxdWVzdC0+cG9zdGZpeCk7CiAKLQlsaXN0X21vdmVfdGFpbCgm
cmVxdWVzdC0+c2NoZWQubGluaywgJmVuZ2luZS0+YWN0aXZlLnJlcXVlc3RzKTsKKwl0cmFjZV9p
OTE1X3JlcXVlc3RfZXhlY3V0ZShyZXF1ZXN0KTsKKwllbmdpbmUtPnNlcmlhbCsrOworCXJlc3Vs
dCA9IHRydWU7CiAKLQlHRU1fQlVHX09OKHRlc3RfYml0KEk5MTVfRkVOQ0VfRkxBR19BQ1RJVkUs
ICZyZXF1ZXN0LT5mZW5jZS5mbGFncykpOwotCXNldF9iaXQoSTkxNV9GRU5DRV9GTEFHX0FDVElW
RSwgJnJlcXVlc3QtPmZlbmNlLmZsYWdzKTsKK3hmZXI6CS8qIFdlIG1heSBiZSByZWN1cnNpbmcg
ZnJvbSB0aGUgc2lnbmFsIGNhbGxiYWNrIG9mIGFub3RoZXIgaTkxNSBmZW5jZSAqLworCXNwaW5f
bG9ja19uZXN0ZWQoJnJlcXVlc3QtPmxvY2ssIFNJTkdMRV9ERVBUSF9ORVNUSU5HKTsKKworCWlm
ICghdGVzdF9hbmRfc2V0X2JpdChJOTE1X0ZFTkNFX0ZMQUdfQUNUSVZFLCAmcmVxdWVzdC0+ZmVu
Y2UuZmxhZ3MpKQorCQlsaXN0X21vdmVfdGFpbCgmcmVxdWVzdC0+c2NoZWQubGluaywgJmVuZ2lu
ZS0+YWN0aXZlLnJlcXVlc3RzKTsKIAogCWlmICh0ZXN0X2JpdChETUFfRkVOQ0VfRkxBR19FTkFC
TEVfU0lHTkFMX0JJVCwgJnJlcXVlc3QtPmZlbmNlLmZsYWdzKSAmJgogCSAgICAhdGVzdF9iaXQo
RE1BX0ZFTkNFX0ZMQUdfU0lHTkFMRURfQklULCAmcmVxdWVzdC0+ZmVuY2UuZmxhZ3MpICYmCkBA
IC00MjksMTIgKzQzOCw3IEBAIHZvaWQgX19pOTE1X3JlcXVlc3Rfc3VibWl0KHN0cnVjdCBpOTE1
X3JlcXVlc3QgKnJlcXVlc3QpCiAKIAlzcGluX3VubG9jaygmcmVxdWVzdC0+bG9jayk7CiAKLQll
bmdpbmUtPmVtaXRfZmluaV9icmVhZGNydW1iKHJlcXVlc3QsCi0JCQkJICAgICByZXF1ZXN0LT5y
aW5nLT52YWRkciArIHJlcXVlc3QtPnBvc3RmaXgpOwotCi0JZW5naW5lLT5zZXJpYWwrKzsKLQot
CXRyYWNlX2k5MTVfcmVxdWVzdF9leGVjdXRlKHJlcXVlc3QpOworCXJldHVybiByZXN1bHQ7CiB9
CiAKIHZvaWQgaTkxNV9yZXF1ZXN0X3N1Ym1pdChzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpyZXF1ZXN0
KQpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9yZXF1ZXN0LmggYi9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3JlcXVlc3QuaAppbmRleCBiMThmNDk1MjhkZWQuLmVjNWJi
NGMyZTVhZSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9yZXF1ZXN0LmgK
KysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9yZXF1ZXN0LmgKQEAgLTI5Miw3ICsyOTIs
NyBAQCBpbnQgaTkxNV9yZXF1ZXN0X2F3YWl0X2V4ZWN1dGlvbihzdHJ1Y3QgaTkxNV9yZXF1ZXN0
ICpycSwKIAogdm9pZCBpOTE1X3JlcXVlc3RfYWRkKHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxKTsK
IAotdm9pZCBfX2k5MTVfcmVxdWVzdF9zdWJtaXQoc3RydWN0IGk5MTVfcmVxdWVzdCAqcmVxdWVz
dCk7Citib29sIF9faTkxNV9yZXF1ZXN0X3N1Ym1pdChzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpyZXF1
ZXN0KTsKIHZvaWQgaTkxNV9yZXF1ZXN0X3N1Ym1pdChzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpyZXF1
ZXN0KTsKIAogdm9pZCBpOTE1X3JlcXVlc3Rfc2tpcChzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpyZXF1
ZXN0LCBpbnQgZXJyb3IpOwotLSAKMi4yMy4wCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fXwpJbnRlbC1nZnggbWFpbGluZyBsaXN0CkludGVsLWdmeEBsaXN0
cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9s
aXN0aW5mby9pbnRlbC1nZng=

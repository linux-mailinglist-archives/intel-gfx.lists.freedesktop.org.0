Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 7C98CD8C25
	for <lists+intel-gfx@lfdr.de>; Wed, 16 Oct 2019 11:08:06 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id AF8196E908;
	Wed, 16 Oct 2019 09:08:04 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id CD12F6E908
 for <intel-gfx@lists.freedesktop.org>; Wed, 16 Oct 2019 09:08:02 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18853543-1500050 
 for multiple; Wed, 16 Oct 2019 10:07:50 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Wed, 16 Oct 2019 10:07:49 +0100
Message-Id: <20191016090749.7092-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH] drm/i915: Do initial mocs configuration directly
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

Tm93IHRoYXQgd2UgcmVjb3JkIHRoZSBkZWZhdWx0ICJnb2xkZW5zdGF0ZSIgY29udGV4dCwgd2Ug
ZG8gbm90IG5lZWQgdG8KZW1pdCB0aGUgbW9jcyByZWdpc3RlcnMgYXQgdGhlIHN0YXJ0IG9mIGVh
Y2ggY29udGV4dCBhbmQgY2FuIHNpbXBseSBkbwptbWlvIGJlZm9yZSB0aGUgZmlyc3QgY29udGV4
dCBhbmQgY2FwdHVyZSB0aGUgcmVnaXN0ZXJzIGFzIHBhcnQgb2YgaXRzCmRlZmF1bHQgaW1hZ2Uu
IEFzIGEgY29uc2VxdWVuY2UsIHRoaXMgbWVhbnMgdGhhdCB3ZSByZXBlYXQgdGhlIG1taW8KYWZ0
ZXIgZWFjaCBlbmdpbmUgcmVzZXQsIGZpeGluZyB1cCBhbnkgcGxhdGZvcm0gYW5kIHJlZ2lzdGVy
cyB0aGF0IHdlcmUKemFwcGVkIGJ5IHRoZSByZXNldCAoZm9yIHRob3NlIHBsYXRmb3JtcyB3aXRo
IGdsb2JhbCBub3QgY29udGV4dC1zYXZlZApzZXR0aW5ncykuCgpSZWZlcmVuY2VzOiBodHRwczov
L2J1Z3MuZnJlZWRlc2t0b3Aub3JnL3Nob3dfYnVnLmNnaT9pZD0xMTE3MjMKUmVmZXJlbmNlczog
aHR0cHM6Ly9idWdzLmZyZWVkZXNrdG9wLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9MTExNjQ1ClNpZ25l
ZC1vZmYtYnk6IENocmlzIFdpbHNvbiA8Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPgpDYzogUHJh
dGhhcCBLdW1hciBWYWxzYW4gPHByYXRoYXAua3VtYXIudmFsc2FuQGludGVsLmNvbT4KLS0tCiBk
cml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9tb2NzLmMgfCAyODEgKysrKysrKy0tLS0tLS0t
LS0tLS0tLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9tb2NzLmggfCAgIDMg
LQogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW0uYyAgICAgIHwgICA5IC0KIDMgZmlsZXMg
Y2hhbmdlZCwgNzMgaW5zZXJ0aW9ucygrKSwgMjIwIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBh
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX21vY3MuYyBiL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2d0L2ludGVsX21vY3MuYwppbmRleCA3Mjg3MDRiYmJlMTguLmVlMTUwYjAzNDg1NSAxMDA2
NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbW9jcy5jCisrKyBiL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX21vY3MuYwpAQCAtMjg3LDEwICsyODcsOSBAQCBzdGF0
aWMgY29uc3Qgc3RydWN0IGRybV9pOTE1X21vY3NfZW50cnkgaWNlbGFrZV9tb2NzX3RhYmxlW10g
PSB7CiAJR0VOMTFfTU9DU19FTlRSSUVTCiB9OwogCi1zdGF0aWMgYm9vbCBnZXRfbW9jc19zZXR0
aW5ncyhzdHJ1Y3QgaW50ZWxfZ3QgKmd0LAorc3RhdGljIGJvb2wgZ2V0X21vY3Nfc2V0dGluZ3Mo
Y29uc3Qgc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUsCiAJCQkgICAgICBzdHJ1Y3QgZHJt
X2k5MTVfbW9jc190YWJsZSAqdGFibGUpCiB7Ci0Jc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5
MTUgPSBndC0+aTkxNTsKIAlib29sIHJlc3VsdCA9IGZhbHNlOwogCiAJaWYgKElOVEVMX0dFTihp
OTE1KSA+PSAxMikgewpAQCAtMzMxLDkgKzMzMCw5IEBAIHN0YXRpYyBib29sIGdldF9tb2NzX3Nl
dHRpbmdzKHN0cnVjdCBpbnRlbF9ndCAqZ3QsCiAJcmV0dXJuIHJlc3VsdDsKIH0KIAotc3RhdGlj
IGk5MTVfcmVnX3QgbW9jc19yZWdpc3RlcihlbnVtIGludGVsX2VuZ2luZV9pZCBlbmdpbmVfaWQs
IGludCBpbmRleCkKK3N0YXRpYyBpOTE1X3JlZ190IG1vY3NfcmVnaXN0ZXIoY29uc3Qgc3RydWN0
IGludGVsX2VuZ2luZV9jcyAqZW5naW5lLCBpbnQgaW5kZXgpCiB7Ci0Jc3dpdGNoIChlbmdpbmVf
aWQpIHsKKwlzd2l0Y2ggKGVuZ2luZS0+aWQpIHsKIAljYXNlIFJDUzA6CiAJCXJldHVybiBHRU45
X0dGWF9NT0NTKGluZGV4KTsKIAljYXNlIFZDUzA6CkBAIC0zNDcsNyArMzQ2LDcgQEAgc3RhdGlj
IGk5MTVfcmVnX3QgbW9jc19yZWdpc3RlcihlbnVtIGludGVsX2VuZ2luZV9pZCBlbmdpbmVfaWQs
IGludCBpbmRleCkKIAljYXNlIFZDUzI6CiAJCXJldHVybiBHRU4xMV9NRlgyX01PQ1MoaW5kZXgp
OwogCWRlZmF1bHQ6Ci0JCU1JU1NJTkdfQ0FTRShlbmdpbmVfaWQpOworCQlNSVNTSU5HX0NBU0Uo
ZW5naW5lLT5pZCk7CiAJCXJldHVybiBJTlZBTElEX01NSU9fUkVHOwogCX0KIH0KQEAgLTM2NSwx
MTggKzM2NCwyNSBAQCBzdGF0aWMgdTMyIGdldF9lbnRyeV9jb250cm9sKGNvbnN0IHN0cnVjdCBk
cm1faTkxNV9tb2NzX3RhYmxlICp0YWJsZSwKIAlyZXR1cm4gdGFibGUtPnRhYmxlW0k5MTVfTU9D
U19QVEVdLmNvbnRyb2xfdmFsdWU7CiB9CiAKLS8qKgotICogaW50ZWxfbW9jc19pbml0X2VuZ2lu
ZSgpIC0gZW1pdCB0aGUgbW9jcyBjb250cm9sIHRhYmxlCi0gKiBAZW5naW5lOglUaGUgZW5naW5l
IGZvciB3aG9tIHRvIGVtaXQgdGhlIHJlZ2lzdGVycy4KLSAqCi0gKiBUaGlzIGZ1bmN0aW9uIHNp
bXBseSBlbWl0cyBhIE1JX0xPQURfUkVHSVNURVJfSU1NIGNvbW1hbmQgZm9yIHRoZQotICogZ2l2
ZW4gdGFibGUgc3RhcnRpbmcgYXQgdGhlIGdpdmVuIGFkZHJlc3MuCi0gKi8KLXZvaWQgaW50ZWxf
bW9jc19pbml0X2VuZ2luZShzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUpCitzdGF0aWMg
dm9pZCBpbml0X21vY3NfdGFibGUoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lLAorCQkJ
ICAgIGNvbnN0IHN0cnVjdCBkcm1faTkxNV9tb2NzX3RhYmxlICp0YWJsZSkKIHsKLQlzdHJ1Y3Qg
aW50ZWxfZ3QgKmd0ID0gZW5naW5lLT5ndDsKLQlzdHJ1Y3QgaW50ZWxfdW5jb3JlICp1bmNvcmUg
PSBndC0+dW5jb3JlOwotCXN0cnVjdCBkcm1faTkxNV9tb2NzX3RhYmxlIHRhYmxlOwotCXVuc2ln
bmVkIGludCBpbmRleDsKLQl1MzIgdW51c2VkX3ZhbHVlOwotCi0JLyogUGxhdGZvcm1zIHdpdGgg
Z2xvYmFsIE1PQ1MgZG8gbm90IG5lZWQgcGVyLWVuZ2luZSBpbml0aWFsaXphdGlvbi4gKi8KLQlp
ZiAoSEFTX0dMT0JBTF9NT0NTX1JFR0lTVEVSUyhndC0+aTkxNSkpCi0JCXJldHVybjsKLQotCS8q
IENhbGxlZCB1bmRlciBhIGJsYW5rZXQgZm9yY2V3YWtlICovCi0JYXNzZXJ0X2ZvcmNld2FrZXNf
YWN0aXZlKHVuY29yZSwgRk9SQ0VXQUtFX0FMTCk7Ci0KLQlpZiAoIWdldF9tb2NzX3NldHRpbmdz
KGd0LCAmdGFibGUpKQotCQlyZXR1cm47Ci0KLQkvKiBTZXQgdW51c2VkIHZhbHVlcyB0byBQVEUg
Ki8KLQl1bnVzZWRfdmFsdWUgPSB0YWJsZS50YWJsZVtJOTE1X01PQ1NfUFRFXS5jb250cm9sX3Zh
bHVlOwotCi0JZm9yIChpbmRleCA9IDA7IGluZGV4IDwgdGFibGUuc2l6ZTsgaW5kZXgrKykgewot
CQl1MzIgdmFsdWUgPSBnZXRfZW50cnlfY29udHJvbCgmdGFibGUsIGluZGV4KTsKKwlzdHJ1Y3Qg
aW50ZWxfdW5jb3JlICp1bmNvcmUgPSBlbmdpbmUtPnVuY29yZTsKKwl1MzIgdW51c2VkX3ZhbHVl
ID0gdGFibGUtPnRhYmxlW0k5MTVfTU9DU19QVEVdLmNvbnRyb2xfdmFsdWU7CisJdW5zaWduZWQg
aW50IGk7CiAKKwlmb3IgKGkgPSAwOyBpIDwgdGFibGUtPnNpemU7IGkrKykKIAkJaW50ZWxfdW5j
b3JlX3dyaXRlX2Z3KHVuY29yZSwKLQkJCQkgICAgICBtb2NzX3JlZ2lzdGVyKGVuZ2luZS0+aWQs
IGluZGV4KSwKLQkJCQkgICAgICB2YWx1ZSk7Ci0JfQorCQkJCSAgICAgIG1vY3NfcmVnaXN0ZXIo
ZW5naW5lLCBpKSwKKwkJCQkgICAgICBnZXRfZW50cnlfY29udHJvbCh0YWJsZSwgaSkpOwogCi0J
LyogQWxsIHJlbWFpbmluZyBlbnRyaWVzIGFyZSBhbHNvIHVudXNlZCAqLwotCWZvciAoOyBpbmRl
eCA8IHRhYmxlLm5fZW50cmllczsgaW5kZXgrKykKKwkvKiBBbGwgcmVtYWluaW5nIGVudHJpZXMg
YXJlIHVudXNlZCAqLworCWZvciAoOyBpIDwgdGFibGUtPm5fZW50cmllczsgaSsrKQogCQlpbnRl
bF91bmNvcmVfd3JpdGVfZncodW5jb3JlLAotCQkJCSAgICAgIG1vY3NfcmVnaXN0ZXIoZW5naW5l
LT5pZCwgaW5kZXgpLAorCQkJCSAgICAgIG1vY3NfcmVnaXN0ZXIoZW5naW5lLCBpKSwKIAkJCQkg
ICAgICB1bnVzZWRfdmFsdWUpOwogfQogCi1zdGF0aWMgdm9pZCBpbnRlbF9tb2NzX2luaXRfZ2xv
YmFsKHN0cnVjdCBpbnRlbF9ndCAqZ3QpCi17Ci0Jc3RydWN0IGludGVsX3VuY29yZSAqdW5jb3Jl
ID0gZ3QtPnVuY29yZTsKLQlzdHJ1Y3QgZHJtX2k5MTVfbW9jc190YWJsZSB0YWJsZTsKLQl1bnNp
Z25lZCBpbnQgaW5kZXg7Ci0KLQlHRU1fQlVHX09OKCFIQVNfR0xPQkFMX01PQ1NfUkVHSVNURVJT
KGd0LT5pOTE1KSk7Ci0KLQlpZiAoIWdldF9tb2NzX3NldHRpbmdzKGd0LCAmdGFibGUpKQotCQly
ZXR1cm47Ci0KLQlpZiAoR0VNX0RFQlVHX1dBUk5fT04odGFibGUuc2l6ZSA+IHRhYmxlLm5fZW50
cmllcykpCi0JCXJldHVybjsKLQotCWZvciAoaW5kZXggPSAwOyBpbmRleCA8IHRhYmxlLnNpemU7
IGluZGV4KyspCi0JCWludGVsX3VuY29yZV93cml0ZSh1bmNvcmUsCi0JCQkJICAgR0VOMTJfR0xP
QkFMX01PQ1MoaW5kZXgpLAotCQkJCSAgIHRhYmxlLnRhYmxlW2luZGV4XS5jb250cm9sX3ZhbHVl
KTsKLQotCS8qCi0JICogT2ssIG5vdyBzZXQgdGhlIHVudXNlZCBlbnRyaWVzIHRvIHRoZSBpbnZh
bGlkIGVudHJ5IChpbmRleCAwKS4gVGhlc2UKLQkgKiBlbnRyaWVzIGFyZSBvZmZpY2lhbGx5IHVu
ZGVmaW5lZCBhbmQgbm8gY29udHJhY3QgZm9yIHRoZSBjb250ZW50cyBhbmQKLQkgKiBzZXR0aW5n
cyBpcyBnaXZlbiBmb3IgdGhlc2UgZW50cmllcy4KLQkgKi8KLQlmb3IgKDsgaW5kZXggPCB0YWJs
ZS5uX2VudHJpZXM7IGluZGV4KyspCi0JCWludGVsX3VuY29yZV93cml0ZSh1bmNvcmUsCi0JCQkJ
ICAgR0VOMTJfR0xPQkFMX01PQ1MoaW5kZXgpLAotCQkJCSAgIHRhYmxlLnRhYmxlWzBdLmNvbnRy
b2xfdmFsdWUpOwotfQotCi1zdGF0aWMgaW50IGVtaXRfbW9jc19jb250cm9sX3RhYmxlKHN0cnVj
dCBpOTE1X3JlcXVlc3QgKnJxLAotCQkJCSAgIGNvbnN0IHN0cnVjdCBkcm1faTkxNV9tb2NzX3Rh
YmxlICp0YWJsZSkKLXsKLQllbnVtIGludGVsX2VuZ2luZV9pZCBlbmdpbmUgPSBycS0+ZW5naW5l
LT5pZDsKLQl1bnNpZ25lZCBpbnQgaW5kZXg7Ci0JdTMyIHVudXNlZF92YWx1ZTsKLQl1MzIgKmNz
OwotCi0JaWYgKEdFTV9XQVJOX09OKHRhYmxlLT5zaXplID4gdGFibGUtPm5fZW50cmllcykpCi0J
CXJldHVybiAtRU5PREVWOwotCi0JLyogU2V0IHVudXNlZCB2YWx1ZXMgdG8gUFRFICovCi0JdW51
c2VkX3ZhbHVlID0gdGFibGUtPnRhYmxlW0k5MTVfTU9DU19QVEVdLmNvbnRyb2xfdmFsdWU7Ci0K
LQljcyA9IGludGVsX3JpbmdfYmVnaW4ocnEsIDIgKyAyICogdGFibGUtPm5fZW50cmllcyk7Ci0J
aWYgKElTX0VSUihjcykpCi0JCXJldHVybiBQVFJfRVJSKGNzKTsKLQotCSpjcysrID0gTUlfTE9B
RF9SRUdJU1RFUl9JTU0odGFibGUtPm5fZW50cmllcyk7Ci0KLQlmb3IgKGluZGV4ID0gMDsgaW5k
ZXggPCB0YWJsZS0+c2l6ZTsgaW5kZXgrKykgewotCQl1MzIgdmFsdWUgPSBnZXRfZW50cnlfY29u
dHJvbCh0YWJsZSwgaW5kZXgpOwotCi0JCSpjcysrID0gaTkxNV9tbWlvX3JlZ19vZmZzZXQobW9j
c19yZWdpc3RlcihlbmdpbmUsIGluZGV4KSk7Ci0JCSpjcysrID0gdmFsdWU7Ci0JfQotCi0JLyog
QWxsIHJlbWFpbmluZyBlbnRyaWVzIGFyZSBhbHNvIHVudXNlZCAqLwotCWZvciAoOyBpbmRleCA8
IHRhYmxlLT5uX2VudHJpZXM7IGluZGV4KyspIHsKLQkJKmNzKysgPSBpOTE1X21taW9fcmVnX29m
ZnNldChtb2NzX3JlZ2lzdGVyKGVuZ2luZSwgaW5kZXgpKTsKLQkJKmNzKysgPSB1bnVzZWRfdmFs
dWU7Ci0JfQotCi0JKmNzKysgPSBNSV9OT09QOwotCWludGVsX3JpbmdfYWR2YW5jZShycSwgY3Mp
OwotCi0JcmV0dXJuIDA7Ci19Ci0KIC8qCiAgKiBHZXQgbDNjY192YWx1ZSBmcm9tIE1PQ1MgZW50
cnkgdGFraW5nIGludG8gYWNjb3VudCB3aGVuIGl0J3Mgbm90IHVzZWQ6CiAgKiBJOTE1X01PQ1Nf
UFRFJ3MgdmFsdWUgaXMgcmV0dXJuZWQgaW4gdGhpcyBjYXNlLgpAQCAtNDk0LDE0MSArNDAwLDEw
MCBAQCBzdGF0aWMgaW5saW5lIHUzMiBsM2NjX2NvbWJpbmUoY29uc3Qgc3RydWN0IGRybV9pOTE1
X21vY3NfdGFibGUgKnRhYmxlLAogCQkJICAgICAgIHUxNiBsb3csCiAJCQkgICAgICAgdTE2IGhp
Z2gpCiB7Ci0JcmV0dXJuIGxvdyB8IGhpZ2ggPDwgMTY7CisJcmV0dXJuIGxvdyB8ICh1MzIpaGln
aCA8PCAxNjsKIH0KIAotc3RhdGljIGludCBlbWl0X21vY3NfbDNjY190YWJsZShzdHJ1Y3QgaTkx
NV9yZXF1ZXN0ICpycSwKLQkJCQljb25zdCBzdHJ1Y3QgZHJtX2k5MTVfbW9jc190YWJsZSAqdGFi
bGUpCitzdGF0aWMgdm9pZCBpbml0X2wzY2NfdGFibGUoc3RydWN0IGludGVsX2VuZ2luZV9jcyAq
ZW5naW5lLAorCQkJICAgIGNvbnN0IHN0cnVjdCBkcm1faTkxNV9tb2NzX3RhYmxlICp0YWJsZSkK
IHsKLQl1MTYgdW51c2VkX3ZhbHVlOworCXN0cnVjdCBpbnRlbF91bmNvcmUgKnVuY29yZSA9IGVu
Z2luZS0+dW5jb3JlOworCXUxNiB1bnVzZWRfdmFsdWUgPSB0YWJsZS0+dGFibGVbSTkxNV9NT0NT
X1BURV0ubDNjY192YWx1ZTsKIAl1bnNpZ25lZCBpbnQgaTsKLQl1MzIgKmNzOwotCi0JaWYgKEdF
TV9XQVJOX09OKHRhYmxlLT5zaXplID4gdGFibGUtPm5fZW50cmllcykpCi0JCXJldHVybiAtRU5P
REVWOwotCi0JLyogU2V0IHVudXNlZCB2YWx1ZXMgdG8gUFRFICovCi0JdW51c2VkX3ZhbHVlID0g
dGFibGUtPnRhYmxlW0k5MTVfTU9DU19QVEVdLmwzY2NfdmFsdWU7Ci0KLQljcyA9IGludGVsX3Jp
bmdfYmVnaW4ocnEsIDIgKyB0YWJsZS0+bl9lbnRyaWVzKTsKLQlpZiAoSVNfRVJSKGNzKSkKLQkJ
cmV0dXJuIFBUUl9FUlIoY3MpOwotCi0JKmNzKysgPSBNSV9MT0FEX1JFR0lTVEVSX0lNTSh0YWJs
ZS0+bl9lbnRyaWVzIC8gMik7CiAKIAlmb3IgKGkgPSAwOyBpIDwgdGFibGUtPnNpemUgLyAyOyBp
KyspIHsKIAkJdTE2IGxvdyA9IGdldF9lbnRyeV9sM2NjKHRhYmxlLCAyICogaSk7CiAJCXUxNiBo
aWdoID0gZ2V0X2VudHJ5X2wzY2ModGFibGUsIDIgKiBpICsgMSk7CiAKLQkJKmNzKysgPSBpOTE1
X21taW9fcmVnX29mZnNldChHRU45X0xOQ0ZDTU9DUyhpKSk7Ci0JCSpjcysrID0gbDNjY19jb21i
aW5lKHRhYmxlLCBsb3csIGhpZ2gpOworCQlpbnRlbF91bmNvcmVfd3JpdGUodW5jb3JlLAorCQkJ
CSAgIEdFTjlfTE5DRkNNT0NTKGkpLAorCQkJCSAgIGwzY2NfY29tYmluZSh0YWJsZSwgbG93LCBo
aWdoKSk7CiAJfQogCiAJLyogT2RkIHRhYmxlIHNpemUgLSAxIGxlZnQgb3ZlciAqLwotCWlmICh0
YWJsZS0+c2l6ZSAmIDB4MDEpIHsKKwlpZiAodGFibGUtPnNpemUgJiAxKSB7CiAJCXUxNiBsb3cg
PSBnZXRfZW50cnlfbDNjYyh0YWJsZSwgMiAqIGkpOwogCi0JCSpjcysrID0gaTkxNV9tbWlvX3Jl
Z19vZmZzZXQoR0VOOV9MTkNGQ01PQ1MoaSkpOwotCQkqY3MrKyA9IGwzY2NfY29tYmluZSh0YWJs
ZSwgbG93LCB1bnVzZWRfdmFsdWUpOworCQlpbnRlbF91bmNvcmVfd3JpdGUodW5jb3JlLAorCQkJ
CSAgIEdFTjlfTE5DRkNNT0NTKGkpLAorCQkJCSAgIGwzY2NfY29tYmluZSh0YWJsZSwgbG93LCB1
bnVzZWRfdmFsdWUpKTsKIAkJaSsrOwogCX0KIAogCS8qIEFsbCByZW1haW5pbmcgZW50cmllcyBh
cmUgYWxzbyB1bnVzZWQgKi8KLQlmb3IgKDsgaSA8IHRhYmxlLT5uX2VudHJpZXMgLyAyOyBpKysp
IHsKLQkJKmNzKysgPSBpOTE1X21taW9fcmVnX29mZnNldChHRU45X0xOQ0ZDTU9DUyhpKSk7Ci0J
CSpjcysrID0gbDNjY19jb21iaW5lKHRhYmxlLCB1bnVzZWRfdmFsdWUsIHVudXNlZF92YWx1ZSk7
Ci0JfQotCi0JKmNzKysgPSBNSV9OT09QOwotCWludGVsX3JpbmdfYWR2YW5jZShycSwgY3MpOwot
Ci0JcmV0dXJuIDA7CisJZm9yICg7IGkgPCB0YWJsZS0+bl9lbnRyaWVzIC8gMjsgaSsrKQorCQlp
bnRlbF91bmNvcmVfd3JpdGUodW5jb3JlLAorCQkJCSAgIEdFTjlfTE5DRkNNT0NTKGkpLAorCQkJ
CSAgIGwzY2NfY29tYmluZSh0YWJsZSwgdW51c2VkX3ZhbHVlLAorCQkJCQkJdW51c2VkX3ZhbHVl
KSk7CiB9CiAKLXN0YXRpYyB2b2lkIGludGVsX21vY3NfaW5pdF9sM2NjX3RhYmxlKHN0cnVjdCBp
bnRlbF9ndCAqZ3QpCisvKioKKyAqIGludGVsX21vY3NfaW5pdF9lbmdpbmUoKSAtIGVtaXQgdGhl
IG1vY3MgY29udHJvbCB0YWJsZQorICogQGVuZ2luZToJVGhlIGVuZ2luZSBmb3Igd2hvbSB0byBl
bWl0IHRoZSByZWdpc3RlcnMuCisgKgorICogVGhpcyBmdW5jdGlvbiBzaW1wbHkgZW1pdHMgYSBN
SV9MT0FEX1JFR0lTVEVSX0lNTSBjb21tYW5kIGZvciB0aGUKKyAqIGdpdmVuIHRhYmxlIHN0YXJ0
aW5nIGF0IHRoZSBnaXZlbiBhZGRyZXNzLgorICovCit2b2lkIGludGVsX21vY3NfaW5pdF9lbmdp
bmUoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lKQogewotCXN0cnVjdCBpbnRlbF91bmNv
cmUgKnVuY29yZSA9IGd0LT51bmNvcmU7CiAJc3RydWN0IGRybV9pOTE1X21vY3NfdGFibGUgdGFi
bGU7Ci0JdW5zaWduZWQgaW50IGk7Ci0JdTE2IHVudXNlZF92YWx1ZTsKIAotCWlmICghZ2V0X21v
Y3Nfc2V0dGluZ3MoZ3QsICZ0YWJsZSkpCisJLyogQ2FsbGVkIHVuZGVyIGEgYmxhbmtldCBmb3Jj
ZXdha2UgKi8KKwlhc3NlcnRfZm9yY2V3YWtlc19hY3RpdmUoZW5naW5lLT51bmNvcmUsIEZPUkNF
V0FLRV9BTEwpOworCisJaWYgKCFnZXRfbW9jc19zZXR0aW5ncyhlbmdpbmUtPmk5MTUsICZ0YWJs
ZSkpCiAJCXJldHVybjsKIAotCS8qIFNldCB1bnVzZWQgdmFsdWVzIHRvIFBURSAqLwotCXVudXNl
ZF92YWx1ZSA9IHRhYmxlLnRhYmxlW0k5MTVfTU9DU19QVEVdLmwzY2NfdmFsdWU7CisJLyogUGxh
dGZvcm1zIHdpdGggZ2xvYmFsIE1PQ1MgZG8gbm90IG5lZWQgcGVyLWVuZ2luZSBpbml0aWFsaXph
dGlvbi4gKi8KKwlpZiAoIUhBU19HTE9CQUxfTU9DU19SRUdJU1RFUlMoZW5naW5lLT5pOTE1KSkK
KwkJaW5pdF9tb2NzX3RhYmxlKGVuZ2luZSwgJnRhYmxlKTsKIAotCWZvciAoaSA9IDA7IGkgPCB0
YWJsZS5zaXplIC8gMjsgaSsrKSB7Ci0JCXUxNiBsb3cgPSBnZXRfZW50cnlfbDNjYygmdGFibGUs
IDIgKiBpKTsKLQkJdTE2IGhpZ2ggPSBnZXRfZW50cnlfbDNjYygmdGFibGUsIDIgKiBpICsgMSk7
CisJaWYgKGVuZ2luZS0+Y2xhc3MgPT0gUkVOREVSX0NMQVNTKQorCQlpbml0X2wzY2NfdGFibGUo
ZW5naW5lLCAmdGFibGUpOworfQogCi0JCWludGVsX3VuY29yZV93cml0ZSh1bmNvcmUsCi0JCQkJ
ICAgR0VOOV9MTkNGQ01PQ1MoaSksCi0JCQkJICAgbDNjY19jb21iaW5lKCZ0YWJsZSwgbG93LCBo
aWdoKSk7Ci0JfQorc3RhdGljIHZvaWQgaW50ZWxfbW9jc19pbml0X2dsb2JhbChzdHJ1Y3QgaW50
ZWxfZ3QgKmd0KQoreworCXN0cnVjdCBpbnRlbF91bmNvcmUgKnVuY29yZSA9IGd0LT51bmNvcmU7
CisJc3RydWN0IGRybV9pOTE1X21vY3NfdGFibGUgdGFibGU7CisJdW5zaWduZWQgaW50IGluZGV4
OwogCi0JLyogT2RkIHRhYmxlIHNpemUgLSAxIGxlZnQgb3ZlciAqLwotCWlmICh0YWJsZS5zaXpl
ICYgMHgwMSkgewotCQl1MTYgbG93ID0gZ2V0X2VudHJ5X2wzY2MoJnRhYmxlLCAyICogaSk7CisJ
R0VNX0JVR19PTighSEFTX0dMT0JBTF9NT0NTX1JFR0lTVEVSUyhndC0+aTkxNSkpOwogCi0JCWlu
dGVsX3VuY29yZV93cml0ZSh1bmNvcmUsCi0JCQkJICAgR0VOOV9MTkNGQ01PQ1MoaSksCi0JCQkJ
ICAgbDNjY19jb21iaW5lKCZ0YWJsZSwgbG93LCB1bnVzZWRfdmFsdWUpKTsKLQkJaSsrOwotCX0K
KwlpZiAoIWdldF9tb2NzX3NldHRpbmdzKGd0LT5pOTE1LCAmdGFibGUpKQorCQlyZXR1cm47CiAK
LQkvKiBBbGwgcmVtYWluaW5nIGVudHJpZXMgYXJlIGFsc28gdW51c2VkICovCi0JZm9yICg7IGkg
PCB0YWJsZS5uX2VudHJpZXMgLyAyOyBpKyspCi0JCWludGVsX3VuY29yZV93cml0ZSh1bmNvcmUs
Ci0JCQkJICAgR0VOOV9MTkNGQ01PQ1MoaSksCi0JCQkJICAgbDNjY19jb21iaW5lKCZ0YWJsZSwg
dW51c2VkX3ZhbHVlLAotCQkJCQkJdW51c2VkX3ZhbHVlKSk7Ci19CisJaWYgKEdFTV9ERUJVR19X
QVJOX09OKHRhYmxlLnNpemUgPiB0YWJsZS5uX2VudHJpZXMpKQorCQlyZXR1cm47CiAKLS8qKgot
ICogaW50ZWxfbW9jc19lbWl0KCkgLSBwcm9ncmFtIHRoZSBNT0NTIHJlZ2lzdGVyLgotICogQHJx
OglSZXF1ZXN0IHRvIHVzZSB0byBzZXQgdXAgdGhlIE1PQ1MgdGFibGVzLgotICoKLSAqIFRoaXMg
ZnVuY3Rpb24gd2lsbCBlbWl0IGEgYmF0Y2ggYnVmZmVyIHdpdGggdGhlIHZhbHVlcyByZXF1aXJl
ZCBmb3IKLSAqIHByb2dyYW1taW5nIHRoZSBNT0NTIHJlZ2lzdGVyIHZhbHVlcyBmb3IgYWxsIHRo
ZSBjdXJyZW50bHkgc3VwcG9ydGVkCi0gKiByaW5ncy4KLSAqCi0gKiBUaGVzZSByZWdpc3RlcnMg
YXJlIHBhcnRpYWxseSBzdG9yZWQgaW4gdGhlIFJDUyBjb250ZXh0LCBzbyB0aGV5IGFyZQotICog
ZW1pdHRlZCBhdCB0aGUgc2FtZSB0aW1lIHNvIHRoYXQgd2hlbiBhIGNvbnRleHQgaXMgY3JlYXRl
ZCB0aGVzZSByZWdpc3RlcnMKLSAqIGFyZSBzZXQgdXAuIFRoZXNlIHJlZ2lzdGVycyBoYXZlIHRv
IGJlIGVtaXR0ZWQgaW50byB0aGUgc3RhcnQgb2YgdGhlCi0gKiBjb250ZXh0IGFzIHNldHRpbmcg
dGhlIEVMU1Agd2lsbCByZS1pbml0IHNvbWUgb2YgdGhlc2UgcmVnaXN0ZXJzIGJhY2sKLSAqIHRv
IHRoZSBodyB2YWx1ZXMuCi0gKgotICogUmV0dXJuOiAwIG9uIHN1Y2Nlc3MsIG90aGVyd2lzZSB0
aGUgZXJyb3Igc3RhdHVzLgotICovCi1pbnQgaW50ZWxfbW9jc19lbWl0KHN0cnVjdCBpOTE1X3Jl
cXVlc3QgKnJxKQotewotCXN0cnVjdCBkcm1faTkxNV9tb2NzX3RhYmxlIHQ7Ci0JaW50IHJldDsK
LQotCWlmIChIQVNfR0xPQkFMX01PQ1NfUkVHSVNURVJTKHJxLT5pOTE1KSB8fAotCSAgICBycS0+
ZW5naW5lLT5jbGFzcyAhPSBSRU5ERVJfQ0xBU1MpCi0JCXJldHVybiAwOwotCi0JaWYgKGdldF9t
b2NzX3NldHRpbmdzKHJxLT5lbmdpbmUtPmd0LCAmdCkpIHsKLQkJLyogUHJvZ3JhbSB0aGUgUkNT
IGNvbnRyb2wgcmVnaXN0ZXJzICovCi0JCXJldCA9IGVtaXRfbW9jc19jb250cm9sX3RhYmxlKHJx
LCAmdCk7Ci0JCWlmIChyZXQpCi0JCQlyZXR1cm4gcmV0OwotCi0JCS8qIE5vdyBwcm9ncmFtIHRo
ZSBsM2NjIHJlZ2lzdGVycyAqLwotCQlyZXQgPSBlbWl0X21vY3NfbDNjY190YWJsZShycSwgJnQp
OwotCQlpZiAocmV0KQotCQkJcmV0dXJuIHJldDsKLQl9CisJZm9yIChpbmRleCA9IDA7IGluZGV4
IDwgdGFibGUuc2l6ZTsgaW5kZXgrKykKKwkJaW50ZWxfdW5jb3JlX3dyaXRlKHVuY29yZSwKKwkJ
CQkgICBHRU4xMl9HTE9CQUxfTU9DUyhpbmRleCksCisJCQkJICAgdGFibGUudGFibGVbaW5kZXhd
LmNvbnRyb2xfdmFsdWUpOwogCi0JcmV0dXJuIDA7CisJLyoKKwkgKiBPaywgbm93IHNldCB0aGUg
dW51c2VkIGVudHJpZXMgdG8gdGhlIGludmFsaWQgZW50cnkgKGluZGV4IDApLiBUaGVzZQorCSAq
IGVudHJpZXMgYXJlIG9mZmljaWFsbHkgdW5kZWZpbmVkIGFuZCBubyBjb250cmFjdCBmb3IgdGhl
IGNvbnRlbnRzIGFuZAorCSAqIHNldHRpbmdzIGlzIGdpdmVuIGZvciB0aGVzZSBlbnRyaWVzLgor
CSAqLworCWZvciAoOyBpbmRleCA8IHRhYmxlLm5fZW50cmllczsgaW5kZXgrKykKKwkJaW50ZWxf
dW5jb3JlX3dyaXRlKHVuY29yZSwKKwkJCQkgICBHRU4xMl9HTE9CQUxfTU9DUyhpbmRleCksCisJ
CQkJICAgdGFibGUudGFibGVbMF0uY29udHJvbF92YWx1ZSk7CiB9CiAKIHZvaWQgaW50ZWxfbW9j
c19pbml0KHN0cnVjdCBpbnRlbF9ndCAqZ3QpCiB7Ci0JaW50ZWxfbW9jc19pbml0X2wzY2NfdGFi
bGUoZ3QpOwotCiAJaWYgKEhBU19HTE9CQUxfTU9DU19SRUdJU1RFUlMoZ3QtPmk5MTUpKQogCQlp
bnRlbF9tb2NzX2luaXRfZ2xvYmFsKGd0KTsKIH0KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2d0L2ludGVsX21vY3MuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX21v
Y3MuaAppbmRleCAyYWU4MTZiN2NhMTkuLjgzMzcxZjNlNmJhMSAxMDA2NDQKLS0tIGEvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbW9jcy5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2d0L2ludGVsX21vY3MuaApAQCAtNDksMTMgKzQ5LDEwIEBACiAgKiBjb250ZXh0IGhhbmRsaW5n
IGtlZXAgdGhlIE1PQ1MgaW4gc3RlcC4KICAqLwogCi1zdHJ1Y3QgaTkxNV9yZXF1ZXN0Owogc3Ry
dWN0IGludGVsX2VuZ2luZV9jczsKIHN0cnVjdCBpbnRlbF9ndDsKIAogdm9pZCBpbnRlbF9tb2Nz
X2luaXQoc3RydWN0IGludGVsX2d0ICpndCk7CiB2b2lkIGludGVsX21vY3NfaW5pdF9lbmdpbmUo
c3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lKTsKIAotaW50IGludGVsX21vY3NfZW1pdChz
dHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSk7Ci0KICNlbmRpZgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9n
cHUvZHJtL2k5MTUvaTkxNV9nZW0uYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtLmMK
aW5kZXggMGRkYmQzYTVmYjhkLi4zNjk0YzdmZjZkMjMgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L2k5MTVfZ2VtLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW0u
YwpAQCAtMTExMSwxNSArMTExMSw2IEBAIHN0YXRpYyBpbnQgX19pbnRlbF9lbmdpbmVzX3JlY29y
ZF9kZWZhdWx0cyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKIAkJaWYgKGVycikKIAkJ
CWdvdG8gZXJyX3JxOwogCi0JCS8qCi0JCSAqIEZhaWxpbmcgdG8gcHJvZ3JhbSB0aGUgTU9DUyBp
cyBub24tZmF0YWwuVGhlIHN5c3RlbSB3aWxsIG5vdAotCQkgKiBydW4gYXQgcGVhayBwZXJmb3Jt
YW5jZS4gU28gd2FybiB0aGUgdXNlciBhbmQgY2Fycnkgb24uCi0JCSAqLwotCQllcnIgPSBpbnRl
bF9tb2NzX2VtaXQocnEpOwotCQlpZiAoZXJyKQotCQkJZGV2X25vdGljZShpOTE1LT5kcm0uZGV2
LAotCQkJCSAgICJGYWlsZWQgdG8gcHJvZ3JhbSBNT0NTIHJlZ2lzdGVyczsgZXhwZWN0IHBlcmZv
cm1hbmNlIGlzc3Vlcy5cbiIpOwotCiAJCWVyciA9IGludGVsX3JlbmRlcnN0YXRlX2VtaXQocnEp
OwogCQlpZiAoZXJyKQogCQkJZ290byBlcnJfcnE7Ci0tIAoyLjIzLjAKCl9fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QK
SW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9w
Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWdmeA==

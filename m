Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 951A666A38
	for <lists+intel-gfx@lfdr.de>; Fri, 12 Jul 2019 11:43:40 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 334646E33E;
	Fri, 12 Jul 2019 09:43:35 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 5F5206E33C
 for <intel-gfx@lists.freedesktop.org>; Fri, 12 Jul 2019 09:43:33 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17243559-1500050 
 for <intel-gfx@lists.freedesktop.org>; Fri, 12 Jul 2019 10:43:27 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Fri, 12 Jul 2019 10:43:23 +0100
Message-Id: <20190712094327.24437-2-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.22.0
In-Reply-To: <20190712094327.24437-1-chris@chris-wilson.co.uk>
References: <20190712094327.24437-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [CI 2/6] drm/i915/gtt: Reorder gen8 ppgtt
 free/clear/alloc
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SW4gcHJlcGFyYXRpb24gZm9yIHJlZmFjdG9yaW5nIHRoZSBmcmVlL2NsZWFyL2FsbG9jLCBmaXJz
dCBtb3ZlIHRoZSBjb2RlCmFyb3VuZCBzbyB0aGF0IHdlIGNhbiBhdm9pZCBmb3J3YXJkIGRlY2xh
cmF0aW9ucyBpbiB0aGUgbmV4dCBzZXQgb2YKcGF0Y2hlcy4KClNpZ25lZC1vZmYtYnk6IENocmlz
IFdpbHNvbiA8Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPgpSZXZpZXdlZC1ieTogTWlrYSBLdW9w
cGFsYSA8bWlrYS5rdW9wcGFsYUBsaW51eC5pbnRlbC5jb20+Ci0tLQogZHJpdmVycy9ncHUvZHJt
L2k5MTUvaTkxNV9nZW1fZ3R0LmMgfCA2NzMgKysrKysrKysrKysrKystLS0tLS0tLS0tLS0tLQog
MSBmaWxlIGNoYW5nZWQsIDMzNyBpbnNlcnRpb25zKCspLCAzMzYgZGVsZXRpb25zKC0pCgpkaWZm
IC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW1fZ3R0LmMgYi9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuYwppbmRleCBiMmFhNDQxMDNmYjAuLmFiYjJlM2U0YmJi
YyAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW1fZ3R0LmMKKysrIGIv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW1fZ3R0LmMKQEAgLTgzMCw2ICs4MzAsMTA0IEBA
IHN0YXRpYyB2b2lkIG1hcmtfdGxic19kaXJ0eShzdHJ1Y3QgaTkxNV9wcGd0dCAqcHBndHQpCiAJ
cHBndHQtPnBkX2RpcnR5X2VuZ2luZXMgPSBBTExfRU5HSU5FUzsKIH0KIAorc3RhdGljIGludCBn
ZW44X3BwZ3R0X25vdGlmeV92Z3Qoc3RydWN0IGk5MTVfcHBndHQgKnBwZ3R0LCBib29sIGNyZWF0
ZSkKK3sKKwlzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSA9ICZwcGd0dC0+dm07CisJc3Ry
dWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2ID0gdm0tPmk5MTU7CisJZW51bSB2Z3RfZzJ2
X3R5cGUgbXNnOworCWludCBpOworCisJaWYgKGNyZWF0ZSkKKwkJYXRvbWljX2luYyhweF91c2Vk
KHBwZ3R0LT5wZCkpOyAvKiBuZXZlciByZW1vdmUgKi8KKwllbHNlCisJCWF0b21pY19kZWMocHhf
dXNlZChwcGd0dC0+cGQpKTsKKworCWlmIChpOTE1X3ZtX2lzXzRsdmwodm0pKSB7CisJCWNvbnN0
IHU2NCBkYWRkciA9IHB4X2RtYShwcGd0dC0+cGQpOworCisJCUk5MTVfV1JJVEUodmd0aWZfcmVn
KHBkcFswXS5sbyksIGxvd2VyXzMyX2JpdHMoZGFkZHIpKTsKKwkJSTkxNV9XUklURSh2Z3RpZl9y
ZWcocGRwWzBdLmhpKSwgdXBwZXJfMzJfYml0cyhkYWRkcikpOworCisJCW1zZyA9IChjcmVhdGUg
PyBWR1RfRzJWX1BQR1RUX0w0X1BBR0VfVEFCTEVfQ1JFQVRFIDoKKwkJCQlWR1RfRzJWX1BQR1RU
X0w0X1BBR0VfVEFCTEVfREVTVFJPWSk7CisJfSBlbHNlIHsKKwkJZm9yIChpID0gMDsgaSA8IEdF
TjhfM0xWTF9QRFBFUzsgaSsrKSB7CisJCQljb25zdCB1NjQgZGFkZHIgPSBpOTE1X3BhZ2VfZGly
X2RtYV9hZGRyKHBwZ3R0LCBpKTsKKworCQkJSTkxNV9XUklURSh2Z3RpZl9yZWcocGRwW2ldLmxv
KSwgbG93ZXJfMzJfYml0cyhkYWRkcikpOworCQkJSTkxNV9XUklURSh2Z3RpZl9yZWcocGRwW2ld
LmhpKSwgdXBwZXJfMzJfYml0cyhkYWRkcikpOworCQl9CisKKwkJbXNnID0gKGNyZWF0ZSA/IFZH
VF9HMlZfUFBHVFRfTDNfUEFHRV9UQUJMRV9DUkVBVEUgOgorCQkJCVZHVF9HMlZfUFBHVFRfTDNf
UEFHRV9UQUJMRV9ERVNUUk9ZKTsKKwl9CisKKwlJOTE1X1dSSVRFKHZndGlmX3JlZyhnMnZfbm90
aWZ5KSwgbXNnKTsKKworCXJldHVybiAwOworfQorCitzdGF0aWMgdm9pZCBnZW44X2ZyZWVfcGFn
ZV90YWJsZXMoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCisJCQkJICBzdHJ1Y3QgaTkx
NV9wYWdlX2RpcmVjdG9yeSAqcGQpCit7CisJaW50IGk7CisKKwlmb3IgKGkgPSAwOyBpIDwgSTkx
NV9QREVTOyBpKyspIHsKKwkJaWYgKHBkLT5lbnRyeVtpXSAhPSAmdm0tPnNjcmF0Y2hfcHQpCisJ
CQlmcmVlX3BkKHZtLCBwZC0+ZW50cnlbaV0pOworCX0KK30KKworc3RhdGljIHZvaWQgZ2VuOF9w
cGd0dF9jbGVhbnVwXzNsdmwoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCisJCQkJICAg
IHN0cnVjdCBpOTE1X3BhZ2VfZGlyZWN0b3J5ICpwZHApCit7CisJY29uc3QgdW5zaWduZWQgaW50
IHBkcGVzID0gaTkxNV9wZHBlc19wZXJfcGRwKHZtKTsKKwlpbnQgaTsKKworCWZvciAoaSA9IDA7
IGkgPCBwZHBlczsgaSsrKSB7CisJCWlmIChwZHAtPmVudHJ5W2ldID09ICZ2bS0+c2NyYXRjaF9w
ZCkKKwkJCWNvbnRpbnVlOworCisJCWdlbjhfZnJlZV9wYWdlX3RhYmxlcyh2bSwgcGRwLT5lbnRy
eVtpXSk7CisJCWZyZWVfcGQodm0sIHBkcC0+ZW50cnlbaV0pOworCX0KKworCWZyZWVfcHgodm0s
IHBkcCk7Cit9CisKK3N0YXRpYyB2b2lkIGdlbjhfcHBndHRfY2xlYW51cF80bHZsKHN0cnVjdCBp
OTE1X3BwZ3R0ICpwcGd0dCkKK3sKKwlzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeSAqIGNvbnN0
IHBtbDQgPSBwcGd0dC0+cGQ7CisJaW50IGk7CisKKwlmb3IgKGkgPSAwOyBpIDwgR0VOOF9QTUw0
RVNfUEVSX1BNTDQ7IGkrKykgeworCQlzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeSAqcGRwID0g
aTkxNV9wZHBfZW50cnkocG1sNCwgaSk7CisKKwkJaWYgKHB4X2Jhc2UocGRwKSA9PSAmcHBndHQt
PnZtLnNjcmF0Y2hfcGRwKQorCQkJY29udGludWU7CisKKwkJZ2VuOF9wcGd0dF9jbGVhbnVwXzNs
dmwoJnBwZ3R0LT52bSwgcGRwKTsKKwl9CisKKwlmcmVlX3B4KCZwcGd0dC0+dm0sIHBtbDQpOwor
fQorCitzdGF0aWMgdm9pZCBnZW44X3BwZ3R0X2NsZWFudXAoc3RydWN0IGk5MTVfYWRkcmVzc19z
cGFjZSAqdm0pCit7CisJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUgPSB2bS0+aTkxNTsK
KwlzdHJ1Y3QgaTkxNV9wcGd0dCAqcHBndHQgPSBpOTE1X3ZtX3RvX3BwZ3R0KHZtKTsKKworCWlm
IChpbnRlbF92Z3B1X2FjdGl2ZShpOTE1KSkKKwkJZ2VuOF9wcGd0dF9ub3RpZnlfdmd0KHBwZ3R0
LCBmYWxzZSk7CisKKwlpZiAoaTkxNV92bV9pc180bHZsKHZtKSkKKwkJZ2VuOF9wcGd0dF9jbGVh
bnVwXzRsdmwocHBndHQpOworCWVsc2UKKwkJZ2VuOF9wcGd0dF9jbGVhbnVwXzNsdmwoJnBwZ3R0
LT52bSwgcHBndHQtPnBkKTsKKworCWZyZWVfc2NyYXRjaCh2bSk7Cit9CisKIC8qIFJlbW92ZXMg
ZW50cmllcyBmcm9tIGEgc2luZ2xlIHBhZ2UgdGFibGUsIHJlbGVhc2luZyBpdCBpZiBpdCdzIGVt
cHR5LgogICogQ2FsbGVyIGNhbiB1c2UgdGhlIHJldHVybiB2YWx1ZSB0byB1cGRhdGUgaGlnaGVy
LWxldmVsIGVudHJpZXMuCiAgKi8KQEAgLTkxNiw5NSArMTAxNCwyNjUgQEAgc3RhdGljIHZvaWQg
Z2VuOF9wcGd0dF9jbGVhcl80bHZsKHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAogCX0K
IH0KIAotc3RhdGljIGlubGluZSBzdHJ1Y3Qgc2d0X2RtYSB7Ci0Jc3RydWN0IHNjYXR0ZXJsaXN0
ICpzZzsKLQlkbWFfYWRkcl90IGRtYSwgbWF4OwotfSBzZ3RfZG1hKHN0cnVjdCBpOTE1X3ZtYSAq
dm1hKSB7Ci0Jc3RydWN0IHNjYXR0ZXJsaXN0ICpzZyA9IHZtYS0+cGFnZXMtPnNnbDsKLQlkbWFf
YWRkcl90IGFkZHIgPSBzZ19kbWFfYWRkcmVzcyhzZyk7Ci0JcmV0dXJuIChzdHJ1Y3Qgc2d0X2Rt
YSkgeyBzZywgYWRkciwgYWRkciArIHNnLT5sZW5ndGggfTsKLX0KLQotc3RydWN0IGdlbjhfaW5z
ZXJ0X3B0ZSB7Ci0JdTE2IHBtbDRlOwotCXUxNiBwZHBlOwotCXUxNiBwZGU7Ci0JdTE2IHB0ZTsK
LX07CiAKLXN0YXRpYyBfX2Fsd2F5c19pbmxpbmUgc3RydWN0IGdlbjhfaW5zZXJ0X3B0ZSBnZW44
X2luc2VydF9wdGUodTY0IHN0YXJ0KQorc3RhdGljIGludCBnZW44X3BwZ3R0X2FsbG9jX3BkKHN0
cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAorCQkJICAgICAgIHN0cnVjdCBpOTE1X3BhZ2Vf
ZGlyZWN0b3J5ICpwZCwKKwkJCSAgICAgICB1NjQgc3RhcnQsIHU2NCBsZW5ndGgpCiB7Ci0JcmV0
dXJuIChzdHJ1Y3QgZ2VuOF9pbnNlcnRfcHRlKSB7Ci0JCSBnZW44X3BtbDRlX2luZGV4KHN0YXJ0
KSwKLQkJIGdlbjhfcGRwZV9pbmRleChzdGFydCksCi0JCSBnZW44X3BkZV9pbmRleChzdGFydCks
Ci0JCSBnZW44X3B0ZV9pbmRleChzdGFydCksCi0JfTsKLX0KKwlzdHJ1Y3QgaTkxNV9wYWdlX3Rh
YmxlICpwdCwgKmFsbG9jID0gTlVMTDsKKwl1NjQgZnJvbSA9IHN0YXJ0OworCXVuc2lnbmVkIGlu
dCBwZGU7CisJaW50IHJldCA9IDA7CiAKLXN0YXRpYyBfX2Fsd2F5c19pbmxpbmUgYm9vbAotZ2Vu
OF9wcGd0dF9pbnNlcnRfcHRlX2VudHJpZXMoc3RydWN0IGk5MTVfcHBndHQgKnBwZ3R0LAotCQkJ
ICAgICAgc3RydWN0IGk5MTVfcGFnZV9kaXJlY3RvcnkgKnBkcCwKLQkJCSAgICAgIHN0cnVjdCBz
Z3RfZG1hICppdGVyLAotCQkJICAgICAgc3RydWN0IGdlbjhfaW5zZXJ0X3B0ZSAqaWR4LAotCQkJ
ICAgICAgZW51bSBpOTE1X2NhY2hlX2xldmVsIGNhY2hlX2xldmVsLAotCQkJICAgICAgdTMyIGZs
YWdzKQotewotCXN0cnVjdCBpOTE1X3BhZ2VfZGlyZWN0b3J5ICpwZDsKLQljb25zdCBnZW44X3B0
ZV90IHB0ZV9lbmNvZGUgPSBnZW44X3B0ZV9lbmNvZGUoMCwgY2FjaGVfbGV2ZWwsIGZsYWdzKTsK
LQlnZW44X3B0ZV90ICp2YWRkcjsKLQlib29sIHJldDsKKwlzcGluX2xvY2soJnBkLT5sb2NrKTsK
KwlnZW44X2Zvcl9lYWNoX3BkZShwdCwgcGQsIHN0YXJ0LCBsZW5ndGgsIHBkZSkgeworCQljb25z
dCBpbnQgY291bnQgPSBnZW44X3B0ZV9jb3VudChzdGFydCwgbGVuZ3RoKTsKIAotCUdFTV9CVUdf
T04oaWR4LT5wZHBlID49IGk5MTVfcGRwZXNfcGVyX3BkcCgmcHBndHQtPnZtKSk7Ci0JcGQgPSBp
OTE1X3BkX2VudHJ5KHBkcCwgaWR4LT5wZHBlKTsKLQl2YWRkciA9IGttYXBfYXRvbWljX3B4KGk5
MTVfcHRfZW50cnkocGQsIGlkeC0+cGRlKSk7Ci0JZG8gewotCQl2YWRkcltpZHgtPnB0ZV0gPSBw
dGVfZW5jb2RlIHwgaXRlci0+ZG1hOworCQlpZiAocHhfYmFzZShwdCkgPT0gJnZtLT5zY3JhdGNo
X3B0KSB7CisJCQlzcGluX3VubG9jaygmcGQtPmxvY2spOwogCi0JCWl0ZXItPmRtYSArPSBJOTE1
X0dUVF9QQUdFX1NJWkU7Ci0JCWlmIChpdGVyLT5kbWEgPj0gaXRlci0+bWF4KSB7Ci0JCQlpdGVy
LT5zZyA9IF9fc2dfbmV4dChpdGVyLT5zZyk7Ci0JCQlpZiAoIWl0ZXItPnNnKSB7Ci0JCQkJcmV0
ID0gZmFsc2U7Ci0JCQkJYnJlYWs7CisJCQlwdCA9IGZldGNoX2FuZF96ZXJvKCZhbGxvYyk7CisJ
CQlpZiAoIXB0KQorCQkJCXB0ID0gYWxsb2NfcHQodm0pOworCQkJaWYgKElTX0VSUihwdCkpIHsK
KwkJCQlyZXQgPSBQVFJfRVJSKHB0KTsKKwkJCQlnb3RvIHVud2luZDsKIAkJCX0KIAotCQkJaXRl
ci0+ZG1hID0gc2dfZG1hX2FkZHJlc3MoaXRlci0+c2cpOwotCQkJaXRlci0+bWF4ID0gaXRlci0+
ZG1hICsgaXRlci0+c2ctPmxlbmd0aDsKKwkJCWlmIChjb3VudCA8IEdFTjhfUFRFUyB8fCBpbnRl
bF92Z3B1X2FjdGl2ZSh2bS0+aTkxNSkpCisJCQkJZmlsbF9weChwdCwgdm0tPnNjcmF0Y2hfcHRl
KTsKKworCQkJc3Bpbl9sb2NrKCZwZC0+bG9jayk7CisJCQlpZiAocGQtPmVudHJ5W3BkZV0gPT0g
JnZtLT5zY3JhdGNoX3B0KSB7CisJCQkJc2V0X3BkX2VudHJ5KHBkLCBwZGUsIHB0KTsKKwkJCX0g
ZWxzZSB7CisJCQkJYWxsb2MgPSBwdDsKKwkJCQlwdCA9IHBkLT5lbnRyeVtwZGVdOworCQkJfQog
CQl9CiAKLQkJaWYgKCsraWR4LT5wdGUgPT0gR0VOOF9QVEVTKSB7Ci0JCQlpZHgtPnB0ZSA9IDA7
CisJCWF0b21pY19hZGQoY291bnQsICZwdC0+dXNlZCk7CisJfQorCXNwaW5fdW5sb2NrKCZwZC0+
bG9jayk7CisJZ290byBvdXQ7CiAKLQkJCWlmICgrK2lkeC0+cGRlID09IEk5MTVfUERFUykgewot
CQkJCWlkeC0+cGRlID0gMDsKK3Vud2luZDoKKwlnZW44X3BwZ3R0X2NsZWFyX3BkKHZtLCBwZCwg
ZnJvbSwgc3RhcnQgLSBmcm9tKTsKK291dDoKKwlpZiAoYWxsb2MpCisJCWZyZWVfcHgodm0sIGFs
bG9jKTsKKwlyZXR1cm4gcmV0OworfQogCi0JCQkJLyogTGltaXRlZCBieSBzZyBsZW5ndGggZm9y
IDNsdmwgKi8KLQkJCQlpZiAoKytpZHgtPnBkcGUgPT0gR0VOOF9QTUw0RVNfUEVSX1BNTDQpIHsK
LQkJCQkJaWR4LT5wZHBlID0gMDsKLQkJCQkJcmV0ID0gdHJ1ZTsKLQkJCQkJYnJlYWs7Ci0JCQkJ
fQorc3RhdGljIGludCBnZW44X3BwZ3R0X2FsbG9jX3BkcChzdHJ1Y3QgaTkxNV9hZGRyZXNzX3Nw
YWNlICp2bSwKKwkJCQlzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeSAqcGRwLAorCQkJCXU2NCBz
dGFydCwgdTY0IGxlbmd0aCkKK3sKKwlzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeSAqcGQsICph
bGxvYyA9IE5VTEw7CisJdTY0IGZyb20gPSBzdGFydDsKKwl1bnNpZ25lZCBpbnQgcGRwZTsKKwlp
bnQgcmV0ID0gMDsKIAotCQkJCUdFTV9CVUdfT04oaWR4LT5wZHBlID49IGk5MTVfcGRwZXNfcGVy
X3BkcCgmcHBndHQtPnZtKSk7Ci0JCQkJcGQgPSBwZHAtPmVudHJ5W2lkeC0+cGRwZV07CisJc3Bp
bl9sb2NrKCZwZHAtPmxvY2spOworCWdlbjhfZm9yX2VhY2hfcGRwZShwZCwgcGRwLCBzdGFydCwg
bGVuZ3RoLCBwZHBlKSB7CisJCWlmIChweF9iYXNlKHBkKSA9PSAmdm0tPnNjcmF0Y2hfcGQpIHsK
KwkJCXNwaW5fdW5sb2NrKCZwZHAtPmxvY2spOworCisJCQlwZCA9IGZldGNoX2FuZF96ZXJvKCZh
bGxvYyk7CisJCQlpZiAoIXBkKQorCQkJCXBkID0gYWxsb2NfcGQodm0pOworCQkJaWYgKElTX0VS
UihwZCkpIHsKKwkJCQlyZXQgPSBQVFJfRVJSKHBkKTsKKwkJCQlnb3RvIHVud2luZDsKIAkJCX0K
IAotCQkJa3VubWFwX2F0b21pYyh2YWRkcik7Ci0JCQl2YWRkciA9IGttYXBfYXRvbWljX3B4KGk5
MTVfcHRfZW50cnkocGQsIGlkeC0+cGRlKSk7CisJCQlpbml0X3BkKHBkLCAmdm0tPnNjcmF0Y2hf
cHQpOworCisJCQlzcGluX2xvY2soJnBkcC0+bG9jayk7CisJCQlpZiAocGRwLT5lbnRyeVtwZHBl
XSA9PSAmdm0tPnNjcmF0Y2hfcGQpIHsKKwkJCQlzZXRfcGRfZW50cnkocGRwLCBwZHBlLCBwZCk7
CisJCQl9IGVsc2UgeworCQkJCWFsbG9jID0gcGQ7CisJCQkJcGQgPSBwZHAtPmVudHJ5W3BkcGVd
OworCQkJfQogCQl9Ci0JfSB3aGlsZSAoMSk7Ci0Ja3VubWFwX2F0b21pYyh2YWRkcik7CisJCWF0
b21pY19pbmMocHhfdXNlZChwZCkpOworCQlzcGluX3VubG9jaygmcGRwLT5sb2NrKTsKKworCQly
ZXQgPSBnZW44X3BwZ3R0X2FsbG9jX3BkKHZtLCBwZCwgc3RhcnQsIGxlbmd0aCk7CisJCWlmICh1
bmxpa2VseShyZXQpKQorCQkJZ290byB1bndpbmRfcGQ7CisKKwkJc3Bpbl9sb2NrKCZwZHAtPmxv
Y2spOworCQlhdG9taWNfZGVjKHB4X3VzZWQocGQpKTsKKwl9CisJc3Bpbl91bmxvY2soJnBkcC0+
bG9jayk7CisJZ290byBvdXQ7CiAKK3Vud2luZF9wZDoKKwlpZiAocmVsZWFzZV9wZF9lbnRyeShw
ZHAsIHBkcGUsICZwZC0+cHQsICZ2bS0+c2NyYXRjaF9wZCkpCisJCWZyZWVfcHgodm0sIHBkKTsK
K3Vud2luZDoKKwlnZW44X3BwZ3R0X2NsZWFyX3BkcCh2bSwgcGRwLCBmcm9tLCBzdGFydCAtIGZy
b20pOworb3V0OgorCWlmIChhbGxvYykKKwkJZnJlZV9weCh2bSwgYWxsb2MpOwogCXJldHVybiBy
ZXQ7CiB9CiAKLXN0YXRpYyB2b2lkIGdlbjhfcHBndHRfaW5zZXJ0XzNsdmwoc3RydWN0IGk5MTVf
YWRkcmVzc19zcGFjZSAqdm0sCi0JCQkJICAgc3RydWN0IGk5MTVfdm1hICp2bWEsCi0JCQkJICAg
ZW51bSBpOTE1X2NhY2hlX2xldmVsIGNhY2hlX2xldmVsLAotCQkJCSAgIHUzMiBmbGFncykKK3N0
YXRpYyBpbnQgZ2VuOF9wcGd0dF9hbGxvY18zbHZsKHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2Ug
KnZtLAorCQkJCSB1NjQgc3RhcnQsIHU2NCBsZW5ndGgpCiB7Ci0Jc3RydWN0IGk5MTVfcHBndHQg
KnBwZ3R0ID0gaTkxNV92bV90b19wcGd0dCh2bSk7CisJcmV0dXJuIGdlbjhfcHBndHRfYWxsb2Nf
cGRwKHZtLAorCQkJCSAgICBpOTE1X3ZtX3RvX3BwZ3R0KHZtKS0+cGQsIHN0YXJ0LCBsZW5ndGgp
OworfQorCitzdGF0aWMgaW50IGdlbjhfcHBndHRfYWxsb2NfNGx2bChzdHJ1Y3QgaTkxNV9hZGRy
ZXNzX3NwYWNlICp2bSwKKwkJCQkgdTY0IHN0YXJ0LCB1NjQgbGVuZ3RoKQoreworCXN0cnVjdCBp
OTE1X3BwZ3R0ICpwcGd0dCA9IGk5MTVfdm1fdG9fcHBndHQodm0pOworCXN0cnVjdCBpOTE1X3Bh
Z2VfZGlyZWN0b3J5ICogY29uc3QgcG1sNCA9IHBwZ3R0LT5wZDsKKwlzdHJ1Y3QgaTkxNV9wYWdl
X2RpcmVjdG9yeSAqcGRwLCAqYWxsb2MgPSBOVUxMOworCXU2NCBmcm9tID0gc3RhcnQ7CisJaW50
IHJldCA9IDA7CisJdTMyIHBtbDRlOworCisJc3Bpbl9sb2NrKCZwbWw0LT5sb2NrKTsKKwlnZW44
X2Zvcl9lYWNoX3BtbDRlKHBkcCwgcG1sNCwgc3RhcnQsIGxlbmd0aCwgcG1sNGUpIHsKKwkJaWYg
KHB4X2Jhc2UocGRwKSA9PSAmdm0tPnNjcmF0Y2hfcGRwKSB7CisJCQlzcGluX3VubG9jaygmcG1s
NC0+bG9jayk7CisKKwkJCXBkcCA9IGZldGNoX2FuZF96ZXJvKCZhbGxvYyk7CisJCQlpZiAoIXBk
cCkKKwkJCQlwZHAgPSBhbGxvY19wZCh2bSk7CisJCQlpZiAoSVNfRVJSKHBkcCkpIHsKKwkJCQly
ZXQgPSBQVFJfRVJSKHBkcCk7CisJCQkJZ290byB1bndpbmQ7CisJCQl9CisKKwkJCWluaXRfcGQo
cGRwLCAmdm0tPnNjcmF0Y2hfcGQpOworCisJCQlzcGluX2xvY2soJnBtbDQtPmxvY2spOworCQkJ
aWYgKHBtbDQtPmVudHJ5W3BtbDRlXSA9PSAmdm0tPnNjcmF0Y2hfcGRwKSB7CisJCQkJc2V0X3Bk
X2VudHJ5KHBtbDQsIHBtbDRlLCBwZHApOworCQkJfSBlbHNlIHsKKwkJCQlhbGxvYyA9IHBkcDsK
KwkJCQlwZHAgPSBwbWw0LT5lbnRyeVtwbWw0ZV07CisJCQl9CisJCX0KKwkJYXRvbWljX2luYyhw
eF91c2VkKHBkcCkpOworCQlzcGluX3VubG9jaygmcG1sNC0+bG9jayk7CisKKwkJcmV0ID0gZ2Vu
OF9wcGd0dF9hbGxvY19wZHAodm0sIHBkcCwgc3RhcnQsIGxlbmd0aCk7CisJCWlmICh1bmxpa2Vs
eShyZXQpKQorCQkJZ290byB1bndpbmRfcGRwOworCisJCXNwaW5fbG9jaygmcG1sNC0+bG9jayk7
CisJCWF0b21pY19kZWMocHhfdXNlZChwZHApKTsKKwl9CisJc3Bpbl91bmxvY2soJnBtbDQtPmxv
Y2spOworCWdvdG8gb3V0OworCit1bndpbmRfcGRwOgorCWlmIChyZWxlYXNlX3BkX2VudHJ5KHBt
bDQsIHBtbDRlLCAmcGRwLT5wdCwgJnZtLT5zY3JhdGNoX3BkcCkpCisJCWZyZWVfcHgodm0sIHBk
cCk7Cit1bndpbmQ6CisJZ2VuOF9wcGd0dF9jbGVhcl80bHZsKHZtLCBmcm9tLCBzdGFydCAtIGZy
b20pOworb3V0OgorCWlmIChhbGxvYykKKwkJZnJlZV9weCh2bSwgYWxsb2MpOworCXJldHVybiBy
ZXQ7Cit9CisKK3N0YXRpYyBpbmxpbmUgc3RydWN0IHNndF9kbWEgeworCXN0cnVjdCBzY2F0dGVy
bGlzdCAqc2c7CisJZG1hX2FkZHJfdCBkbWEsIG1heDsKK30gc2d0X2RtYShzdHJ1Y3QgaTkxNV92
bWEgKnZtYSkgeworCXN0cnVjdCBzY2F0dGVybGlzdCAqc2cgPSB2bWEtPnBhZ2VzLT5zZ2w7CisJ
ZG1hX2FkZHJfdCBhZGRyID0gc2dfZG1hX2FkZHJlc3Moc2cpOworCXJldHVybiAoc3RydWN0IHNn
dF9kbWEpIHsgc2csIGFkZHIsIGFkZHIgKyBzZy0+bGVuZ3RoIH07Cit9CisKK3N0cnVjdCBnZW44
X2luc2VydF9wdGUgeworCXUxNiBwbWw0ZTsKKwl1MTYgcGRwZTsKKwl1MTYgcGRlOworCXUxNiBw
dGU7Cit9OworCitzdGF0aWMgX19hbHdheXNfaW5saW5lIHN0cnVjdCBnZW44X2luc2VydF9wdGUg
Z2VuOF9pbnNlcnRfcHRlKHU2NCBzdGFydCkKK3sKKwlyZXR1cm4gKHN0cnVjdCBnZW44X2luc2Vy
dF9wdGUpIHsKKwkJIGdlbjhfcG1sNGVfaW5kZXgoc3RhcnQpLAorCQkgZ2VuOF9wZHBlX2luZGV4
KHN0YXJ0KSwKKwkJIGdlbjhfcGRlX2luZGV4KHN0YXJ0KSwKKwkJIGdlbjhfcHRlX2luZGV4KHN0
YXJ0KSwKKwl9OworfQorCitzdGF0aWMgX19hbHdheXNfaW5saW5lIGJvb2wKK2dlbjhfcHBndHRf
aW5zZXJ0X3B0ZV9lbnRyaWVzKHN0cnVjdCBpOTE1X3BwZ3R0ICpwcGd0dCwKKwkJCSAgICAgIHN0
cnVjdCBpOTE1X3BhZ2VfZGlyZWN0b3J5ICpwZHAsCisJCQkgICAgICBzdHJ1Y3Qgc2d0X2RtYSAq
aXRlciwKKwkJCSAgICAgIHN0cnVjdCBnZW44X2luc2VydF9wdGUgKmlkeCwKKwkJCSAgICAgIGVu
dW0gaTkxNV9jYWNoZV9sZXZlbCBjYWNoZV9sZXZlbCwKKwkJCSAgICAgIHUzMiBmbGFncykKK3sK
KwlzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeSAqcGQ7CisJY29uc3QgZ2VuOF9wdGVfdCBwdGVf
ZW5jb2RlID0gZ2VuOF9wdGVfZW5jb2RlKDAsIGNhY2hlX2xldmVsLCBmbGFncyk7CisJZ2VuOF9w
dGVfdCAqdmFkZHI7CisJYm9vbCByZXQ7CisKKwlHRU1fQlVHX09OKGlkeC0+cGRwZSA+PSBpOTE1
X3BkcGVzX3Blcl9wZHAoJnBwZ3R0LT52bSkpOworCXBkID0gaTkxNV9wZF9lbnRyeShwZHAsIGlk
eC0+cGRwZSk7CisJdmFkZHIgPSBrbWFwX2F0b21pY19weChpOTE1X3B0X2VudHJ5KHBkLCBpZHgt
PnBkZSkpOworCWRvIHsKKwkJdmFkZHJbaWR4LT5wdGVdID0gcHRlX2VuY29kZSB8IGl0ZXItPmRt
YTsKKworCQlpdGVyLT5kbWEgKz0gSTkxNV9HVFRfUEFHRV9TSVpFOworCQlpZiAoaXRlci0+ZG1h
ID49IGl0ZXItPm1heCkgeworCQkJaXRlci0+c2cgPSBfX3NnX25leHQoaXRlci0+c2cpOworCQkJ
aWYgKCFpdGVyLT5zZykgeworCQkJCXJldCA9IGZhbHNlOworCQkJCWJyZWFrOworCQkJfQorCisJ
CQlpdGVyLT5kbWEgPSBzZ19kbWFfYWRkcmVzcyhpdGVyLT5zZyk7CisJCQlpdGVyLT5tYXggPSBp
dGVyLT5kbWEgKyBpdGVyLT5zZy0+bGVuZ3RoOworCQl9CisKKwkJaWYgKCsraWR4LT5wdGUgPT0g
R0VOOF9QVEVTKSB7CisJCQlpZHgtPnB0ZSA9IDA7CisKKwkJCWlmICgrK2lkeC0+cGRlID09IEk5
MTVfUERFUykgeworCQkJCWlkeC0+cGRlID0gMDsKKworCQkJCS8qIExpbWl0ZWQgYnkgc2cgbGVu
Z3RoIGZvciAzbHZsICovCisJCQkJaWYgKCsraWR4LT5wZHBlID09IEdFTjhfUE1MNEVTX1BFUl9Q
TUw0KSB7CisJCQkJCWlkeC0+cGRwZSA9IDA7CisJCQkJCXJldCA9IHRydWU7CisJCQkJCWJyZWFr
OworCQkJCX0KKworCQkJCUdFTV9CVUdfT04oaWR4LT5wZHBlID49IGk5MTVfcGRwZXNfcGVyX3Bk
cCgmcHBndHQtPnZtKSk7CisJCQkJcGQgPSBwZHAtPmVudHJ5W2lkeC0+cGRwZV07CisJCQl9CisK
KwkJCWt1bm1hcF9hdG9taWModmFkZHIpOworCQkJdmFkZHIgPSBrbWFwX2F0b21pY19weChpOTE1
X3B0X2VudHJ5KHBkLCBpZHgtPnBkZSkpOworCQl9CisJfSB3aGlsZSAoMSk7CisJa3VubWFwX2F0
b21pYyh2YWRkcik7CisKKwlyZXR1cm4gcmV0OworfQorCitzdGF0aWMgdm9pZCBnZW44X3BwZ3R0
X2luc2VydF8zbHZsKHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAorCQkJCSAgIHN0cnVj
dCBpOTE1X3ZtYSAqdm1hLAorCQkJCSAgIGVudW0gaTkxNV9jYWNoZV9sZXZlbCBjYWNoZV9sZXZl
bCwKKwkJCQkgICB1MzIgZmxhZ3MpCit7CisJc3RydWN0IGk5MTVfcHBndHQgKnBwZ3R0ID0gaTkx
NV92bV90b19wcGd0dCh2bSk7CiAJc3RydWN0IHNndF9kbWEgaXRlciA9IHNndF9kbWEodm1hKTsK
IAlzdHJ1Y3QgZ2VuOF9pbnNlcnRfcHRlIGlkeCA9IGdlbjhfaW5zZXJ0X3B0ZSh2bWEtPm5vZGUu
c3RhcnQpOwogCkBAIC0xMTYwLDE3ICsxNDI4LDYgQEAgc3RhdGljIHZvaWQgZ2VuOF9wcGd0dF9p
bnNlcnRfNGx2bChzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKIAl9CiB9CiAKLXN0YXRp
YyB2b2lkIGdlbjhfZnJlZV9wYWdlX3RhYmxlcyhzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2
bSwKLQkJCQkgIHN0cnVjdCBpOTE1X3BhZ2VfZGlyZWN0b3J5ICpwZCkKLXsKLQlpbnQgaTsKLQot
CWZvciAoaSA9IDA7IGkgPCBJOTE1X1BERVM7IGkrKykgewotCQlpZiAocGQtPmVudHJ5W2ldICE9
ICZ2bS0+c2NyYXRjaF9wdCkKLQkJCWZyZWVfcGQodm0sIHBkLT5lbnRyeVtpXSk7Ci0JfQotfQot
CiBzdGF0aWMgaW50IGdlbjhfaW5pdF9zY3JhdGNoKHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2Ug
KnZtKQogewogCWludCByZXQ7CkBAIC0xMjM3LDI2MiArMTQ5NCw2IEBAIHN0YXRpYyBpbnQgZ2Vu
OF9pbml0X3NjcmF0Y2goc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0pCiAJcmV0dXJuIHJl
dDsKIH0KIAotc3RhdGljIGludCBnZW44X3BwZ3R0X25vdGlmeV92Z3Qoc3RydWN0IGk5MTVfcHBn
dHQgKnBwZ3R0LCBib29sIGNyZWF0ZSkKLXsKLQlzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2
bSA9ICZwcGd0dC0+dm07Ci0Jc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2ID0gdm0t
Pmk5MTU7Ci0JZW51bSB2Z3RfZzJ2X3R5cGUgbXNnOwotCWludCBpOwotCi0JaWYgKGNyZWF0ZSkK
LQkJYXRvbWljX2luYyhweF91c2VkKHBwZ3R0LT5wZCkpOyAvKiBuZXZlciByZW1vdmUgKi8KLQll
bHNlCi0JCWF0b21pY19kZWMocHhfdXNlZChwcGd0dC0+cGQpKTsKLQotCWlmIChpOTE1X3ZtX2lz
XzRsdmwodm0pKSB7Ci0JCWNvbnN0IHU2NCBkYWRkciA9IHB4X2RtYShwcGd0dC0+cGQpOwotCi0J
CUk5MTVfV1JJVEUodmd0aWZfcmVnKHBkcFswXS5sbyksIGxvd2VyXzMyX2JpdHMoZGFkZHIpKTsK
LQkJSTkxNV9XUklURSh2Z3RpZl9yZWcocGRwWzBdLmhpKSwgdXBwZXJfMzJfYml0cyhkYWRkcikp
OwotCi0JCW1zZyA9IChjcmVhdGUgPyBWR1RfRzJWX1BQR1RUX0w0X1BBR0VfVEFCTEVfQ1JFQVRF
IDoKLQkJCQlWR1RfRzJWX1BQR1RUX0w0X1BBR0VfVEFCTEVfREVTVFJPWSk7Ci0JfSBlbHNlIHsK
LQkJZm9yIChpID0gMDsgaSA8IEdFTjhfM0xWTF9QRFBFUzsgaSsrKSB7Ci0JCQljb25zdCB1NjQg
ZGFkZHIgPSBpOTE1X3BhZ2VfZGlyX2RtYV9hZGRyKHBwZ3R0LCBpKTsKLQotCQkJSTkxNV9XUklU
RSh2Z3RpZl9yZWcocGRwW2ldLmxvKSwgbG93ZXJfMzJfYml0cyhkYWRkcikpOwotCQkJSTkxNV9X
UklURSh2Z3RpZl9yZWcocGRwW2ldLmhpKSwgdXBwZXJfMzJfYml0cyhkYWRkcikpOwotCQl9Ci0K
LQkJbXNnID0gKGNyZWF0ZSA/IFZHVF9HMlZfUFBHVFRfTDNfUEFHRV9UQUJMRV9DUkVBVEUgOgot
CQkJCVZHVF9HMlZfUFBHVFRfTDNfUEFHRV9UQUJMRV9ERVNUUk9ZKTsKLQl9Ci0KLQlJOTE1X1dS
SVRFKHZndGlmX3JlZyhnMnZfbm90aWZ5KSwgbXNnKTsKLQotCXJldHVybiAwOwotfQotCi1zdGF0
aWMgdm9pZCBnZW44X3BwZ3R0X2NsZWFudXBfM2x2bChzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNl
ICp2bSwKLQkJCQkgICAgc3RydWN0IGk5MTVfcGFnZV9kaXJlY3RvcnkgKnBkcCkKLXsKLQljb25z
dCB1bnNpZ25lZCBpbnQgcGRwZXMgPSBpOTE1X3BkcGVzX3Blcl9wZHAodm0pOwotCWludCBpOwot
Ci0JZm9yIChpID0gMDsgaSA8IHBkcGVzOyBpKyspIHsKLQkJaWYgKHBkcC0+ZW50cnlbaV0gPT0g
JnZtLT5zY3JhdGNoX3BkKQotCQkJY29udGludWU7Ci0KLQkJZ2VuOF9mcmVlX3BhZ2VfdGFibGVz
KHZtLCBwZHAtPmVudHJ5W2ldKTsKLQkJZnJlZV9wZCh2bSwgcGRwLT5lbnRyeVtpXSk7Ci0JfQot
Ci0JZnJlZV9weCh2bSwgcGRwKTsKLX0KLQotc3RhdGljIHZvaWQgZ2VuOF9wcGd0dF9jbGVhbnVw
XzRsdmwoc3RydWN0IGk5MTVfcHBndHQgKnBwZ3R0KQotewotCXN0cnVjdCBpOTE1X3BhZ2VfZGly
ZWN0b3J5ICogY29uc3QgcG1sNCA9IHBwZ3R0LT5wZDsKLQlpbnQgaTsKLQotCWZvciAoaSA9IDA7
IGkgPCBHRU44X1BNTDRFU19QRVJfUE1MNDsgaSsrKSB7Ci0JCXN0cnVjdCBpOTE1X3BhZ2VfZGly
ZWN0b3J5ICpwZHAgPSBpOTE1X3BkcF9lbnRyeShwbWw0LCBpKTsKLQotCQlpZiAocHhfYmFzZShw
ZHApID09ICZwcGd0dC0+dm0uc2NyYXRjaF9wZHApCi0JCQljb250aW51ZTsKLQotCQlnZW44X3Bw
Z3R0X2NsZWFudXBfM2x2bCgmcHBndHQtPnZtLCBwZHApOwotCX0KLQotCWZyZWVfcHgoJnBwZ3R0
LT52bSwgcG1sNCk7Ci19Ci0KLXN0YXRpYyB2b2lkIGdlbjhfcHBndHRfY2xlYW51cChzdHJ1Y3Qg
aTkxNV9hZGRyZXNzX3NwYWNlICp2bSkKLXsKLQlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkx
NSA9IHZtLT5pOTE1OwotCXN0cnVjdCBpOTE1X3BwZ3R0ICpwcGd0dCA9IGk5MTVfdm1fdG9fcHBn
dHQodm0pOwotCi0JaWYgKGludGVsX3ZncHVfYWN0aXZlKGk5MTUpKQotCQlnZW44X3BwZ3R0X25v
dGlmeV92Z3QocHBndHQsIGZhbHNlKTsKLQotCWlmIChpOTE1X3ZtX2lzXzRsdmwodm0pKQotCQln
ZW44X3BwZ3R0X2NsZWFudXBfNGx2bChwcGd0dCk7Ci0JZWxzZQotCQlnZW44X3BwZ3R0X2NsZWFu
dXBfM2x2bCgmcHBndHQtPnZtLCBwcGd0dC0+cGQpOwotCi0JZnJlZV9zY3JhdGNoKHZtKTsKLX0K
LQotc3RhdGljIGludCBnZW44X3BwZ3R0X2FsbG9jX3BkKHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3Bh
Y2UgKnZtLAotCQkJICAgICAgIHN0cnVjdCBpOTE1X3BhZ2VfZGlyZWN0b3J5ICpwZCwKLQkJCSAg
ICAgICB1NjQgc3RhcnQsIHU2NCBsZW5ndGgpCi17Ci0Jc3RydWN0IGk5MTVfcGFnZV90YWJsZSAq
cHQsICphbGxvYyA9IE5VTEw7Ci0JdTY0IGZyb20gPSBzdGFydDsKLQl1bnNpZ25lZCBpbnQgcGRl
OwotCWludCByZXQgPSAwOwotCi0Jc3Bpbl9sb2NrKCZwZC0+bG9jayk7Ci0JZ2VuOF9mb3JfZWFj
aF9wZGUocHQsIHBkLCBzdGFydCwgbGVuZ3RoLCBwZGUpIHsKLQkJY29uc3QgaW50IGNvdW50ID0g
Z2VuOF9wdGVfY291bnQoc3RhcnQsIGxlbmd0aCk7Ci0KLQkJaWYgKHB4X2Jhc2UocHQpID09ICZ2
bS0+c2NyYXRjaF9wdCkgewotCQkJc3Bpbl91bmxvY2soJnBkLT5sb2NrKTsKLQotCQkJcHQgPSBm
ZXRjaF9hbmRfemVybygmYWxsb2MpOwotCQkJaWYgKCFwdCkKLQkJCQlwdCA9IGFsbG9jX3B0KHZt
KTsKLQkJCWlmIChJU19FUlIocHQpKSB7Ci0JCQkJcmV0ID0gUFRSX0VSUihwdCk7Ci0JCQkJZ290
byB1bndpbmQ7Ci0JCQl9Ci0KLQkJCWlmIChjb3VudCA8IEdFTjhfUFRFUyB8fCBpbnRlbF92Z3B1
X2FjdGl2ZSh2bS0+aTkxNSkpCi0JCQkJZmlsbF9weChwdCwgdm0tPnNjcmF0Y2hfcHRlKTsKLQot
CQkJc3Bpbl9sb2NrKCZwZC0+bG9jayk7Ci0JCQlpZiAocGQtPmVudHJ5W3BkZV0gPT0gJnZtLT5z
Y3JhdGNoX3B0KSB7Ci0JCQkJc2V0X3BkX2VudHJ5KHBkLCBwZGUsIHB0KTsKLQkJCX0gZWxzZSB7
Ci0JCQkJYWxsb2MgPSBwdDsKLQkJCQlwdCA9IHBkLT5lbnRyeVtwZGVdOwotCQkJfQotCQl9Ci0K
LQkJYXRvbWljX2FkZChjb3VudCwgJnB0LT51c2VkKTsKLQl9Ci0Jc3Bpbl91bmxvY2soJnBkLT5s
b2NrKTsKLQlnb3RvIG91dDsKLQotdW53aW5kOgotCWdlbjhfcHBndHRfY2xlYXJfcGQodm0sIHBk
LCBmcm9tLCBzdGFydCAtIGZyb20pOwotb3V0OgotCWlmIChhbGxvYykKLQkJZnJlZV9weCh2bSwg
YWxsb2MpOwotCXJldHVybiByZXQ7Ci19Ci0KLXN0YXRpYyBpbnQgZ2VuOF9wcGd0dF9hbGxvY19w
ZHAoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCi0JCQkJc3RydWN0IGk5MTVfcGFnZV9k
aXJlY3RvcnkgKnBkcCwKLQkJCQl1NjQgc3RhcnQsIHU2NCBsZW5ndGgpCi17Ci0Jc3RydWN0IGk5
MTVfcGFnZV9kaXJlY3RvcnkgKnBkLCAqYWxsb2MgPSBOVUxMOwotCXU2NCBmcm9tID0gc3RhcnQ7
Ci0JdW5zaWduZWQgaW50IHBkcGU7Ci0JaW50IHJldCA9IDA7Ci0KLQlzcGluX2xvY2soJnBkcC0+
bG9jayk7Ci0JZ2VuOF9mb3JfZWFjaF9wZHBlKHBkLCBwZHAsIHN0YXJ0LCBsZW5ndGgsIHBkcGUp
IHsKLQkJaWYgKHB4X2Jhc2UocGQpID09ICZ2bS0+c2NyYXRjaF9wZCkgewotCQkJc3Bpbl91bmxv
Y2soJnBkcC0+bG9jayk7Ci0KLQkJCXBkID0gZmV0Y2hfYW5kX3plcm8oJmFsbG9jKTsKLQkJCWlm
ICghcGQpCi0JCQkJcGQgPSBhbGxvY19wZCh2bSk7Ci0JCQlpZiAoSVNfRVJSKHBkKSkgewotCQkJ
CXJldCA9IFBUUl9FUlIocGQpOwotCQkJCWdvdG8gdW53aW5kOwotCQkJfQotCi0JCQlpbml0X3Bk
KHBkLCAmdm0tPnNjcmF0Y2hfcHQpOwotCi0JCQlzcGluX2xvY2soJnBkcC0+bG9jayk7Ci0JCQlp
ZiAocGRwLT5lbnRyeVtwZHBlXSA9PSAmdm0tPnNjcmF0Y2hfcGQpIHsKLQkJCQlzZXRfcGRfZW50
cnkocGRwLCBwZHBlLCBwZCk7Ci0JCQl9IGVsc2UgewotCQkJCWFsbG9jID0gcGQ7Ci0JCQkJcGQg
PSBwZHAtPmVudHJ5W3BkcGVdOwotCQkJfQotCQl9Ci0JCWF0b21pY19pbmMocHhfdXNlZChwZCkp
OwotCQlzcGluX3VubG9jaygmcGRwLT5sb2NrKTsKLQotCQlyZXQgPSBnZW44X3BwZ3R0X2FsbG9j
X3BkKHZtLCBwZCwgc3RhcnQsIGxlbmd0aCk7Ci0JCWlmICh1bmxpa2VseShyZXQpKQotCQkJZ290
byB1bndpbmRfcGQ7Ci0KLQkJc3Bpbl9sb2NrKCZwZHAtPmxvY2spOwotCQlhdG9taWNfZGVjKHB4
X3VzZWQocGQpKTsKLQl9Ci0Jc3Bpbl91bmxvY2soJnBkcC0+bG9jayk7Ci0JZ290byBvdXQ7Ci0K
LXVud2luZF9wZDoKLQlpZiAocmVsZWFzZV9wZF9lbnRyeShwZHAsIHBkcGUsICZwZC0+cHQsICZ2
bS0+c2NyYXRjaF9wZCkpCi0JCWZyZWVfcHgodm0sIHBkKTsKLXVud2luZDoKLQlnZW44X3BwZ3R0
X2NsZWFyX3BkcCh2bSwgcGRwLCBmcm9tLCBzdGFydCAtIGZyb20pOwotb3V0OgotCWlmIChhbGxv
YykKLQkJZnJlZV9weCh2bSwgYWxsb2MpOwotCXJldHVybiByZXQ7Ci19Ci0KLXN0YXRpYyBpbnQg
Z2VuOF9wcGd0dF9hbGxvY18zbHZsKHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAotCQkJ
CSB1NjQgc3RhcnQsIHU2NCBsZW5ndGgpCi17Ci0JcmV0dXJuIGdlbjhfcHBndHRfYWxsb2NfcGRw
KHZtLAotCQkJCSAgICBpOTE1X3ZtX3RvX3BwZ3R0KHZtKS0+cGQsIHN0YXJ0LCBsZW5ndGgpOwot
fQotCi1zdGF0aWMgaW50IGdlbjhfcHBndHRfYWxsb2NfNGx2bChzdHJ1Y3QgaTkxNV9hZGRyZXNz
X3NwYWNlICp2bSwKLQkJCQkgdTY0IHN0YXJ0LCB1NjQgbGVuZ3RoKQotewotCXN0cnVjdCBpOTE1
X3BwZ3R0ICpwcGd0dCA9IGk5MTVfdm1fdG9fcHBndHQodm0pOwotCXN0cnVjdCBpOTE1X3BhZ2Vf
ZGlyZWN0b3J5ICogY29uc3QgcG1sNCA9IHBwZ3R0LT5wZDsKLQlzdHJ1Y3QgaTkxNV9wYWdlX2Rp
cmVjdG9yeSAqcGRwLCAqYWxsb2MgPSBOVUxMOwotCXU2NCBmcm9tID0gc3RhcnQ7Ci0JaW50IHJl
dCA9IDA7Ci0JdTMyIHBtbDRlOwotCi0Jc3Bpbl9sb2NrKCZwbWw0LT5sb2NrKTsKLQlnZW44X2Zv
cl9lYWNoX3BtbDRlKHBkcCwgcG1sNCwgc3RhcnQsIGxlbmd0aCwgcG1sNGUpIHsKLQkJaWYgKHB4
X2Jhc2UocGRwKSA9PSAmdm0tPnNjcmF0Y2hfcGRwKSB7Ci0JCQlzcGluX3VubG9jaygmcG1sNC0+
bG9jayk7Ci0KLQkJCXBkcCA9IGZldGNoX2FuZF96ZXJvKCZhbGxvYyk7Ci0JCQlpZiAoIXBkcCkK
LQkJCQlwZHAgPSBhbGxvY19wZCh2bSk7Ci0JCQlpZiAoSVNfRVJSKHBkcCkpIHsKLQkJCQlyZXQg
PSBQVFJfRVJSKHBkcCk7Ci0JCQkJZ290byB1bndpbmQ7Ci0JCQl9Ci0KLQkJCWluaXRfcGQocGRw
LCAmdm0tPnNjcmF0Y2hfcGQpOwotCi0JCQlzcGluX2xvY2soJnBtbDQtPmxvY2spOwotCQkJaWYg
KHBtbDQtPmVudHJ5W3BtbDRlXSA9PSAmdm0tPnNjcmF0Y2hfcGRwKSB7Ci0JCQkJc2V0X3BkX2Vu
dHJ5KHBtbDQsIHBtbDRlLCBwZHApOwotCQkJfSBlbHNlIHsKLQkJCQlhbGxvYyA9IHBkcDsKLQkJ
CQlwZHAgPSBwbWw0LT5lbnRyeVtwbWw0ZV07Ci0JCQl9Ci0JCX0KLQkJYXRvbWljX2luYyhweF91
c2VkKHBkcCkpOwotCQlzcGluX3VubG9jaygmcG1sNC0+bG9jayk7Ci0KLQkJcmV0ID0gZ2VuOF9w
cGd0dF9hbGxvY19wZHAodm0sIHBkcCwgc3RhcnQsIGxlbmd0aCk7Ci0JCWlmICh1bmxpa2VseShy
ZXQpKQotCQkJZ290byB1bndpbmRfcGRwOwotCi0JCXNwaW5fbG9jaygmcG1sNC0+bG9jayk7Ci0J
CWF0b21pY19kZWMocHhfdXNlZChwZHApKTsKLQl9Ci0Jc3Bpbl91bmxvY2soJnBtbDQtPmxvY2sp
OwotCWdvdG8gb3V0OwotCi11bndpbmRfcGRwOgotCWlmIChyZWxlYXNlX3BkX2VudHJ5KHBtbDQs
IHBtbDRlLCAmcGRwLT5wdCwgJnZtLT5zY3JhdGNoX3BkcCkpCi0JCWZyZWVfcHgodm0sIHBkcCk7
Ci11bndpbmQ6Ci0JZ2VuOF9wcGd0dF9jbGVhcl80bHZsKHZtLCBmcm9tLCBzdGFydCAtIGZyb20p
Owotb3V0OgotCWlmIChhbGxvYykKLQkJZnJlZV9weCh2bSwgYWxsb2MpOwotCXJldHVybiByZXQ7
Ci19Ci0KIHN0YXRpYyBpbnQgZ2VuOF9wcmVhbGxvY2F0ZV90b3BfbGV2ZWxfcGRwKHN0cnVjdCBp
OTE1X3BwZ3R0ICpwcGd0dCkKIHsKIAlzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSA9ICZw
cGd0dC0+dm07Ci0tIAoyLjIyLjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVk
ZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZv
L2ludGVsLWdmeA==

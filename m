Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id EF9534DCFA
	for <lists+intel-gfx@lfdr.de>; Thu, 20 Jun 2019 23:46:30 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 7FFC66E802;
	Thu, 20 Jun 2019 21:46:26 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mblankhorst.nl (mblankhorst.nl
 [IPv6:2a02:2308::216:3eff:fe92:dfa3])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 6CF086E7F7
 for <intel-gfx@lists.freedesktop.org>; Thu, 20 Jun 2019 21:46:18 +0000 (UTC)
From: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
To: intel-gfx@lists.freedesktop.org
Date: Thu, 20 Jun 2019 23:46:10 +0200
Message-Id: <20190620214613.14481-7-maarten.lankhorst@linux.intel.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190620214613.14481-1-maarten.lankhorst@linux.intel.com>
References: <20190620214613.14481-1-maarten.lankhorst@linux.intel.com>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 6/9] drm/i915: Use intel state as much as
 possible in wm code
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SW5zdGVhZCBvZiBkaXJlY3RseSByZWZlcmVuY2luZyBkcm1fY3J0Y19zdGF0ZSwgY29udmVydCB0
bwppbnRlbF9jdGNfc3RhdGUgYW5kIHVzZSB0aGUgYmFzZSBzdHJ1Y3QuIFRoaXMgaXMgdXNlZnVs
IHdoZW4gd2UncmUKbWFraW5nIHRoZSBzcGxpdCBiZXR3ZWVuIHVhcGkgYW5kIGh3IHN0YXRlLCBh
bmQgYWxzbyBtYWtlcyB0aGUKY29kZSBzbGlnaHRseSBtb3JlIHJlYWRhYmxlLgoKU2lnbmVkLW9m
Zi1ieTogTWFhcnRlbiBMYW5raG9yc3QgPG1hYXJ0ZW4ubGFua2hvcnN0QGxpbnV4LmludGVsLmNv
bT4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pbnRlbF9wbS5jIHwgMTEyICsrKysrKysrKysr
KysrLS0tLS0tLS0tLS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgNTAgaW5zZXJ0aW9ucygrKSwg
NjIgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50ZWxf
cG0uYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2ludGVsX3BtLmMKaW5kZXggNDExNmRlMmE3N2Zk
Li5hZmEwNjlmMGRjNzAgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2ludGVsX3Bt
LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfcG0uYwpAQCAtMzg1Nyw4ICszODU3
LDggQEAgc2tsX2RkYl9nZXRfcGlwZV9hbGxvY2F0aW9uX2xpbWl0cyhzdHJ1Y3QgZHJtX2k5MTVf
cHJpdmF0ZSAqZGV2X3ByaXYsCiAJc3RydWN0IGRybV9hdG9taWNfc3RhdGUgKnN0YXRlID0gY3N0
YXRlLT5iYXNlLnN0YXRlOwogCXN0cnVjdCBpbnRlbF9hdG9taWNfc3RhdGUgKmludGVsX3N0YXRl
ID0gdG9faW50ZWxfYXRvbWljX3N0YXRlKHN0YXRlKTsKIAlzdHJ1Y3QgZHJtX2NydGMgKmZvcl9j
cnRjID0gY3N0YXRlLT5iYXNlLmNydGM7Ci0JY29uc3Qgc3RydWN0IGRybV9jcnRjX3N0YXRlICpj
cnRjX3N0YXRlOwotCWNvbnN0IHN0cnVjdCBkcm1fY3J0YyAqY3J0YzsKKwljb25zdCBzdHJ1Y3Qg
aW50ZWxfY3J0Y19zdGF0ZSAqY3J0Y19zdGF0ZTsKKwljb25zdCBzdHJ1Y3QgaW50ZWxfY3J0YyAq
Y3J0YzsKIAl1MzIgcGlwZV93aWR0aCA9IDAsIHRvdGFsX3dpZHRoID0gMCwgd2lkdGhfYmVmb3Jl
X3BpcGUgPSAwOwogCWVudW0gcGlwZSBmb3JfcGlwZSA9IHRvX2ludGVsX2NydGMoZm9yX2NydGMp
LT5waXBlOwogCXUxNiBkZGJfc2l6ZTsKQEAgLTM5MDEsMTYgKzM5MDEsMTYgQEAgc2tsX2RkYl9n
ZXRfcGlwZV9hbGxvY2F0aW9uX2xpbWl0cyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3By
aXYsCiAJICogZnJhbWVidWZmZXIsIFNvIGluc3RlYWQgb2YgYWxsb2NhdGluZyBEREIgZXF1YWxs
eSBhbW9uZyBwaXBlcwogCSAqIGRpc3RyaWJ1dGUgRERCIGJhc2VkIG9uIHJlc29sdXRpb24vd2lk
dGggb2YgdGhlIGRpc3BsYXkuCiAJICovCi0JZm9yX2VhY2hfbmV3X2NydGNfaW5fc3RhdGUoc3Rh
dGUsIGNydGMsIGNydGNfc3RhdGUsIGkpIHsKKwlmb3JfZWFjaF9uZXdfaW50ZWxfY3J0Y19pbl9z
dGF0ZShpbnRlbF9zdGF0ZSwgY3J0YywgY3J0Y19zdGF0ZSwgaSkgewogCQljb25zdCBzdHJ1Y3Qg
ZHJtX2Rpc3BsYXlfbW9kZSAqYWRqdXN0ZWRfbW9kZTsKIAkJaW50IGhkaXNwbGF5LCB2ZGlzcGxh
eTsKIAkJZW51bSBwaXBlIHBpcGU7CiAKLQkJaWYgKCFjcnRjX3N0YXRlLT5lbmFibGUpCisJCWlm
ICghY3J0Y19zdGF0ZS0+YmFzZS5lbmFibGUpCiAJCQljb250aW51ZTsKIAotCQlwaXBlID0gdG9f
aW50ZWxfY3J0YyhjcnRjKS0+cGlwZTsKLQkJYWRqdXN0ZWRfbW9kZSA9ICZjcnRjX3N0YXRlLT5h
ZGp1c3RlZF9tb2RlOworCQlwaXBlID0gY3J0Yy0+cGlwZTsKKwkJYWRqdXN0ZWRfbW9kZSA9ICZj
cnRjX3N0YXRlLT5iYXNlLmFkanVzdGVkX21vZGU7CiAJCWRybV9tb2RlX2dldF9odl90aW1pbmco
YWRqdXN0ZWRfbW9kZSwgJmhkaXNwbGF5LCAmdmRpc3BsYXkpOwogCQl0b3RhbF93aWR0aCArPSBo
ZGlzcGxheTsKIApAQCAtNDEzOSwxMSArNDEzOSw5IEBAIGludCBza2xfY2hlY2tfcGlwZV9tYXhf
cGl4ZWxfcmF0ZShzdHJ1Y3QgaW50ZWxfY3J0YyAqaW50ZWxfY3J0YywKIAkJCQkgIHN0cnVjdCBp
bnRlbF9jcnRjX3N0YXRlICpjc3RhdGUpCiB7CiAJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRl
dl9wcml2ID0gdG9faTkxNShpbnRlbF9jcnRjLT5iYXNlLmRldik7Ci0Jc3RydWN0IGRybV9jcnRj
X3N0YXRlICpjcnRjX3N0YXRlID0gJmNzdGF0ZS0+YmFzZTsKLQlzdHJ1Y3QgZHJtX2F0b21pY19z
dGF0ZSAqc3RhdGUgPSBjcnRjX3N0YXRlLT5zdGF0ZTsKKwlzdHJ1Y3QgZHJtX2F0b21pY19zdGF0
ZSAqc3RhdGUgPSBjc3RhdGUtPmJhc2Uuc3RhdGU7CiAJc3RydWN0IGRybV9wbGFuZSAqcGxhbmU7
Ci0JY29uc3Qgc3RydWN0IGRybV9wbGFuZV9zdGF0ZSAqcHN0YXRlOwotCXN0cnVjdCBpbnRlbF9w
bGFuZV9zdGF0ZSAqaW50ZWxfcHN0YXRlOworCWNvbnN0IHN0cnVjdCBkcm1fcGxhbmVfc3RhdGUg
KmRybV9wc3RhdGU7CiAJaW50IGNydGNfY2xvY2ssIGRvdGNsazsKIAl1MzIgcGlwZV9tYXhfcGl4
ZWxfcmF0ZTsKIAl1aW50X2ZpeGVkXzE2XzE2X3QgcGlwZV9kb3duc2NhbGU7CkBAIC00MTUyLDIy
ICs0MTUwLDIxIEBAIGludCBza2xfY2hlY2tfcGlwZV9tYXhfcGl4ZWxfcmF0ZShzdHJ1Y3QgaW50
ZWxfY3J0YyAqaW50ZWxfY3J0YywKIAlpZiAoIWNzdGF0ZS0+YmFzZS5lbmFibGUpCiAJCXJldHVy
biAwOwogCi0JZHJtX2F0b21pY19jcnRjX3N0YXRlX2Zvcl9lYWNoX3BsYW5lX3N0YXRlKHBsYW5l
LCBwc3RhdGUsIGNydGNfc3RhdGUpIHsKKwlkcm1fYXRvbWljX2NydGNfc3RhdGVfZm9yX2VhY2hf
cGxhbmVfc3RhdGUocGxhbmUsIGRybV9wc3RhdGUsICZjc3RhdGUtPmJhc2UpIHsKIAkJdWludF9m
aXhlZF8xNl8xNl90IHBsYW5lX2Rvd25zY2FsZTsKIAkJdWludF9maXhlZF8xNl8xNl90IGZwXzlf
ZGl2XzggPSBkaXZfZml4ZWQxNig5LCA4KTsKIAkJaW50IGJwcDsKKwkJY29uc3Qgc3RydWN0IGlu
dGVsX3BsYW5lX3N0YXRlICpwc3RhdGUgPQorCQkJdG9faW50ZWxfcGxhbmVfc3RhdGUoZHJtX3Bz
dGF0ZSk7CiAKLQkJaWYgKCFpbnRlbF93bV9wbGFuZV92aXNpYmxlKGNzdGF0ZSwKLQkJCQkJICAg
IHRvX2ludGVsX3BsYW5lX3N0YXRlKHBzdGF0ZSkpKQorCQlpZiAoIWludGVsX3dtX3BsYW5lX3Zp
c2libGUoY3N0YXRlLCBwc3RhdGUpKQogCQkJY29udGludWU7CiAKLQkJaWYgKFdBUk5fT04oIXBz
dGF0ZS0+ZmIpKQorCQlpZiAoV0FSTl9PTighcHN0YXRlLT5iYXNlLmZiKSkKIAkJCXJldHVybiAt
RUlOVkFMOwogCi0JCWludGVsX3BzdGF0ZSA9IHRvX2ludGVsX3BsYW5lX3N0YXRlKHBzdGF0ZSk7
Ci0JCXBsYW5lX2Rvd25zY2FsZSA9IHNrbF9wbGFuZV9kb3duc2NhbGVfYW1vdW50KGNzdGF0ZSwK
LQkJCQkJCQkgICAgIGludGVsX3BzdGF0ZSk7Ci0JCWJwcCA9IHBzdGF0ZS0+ZmItPmZvcm1hdC0+
Y3BwWzBdICogODsKKwkJcGxhbmVfZG93bnNjYWxlID0gc2tsX3BsYW5lX2Rvd25zY2FsZV9hbW91
bnQoY3N0YXRlLCBwc3RhdGUpOworCQlicHAgPSBwc3RhdGUtPmJhc2UuZmItPmZvcm1hdC0+Y3Bw
WzBdICogODsKIAkJaWYgKGJwcCA9PSA2NCkKIAkJCXBsYW5lX2Rvd25zY2FsZSA9IG11bF9maXhl
ZDE2KHBsYW5lX2Rvd25zY2FsZSwKIAkJCQkJCSAgICAgIGZwXzlfZGl2XzgpOwpAQCAtNDE3OCw3
ICs0MTc1LDcgQEAgaW50IHNrbF9jaGVja19waXBlX21heF9waXhlbF9yYXRlKHN0cnVjdCBpbnRl
bF9jcnRjICppbnRlbF9jcnRjLAogCiAJcGlwZV9kb3duc2NhbGUgPSBtdWxfZml4ZWQxNihwaXBl
X2Rvd25zY2FsZSwgbWF4X2Rvd25zY2FsZSk7CiAKLQljcnRjX2Nsb2NrID0gY3J0Y19zdGF0ZS0+
YWRqdXN0ZWRfbW9kZS5jcnRjX2Nsb2NrOworCWNydGNfY2xvY2sgPSBjc3RhdGUtPmJhc2UuYWRq
dXN0ZWRfbW9kZS5jcnRjX2Nsb2NrOwogCWRvdGNsayA9IHRvX2ludGVsX2F0b21pY19zdGF0ZShz
dGF0ZSktPmNkY2xrLmxvZ2ljYWwuY2RjbGs7CiAKIAlpZiAoSVNfR0VNSU5JTEFLRShkZXZfcHJp
dikgfHwgSU5URUxfR0VOKGRldl9wcml2KSA+PSAxMCkKQEAgLTQxOTYsMTEgKzQxOTMsMTAgQEAg
aW50IHNrbF9jaGVja19waXBlX21heF9waXhlbF9yYXRlKHN0cnVjdCBpbnRlbF9jcnRjICppbnRl
bF9jcnRjLAogCiBzdGF0aWMgdTY0CiBza2xfcGxhbmVfcmVsYXRpdmVfZGF0YV9yYXRlKGNvbnN0
IHN0cnVjdCBpbnRlbF9jcnRjX3N0YXRlICpjc3RhdGUsCi0JCQkgICAgIGNvbnN0IHN0cnVjdCBp
bnRlbF9wbGFuZV9zdGF0ZSAqaW50ZWxfcHN0YXRlLAorCQkJICAgICBjb25zdCBzdHJ1Y3QgaW50
ZWxfcGxhbmVfc3RhdGUgKnBzdGF0ZSwKIAkJCSAgICAgY29uc3QgaW50IHBsYW5lKQogewotCXN0
cnVjdCBpbnRlbF9wbGFuZSAqaW50ZWxfcGxhbmUgPQotCQl0b19pbnRlbF9wbGFuZShpbnRlbF9w
c3RhdGUtPmJhc2UucGxhbmUpOworCXN0cnVjdCBpbnRlbF9wbGFuZSAqaW50ZWxfcGxhbmUgPSB0
b19pbnRlbF9wbGFuZShwc3RhdGUtPmJhc2UucGxhbmUpOwogCXUzMiBkYXRhX3JhdGU7CiAJdTMy
IHdpZHRoID0gMCwgaGVpZ2h0ID0gMDsKIAlzdHJ1Y3QgZHJtX2ZyYW1lYnVmZmVyICpmYjsKQEAg
LTQyMDgsMTAgKzQyMDQsMTAgQEAgc2tsX3BsYW5lX3JlbGF0aXZlX2RhdGFfcmF0ZShjb25zdCBz
dHJ1Y3QgaW50ZWxfY3J0Y19zdGF0ZSAqY3N0YXRlLAogCXVpbnRfZml4ZWRfMTZfMTZfdCBkb3du
X3NjYWxlX2Ftb3VudDsKIAl1NjQgcmF0ZTsKIAotCWlmICghaW50ZWxfcHN0YXRlLT5iYXNlLnZp
c2libGUpCisJaWYgKCFwc3RhdGUtPmJhc2UudmlzaWJsZSkKIAkJcmV0dXJuIDA7CiAKLQlmYiA9
IGludGVsX3BzdGF0ZS0+YmFzZS5mYjsKKwlmYiA9IHBzdGF0ZS0+YmFzZS5mYjsKIAlmb3JtYXQg
PSBmYi0+Zm9ybWF0LT5mb3JtYXQ7CiAKIAlpZiAoaW50ZWxfcGxhbmUtPmlkID09IFBMQU5FX0NV
UlNPUikKQEAgLTQyMjQsOCArNDIyMCw4IEBAIHNrbF9wbGFuZV9yZWxhdGl2ZV9kYXRhX3JhdGUo
Y29uc3Qgc3RydWN0IGludGVsX2NydGNfc3RhdGUgKmNzdGF0ZSwKIAkgKiB0aGUgOTAvMjcwIGRl
Z3JlZSBwbGFuZSByb3RhdGlvbiBjYXNlcyAodG8gbWF0Y2ggdGhlCiAJICogR1RUIG1hcHBpbmcp
LCBoZW5jZSBubyBuZWVkIHRvIGFjY291bnQgZm9yIHJvdGF0aW9uIGhlcmUuCiAJICovCi0Jd2lk
dGggPSBkcm1fcmVjdF93aWR0aCgmaW50ZWxfcHN0YXRlLT5iYXNlLnNyYykgPj4gMTY7Ci0JaGVp
Z2h0ID0gZHJtX3JlY3RfaGVpZ2h0KCZpbnRlbF9wc3RhdGUtPmJhc2Uuc3JjKSA+PiAxNjsKKwl3
aWR0aCA9IGRybV9yZWN0X3dpZHRoKCZwc3RhdGUtPmJhc2Uuc3JjKSA+PiAxNjsKKwloZWlnaHQg
PSBkcm1fcmVjdF9oZWlnaHQoJnBzdGF0ZS0+YmFzZS5zcmMpID4+IDE2OwogCiAJLyogVVYgcGxh
bmUgZG9lcyAxLzIgcGl4ZWwgc3ViLXNhbXBsaW5nICovCiAJaWYgKHBsYW5lID09IDEgJiYgaXNf
cGxhbmFyX3l1dl9mb3JtYXQoZm9ybWF0KSkgewpAQCAtNDIzNSw3ICs0MjMxLDcgQEAgc2tsX3Bs
YW5lX3JlbGF0aXZlX2RhdGFfcmF0ZShjb25zdCBzdHJ1Y3QgaW50ZWxfY3J0Y19zdGF0ZSAqY3N0
YXRlLAogCiAJZGF0YV9yYXRlID0gd2lkdGggKiBoZWlnaHQ7CiAKLQlkb3duX3NjYWxlX2Ftb3Vu
dCA9IHNrbF9wbGFuZV9kb3duc2NhbGVfYW1vdW50KGNzdGF0ZSwgaW50ZWxfcHN0YXRlKTsKKwlk
b3duX3NjYWxlX2Ftb3VudCA9IHNrbF9wbGFuZV9kb3duc2NhbGVfYW1vdW50KGNzdGF0ZSwgcHN0
YXRlKTsKIAogCXJhdGUgPSBtdWxfcm91bmRfdXBfdTMyX2ZpeGVkMTYoZGF0YV9yYXRlLCBkb3du
X3NjYWxlX2Ftb3VudCk7CiAKQEAgLTQyNDQsMzUgKzQyNDAsMzIgQEAgc2tsX3BsYW5lX3JlbGF0
aXZlX2RhdGFfcmF0ZShjb25zdCBzdHJ1Y3QgaW50ZWxfY3J0Y19zdGF0ZSAqY3N0YXRlLAogfQog
CiBzdGF0aWMgdTY0Ci1za2xfZ2V0X3RvdGFsX3JlbGF0aXZlX2RhdGFfcmF0ZShzdHJ1Y3QgaW50
ZWxfY3J0Y19zdGF0ZSAqaW50ZWxfY3N0YXRlLAorc2tsX2dldF90b3RhbF9yZWxhdGl2ZV9kYXRh
X3JhdGUoc3RydWN0IGludGVsX2NydGNfc3RhdGUgKmNzdGF0ZSwKIAkJCQkgdTY0ICpwbGFuZV9k
YXRhX3JhdGUsCiAJCQkJIHU2NCAqdXZfcGxhbmVfZGF0YV9yYXRlKQogewotCXN0cnVjdCBkcm1f
Y3J0Y19zdGF0ZSAqY3N0YXRlID0gJmludGVsX2NzdGF0ZS0+YmFzZTsKLQlzdHJ1Y3QgZHJtX2F0
b21pY19zdGF0ZSAqc3RhdGUgPSBjc3RhdGUtPnN0YXRlOworCXN0cnVjdCBkcm1fYXRvbWljX3N0
YXRlICpzdGF0ZSA9IGNzdGF0ZS0+YmFzZS5zdGF0ZTsKIAlzdHJ1Y3QgZHJtX3BsYW5lICpwbGFu
ZTsKLQljb25zdCBzdHJ1Y3QgZHJtX3BsYW5lX3N0YXRlICpwc3RhdGU7CisJY29uc3Qgc3RydWN0
IGRybV9wbGFuZV9zdGF0ZSAqZHJtX3BzdGF0ZTsKIAl1NjQgdG90YWxfZGF0YV9yYXRlID0gMDsK
IAogCWlmIChXQVJOX09OKCFzdGF0ZSkpCiAJCXJldHVybiAwOwogCiAJLyogQ2FsY3VsYXRlIGFu
ZCBjYWNoZSBkYXRhIHJhdGUgZm9yIGVhY2ggcGxhbmUgKi8KLQlkcm1fYXRvbWljX2NydGNfc3Rh
dGVfZm9yX2VhY2hfcGxhbmVfc3RhdGUocGxhbmUsIHBzdGF0ZSwgY3N0YXRlKSB7CisJZHJtX2F0
b21pY19jcnRjX3N0YXRlX2Zvcl9lYWNoX3BsYW5lX3N0YXRlKHBsYW5lLCBkcm1fcHN0YXRlLCAm
Y3N0YXRlLT5iYXNlKSB7CiAJCWVudW0gcGxhbmVfaWQgcGxhbmVfaWQgPSB0b19pbnRlbF9wbGFu
ZShwbGFuZSktPmlkOworCQljb25zdCBzdHJ1Y3QgaW50ZWxfcGxhbmVfc3RhdGUgKnBzdGF0ZSA9
CisJCQl0b19pbnRlbF9wbGFuZV9zdGF0ZShkcm1fcHN0YXRlKTsKIAkJdTY0IHJhdGU7Ci0JCWNv
bnN0IHN0cnVjdCBpbnRlbF9wbGFuZV9zdGF0ZSAqaW50ZWxfcHN0YXRlID0KLQkJCXRvX2ludGVs
X3BsYW5lX3N0YXRlKHBzdGF0ZSk7CiAKIAkJLyogcGFja2VkL3kgKi8KLQkJcmF0ZSA9IHNrbF9w
bGFuZV9yZWxhdGl2ZV9kYXRhX3JhdGUoaW50ZWxfY3N0YXRlLAotCQkJCQkJICAgIGludGVsX3Bz
dGF0ZSwgMCk7CisJCXJhdGUgPSBza2xfcGxhbmVfcmVsYXRpdmVfZGF0YV9yYXRlKGNzdGF0ZSwg
cHN0YXRlLCAwKTsKIAkJcGxhbmVfZGF0YV9yYXRlW3BsYW5lX2lkXSA9IHJhdGU7CiAJCXRvdGFs
X2RhdGFfcmF0ZSArPSByYXRlOwogCiAJCS8qIHV2LXBsYW5lICovCi0JCXJhdGUgPSBza2xfcGxh
bmVfcmVsYXRpdmVfZGF0YV9yYXRlKGludGVsX2NzdGF0ZSwKLQkJCQkJCSAgICBpbnRlbF9wc3Rh
dGUsIDEpOworCQlyYXRlID0gc2tsX3BsYW5lX3JlbGF0aXZlX2RhdGFfcmF0ZShjc3RhdGUsIHBz
dGF0ZSwgMSk7CiAJCXV2X3BsYW5lX2RhdGFfcmF0ZVtwbGFuZV9pZF0gPSByYXRlOwogCQl0b3Rh
bF9kYXRhX3JhdGUgKz0gcmF0ZTsKIAl9CkBAIC00MjgxLDI4ICs0Mjc0LDI1IEBAIHNrbF9nZXRf
dG90YWxfcmVsYXRpdmVfZGF0YV9yYXRlKHN0cnVjdCBpbnRlbF9jcnRjX3N0YXRlICppbnRlbF9j
c3RhdGUsCiB9CiAKIHN0YXRpYyB1NjQKLWljbF9nZXRfdG90YWxfcmVsYXRpdmVfZGF0YV9yYXRl
KHN0cnVjdCBpbnRlbF9jcnRjX3N0YXRlICppbnRlbF9jc3RhdGUsCitpY2xfZ2V0X3RvdGFsX3Jl
bGF0aXZlX2RhdGFfcmF0ZShzdHJ1Y3QgaW50ZWxfY3J0Y19zdGF0ZSAqY3N0YXRlLAogCQkJCSB1
NjQgKnBsYW5lX2RhdGFfcmF0ZSkKIHsKLQlzdHJ1Y3QgZHJtX2NydGNfc3RhdGUgKmNzdGF0ZSA9
ICZpbnRlbF9jc3RhdGUtPmJhc2U7Ci0Jc3RydWN0IGRybV9hdG9taWNfc3RhdGUgKnN0YXRlID0g
Y3N0YXRlLT5zdGF0ZTsKIAlzdHJ1Y3QgZHJtX3BsYW5lICpwbGFuZTsKLQljb25zdCBzdHJ1Y3Qg
ZHJtX3BsYW5lX3N0YXRlICpwc3RhdGU7CisJY29uc3Qgc3RydWN0IGRybV9wbGFuZV9zdGF0ZSAq
ZHJtX3BzdGF0ZTsKIAl1NjQgdG90YWxfZGF0YV9yYXRlID0gMDsKIAotCWlmIChXQVJOX09OKCFz
dGF0ZSkpCisJaWYgKFdBUk5fT04oIWNzdGF0ZS0+YmFzZS5zdGF0ZSkpCiAJCXJldHVybiAwOwog
CiAJLyogQ2FsY3VsYXRlIGFuZCBjYWNoZSBkYXRhIHJhdGUgZm9yIGVhY2ggcGxhbmUgKi8KLQlk
cm1fYXRvbWljX2NydGNfc3RhdGVfZm9yX2VhY2hfcGxhbmVfc3RhdGUocGxhbmUsIHBzdGF0ZSwg
Y3N0YXRlKSB7Ci0JCWNvbnN0IHN0cnVjdCBpbnRlbF9wbGFuZV9zdGF0ZSAqaW50ZWxfcHN0YXRl
ID0KLQkJCXRvX2ludGVsX3BsYW5lX3N0YXRlKHBzdGF0ZSk7CisJZHJtX2F0b21pY19jcnRjX3N0
YXRlX2Zvcl9lYWNoX3BsYW5lX3N0YXRlKHBsYW5lLCBkcm1fcHN0YXRlLCAmY3N0YXRlLT5iYXNl
KSB7CisJCWNvbnN0IHN0cnVjdCBpbnRlbF9wbGFuZV9zdGF0ZSAqcHN0YXRlID0KKwkJCXRvX2lu
dGVsX3BsYW5lX3N0YXRlKGRybV9wc3RhdGUpOwogCQllbnVtIHBsYW5lX2lkIHBsYW5lX2lkID0g
dG9faW50ZWxfcGxhbmUocGxhbmUpLT5pZDsKIAkJdTY0IHJhdGU7CiAKLQkJaWYgKCFpbnRlbF9w
c3RhdGUtPmxpbmtlZF9wbGFuZSkgewotCQkJcmF0ZSA9IHNrbF9wbGFuZV9yZWxhdGl2ZV9kYXRh
X3JhdGUoaW50ZWxfY3N0YXRlLAotCQkJCQkJCSAgICBpbnRlbF9wc3RhdGUsIDApOworCQlpZiAo
IXBzdGF0ZS0+bGlua2VkX3BsYW5lKSB7CisJCQlyYXRlID0gc2tsX3BsYW5lX3JlbGF0aXZlX2Rh
dGFfcmF0ZShjc3RhdGUsIHBzdGF0ZSwgMCk7CiAJCQlwbGFuZV9kYXRhX3JhdGVbcGxhbmVfaWRd
ID0gcmF0ZTsKIAkJCXRvdGFsX2RhdGFfcmF0ZSArPSByYXRlOwogCQl9IGVsc2UgewpAQCAtNDMx
NSwxOCArNDMwNSwxNiBAQCBpY2xfZ2V0X3RvdGFsX3JlbGF0aXZlX2RhdGFfcmF0ZShzdHJ1Y3Qg
aW50ZWxfY3J0Y19zdGF0ZSAqaW50ZWxfY3N0YXRlLAogCQkJICogTlVMTCBpZiB3ZSB0cnkgZ2V0
X25ld19wbGFuZV9zdGF0ZSgpLCBzbyB3ZQogCQkJICogYWx3YXlzIGNhbGN1bGF0ZSBmcm9tIHRo
ZSBtYXN0ZXIuCiAJCQkgKi8KLQkJCWlmIChpbnRlbF9wc3RhdGUtPnNsYXZlKQorCQkJaWYgKHBz
dGF0ZS0+c2xhdmUpCiAJCQkJY29udGludWU7CiAKIAkJCS8qIFkgcGxhbmUgcmF0ZSBpcyBjYWxj
dWxhdGVkIG9uIHRoZSBzbGF2ZSAqLwotCQkJcmF0ZSA9IHNrbF9wbGFuZV9yZWxhdGl2ZV9kYXRh
X3JhdGUoaW50ZWxfY3N0YXRlLAotCQkJCQkJCSAgICBpbnRlbF9wc3RhdGUsIDApOwotCQkJeV9w
bGFuZV9pZCA9IGludGVsX3BzdGF0ZS0+bGlua2VkX3BsYW5lLT5pZDsKKwkJCXJhdGUgPSBza2xf
cGxhbmVfcmVsYXRpdmVfZGF0YV9yYXRlKGNzdGF0ZSwgcHN0YXRlLCAwKTsKKwkJCXlfcGxhbmVf
aWQgPSBwc3RhdGUtPmxpbmtlZF9wbGFuZS0+aWQ7CiAJCQlwbGFuZV9kYXRhX3JhdGVbeV9wbGFu
ZV9pZF0gPSByYXRlOwogCQkJdG90YWxfZGF0YV9yYXRlICs9IHJhdGU7CiAKLQkJCXJhdGUgPSBz
a2xfcGxhbmVfcmVsYXRpdmVfZGF0YV9yYXRlKGludGVsX2NzdGF0ZSwKLQkJCQkJCQkgICAgaW50
ZWxfcHN0YXRlLCAxKTsKKwkJCXJhdGUgPSBza2xfcGxhbmVfcmVsYXRpdmVfZGF0YV9yYXRlKGNz
dGF0ZSwgcHN0YXRlLCAxKTsKIAkJCXBsYW5lX2RhdGFfcmF0ZVtwbGFuZV9pZF0gPSByYXRlOwog
CQkJdG90YWxfZGF0YV9yYXRlICs9IHJhdGU7CiAJCX0KQEAgLTUwOTUsOSArNTA4Myw4IEBAIHN0
YXRpYyBpbnQgc2tsX2J1aWxkX3BpcGVfd20oc3RydWN0IGludGVsX2NydGNfc3RhdGUgKmNzdGF0
ZSkKIHsKIAlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYgPSB0b19pOTE1KGNzdGF0
ZS0+YmFzZS5jcnRjLT5kZXYpOwogCXN0cnVjdCBza2xfcGlwZV93bSAqcGlwZV93bSA9ICZjc3Rh
dGUtPndtLnNrbC5vcHRpbWFsOwotCXN0cnVjdCBkcm1fY3J0Y19zdGF0ZSAqY3J0Y19zdGF0ZSA9
ICZjc3RhdGUtPmJhc2U7CiAJc3RydWN0IGRybV9wbGFuZSAqcGxhbmU7Ci0JY29uc3Qgc3RydWN0
IGRybV9wbGFuZV9zdGF0ZSAqcHN0YXRlOworCWNvbnN0IHN0cnVjdCBkcm1fcGxhbmVfc3RhdGUg
KmRybV9wc3RhdGU7CiAJaW50IHJldDsKIAogCS8qCkBAIC01MTA2LDE0ICs1MDkzLDE1IEBAIHN0
YXRpYyBpbnQgc2tsX2J1aWxkX3BpcGVfd20oc3RydWN0IGludGVsX2NydGNfc3RhdGUgKmNzdGF0
ZSkKIAkgKi8KIAltZW1zZXQocGlwZV93bS0+cGxhbmVzLCAwLCBzaXplb2YocGlwZV93bS0+cGxh
bmVzKSk7CiAKLQlkcm1fYXRvbWljX2NydGNfc3RhdGVfZm9yX2VhY2hfcGxhbmVfc3RhdGUocGxh
bmUsIHBzdGF0ZSwgY3J0Y19zdGF0ZSkgewotCQljb25zdCBzdHJ1Y3QgaW50ZWxfcGxhbmVfc3Rh
dGUgKmludGVsX3BzdGF0ZSA9Ci0JCQkJCQl0b19pbnRlbF9wbGFuZV9zdGF0ZShwc3RhdGUpOwor
CWRybV9hdG9taWNfY3J0Y19zdGF0ZV9mb3JfZWFjaF9wbGFuZV9zdGF0ZShwbGFuZSwgZHJtX3Bz
dGF0ZSwKKwkJCQkJCSAgICZjc3RhdGUtPmJhc2UpIHsKKwkJY29uc3Qgc3RydWN0IGludGVsX3Bs
YW5lX3N0YXRlICpwc3RhdGUgPQorCQkJdG9faW50ZWxfcGxhbmVfc3RhdGUoZHJtX3BzdGF0ZSk7
CiAKIAkJaWYgKElOVEVMX0dFTihkZXZfcHJpdikgPj0gMTEpCi0JCQlyZXQgPSBpY2xfYnVpbGRf
cGxhbmVfd20oY3N0YXRlLCBpbnRlbF9wc3RhdGUpOworCQkJcmV0ID0gaWNsX2J1aWxkX3BsYW5l
X3dtKGNzdGF0ZSwgcHN0YXRlKTsKIAkJZWxzZQotCQkJcmV0ID0gc2tsX2J1aWxkX3BsYW5lX3dt
KGNzdGF0ZSwgaW50ZWxfcHN0YXRlKTsKKwkJCXJldCA9IHNrbF9idWlsZF9wbGFuZV93bShjc3Rh
dGUsIHBzdGF0ZSk7CiAJCWlmIChyZXQpCiAJCQlyZXR1cm4gcmV0OwogCX0KLS0gCjIuMjAuMQoK
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4
IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlz
dHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

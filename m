Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id C165624A15E
	for <lists+intel-gfx@lfdr.de>; Wed, 19 Aug 2020 16:09:37 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id A9E756E431;
	Wed, 19 Aug 2020 14:09:18 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mblankhorst.nl (mblankhorst.nl [141.105.120.124])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 698FA6E3F7
 for <intel-gfx@lists.freedesktop.org>; Wed, 19 Aug 2020 14:09:13 +0000 (UTC)
From: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
To: intel-gfx@lists.freedesktop.org
Date: Wed, 19 Aug 2020 16:08:55 +0200
Message-Id: <20200819140904.1708856-16-maarten.lankhorst@linux.intel.com>
X-Mailer: git-send-email 2.28.0
In-Reply-To: <20200819140904.1708856-1-maarten.lankhorst@linux.intel.com>
References: <20200819140904.1708856-1-maarten.lankhorst@linux.intel.com>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v2 15/24] drm/i915: Convert
 i915_gem_object/client_blt.c to use ww locking as well, v2.
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: =?UTF-8?q?Thomas=20Hellstr=C3=B6m?= <thomas.hellstrom@intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

VGhpcyBpcyB0aGUgbGFzdCBwYXJ0IG91dHNpZGUgb2Ygc2VsZnRlc3RzIHRoYXQgc3RpbGwgZG9u
J3QgdXNlIHRoZQpjb3JyZWN0IGxvY2sgb3JkZXJpbmcgb2YgdGltZWxpbmUtPm11dGV4IHZzIHJl
c3ZfbG9jay4KCldpdGggZ2VtIGZpeGVkLCB0aGVyZSBhcmUgYSBmZXcgcGxhY2VzIHRoYXQgc3Rp
bGwgZ2V0IGxvY2tpbmcgd3Jvbmc6Ci0gZ3Z0L3NjaGVkdWxlci5jCi0gaTkxNV9wZXJmLmMKLSBN
b3N0IGlmIG5vdCBhbGwgc2VsZnRlc3RzLgoKQ2hhbmdlcyBzaW5jZSB2MToKLSBBZGQgaW50ZWxf
ZW5naW5lX3BtX2dldC9wdXQoKSBjYWxscyB0byBmaXggdXNlLWFmdGVyLWZyZWUgd2hlbiB1c2lu
ZwogIGludGVsX2VuZ2luZV9nZXRfcG9vbCgpLgoKU2lnbmVkLW9mZi1ieTogTWFhcnRlbiBMYW5r
aG9yc3QgPG1hYXJ0ZW4ubGFua2hvcnN0QGxpbnV4LmludGVsLmNvbT4KUmV2aWV3ZWQtYnk6IFRo
b21hcyBIZWxsc3Ryw7ZtIDx0aG9tYXMuaGVsbHN0cm9tQGludGVsLmNvbT4KLS0tCiAuLi4vZ3B1
L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jbGllbnRfYmx0LmMgICAgfCAgNzggKysrKysrKy0tCiAu
Li4vZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9vYmplY3RfYmx0LmMgICAgfCAxNTIgKysrKysr
KysrKysrLS0tLS0tCiAuLi4vZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9vYmplY3RfYmx0Lmgg
ICAgfCAgIDMgKwogMyBmaWxlcyBjaGFuZ2VkLCAxNjMgaW5zZXJ0aW9ucygrKSwgNzAgZGVsZXRp
b25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2Ns
aWVudF9ibHQuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jbGllbnRfYmx0
LmMKaW5kZXggYTg1OTA3ZjI5YzUzLi4yNzJjZjNlYTY4ZDUgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jbGllbnRfYmx0LmMKKysrIGIvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NsaWVudF9ibHQuYwpAQCAtMTU4LDYgKzE1OCw3IEBAIHN0
YXRpYyB2b2lkIGNsZWFyX3BhZ2VzX3dvcmtlcihzdHJ1Y3Qgd29ya19zdHJ1Y3QgKndvcmspCiAJ
c3RydWN0IGNsZWFyX3BhZ2VzX3dvcmsgKncgPSBjb250YWluZXJfb2Yod29yaywgdHlwZW9mKCp3
KSwgd29yayk7CiAJc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiA9IHctPnNsZWV2ZS0+
dm1hLT5vYmo7CiAJc3RydWN0IGk5MTVfdm1hICp2bWEgPSB3LT5zbGVldmUtPnZtYTsKKwlzdHJ1
Y3QgaTkxNV9nZW1fd3dfY3R4IHd3OwogCXN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxOwogCXN0cnVj
dCBpOTE1X3ZtYSAqYmF0Y2g7CiAJaW50IGVyciA9IHctPmRtYS5lcnJvcjsKQEAgLTE3MywxNyAr
MTc0LDIwIEBAIHN0YXRpYyB2b2lkIGNsZWFyX3BhZ2VzX3dvcmtlcihzdHJ1Y3Qgd29ya19zdHJ1
Y3QgKndvcmspCiAJb2JqLT5yZWFkX2RvbWFpbnMgPSBJOTE1X0dFTV9HUFVfRE9NQUlOUzsKIAlv
YmotPndyaXRlX2RvbWFpbiA9IDA7CiAKLQllcnIgPSBpOTE1X3ZtYV9waW4odm1hLCAwLCAwLCBQ
SU5fVVNFUik7Ci0JaWYgKHVubGlrZWx5KGVycikpCisJaTkxNV9nZW1fd3dfY3R4X2luaXQoJnd3
LCBmYWxzZSk7CisJaW50ZWxfZW5naW5lX3BtX2dldCh3LT5jZS0+ZW5naW5lKTsKK3JldHJ5Ogor
CWVyciA9IGludGVsX2NvbnRleHRfcGluX3d3KHctPmNlLCAmd3cpOworCWlmIChlcnIpCiAJCWdv
dG8gb3V0X3NpZ25hbDsKIAotCWJhdGNoID0gaW50ZWxfZW1pdF92bWFfZmlsbF9ibHQody0+Y2Us
IHZtYSwgdy0+dmFsdWUpOworCWJhdGNoID0gaW50ZWxfZW1pdF92bWFfZmlsbF9ibHQody0+Y2Us
IHZtYSwgJnd3LCB3LT52YWx1ZSk7CiAJaWYgKElTX0VSUihiYXRjaCkpIHsKIAkJZXJyID0gUFRS
X0VSUihiYXRjaCk7Ci0JCWdvdG8gb3V0X3VucGluOworCQlnb3RvIG91dF9jdHg7CiAJfQogCi0J
cnEgPSBpbnRlbF9jb250ZXh0X2NyZWF0ZV9yZXF1ZXN0KHctPmNlKTsKKwlycSA9IGk5MTVfcmVx
dWVzdF9jcmVhdGUody0+Y2UpOwogCWlmIChJU19FUlIocnEpKSB7CiAJCWVyciA9IFBUUl9FUlIo
cnEpOwogCQlnb3RvIG91dF9iYXRjaDsKQEAgLTIyNSw5ICsyMjksMTkgQEAgc3RhdGljIHZvaWQg
Y2xlYXJfcGFnZXNfd29ya2VyKHN0cnVjdCB3b3JrX3N0cnVjdCAqd29yaykKIAlpOTE1X3JlcXVl
c3RfYWRkKHJxKTsKIG91dF9iYXRjaDoKIAlpbnRlbF9lbWl0X3ZtYV9yZWxlYXNlKHctPmNlLCBi
YXRjaCk7Ci1vdXRfdW5waW46Ci0JaTkxNV92bWFfdW5waW4odm1hKTsKK291dF9jdHg6CisJaW50
ZWxfY29udGV4dF91bnBpbih3LT5jZSk7CiBvdXRfc2lnbmFsOgorCWlmIChlcnIgPT0gLUVERUFE
TEspIHsKKwkJZXJyID0gaTkxNV9nZW1fd3dfY3R4X2JhY2tvZmYoJnd3KTsKKwkJaWYgKCFlcnIp
CisJCQlnb3RvIHJldHJ5OworCX0KKwlpOTE1X2dlbV93d19jdHhfZmluaSgmd3cpOworCisJaTkx
NV92bWFfdW5waW4ody0+c2xlZXZlLT52bWEpOworCWludGVsX2VuZ2luZV9wbV9wdXQody0+Y2Ut
PmVuZ2luZSk7CisKIAlpZiAodW5saWtlbHkoZXJyKSkgewogCQlkbWFfZmVuY2Vfc2V0X2Vycm9y
KCZ3LT5kbWEsIGVycik7CiAJCWRtYV9mZW5jZV9zaWduYWwoJnctPmRtYSk7CkBAIC0yMzUsNiAr
MjQ5LDQ0IEBAIHN0YXRpYyB2b2lkIGNsZWFyX3BhZ2VzX3dvcmtlcihzdHJ1Y3Qgd29ya19zdHJ1
Y3QgKndvcmspCiAJfQogfQogCitzdGF0aWMgaW50IHBpbl93YWl0X2NsZWFyX3BhZ2VzX3dvcmso
c3RydWN0IGNsZWFyX3BhZ2VzX3dvcmsgKncsCisJCQkJICAgICBzdHJ1Y3QgaW50ZWxfY29udGV4
dCAqY2UpCit7CisJc3RydWN0IGk5MTVfdm1hICp2bWEgPSB3LT5zbGVldmUtPnZtYTsKKwlzdHJ1
Y3QgaTkxNV9nZW1fd3dfY3R4IHd3OworCWludCBlcnI7CisKKwlpOTE1X2dlbV93d19jdHhfaW5p
dCgmd3csIGZhbHNlKTsKK3JldHJ5OgorCWVyciA9IGk5MTVfZ2VtX29iamVjdF9sb2NrKHZtYS0+
b2JqLCAmd3cpOworCWlmIChlcnIpCisJCWdvdG8gb3V0OworCisJZXJyID0gaTkxNV92bWFfcGlu
X3d3KHZtYSwgJnd3LCAwLCAwLCBQSU5fVVNFUik7CisJaWYgKHVubGlrZWx5KGVycikpCisJCWdv
dG8gb3V0OworCisJZXJyID0gaTkxNV9zd19mZW5jZV9hd2FpdF9yZXNlcnZhdGlvbigmdy0+d2Fp
dCwKKwkJCQkJICAgICAgdm1hLT5vYmotPmJhc2UucmVzdiwgTlVMTCwKKwkJCQkJICAgICAgdHJ1
ZSwgMCwgSTkxNV9GRU5DRV9HRlApOworCWlmIChlcnIpCisJCWdvdG8gZXJyX3VucGluX3ZtYTsK
KworCWRtYV9yZXN2X2FkZF9leGNsX2ZlbmNlKHZtYS0+b2JqLT5iYXNlLnJlc3YsICZ3LT5kbWEp
OworCitlcnJfdW5waW5fdm1hOgorCWlmIChlcnIpCisJCWk5MTVfdm1hX3VucGluKHZtYSk7Citv
dXQ6CisJaWYgKGVyciA9PSAtRURFQURMSykgeworCQllcnIgPSBpOTE1X2dlbV93d19jdHhfYmFj
a29mZigmd3cpOworCQlpZiAoIWVycikKKwkJCWdvdG8gcmV0cnk7CisJfQorCWk5MTVfZ2VtX3d3
X2N0eF9maW5pKCZ3dyk7CisJcmV0dXJuIGVycjsKK30KKwogc3RhdGljIGludCBfX2k5MTVfc3df
ZmVuY2VfY2FsbAogY2xlYXJfcGFnZXNfd29ya19ub3RpZnkoc3RydWN0IGk5MTVfc3dfZmVuY2Ug
KmZlbmNlLAogCQkJZW51bSBpOTE1X3N3X2ZlbmNlX25vdGlmeSBzdGF0ZSkKQEAgLTI4OCwxNyAr
MzQwLDkgQEAgaW50IGk5MTVfZ2VtX3NjaGVkdWxlX2ZpbGxfcGFnZXNfYmx0KHN0cnVjdCBkcm1f
aTkxNV9nZW1fb2JqZWN0ICpvYmosCiAJZG1hX2ZlbmNlX2luaXQoJndvcmstPmRtYSwgJmNsZWFy
X3BhZ2VzX3dvcmtfb3BzLCAmZmVuY2VfbG9jaywgMCwgMCk7CiAJaTkxNV9zd19mZW5jZV9pbml0
KCZ3b3JrLT53YWl0LCBjbGVhcl9wYWdlc193b3JrX25vdGlmeSk7CiAKLQlpOTE1X2dlbV9vYmpl
Y3RfbG9jayhvYmosIE5VTEwpOwotCWVyciA9IGk5MTVfc3dfZmVuY2VfYXdhaXRfcmVzZXJ2YXRp
b24oJndvcmstPndhaXQsCi0JCQkJCSAgICAgIG9iai0+YmFzZS5yZXN2LCBOVUxMLCB0cnVlLCAw
LAotCQkJCQkgICAgICBJOTE1X0ZFTkNFX0dGUCk7Ci0JaWYgKGVyciA8IDApIHsKKwllcnIgPSBw
aW5fd2FpdF9jbGVhcl9wYWdlc193b3JrKHdvcmssIGNlKTsKKwlpZiAoZXJyIDwgMCkKIAkJZG1h
X2ZlbmNlX3NldF9lcnJvcigmd29yay0+ZG1hLCBlcnIpOwotCX0gZWxzZSB7Ci0JCWRtYV9yZXN2
X2FkZF9leGNsX2ZlbmNlKG9iai0+YmFzZS5yZXN2LCAmd29yay0+ZG1hKTsKLQkJZXJyID0gMDsK
LQl9Ci0JaTkxNV9nZW1fb2JqZWN0X3VubG9jayhvYmopOwogCiAJZG1hX2ZlbmNlX2dldCgmd29y
ay0+ZG1hKTsKIAlpOTE1X3N3X2ZlbmNlX2NvbW1pdCgmd29yay0+d2FpdCk7CmRpZmYgLS1naXQg
YS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fb2JqZWN0X2JsdC5jIGIvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX29iamVjdF9ibHQuYwppbmRleCBiZmRiMzJkNDY4
NzcuLmQ5M2ViMzYxNjBjOSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5
MTVfZ2VtX29iamVjdF9ibHQuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9n
ZW1fb2JqZWN0X2JsdC5jCkBAIC0xNCw2ICsxNCw3IEBACiAKIHN0cnVjdCBpOTE1X3ZtYSAqaW50
ZWxfZW1pdF92bWFfZmlsbF9ibHQoc3RydWN0IGludGVsX2NvbnRleHQgKmNlLAogCQkJCQkgc3Ry
dWN0IGk5MTVfdm1hICp2bWEsCisJCQkJCSBzdHJ1Y3QgaTkxNV9nZW1fd3dfY3R4ICp3dywKIAkJ
CQkJIHUzMiB2YWx1ZSkKIHsKIAlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSA9IGNlLT52
bS0+aTkxNTsKQEAgLTM5LDEwICs0MCwyNCBAQCBzdHJ1Y3QgaTkxNV92bWEgKmludGVsX2VtaXRf
dm1hX2ZpbGxfYmx0KHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSwKIAkJZ290byBvdXRfcG07CiAJ
fQogCisJZXJyID0gaTkxNV9nZW1fb2JqZWN0X2xvY2socG9vbC0+b2JqLCB3dyk7CisJaWYgKGVy
cikKKwkJZ290byBvdXRfcHV0OworCisJYmF0Y2ggPSBpOTE1X3ZtYV9pbnN0YW5jZShwb29sLT5v
YmosIGNlLT52bSwgTlVMTCk7CisJaWYgKElTX0VSUihiYXRjaCkpIHsKKwkJZXJyID0gUFRSX0VS
UihiYXRjaCk7CisJCWdvdG8gb3V0X3B1dDsKKwl9CisKKwllcnIgPSBpOTE1X3ZtYV9waW5fd3co
YmF0Y2gsIHd3LCAwLCAwLCBQSU5fVVNFUik7CisJaWYgKHVubGlrZWx5KGVycikpCisJCWdvdG8g
b3V0X3B1dDsKKwogCWNtZCA9IGk5MTVfZ2VtX29iamVjdF9waW5fbWFwKHBvb2wtPm9iaiwgSTkx
NV9NQVBfV0MpOwogCWlmIChJU19FUlIoY21kKSkgewogCQllcnIgPSBQVFJfRVJSKGNtZCk7Ci0J
CWdvdG8gb3V0X3B1dDsKKwkJZ290byBvdXRfdW5waW47CiAJfQogCiAJcmVtID0gdm1hLT5zaXpl
OwpAQCAtODQsMTkgKzk5LDExIEBAIHN0cnVjdCBpOTE1X3ZtYSAqaW50ZWxfZW1pdF92bWFfZmls
bF9ibHQoc3RydWN0IGludGVsX2NvbnRleHQgKmNlLAogCiAJaW50ZWxfZ3RfY2hpcHNldF9mbHVz
aChjZS0+dm0tPmd0KTsKIAotCWJhdGNoID0gaTkxNV92bWFfaW5zdGFuY2UocG9vbC0+b2JqLCBj
ZS0+dm0sIE5VTEwpOwotCWlmIChJU19FUlIoYmF0Y2gpKSB7Ci0JCWVyciA9IFBUUl9FUlIoYmF0
Y2gpOwotCQlnb3RvIG91dF9wdXQ7Ci0JfQotCi0JZXJyID0gaTkxNV92bWFfcGluKGJhdGNoLCAw
LCAwLCBQSU5fVVNFUik7Ci0JaWYgKHVubGlrZWx5KGVycikpCi0JCWdvdG8gb3V0X3B1dDsKLQog
CWJhdGNoLT5wcml2YXRlID0gcG9vbDsKIAlyZXR1cm4gYmF0Y2g7CiAKK291dF91bnBpbjoKKwlp
OTE1X3ZtYV91bnBpbihiYXRjaCk7CiBvdXRfcHV0OgogCWludGVsX2d0X2J1ZmZlcl9wb29sX3B1
dChwb29sKTsKIG91dF9wbToKQEAgLTEwOCwxMSArMTE1LDkgQEAgaW50IGludGVsX2VtaXRfdm1h
X21hcmtfYWN0aXZlKHN0cnVjdCBpOTE1X3ZtYSAqdm1hLCBzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpy
cSkKIHsKIAlpbnQgZXJyOwogCi0JaTkxNV92bWFfbG9jayh2bWEpOwogCWVyciA9IGk5MTVfcmVx
dWVzdF9hd2FpdF9vYmplY3QocnEsIHZtYS0+b2JqLCBmYWxzZSk7CiAJaWYgKGVyciA9PSAwKQog
CQllcnIgPSBpOTE1X3ZtYV9tb3ZlX3RvX2FjdGl2ZSh2bWEsIHJxLCAwKTsKLQlpOTE1X3ZtYV91
bmxvY2sodm1hKTsKIAlpZiAodW5saWtlbHkoZXJyKSkKIAkJcmV0dXJuIGVycjsKIApAQCAtMTQx
LDYgKzE0Niw3IEBAIGludCBpOTE1X2dlbV9vYmplY3RfZmlsbF9ibHQoc3RydWN0IGRybV9pOTE1
X2dlbV9vYmplY3QgKm9iaiwKIAkJCSAgICAgc3RydWN0IGludGVsX2NvbnRleHQgKmNlLAogCQkJ
ICAgICB1MzIgdmFsdWUpCiB7CisJc3RydWN0IGk5MTVfZ2VtX3d3X2N0eCB3dzsKIAlzdHJ1Y3Qg
aTkxNV9yZXF1ZXN0ICpycTsKIAlzdHJ1Y3QgaTkxNV92bWEgKmJhdGNoOwogCXN0cnVjdCBpOTE1
X3ZtYSAqdm1hOwpAQCAtMTUwLDE3ICsxNTYsMjggQEAgaW50IGk5MTVfZ2VtX29iamVjdF9maWxs
X2JsdChzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqLAogCWlmIChJU19FUlIodm1hKSkK
IAkJcmV0dXJuIFBUUl9FUlIodm1hKTsKIAotCWVyciA9IGk5MTVfdm1hX3Bpbih2bWEsIDAsIDAs
IFBJTl9VU0VSKTsKLQlpZiAodW5saWtlbHkoZXJyKSkKLQkJcmV0dXJuIGVycjsKKwlpOTE1X2dl
bV93d19jdHhfaW5pdCgmd3csIHRydWUpOworCWludGVsX2VuZ2luZV9wbV9nZXQoY2UtPmVuZ2lu
ZSk7CityZXRyeToKKwllcnIgPSBpOTE1X2dlbV9vYmplY3RfbG9jayhvYmosICZ3dyk7CisJaWYg
KGVycikKKwkJZ290byBvdXQ7CiAKLQliYXRjaCA9IGludGVsX2VtaXRfdm1hX2ZpbGxfYmx0KGNl
LCB2bWEsIHZhbHVlKTsKKwllcnIgPSBpbnRlbF9jb250ZXh0X3Bpbl93dyhjZSwgJnd3KTsKKwlp
ZiAoZXJyKQorCQlnb3RvIG91dDsKKworCWVyciA9IGk5MTVfdm1hX3Bpbl93dyh2bWEsICZ3dywg
MCwgMCwgUElOX1VTRVIpOworCWlmIChlcnIpCisJCWdvdG8gb3V0X2N0eDsKKworCWJhdGNoID0g
aW50ZWxfZW1pdF92bWFfZmlsbF9ibHQoY2UsIHZtYSwgJnd3LCB2YWx1ZSk7CiAJaWYgKElTX0VS
UihiYXRjaCkpIHsKIAkJZXJyID0gUFRSX0VSUihiYXRjaCk7Ci0JCWdvdG8gb3V0X3VucGluOwor
CQlnb3RvIG91dF92bWE7CiAJfQogCi0JcnEgPSBpbnRlbF9jb250ZXh0X2NyZWF0ZV9yZXF1ZXN0
KGNlKTsKKwlycSA9IGk5MTVfcmVxdWVzdF9jcmVhdGUoY2UpOwogCWlmIChJU19FUlIocnEpKSB7
CiAJCWVyciA9IFBUUl9FUlIocnEpOwogCQlnb3RvIG91dF9iYXRjaDsKQEAgLTE3MCwxMSArMTg3
LDkgQEAgaW50IGk5MTVfZ2VtX29iamVjdF9maWxsX2JsdChzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29i
amVjdCAqb2JqLAogCWlmICh1bmxpa2VseShlcnIpKQogCQlnb3RvIG91dF9yZXF1ZXN0OwogCi0J
aTkxNV92bWFfbG9jayh2bWEpOwogCWVyciA9IG1vdmVfb2JqX3RvX2dwdSh2bWEtPm9iaiwgcnEs
IHRydWUpOwogCWlmIChlcnIgPT0gMCkKIAkJZXJyID0gaTkxNV92bWFfbW92ZV90b19hY3RpdmUo
dm1hLCBycSwgRVhFQ19PQkpFQ1RfV1JJVEUpOwotCWk5MTVfdm1hX3VubG9jayh2bWEpOwogCWlm
ICh1bmxpa2VseShlcnIpKQogCQlnb3RvIG91dF9yZXF1ZXN0OwogCkBAIC0xOTMsOCArMjA4LDE4
IEBAIGludCBpOTE1X2dlbV9vYmplY3RfZmlsbF9ibHQoc3RydWN0IGRybV9pOTE1X2dlbV9vYmpl
Y3QgKm9iaiwKIAlpOTE1X3JlcXVlc3RfYWRkKHJxKTsKIG91dF9iYXRjaDoKIAlpbnRlbF9lbWl0
X3ZtYV9yZWxlYXNlKGNlLCBiYXRjaCk7Ci1vdXRfdW5waW46CitvdXRfdm1hOgogCWk5MTVfdm1h
X3VucGluKHZtYSk7CitvdXRfY3R4OgorCWludGVsX2NvbnRleHRfdW5waW4oY2UpOworb3V0Ogor
CWlmIChlcnIgPT0gLUVERUFETEspIHsKKwkJZXJyID0gaTkxNV9nZW1fd3dfY3R4X2JhY2tvZmYo
Jnd3KTsKKwkJaWYgKCFlcnIpCisJCQlnb3RvIHJldHJ5OworCX0KKwlpOTE1X2dlbV93d19jdHhf
ZmluaSgmd3cpOworCWludGVsX2VuZ2luZV9wbV9wdXQoY2UtPmVuZ2luZSk7CiAJcmV0dXJuIGVy
cjsKIH0KIApAQCAtMjEwLDYgKzIzNSw3IEBAIHN0YXRpYyBib29sIHdhXzEyMDk2NDQ2MTFfYXBw
bGllcyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSwgdTMyIHNpemUpCiB9CiAKIHN0cnVj
dCBpOTE1X3ZtYSAqaW50ZWxfZW1pdF92bWFfY29weV9ibHQoc3RydWN0IGludGVsX2NvbnRleHQg
KmNlLAorCQkJCQkgc3RydWN0IGk5MTVfZ2VtX3d3X2N0eCAqd3csCiAJCQkJCSBzdHJ1Y3QgaTkx
NV92bWEgKnNyYywKIAkJCQkJIHN0cnVjdCBpOTE1X3ZtYSAqZHN0KQogewpAQCAtMjM2LDEwICsy
NjIsMjQgQEAgc3RydWN0IGk5MTVfdm1hICppbnRlbF9lbWl0X3ZtYV9jb3B5X2JsdChzdHJ1Y3Qg
aW50ZWxfY29udGV4dCAqY2UsCiAJCWdvdG8gb3V0X3BtOwogCX0KIAorCWVyciA9IGk5MTVfZ2Vt
X29iamVjdF9sb2NrKHBvb2wtPm9iaiwgd3cpOworCWlmIChlcnIpCisJCWdvdG8gb3V0X3B1dDsK
KworCWJhdGNoID0gaTkxNV92bWFfaW5zdGFuY2UocG9vbC0+b2JqLCBjZS0+dm0sIE5VTEwpOwor
CWlmIChJU19FUlIoYmF0Y2gpKSB7CisJCWVyciA9IFBUUl9FUlIoYmF0Y2gpOworCQlnb3RvIG91
dF9wdXQ7CisJfQorCisJZXJyID0gaTkxNV92bWFfcGluX3d3KGJhdGNoLCB3dywgMCwgMCwgUElO
X1VTRVIpOworCWlmICh1bmxpa2VseShlcnIpKQorCQlnb3RvIG91dF9wdXQ7CisKIAljbWQgPSBp
OTE1X2dlbV9vYmplY3RfcGluX21hcChwb29sLT5vYmosIEk5MTVfTUFQX1dDKTsKIAlpZiAoSVNf
RVJSKGNtZCkpIHsKIAkJZXJyID0gUFRSX0VSUihjbWQpOwotCQlnb3RvIG91dF9wdXQ7CisJCWdv
dG8gb3V0X3VucGluOwogCX0KIAogCXJlbSA9IHNyYy0+c2l6ZTsKQEAgLTI5NiwyMCArMzM2LDEx
IEBAIHN0cnVjdCBpOTE1X3ZtYSAqaW50ZWxfZW1pdF92bWFfY29weV9ibHQoc3RydWN0IGludGVs
X2NvbnRleHQgKmNlLAogCWk5MTVfZ2VtX29iamVjdF91bnBpbl9tYXAocG9vbC0+b2JqKTsKIAog
CWludGVsX2d0X2NoaXBzZXRfZmx1c2goY2UtPnZtLT5ndCk7Ci0KLQliYXRjaCA9IGk5MTVfdm1h
X2luc3RhbmNlKHBvb2wtPm9iaiwgY2UtPnZtLCBOVUxMKTsKLQlpZiAoSVNfRVJSKGJhdGNoKSkg
ewotCQllcnIgPSBQVFJfRVJSKGJhdGNoKTsKLQkJZ290byBvdXRfcHV0OwotCX0KLQotCWVyciA9
IGk5MTVfdm1hX3BpbihiYXRjaCwgMCwgMCwgUElOX1VTRVIpOwotCWlmICh1bmxpa2VseShlcnIp
KQotCQlnb3RvIG91dF9wdXQ7Ci0KIAliYXRjaC0+cHJpdmF0ZSA9IHBvb2w7CiAJcmV0dXJuIGJh
dGNoOwogCitvdXRfdW5waW46CisJaTkxNV92bWFfdW5waW4oYmF0Y2gpOwogb3V0X3B1dDoKIAlp
bnRlbF9ndF9idWZmZXJfcG9vbF9wdXQocG9vbCk7CiBvdXRfcG06CkBAIC0zMjEsMTAgKzM1Miw5
IEBAIGludCBpOTE1X2dlbV9vYmplY3RfY29weV9ibHQoc3RydWN0IGRybV9pOTE1X2dlbV9vYmpl
Y3QgKnNyYywKIAkJCSAgICAgc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKmRzdCwKIAkJCSAg
ICAgc3RydWN0IGludGVsX2NvbnRleHQgKmNlKQogewotCXN0cnVjdCBkcm1fZ2VtX29iamVjdCAq
b2Jqc1tdID0geyAmc3JjLT5iYXNlLCAmZHN0LT5iYXNlIH07CiAJc3RydWN0IGk5MTVfYWRkcmVz
c19zcGFjZSAqdm0gPSBjZS0+dm07CiAJc3RydWN0IGk5MTVfdm1hICp2bWFbMl0sICpiYXRjaDsK
LQlzdHJ1Y3Qgd3dfYWNxdWlyZV9jdHggYWNxdWlyZTsKKwlzdHJ1Y3QgaTkxNV9nZW1fd3dfY3R4
IHd3OwogCXN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxOwogCWludCBlcnIsIGk7CiAKQEAgLTMzMiwy
NSArMzYyLDM2IEBAIGludCBpOTE1X2dlbV9vYmplY3RfY29weV9ibHQoc3RydWN0IGRybV9pOTE1
X2dlbV9vYmplY3QgKnNyYywKIAlpZiAoSVNfRVJSKHZtYVswXSkpCiAJCXJldHVybiBQVFJfRVJS
KHZtYVswXSk7CiAKLQllcnIgPSBpOTE1X3ZtYV9waW4odm1hWzBdLCAwLCAwLCBQSU5fVVNFUik7
Ci0JaWYgKHVubGlrZWx5KGVycikpCi0JCXJldHVybiBlcnI7Ci0KIAl2bWFbMV0gPSBpOTE1X3Zt
YV9pbnN0YW5jZShkc3QsIHZtLCBOVUxMKTsKIAlpZiAoSVNfRVJSKHZtYVsxXSkpCi0JCWdvdG8g
b3V0X3VucGluX3NyYzsKKwkJcmV0dXJuIFBUUl9FUlIodm1hKTsKIAotCWVyciA9IGk5MTVfdm1h
X3Bpbih2bWFbMV0sIDAsIDAsIFBJTl9VU0VSKTsKKwlpOTE1X2dlbV93d19jdHhfaW5pdCgmd3cs
IHRydWUpOworCWludGVsX2VuZ2luZV9wbV9nZXQoY2UtPmVuZ2luZSk7CityZXRyeToKKwllcnIg
PSBpOTE1X2dlbV9vYmplY3RfbG9jayhzcmMsICZ3dyk7CisJaWYgKCFlcnIpCisJCWVyciA9IGk5
MTVfZ2VtX29iamVjdF9sb2NrKGRzdCwgJnd3KTsKKwlpZiAoIWVycikKKwkJZXJyID0gaW50ZWxf
Y29udGV4dF9waW5fd3coY2UsICZ3dyk7CisJaWYgKGVycikKKwkJZ290byBvdXQ7CisKKwllcnIg
PSBpOTE1X3ZtYV9waW5fd3codm1hWzBdLCAmd3csIDAsIDAsIFBJTl9VU0VSKTsKKwlpZiAoZXJy
KQorCQlnb3RvIG91dF9jdHg7CisKKwllcnIgPSBpOTE1X3ZtYV9waW5fd3codm1hWzFdLCAmd3cs
IDAsIDAsIFBJTl9VU0VSKTsKIAlpZiAodW5saWtlbHkoZXJyKSkKIAkJZ290byBvdXRfdW5waW5f
c3JjOwogCi0JYmF0Y2ggPSBpbnRlbF9lbWl0X3ZtYV9jb3B5X2JsdChjZSwgdm1hWzBdLCB2bWFb
MV0pOworCWJhdGNoID0gaW50ZWxfZW1pdF92bWFfY29weV9ibHQoY2UsICZ3dywgdm1hWzBdLCB2
bWFbMV0pOwogCWlmIChJU19FUlIoYmF0Y2gpKSB7CiAJCWVyciA9IFBUUl9FUlIoYmF0Y2gpOwog
CQlnb3RvIG91dF91bnBpbl9kc3Q7CiAJfQogCi0JcnEgPSBpbnRlbF9jb250ZXh0X2NyZWF0ZV9y
ZXF1ZXN0KGNlKTsKKwlycSA9IGk5MTVfcmVxdWVzdF9jcmVhdGUoY2UpOwogCWlmIChJU19FUlIo
cnEpKSB7CiAJCWVyciA9IFBUUl9FUlIocnEpOwogCQlnb3RvIG91dF9iYXRjaDsKQEAgLTM2MCwx
NCArNDAxLDEwIEBAIGludCBpOTE1X2dlbV9vYmplY3RfY29weV9ibHQoc3RydWN0IGRybV9pOTE1
X2dlbV9vYmplY3QgKnNyYywKIAlpZiAodW5saWtlbHkoZXJyKSkKIAkJZ290byBvdXRfcmVxdWVz
dDsKIAotCWVyciA9IGRybV9nZW1fbG9ja19yZXNlcnZhdGlvbnMob2JqcywgQVJSQVlfU0laRShv
YmpzKSwgJmFjcXVpcmUpOwotCWlmICh1bmxpa2VseShlcnIpKQotCQlnb3RvIG91dF9yZXF1ZXN0
OwotCiAJZm9yIChpID0gMDsgaSA8IEFSUkFZX1NJWkUodm1hKTsgaSsrKSB7CiAJCWVyciA9IG1v
dmVfb2JqX3RvX2dwdSh2bWFbaV0tPm9iaiwgcnEsIGkpOwogCQlpZiAodW5saWtlbHkoZXJyKSkK
LQkJCWdvdG8gb3V0X3VubG9jazsKKwkJCWdvdG8gb3V0X3JlcXVlc3Q7CiAJfQogCiAJZm9yIChp
ID0gMDsgaSA8IEFSUkFZX1NJWkUodm1hKTsgaSsrKSB7CkBAIC0zNzUsMjAgKzQxMiwxOSBAQCBp
bnQgaTkxNV9nZW1fb2JqZWN0X2NvcHlfYmx0KHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpz
cmMsCiAKIAkJZXJyID0gaTkxNV92bWFfbW92ZV90b19hY3RpdmUodm1hW2ldLCBycSwgZmxhZ3Mp
OwogCQlpZiAodW5saWtlbHkoZXJyKSkKLQkJCWdvdG8gb3V0X3VubG9jazsKKwkJCWdvdG8gb3V0
X3JlcXVlc3Q7CiAJfQogCiAJaWYgKHJxLT5lbmdpbmUtPmVtaXRfaW5pdF9icmVhZGNydW1iKSB7
CiAJCWVyciA9IHJxLT5lbmdpbmUtPmVtaXRfaW5pdF9icmVhZGNydW1iKHJxKTsKIAkJaWYgKHVu
bGlrZWx5KGVycikpCi0JCQlnb3RvIG91dF91bmxvY2s7CisJCQlnb3RvIG91dF9yZXF1ZXN0Owog
CX0KIAogCWVyciA9IHJxLT5lbmdpbmUtPmVtaXRfYmJfc3RhcnQocnEsCiAJCQkJCWJhdGNoLT5u
b2RlLnN0YXJ0LCBiYXRjaC0+bm9kZS5zaXplLAogCQkJCQkwKTsKLW91dF91bmxvY2s6Ci0JZHJt
X2dlbV91bmxvY2tfcmVzZXJ2YXRpb25zKG9ianMsIEFSUkFZX1NJWkUob2JqcyksICZhY3F1aXJl
KTsKKwogb3V0X3JlcXVlc3Q6CiAJaWYgKHVubGlrZWx5KGVycikpCiAJCWk5MTVfcmVxdWVzdF9z
ZXRfZXJyb3Jfb25jZShycSwgZXJyKTsKQEAgLTQwMCw2ICs0MzYsMTYgQEAgaW50IGk5MTVfZ2Vt
X29iamVjdF9jb3B5X2JsdChzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqc3JjLAogCWk5MTVf
dm1hX3VucGluKHZtYVsxXSk7CiBvdXRfdW5waW5fc3JjOgogCWk5MTVfdm1hX3VucGluKHZtYVsw
XSk7CitvdXRfY3R4OgorCWludGVsX2NvbnRleHRfdW5waW4oY2UpOworb3V0OgorCWlmIChlcnIg
PT0gLUVERUFETEspIHsKKwkJZXJyID0gaTkxNV9nZW1fd3dfY3R4X2JhY2tvZmYoJnd3KTsKKwkJ
aWYgKCFlcnIpCisJCQlnb3RvIHJldHJ5OworCX0KKwlpOTE1X2dlbV93d19jdHhfZmluaSgmd3cp
OworCWludGVsX2VuZ2luZV9wbV9wdXQoY2UtPmVuZ2luZSk7CiAJcmV0dXJuIGVycjsKIH0KIApk
aWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX29iamVjdF9ibHQu
aCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9vYmplY3RfYmx0LmgKaW5kZXgg
OGJjZDMzNmE5MGRjLi4yNDA5ZmRjY2NmMGUgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2dlbS9pOTE1X2dlbV9vYmplY3RfYmx0LmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUv
Z2VtL2k5MTVfZ2VtX29iamVjdF9ibHQuaApAQCAtMTMsMTIgKzEzLDE1IEBACiAjaW5jbHVkZSAi
aTkxNV92bWEuaCIKIAogc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3Q7CitzdHJ1Y3QgaTkxNV9n
ZW1fd3dfY3R4OwogCiBzdHJ1Y3QgaTkxNV92bWEgKmludGVsX2VtaXRfdm1hX2ZpbGxfYmx0KHN0
cnVjdCBpbnRlbF9jb250ZXh0ICpjZSwKIAkJCQkJIHN0cnVjdCBpOTE1X3ZtYSAqdm1hLAorCQkJ
CQkgc3RydWN0IGk5MTVfZ2VtX3d3X2N0eCAqd3csCiAJCQkJCSB1MzIgdmFsdWUpOwogCiBzdHJ1
Y3QgaTkxNV92bWEgKmludGVsX2VtaXRfdm1hX2NvcHlfYmx0KHN0cnVjdCBpbnRlbF9jb250ZXh0
ICpjZSwKKwkJCQkJIHN0cnVjdCBpOTE1X2dlbV93d19jdHggKnd3LAogCQkJCQkgc3RydWN0IGk5
MTVfdm1hICpzcmMsCiAJCQkJCSBzdHJ1Y3QgaTkxNV92bWEgKmRzdCk7CiAKLS0gCjIuMjguMAoK
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4
IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlz
dHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4Cg==

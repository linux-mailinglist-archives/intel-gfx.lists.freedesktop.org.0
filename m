Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 3CF84393163
	for <lists+intel-gfx@lfdr.de>; Thu, 27 May 2021 16:47:55 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id AA1686F3EA;
	Thu, 27 May 2021 14:47:46 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mga14.intel.com (mga14.intel.com [192.55.52.115])
 by gabe.freedesktop.org (Postfix) with ESMTPS id E81796F3DF;
 Thu, 27 May 2021 14:47:40 +0000 (UTC)
IronPort-SDR: H0QAXSsvTyAHUgPe1jiU4bTTR2nshkQWdHLmfw0TW6HSYqHX745PDHMIUOjlNJYg2YB5ZEw9tC
 Idyi+Cwydchg==
X-IronPort-AV: E=McAfee;i="6200,9189,9996"; a="202515619"
X-IronPort-AV: E=Sophos;i="5.82,334,1613462400"; d="scan'208";a="202515619"
Received: from orsmga008.jf.intel.com ([10.7.209.65])
 by fmsmga103.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 27 May 2021 07:47:40 -0700
IronPort-SDR: h3CeAUHOVu0hijewqh+uUfVM5zs00TyRK3Bv5l/U0BkHxKRr+uU29WIWGhjYskLXIXWyYE39QQ
 fHCcyUiRy2QA==
X-IronPort-AV: E=Sophos;i="5.82,334,1613462400"; d="scan'208";a="443597994"
Received: from ibanaga-mobl.ger.corp.intel.com (HELO thellst-mobl1.intel.com)
 ([10.249.254.58])
 by orsmga008-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 27 May 2021 07:47:38 -0700
From: =?UTF-8?q?Thomas=20Hellstr=C3=B6m?= <thomas.hellstrom@linux.intel.com>
To: intel-gfx@lists.freedesktop.org,
	dri-devel@lists.freedesktop.org
Date: Thu, 27 May 2021 16:47:05 +0200
Message-Id: <20210527144710.1975553-11-thomas.hellstrom@linux.intel.com>
X-Mailer: git-send-email 2.31.1
In-Reply-To: <20210527144710.1975553-1-thomas.hellstrom@linux.intel.com>
References: <20210527144710.1975553-1-thomas.hellstrom@linux.intel.com>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v5 10/15] drm/ttm,
 drm/amdgpu: Allow the driver some control over swapping
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: =?UTF-8?q?Thomas=20Hellstr=C3=B6m?= <thomas.hellstrom@linux.intel.com>,
 =?UTF-8?q?Christian=20K=C3=B6nig?= <christian.koenig@amd.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

V2UgYXJlIGNhbGxpbmcgdGhlIGV2aWN0aW9uX3ZhbHVhYmxlIGRyaXZlciBjYWxsYmFjayBhdCBl
dmljdGlvbiB0aW1lIHRvCmRldGVybWluZSB3aGV0aGVyIHdlIGFjdHVhbGx5IGNhbiBldmljdCBh
IGJ1ZmZlciBvYmplY3QuClRoZSB1cGNvbWluZyBpOTE1IFRUTSBiYWNrZW5kIG5lZWRzIHRoZSBz
YW1lIGZ1bmN0aW9uYWxpdHkgZm9yIHN3YXBvdXQsCmFuZCB0aGF0IG1pZ2h0IGFjdHVhbGx5IGJl
IGJlbmVmaWNpYWwgdG8gb3RoZXIgZHJpdmVycyBhcyB3ZWxsLgoKQWRkIGFuIGV2aWN0aW9uX3Zh
bHVhYmxlIGNhbGwgYWxzbyBpbiB0aGUgc3dhcG91dCBwYXRoLiBUcnkgdG8ga2VlcCB0aGUKY3Vy
cmVudCBiZWhhdmlvdXIgZm9yIGFsbCBkcml2ZXJzIGJ5IHJldHVybmluZyB0cnVlIGlmIHRoZSBi
dWZmZXIgb2JqZWN0CmlzIGFscmVhZHkgaW4gdGhlIFRUTV9QTF9TWVNURU0gcGxhY2VtZW50LiBX
ZSBjaGFuZ2UgYmVoYXZpb3VyIGZvciB0aGUKY2FzZSB3aGVyZSBhIGJ1ZmZlciBvYmplY3QgaXMg
aW4gYSBUVCBiYWNrZWQgcGxhY2VtZW50IHdoZW4gc3dhcHBlZCBvdXQsCmluIHdoaWNoIGNhc2Ug
dGhlIGRyaXZlcnMgbm9ybWFsIGV2aWN0aW9uX3ZhbHVhYmxlIHBhdGggaXMgcnVuLgoKUmV2aWV3
ZWQtYnk6IE1hYXJ0ZW4gTGFua2hvcnN0IDxtYWFydGVuLmxhbmtob3JzdEBsaW51eC5pbnRlbC5j
b20+CkNjOiBDaHJpc3RpYW4gS8O2bmlnIDxjaHJpc3RpYW4ua29lbmlnQGFtZC5jb20+ClNpZ25l
ZC1vZmYtYnk6IFRob21hcyBIZWxsc3Ryw7ZtIDx0aG9tYXMuaGVsbHN0cm9tQGxpbnV4LmludGVs
LmNvbT4KLS0tCnYzOgotIERvbid0IGV4cG9ydCB0dG1fdHRfdW5wb3B1bGF0ZQotIEZpeCBjb25m
dXNpb24gcmVhZGluZyB0aGUgbG9ja2VkIHBvaW50ZXIgaW5zdGVhZCBvZiB0aGUgdmFsdWUKICBw
b2ludGVkIHRvIGluIHR0bV9ib19ldmljdF9zd2Fwb3V0X2FsbG93YWJsZSAoUmVwb3J0ZWQgYnkK
ICBNYWFydGVuIExhbmtob3JzdCkKdjU6Ci0gVXNlIG1lbXNldCgpIHJhdGhlciB0aGFuID0ge30g
KFN1Z2dlc3RlZCBieSBDaHJpc3RpYW4gS8O2bmlnKQotIFJlbW92ZSBjaGVjayBmb3IgdHRtX3R0
X2lzX3BvcHVsYXRlZCBpbiB0aGUgc3dhcG91dCBjb2RlIGluIHRoZSBob3BlCiAgaXQgd2lsbCBi
ZSBmaXhlZCBlbHNld2hlcmUgKFN1Z2dlc3RlZCBieSBDaHJpc3RpYW4gS8O2bmlnKQotLS0KIGRy
aXZlcnMvZ3B1L2RybS9hbWQvYW1kZ3B1L2FtZGdwdV90dG0uYyB8ICA0ICsrKwogZHJpdmVycy9n
cHUvZHJtL3R0bS90dG1fYm8uYyAgICAgICAgICAgIHwgNDMgKysrKysrKysrKysrKysrKy0tLS0t
LS0tLQogMiBmaWxlcyBjaGFuZ2VkLCAzMiBpbnNlcnRpb25zKCspLCAxNSBkZWxldGlvbnMoLSkK
CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfdHRtLmMgYi9k
cml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfdHRtLmMKaW5kZXggODA0MzdiNmJhNWYz
Li41MTE2MDY1NzQ4YTUgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9hbWQvYW1kZ3B1L2Ft
ZGdwdV90dG0uYworKysgYi9kcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfdHRtLmMK
QEAgLTEzMjgsNiArMTMyOCwxMCBAQCBzdGF0aWMgYm9vbCBhbWRncHVfdHRtX2JvX2V2aWN0aW9u
X3ZhbHVhYmxlKHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8sCiAJc3RydWN0IGRtYV9mZW5j
ZSAqZjsKIAlpbnQgaTsKIAorCS8qIFN3YXBvdXQ/ICovCisJaWYgKGJvLT5tZW0ubWVtX3R5cGUg
PT0gVFRNX1BMX1NZU1RFTSkKKwkJcmV0dXJuIHRydWU7CisKIAlpZiAoYm8tPnR5cGUgPT0gdHRt
X2JvX3R5cGVfa2VybmVsICYmCiAJICAgICFhbWRncHVfdm1fZXZpY3RhYmxlKHR0bV90b19hbWRn
cHVfYm8oYm8pKSkKIAkJcmV0dXJuIGZhbHNlOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJt
L3R0bS90dG1fYm8uYyBiL2RyaXZlcnMvZ3B1L2RybS90dG0vdHRtX2JvLmMKaW5kZXggYmUwNDA2
NDY2NDYwLi45ZjUzNTA2YTgyZmMgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS90dG0vdHRt
X2JvLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL3R0bS90dG1fYm8uYwpAQCAtNTM2LDYgKzUzNiwx
MCBAQCBzdGF0aWMgaW50IHR0bV9ib19ldmljdChzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJv
LAogYm9vbCB0dG1fYm9fZXZpY3Rpb25fdmFsdWFibGUoc3RydWN0IHR0bV9idWZmZXJfb2JqZWN0
ICpibywKIAkJCSAgICAgIGNvbnN0IHN0cnVjdCB0dG1fcGxhY2UgKnBsYWNlKQogeworCWRtYV9y
ZXN2X2Fzc2VydF9oZWxkKGJvLT5iYXNlLnJlc3YpOworCWlmIChiby0+bWVtLm1lbV90eXBlID09
IFRUTV9QTF9TWVNURU0pCisJCXJldHVybiB0cnVlOworCiAJLyogRG9uJ3QgZXZpY3QgdGhpcyBC
TyBpZiBpdCdzIG91dHNpZGUgb2YgdGhlCiAJICogcmVxdWVzdGVkIHBsYWNlbWVudCByYW5nZQog
CSAqLwpAQCAtNTU4LDcgKzU2Miw5IEBAIEVYUE9SVF9TWU1CT0wodHRtX2JvX2V2aWN0aW9uX3Zh
bHVhYmxlKTsKICAqIGIuIE90aGVyd2lzZSwgdHJ5bG9jayBpdC4KICAqLwogc3RhdGljIGJvb2wg
dHRtX2JvX2V2aWN0X3N3YXBvdXRfYWxsb3dhYmxlKHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAq
Ym8sCi0JCQlzdHJ1Y3QgdHRtX29wZXJhdGlvbl9jdHggKmN0eCwgYm9vbCAqbG9ja2VkLCBib29s
ICpidXN5KQorCQkJCQkgICBzdHJ1Y3QgdHRtX29wZXJhdGlvbl9jdHggKmN0eCwKKwkJCQkJICAg
Y29uc3Qgc3RydWN0IHR0bV9wbGFjZSAqcGxhY2UsCisJCQkJCSAgIGJvb2wgKmxvY2tlZCwgYm9v
bCAqYnVzeSkKIHsKIAlib29sIHJldCA9IGZhbHNlOwogCkBAIC01NzYsNiArNTgyLDE0IEBAIHN0
YXRpYyBib29sIHR0bV9ib19ldmljdF9zd2Fwb3V0X2FsbG93YWJsZShzdHJ1Y3QgdHRtX2J1ZmZl
cl9vYmplY3QgKmJvLAogCQkJKmJ1c3kgPSAhcmV0OwogCX0KIAorCWlmIChyZXQgJiYgcGxhY2Ug
JiYgIWJvLT5iZGV2LT5mdW5jcy0+ZXZpY3Rpb25fdmFsdWFibGUoYm8sIHBsYWNlKSkgeworCQly
ZXQgPSBmYWxzZTsKKwkJaWYgKCpsb2NrZWQpIHsKKwkJCWRtYV9yZXN2X3VubG9jayhiby0+YmFz
ZS5yZXN2KTsKKwkJCSpsb2NrZWQgPSBmYWxzZTsKKwkJfQorCX0KKwogCXJldHVybiByZXQ7CiB9
CiAKQEAgLTYzMCwyMCArNjQ0LDE0IEBAIGludCB0dG1fbWVtX2V2aWN0X2ZpcnN0KHN0cnVjdCB0
dG1fZGV2aWNlICpiZGV2LAogCQlsaXN0X2Zvcl9lYWNoX2VudHJ5KGJvLCAmbWFuLT5scnVbaV0s
IGxydSkgewogCQkJYm9vbCBidXN5OwogCi0JCQlpZiAoIXR0bV9ib19ldmljdF9zd2Fwb3V0X2Fs
bG93YWJsZShibywgY3R4LCAmbG9ja2VkLAotCQkJCQkJCSAgICAmYnVzeSkpIHsKKwkJCWlmICgh
dHRtX2JvX2V2aWN0X3N3YXBvdXRfYWxsb3dhYmxlKGJvLCBjdHgsIHBsYWNlLAorCQkJCQkJCSAg
ICAmbG9ja2VkLCAmYnVzeSkpIHsKIAkJCQlpZiAoYnVzeSAmJiAhYnVzeV9ibyAmJiB0aWNrZXQg
IT0KIAkJCQkgICAgZG1hX3Jlc3ZfbG9ja2luZ19jdHgoYm8tPmJhc2UucmVzdikpCiAJCQkJCWJ1
c3lfYm8gPSBibzsKIAkJCQljb250aW51ZTsKIAkJCX0KIAotCQkJaWYgKHBsYWNlICYmICFiZGV2
LT5mdW5jcy0+ZXZpY3Rpb25fdmFsdWFibGUoYm8sCi0JCQkJCQkJCSAgICAgIHBsYWNlKSkgewot
CQkJCWlmIChsb2NrZWQpCi0JCQkJCWRtYV9yZXN2X3VubG9jayhiby0+YmFzZS5yZXN2KTsKLQkJ
CQljb250aW51ZTsKLQkJCX0KIAkJCWlmICghdHRtX2JvX2dldF91bmxlc3NfemVybyhibykpIHsK
IAkJCQlpZiAobG9ja2VkKQogCQkJCQlkbWFfcmVzdl91bmxvY2soYm8tPmJhc2UucmVzdik7CkBA
IC0xMTQwLDEwICsxMTQ4LDE5IEBAIEVYUE9SVF9TWU1CT0wodHRtX2JvX3dhaXQpOwogaW50IHR0
bV9ib19zd2Fwb3V0KHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8sIHN0cnVjdCB0dG1fb3Bl
cmF0aW9uX2N0eCAqY3R4LAogCQkgICBnZnBfdCBnZnBfZmxhZ3MpCiB7CisJc3RydWN0IHR0bV9w
bGFjZSBwbGFjZTsKIAlib29sIGxvY2tlZDsKIAlpbnQgcmV0OwogCi0JaWYgKCF0dG1fYm9fZXZp
Y3Rfc3dhcG91dF9hbGxvd2FibGUoYm8sIGN0eCwgJmxvY2tlZCwgTlVMTCkpCisJLyoKKwkgKiBX
aGlsZSB0aGUgYm8gbWF5IGFscmVhZHkgcmVzaWRlIGluIFNZU1RFTSBwbGFjZW1lbnQsIHNldAor
CSAqIFNZU1RFTSBhcyBuZXcgcGxhY2VtZW50IHRvIGNvdmVyIGFsc28gdGhlIG1vdmUgZnVydGhl
ciBiZWxvdy4KKwkgKiBUaGUgZHJpdmVyIG1heSB1c2UgdGhlIGZhY3QgdGhhdCB3ZSdyZSBtb3Zp
bmcgZnJvbSBTWVNURU0KKwkgKiBhcyBhbiBpbmRpY2F0aW9uIHRoYXQgd2UncmUgYWJvdXQgdG8g
c3dhcCBvdXQuCisJICovCisJbWVtc2V0KCZwbGFjZSwgMCwgc2l6ZW9mKHBsYWNlKSk7CisJcGxh
Y2UubWVtX3R5cGUgPSBUVE1fUExfU1lTVEVNOworCWlmICghdHRtX2JvX2V2aWN0X3N3YXBvdXRf
YWxsb3dhYmxlKGJvLCBjdHgsICZwbGFjZSwgJmxvY2tlZCwgTlVMTCkpCiAJCXJldHVybiAtRUJV
U1k7CiAKIAlpZiAoIXR0bV9ib19nZXRfdW5sZXNzX3plcm8oYm8pKSB7CkBAIC0xMTY4LDEzICsx
MTg1LDkgQEAgaW50IHR0bV9ib19zd2Fwb3V0KHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8s
IHN0cnVjdCB0dG1fb3BlcmF0aW9uX2N0eCAqY3R4LAogCWlmIChiby0+bWVtLm1lbV90eXBlICE9
IFRUTV9QTF9TWVNURU0pIHsKIAkJc3RydWN0IHR0bV9vcGVyYXRpb25fY3R4IGN0eCA9IHsgZmFs
c2UsIGZhbHNlIH07CiAJCXN0cnVjdCB0dG1fcmVzb3VyY2UgZXZpY3RfbWVtOwotCQlzdHJ1Y3Qg
dHRtX3BsYWNlIHBsYWNlLCBob3A7CisJCXN0cnVjdCB0dG1fcGxhY2UgaG9wOwogCi0JCW1lbXNl
dCgmcGxhY2UsIDAsIHNpemVvZihwbGFjZSkpOwogCQltZW1zZXQoJmhvcCwgMCwgc2l6ZW9mKGhv
cCkpOwotCi0JCXBsYWNlLm1lbV90eXBlID0gVFRNX1BMX1NZU1RFTTsKLQogCQlyZXQgPSB0dG1f
cmVzb3VyY2VfYWxsb2MoYm8sICZwbGFjZSwgJmV2aWN0X21lbSk7CiAJCWlmICh1bmxpa2VseShy
ZXQpKQogCQkJZ290byBvdXQ7Ci0tIAoyLjMxLjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxp
c3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFu
L2xpc3RpbmZvL2ludGVsLWdmeAo=

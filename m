Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id C4EDCF9B3A
	for <lists+intel-gfx@lfdr.de>; Tue, 12 Nov 2019 21:51:08 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 755406E516;
	Tue, 12 Nov 2019 20:51:06 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 004A96E516
 for <intel-gfx@lists.freedesktop.org>; Tue, 12 Nov 2019 20:51:03 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 19179339-1500050 
 for multiple; Tue, 12 Nov 2019 20:50:49 +0000
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Tue, 12 Nov 2019 20:50:47 +0000
Message-Id: <20191112205047.19201-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.24.0
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH] drm/i915/selftests: Exercise long preemption
 chains
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

VmVyaWZ5IHRoYXQgd2UgY2FuIGV4ZWN1dGUgYSBsb25nIGNoYWluIG9mIGRlcGVuZGVudCByZXF1
ZXN0cyBmcm9tCnVzZXJzcGFjZSwgZWFjaCBvbmUgc2xpZ2h0bHkgbW9yZSBpbXBvcnRhbnQgdGhh
biB0aGUgbGFzdC4KClNpZ25lZC1vZmYtYnk6IENocmlzIFdpbHNvbiA8Y2hyaXNAY2hyaXMtd2ls
c29uLmNvLnVrPgpDYzogVHZydGtvIFVyc3VsaW4gPHR2cnRrby51cnN1bGluQGludGVsLmNvbT4K
LS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVzdF9scmMuYyB8IDE4NiArKysrKysr
KysrKysrKysrKysrKysrKysrCiAxIGZpbGUgY2hhbmdlZCwgMTg2IGluc2VydGlvbnMoKykKCmRp
ZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVzdF9scmMuYyBiL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L2d0L3NlbGZ0ZXN0X2xyYy5jCmluZGV4IGQxZWQzYzBmODUxYy4uMGIw
MzE2MTU5YWUzIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVzdF9s
cmMuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVzdF9scmMuYwpAQCAtMTkx
NSw2ICsxOTE1LDE5MSBAQCBzdGF0aWMgaW50IGxpdmVfY2hhaW5fcHJlZW1wdCh2b2lkICphcmcp
CiAJZ290byBlcnJfY2xpZW50X2xvOwogfQogCitzdGF0aWMgaW50IGNyZWF0ZV9nYW5nKHN0cnVj
dCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSwKKwkJICAgICAgIHN0cnVjdCBpOTE1X3JlcXVlc3Qg
KipwcmV2KQoreworCXN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmo7CisJc3RydWN0IGlu
dGVsX2NvbnRleHQgKmNlOworCXN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxOworCXN0cnVjdCBpOTE1
X3ZtYSAqdm1hOworCXUzMiAqY3M7CisJaW50IGVycjsKKworCWNlID0gaW50ZWxfY29udGV4dF9j
cmVhdGUoZW5naW5lLT5rZXJuZWxfY29udGV4dC0+Z2VtX2NvbnRleHQsIGVuZ2luZSk7CisJaWYg
KElTX0VSUihjZSkpCisJCXJldHVybiBQVFJfRVJSKGNlKTsKKworCW9iaiA9IGk5MTVfZ2VtX29i
amVjdF9jcmVhdGVfaW50ZXJuYWwoZW5naW5lLT5pOTE1LCA0MDk2KTsKKwlpZiAoSVNfRVJSKG9i
aikpIHsKKwkJZXJyID0gUFRSX0VSUihvYmopOworCQlnb3RvIGVycl9jZTsKKwl9CisKKwl2bWEg
PSBpOTE1X3ZtYV9pbnN0YW5jZShvYmosIGNlLT52bSwgTlVMTCk7CisJaWYgKElTX0VSUih2bWEp
KSB7CisJCWVyciA9IFBUUl9FUlIodm1hKTsKKwkJZ290byBlcnJfb2JqOworCX0KKworCWVyciA9
IGk5MTVfdm1hX3Bpbih2bWEsIDAsIDAsIFBJTl9VU0VSKTsKKwlpZiAoZXJyKQorCQlnb3RvIGVy
cl9vYmo7CisKKwljcyA9IGk5MTVfZ2VtX29iamVjdF9waW5fbWFwKG9iaiwgSTkxNV9NQVBfV0Mp
OworCWlmIChJU19FUlIoY3MpKQorCQlnb3RvIGVycl9vYmo7CisKKwkqY3MrKyA9IE1JX0FSQl9P
Tl9PRkYgfCBNSV9BUkJfRU5BQkxFOworCisJKmNzKysgPSBNSV9TRU1BUEhPUkVfV0FJVCB8CisJ
CU1JX1NFTUFQSE9SRV9QT0xMIHwKKwkJTUlfU0VNQVBIT1JFX1NBRF9FUV9TREQ7CisJKmNzKysg
PSAwOworCSpjcysrID0gbG93ZXJfMzJfYml0cyh2bWEtPm5vZGUuc3RhcnQpOworCSpjcysrID0g
dXBwZXJfMzJfYml0cyh2bWEtPm5vZGUuc3RhcnQpOworCisJaWYgKCpwcmV2KSB7CisJCXU2NCBv
ZmZzZXQgPSAoKnByZXYpLT5iYXRjaC0+bm9kZS5zdGFydDsKKworCQkqY3MrKyA9IE1JX1NUT1JF
X0RXT1JEX0lNTV9HRU40OworCQkqY3MrKyA9IGxvd2VyXzMyX2JpdHMob2Zmc2V0KTsKKwkJKmNz
KysgPSB1cHBlcl8zMl9iaXRzKG9mZnNldCk7CisJCSpjcysrID0gMDsKKwl9CisKKwkqY3MrKyA9
IE1JX0JBVENIX0JVRkZFUl9FTkQ7CisJaTkxNV9nZW1fb2JqZWN0X2ZsdXNoX21hcChvYmopOwor
CWk5MTVfZ2VtX29iamVjdF91bnBpbl9tYXAob2JqKTsKKworCXJxID0gaW50ZWxfY29udGV4dF9j
cmVhdGVfcmVxdWVzdChjZSk7CisJaWYgKElTX0VSUihycSkpCisJCWdvdG8gZXJyX29iajsKKwor
CXJxLT5iYXRjaCA9IHZtYTsKKwlpOTE1X3JlcXVlc3RfZ2V0KHJxKTsKKworCWk5MTVfdm1hX2xv
Y2sodm1hKTsKKwllcnIgPSBpOTE1X3JlcXVlc3RfYXdhaXRfb2JqZWN0KHJxLCB2bWEtPm9iaiwg
ZmFsc2UpOworCWlmICghZXJyKQorCQllcnIgPSBpOTE1X3ZtYV9tb3ZlX3RvX2FjdGl2ZSh2bWEs
IHJxLCAwKTsKKwlpZiAoIWVycikKKwkJZXJyID0gcnEtPmVuZ2luZS0+ZW1pdF9iYl9zdGFydChy
cSwKKwkJCQkJCXZtYS0+bm9kZS5zdGFydCwKKwkJCQkJCVBBR0VfU0laRSwgMCk7CisJaTkxNV92
bWFfdW5sb2NrKHZtYSk7CisJaTkxNV9yZXF1ZXN0X2FkZChycSk7CisJaWYgKGVycikKKwkJZ290
byBlcnJfcnE7CisKKwlpOTE1X2dlbV9vYmplY3RfcHV0KG9iaik7CisJaW50ZWxfY29udGV4dF9w
dXQoY2UpOworCisJcnEtPmNsaWVudF9saW5rLm5leHQgPSAmKCpwcmV2KS0+Y2xpZW50X2xpbms7
CisJKnByZXYgPSBycTsKKwlyZXR1cm4gMDsKKworZXJyX3JxOgorCWk5MTVfcmVxdWVzdF9wdXQo
cnEpOworZXJyX29iajoKKwlpOTE1X2dlbV9vYmplY3RfcHV0KG9iaik7CitlcnJfY2U6CisJaW50
ZWxfY29udGV4dF9wdXQoY2UpOworCXJldHVybiBlcnI7Cit9CisKK3N0YXRpYyBpbnQgbGl2ZV9w
cmVlbXB0X2dhbmcodm9pZCAqYXJnKQoreworCXN0cnVjdCBpbnRlbF9ndCAqZ3QgPSBhcmc7CisJ
c3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lOworCWVudW0gaW50ZWxfZW5naW5lX2lkIGlk
OworCisJaWYgKCFIQVNfTE9HSUNBTF9SSU5HX1BSRUVNUFRJT04oZ3QtPmk5MTUpKQorCQlyZXR1
cm4gMDsKKworCS8qCisJICogQnVpbGQgYXMgbG9uZyBhIGNoYWluIG9mIHByZWVtcHRlcnMgYXMg
d2UgY2FuLCB3aXRoIGVhY2gKKwkgKiByZXF1ZXN0IGhpZ2hlciBwcmlvcml0eSB0aGFuIHRoZSBs
YXN0LiBPbmNlIHdlIGdpdmUsIHdlIHJlbGVhc2UKKwkgKiB0aGUgbGFzdCBiYXRjaCB3aGljaCB0
aGVuIHByZWNvbGF0ZXMgZG93biB0aGUgY2hhaW4sIGVhY2ggcmVsZWFzaW5nCisJICogdGhlIG5l
eHQgb2xkZXN0LiBUaGUgaW50ZW50IGlzIHRvIHNpbXBseSBwdXNoIGFzIGhhcmQgYXMgd2UgY2Fu
CisJICogd2l0aCB0aGUgbnVtYmVyIG9mIHByZWVtcHRpb25zLCB0cnlpbmcgdG8gZXhjZWVkIG5h
cnJvdyBIVyBsaW1pdHMuCisJICogQXQgYSBtaW5pbXVtLCB3ZSBpbnNpc3QgdGhhdCB3ZSBjYW4g
c29ydCBhbGwgdGhlIHVzZXIgaGlnaAorCSAqIHByaW9yaXR5IGxldmVscyBpbnRvIGV4ZWN1dGlv
biBvcmRlci4KKwkgKi8KKworCWZvcl9lYWNoX2VuZ2luZShlbmdpbmUsIGd0LCBpZCkgeworCQlz
dHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSA9IE5VTEw7CisJCXN0cnVjdCBpZ3RfbGl2ZV90ZXN0IHQ7
CisJCUlHVF9USU1FT1VUKGVuZF90aW1lKTsKKwkJaW50IHByaW8gPSAwOworCQlpbnQgZXJyID0g
MDsKKwkJdTMyICpjczsKKworCQlpZiAoIWludGVsX2VuZ2luZV9oYXNfcHJlZW1wdGlvbihlbmdp
bmUpKQorCQkJY29udGludWU7CisKKwkJaWYgKGlndF9saXZlX3Rlc3RfYmVnaW4oJnQsIGd0LT5p
OTE1LCBfX2Z1bmNfXywgZW5naW5lLT5uYW1lKSkKKwkJCXJldHVybiAtRUlPOworCisJCWRvIHsK
KwkJCXN0cnVjdCBpOTE1X3NjaGVkX2F0dHIgYXR0ciA9IHsKKwkJCQkucHJpb3JpdHkgPSBJOTE1
X1VTRVJfUFJJT1JJVFkocHJpbysrKSwKKwkJCX07CisKKwkJCWVyciA9IGNyZWF0ZV9nYW5nKGVu
Z2luZSwgJnJxKTsKKwkJCWlmIChlcnIpCisJCQkJYnJlYWs7CisKKwkJCWVuZ2luZS0+c2NoZWR1
bGUocnEsICZhdHRyKTsKKworCQkJaWYgKHByaW8gPD0gSTkxNV9QUklPUklUWV9NQVgpCisJCQkJ
Y29udGludWU7CisKKwkJCWlmIChwcmlvID4gKElOVF9NQVggPj4gSTkxNV9VU0VSX1BSSU9SSVRZ
X1NISUZUKSkKKwkJCQlicmVhazsKKworCQkJaWYgKF9faWd0X3RpbWVvdXQoZW5kX3RpbWUsIE5V
TEwpKQorCQkJCWJyZWFrOworCQl9IHdoaWxlICgxKTsKKwkJcHJfZGVidWcoIiVzOiBQcmVlbXB0
IGNoYWluIG9mICVkIHJlcXVlc3RzXG4iLAorCQkJIGVuZ2luZS0+bmFtZSwgcHJpbyk7CisKKwkJ
Y3MgPSBpOTE1X2dlbV9vYmplY3RfcGluX21hcChycS0+YmF0Y2gtPm9iaiwgSTkxNV9NQVBfV0Mp
OworCQlpZiAoIUlTX0VSUihjcykpIHsKKwkJCSpjcyA9IDA7CisJCQlpOTE1X2dlbV9vYmplY3Rf
dW5waW5fbWFwKHJxLT5iYXRjaC0+b2JqKTsKKwkJfSBlbHNlIHsKKwkJCWVyciA9IFBUUl9FUlIo
Y3MpOworCQkJaW50ZWxfZ3Rfc2V0X3dlZGdlZChndCk7CisJCX0KKworCQlpZiAoZXJyID09IDAg
JiYgaTkxNV9yZXF1ZXN0X3dhaXQocnEsIDAsIEhaKSA8IDApIHsKKwkJCXN0cnVjdCBkcm1fcHJp
bnRlciBwID0KKwkJCQlkcm1faW5mb19wcmludGVyKGVuZ2luZS0+aTkxNS0+ZHJtLmRldik7CisK
KwkJCXByX2VycigiRmFpbGVkIHRvIGZsdXNoIGNoYWluIG9mICVkIHJlcXVlc3RzXG4iLCBwcmlv
KTsKKwkJCWludGVsX2VuZ2luZV9kdW1wKGVuZ2luZSwgJnAsCisJCQkJCSAgIiVzXG4iLCBlbmdp
bmUtPm5hbWUpOworCisJCQllcnIgPSAtRVRJTUU7CisJCX0KKworCQl3aGlsZSAocnEpIHsKKwkJ
CXN0cnVjdCBpOTE1X3JlcXVlc3QgKm4gPQorCQkJCWxpc3RfbmV4dF9lbnRyeShycSwgY2xpZW50
X2xpbmspOworCisJCQlpOTE1X3JlcXVlc3RfcHV0KHJxKTsKKwkJCXJxID0gbjsKKwkJfQorCisJ
CWlmIChpZ3RfbGl2ZV90ZXN0X2VuZCgmdCkpCisJCQllcnIgPSAtRUlPOworCQlpZiAoZXJyKQor
CQkJcmV0dXJuIGVycjsKKwl9CisKKwlyZXR1cm4gMDsKK30KKwogc3RhdGljIGludCBsaXZlX3By
ZWVtcHRfaGFuZyh2b2lkICphcmcpCiB7CiAJc3RydWN0IGludGVsX2d0ICpndCA9IGFyZzsKQEAg
LTMwMjgsNiArMzIxMyw3IEBAIGludCBpbnRlbF9leGVjbGlzdHNfbGl2ZV9zZWxmdGVzdHMoc3Ry
dWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCiAJCVNVQlRFU1QobGl2ZV9zdXBwcmVzc19zZWxm
X3ByZWVtcHQpLAogCQlTVUJURVNUKGxpdmVfc3VwcHJlc3Nfd2FpdF9wcmVlbXB0KSwKIAkJU1VC
VEVTVChsaXZlX2NoYWluX3ByZWVtcHQpLAorCQlTVUJURVNUKGxpdmVfcHJlZW1wdF9nYW5nKSwK
IAkJU1VCVEVTVChsaXZlX3ByZWVtcHRfaGFuZyksCiAJCVNVQlRFU1QobGl2ZV9wcmVlbXB0X3Rp
bWVvdXQpLAogCQlTVUJURVNUKGxpdmVfcHJlZW1wdF9zbW9rZSksCi0tIAoyLjI0LjAKCl9fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCkludGVsLWdmeCBtYWls
aW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZy
ZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWdmeA==

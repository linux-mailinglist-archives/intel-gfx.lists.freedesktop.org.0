Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id C271C10B65D
	for <lists+intel-gfx@lfdr.de>; Wed, 27 Nov 2019 20:06:19 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id B381B6E5A0;
	Wed, 27 Nov 2019 19:06:17 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mga17.intel.com (mga17.intel.com [192.55.52.151])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 6E1A16E4FE
 for <intel-gfx@lists.freedesktop.org>; Wed, 27 Nov 2019 19:06:13 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from fmsmga007.fm.intel.com ([10.253.24.52])
 by fmsmga107.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 27 Nov 2019 11:06:13 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.69,250,1571727600"; d="scan'208";a="206975088"
Received: from stinkbox.fi.intel.com (HELO stinkbox) ([10.237.72.174])
 by fmsmga007.fm.intel.com with SMTP; 27 Nov 2019 11:06:11 -0800
Received: by stinkbox (sSMTP sendmail emulation);
 Wed, 27 Nov 2019 21:06:10 +0200
From: Ville Syrjala <ville.syrjala@linux.intel.com>
To: intel-gfx@lists.freedesktop.org
Date: Wed, 27 Nov 2019 21:05:54 +0200
Message-Id: <20191127190556.1574-6-ville.syrjala@linux.intel.com>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20191127190556.1574-1-ville.syrjala@linux.intel.com>
References: <20191127190556.1574-1-ville.syrjala@linux.intel.com>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 5/7] drm/i915: Clean up the gen2 "no planes ->
 underrun" workaround
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

RnJvbTogVmlsbGUgU3lyasOkbMOkIDx2aWxsZS5zeXJqYWxhQGxpbnV4LmludGVsLmNvbT4KCldl
IGhhdmUgdGhlIGFjdGl2ZV9wbGFuZXMgYml0bWFzayBub3cgc28gdXNlIGl0IHRvIHByb3Blcmx5
CmRldGVybWluZSB3aGVuIHNvbWUgcGxhbmVzIGFyZSB2aXNpYmxlIGZvciB0aGUgZ2VuMiB1bmRl
cnJ1bgp3b3JrYXJvdW5kLgoKVGhpcyBsZXQncyB1cyBhbG1vc3QgZWxpbWluYXRlIGludGVsX3Bv
c3RfZW5hYmxlX3ByaW1hcnkoKS4KVGhlIG1hbnVhbCB1bmRlcnJ1biBjaGVja3Mgd2UgY2FuIHNp
bXBseSBtb3ZlIGludG8KaW50ZWxfYXRvbWljX2NvbW1pdF90YWlsKCkgc2luY2UgdGhleSBsb29w
IG92ZXIgYWxsIHRoZSBwaXBlcwphbHJlYWR5LiBObyBwb2ludCBpbiByZXBlYXRpbmcgdGhlIGNo
ZWNrcyBtdWx0aXBsZSB0aW1lcyB3aGVuCnRoZXJlIGFyZSBtdWx0aXBsZSBwaXBlcyBpbiB0aGUg
Y29tbWl0LgoKU2lnbmVkLW9mZi1ieTogVmlsbGUgU3lyasOkbMOkIDx2aWxsZS5zeXJqYWxhQGxp
bnV4LmludGVsLmNvbT4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9kaXNwbGF5L2ludGVsX2Rp
c3BsYXkuYyB8IDE1NSArKysrKysrKystLS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgNzAgaW5z
ZXJ0aW9ucygrKSwgODUgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJt
L2k5MTUvZGlzcGxheS9pbnRlbF9kaXNwbGF5LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9kaXNw
bGF5L2ludGVsX2Rpc3BsYXkuYwppbmRleCA3MjY1NWI1YjEzNjUuLjUzNjhmM2FiNzBhZiAxMDA2
NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZGlzcGxheS9pbnRlbF9kaXNwbGF5LmMKKysr
IGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZGlzcGxheS9pbnRlbF9kaXNwbGF5LmMKQEAgLTU5MDgs
MzcgKzU5MDgsNiBAQCBzdGF0aWMgdm9pZCBpbnRlbF9jcnRjX2RwbXNfb3ZlcmxheV9kaXNhYmxl
KHN0cnVjdCBpbnRlbF9jcnRjICppbnRlbF9jcnRjKQogCSAqLwogfQogCi0vKioKLSAqIGludGVs
X3Bvc3RfZW5hYmxlX3ByaW1hcnkgLSBQZXJmb3JtIG9wZXJhdGlvbnMgYWZ0ZXIgZW5hYmxpbmcg
cHJpbWFyeSBwbGFuZQotICogQGNydGM6IHRoZSBDUlRDIHdob3NlIHByaW1hcnkgcGxhbmUgd2Fz
IGp1c3QgZW5hYmxlZAotICogQG5ld19jcnRjX3N0YXRlOiB0aGUgZW5hYmxpbmcgc3RhdGUKLSAq
Ci0gKiBQZXJmb3JtcyBwb3RlbnRpYWxseSBzbGVlcGluZyBvcGVyYXRpb25zIHRoYXQgbXVzdCBi
ZSBkb25lIGFmdGVyIHRoZSBwcmltYXJ5Ci0gKiBwbGFuZSBpcyBlbmFibGVkLCBzdWNoIGFzIHVw
ZGF0aW5nIEZCQyBhbmQgSVBTLiAgTm90ZSB0aGF0IHRoaXMgbWF5IGJlCi0gKiBjYWxsZWQgZHVl
IHRvIGFuIGV4cGxpY2l0IHByaW1hcnkgcGxhbmUgdXBkYXRlLCBvciBkdWUgdG8gYW4gaW1wbGlj
aXQKLSAqIHJlLWVuYWJsZSB0aGF0IGlzIGNhdXNlZCB3aGVuIGEgc3ByaXRlIHBsYW5lIGlzIHVw
ZGF0ZWQgdG8gbm8gbG9uZ2VyCi0gKiBjb21wbGV0ZWx5IGhpZGUgdGhlIHByaW1hcnkgcGxhbmUu
Ci0gKi8KLXN0YXRpYyB2b2lkCi1pbnRlbF9wb3N0X2VuYWJsZV9wcmltYXJ5KHN0cnVjdCBpbnRl
bF9jcnRjICpjcnRjKQotewotCXN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiA9IHRv
X2k5MTUoY3J0Yy0+YmFzZS5kZXYpOwotCWVudW0gcGlwZSBwaXBlID0gY3J0Yy0+cGlwZTsKLQot
CS8qCi0JICogR2VuMiByZXBvcnRzIHBpcGUgdW5kZXJydW5zIHdoZW5ldmVyIGFsbCBwbGFuZXMg
YXJlIGRpc2FibGVkLgotCSAqIFNvIGRvbid0IGVuYWJsZSB1bmRlcnJ1biByZXBvcnRpbmcgYmVm
b3JlIGF0IGxlYXN0IHNvbWUgcGxhbmVzCi0JICogYXJlIGVuYWJsZWQuCi0JICogRklYTUU6IE5l
ZWQgdG8gZml4IHRoZSBsb2dpYyB0byB3b3JrIHdoZW4gd2UgdHVybiBvZmYgYWxsIHBsYW5lcwot
CSAqIGJ1dCBsZWF2ZSB0aGUgcGlwZSBydW5uaW5nLgotCSAqLwotCWlmIChJU19HRU4oZGV2X3By
aXYsIDIpKQotCQlpbnRlbF9zZXRfY3B1X2ZpZm9fdW5kZXJydW5fcmVwb3J0aW5nKGRldl9wcml2
LCBwaXBlLCB0cnVlKTsKLQotCS8qIFVuZGVycnVucyBkb24ndCBhbHdheXMgcmFpc2UgaW50ZXJy
dXB0cywgc28gY2hlY2sgbWFudWFsbHkuICovCi0JaW50ZWxfY2hlY2tfY3B1X2ZpZm9fdW5kZXJy
dW5zKGRldl9wcml2KTsKLQlpbnRlbF9jaGVja19wY2hfZmlmb191bmRlcnJ1bnMoZGV2X3ByaXYp
OwotfQogCiAvKiBGSVhNRSBnZXQgcmlkIG9mIHRoaXMgYW5kIHVzZSBwcmVfcGxhbmVfdXBkYXRl
ICovCiBzdGF0aWMgdm9pZApAQCAtNjA1OSw2ICs2MDI4LDIwIEBAIHN0YXRpYyBib29sIG5lZWRz
X3NjYWxlcmNsa193YShjb25zdCBzdHJ1Y3QgaW50ZWxfY3J0Y19zdGF0ZSAqY3J0Y19zdGF0ZSkK
IAlyZXR1cm4gZmFsc2U7CiB9CiAKK3N0YXRpYyBib29sIHBsYW5lc19lbmFibGluZyhjb25zdCBz
dHJ1Y3QgaW50ZWxfY3J0Y19zdGF0ZSAqb2xkX2NydGNfc3RhdGUsCisJCQkgICAgY29uc3Qgc3Ry
dWN0IGludGVsX2NydGNfc3RhdGUgKm5ld19jcnRjX3N0YXRlKQoreworCXJldHVybiAoIW9sZF9j
cnRjX3N0YXRlLT5hY3RpdmVfcGxhbmVzIHx8IG5lZWRzX21vZGVzZXQobmV3X2NydGNfc3RhdGUp
KSAmJgorCQluZXdfY3J0Y19zdGF0ZS0+YWN0aXZlX3BsYW5lczsKK30KKworc3RhdGljIGJvb2wg
cGxhbmVzX2Rpc2FibGluZyhjb25zdCBzdHJ1Y3QgaW50ZWxfY3J0Y19zdGF0ZSAqb2xkX2NydGNf
c3RhdGUsCisJCQkgICAgIGNvbnN0IHN0cnVjdCBpbnRlbF9jcnRjX3N0YXRlICpuZXdfY3J0Y19z
dGF0ZSkKK3sKKwlyZXR1cm4gb2xkX2NydGNfc3RhdGUtPmFjdGl2ZV9wbGFuZXMgJiYKKwkJKCFu
ZXdfY3J0Y19zdGF0ZS0+YWN0aXZlX3BsYW5lcyB8fCBuZWVkc19tb2Rlc2V0KG5ld19jcnRjX3N0
YXRlKSk7Cit9CisKIHN0YXRpYyB2b2lkIGludGVsX3Bvc3RfcGxhbmVfdXBkYXRlKHN0cnVjdCBp
bnRlbF9hdG9taWNfc3RhdGUgKnN0YXRlLAogCQkJCSAgICBzdHJ1Y3QgaW50ZWxfY3J0YyAqY3J0
YykKIHsKQEAgLTYwNjgsMTAgKzYwNTEsOSBAQCBzdGF0aWMgdm9pZCBpbnRlbF9wb3N0X3BsYW5l
X3VwZGF0ZShzdHJ1Y3QgaW50ZWxfYXRvbWljX3N0YXRlICpzdGF0ZSwKIAkJaW50ZWxfYXRvbWlj
X2dldF9vbGRfY3J0Y19zdGF0ZShzdGF0ZSwgY3J0Yyk7CiAJY29uc3Qgc3RydWN0IGludGVsX2Ny
dGNfc3RhdGUgKm5ld19jcnRjX3N0YXRlID0KIAkJaW50ZWxfYXRvbWljX2dldF9uZXdfY3J0Y19z
dGF0ZShzdGF0ZSwgY3J0Yyk7Ci0JY29uc3Qgc3RydWN0IGludGVsX3BsYW5lX3N0YXRlICpvbGRf
cHJpbWFyeV9zdGF0ZSA9Ci0JCWludGVsX2F0b21pY19nZXRfb2xkX3BsYW5lX3N0YXRlKHN0YXRl
LCBwcmltYXJ5KTsKIAljb25zdCBzdHJ1Y3QgaW50ZWxfcGxhbmVfc3RhdGUgKm5ld19wcmltYXJ5
X3N0YXRlID0KIAkJaW50ZWxfYXRvbWljX2dldF9uZXdfcGxhbmVfc3RhdGUoc3RhdGUsIHByaW1h
cnkpOworCWVudW0gcGlwZSBwaXBlID0gY3J0Yy0+cGlwZTsKIAogCWludGVsX2Zyb250YnVmZmVy
X2ZsaXAoZGV2X3ByaXYsIG5ld19jcnRjX3N0YXRlLT5mYl9iaXRzKTsKIApAQCAtNjA4MSwyMiAr
NjA2MywxNiBAQCBzdGF0aWMgdm9pZCBpbnRlbF9wb3N0X3BsYW5lX3VwZGF0ZShzdHJ1Y3QgaW50
ZWxfYXRvbWljX3N0YXRlICpzdGF0ZSwKIAlpZiAoaHN3X3Bvc3RfdXBkYXRlX2VuYWJsZV9pcHMo
b2xkX2NydGNfc3RhdGUsIG5ld19jcnRjX3N0YXRlKSkKIAkJaHN3X2VuYWJsZV9pcHMobmV3X2Ny
dGNfc3RhdGUpOwogCi0JaWYgKG5ld19wcmltYXJ5X3N0YXRlKSB7CisJaWYgKG5ld19wcmltYXJ5
X3N0YXRlKQogCQlpbnRlbF9mYmNfcG9zdF91cGRhdGUoY3J0Yyk7CiAKLQkJaWYgKG5ld19wcmlt
YXJ5X3N0YXRlLT51YXBpLnZpc2libGUgJiYKLQkJICAgIChuZWVkc19tb2Rlc2V0KG5ld19jcnRj
X3N0YXRlKSB8fAotCQkgICAgICFvbGRfcHJpbWFyeV9zdGF0ZS0+dWFwaS52aXNpYmxlKSkKLQkJ
CWludGVsX3Bvc3RfZW5hYmxlX3ByaW1hcnkoY3J0Yyk7Ci0JfQotCiAJaWYgKG5lZWRzX252MTJf
d2Eob2xkX2NydGNfc3RhdGUpICYmCiAJICAgICFuZWVkc19udjEyX3dhKG5ld19jcnRjX3N0YXRl
KSkKLQkJc2tsX3dhXzgyNyhkZXZfcHJpdiwgY3J0Yy0+cGlwZSwgZmFsc2UpOworCQlza2xfd2Ff
ODI3KGRldl9wcml2LCBwaXBlLCBmYWxzZSk7CiAKIAlpZiAobmVlZHNfc2NhbGVyY2xrX3dhKG9s
ZF9jcnRjX3N0YXRlKSAmJgogCSAgICAhbmVlZHNfc2NhbGVyY2xrX3dhKG5ld19jcnRjX3N0YXRl
KSkKLQkJaWNsX3dhX3NjYWxlcmNsa2dhdGluZyhkZXZfcHJpdiwgY3J0Yy0+cGlwZSwgZmFsc2Up
OworCQlpY2xfd2Ffc2NhbGVyY2xrZ2F0aW5nKGRldl9wcml2LCBwaXBlLCBmYWxzZSk7CiB9CiAK
IHN0YXRpYyB2b2lkIGludGVsX3ByZV9wbGFuZV91cGRhdGUoc3RydWN0IGludGVsX2F0b21pY19z
dGF0ZSAqc3RhdGUsCkBAIC02MTA4LDM1ICs2MDg0LDI1IEBAIHN0YXRpYyB2b2lkIGludGVsX3By
ZV9wbGFuZV91cGRhdGUoc3RydWN0IGludGVsX2F0b21pY19zdGF0ZSAqc3RhdGUsCiAJCWludGVs
X2F0b21pY19nZXRfb2xkX2NydGNfc3RhdGUoc3RhdGUsIGNydGMpOwogCWNvbnN0IHN0cnVjdCBp
bnRlbF9jcnRjX3N0YXRlICpuZXdfY3J0Y19zdGF0ZSA9CiAJCWludGVsX2F0b21pY19nZXRfbmV3
X2NydGNfc3RhdGUoc3RhdGUsIGNydGMpOwotCWNvbnN0IHN0cnVjdCBpbnRlbF9wbGFuZV9zdGF0
ZSAqb2xkX3ByaW1hcnlfc3RhdGUgPQotCQlpbnRlbF9hdG9taWNfZ2V0X29sZF9wbGFuZV9zdGF0
ZShzdGF0ZSwgcHJpbWFyeSk7CiAJY29uc3Qgc3RydWN0IGludGVsX3BsYW5lX3N0YXRlICpuZXdf
cHJpbWFyeV9zdGF0ZSA9CiAJCWludGVsX2F0b21pY19nZXRfbmV3X3BsYW5lX3N0YXRlKHN0YXRl
LCBwcmltYXJ5KTsKLQlib29sIG1vZGVzZXQgPSBuZWVkc19tb2Rlc2V0KG5ld19jcnRjX3N0YXRl
KTsKKwllbnVtIHBpcGUgcGlwZSA9IGNydGMtPnBpcGU7CiAKIAlpZiAoaHN3X3ByZV91cGRhdGVf
ZGlzYWJsZV9pcHMob2xkX2NydGNfc3RhdGUsIG5ld19jcnRjX3N0YXRlKSkKIAkJaHN3X2Rpc2Fi
bGVfaXBzKG9sZF9jcnRjX3N0YXRlKTsKIAotCWlmIChuZXdfcHJpbWFyeV9zdGF0ZSkgeworCWlm
IChuZXdfcHJpbWFyeV9zdGF0ZSkKIAkJaW50ZWxfZmJjX3ByZV91cGRhdGUoY3J0YywgbmV3X2Ny
dGNfc3RhdGUsIG5ld19wcmltYXJ5X3N0YXRlKTsKLQkJLyoKLQkJICogR2VuMiByZXBvcnRzIHBp
cGUgdW5kZXJydW5zIHdoZW5ldmVyIGFsbCBwbGFuZXMgYXJlIGRpc2FibGVkLgotCQkgKiBTbyBk
aXNhYmxlIHVuZGVycnVuIHJlcG9ydGluZyBiZWZvcmUgYWxsIHRoZSBwbGFuZXMgZ2V0IGRpc2Fi
bGVkLgotCQkgKi8KLQkJaWYgKElTX0dFTihkZXZfcHJpdiwgMikgJiYgb2xkX3ByaW1hcnlfc3Rh
dGUtPnVhcGkudmlzaWJsZSAmJgotCQkgICAgKG1vZGVzZXQgfHwgIW5ld19wcmltYXJ5X3N0YXRl
LT51YXBpLnZpc2libGUpKQotCQkJaW50ZWxfc2V0X2NwdV9maWZvX3VuZGVycnVuX3JlcG9ydGlu
ZyhkZXZfcHJpdiwgY3J0Yy0+cGlwZSwgZmFsc2UpOwotCX0KIAogCS8qIERpc3BsYXkgV0EgODI3
ICovCiAJaWYgKCFuZWVkc19udjEyX3dhKG9sZF9jcnRjX3N0YXRlKSAmJgogCSAgICBuZWVkc19u
djEyX3dhKG5ld19jcnRjX3N0YXRlKSkKLQkJc2tsX3dhXzgyNyhkZXZfcHJpdiwgY3J0Yy0+cGlw
ZSwgdHJ1ZSk7CisJCXNrbF93YV84MjcoZGV2X3ByaXYsIHBpcGUsIHRydWUpOwogCiAJLyogV2Ff
MjAwNjYwNDMxMjppY2wgKi8KIAlpZiAoIW5lZWRzX3NjYWxlcmNsa193YShvbGRfY3J0Y19zdGF0
ZSkgJiYKIAkgICAgbmVlZHNfc2NhbGVyY2xrX3dhKG5ld19jcnRjX3N0YXRlKSkKLQkJaWNsX3dh
X3NjYWxlcmNsa2dhdGluZyhkZXZfcHJpdiwgY3J0Yy0+cGlwZSwgdHJ1ZSk7CisJCWljbF93YV9z
Y2FsZXJjbGtnYXRpbmcoZGV2X3ByaXYsIHBpcGUsIHRydWUpOwogCiAJLyoKIAkgKiBWYmxhbmsg
dGltZSB1cGRhdGVzIGZyb20gdGhlIHNoYWRvdyB0byBsaXZlIHBsYW5lIGNvbnRyb2wgcmVnaXN0
ZXIKQEAgLTYxNDksNyArNjExNSw3IEBAIHN0YXRpYyB2b2lkIGludGVsX3ByZV9wbGFuZV91cGRh
dGUoc3RydWN0IGludGVsX2F0b21pY19zdGF0ZSAqc3RhdGUsCiAJICovCiAJaWYgKEhBU19HTUNI
KGRldl9wcml2KSAmJiBvbGRfY3J0Y19zdGF0ZS0+aHcuYWN0aXZlICYmCiAJICAgIG5ld19jcnRj
X3N0YXRlLT5kaXNhYmxlX2N4c3IgJiYgaW50ZWxfc2V0X21lbW9yeV9jeHNyKGRldl9wcml2LCBm
YWxzZSkpCi0JCWludGVsX3dhaXRfZm9yX3ZibGFuayhkZXZfcHJpdiwgY3J0Yy0+cGlwZSk7CisJ
CWludGVsX3dhaXRfZm9yX3ZibGFuayhkZXZfcHJpdiwgcGlwZSk7CiAKIAkvKgogCSAqIElWQiB3
b3JrYXJvdW5kOiBtdXN0IGRpc2FibGUgbG93IHBvd2VyIHdhdGVybWFya3MgZm9yIGF0IGxlYXN0
CkBAIC02MTYwLDMzICs2MTI2LDQzIEBAIHN0YXRpYyB2b2lkIGludGVsX3ByZV9wbGFuZV91cGRh
dGUoc3RydWN0IGludGVsX2F0b21pY19zdGF0ZSAqc3RhdGUsCiAJICovCiAJaWYgKG9sZF9jcnRj
X3N0YXRlLT5ody5hY3RpdmUgJiYKIAkgICAgbmV3X2NydGNfc3RhdGUtPmRpc2FibGVfbHBfd20g
JiYgaWxrX2Rpc2FibGVfbHBfd20oZGV2X3ByaXYpKQotCQlpbnRlbF93YWl0X2Zvcl92Ymxhbmso
ZGV2X3ByaXYsIGNydGMtPnBpcGUpOworCQlpbnRlbF93YWl0X2Zvcl92YmxhbmsoZGV2X3ByaXYs
IHBpcGUpOwogCiAJLyoKLQkgKiBJZiB3ZSdyZSBkb2luZyBhIG1vZGVzZXQsIHdlJ3JlIGRvbmUu
ICBObyBuZWVkIHRvIGRvIGFueSBwcmUtdmJsYW5rCi0JICogd2F0ZXJtYXJrIHByb2dyYW1taW5n
IGhlcmUuCisJICogSWYgd2UncmUgZG9pbmcgYSBtb2Rlc2V0IHdlIGRvbid0IG5lZWQgdG8gZG8g
YW55CisJICogcHJlLXZibGFuayB3YXRlcm1hcmsgcHJvZ3JhbW1pbmcgaGVyZS4KIAkgKi8KLQlp
ZiAobmVlZHNfbW9kZXNldChuZXdfY3J0Y19zdGF0ZSkpCi0JCXJldHVybjsKKwlpZiAoIW5lZWRz
X21vZGVzZXQobmV3X2NydGNfc3RhdGUpKSB7CisJCS8qCisJCSAqIEZvciBwbGF0Zm9ybXMgdGhh
dCBzdXBwb3J0IGF0b21pYyB3YXRlcm1hcmtzLCBwcm9ncmFtIHRoZQorCQkgKiAnaW50ZXJtZWRp
YXRlJyB3YXRlcm1hcmtzIGltbWVkaWF0ZWx5LiAgT24gcHJlLWdlbjkgcGxhdGZvcm1zLCB0aGVz
ZQorCQkgKiB3aWxsIGJlIHRoZSBpbnRlcm1lZGlhdGUgdmFsdWVzIHRoYXQgYXJlIHNhZmUgZm9y
IGJvdGggcHJlLSBhbmQKKwkJICogcG9zdC0gdmJsYW5rOyB3aGVuIHZibGFuayBoYXBwZW5zLCB0
aGUgJ2FjdGl2ZScgdmFsdWVzIHdpbGwgYmUgc2V0CisJCSAqIHRvIHRoZSBmaW5hbCAndGFyZ2V0
JyB2YWx1ZXMgYW5kIHdlJ2xsIGRvIHRoaXMgYWdhaW4gdG8gZ2V0IHRoZQorCQkgKiBvcHRpbWFs
IHdhdGVybWFya3MuICBGb3IgZ2VuOSsgcGxhdGZvcm1zLCB0aGUgdmFsdWVzIHdlIHByb2dyYW0g
aGVyZQorCQkgKiB3aWxsIGJlIHRoZSBmaW5hbCB0YXJnZXQgdmFsdWVzIHdoaWNoIHdpbGwgZ2V0
IGF1dG9tYXRpY2FsbHkgbGF0Y2hlZAorCQkgKiBhdCB2YmxhbmsgdGltZTsgbm8gZnVydGhlciBw
cm9ncmFtbWluZyB3aWxsIGJlIG5lY2Vzc2FyeS4KKwkJICoKKwkJICogSWYgYSBwbGF0Zm9ybSBo
YXNuJ3QgYmVlbiB0cmFuc2l0aW9uZWQgdG8gYXRvbWljIHdhdGVybWFya3MgeWV0LAorCQkgKiB3
ZSdsbCBjb250aW51ZSB0byB1cGRhdGUgd2F0ZXJtYXJrcyB0aGUgb2xkIHdheSwgaWYgZmxhZ3Mg
dGVsbAorCQkgKiB1cyB0by4KKwkJICovCisJCWlmIChkZXZfcHJpdi0+ZGlzcGxheS5pbml0aWFs
X3dhdGVybWFya3MpCisJCQlkZXZfcHJpdi0+ZGlzcGxheS5pbml0aWFsX3dhdGVybWFya3Moc3Rh
dGUsIGNydGMpOworCQllbHNlIGlmIChuZXdfY3J0Y19zdGF0ZS0+dXBkYXRlX3dtX3ByZSkKKwkJ
CWludGVsX3VwZGF0ZV93YXRlcm1hcmtzKGNydGMpOworCX0KIAogCS8qCi0JICogRm9yIHBsYXRm
b3JtcyB0aGF0IHN1cHBvcnQgYXRvbWljIHdhdGVybWFya3MsIHByb2dyYW0gdGhlCi0JICogJ2lu
dGVybWVkaWF0ZScgd2F0ZXJtYXJrcyBpbW1lZGlhdGVseS4gIE9uIHByZS1nZW45IHBsYXRmb3Jt
cywgdGhlc2UKLQkgKiB3aWxsIGJlIHRoZSBpbnRlcm1lZGlhdGUgdmFsdWVzIHRoYXQgYXJlIHNh
ZmUgZm9yIGJvdGggcHJlLSBhbmQKLQkgKiBwb3N0LSB2Ymxhbms7IHdoZW4gdmJsYW5rIGhhcHBl
bnMsIHRoZSAnYWN0aXZlJyB2YWx1ZXMgd2lsbCBiZSBzZXQKLQkgKiB0byB0aGUgZmluYWwgJ3Rh
cmdldCcgdmFsdWVzIGFuZCB3ZSdsbCBkbyB0aGlzIGFnYWluIHRvIGdldCB0aGUKLQkgKiBvcHRp
bWFsIHdhdGVybWFya3MuICBGb3IgZ2VuOSsgcGxhdGZvcm1zLCB0aGUgdmFsdWVzIHdlIHByb2dy
YW0gaGVyZQotCSAqIHdpbGwgYmUgdGhlIGZpbmFsIHRhcmdldCB2YWx1ZXMgd2hpY2ggd2lsbCBn
ZXQgYXV0b21hdGljYWxseSBsYXRjaGVkCi0JICogYXQgdmJsYW5rIHRpbWU7IG5vIGZ1cnRoZXIg
cHJvZ3JhbW1pbmcgd2lsbCBiZSBuZWNlc3NhcnkuCisJICogR2VuMiByZXBvcnRzIHBpcGUgdW5k
ZXJydW5zIHdoZW5ldmVyIGFsbCBwbGFuZXMgYXJlIGRpc2FibGVkLgorCSAqIFNvIGRpc2FibGUg
dW5kZXJydW4gcmVwb3J0aW5nIGJlZm9yZSBhbGwgdGhlIHBsYW5lcyBnZXQgZGlzYWJsZWQuCiAJ
ICoKLQkgKiBJZiBhIHBsYXRmb3JtIGhhc24ndCBiZWVuIHRyYW5zaXRpb25lZCB0byBhdG9taWMg
d2F0ZXJtYXJrcyB5ZXQsCi0JICogd2UnbGwgY29udGludWUgdG8gdXBkYXRlIHdhdGVybWFya3Mg
dGhlIG9sZCB3YXksIGlmIGZsYWdzIHRlbGwKLQkgKiB1cyB0by4KKwkgKiBXZSBkbyB0aGlzIGFm
dGVyIC5pbml0aWFsX3dhdGVybWFya3MoKSBzbyB0aGF0IHdlIGhhdmUgYQorCSAqIGNoYW5jZSBv
ZiBjYXRjaGluZyB1bmRlcnJ1bnMgd2l0aCB0aGUgaW50ZXJtZWRpYXRlIHdhdGVybWFya3MKKwkg
KiB2cy4gdGhlIG9sZCBwbGFuZSBjb25maWd1cmF0aW9uLgogCSAqLwotCWlmIChkZXZfcHJpdi0+
ZGlzcGxheS5pbml0aWFsX3dhdGVybWFya3MpCi0JCWRldl9wcml2LT5kaXNwbGF5LmluaXRpYWxf
d2F0ZXJtYXJrcyhzdGF0ZSwgY3J0Yyk7Ci0JZWxzZSBpZiAobmV3X2NydGNfc3RhdGUtPnVwZGF0
ZV93bV9wcmUpCi0JCWludGVsX3VwZGF0ZV93YXRlcm1hcmtzKGNydGMpOworCWlmIChJU19HRU4o
ZGV2X3ByaXYsIDIpICYmIHBsYW5lc19kaXNhYmxpbmcob2xkX2NydGNfc3RhdGUsIG5ld19jcnRj
X3N0YXRlKSkKKwkJaW50ZWxfc2V0X2NwdV9maWZvX3VuZGVycnVuX3JlcG9ydGluZyhkZXZfcHJp
diwgcGlwZSwgZmFsc2UpOwogfQogCiBzdGF0aWMgdm9pZCBpbnRlbF9jcnRjX2Rpc2FibGVfcGxh
bmVzKHN0cnVjdCBpbnRlbF9hdG9taWNfc3RhdGUgKnN0YXRlLApAQCAtMTQ0MjMsMTMgKzE0Mzk5
LDYgQEAgc3RhdGljIHZvaWQgaW50ZWxfb2xkX2NydGNfc3RhdGVfZGlzYWJsZXMoc3RydWN0IGlu
dGVsX2F0b21pY19zdGF0ZSAqc3RhdGUsCiAJaW50ZWxfZmJjX2Rpc2FibGUoY3J0Yyk7CiAJaW50
ZWxfZGlzYWJsZV9zaGFyZWRfZHBsbChvbGRfY3J0Y19zdGF0ZSk7CiAKLQkvKgotCSAqIFVuZGVy
cnVucyBkb24ndCBhbHdheXMgcmFpc2UgaW50ZXJydXB0cywKLQkgKiBzbyBjaGVjayBtYW51YWxs
eS4KLQkgKi8KLQlpbnRlbF9jaGVja19jcHVfZmlmb191bmRlcnJ1bnMoZGV2X3ByaXYpOwotCWlu
dGVsX2NoZWNrX3BjaF9maWZvX3VuZGVycnVucyhkZXZfcHJpdik7Ci0KIAkvKiBGSVhNRSB1bmlm
eSB0aGlzIGZvciBhbGwgcGxhdGZvcm1zICovCiAJaWYgKCFuZXdfY3J0Y19zdGF0ZS0+aHcuYWN0
aXZlICYmCiAJICAgICFIQVNfR01DSChkZXZfcHJpdikgJiYKQEAgLTE0ODgyLDcgKzE0ODUxLDE5
IEBAIHN0YXRpYyB2b2lkIGludGVsX2F0b21pY19jb21taXRfdGFpbChzdHJ1Y3QgaW50ZWxfYXRv
bWljX3N0YXRlICpzdGF0ZSkKIAkgKgogCSAqIFRPRE86IE1vdmUgdGhpcyAoYW5kIG90aGVyIGNs
ZWFudXApIHRvIGFuIGFzeW5jIHdvcmtlciBldmVudHVhbGx5LgogCSAqLwotCWZvcl9lYWNoX25l
d19pbnRlbF9jcnRjX2luX3N0YXRlKHN0YXRlLCBjcnRjLCBuZXdfY3J0Y19zdGF0ZSwgaSkgewor
CWZvcl9lYWNoX29sZG5ld19pbnRlbF9jcnRjX2luX3N0YXRlKHN0YXRlLCBjcnRjLCBvbGRfY3J0
Y19zdGF0ZSwKKwkJCQkJICAgIG5ld19jcnRjX3N0YXRlLCBpKSB7CisJCS8qCisJCSAqIEdlbjIg
cmVwb3J0cyBwaXBlIHVuZGVycnVucyB3aGVuZXZlciBhbGwgcGxhbmVzIGFyZSBkaXNhYmxlZC4K
KwkJICogU28gcmUtZW5hYmxlIHVuZGVycnVuIHJlcG9ydGluZyBhZnRlciBzb21lIHBsYW5lcyBn
ZXQgZW5hYmxlZC4KKwkJICoKKwkJICogV2UgZG8gdGhpcyBiZWZvcmUgLm9wdGltaXplX3dhdGVy
bWFya3MoKSBzbyB0aGF0IHdlIGhhdmUgYQorCQkgKiBjaGFuY2Ugb2YgY2F0Y2hpbmcgdW5kZXJy
dW5zIHdpdGggdGhlIGludGVybWVkaWF0ZSB3YXRlcm1hcmtzCisJCSAqIHZzLiB0aGUgbmV3IHBs
YW5lIGNvbmZpZ3VyYXRpb24uCisJCSAqLworCQlpZiAoSVNfR0VOKGRldl9wcml2LCAyKSAmJiBw
bGFuZXNfZW5hYmxpbmcob2xkX2NydGNfc3RhdGUsIG5ld19jcnRjX3N0YXRlKSkKKwkJCWludGVs
X3NldF9jcHVfZmlmb191bmRlcnJ1bl9yZXBvcnRpbmcoZGV2X3ByaXYsIGNydGMtPnBpcGUsIHRy
dWUpOworCiAJCWlmIChkZXZfcHJpdi0+ZGlzcGxheS5vcHRpbWl6ZV93YXRlcm1hcmtzKQogCQkJ
ZGV2X3ByaXYtPmRpc3BsYXkub3B0aW1pemVfd2F0ZXJtYXJrcyhzdGF0ZSwgY3J0Yyk7CiAJfQpA
QCAtMTQ4OTYsNiArMTQ4NzcsMTAgQEAgc3RhdGljIHZvaWQgaW50ZWxfYXRvbWljX2NvbW1pdF90
YWlsKHN0cnVjdCBpbnRlbF9hdG9taWNfc3RhdGUgKnN0YXRlKQogCQlpbnRlbF9tb2Rlc2V0X3Zl
cmlmeV9jcnRjKGNydGMsIHN0YXRlLCBvbGRfY3J0Y19zdGF0ZSwgbmV3X2NydGNfc3RhdGUpOwog
CX0KIAorCS8qIFVuZGVycnVucyBkb24ndCBhbHdheXMgcmFpc2UgaW50ZXJydXB0cywgc28gY2hl
Y2sgbWFudWFsbHkgKi8KKwlpbnRlbF9jaGVja19jcHVfZmlmb191bmRlcnJ1bnMoZGV2X3ByaXYp
OworCWludGVsX2NoZWNrX3BjaF9maWZvX3VuZGVycnVucyhkZXZfcHJpdik7CisKIAlpZiAoc3Rh
dGUtPm1vZGVzZXQpCiAJCWludGVsX3ZlcmlmeV9wbGFuZXMoc3RhdGUpOwogCi0tIAoyLjIzLjAK
Cl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCkludGVsLWdm
eCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xp
c3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWdmeA==

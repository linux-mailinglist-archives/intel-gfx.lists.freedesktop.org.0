Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id E764F63351
	for <lists+intel-gfx@lfdr.de>; Tue,  9 Jul 2019 11:12:54 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 5D73789FCA;
	Tue,  9 Jul 2019 09:12:53 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id E9F4589FCA
 for <intel-gfx@lists.freedesktop.org>; Tue,  9 Jul 2019 09:12:51 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17180596-1500050 
 for multiple; Tue, 09 Jul 2019 10:12:34 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Tue,  9 Jul 2019 10:12:33 +0100
Message-Id: <20190709091233.8573-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.22.0
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH] drm/i915/execlists: Disable preemption under GVT
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

UHJlZW1wdC10by1idXN5IHVzZXMgYSBHUFUgc2VtYXBob3JlIHRvIGVuZm9yY2UgYW4gaWRsZS1i
YXJyaWVyIGFjcm9zcwpwcmVlbXB0aW9uLCBidXQgbWVkaWF0ZWQgZ3Z0IGRvZXMgbm90IGZ1bGx5
IHN1cHBvcnQgc2VtYXBob3Jlcy4KCnYyOiBGaWRkbGUgYXJvdW5kIHdpdGggdGhlIGZsYWdzIGFu
ZCBzZXR0bGUgb24gdXNpbmcgaGFzLXNlbWFwaG9yZXMgZm9yCnRoZSBjb3JlIGJpdHMgc28gdGhh
dCB3ZSByZXRhaW4gdGhlIGFiaWxpdHkgdG8gcHJlZW1wdCBvdXIgb3duCnNlbWFwaG9yZXMuCgpT
aWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KQ2M6
IFpoZW55dSBXYW5nIDx6aGVueXV3QGxpbnV4LmludGVsLmNvbT4KQ2M6IFhpYW9saW4gWmhhbmcg
PHhpYW9saW4uemhhbmdAaW50ZWwuY29tPgpDYzogVHZydGtvIFVyc3VsaW4gPHR2cnRrby51cnN1
bGluQGludGVsLmNvbT4KQ2M6IE1pa2EgS3VvcHBhbGEgPG1pa2Eua3VvcHBhbGFAbGludXguaW50
ZWwuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZV9jcy5jIHwg
IDQgKystLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjLmMgICAgICAgfCAyNCAr
KysrKysrKysrKysrKysrKy0tLS0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Qvc2VsZnRlc3Rf
bHJjLmMgICAgfCAgNiArKysrKysKIDMgZmlsZXMgY2hhbmdlZCwgMjYgaW5zZXJ0aW9ucygrKSwg
OCBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRl
bF9lbmdpbmVfY3MuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZV9jcy5j
CmluZGV4IDU2MzEwODEyZGEyMS4uNjE0ZWQ4YzQ4OGVmIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfY3MuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9ndC9pbnRlbF9lbmdpbmVfY3MuYwpAQCAtODI1LDYgKzgyNSw4IEBAIGludCBpbnRlbF9lbmdp
bmVfaW5pdF9jb21tb24oc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lKQogCXN0cnVjdCBk
cm1faTkxNV9wcml2YXRlICppOTE1ID0gZW5naW5lLT5pOTE1OwogCWludCByZXQ7CiAKKwllbmdp
bmUtPnNldF9kZWZhdWx0X3N1Ym1pc3Npb24oZW5naW5lKTsKKwogCS8qIFdlIG1heSBuZWVkIHRv
IGRvIHRoaW5ncyB3aXRoIHRoZSBzaHJpbmtlciB3aGljaAogCSAqIHJlcXVpcmUgdXMgdG8gaW1t
ZWRpYXRlbHkgc3dpdGNoIGJhY2sgdG8gdGhlIGRlZmF1bHQKIAkgKiBjb250ZXh0LiBUaGlzIGNh
biBjYXVzZSBhIHByb2JsZW0gYXMgcGlubmluZyB0aGUKQEAgLTg1Miw4ICs4NTQsNiBAQCBpbnQg
aW50ZWxfZW5naW5lX2luaXRfY29tbW9uKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkK
IAogCWVuZ2luZS0+ZW1pdF9maW5pX2JyZWFkY3J1bWJfZHcgPSByZXQ7CiAKLQllbmdpbmUtPnNl
dF9kZWZhdWx0X3N1Ym1pc3Npb24oZW5naW5lKTsKLQogCXJldHVybiAwOwogCiBlcnJfdW5waW46
CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9scmMuYyBiL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2xyYy5jCmluZGV4IDU1OGE1ODUwZGUzYy4uZWYzNmY0
YjVlMjEyIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9scmMuYwor
KysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9scmMuYwpAQCAtMjk1LDYgKzI5NSw5
IEBAIHN0YXRpYyBpbmxpbmUgYm9vbCBuZWVkX3ByZWVtcHQoY29uc3Qgc3RydWN0IGludGVsX2Vu
Z2luZV9jcyAqZW5naW5lLAogewogCWludCBsYXN0X3ByaW87CiAKKwlpZiAoIWludGVsX2VuZ2lu
ZV9oYXNfc2VtYXBob3JlcyhlbmdpbmUpKQorCQlyZXR1cm4gZmFsc2U7CisKIAkvKgogCSAqIENo
ZWNrIGlmIHRoZSBjdXJyZW50IHByaW9yaXR5IGhpbnQgbWVyaXRzIGEgcHJlZW1wdGlvbiBhdHRl
bXB0LgogCSAqCkBAIC04OTMsNiArODk2LDkgQEAgbmVlZF90aW1lc2xpY2Uoc3RydWN0IGludGVs
X2VuZ2luZV9jcyAqZW5naW5lLCBjb25zdCBzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSkKIHsKIAlp
bnQgaGludDsKIAorCWlmICghaW50ZWxfZW5naW5lX2hhc19zZW1hcGhvcmVzKGVuZ2luZSkpCisJ
CXJldHVybiBmYWxzZTsKKwogCWlmIChsaXN0X2lzX2xhc3QoJnJxLT5zY2hlZC5saW5rLCAmZW5n
aW5lLT5hY3RpdmUucmVxdWVzdHMpKQogCQlyZXR1cm4gZmFsc2U7CiAKQEAgLTI2MzQsNyArMjY0
MCw4IEBAIHN0YXRpYyB1MzIgKmdlbjhfZW1pdF9maW5pX2JyZWFkY3J1bWIoc3RydWN0IGk5MTVf
cmVxdWVzdCAqcmVxdWVzdCwgdTMyICpjcykKIAkqY3MrKyA9IE1JX1VTRVJfSU5URVJSVVBUOwog
CiAJKmNzKysgPSBNSV9BUkJfT05fT0ZGIHwgTUlfQVJCX0VOQUJMRTsKLQljcyA9IGVtaXRfcHJl
ZW1wdF9idXN5d2FpdChyZXF1ZXN0LCBjcyk7CisJaWYgKGludGVsX2VuZ2luZV9oYXNfc2VtYXBo
b3JlcyhyZXF1ZXN0LT5lbmdpbmUpKQorCQljcyA9IGVtaXRfcHJlZW1wdF9idXN5d2FpdChyZXF1
ZXN0LCBjcyk7CiAKIAlyZXF1ZXN0LT50YWlsID0gaW50ZWxfcmluZ19vZmZzZXQocmVxdWVzdCwg
Y3MpOwogCWFzc2VydF9yaW5nX3RhaWxfdmFsaWQocmVxdWVzdC0+cmluZywgcmVxdWVzdC0+dGFp
bCk7CkBAIC0yNjU4LDcgKzI2NjUsOCBAQCBzdGF0aWMgdTMyICpnZW44X2VtaXRfZmluaV9icmVh
ZGNydW1iX3JjcyhzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpyZXF1ZXN0LCB1MzIgKmNzKQogCSpjcysr
ID0gTUlfVVNFUl9JTlRFUlJVUFQ7CiAKIAkqY3MrKyA9IE1JX0FSQl9PTl9PRkYgfCBNSV9BUkJf
RU5BQkxFOwotCWNzID0gZW1pdF9wcmVlbXB0X2J1c3l3YWl0KHJlcXVlc3QsIGNzKTsKKwlpZiAo
aW50ZWxfZW5naW5lX2hhc19zZW1hcGhvcmVzKHJlcXVlc3QtPmVuZ2luZSkpCisJCWNzID0gZW1p
dF9wcmVlbXB0X2J1c3l3YWl0KHJlcXVlc3QsIGNzKTsKIAogCXJlcXVlc3QtPnRhaWwgPSBpbnRl
bF9yaW5nX29mZnNldChyZXF1ZXN0LCBjcyk7CiAJYXNzZXJ0X3JpbmdfdGFpbF92YWxpZChyZXF1
ZXN0LT5yaW5nLCByZXF1ZXN0LT50YWlsKTsKQEAgLTI3MDYsMTAgKzI3MTQsMTEgQEAgdm9pZCBp
bnRlbF9leGVjbGlzdHNfc2V0X2RlZmF1bHRfc3VibWlzc2lvbihzdHJ1Y3QgaW50ZWxfZW5naW5l
X2NzICplbmdpbmUpCiAJZW5naW5lLT51bnBhcmsgPSBOVUxMOwogCiAJZW5naW5lLT5mbGFncyB8
PSBJOTE1X0VOR0lORV9TVVBQT1JUU19TVEFUUzsKLQlpZiAoIWludGVsX3ZncHVfYWN0aXZlKGVu
Z2luZS0+aTkxNSkpCisJaWYgKCFpbnRlbF92Z3B1X2FjdGl2ZShlbmdpbmUtPmk5MTUpKSB7CiAJ
CWVuZ2luZS0+ZmxhZ3MgfD0gSTkxNV9FTkdJTkVfSEFTX1NFTUFQSE9SRVM7Ci0JaWYgKEhBU19M
T0dJQ0FMX1JJTkdfUFJFRU1QVElPTihlbmdpbmUtPmk5MTUpKQotCQllbmdpbmUtPmZsYWdzIHw9
IEk5MTVfRU5HSU5FX0hBU19QUkVFTVBUSU9OOworCQlpZiAoSEFTX0xPR0lDQUxfUklOR19QUkVF
TVBUSU9OKGVuZ2luZS0+aTkxNSkpCisJCQllbmdpbmUtPmZsYWdzIHw9IEk5MTVfRU5HSU5FX0hB
U19QUkVFTVBUSU9OOworCX0KIH0KIAogc3RhdGljIHZvaWQgZXhlY2xpc3RzX2Rlc3Ryb3koc3Ry
dWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lKQpAQCAtMzM5OSw3ICszNDA4LDYgQEAgaW50ZWxf
ZXhlY2xpc3RzX2NyZWF0ZV92aXJ0dWFsKHN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICpjdHgsCiAJ
dmUtPmJhc2UuY2xhc3MgPSBPVEhFUl9DTEFTUzsKIAl2ZS0+YmFzZS51YWJpX2NsYXNzID0gSTkx
NV9FTkdJTkVfQ0xBU1NfSU5WQUxJRDsKIAl2ZS0+YmFzZS5pbnN0YW5jZSA9IEk5MTVfRU5HSU5F
X0NMQVNTX0lOVkFMSURfVklSVFVBTDsKLQl2ZS0+YmFzZS5mbGFncyA9IEk5MTVfRU5HSU5FX0lT
X1ZJUlRVQUw7CiAKIAkvKgogCSAqIFRoZSBkZWNpc2lvbiBvbiB3aGV0aGVyIHRvIHN1Ym1pdCBh
IHJlcXVlc3QgdXNpbmcgc2VtYXBob3JlcwpAQCAtMzQ5Niw4ICszNTA0LDEyIEBAIGludGVsX2V4
ZWNsaXN0c19jcmVhdGVfdmlydHVhbChzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4LAogCQl2
ZS0+YmFzZS5lbWl0X2ZpbmlfYnJlYWRjcnVtYiA9IHNpYmxpbmctPmVtaXRfZmluaV9icmVhZGNy
dW1iOwogCQl2ZS0+YmFzZS5lbWl0X2ZpbmlfYnJlYWRjcnVtYl9kdyA9CiAJCQlzaWJsaW5nLT5l
bWl0X2ZpbmlfYnJlYWRjcnVtYl9kdzsKKworCQl2ZS0+YmFzZS5mbGFncyA9IHNpYmxpbmctPmZs
YWdzOwogCX0KIAorCXZlLT5iYXNlLmZsYWdzIHw9IEk5MTVfRU5HSU5FX0lTX1ZJUlRVQUw7CisK
IAlyZXR1cm4gJnZlLT5jb250ZXh0OwogCiBlcnJfcHV0OgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9n
cHUvZHJtL2k5MTUvZ3Qvc2VsZnRlc3RfbHJjLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9z
ZWxmdGVzdF9scmMuYwppbmRleCBmZTRlMTVmOWJhOWQuLmExM2YwNmJhOTg0YiAxMDA2NDQKLS0t
IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Qvc2VsZnRlc3RfbHJjLmMKKysrIGIvZHJpdmVycy9n
cHUvZHJtL2k5MTUvZ3Qvc2VsZnRlc3RfbHJjLmMKQEAgLTI2OSw2ICsyNjksOSBAQCBzdGF0aWMg
aW50IGxpdmVfdGltZXNsaWNlX3ByZWVtcHQodm9pZCAqYXJnKQogCQllbnVtIGludGVsX2VuZ2lu
ZV9pZCBpZDsKIAogCQlmb3JfZWFjaF9lbmdpbmUoZW5naW5lLCBpOTE1LCBpZCkgeworCQkJaWYg
KCFpbnRlbF9lbmdpbmVfaGFzX3ByZWVtcHRpb24oZW5naW5lKSkKKwkJCQljb250aW51ZTsKKwog
CQkJbWVtc2V0KHZhZGRyLCAwLCBQQUdFX1NJWkUpOwogCiAJCQllcnIgPSBzbGljZV9zZW1hcGhv
cmVfcXVldWUoZW5naW5lLCB2bWEsIGNvdW50KTsKQEAgLTM1NCw2ICszNTcsOSBAQCBzdGF0aWMg
aW50IGxpdmVfYnVzeXdhaXRfcHJlZW1wdCh2b2lkICphcmcpCiAJCXN0cnVjdCBpZ3RfbGl2ZV90
ZXN0IHQ7CiAJCXUzMiAqY3M7CiAKKwkJaWYgKCFpbnRlbF9lbmdpbmVfaGFzX3ByZWVtcHRpb24o
ZW5naW5lKSkKKwkJCWNvbnRpbnVlOworCiAJCWlmICghaW50ZWxfZW5naW5lX2Nhbl9zdG9yZV9k
d29yZChlbmdpbmUpKQogCQkJY29udGludWU7CiAKLS0gCjIuMjIuMAoKX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJ
bnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Au
b3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

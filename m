Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 79EA11411B8
	for <lists+intel-gfx@lfdr.de>; Fri, 17 Jan 2020 20:31:27 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 1880E6F8D9;
	Fri, 17 Jan 2020 19:31:12 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mail-yw1-xc44.google.com (mail-yw1-xc44.google.com
 [IPv6:2607:f8b0:4864:20::c44])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 102436F8DA
 for <intel-gfx@lists.freedesktop.org>; Fri, 17 Jan 2020 19:31:11 +0000 (UTC)
Received: by mail-yw1-xc44.google.com with SMTP id i190so14863614ywc.2
 for <intel-gfx@lists.freedesktop.org>; Fri, 17 Jan 2020 11:31:11 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=poorly.run; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=SbNgaMiTiOnuP5x7gX1mRS5vhRHmZZDgtqKGI/95uUY=;
 b=WDo/jNCzpIjteT6slJO5OAxoOx1qm5KozHFnrFFef8CXsmZeQ8/NzzQzP86Pg8RQv3
 nbpf8kRUsCOtku0xitylysA7Sgg6KsgbYSMQZaaBR7qHIxY9efXwUbARg8r3TtOLa0Zo
 EbMnl5QF2fXO7Z6NQNur03TXI71gkPIdOgeJrkwjNv2/7fKEqNYmg/MPtr4N+NlJJvw8
 pFUeFQscDQ1kKj2+JbvKIsOgU8TukPPWPHHUzJSaT0Q6X6WHgtEd3U0v59nr3EQduyee
 L+yek8MCoZCIep8+ENfiRj9g0lPgMHV/EUoLTDPAs91RUgx4PTSRPystlCmWAwjcgoO0
 aX9g==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=SbNgaMiTiOnuP5x7gX1mRS5vhRHmZZDgtqKGI/95uUY=;
 b=XcW9jlSbRYQc4VyLIVz5kdyZGHOltxkWICJnz/f597Epbu064hVL31Iw4f9XXYMJTQ
 8LWTZeNavmdbNW/tQ1JKitOCGotZv5/JjYD8JqZCAbKEaLTQ4UCyVaMLye7UM/Cq0sSH
 IigaA9nL2sixPflplxaCQmMSbMlvrv+hdgOPIex5Yaj1C7ANT31uEt4YHiPDlFiedmnf
 IQbQ0/aX/v0KDXGgH+GOH17cL/wPZsb/TLP9mACMHkBi9pEOLqESGDXENnb2x9CUYwco
 F9zR2VIK3jj1BJ6BZ8WAPhH3DuoTKz2X1qAtKM79vTyBex27svqEKMq1g5S7p71djMa1
 V4Og==
X-Gm-Message-State: APjAAAXiniUF9jmbC3tCFaUkCoI+sqrLEqtD7KayV6ERaJPWmk4KLw8y
 U1ACl1Hc6U9SQMEBlneXTZOriA==
X-Google-Smtp-Source: APXvYqz/yCMJFOzlADix9RzmgcLqjA4WjrMIrzaDFEcrlxiX+WzFCHmyro9a55/oNZRLKFaoya3slw==
X-Received: by 2002:a81:6f07:: with SMTP id k7mr33628147ywc.395.1579289470209; 
 Fri, 17 Jan 2020 11:31:10 -0800 (PST)
Received: from localhost ([2620:0:1013:11:1e1:4760:6ce4:fc64])
 by smtp.gmail.com with ESMTPSA id y9sm11248970ywc.19.2020.01.17.11.31.09
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Fri, 17 Jan 2020 11:31:09 -0800 (PST)
From: Sean Paul <sean@poorly.run>
To: dri-devel@lists.freedesktop.org,
	intel-gfx@lists.freedesktop.org
Date: Fri, 17 Jan 2020 14:30:55 -0500
Message-Id: <20200117193103.156821-5-sean@poorly.run>
X-Mailer: git-send-email 2.25.0.341.g760bfbb309-goog
In-Reply-To: <20200117193103.156821-1-sean@poorly.run>
References: <20200117193103.156821-1-sean@poorly.run>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v3 04/12] drm/i915: Intercept Aksv writes in the
 aux hooks
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: daniel.vetter@ffwll.ch, Sean Paul <seanpaul@chromium.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

RnJvbTogU2VhbiBQYXVsIDxzZWFucGF1bEBjaHJvbWl1bS5vcmc+CgpJbnN0ZWFkIG9mIGhhbmQg
cm9sbGluZyB0aGUgdHJhbnNmZXIgb3Vyc2VsdmVzIGluIHRoZSBoZGNwIGhvb2ssIGluc3BlY3QK
YXV4IG1lc3NhZ2VzIGFuZCBhZGQgdGhlIGFrc3YgZmxhZyBpbiB0aGUgYXV4IHRyYW5zZmVyIGhv
b2suCgpJSVJDLCB0aGlzIHdhcyB0aGUgb3JpZ2luYWwgaW1wbGVtZW50YXRpb24gYW5kIGZvbGtz
IHdhbnRlZCB0aGlzIGhhY2sgdG8KYmUgaXNvbGF0ZWQgdG8gdGhlIGhkY3AgY29kZSwgd2hpY2gg
bWFrZXMgc2Vuc2UuCgpIb3dldmVyIGluIHRlc3RpbmcgYW4gTEcgbW9uaXRvciBvbiBteSBkZXNr
LCBJIG5vdGljZWQgaXQgd2FzIHBhc3NpbmcKYmFjayBhIERFRkVSIHJlcGx5LiBUaGlzIHdhc24n
dCBoYW5kbGVkIGluIG91ciBoYW5kLXJvbGxlZCBjb2RlIGFuZCBIRENQCmF1dGggd2FzIGZhaWxp
bmcgYXMgYSByZXN1bHQuIEluc3RlYWQgb2YgY29weS9wYXN0aW5nIGFsbCBvZiB0aGUgcmV0cnkK
bG9naWMgYW5kIGRlbGF5cyBmcm9tIGRybSBkcCBoZWxwZXJzLCBsZXQncyBqdXN0IHVzZSB0aGUg
aGVscGVycyBhbmQgaGlkZQp0aGUgYWtzdiBzZWxlY3QgYXMgYmVzdCBhcyB3ZSBjYW4uCgpSZXZp
ZXdlZC1ieTogVmlsbGUgU3lyasOkbMOkIDx2aWxsZS5zeXJqYWxhQGxpbnV4LmludGVsLmNvbT4K
UmV2aWV3ZWQtYnk6IFJhbWFsaW5nYW0gQyA8cmFtYWxpbmdhbS5jQGludGVsLmNvbT4KU2lnbmVk
LW9mZi1ieTogU2VhbiBQYXVsIDxzZWFucGF1bEBjaHJvbWl1bS5vcmc+Ckxpbms6IGh0dHBzOi8v
cGF0Y2h3b3JrLmZyZWVkZXNrdG9wLm9yZy9wYXRjaC9tc2dpZC8yMDE5MTIwMzE3MzYzOC45NDkx
OS0zLXNlYW5AcG9vcmx5LnJ1biAjdjEKTGluazogaHR0cHM6Ly9wYXRjaHdvcmsuZnJlZWRlc2t0
b3Aub3JnL3BhdGNoL21zZ2lkLzIwMTkxMjEyMTkwMjMwLjE4ODUwNS01LXNlYW5AcG9vcmx5LnJ1
biAjdjIKCkNoYW5nZXMgaW4gdjI6Ci1SZW1vdmUgJ2dlbmVyYXRlJyBpbiBpbnRlbF9kcF9hdXhf
Z2VuZXJhdGVfeGZlcl9mbGFncywgbWFrZSBhcmcgY29uc3QgKFZpbGxlKQotQnVuZGxlIEFrc3Yg
aWYgc3RhdGVtZW50IHRvZ2V0aGVyIChWaWxsZSkKLVJlbmFtZSAndHhidWYnIHRvICdha3N2JyAo
VmlsbGUpCkNoYW5nZXMgaW4gdjM6Ci1Ob25lCi0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvZGlz
cGxheS9pbnRlbF9kcC5jIHwgNjIgKysrKysrKysrKysrLS0tLS0tLS0tLS0tLQogMSBmaWxlIGNo
YW5nZWQsIDI5IGluc2VydGlvbnMoKyksIDMzIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2Rpc3BsYXkvaW50ZWxfZHAuYyBiL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2Rpc3BsYXkvaW50ZWxfZHAuYwppbmRleCA0MDc0ZDgzYjFhNWYuLjBkNTlmNjI5MTdlZCAx
MDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZGlzcGxheS9pbnRlbF9kcC5jCisrKyBi
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2Rpc3BsYXkvaW50ZWxfZHAuYwpAQCAtMTUxNSwxMiArMTUx
NSwyNyBAQCBpbnRlbF9kcF9hdXhfaGVhZGVyKHU4IHR4YnVmW0hFQURFUl9TSVpFXSwKIAl0eGJ1
ZlszXSA9IG1zZy0+c2l6ZSAtIDE7CiB9CiAKK3N0YXRpYyB1MzIgaW50ZWxfZHBfYXV4X3hmZXJf
ZmxhZ3MoY29uc3Qgc3RydWN0IGRybV9kcF9hdXhfbXNnICptc2cpCit7CisJLyoKKwkgKiBJZiB3
ZSdyZSB0cnlpbmcgdG8gc2VuZCB0aGUgSERDUCBBa3N2LCB3ZSBuZWVkIHRvIHNldCBhIHRoZSBB
a3N2CisJICogc2VsZWN0IGJpdCB0byBpbmZvcm0gdGhlIGhhcmR3YXJlIHRvIHNlbmQgdGhlIEFr
c3YgYWZ0ZXIgb3VyIGhlYWRlcgorCSAqIHNpbmNlIHdlIGNhbid0IGFjY2VzcyB0aGF0IGRhdGEg
ZnJvbSBzb2Z0d2FyZS4KKwkgKi8KKwlpZiAoKG1zZy0+cmVxdWVzdCAmIH5EUF9BVVhfSTJDX01P
VCkgPT0gRFBfQVVYX05BVElWRV9XUklURSAmJgorCSAgICBtc2ctPmFkZHJlc3MgPT0gRFBfQVVY
X0hEQ1BfQUtTVikKKwkJcmV0dXJuIERQX0FVWF9DSF9DVExfQVVYX0FLU1ZfU0VMRUNUOworCisJ
cmV0dXJuIDA7Cit9CisKIHN0YXRpYyBzc2l6ZV90CiBpbnRlbF9kcF9hdXhfdHJhbnNmZXIoc3Ry
dWN0IGRybV9kcF9hdXggKmF1eCwgc3RydWN0IGRybV9kcF9hdXhfbXNnICptc2cpCiB7CiAJc3Ry
dWN0IGludGVsX2RwICppbnRlbF9kcCA9IGNvbnRhaW5lcl9vZihhdXgsIHN0cnVjdCBpbnRlbF9k
cCwgYXV4KTsKIAl1OCB0eGJ1ZlsyMF0sIHJ4YnVmWzIwXTsKIAlzaXplX3QgdHhzaXplLCByeHNp
emU7CisJdTMyIGZsYWdzID0gaW50ZWxfZHBfYXV4X3hmZXJfZmxhZ3MobXNnKTsKIAlpbnQgcmV0
OwogCiAJaW50ZWxfZHBfYXV4X2hlYWRlcih0eGJ1ZiwgbXNnKTsKQEAgLTE1NDEsNyArMTU1Niw3
IEBAIGludGVsX2RwX2F1eF90cmFuc2ZlcihzdHJ1Y3QgZHJtX2RwX2F1eCAqYXV4LCBzdHJ1Y3Qg
ZHJtX2RwX2F1eF9tc2cgKm1zZykKIAkJCW1lbWNweSh0eGJ1ZiArIEhFQURFUl9TSVpFLCBtc2ct
PmJ1ZmZlciwgbXNnLT5zaXplKTsKIAogCQlyZXQgPSBpbnRlbF9kcF9hdXhfeGZlcihpbnRlbF9k
cCwgdHhidWYsIHR4c2l6ZSwKLQkJCQkJcnhidWYsIHJ4c2l6ZSwgMCk7CisJCQkJCXJ4YnVmLCBy
eHNpemUsIGZsYWdzKTsKIAkJaWYgKHJldCA+IDApIHsKIAkJCW1zZy0+cmVwbHkgPSByeGJ1Zlsw
XSA+PiA0OwogCkBAIC0xNTY0LDcgKzE1NzksNyBAQCBpbnRlbF9kcF9hdXhfdHJhbnNmZXIoc3Ry
dWN0IGRybV9kcF9hdXggKmF1eCwgc3RydWN0IGRybV9kcF9hdXhfbXNnICptc2cpCiAJCQlyZXR1
cm4gLUUyQklHOwogCiAJCXJldCA9IGludGVsX2RwX2F1eF94ZmVyKGludGVsX2RwLCB0eGJ1Ziwg
dHhzaXplLAotCQkJCQlyeGJ1ZiwgcnhzaXplLCAwKTsKKwkJCQkJcnhidWYsIHJ4c2l6ZSwgZmxh
Z3MpOwogCQlpZiAocmV0ID4gMCkgewogCQkJbXNnLT5yZXBseSA9IHJ4YnVmWzBdID4+IDQ7CiAJ
CQkvKgpAQCAtNTkwNCwxNyArNTkxOSw5IEBAIHN0YXRpYwogaW50IGludGVsX2RwX2hkY3Bfd3Jp
dGVfYW5fYWtzdihzdHJ1Y3QgaW50ZWxfZGlnaXRhbF9wb3J0ICppbnRlbF9kaWdfcG9ydCwKIAkJ
CQl1OCAqYW4pCiB7Ci0Jc3RydWN0IGludGVsX2RwICppbnRlbF9kcCA9IGVuY190b19pbnRlbF9k
cCh0b19pbnRlbF9lbmNvZGVyKCZpbnRlbF9kaWdfcG9ydC0+YmFzZS5iYXNlKSk7Ci0Jc3RhdGlj
IGNvbnN0IHN0cnVjdCBkcm1fZHBfYXV4X21zZyBtc2cgPSB7Ci0JCS5yZXF1ZXN0ID0gRFBfQVVY
X05BVElWRV9XUklURSwKLQkJLmFkZHJlc3MgPSBEUF9BVVhfSERDUF9BS1NWLAotCQkuc2l6ZSA9
IERSTV9IRENQX0tTVl9MRU4sCi0JfTsKLQl1OCB0eGJ1ZltIRUFERVJfU0laRSArIERSTV9IRENQ
X0tTVl9MRU5dID0ge30sIHJ4YnVmWzJdLCByZXBseSA9IDA7CisJdTggYWtzdltEUk1fSERDUF9L
U1ZfTEVOXSA9IHt9OwogCXNzaXplX3QgZHBjZF9yZXQ7Ci0JaW50IHJldDsKIAotCS8qIE91dHB1
dCBBbiBmaXJzdCwgdGhhdCdzIGVhc3kgKi8KIAlkcGNkX3JldCA9IGRybV9kcF9kcGNkX3dyaXRl
KCZpbnRlbF9kaWdfcG9ydC0+ZHAuYXV4LCBEUF9BVVhfSERDUF9BTiwKIAkJCQkgICAgIGFuLCBE
Uk1fSERDUF9BTl9MRU4pOwogCWlmIChkcGNkX3JldCAhPSBEUk1fSERDUF9BTl9MRU4pIHsKQEAg
LTU5MjQsMjkgKzU5MzEsMTggQEAgaW50IGludGVsX2RwX2hkY3Bfd3JpdGVfYW5fYWtzdihzdHJ1
Y3QgaW50ZWxfZGlnaXRhbF9wb3J0ICppbnRlbF9kaWdfcG9ydCwKIAl9CiAKIAkvKgotCSAqIFNp
bmNlIEFrc3YgaXMgT2gtU28tU2VjcmV0LCB3ZSBjYW4ndCBhY2Nlc3MgaXQgaW4gc29mdHdhcmUu
IFNvIGluCi0JICogb3JkZXIgdG8gZ2V0IGl0IG9uIHRoZSB3aXJlLCB3ZSBuZWVkIHRvIGNyZWF0
ZSB0aGUgQVVYIGhlYWRlciBhcyBpZgotCSAqIHdlIHdlcmUgd3JpdGluZyB0aGUgZGF0YSwgYW5k
IHRoZW4gdGlja2xlIHRoZSBoYXJkd2FyZSB0byBvdXRwdXQgdGhlCi0JICogZGF0YSBvbmNlIHRo
ZSBoZWFkZXIgaXMgc2VudCBvdXQuCisJICogU2luY2UgQWtzdiBpcyBPaC1Tby1TZWNyZXQsIHdl
IGNhbid0IGFjY2VzcyBpdCBpbiBzb2Z0d2FyZS4gU28gd2UKKwkgKiBzZW5kIGFuIGVtcHR5IGJ1
ZmZlciBvZiB0aGUgY29ycmVjdCBsZW5ndGggdGhyb3VnaCB0aGUgRFAgaGVscGVycy4gT24KKwkg
KiB0aGUgb3RoZXIgc2lkZSwgaW4gdGhlIHRyYW5zZmVyIGhvb2ssIHdlJ2xsIGdlbmVyYXRlIGEg
ZmxhZyBiYXNlZCBvbgorCSAqIHRoZSBkZXN0aW5hdGlvbiBhZGRyZXNzIHdoaWNoIHdpbGwgdGlj
a2xlIHRoZSBoYXJkd2FyZSB0byBvdXRwdXQgdGhlCisJICogQWtzdiBvbiBvdXIgYmVoYWxmIGFm
dGVyIHRoZSBoZWFkZXIgaXMgc2VudC4KIAkgKi8KLQlpbnRlbF9kcF9hdXhfaGVhZGVyKHR4YnVm
LCAmbXNnKTsKLQotCXJldCA9IGludGVsX2RwX2F1eF94ZmVyKGludGVsX2RwLCB0eGJ1ZiwgSEVB
REVSX1NJWkUgKyBtc2cuc2l6ZSwKLQkJCQlyeGJ1Ziwgc2l6ZW9mKHJ4YnVmKSwKLQkJCQlEUF9B
VVhfQ0hfQ1RMX0FVWF9BS1NWX1NFTEVDVCk7Ci0JaWYgKHJldCA8IDApIHsKLQkJRFJNX0RFQlVH
X0tNUygiV3JpdGUgQWtzdiBvdmVyIERQL0FVWCBmYWlsZWQgKCVkKVxuIiwgcmV0KTsKLQkJcmV0
dXJuIHJldDsKLQl9IGVsc2UgaWYgKHJldCA9PSAwKSB7Ci0JCURSTV9ERUJVR19LTVMoIkFrc3Yg
d3JpdGUgb3ZlciBEUC9BVVggd2FzIGVtcHR5XG4iKTsKLQkJcmV0dXJuIC1FSU87Ci0JfQotCi0J
cmVwbHkgPSAocnhidWZbMF0gPj4gNCkgJiBEUF9BVVhfTkFUSVZFX1JFUExZX01BU0s7Ci0JaWYg
KHJlcGx5ICE9IERQX0FVWF9OQVRJVkVfUkVQTFlfQUNLKSB7Ci0JCURSTV9ERUJVR19LTVMoIkFr
c3Ygd3JpdGU6IG5vIERQX0FVWF9OQVRJVkVfUkVQTFlfQUNLICV4XG4iLAotCQkJICAgICAgcmVw
bHkpOwotCQlyZXR1cm4gLUVJTzsKKwlkcGNkX3JldCA9IGRybV9kcF9kcGNkX3dyaXRlKCZpbnRl
bF9kaWdfcG9ydC0+ZHAuYXV4LCBEUF9BVVhfSERDUF9BS1NWLAorCQkJCSAgICAgYWtzdiwgRFJN
X0hEQ1BfS1NWX0xFTik7CisJaWYgKGRwY2RfcmV0ICE9IERSTV9IRENQX0tTVl9MRU4pIHsKKwkJ
RFJNX0RFQlVHX0tNUygiRmFpbGVkIHRvIHdyaXRlIEFrc3Ygb3ZlciBEUC9BVVggKCV6ZClcbiIs
CisJCQkgICAgICBkcGNkX3JldCk7CisJCXJldHVybiBkcGNkX3JldCA+PSAwID8gLUVJTyA6IGRw
Y2RfcmV0OwogCX0KIAlyZXR1cm4gMDsKIH0KLS0gClNlYW4gUGF1bCwgU29mdHdhcmUgRW5naW5l
ZXIsIEdvb2dsZSAvIENocm9taXVtIE9TCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fXwpJbnRlbC1nZnggbWFpbGluZyBsaXN0CkludGVsLWdmeEBsaXN0cy5m
cmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0
aW5mby9pbnRlbC1nZngK

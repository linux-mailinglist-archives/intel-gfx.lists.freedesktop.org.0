Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id B3C531036AA
	for <lists+intel-gfx@lfdr.de>; Wed, 20 Nov 2019 10:33:25 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 762326E13F;
	Wed, 20 Nov 2019 09:33:23 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 283386E12A
 for <intel-gfx@lists.freedesktop.org>; Wed, 20 Nov 2019 09:33:14 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 19267946-1500050 
 for multiple; Wed, 20 Nov 2019 09:33:05 +0000
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Wed, 20 Nov 2019 09:32:56 +0000
Message-Id: <20191120093302.3723715-3-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.24.0
In-Reply-To: <20191120093302.3723715-1-chris@chris-wilson.co.uk>
References: <20191120093302.3723715-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 3/9] drm/i915/gt: Unlock engine-pm after queuing
 the kernel context switch
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SW4gY29tbWl0IGE3OWNhNjU2YjY0OCAoImRybS9pOTE1OiBQdXNoIHRoZSB3YWtlcmVmLT5jb3Vu
dCBkZWZlcnJhbCB0bwp0aGUgYmFja2VuZCIpLCBJIGVycm9uZW91c2x5IGNvbmNsdWRlZCB0aGF0
IHdlIGxhc3QgbW9kaWZ5IHRoZSBlbmdpbmUKaW5zaWRlIF9faTkxNV9yZXF1ZXN0X2NvbW1pdCgp
IG1lYW5pbmcgdGhhdCB3ZSBjb3VsZCBlbmFibGUgY29uY3VycmVudApzdWJtaXNzaW9uIGZvciB1
c2Vyc3BhY2UgYXMgd2UgZW5xdWV1ZWQgdGhpcyByZXF1ZXN0LiBIb3dldmVyLCB0aGlzCmZhbGxz
IGludG8gYSB0cmFwIHdpdGggb3RoZXIgdXNlcnMgb2YgdGhlIGVuZ2luZS0+a2VybmVsX2NvbnRl
eHQgd2FraW5nCnVwIGFuZCBzdWJtaXR0aW5nIHRoZWlyIHJlcXVlc3QgYmVmb3JlIHRoZSBpZGxl
LXN3aXRjaCBpcyBxdWV1ZWQsIHdpdGgKdGhlIHJlc3VsdCB0aGF0IHRoZSBrZXJuZWxfY29udGV4
dCBpcyBleGVjdXRlZCBvdXQtb2Ytc2VxdWVuY2UgbW9zdApsaWtlbHkgdXBzZXR0aW5nIHRoZSBH
UFUgYW5kIGNlcnRhaW5seSBvdXJzZWx2ZXMgd2hlbiB3ZSB0cnkgdG8gcmV0aXJlCnRoZSBvdXQt
b2Ytc2VxdWVuY2UgcmVxdWVzdHMuCgpBcyBzdWNoIHdlIG5lZWQgdG8gaG9sZCBvbnRvIHRoZSBl
ZmZlY3RpdmUgZW5naW5lLT5rZXJuZWxfY29udGV4dCBtdXRleApsb2NrICh2aWEgdGhlIGVuZ2lu
ZSBwbSBtdXRleCBwcm94eSkgdW50aWwgd2UgaGF2ZSBmaW5pc2ggcXVldWluZyB0aGUKcmVxdWVz
dCB0byB0aGUgZW5naW5lLgoKdjI6IFNlcmlhbGlzZSBhZ2FpbnN0IGNvbmN1cnJlbnQgaW50ZWxf
Z3RfcmV0aXJlX3JlcXVlc3RzKCkKdjM6IERlc2NyaWJlIHRoZSBoYWlyeSBsb2NraW5nIHNjaGVt
ZSB3aXRoIGludGVsX2d0X3JldGlyZV9yZXF1ZXN0cygpCmZvciBmdXR1cmUgcmVmZXJlbmNlLgp2
NDogQ29tYmluZSB0aW1lbGluZS0+bG9jayBhbmQgZW5naW5lIHBtIHJlbGVhc2U7IGl0J3MgaGFp
cnkuCgpGaXhlczogYTc5Y2E2NTZiNjQ4ICgiZHJtL2k5MTU6IFB1c2ggdGhlIHdha2VyZWYtPmNv
dW50IGRlZmVycmFsIHRvIHRoZSBiYWNrZW5kIikKU2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29u
IDxjaHJpc0BjaHJpcy13aWxzb24uY28udWs+CkNjOiBNaWthIEt1b3BwYWxhIDxtaWthLmt1b3Bw
YWxhQGxpbnV4LmludGVsLmNvbT4KQ2M6IFR2cnRrbyBVcnN1bGluIDx0dnJ0a28udXJzdWxpbkBp
bnRlbC5jb20+Ci0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZW5naW5lX3BtLmMg
fCA0NyArKysrKysrKysrKysrKysrKysrLS0tLQogMSBmaWxlIGNoYW5nZWQsIDQwIGluc2VydGlv
bnMoKyksIDcgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUv
Z3QvaW50ZWxfZW5naW5lX3BtLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdp
bmVfcG0uYwppbmRleCAzYzBmNDkwZmYyYzcuLjFmNTE3MzU3YTI2OCAxMDA2NDQKLS0tIGEvZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZW5naW5lX3BtLmMKKysrIGIvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvZ3QvaW50ZWxfZW5naW5lX3BtLmMKQEAgLTczLDggKzczLDI1IEBAIHN0YXRpYyBp
bmxpbmUgdm9pZCBfX3RpbWVsaW5lX21hcmtfdW5sb2NrKHN0cnVjdCBpbnRlbF9jb250ZXh0ICpj
ZSwKIAogI2VuZGlmIC8qICFJU19FTkFCTEVEKENPTkZJR19MT0NLREVQKSAqLwogCitzdGF0aWMg
dm9pZAorX19pbnRlbF90aW1lbGluZV9lbnRlcl9hbmRfcG1fcmVsZWFzZShzdHJ1Y3QgaW50ZWxf
dGltZWxpbmUgKnRsLAorCQkJCSAgICAgIHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkK
K3sKKwlzdHJ1Y3QgaW50ZWxfZ3RfdGltZWxpbmVzICp0aW1lbGluZXMgPSAmZW5naW5lLT5ndC0+
dGltZWxpbmVzOworCisJc3Bpbl9sb2NrKCZ0aW1lbGluZXMtPmxvY2spOworCisJaWYgKCFhdG9t
aWNfZmV0Y2hfaW5jKCZ0bC0+YWN0aXZlX2NvdW50KSkKKwkJbGlzdF9hZGRfdGFpbCgmdGwtPmxp
bmssICZ0aW1lbGluZXMtPmFjdGl2ZV9saXN0KTsKKworCV9faW50ZWxfd2FrZXJlZl9kZWZlcl9w
YXJrKCZlbmdpbmUtPndha2VyZWYpOworCisJc3Bpbl91bmxvY2soJnRpbWVsaW5lcy0+bG9jayk7
Cit9CisKIHN0YXRpYyBib29sIHN3aXRjaF90b19rZXJuZWxfY29udGV4dChzdHJ1Y3QgaW50ZWxf
ZW5naW5lX2NzICplbmdpbmUpCiB7CisJc3RydWN0IGludGVsX2NvbnRleHQgKmNlID0gZW5naW5l
LT5rZXJuZWxfY29udGV4dDsKIAlzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycTsKIAl1bnNpZ25lZCBs
b25nIGZsYWdzOwogCWJvb2wgcmVzdWx0ID0gdHJ1ZTsKQEAgLTk4LDE2ICsxMTUsMzEgQEAgc3Rh
dGljIGJvb2wgc3dpdGNoX3RvX2tlcm5lbF9jb250ZXh0KHN0cnVjdCBpbnRlbF9lbmdpbmVfY3Mg
KmVuZ2luZSkKIAkgKiBUaGlzIHNob3VsZCBob2xkIHRydWUgYXMgd2UgY2FuIG9ubHkgcGFyayB0
aGUgZW5naW5lIGFmdGVyCiAJICogcmV0aXJpbmcgdGhlIGxhc3QgcmVxdWVzdCwgdGh1cyBhbGwg
cmluZ3Mgc2hvdWxkIGJlIGVtcHR5IGFuZAogCSAqIGFsbCB0aW1lbGluZXMgaWRsZS4KKwkgKgor
CSAqIEZvciB1bmxvY2tpbmcsIHRoZXJlIGFyZSAyIG90aGVyIHBhcnRpZXMgYW5kIHRoZSBHUFUg
d2hvIGhhdmUgYQorCSAqIHN0YWtlIGhlcmUuCisJICoKKwkgKiBBIG5ldyBncHUgdXNlciB3aWxs
IGJlIHdhaXRpbmcgb24gdGhlIGVuZ2luZS1wbSB0byBzdGFydCB0aGVpcgorCSAqIGVuZ2luZV91
bnBhcmsuIE5ldyB3YWl0ZXJzIGFyZSBwcmVkaWNhdGVkIG9uIGVuZ2luZS0+d2FrZXJlZi5jb3Vu
dAorCSAqIGFuZCBzbyBpbnRlbF93YWtlcmVmX2RlZmVyX3BhcmsoKSBhY3RzIGxpa2UgYSBtdXRl
eF91bmxvY2sgb2YgdGhlCisJICogZW5naW5lLT53YWtlcmVmLgorCSAqCisJICogVGhlIG90aGVy
IHBhcnR5IGlzIGludGVsX2d0X3JldGlyZV9yZXF1ZXN0cygpLCB3aGljaCBpcyB3YWxraW5nIHRo
ZQorCSAqIGxpc3Qgb2YgYWN0aXZlIHRpbWVsaW5lcyBsb29raW5nIGZvciBjb21wbGV0aW9ucy4g
TWVhbndoaWxlIGFzIHNvb24KKwkgKiBhcyB3ZSBjYWxsIF9faTkxNV9yZXF1ZXN0X3F1ZXVlKCks
IHRoZSBHUFUgbWF5IGNvbXBsZXRlIG91ciByZXF1ZXN0LgorCSAqIEVyZ28sIGlmIHdlIHB1dCBv
dXJzZWx2ZXMgb24gdGhlIHRpbWVsaW5lcy5hY3RpdmVfbGlzdAorCSAqIChzZSBpbnRlbF90aW1l
bGluZV9lbnRlcigpKSBiZWZvcmUgd2UgaW5jcmVtZW50IHRoZQorCSAqIGVuZ2luZS0+d2FrZXJl
Zi5jb3VudCwgd2UgbWF5IHNlZSB0aGUgcmVxdWVzdCBjb21wbGV0aW9uIGFuZCByZXRpcmUKKwkg
KiBpdCBjYXVzaW5nIGFuIHVuZGVmbG93IG9mIHRoZSBlbmdpbmUtPndha2VyZWYuCiAJICovCi0J
ZmxhZ3MgPSBfX3RpbWVsaW5lX21hcmtfbG9jayhlbmdpbmUtPmtlcm5lbF9jb250ZXh0KTsKKwlm
bGFncyA9IF9fdGltZWxpbmVfbWFya19sb2NrKGNlKTsKKwlHRU1fQlVHX09OKGF0b21pY19yZWFk
KCZjZS0+dGltZWxpbmUtPmFjdGl2ZV9jb3VudCkgPCAwKTsKIAotCXJxID0gX19pOTE1X3JlcXVl
c3RfY3JlYXRlKGVuZ2luZS0+a2VybmVsX2NvbnRleHQsIEdGUF9OT1dBSVQpOworCXJxID0gX19p
OTE1X3JlcXVlc3RfY3JlYXRlKGNlLCBHRlBfTk9XQUlUKTsKIAlpZiAoSVNfRVJSKHJxKSkKIAkJ
LyogQ29udGV4dCBzd2l0Y2ggZmFpbGVkLCBob3BlIGZvciB0aGUgYmVzdCEgTWF5YmUgcmVzZXQ/
ICovCiAJCWdvdG8gb3V0X3VubG9jazsKIAotCWludGVsX3RpbWVsaW5lX2VudGVyKGk5MTVfcmVx
dWVzdF90aW1lbGluZShycSkpOwotCiAJLyogQ2hlY2sgYWdhaW4gb24gdGhlIG5leHQgcmV0aXJl
bWVudC4gKi8KIAllbmdpbmUtPndha2VyZWZfc2VyaWFsID0gZW5naW5lLT5zZXJpYWwgKyAxOwog
CWk5MTVfcmVxdWVzdF9hZGRfYWN0aXZlX2JhcnJpZXJzKHJxKTsKQEAgLTExNiwxMyArMTQ4LDE0
IEBAIHN0YXRpYyBib29sIHN3aXRjaF90b19rZXJuZWxfY29udGV4dChzdHJ1Y3QgaW50ZWxfZW5n
aW5lX2NzICplbmdpbmUpCiAJcnEtPnNjaGVkLmF0dHIucHJpb3JpdHkgPSBJOTE1X1BSSU9SSVRZ
X0JBUlJJRVI7CiAJX19pOTE1X3JlcXVlc3RfY29tbWl0KHJxKTsKIAotCS8qIFJlbGVhc2Ugb3Vy
IGV4Y2x1c2l2ZSBob2xkIG9uIHRoZSBlbmdpbmUgKi8KLQlfX2ludGVsX3dha2VyZWZfZGVmZXJf
cGFyaygmZW5naW5lLT53YWtlcmVmKTsKIAlfX2k5MTVfcmVxdWVzdF9xdWV1ZShycSwgTlVMTCk7
CiAKKwkvKiBFeHBvc2Ugb3Vyc2VsdmVzIHRvIGludGVsX2d0X3JldGlyZV9yZXF1ZXN0cygpIGFu
ZCBuZXcgc3VibWlzc2lvbiAqLworCV9faW50ZWxfdGltZWxpbmVfZW50ZXJfYW5kX3BtX3JlbGVh
c2UoY2UtPnRpbWVsaW5lLCBlbmdpbmUpOworCiAJcmVzdWx0ID0gZmFsc2U7CiBvdXRfdW5sb2Nr
OgotCV9fdGltZWxpbmVfbWFya191bmxvY2soZW5naW5lLT5rZXJuZWxfY29udGV4dCwgZmxhZ3Mp
OworCV9fdGltZWxpbmVfbWFya191bmxvY2soY2UsIGZsYWdzKTsKIAlyZXR1cm4gcmVzdWx0Owog
fQogCi0tIAoyLjI0LjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9w
Lm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVs
LWdmeA==

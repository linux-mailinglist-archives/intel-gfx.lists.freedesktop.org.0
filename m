Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 913A95C3D4
	for <lists+intel-gfx@lfdr.de>; Mon,  1 Jul 2019 21:51:03 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 07FCA89930;
	Mon,  1 Jul 2019 19:51:02 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id CA95689930
 for <intel-gfx@lists.freedesktop.org>; Mon,  1 Jul 2019 19:50:59 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17090523-1500050 
 for multiple; Mon, 01 Jul 2019 20:50:41 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon,  1 Jul 2019 20:50:38 +0100
Message-Id: <20190701195038.4908-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190701151213.14856-1-chris@chris-wilson.co.uk>
References: <20190701151213.14856-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v2] drm/i915/gem: Free pages before rcu-freeing
 the object
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Matthew Auld <matthew.auld@intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

QXMgd2UgaGF2ZSBkcm9wcGVkIHRoZSBmaW5hbCByZWZlcmVuY2UgdG8gdGhlIG9iamVjdCwgd2Ug
ZG8gbm90IG5lZWQgdG8Kd2FpdCB1bnRpbCBhZnRlciB0aGUgcmN1IGdyYWNlIHBlcmlvZCB0byBk
cm9wIGl0cyBwYWdlcy4gV2Ugc3RpbGwgcmVxdWlyZQpzdHJ1Y3RfbXV0ZXggdG8gY29tcGxldGVs
eSB1bmJpbmQgdGhlIG9iamVjdCB0byByZWxlYXNlIHRoZSBwYWdlcywgc28gd2UKc3RpbGwgbmVl
ZCBhIGZyZWUtd29ya2VyIHRvIG1hbmFnZSB0aGF0IGZyb20gcHJvY2VzcyBjb250ZXh0LiBCeQpz
Y2hlZHVsaW5nIHRoZSByZWxlYXNlIG9mIHBhZ2VzIGJlZm9yZSB3YWl0aW5nIGZvciB0aGUgcmN1
IHNob3VsZCBtZWFuCnRoYXQgd2UgYXJlIG5vdCB0cmFwcGluZyB0aG9zZSBwYWdlcyBmcm9tIGJl
eW9uZCB0aGUgcmVhY2ggb2YgdGhlCnNocmlua2VyLgoKdjI6IFBhc3MgYWxvbmcgdGhlIHJlcXVl
c3QgdG8gc2tpcCBpZiB0aGUgdm1hIGlzIGJ1c3kgdG8gdGhlIHVuZGVybHlpbmcKdW5iaW5kIHJv
dXRpbmUsIHRvIGF2b2lkIGNoZWNraW5nIHRoZSByZXNlcnZhdGlvbiB1bmRlcm5lYXRoIHRoZQpp
OTE1LT5tbS5vYmpfbG9jayB3aGljaCBtYXkgYmUgdXNlZCBmcm9tIGluc2lkZSBpcnEgY29udGV4
dC4KCkJ1Z3ppbGxhOiBodHRwczovL2J1Z3MuZnJlZWRlc2t0b3Aub3JnL3Nob3dfYnVnLmNnaT9p
ZD0xMTEwMzUKRml4ZXM6IGE5MzYxNWY5MDBiZCAoImRybS9pOTE1OiBUaHJvdyBhd2F5IHRoZSBh
Y3RpdmUgb2JqZWN0IHJldGlyZW1lbnQgY29tcGxleGl0eSIpClNpZ25lZC1vZmYtYnk6IENocmlz
IFdpbHNvbiA8Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPgpDYzogTWF0dGhldyBBdWxkIDxtYXR0
aGV3LmF1bGRAaW50ZWwuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dl
bV9vYmplY3QuYyAgIHwgODIgKysrKysrKysrLS0tLS0tLS0tLS0KIGRyaXZlcnMvZ3B1L2RybS9p
OTE1L2dlbS9pOTE1X2dlbV9waHlzLmMgICAgIHwgIDIgKy0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1
L2dlbS9pOTE1X2dlbV9zaHJpbmtlci5jIHwgMTggKysrLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1
L2dlbS9pOTE1X2dlbV91c2VycHRyLmMgIHwgIDIgKy0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5
MTVfZHJ2LmggICAgICAgICAgICAgIHwgMTUgKystLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkx
NV9nZW0uYyAgICAgICAgICAgICAgfCAgOSArKy0KIDYgZmlsZXMgY2hhbmdlZCwgNjcgaW5zZXJ0
aW9ucygrKSwgNjEgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ2VtL2k5MTVfZ2VtX29iamVjdC5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVf
Z2VtX29iamVjdC5jCmluZGV4IDQzMTk0ZmJjYmMyZS4uZDNlOTZmMDljNmI3IDEwMDY0NAotLS0g
YS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fb2JqZWN0LmMKKysrIGIvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX29iamVjdC5jCkBAIC0xNDYsNiArMTQ2LDE4IEBA
IHZvaWQgaTkxNV9nZW1fY2xvc2Vfb2JqZWN0KHN0cnVjdCBkcm1fZ2VtX29iamVjdCAqZ2VtLCBz
dHJ1Y3QgZHJtX2ZpbGUgKmZpbGUpCiAJfQogfQogCitzdGF0aWMgdm9pZCBfX2k5MTVfZ2VtX2Zy
ZWVfb2JqZWN0X3JjdShzdHJ1Y3QgcmN1X2hlYWQgKmhlYWQpCit7CisJc3RydWN0IGRybV9pOTE1
X2dlbV9vYmplY3QgKm9iaiA9CisJCWNvbnRhaW5lcl9vZihoZWFkLCB0eXBlb2YoKm9iaiksIHJj
dSk7CisJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUgPSB0b19pOTE1KG9iai0+YmFzZS5k
ZXYpOworCisJaTkxNV9nZW1fb2JqZWN0X2ZyZWUob2JqKTsKKworCUdFTV9CVUdfT04oIWF0b21p
Y19yZWFkKCZpOTE1LT5tbS5mcmVlX2NvdW50KSk7CisJYXRvbWljX2RlYygmaTkxNS0+bW0uZnJl
ZV9jb3VudCk7Cit9CisKIHN0YXRpYyB2b2lkIF9faTkxNV9nZW1fZnJlZV9vYmplY3RzKHN0cnVj
dCBkcm1faTkxNV9wcml2YXRlICppOTE1LAogCQkJCSAgICBzdHJ1Y3QgbGxpc3Rfbm9kZSAqZnJl
ZWQpCiB7CkBAIC0xNjgsMjIgKzE4MCw2IEBAIHN0YXRpYyB2b2lkIF9faTkxNV9nZW1fZnJlZV9v
YmplY3RzKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1LAogCQlHRU1fQlVHX09OKCFsaXN0
X2VtcHR5KCZvYmotPnZtYS5saXN0KSk7CiAJCUdFTV9CVUdfT04oIVJCX0VNUFRZX1JPT1QoJm9i
ai0+dm1hLnRyZWUpKTsKIAotCQkvKgotCQkgKiBUaGlzIHNlcmlhbGl6ZXMgZnJlZWluZyB3aXRo
IHRoZSBzaHJpbmtlci4gU2luY2UgdGhlIGZyZWUKLQkJICogaXMgZGVsYXllZCwgZmlyc3QgYnkg
UkNVIHRoZW4gYnkgdGhlIHdvcmtxdWV1ZSwgd2Ugd2FudCB0aGUKLQkJICogc2hyaW5rZXIgdG8g
YmUgYWJsZSB0byBmcmVlIHBhZ2VzIG9mIHVucmVmZXJlbmNlZCBvYmplY3RzLAotCQkgKiBvciBl
bHNlIHdlIG1heSBvb20gd2hpbHN0IHRoZXJlIGFyZSBwbGVudHkgb2YgZGVmZXJyZWQKLQkJICog
ZnJlZWQgb2JqZWN0cy4KLQkJICovCi0JCWlmIChpOTE1X2dlbV9vYmplY3RfaGFzX3BhZ2VzKG9i
aikgJiYKLQkJICAgIGk5MTVfZ2VtX29iamVjdF9pc19zaHJpbmthYmxlKG9iaikpIHsKLQkJCXVu
c2lnbmVkIGxvbmcgZmxhZ3M7Ci0KLQkJCXNwaW5fbG9ja19pcnFzYXZlKCZpOTE1LT5tbS5vYmpf
bG9jaywgZmxhZ3MpOwotCQkJbGlzdF9kZWxfaW5pdCgmb2JqLT5tbS5saW5rKTsKLQkJCXNwaW5f
dW5sb2NrX2lycXJlc3RvcmUoJmk5MTUtPm1tLm9ial9sb2NrLCBmbGFncyk7Ci0JCX0KLQogCQlt
dXRleF91bmxvY2soJmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOwogCiAJCUdFTV9CVUdfT04oYXRv
bWljX3JlYWQoJm9iai0+YmluZF9jb3VudCkpOwpAQCAtMTk3LDE5ICsxOTMsMTUgQEAgc3RhdGlj
IHZvaWQgX19pOTE1X2dlbV9mcmVlX29iamVjdHMoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5
MTUsCiAJCWF0b21pY19zZXQoJm9iai0+bW0ucGFnZXNfcGluX2NvdW50LCAwKTsKIAkJX19pOTE1
X2dlbV9vYmplY3RfcHV0X3BhZ2VzKG9iaiwgSTkxNV9NTV9OT1JNQUwpOwogCQlHRU1fQlVHX09O
KGk5MTVfZ2VtX29iamVjdF9oYXNfcGFnZXMob2JqKSk7CisJCWJpdG1hcF9mcmVlKG9iai0+Yml0
XzE3KTsKIAogCQlpZiAob2JqLT5iYXNlLmltcG9ydF9hdHRhY2gpCiAJCQlkcm1fcHJpbWVfZ2Vt
X2Rlc3Ryb3koJm9iai0+YmFzZSwgTlVMTCk7CiAKIAkJZHJtX2dlbV9vYmplY3RfcmVsZWFzZSgm
b2JqLT5iYXNlKTsKIAotCQliaXRtYXBfZnJlZShvYmotPmJpdF8xNyk7Ci0JCWk5MTVfZ2VtX29i
amVjdF9mcmVlKG9iaik7Ci0KLQkJR0VNX0JVR19PTighYXRvbWljX3JlYWQoJmk5MTUtPm1tLmZy
ZWVfY291bnQpKTsKLQkJYXRvbWljX2RlYygmaTkxNS0+bW0uZnJlZV9jb3VudCk7Ci0KLQkJY29u
ZF9yZXNjaGVkKCk7CisJCS8qIEJ1dCBrZWVwIHRoZSBwb2ludGVyIGFsaXZlIGZvciBSQ1UtcHJv
dGVjdGVkIGxvb2t1cHMgKi8KKwkJY2FsbF9yY3UoJm9iai0+cmN1LCBfX2k5MTVfZ2VtX2ZyZWVf
b2JqZWN0X3JjdSk7CiAJfQogCWludGVsX3J1bnRpbWVfcG1fcHV0KCZpOTE1LT5ydW50aW1lX3Bt
LCB3YWtlcmVmKTsKIH0KQEAgLTI2MCwxOCArMjUyLDM0IEBAIHN0YXRpYyB2b2lkIF9faTkxNV9n
ZW1fZnJlZV93b3JrKHN0cnVjdCB3b3JrX3N0cnVjdCAqd29yaykKIAlzcGluX3VubG9jaygmaTkx
NS0+bW0uZnJlZV9sb2NrKTsKIH0KIAotc3RhdGljIHZvaWQgX19pOTE1X2dlbV9mcmVlX29iamVj
dF9yY3Uoc3RydWN0IHJjdV9oZWFkICpoZWFkKQordm9pZCBpOTE1X2dlbV9mcmVlX29iamVjdChz
dHJ1Y3QgZHJtX2dlbV9vYmplY3QgKmdlbV9vYmopCiB7Ci0Jc3RydWN0IGRybV9pOTE1X2dlbV9v
YmplY3QgKm9iaiA9Ci0JCWNvbnRhaW5lcl9vZihoZWFkLCB0eXBlb2YoKm9iaiksIHJjdSk7CisJ
c3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiA9IHRvX2ludGVsX2JvKGdlbV9vYmopOwog
CXN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1ID0gdG9faTkxNShvYmotPmJhc2UuZGV2KTsK
IAogCS8qCi0JICogV2UgcmV1c2Ugb2JqLT5yY3UgZm9yIHRoZSBmcmVlZCBsaXN0LCBzbyB3ZSBo
YWQgYmV0dGVyIG5vdCB0cmVhdAotCSAqIGl0IGxpa2UgYSByY3VfaGVhZCBmcm9tIHRoaXMgcG9p
bnQgZm9yd2FyZHMuIEFuZCB3ZSBleHBlY3QgYWxsCi0JICogb2JqZWN0cyB0byBiZSBmcmVlZCB2
aWEgdGhpcyBwYXRoLgorCSAqIEJlZm9yZSB3ZSBmcmVlIHRoZSBvYmplY3QsIG1ha2Ugc3VyZSBh
bnkgcHVyZSBSQ1Utb25seQorCSAqIHJlYWQtc2lkZSBjcml0aWNhbCBzZWN0aW9ucyBhcmUgY29t
cGxldGUsIGUuZy4KKwkgKiBpOTE1X2dlbV9idXN5X2lvY3RsKCkuIEZvciB0aGUgY29ycmVzcG9u
ZGluZyBzeW5jaHJvbml6ZWQKKwkgKiBsb29rdXAgc2VlIGk5MTVfZ2VtX29iamVjdF9sb29rdXBf
cmN1KCkuCiAJICovCi0JZGVzdHJveV9yY3VfaGVhZCgmb2JqLT5yY3UpOworCWF0b21pY19pbmMo
Jmk5MTUtPm1tLmZyZWVfY291bnQpOworCisJLyoKKwkgKiBUaGlzIHNlcmlhbGl6ZXMgZnJlZWlu
ZyB3aXRoIHRoZSBzaHJpbmtlci4gU2luY2UgdGhlIGZyZWUKKwkgKiBpcyBkZWxheWVkLCBmaXJz
dCBieSBSQ1UgdGhlbiBieSB0aGUgd29ya3F1ZXVlLCB3ZSB3YW50IHRoZQorCSAqIHNocmlua2Vy
IHRvIGJlIGFibGUgdG8gZnJlZSBwYWdlcyBvZiB1bnJlZmVyZW5jZWQgb2JqZWN0cywKKwkgKiBv
ciBlbHNlIHdlIG1heSBvb20gd2hpbHN0IHRoZXJlIGFyZSBwbGVudHkgb2YgZGVmZXJyZWQKKwkg
KiBmcmVlZCBvYmplY3RzLgorCSAqLworCWlmIChpOTE1X2dlbV9vYmplY3RfaGFzX3BhZ2VzKG9i
aikgJiYKKwkgICAgaTkxNV9nZW1fb2JqZWN0X2lzX3Nocmlua2FibGUob2JqKSkgeworCQl1bnNp
Z25lZCBsb25nIGZsYWdzOworCisJCXNwaW5fbG9ja19pcnFzYXZlKCZpOTE1LT5tbS5vYmpfbG9j
aywgZmxhZ3MpOworCQlsaXN0X2RlbF9pbml0KCZvYmotPm1tLmxpbmspOworCQlzcGluX3VubG9j
a19pcnFyZXN0b3JlKCZpOTE1LT5tbS5vYmpfbG9jaywgZmxhZ3MpOworCX0KIAogCS8qCiAJICog
U2luY2Ugd2UgcmVxdWlyZSBibG9ja2luZyBvbiBzdHJ1Y3RfbXV0ZXggdG8gdW5iaW5kIHRoZSBm
cmVlZApAQCAtMjg3LDIwICsyOTUsNiBAQCBzdGF0aWMgdm9pZCBfX2k5MTVfZ2VtX2ZyZWVfb2Jq
ZWN0X3JjdShzdHJ1Y3QgcmN1X2hlYWQgKmhlYWQpCiAJCXF1ZXVlX3dvcmsoaTkxNS0+d3EsICZp
OTE1LT5tbS5mcmVlX3dvcmspOwogfQogCi12b2lkIGk5MTVfZ2VtX2ZyZWVfb2JqZWN0KHN0cnVj
dCBkcm1fZ2VtX29iamVjdCAqZ2VtX29iaikKLXsKLQlzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVj
dCAqb2JqID0gdG9faW50ZWxfYm8oZ2VtX29iaik7Ci0KLQkvKgotCSAqIEJlZm9yZSB3ZSBmcmVl
IHRoZSBvYmplY3QsIG1ha2Ugc3VyZSBhbnkgcHVyZSBSQ1Utb25seQotCSAqIHJlYWQtc2lkZSBj
cml0aWNhbCBzZWN0aW9ucyBhcmUgY29tcGxldGUsIGUuZy4KLQkgKiBpOTE1X2dlbV9idXN5X2lv
Y3RsKCkuIEZvciB0aGUgY29ycmVzcG9uZGluZyBzeW5jaHJvbml6ZWQKLQkgKiBsb29rdXAgc2Vl
IGk5MTVfZ2VtX29iamVjdF9sb29rdXBfcmN1KCkuCi0JICovCi0JYXRvbWljX2luYygmdG9faTkx
NShvYmotPmJhc2UuZGV2KS0+bW0uZnJlZV9jb3VudCk7Ci0JY2FsbF9yY3UoJm9iai0+cmN1LCBf
X2k5MTVfZ2VtX2ZyZWVfb2JqZWN0X3JjdSk7Ci19Ci0KIHN0YXRpYyBpbmxpbmUgZW51bSBmYl9v
cF9vcmlnaW4KIGZiX3dyaXRlX29yaWdpbihzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2Jq
LCB1bnNpZ25lZCBpbnQgZG9tYWluKQogewpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ2VtL2k5MTVfZ2VtX3BoeXMuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dl
bV9waHlzLmMKaW5kZXggN2I5MDBlZTRlZDhkLi5lMzE4M2U0YzIzZWUgMTAwNjQ0Ci0tLSBhL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9waHlzLmMKKysrIGIvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3BoeXMuYwpAQCAtMTU5LDcgKzE1OSw3IEBAIGludCBpOTE1
X2dlbV9vYmplY3RfYXR0YWNoX3BoeXMoc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiwg
aW50IGFsaWduKQogCWlmIChvYmotPm9wcyAhPSAmaTkxNV9nZW1fc2htZW1fb3BzKQogCQlyZXR1
cm4gLUVJTlZBTDsKIAotCWVyciA9IGk5MTVfZ2VtX29iamVjdF91bmJpbmQob2JqKTsKKwllcnIg
PSBpOTE1X2dlbV9vYmplY3RfdW5iaW5kKG9iaiwgMCk7CiAJaWYgKGVycikKIAkJcmV0dXJuIGVy
cjsKIApkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3Nocmlu
a2VyLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fc2hyaW5rZXIuYwppbmRl
eCBkOTlmMWE2MDBiOTYuLjU2YTdjNmE3ZjdmNCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJt
L2k5MTUvZ2VtL2k5MTVfZ2VtX3Nocmlua2VyLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUv
Z2VtL2k5MTVfZ2VtX3Nocmlua2VyLmMKQEAgLTg4LDEwICs4OCwxOCBAQCBzdGF0aWMgYm9vbCBj
YW5fcmVsZWFzZV9wYWdlcyhzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqKQogCXJldHVy
biBzd2FwX2F2YWlsYWJsZSgpIHx8IG9iai0+bW0ubWFkdiA9PSBJOTE1X01BRFZfRE9OVE5FRUQ7
CiB9CiAKLXN0YXRpYyBib29sIHVuc2FmZV9kcm9wX3BhZ2VzKHN0cnVjdCBkcm1faTkxNV9nZW1f
b2JqZWN0ICpvYmopCitzdGF0aWMgYm9vbCB1bnNhZmVfZHJvcF9wYWdlcyhzdHJ1Y3QgZHJtX2k5
MTVfZ2VtX29iamVjdCAqb2JqLAorCQkJICAgICAgdW5zaWduZWQgbG9uZyBzaHJpbmspCiB7Ci0J
aWYgKGk5MTVfZ2VtX29iamVjdF91bmJpbmQob2JqKSA9PSAwKQorCXVuc2lnbmVkIGxvbmcgZmxh
Z3M7CisKKwlmbGFncyA9IDA7CisJaWYgKCEoc2hyaW5rICYgSTkxNV9TSFJJTktfQUNUSVZFKSkK
KwkJZmxhZ3MgPSBJOTE1X0dFTV9PQkpFQ1RfVU5CSU5EX09OTFlfSUZfSURMRTsKKworCWlmIChp
OTE1X2dlbV9vYmplY3RfdW5iaW5kKG9iaiwgZmxhZ3MpID09IDApCiAJCV9faTkxNV9nZW1fb2Jq
ZWN0X3B1dF9wYWdlcyhvYmosIEk5MTVfTU1fU0hSSU5LRVIpOworCiAJcmV0dXJuICFpOTE1X2dl
bV9vYmplY3RfaGFzX3BhZ2VzKG9iaik7CiB9CiAKQEAgLTIyOSw5ICsyMzcsNyBAQCBpOTE1X2dl
bV9zaHJpbmsoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUsCiAJCQkJY29udGludWU7CiAK
IAkJCWlmICghKHNocmluayAmIEk5MTVfU0hSSU5LX0FDVElWRSkgJiYKLQkJCSAgICAoaTkxNV9n
ZW1fb2JqZWN0X2lzX2ZyYW1lYnVmZmVyKG9iaikgfHwKLQkJCSAgICAgIXJlc2VydmF0aW9uX29i
amVjdF90ZXN0X3NpZ25hbGVkX3JjdShvYmotPmJhc2UucmVzdiwKLQkJCQkJCQkJICAgdHJ1ZSkp
KQorCQkJICAgIGk5MTVfZ2VtX29iamVjdF9pc19mcmFtZWJ1ZmZlcihvYmopKQogCQkJCWNvbnRp
bnVlOwogCiAJCQlpZiAoIShzaHJpbmsgJiBJOTE1X1NIUklOS19CT1VORCkgJiYKQEAgLTI0Niw3
ICsyNTIsNyBAQCBpOTE1X2dlbV9zaHJpbmsoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUs
CiAKIAkJCXNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJmk5MTUtPm1tLm9ial9sb2NrLCBmbGFncyk7
CiAKLQkJCWlmICh1bnNhZmVfZHJvcF9wYWdlcyhvYmopKSB7CisJCQlpZiAodW5zYWZlX2Ryb3Bf
cGFnZXMob2JqLCBzaHJpbmspKSB7CiAJCQkJLyogTWF5IGFycml2ZSBmcm9tIGdldF9wYWdlcyBv
biBhbm90aGVyIGJvICovCiAJCQkJbXV0ZXhfbG9ja19uZXN0ZWQoJm9iai0+bW0ubG9jaywKIAkJ
CQkJCSAgSTkxNV9NTV9TSFJJTktFUik7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9nZW0vaTkxNV9nZW1fdXNlcnB0ci5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVf
Z2VtX3VzZXJwdHIuYwppbmRleCA1MjhiNjE2NzgzMzQuLmIyMzI5NDVlYmRiNSAxMDA2NDQKLS0t
IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3VzZXJwdHIuYworKysgYi9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fdXNlcnB0ci5jCkBAIC0xNTAsNyArMTUwLDcg
QEAgdXNlcnB0cl9tbl9pbnZhbGlkYXRlX3JhbmdlX3N0YXJ0KHN0cnVjdCBtbXVfbm90aWZpZXIg
Kl9tbiwKIAkJCX0KIAkJfQogCi0JCXJldCA9IGk5MTVfZ2VtX29iamVjdF91bmJpbmQob2JqKTsK
KwkJcmV0ID0gaTkxNV9nZW1fb2JqZWN0X3VuYmluZChvYmosIDApOwogCQlpZiAocmV0ID09IDAp
CiAJCQlyZXQgPSBfX2k5MTVfZ2VtX29iamVjdF9wdXRfcGFnZXMob2JqLCBJOTE1X01NX1NIUklO
S0VSKTsKIAkJaTkxNV9nZW1fb2JqZWN0X3B1dChvYmopOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9n
cHUvZHJtL2k5MTUvaTkxNV9kcnYuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZHJ2LmgK
aW5kZXggMDJkZDlmOWYzYTg5Li4yNDAwNzUyNzE0NDAgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L2k5MTVfZHJ2LmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYu
aApAQCAtMjQ0NiwxOCArMjQ0NiwxNyBAQCBpbnQgaTkxNV9nZW1fZnJlZXplX2xhdGUoc3RydWN0
IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2KTsKIAogc3RhdGljIGlubGluZSB2b2lkIGk5MTVf
Z2VtX2RyYWluX2ZyZWVkX29iamVjdHMoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCiB7
Ci0JaWYgKCFhdG9taWNfcmVhZCgmaTkxNS0+bW0uZnJlZV9jb3VudCkpCi0JCXJldHVybjsKLQot
CS8qIEEgc2luZ2xlIHBhc3Mgc2hvdWxkIHN1ZmZpY2UgdG8gcmVsZWFzZSBhbGwgdGhlIGZyZWVk
IG9iamVjdHMgKGFsb25nCisJLyoKKwkgKiBBIHNpbmdsZSBwYXNzIHNob3VsZCBzdWZmaWNlIHRv
IHJlbGVhc2UgYWxsIHRoZSBmcmVlZCBvYmplY3RzIChhbG9uZwogCSAqIG1vc3QgY2FsbCBwYXRo
cykgLCBidXQgYmUgYSBsaXR0bGUgbW9yZSBwYXJhbm9pZCBpbiB0aGF0IGZyZWVpbmcKIAkgKiB0
aGUgb2JqZWN0cyBkb2VzIHRha2UgYSBsaXR0bGUgYW1vdW50IG9mIHRpbWUsIGR1cmluZyB3aGlj
aCB0aGUgcmN1CiAJICogY2FsbGJhY2tzIGNvdWxkIGhhdmUgYWRkZWQgbmV3IG9iamVjdHMgaW50
byB0aGUgZnJlZWQgbGlzdCwgYW5kCiAJICogYXJtZWQgdGhlIHdvcmsgYWdhaW4uCiAJICovCi0J
ZG8geworCXdoaWxlIChhdG9taWNfcmVhZCgmaTkxNS0+bW0uZnJlZV9jb3VudCkpIHsKKwkJZmx1
c2hfd29yaygmaTkxNS0+bW0uZnJlZV93b3JrKTsKIAkJcmN1X2JhcnJpZXIoKTsKLQl9IHdoaWxl
IChmbHVzaF93b3JrKCZpOTE1LT5tbS5mcmVlX3dvcmspKTsKKwl9CiB9CiAKIHN0YXRpYyBpbmxp
bmUgdm9pZCBpOTE1X2dlbV9kcmFpbl93b3JrcXVldWUoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUg
Kmk5MTUpCkBAIC0yNDg4LDcgKzI0ODcsOSBAQCBpOTE1X2dlbV9vYmplY3RfZ2d0dF9waW4oc3Ry
dWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiwKIAkJCSB1NjQgYWxpZ25tZW50LAogCQkJIHU2
NCBmbGFncyk7CiAKLWludCBpOTE1X2dlbV9vYmplY3RfdW5iaW5kKHN0cnVjdCBkcm1faTkxNV9n
ZW1fb2JqZWN0ICpvYmopOworaW50IGk5MTVfZ2VtX29iamVjdF91bmJpbmQoc3RydWN0IGRybV9p
OTE1X2dlbV9vYmplY3QgKm9iaiwKKwkJCSAgIHVuc2lnbmVkIGxvbmcgZmxhZ3MpOworI2RlZmlu
ZSBJOTE1X0dFTV9PQkpFQ1RfVU5CSU5EX09OTFlfSUZfSURMRSBCSVQoMCkKIAogdm9pZCBpOTE1
X2dlbV9ydW50aW1lX3N1c3BlbmQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2KTsK
IApkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW0uYyBiL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2k5MTVfZ2VtLmMKaW5kZXggYjdmMjkwYjc3ZjhmLi5mYjM2ZTFkMjNjNGIg
MTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtLmMKKysrIGIvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvaTkxNV9nZW0uYwpAQCAtMTAxLDcgKzEwMSw4IEBAIGk5MTVfZ2VtX2dl
dF9hcGVydHVyZV9pb2N0bChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LCB2b2lkICpkYXRhLAogCXJl
dHVybiAwOwogfQogCi1pbnQgaTkxNV9nZW1fb2JqZWN0X3VuYmluZChzdHJ1Y3QgZHJtX2k5MTVf
Z2VtX29iamVjdCAqb2JqKQoraW50IGk5MTVfZ2VtX29iamVjdF91bmJpbmQoc3RydWN0IGRybV9p
OTE1X2dlbV9vYmplY3QgKm9iaiwKKwkJCSAgIHVuc2lnbmVkIGxvbmcgZmxhZ3MpCiB7CiAJc3Ry
dWN0IGk5MTVfdm1hICp2bWE7CiAJTElTVF9IRUFEKHN0aWxsX2luX2xpc3QpOwpAQCAtMTE2LDcg
KzExNywxMSBAQCBpbnQgaTkxNV9nZW1fb2JqZWN0X3VuYmluZChzdHJ1Y3QgZHJtX2k5MTVfZ2Vt
X29iamVjdCAqb2JqKQogCQlsaXN0X21vdmVfdGFpbCgmdm1hLT5vYmpfbGluaywgJnN0aWxsX2lu
X2xpc3QpOwogCQlzcGluX3VubG9jaygmb2JqLT52bWEubG9jayk7CiAKLQkJcmV0ID0gaTkxNV92
bWFfdW5iaW5kKHZtYSk7CisJCWlmIChmbGFncyAmIEk5MTVfR0VNX09CSkVDVF9VTkJJTkRfT05M
WV9JRl9JRExFICYmCisJCSAgICBpOTE1X3ZtYV9pc19hY3RpdmUodm1hKSkKKwkJCXJldCA9IC1F
QlVTWTsKKwkJZWxzZQorCQkJcmV0ID0gaTkxNV92bWFfdW5iaW5kKHZtYSk7CiAKIAkJc3Bpbl9s
b2NrKCZvYmotPnZtYS5sb2NrKTsKIAl9Ci0tIAoyLjIwLjEKCl9fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwt
Z2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9t
YWlsbWFuL2xpc3RpbmZvL2ludGVsLWdmeA==

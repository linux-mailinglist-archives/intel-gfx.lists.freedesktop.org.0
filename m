Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id C763DCD8F54
	for <lists+intel-gfx@lfdr.de>; Tue, 23 Dec 2025 11:51:36 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id E628910E292;
	Tue, 23 Dec 2025 10:51:34 +0000 (UTC)
Authentication-Results: gabe.freedesktop.org;
	dkim=pass (2048-bit key; unprotected) header.d=intel.com header.i=@intel.com header.b="JXOUdxts";
	dkim-atps=neutral
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mgamail.intel.com (mgamail.intel.com [198.175.65.11])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 2777010E292;
 Tue, 23 Dec 2025 10:51:34 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
 d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
 t=1766487095; x=1798023095;
 h=from:to:cc:subject:date:message-id:mime-version:
 content-transfer-encoding;
 bh=hTcHmbgxpaH0OztcyxVUG377NfQFK6nwu1j1/n9+EmU=;
 b=JXOUdxtsgrp2C9LHzt2RKDzZlQIBbf+3ncqMgHQLnuy5xikI4Kcjk75/
 3aOcjeveYHEI8DY/SBBdlknBrUtP4zRzW207bciJwVeGl/AYD3P5ZygK7
 GradAJOoHDKje+X3sDp+dOt6/4rVJPy+BpijxCrrpHhQB2DvIWiu/uHQn
 /402+l7CGUSRGqvcp+6lgxc8xl7Ct0hpGJsUJBEJsfnmng9JRFOxS9g7Z
 EPP4z8Pac8VyH3M1zHOB4JZmttpO0ZV/NgRz3+W2RSsMRqGPF7WQoJnnT
 7RNUAEEmTGmAuKqmghQAOPYxri01Xuil8s4MBuEOGR1qHBnJNfC1KFPi9 A==;
X-CSE-ConnectionGUID: c7BK4w+KT+CkjgJP0RPbTQ==
X-CSE-MsgGUID: ULc25NvuSyCMHvKNBycMYQ==
X-IronPort-AV: E=McAfee;i="6800,10657,11650"; a="78651271"
X-IronPort-AV: E=Sophos;i="6.21,170,1763452800"; d="scan'208";a="78651271"
Received: from orviesa005.jf.intel.com ([10.64.159.145])
 by orvoesa103.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 23 Dec 2025 02:51:34 -0800
X-CSE-ConnectionGUID: QnN4w3aiRGKVcmMyR7TBfg==
X-CSE-MsgGUID: a3rs5ihKSfO0dEwI/wSc1A==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="6.21,170,1763452800"; d="scan'208";a="204806123"
Received: from mjarzebo-mobl1.ger.corp.intel.com (HELO
 jhogande-mobl3.intel.com) ([10.245.246.100])
 by orviesa005-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 23 Dec 2025 02:51:32 -0800
From: =?UTF-8?q?Jouni=20H=C3=B6gander?= <jouni.hogander@intel.com>
To: intel-gfx@lists.freedesktop.org,
	intel-xe@lists.freedesktop.org
Cc: =?UTF-8?q?Jouni=20H=C3=B6gander?= <jouni.hogander@intel.com>
Subject: [PATCH v9 0/8] Use trans push mechanism to generate frame change event
Date: Tue, 23 Dec 2025 12:51:12 +0200
Message-ID: <20251223105120.21505-1-jouni.hogander@intel.com>
X-Mailer: git-send-email 2.43.0
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Organization: Intel Finland Oy - BIC 0357606-4 - Westendinkatu 7, 02160 Espoo
Content-Transfer-Encoding: 8bit
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

Currently we are using "automatic" frame change event generation. The
event is generated by any access to plane or pipe registers.

We have option to use "PSR PR Frame Change Enable" bit in TRANS_PUSH
register to enable frame change event generation only when doing trans
push. When this bit is set "automatic" frame change event generation
doesn't work anymore. Benfit from this is more controled updates send
by PSR HW.

This patch set is taking trans push mechanism into use.

v9: always do PSR exit on frontbuffer flush for LunarLake and onwards
v8:
  - rebase
  - Wait for idle only after possible send
v7:
  - added bspec references
  - add HAS_PSR_FRAME_CHANGE macro
  - use TRANS_PUSH in instead of TRAN_VRR_CTL
  - "Do not trigger Frame Change events from frontbuffer flush" patch
    already merged
v6: use AND instead of OR in intel_psr_use_trans_push
v5: add missing patch
v4:
  - add intel_psr_use_trans_push to query if TRANS_PUSH is used
  - set DSB_SKIP_WAITS_EN chicken bit when TRANS_PUSH is used
  - Wait for vblank in case of PSR is using trans push
v3:
  - use rmw when enabling disabling transh push for PSR or VRR
  - rely on crtc_state->has_psr/has_vrr to keep trans push enabled
  - modify frontbuffer flush/invalidate to use disable/enable also for
    SU/SF on recent platforms.
  - send push before waiting for vblank
v2: implement intel_vrr_trans_push_enabled_set_clear and use that
    instead of rmw

Jouni HÃ¶gander (8):
  drm/i915/psr: Add TRANS_PUSH register bit definition for PSR
  drm/i915/psr: Add intel_psr_use_trans_push to query if TRANS_PUSH is
    used
  drm/i915/vrr: Prepare to Use TRANS_PUSH mechanism for PSR frame change
  drm/i915/dsb: Set DSB_SKIP_WAITS_EN chicken bit for LunarLake and
    onwards
  drm/i915/display: Wait for vblank in case of PSR is using trans push
  drm/i915/psr: Wait for idle only after possible send push
  drm/i915/psr: Do PSR exit on frontbuffer flush on LunarLake and
    onwards
  drm/i915/psr: Use TRANS_PUSH to trigger frame change event

 drivers/gpu/drm/i915/display/intel_crtc.c     |  4 +-
 drivers/gpu/drm/i915/display/intel_display.c  | 33 ++++++++++++++--
 drivers/gpu/drm/i915/display/intel_dsb.c      | 15 ++++++--
 drivers/gpu/drm/i915/display/intel_psr.c      | 38 +++++++++++++------
 drivers/gpu/drm/i915/display/intel_psr.h      |  1 +
 drivers/gpu/drm/i915/display/intel_vrr.c      | 29 +++++++++++---
 drivers/gpu/drm/i915/display/intel_vrr.h      |  1 +
 drivers/gpu/drm/i915/display/intel_vrr_regs.h |  1 +
 8 files changed, 96 insertions(+), 26 deletions(-)

-- 
2.43.0


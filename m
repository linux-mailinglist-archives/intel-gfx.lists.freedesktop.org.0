Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 65835484D8
	for <lists+intel-gfx@lfdr.de>; Mon, 17 Jun 2019 16:04:41 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id C416C8914A;
	Mon, 17 Jun 2019 14:04:39 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 5A3A389147
 for <intel-gfx@lists.freedesktop.org>; Mon, 17 Jun 2019 14:04:38 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 16928071-1500050 
 for multiple; Mon, 17 Jun 2019 15:04:25 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 17 Jun 2019 15:04:26 +0100
Message-Id: <20190617140426.7203-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190617112036.9373-1-chris@chris-wilson.co.uk>
References: <20190617112036.9373-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v3] drm/i915/gtt: Serialise both updates to PDE
 and our shadow
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Mika Kuoppala <mika.kuoppala@intel.com>,
 Matthew Auld <matthew.auld@intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

Q3VycmVudGx5LCB3ZSBwZXJmb3JtIGEgbG9ja2VkIHVwZGF0ZSBvZiB0aGUgc2hhZG93IGVudHJ5
IHdoZW4KYWxsb2NhdGluZyBhIHBhZ2UgZGlyZWN0b3J5IGVudHJ5IHN1Y2ggdGhhdCBpZiB0d28g
Y2xpZW50cyBhcmUKY29uY3VycmVudGx5IGFsbG9jYXRpbmcgbmVpZ2hib3VyaW5nIHJhbmdlcyB3
ZSBvbmx5IGluc2VydCBvbmUgbmV3IGVudHJ5CmZvciB0aGUgcGFpciBvZiB0aGVtLiBIb3dldmVy
LCB3ZSBhbHNvIG5lZWQgdG8gc2VyaWFsaXNlIGJvdGggY2xpZW50cwp3cnQgdG8gdGhlIGFjdHVh
bCBlbnRyeSBpbiB0aGUgSFcgdGFibGUsIG9yIGVsc2Ugd2UgbWF5IGFsbG93IG9uZSBjbGllbnQK
b3IgZXZlbiBhIHRoaXJkIGNsaWVudCB0byBwcm9jZWVkIGFoZWFkIG9mIHRoZSBIVyB3cml0ZS4g
TXkgaGFuZHdhdmUKYmVmb3JlIHdhcyB0aGF0IHVuZGVyIHRoZSBfcGF0aG9sb2dpY2FsXyBjb25k
aXRpb24gd2Ugd291bGQgc2VlIHRoZQpzY3JhdGNoIGVudHJ5IGluc3RlYWQgb2YgdGhlIGV4cGVj
dGVkIGVudHJ5LCBjYXVzaW5nIGEgdGVtcG9yYXJ5CmdsaXRjaC4gVGhhdCBzdGFydmF0aW9uIGNv
bmRpdGlvbiB3aWxsIGV2ZW50dWFsbHkgc2hvdyB1cCBpbiBwcmFjdGljZSwgc28KZml4IGl0LgoK
VGhlIHJlYXNvbiBmb3IgdGhlIHByZXZpb3VzIGNoZWF0IHdhcyB0byBhdm9pZCBoYXZpbmcgdG8g
ZnJlZSB0aGUgZXh0cmEKYWxsb2NhdGlvbiB3aGlsZSB1bmRlciB0aGUgc3BpbmxvY2suIE5vdywg
d2Uga2VlcCB0aGUgZXh0cmEgZW50cnkKYWxsb2NhdGVkIHVudGlsIHRoZSBlbmQgaW5zdGVhZC4K
CnYyOiBGaXggZXJyb3IgcGF0aHMgZm9yIGdlbjYKCkZpeGVzOiAxZDFiNTQ5MGI5MWMgKCJkcm0v
aTkxNS9ndHQ6IFJlcGxhY2Ugc3RydWN0X211dGV4IHNlcmlhbGlzYXRpb24gZm9yIGFsbG9jYXRp
b24iKQpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNocmlzQGNocmlzLXdpbHNvbi5jby51
az4KQ2M6IE1hdHRoZXcgQXVsZCA8bWF0dGhldy5hdWxkQGludGVsLmNvbT4KQ2M6IE1pa2EgS3Vv
cHBhbGEgPG1pa2Eua3VvcHBhbGFAaW50ZWwuY29tPgpSZXZpZXdlZC1ieTogTWF0dGhldyBBdWxk
IDxtYXR0aGV3LmF1bGRAaW50ZWwuY29tPgpSZXZpZXdlZC1ieTogTWlrYSBLdW9wcGFsYSA8bWlr
YS5rdW9wcGFsYUBpbnRlbC5jb20+Ci0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW1f
Z3R0LmMgfCAxMzMgKysrKysrKysrKysrKysrLS0tLS0tLS0tLS0tLQogMSBmaWxlIGNoYW5nZWQs
IDczIGluc2VydGlvbnMoKyksIDYwIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2k5MTVfZ2VtX2d0dC5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9n
ZW1fZ3R0LmMKaW5kZXggZWMwMGZjY2QwYzZmLi44YWI4MjAxNDVlYTYgMTAwNjQ0Ci0tLSBhL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtX2d0dC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2k5MTVfZ2VtX2d0dC5jCkBAIC0xMzQ2LDgxICsxMzQ2LDg2IEBAIHN0YXRpYyBpbnQgZ2Vu
OF9wcGd0dF9hbGxvY19wZChzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKIAkJCSAgICAg
ICBzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeSAqcGQsCiAJCQkgICAgICAgdTY0IHN0YXJ0LCB1
NjQgbGVuZ3RoKQogewotCXN0cnVjdCBpOTE1X3BhZ2VfdGFibGUgKnB0OworCXN0cnVjdCBpOTE1
X3BhZ2VfdGFibGUgKnB0LCAqYWxsb2MgPSBOVUxMOwogCXU2NCBmcm9tID0gc3RhcnQ7CiAJdW5z
aWduZWQgaW50IHBkZTsKKwlpbnQgcmV0ID0gMDsKIAogCXNwaW5fbG9jaygmcGQtPmxvY2spOwog
CWdlbjhfZm9yX2VhY2hfcGRlKHB0LCBwZCwgc3RhcnQsIGxlbmd0aCwgcGRlKSB7CiAJCWNvbnN0
IGludCBjb3VudCA9IGdlbjhfcHRlX2NvdW50KHN0YXJ0LCBsZW5ndGgpOwogCiAJCWlmIChwdCA9
PSB2bS0+c2NyYXRjaF9wdCkgewotCQkJc3RydWN0IGk5MTVfcGFnZV90YWJsZSAqb2xkOwotCiAJ
CQlzcGluX3VubG9jaygmcGQtPmxvY2spOwogCi0JCQlwdCA9IGFsbG9jX3B0KHZtKTsKLQkJCWlm
IChJU19FUlIocHQpKQorCQkJcHQgPSBmZXRjaF9hbmRfemVybygmYWxsb2MpOworCQkJaWYgKCFw
dCkKKwkJCQlwdCA9IGFsbG9jX3B0KHZtKTsKKwkJCWlmIChJU19FUlIocHQpKSB7CisJCQkJcmV0
ID0gUFRSX0VSUihwdCk7CiAJCQkJZ290byB1bndpbmQ7CisJCQl9CiAKIAkJCWlmIChjb3VudCA8
IEdFTjhfUFRFUyB8fCBpbnRlbF92Z3B1X2FjdGl2ZSh2bS0+aTkxNSkpCiAJCQkJZ2VuOF9pbml0
aWFsaXplX3B0KHZtLCBwdCk7CiAKLQkJCW9sZCA9IGNtcHhjaGcoJnBkLT5lbnRyeVtwZGVdLCB2
bS0+c2NyYXRjaF9wdCwgcHQpOwotCQkJaWYgKG9sZCA9PSB2bS0+c2NyYXRjaF9wdCkgeworCQkJ
c3Bpbl9sb2NrKCZwZC0+bG9jayk7CisJCQlpZiAocGQtPmVudHJ5W3BkZV0gPT0gdm0tPnNjcmF0
Y2hfcHQpIHsKIAkJCQlnZW44X3BwZ3R0X3NldF9wZGUodm0sIHBkLCBwdCwgcGRlKTsKKwkJCQlw
ZC0+ZW50cnlbcGRlXSA9IHB0OwogCQkJCWF0b21pY19pbmMoJnBkLT51c2VkKTsKIAkJCX0gZWxz
ZSB7Ci0JCQkJZnJlZV9wdCh2bSwgcHQpOwotCQkJCXB0ID0gb2xkOworCQkJCWFsbG9jID0gcHQ7
CisJCQkJcHQgPSBwZC0+ZW50cnlbcGRlXTsKIAkJCX0KLQotCQkJc3Bpbl9sb2NrKCZwZC0+bG9j
ayk7CiAJCX0KIAogCQlhdG9taWNfYWRkKGNvdW50LCAmcHQtPnVzZWQpOwogCX0KIAlzcGluX3Vu
bG9jaygmcGQtPmxvY2spOwotCi0JcmV0dXJuIDA7CisJZ290byBvdXQ7CiAKIHVud2luZDoKIAln
ZW44X3BwZ3R0X2NsZWFyX3BkKHZtLCBwZCwgZnJvbSwgc3RhcnQgLSBmcm9tKTsKLQlyZXR1cm4g
LUVOT01FTTsKK291dDoKKwlpZiAoYWxsb2MpCisJCWZyZWVfcHQodm0sIGFsbG9jKTsKKwlyZXR1
cm4gcmV0OwogfQogCiBzdGF0aWMgaW50IGdlbjhfcHBndHRfYWxsb2NfcGRwKHN0cnVjdCBpOTE1
X2FkZHJlc3Nfc3BhY2UgKnZtLAogCQkJCXN0cnVjdCBpOTE1X3BhZ2VfZGlyZWN0b3J5ICpwZHAs
CiAJCQkJdTY0IHN0YXJ0LCB1NjQgbGVuZ3RoKQogewotCXN0cnVjdCBpOTE1X3BhZ2VfZGlyZWN0
b3J5ICpwZDsKKwlzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeSAqcGQsICphbGxvYyA9IE5VTEw7
CiAJdTY0IGZyb20gPSBzdGFydDsKIAl1bnNpZ25lZCBpbnQgcGRwZTsKLQlpbnQgcmV0OworCWlu
dCByZXQgPSAwOwogCiAJc3Bpbl9sb2NrKCZwZHAtPmxvY2spOwogCWdlbjhfZm9yX2VhY2hfcGRw
ZShwZCwgcGRwLCBzdGFydCwgbGVuZ3RoLCBwZHBlKSB7CiAJCWlmIChwZCA9PSB2bS0+c2NyYXRj
aF9wZCkgewotCQkJc3RydWN0IGk5MTVfcGFnZV9kaXJlY3RvcnkgKm9sZDsKLQogCQkJc3Bpbl91
bmxvY2soJnBkcC0+bG9jayk7CiAKLQkJCXBkID0gYWxsb2NfcGQodm0pOwotCQkJaWYgKElTX0VS
UihwZCkpCisJCQlwZCA9IGZldGNoX2FuZF96ZXJvKCZhbGxvYyk7CisJCQlpZiAoIXBkKQorCQkJ
CXBkID0gYWxsb2NfcGQodm0pOworCQkJaWYgKElTX0VSUihwZCkpIHsKKwkJCQlyZXQgPSBQVFJf
RVJSKHBkKTsKIAkJCQlnb3RvIHVud2luZDsKKwkJCX0KIAogCQkJaW5pdF9wZF93aXRoX3BhZ2Uo
dm0sIHBkLCB2bS0+c2NyYXRjaF9wdCk7CiAKLQkJCW9sZCA9IGNtcHhjaGcoJnBkcC0+ZW50cnlb
cGRwZV0sIHZtLT5zY3JhdGNoX3BkLCBwZCk7Ci0JCQlpZiAob2xkID09IHZtLT5zY3JhdGNoX3Bk
KSB7CisJCQlzcGluX2xvY2soJnBkcC0+bG9jayk7CisJCQlpZiAocGRwLT5lbnRyeVtwZHBlXSA9
PSB2bS0+c2NyYXRjaF9wZCkgewogCQkJCWdlbjhfcHBndHRfc2V0X3BkcGUocGRwLCBwZCwgcGRw
ZSk7CisJCQkJcGRwLT5lbnRyeVtwZHBlXSA9IHBkOwogCQkJCWF0b21pY19pbmMoJnBkcC0+dXNl
ZCk7CiAJCQl9IGVsc2UgewotCQkJCWZyZWVfcGQodm0sIHBkKTsKLQkJCQlwZCA9IG9sZDsKKwkJ
CQlhbGxvYyA9IHBkOworCQkJCXBkID0gcGRwLT5lbnRyeVtwZHBlXTsKIAkJCX0KLQotCQkJc3Bp
bl9sb2NrKCZwZHAtPmxvY2spOwogCQl9CiAJCWF0b21pY19pbmMoJnBkLT51c2VkKTsKIAkJc3Bp
bl91bmxvY2soJnBkcC0+bG9jayk7CkBAIC0xNDMzLDggKzE0MzgsNyBAQCBzdGF0aWMgaW50IGdl
bjhfcHBndHRfYWxsb2NfcGRwKHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAogCQlhdG9t
aWNfZGVjKCZwZC0+dXNlZCk7CiAJfQogCXNwaW5fdW5sb2NrKCZwZHAtPmxvY2spOwotCi0JcmV0
dXJuIDA7CisJZ290byBvdXQ7CiAKIHVud2luZF9wZDoKIAlzcGluX2xvY2soJnBkcC0+bG9jayk7
CkBAIC0xNDQ3LDcgKzE0NTEsMTAgQEAgc3RhdGljIGludCBnZW44X3BwZ3R0X2FsbG9jX3BkcChz
dHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKIAlzcGluX3VubG9jaygmcGRwLT5sb2NrKTsK
IHVud2luZDoKIAlnZW44X3BwZ3R0X2NsZWFyX3BkcCh2bSwgcGRwLCBmcm9tLCBzdGFydCAtIGZy
b20pOwotCXJldHVybiAtRU5PTUVNOworb3V0OgorCWlmIChhbGxvYykKKwkJZnJlZV9wZCh2bSwg
YWxsb2MpOworCXJldHVybiByZXQ7CiB9CiAKIHN0YXRpYyBpbnQgZ2VuOF9wcGd0dF9hbGxvY18z
bHZsKHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLApAQCAtMTQ2MiwzMyArMTQ2OSwzNCBA
QCBzdGF0aWMgaW50IGdlbjhfcHBndHRfYWxsb2NfNGx2bChzdHJ1Y3QgaTkxNV9hZGRyZXNzX3Nw
YWNlICp2bSwKIHsKIAlzdHJ1Y3QgaTkxNV9wcGd0dCAqcHBndHQgPSBpOTE1X3ZtX3RvX3BwZ3R0
KHZtKTsKIAlzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeSAqIGNvbnN0IHBtbDQgPSBwcGd0dC0+
cGQ7Ci0Jc3RydWN0IGk5MTVfcGFnZV9kaXJlY3RvcnkgKnBkcDsKKwlzdHJ1Y3QgaTkxNV9wYWdl
X2RpcmVjdG9yeSAqcGRwLCAqYWxsb2MgPSBOVUxMOwogCXU2NCBmcm9tID0gc3RhcnQ7CisJaW50
IHJldCA9IDA7CiAJdTMyIHBtbDRlOwotCWludCByZXQ7CiAKIAlzcGluX2xvY2soJnBtbDQtPmxv
Y2spOwogCWdlbjhfZm9yX2VhY2hfcG1sNGUocGRwLCBwbWw0LCBzdGFydCwgbGVuZ3RoLCBwbWw0
ZSkgewogCQlpZiAocGRwID09IHZtLT5zY3JhdGNoX3BkcCkgewotCQkJc3RydWN0IGk5MTVfcGFn
ZV9kaXJlY3RvcnkgKm9sZDsKLQogCQkJc3Bpbl91bmxvY2soJnBtbDQtPmxvY2spOwogCi0JCQlw
ZHAgPSBhbGxvY19wZCh2bSk7Ci0JCQlpZiAoSVNfRVJSKHBkcCkpCisJCQlwZHAgPSBmZXRjaF9h
bmRfemVybygmYWxsb2MpOworCQkJaWYgKCFwZHApCisJCQkJcGRwID0gYWxsb2NfcGQodm0pOwor
CQkJaWYgKElTX0VSUihwZHApKSB7CisJCQkJcmV0ID0gUFRSX0VSUihwZHApOwogCQkJCWdvdG8g
dW53aW5kOworCQkJfQogCiAJCQlpbml0X3BkKHZtLCBwZHAsIHZtLT5zY3JhdGNoX3BkKTsKIAot
CQkJb2xkID0gY21weGNoZygmcG1sNC0+ZW50cnlbcG1sNGVdLCB2bS0+c2NyYXRjaF9wZHAsIHBk
cCk7Ci0JCQlpZiAob2xkID09IHZtLT5zY3JhdGNoX3BkcCkgeworCQkJc3Bpbl9sb2NrKCZwbWw0
LT5sb2NrKTsKKwkJCWlmIChwbWw0LT5lbnRyeVtwbWw0ZV0gPT0gdm0tPnNjcmF0Y2hfcGRwKSB7
CiAJCQkJZ2VuOF9wcGd0dF9zZXRfcG1sNGUocG1sNCwgcGRwLCBwbWw0ZSk7CisJCQkJcG1sNC0+
ZW50cnlbcG1sNGVdID0gcGRwOwogCQkJfSBlbHNlIHsKLQkJCQlmcmVlX3BkKHZtLCBwZHApOwot
CQkJCXBkcCA9IG9sZDsKKwkJCQlhbGxvYyA9IHBkcDsKKwkJCQlwZHAgPSBwbWw0LT5lbnRyeVtw
bWw0ZV07CiAJCQl9Ci0KLQkJCXNwaW5fbG9jaygmcG1sNC0+bG9jayk7CiAJCX0KIAkJYXRvbWlj
X2luYygmcGRwLT51c2VkKTsKIAkJc3Bpbl91bmxvY2soJnBtbDQtPmxvY2spOwpAQCAtMTUwMSw4
ICsxNTA5LDcgQEAgc3RhdGljIGludCBnZW44X3BwZ3R0X2FsbG9jXzRsdmwoc3RydWN0IGk5MTVf
YWRkcmVzc19zcGFjZSAqdm0sCiAJCWF0b21pY19kZWMoJnBkcC0+dXNlZCk7CiAJfQogCXNwaW5f
dW5sb2NrKCZwbWw0LT5sb2NrKTsKLQotCXJldHVybiAwOworCWdvdG8gb3V0OwogCiB1bndpbmRf
cGRwOgogCXNwaW5fbG9jaygmcG1sNC0+bG9jayk7CkBAIC0xNTEzLDcgKzE1MjAsMTAgQEAgc3Rh
dGljIGludCBnZW44X3BwZ3R0X2FsbG9jXzRsdmwoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAq
dm0sCiAJc3Bpbl91bmxvY2soJnBtbDQtPmxvY2spOwogdW53aW5kOgogCWdlbjhfcHBndHRfY2xl
YXJfNGx2bCh2bSwgZnJvbSwgc3RhcnQgLSBmcm9tKTsKLQlyZXR1cm4gLUVOT01FTTsKK291dDoK
KwlpZiAoYWxsb2MpCisJCWZyZWVfcGQodm0sIGFsbG9jKTsKKwlyZXR1cm4gcmV0OwogfQogCiBz
dGF0aWMgaW50IGdlbjhfcHJlYWxsb2NhdGVfdG9wX2xldmVsX3BkcChzdHJ1Y3QgaTkxNV9wcGd0
dCAqcHBndHQpCkBAIC0xNzkyLDExICsxODAyLDEyIEBAIHN0YXRpYyBpbnQgZ2VuNl9hbGxvY192
YV9yYW5nZShzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKIHsKIAlzdHJ1Y3QgZ2VuNl9w
cGd0dCAqcHBndHQgPSB0b19nZW42X3BwZ3R0KGk5MTVfdm1fdG9fcHBndHQodm0pKTsKIAlzdHJ1
Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeSAqIGNvbnN0IHBkID0gcHBndHQtPmJhc2UucGQ7Ci0Jc3Ry
dWN0IGk5MTVfcGFnZV90YWJsZSAqcHQ7CisJc3RydWN0IGk5MTVfcGFnZV90YWJsZSAqcHQsICph
bGxvYyA9IE5VTEw7CiAJaW50ZWxfd2FrZXJlZl90IHdha2VyZWY7CiAJdTY0IGZyb20gPSBzdGFy
dDsKIAl1bnNpZ25lZCBpbnQgcGRlOwogCWJvb2wgZmx1c2ggPSBmYWxzZTsKKwlpbnQgcmV0ID0g
MDsKIAogCXdha2VyZWYgPSBpbnRlbF9ydW50aW1lX3BtX2dldCgmdm0tPmk5MTUtPnJ1bnRpbWVf
cG0pOwogCkBAIC0xODA1LDI5ICsxODE2LDMwIEBAIHN0YXRpYyBpbnQgZ2VuNl9hbGxvY192YV9y
YW5nZShzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKIAkJY29uc3QgdW5zaWduZWQgaW50
IGNvdW50ID0gZ2VuNl9wdGVfY291bnQoc3RhcnQsIGxlbmd0aCk7CiAKIAkJaWYgKHB0ID09IHZt
LT5zY3JhdGNoX3B0KSB7Ci0JCQlzdHJ1Y3QgaTkxNV9wYWdlX3RhYmxlICpvbGQ7Ci0KIAkJCXNw
aW5fdW5sb2NrKCZwZC0+bG9jayk7CiAKLQkJCXB0ID0gYWxsb2NfcHQodm0pOwotCQkJaWYgKElT
X0VSUihwdCkpCisJCQlwdCA9IGZldGNoX2FuZF96ZXJvKCZhbGxvYyk7CisJCQlpZiAoIXB0KQor
CQkJCXB0ID0gYWxsb2NfcHQodm0pOworCQkJaWYgKElTX0VSUihwdCkpIHsKKwkJCQlyZXQgPSBQ
VFJfRVJSKHB0KTsKIAkJCQlnb3RvIHVud2luZF9vdXQ7CisJCQl9CiAKIAkJCWdlbjZfaW5pdGlh
bGl6ZV9wdCh2bSwgcHQpOwogCi0JCQlvbGQgPSBjbXB4Y2hnKCZwZC0+ZW50cnlbcGRlXSwgdm0t
PnNjcmF0Y2hfcHQsIHB0KTsKLQkJCWlmIChvbGQgPT0gdm0tPnNjcmF0Y2hfcHQpIHsKKwkJCXNw
aW5fbG9jaygmcGQtPmxvY2spOworCQkJaWYgKHBkLT5lbnRyeVtwZGVdID09IHZtLT5zY3JhdGNo
X3B0KSB7CisJCQkJcGQtPmVudHJ5W3BkZV0gPSBwdDsKIAkJCQlpZiAoaTkxNV92bWFfaXNfYm91
bmQocHBndHQtPnZtYSwKIAkJCQkJCSAgICAgIEk5MTVfVk1BX0dMT0JBTF9CSU5EKSkgewogCQkJ
CQlnZW42X3dyaXRlX3BkZShwcGd0dCwgcGRlLCBwdCk7CiAJCQkJCWZsdXNoID0gdHJ1ZTsKIAkJ
CQl9CiAJCQl9IGVsc2UgewotCQkJCWZyZWVfcHQodm0sIHB0KTsKLQkJCQlwdCA9IG9sZDsKKwkJ
CQlhbGxvYyA9IHB0OworCQkJCXB0ID0gcGQtPmVudHJ5W3BkZV07CiAJCQl9Ci0KLQkJCXNwaW5f
bG9jaygmcGQtPmxvY2spOwogCQl9CiAKIAkJYXRvbWljX2FkZChjb3VudCwgJnB0LT51c2VkKTsK
QEAgLTE4MzksMTQgKzE4NTEsMTUgQEAgc3RhdGljIGludCBnZW42X2FsbG9jX3ZhX3JhbmdlKHN0
cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAogCQlnZW42X2dndHRfaW52YWxpZGF0ZSh2bS0+
aTkxNSk7CiAJfQogCi0JaW50ZWxfcnVudGltZV9wbV9wdXQoJnZtLT5pOTE1LT5ydW50aW1lX3Bt
LCB3YWtlcmVmKTsKLQotCXJldHVybiAwOworCWdvdG8gb3V0OwogCiB1bndpbmRfb3V0OgotCWlu
dGVsX3J1bnRpbWVfcG1fcHV0KCZ2bS0+aTkxNS0+cnVudGltZV9wbSwgd2FrZXJlZik7CiAJZ2Vu
Nl9wcGd0dF9jbGVhcl9yYW5nZSh2bSwgZnJvbSwgc3RhcnQgLSBmcm9tKTsKLQlyZXR1cm4gLUVO
T01FTTsKK291dDoKKwlpZiAoYWxsb2MpCisJCWZyZWVfcHQodm0sIGFsbG9jKTsKKwlpbnRlbF9y
dW50aW1lX3BtX3B1dCgmdm0tPmk5MTUtPnJ1bnRpbWVfcG0sIHdha2VyZWYpOworCXJldHVybiBy
ZXQ7CiB9CiAKIHN0YXRpYyBpbnQgZ2VuNl9wcGd0dF9pbml0X3NjcmF0Y2goc3RydWN0IGdlbjZf
cHBndHQgKnBwZ3R0KQotLSAKMi4yMC4xCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fXwpJbnRlbC1nZnggbWFpbGluZyBsaXN0CkludGVsLWdmeEBsaXN0cy5m
cmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0
aW5mby9pbnRlbC1nZng=

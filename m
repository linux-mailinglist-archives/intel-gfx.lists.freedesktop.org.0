Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 91B4716BF67
	for <lists+intel-gfx@lfdr.de>; Tue, 25 Feb 2020 12:15:22 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 18CD06E8AF;
	Tue, 25 Feb 2020 11:15:19 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mga02.intel.com (mga02.intel.com [134.134.136.20])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 926B16E8AF
 for <intel-gfx@lists.freedesktop.org>; Tue, 25 Feb 2020 11:15:18 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga007.jf.intel.com ([10.7.209.58])
 by orsmga101.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 25 Feb 2020 03:15:17 -0800
X-IronPort-AV: E=Sophos;i="5.70,483,1574150400"; d="scan'208";a="226314269"
Received: from jnikula-mobl3.fi.intel.com (HELO localhost) ([10.237.66.161])
 by orsmga007-auth.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 25 Feb 2020 03:15:14 -0800
From: Jani Nikula <jani.nikula@intel.com>
To: intel-gfx@lists.freedesktop.org
Date: Tue, 25 Feb 2020 13:15:07 +0200
Message-Id: <20200225111509.21879-1-jani.nikula@intel.com>
X-Mailer: git-send-email 2.20.1
MIME-Version: 1.0
Organization: Intel Finland Oy - BIC 0357606-4 - Westendinkatu 7, 02160 Espoo
Subject: [Intel-gfx] [PATCH 1/3] drm/i915: split out intel_dram.[ch] from
 i915_drv.c
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: jani.nikula@intel.com
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

VGhlIERSQU0gcmVsYXRlZCByb3V0aW5lcyBhcmUgcHJldHR5IGlzb2xhdGVkIGZyb20gdGhlIHJl
c3Qgb2YgdGhlCmk5MTVfZHJ2LmMsIHNwbGl0IGl0IG91dCB0byBhIHNlcGFyYXRlIGZpbGUuIFB1
dCB0aGUgZURSQU0gc3R1ZmYgaW4gdGhlCnNhbWUgYmFnLCBhbmQgcmVuYW1lIHRoZSB2aXNpYmxl
IGZ1bmN0aW9ucyB0byBoYXZlIGludGVsX2RyYW1fCnByZWZpeC4gRG8gc29tZSBiZW5pZ24gd2hp
dGVzcGFjZSBmaXhlcyBhbmQgZGV2X3ByaXYgLT4gaTkxNSBjb252ZXJzaW9ucwp3aGlsZSBhdCBp
dC4KClNpZ25lZC1vZmYtYnk6IEphbmkgTmlrdWxhIDxqYW5pLm5pa3VsYUBpbnRlbC5jb20+Ci0t
LQogZHJpdmVycy9ncHUvZHJtL2k5MTUvTWFrZWZpbGUgICAgIHwgICAxICsKIGRyaXZlcnMvZ3B1
L2RybS9pOTE1L2k5MTVfZHJ2LmMgICB8IDQ5MyArLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2ludGVsX2RyYW0uYyB8IDQ4NyArKysrKysrKysrKysr
KysrKysrKysrKysrKysrKwogZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfZHJhbS5oIHwgIDE0
ICsKIDQgZmlsZXMgY2hhbmdlZCwgNTA1IGluc2VydGlvbnMoKyksIDQ5MCBkZWxldGlvbnMoLSkK
IGNyZWF0ZSBtb2RlIDEwMDY0NCBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pbnRlbF9kcmFtLmMKIGNy
ZWF0ZSBtb2RlIDEwMDY0NCBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pbnRlbF9kcmFtLmgKCmRpZmYg
LS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9NYWtlZmlsZSBiL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L01ha2VmaWxlCmluZGV4IGJjMjhjMzFjNGY3OC4uN2U0NzMxMzVlNjE3IDEwMDY0NAotLS0g
YS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9NYWtlZmlsZQorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9NYWtlZmlsZQpAQCAtNDcsNiArNDcsNyBAQCBpOTE1LXkgKz0gaTkxNV9kcnYubyBcCiAJICBp
OTE1X3N5c2ZzLm8gXAogCSAgaTkxNV91dGlscy5vIFwKIAkgIGludGVsX2RldmljZV9pbmZvLm8g
XAorCSAgaW50ZWxfZHJhbS5vIFwKIAkgIGludGVsX21lbW9yeV9yZWdpb24ubyBcCiAJICBpbnRl
bF9wY2gubyBcCiAJICBpbnRlbF9wbS5vIFwKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2k5MTVfZHJ2LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2Rydi5jCmluZGV4IGRi
YTVmZTEzOTFlOC4uN2YwZTBiYTkxOGU5IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9pOTE1X2Rydi5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZHJ2LmMKQEAgLTgw
LDYgKzgwLDcgQEAKICNpbmNsdWRlICJpOTE1X3N5c2ZzLmgiCiAjaW5jbHVkZSAiaTkxNV90cmFj
ZS5oIgogI2luY2x1ZGUgImk5MTVfdmdwdS5oIgorI2luY2x1ZGUgImludGVsX2RyYW0uaCIKICNp
bmNsdWRlICJpbnRlbF9tZW1vcnlfcmVnaW9uLmgiCiAjaW5jbHVkZSAiaW50ZWxfcG0uaCIKICNp
bmNsdWRlICJ2bHZfc3VzcGVuZC5oIgpAQCAtNTU4LDQ5NCArNTU5LDYgQEAgc3RhdGljIHZvaWQg
aW50ZWxfc2FuaXRpemVfb3B0aW9ucyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYp
CiAJaW50ZWxfZ3Z0X3Nhbml0aXplX29wdGlvbnMoZGV2X3ByaXYpOwogfQogCi0jZGVmaW5lIERS
QU1fVFlQRV9TVFIodHlwZSkgW0lOVEVMX0RSQU1fICMjIHR5cGVdID0gI3R5cGUKLQotc3RhdGlj
IGNvbnN0IGNoYXIgKmludGVsX2RyYW1fdHlwZV9zdHIoZW51bSBpbnRlbF9kcmFtX3R5cGUgdHlw
ZSkKLXsKLQlzdGF0aWMgY29uc3QgY2hhciAqIGNvbnN0IHN0cltdID0gewotCQlEUkFNX1RZUEVf
U1RSKFVOS05PV04pLAotCQlEUkFNX1RZUEVfU1RSKEREUjMpLAotCQlEUkFNX1RZUEVfU1RSKERE
UjQpLAotCQlEUkFNX1RZUEVfU1RSKExQRERSMyksCi0JCURSQU1fVFlQRV9TVFIoTFBERFI0KSwK
LQl9OwotCi0JaWYgKHR5cGUgPj0gQVJSQVlfU0laRShzdHIpKQotCQl0eXBlID0gSU5URUxfRFJB
TV9VTktOT1dOOwotCi0JcmV0dXJuIHN0clt0eXBlXTsKLX0KLQotI3VuZGVmIERSQU1fVFlQRV9T
VFIKLQotc3RhdGljIGludCBpbnRlbF9kaW1tX251bV9kZXZpY2VzKGNvbnN0IHN0cnVjdCBkcmFt
X2RpbW1faW5mbyAqZGltbSkKLXsKLQlyZXR1cm4gZGltbS0+cmFua3MgKiA2NCAvIChkaW1tLT53
aWR0aCA/OiAxKTsKLX0KLQotLyogUmV0dXJucyB0b3RhbCBHQiBmb3IgdGhlIHdob2xlIERJTU0g
Ki8KLXN0YXRpYyBpbnQgc2tsX2dldF9kaW1tX3NpemUodTE2IHZhbCkKLXsKLQlyZXR1cm4gdmFs
ICYgU0tMX0RSQU1fU0laRV9NQVNLOwotfQotCi1zdGF0aWMgaW50IHNrbF9nZXRfZGltbV93aWR0
aCh1MTYgdmFsKQotewotCWlmIChza2xfZ2V0X2RpbW1fc2l6ZSh2YWwpID09IDApCi0JCXJldHVy
biAwOwotCi0Jc3dpdGNoICh2YWwgJiBTS0xfRFJBTV9XSURUSF9NQVNLKSB7Ci0JY2FzZSBTS0xf
RFJBTV9XSURUSF9YODoKLQljYXNlIFNLTF9EUkFNX1dJRFRIX1gxNjoKLQljYXNlIFNLTF9EUkFN
X1dJRFRIX1gzMjoKLQkJdmFsID0gKHZhbCAmIFNLTF9EUkFNX1dJRFRIX01BU0spID4+IFNLTF9E
UkFNX1dJRFRIX1NISUZUOwotCQlyZXR1cm4gOCA8PCB2YWw7Ci0JZGVmYXVsdDoKLQkJTUlTU0lO
R19DQVNFKHZhbCk7Ci0JCXJldHVybiAwOwotCX0KLX0KLQotc3RhdGljIGludCBza2xfZ2V0X2Rp
bW1fcmFua3ModTE2IHZhbCkKLXsKLQlpZiAoc2tsX2dldF9kaW1tX3NpemUodmFsKSA9PSAwKQot
CQlyZXR1cm4gMDsKLQotCXZhbCA9ICh2YWwgJiBTS0xfRFJBTV9SQU5LX01BU0spID4+IFNLTF9E
UkFNX1JBTktfU0hJRlQ7Ci0KLQlyZXR1cm4gdmFsICsgMTsKLX0KLQotLyogUmV0dXJucyB0b3Rh
bCBHQiBmb3IgdGhlIHdob2xlIERJTU0gKi8KLXN0YXRpYyBpbnQgY25sX2dldF9kaW1tX3NpemUo
dTE2IHZhbCkKLXsKLQlyZXR1cm4gKHZhbCAmIENOTF9EUkFNX1NJWkVfTUFTSykgLyAyOwotfQot
Ci1zdGF0aWMgaW50IGNubF9nZXRfZGltbV93aWR0aCh1MTYgdmFsKQotewotCWlmIChjbmxfZ2V0
X2RpbW1fc2l6ZSh2YWwpID09IDApCi0JCXJldHVybiAwOwotCi0Jc3dpdGNoICh2YWwgJiBDTkxf
RFJBTV9XSURUSF9NQVNLKSB7Ci0JY2FzZSBDTkxfRFJBTV9XSURUSF9YODoKLQljYXNlIENOTF9E
UkFNX1dJRFRIX1gxNjoKLQljYXNlIENOTF9EUkFNX1dJRFRIX1gzMjoKLQkJdmFsID0gKHZhbCAm
IENOTF9EUkFNX1dJRFRIX01BU0spID4+IENOTF9EUkFNX1dJRFRIX1NISUZUOwotCQlyZXR1cm4g
OCA8PCB2YWw7Ci0JZGVmYXVsdDoKLQkJTUlTU0lOR19DQVNFKHZhbCk7Ci0JCXJldHVybiAwOwot
CX0KLX0KLQotc3RhdGljIGludCBjbmxfZ2V0X2RpbW1fcmFua3ModTE2IHZhbCkKLXsKLQlpZiAo
Y25sX2dldF9kaW1tX3NpemUodmFsKSA9PSAwKQotCQlyZXR1cm4gMDsKLQotCXZhbCA9ICh2YWwg
JiBDTkxfRFJBTV9SQU5LX01BU0spID4+IENOTF9EUkFNX1JBTktfU0hJRlQ7Ci0KLQlyZXR1cm4g
dmFsICsgMTsKLX0KLQotc3RhdGljIGJvb2wKLXNrbF9pc18xNmdiX2RpbW0oY29uc3Qgc3RydWN0
IGRyYW1fZGltbV9pbmZvICpkaW1tKQotewotCS8qIENvbnZlcnQgdG90YWwgR0IgdG8gR2IgcGVy
IERSQU0gZGV2aWNlICovCi0JcmV0dXJuIDggKiBkaW1tLT5zaXplIC8gKGludGVsX2RpbW1fbnVt
X2RldmljZXMoZGltbSkgPzogMSkgPT0gMTY7Ci19Ci0KLXN0YXRpYyB2b2lkCi1za2xfZHJhbV9n
ZXRfZGltbV9pbmZvKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiwKLQkJICAgICAg
IHN0cnVjdCBkcmFtX2RpbW1faW5mbyAqZGltbSwKLQkJICAgICAgIGludCBjaGFubmVsLCBjaGFy
IGRpbW1fbmFtZSwgdTE2IHZhbCkKLXsKLQlpZiAoSU5URUxfR0VOKGRldl9wcml2KSA+PSAxMCkg
ewotCQlkaW1tLT5zaXplID0gY25sX2dldF9kaW1tX3NpemUodmFsKTsKLQkJZGltbS0+d2lkdGgg
PSBjbmxfZ2V0X2RpbW1fd2lkdGgodmFsKTsKLQkJZGltbS0+cmFua3MgPSBjbmxfZ2V0X2RpbW1f
cmFua3ModmFsKTsKLQl9IGVsc2UgewotCQlkaW1tLT5zaXplID0gc2tsX2dldF9kaW1tX3NpemUo
dmFsKTsKLQkJZGltbS0+d2lkdGggPSBza2xfZ2V0X2RpbW1fd2lkdGgodmFsKTsKLQkJZGltbS0+
cmFua3MgPSBza2xfZ2V0X2RpbW1fcmFua3ModmFsKTsKLQl9Ci0KLQlkcm1fZGJnX2ttcygmZGV2
X3ByaXYtPmRybSwKLQkJICAgICJDSCV1IERJTU0gJWMgc2l6ZTogJXUgR0IsIHdpZHRoOiBYJXUs
IHJhbmtzOiAldSwgMTZHYiBESU1NczogJXNcbiIsCi0JCSAgICBjaGFubmVsLCBkaW1tX25hbWUs
IGRpbW0tPnNpemUsIGRpbW0tPndpZHRoLCBkaW1tLT5yYW5rcywKLQkJICAgIHllc25vKHNrbF9p
c18xNmdiX2RpbW0oZGltbSkpKTsKLX0KLQotc3RhdGljIGludAotc2tsX2RyYW1fZ2V0X2NoYW5u
ZWxfaW5mbyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYsCi0JCQkgIHN0cnVjdCBk
cmFtX2NoYW5uZWxfaW5mbyAqY2gsCi0JCQkgIGludCBjaGFubmVsLCB1MzIgdmFsKQotewotCXNr
bF9kcmFtX2dldF9kaW1tX2luZm8oZGV2X3ByaXYsICZjaC0+ZGltbV9sLAotCQkJICAgICAgIGNo
YW5uZWwsICdMJywgdmFsICYgMHhmZmZmKTsKLQlza2xfZHJhbV9nZXRfZGltbV9pbmZvKGRldl9w
cml2LCAmY2gtPmRpbW1fcywKLQkJCSAgICAgICBjaGFubmVsLCAnUycsIHZhbCA+PiAxNik7Ci0K
LQlpZiAoY2gtPmRpbW1fbC5zaXplID09IDAgJiYgY2gtPmRpbW1fcy5zaXplID09IDApIHsKLQkJ
ZHJtX2RiZ19rbXMoJmRldl9wcml2LT5kcm0sICJDSCV1IG5vdCBwb3B1bGF0ZWRcbiIsIGNoYW5u
ZWwpOwotCQlyZXR1cm4gLUVJTlZBTDsKLQl9Ci0KLQlpZiAoY2gtPmRpbW1fbC5yYW5rcyA9PSAy
IHx8IGNoLT5kaW1tX3MucmFua3MgPT0gMikKLQkJY2gtPnJhbmtzID0gMjsKLQllbHNlIGlmIChj
aC0+ZGltbV9sLnJhbmtzID09IDEgJiYgY2gtPmRpbW1fcy5yYW5rcyA9PSAxKQotCQljaC0+cmFu
a3MgPSAyOwotCWVsc2UKLQkJY2gtPnJhbmtzID0gMTsKLQotCWNoLT5pc18xNmdiX2RpbW0gPQot
CQlza2xfaXNfMTZnYl9kaW1tKCZjaC0+ZGltbV9sKSB8fAotCQlza2xfaXNfMTZnYl9kaW1tKCZj
aC0+ZGltbV9zKTsKLQotCWRybV9kYmdfa21zKCZkZXZfcHJpdi0+ZHJtLCAiQ0gldSByYW5rczog
JXUsIDE2R2IgRElNTXM6ICVzXG4iLAotCQkgICAgY2hhbm5lbCwgY2gtPnJhbmtzLCB5ZXNubyhj
aC0+aXNfMTZnYl9kaW1tKSk7Ci0KLQlyZXR1cm4gMDsKLX0KLQotc3RhdGljIGJvb2wKLWludGVs
X2lzX2RyYW1fc3ltbWV0cmljKGNvbnN0IHN0cnVjdCBkcmFtX2NoYW5uZWxfaW5mbyAqY2gwLAot
CQkJY29uc3Qgc3RydWN0IGRyYW1fY2hhbm5lbF9pbmZvICpjaDEpCi17Ci0JcmV0dXJuICFtZW1j
bXAoY2gwLCBjaDEsIHNpemVvZigqY2gwKSkgJiYKLQkJKGNoMC0+ZGltbV9zLnNpemUgPT0gMCB8
fAotCQkgIW1lbWNtcCgmY2gwLT5kaW1tX2wsICZjaDAtPmRpbW1fcywgc2l6ZW9mKGNoMC0+ZGlt
bV9sKSkpOwotfQotCi1zdGF0aWMgaW50Ci1za2xfZHJhbV9nZXRfY2hhbm5lbHNfaW5mbyhzdHJ1
Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYpCi17Ci0Jc3RydWN0IGRyYW1faW5mbyAqZHJh
bV9pbmZvID0gJmRldl9wcml2LT5kcmFtX2luZm87Ci0Jc3RydWN0IGRyYW1fY2hhbm5lbF9pbmZv
IGNoMCA9IHt9LCBjaDEgPSB7fTsKLQl1MzIgdmFsOwotCWludCByZXQ7Ci0KLQl2YWwgPSBJOTE1
X1JFQUQoU0tMX01BRF9ESU1NX0NIMF8wXzBfMF9NQ0hCQVJfTUNNQUlOKTsKLQlyZXQgPSBza2xf
ZHJhbV9nZXRfY2hhbm5lbF9pbmZvKGRldl9wcml2LCAmY2gwLCAwLCB2YWwpOwotCWlmIChyZXQg
PT0gMCkKLQkJZHJhbV9pbmZvLT5udW1fY2hhbm5lbHMrKzsKLQotCXZhbCA9IEk5MTVfUkVBRChT
S0xfTUFEX0RJTU1fQ0gxXzBfMF8wX01DSEJBUl9NQ01BSU4pOwotCXJldCA9IHNrbF9kcmFtX2dl
dF9jaGFubmVsX2luZm8oZGV2X3ByaXYsICZjaDEsIDEsIHZhbCk7Ci0JaWYgKHJldCA9PSAwKQot
CQlkcmFtX2luZm8tPm51bV9jaGFubmVscysrOwotCi0JaWYgKGRyYW1faW5mby0+bnVtX2NoYW5u
ZWxzID09IDApIHsKLQkJZHJtX2luZm8oJmRldl9wcml2LT5kcm0sCi0JCQkgIk51bWJlciBvZiBt
ZW1vcnkgY2hhbm5lbHMgaXMgemVyb1xuIik7Ci0JCXJldHVybiAtRUlOVkFMOwotCX0KLQotCS8q
Ci0JICogSWYgYW55IG9mIHRoZSBjaGFubmVsIGlzIHNpbmdsZSByYW5rIGNoYW5uZWwsIHdvcnN0
IGNhc2Ugb3V0cHV0Ci0JICogd2lsbCBiZSBzYW1lIGFzIGlmIHNpbmdsZSByYW5rIG1lbW9yeSwg
c28gY29uc2lkZXIgc2luZ2xlIHJhbmsKLQkgKiBtZW1vcnkuCi0JICovCi0JaWYgKGNoMC5yYW5r
cyA9PSAxIHx8IGNoMS5yYW5rcyA9PSAxKQotCQlkcmFtX2luZm8tPnJhbmtzID0gMTsKLQllbHNl
Ci0JCWRyYW1faW5mby0+cmFua3MgPSBtYXgoY2gwLnJhbmtzLCBjaDEucmFua3MpOwotCi0JaWYg
KGRyYW1faW5mby0+cmFua3MgPT0gMCkgewotCQlkcm1faW5mbygmZGV2X3ByaXYtPmRybSwKLQkJ
CSAiY291bGRuJ3QgZ2V0IG1lbW9yeSByYW5rIGluZm9ybWF0aW9uXG4iKTsKLQkJcmV0dXJuIC1F
SU5WQUw7Ci0JfQotCi0JZHJhbV9pbmZvLT5pc18xNmdiX2RpbW0gPSBjaDAuaXNfMTZnYl9kaW1t
IHx8IGNoMS5pc18xNmdiX2RpbW07Ci0KLQlkcmFtX2luZm8tPnN5bW1ldHJpY19tZW1vcnkgPSBp
bnRlbF9pc19kcmFtX3N5bW1ldHJpYygmY2gwLCAmY2gxKTsKLQotCWRybV9kYmdfa21zKCZkZXZf
cHJpdi0+ZHJtLCAiTWVtb3J5IGNvbmZpZ3VyYXRpb24gaXMgc3ltbWV0cmljPyAlc1xuIiwKLQkJ
ICAgIHllc25vKGRyYW1faW5mby0+c3ltbWV0cmljX21lbW9yeSkpOwotCXJldHVybiAwOwotfQot
Ci1zdGF0aWMgZW51bSBpbnRlbF9kcmFtX3R5cGUKLXNrbF9nZXRfZHJhbV90eXBlKHN0cnVjdCBk
cm1faTkxNV9wcml2YXRlICpkZXZfcHJpdikKLXsKLQl1MzIgdmFsOwotCi0JdmFsID0gSTkxNV9S
RUFEKFNLTF9NQURfSU5URVJfQ0hBTk5FTF8wXzBfMF9NQ0hCQVJfTUNNQUlOKTsKLQotCXN3aXRj
aCAodmFsICYgU0tMX0RSQU1fRERSX1RZUEVfTUFTSykgewotCWNhc2UgU0tMX0RSQU1fRERSX1RZ
UEVfRERSMzoKLQkJcmV0dXJuIElOVEVMX0RSQU1fRERSMzsKLQljYXNlIFNLTF9EUkFNX0REUl9U
WVBFX0REUjQ6Ci0JCXJldHVybiBJTlRFTF9EUkFNX0REUjQ7Ci0JY2FzZSBTS0xfRFJBTV9ERFJf
VFlQRV9MUEREUjM6Ci0JCXJldHVybiBJTlRFTF9EUkFNX0xQRERSMzsKLQljYXNlIFNLTF9EUkFN
X0REUl9UWVBFX0xQRERSNDoKLQkJcmV0dXJuIElOVEVMX0RSQU1fTFBERFI0OwotCWRlZmF1bHQ6
Ci0JCU1JU1NJTkdfQ0FTRSh2YWwpOwotCQlyZXR1cm4gSU5URUxfRFJBTV9VTktOT1dOOwotCX0K
LX0KLQotc3RhdGljIGludAotc2tsX2dldF9kcmFtX2luZm8oc3RydWN0IGRybV9pOTE1X3ByaXZh
dGUgKmRldl9wcml2KQotewotCXN0cnVjdCBkcmFtX2luZm8gKmRyYW1faW5mbyA9ICZkZXZfcHJp
di0+ZHJhbV9pbmZvOwotCXUzMiBtZW1fZnJlcV9raHosIHZhbDsKLQlpbnQgcmV0OwotCi0JZHJh
bV9pbmZvLT50eXBlID0gc2tsX2dldF9kcmFtX3R5cGUoZGV2X3ByaXYpOwotCWRybV9kYmdfa21z
KCZkZXZfcHJpdi0+ZHJtLCAiRFJBTSB0eXBlOiAlc1xuIiwKLQkJICAgIGludGVsX2RyYW1fdHlw
ZV9zdHIoZHJhbV9pbmZvLT50eXBlKSk7Ci0KLQlyZXQgPSBza2xfZHJhbV9nZXRfY2hhbm5lbHNf
aW5mbyhkZXZfcHJpdik7Ci0JaWYgKHJldCkKLQkJcmV0dXJuIHJldDsKLQotCXZhbCA9IEk5MTVf
UkVBRChTS0xfTUNfQklPU19EQVRBXzBfMF8wX01DSEJBUl9QQ1UpOwotCW1lbV9mcmVxX2toeiA9
IERJVl9ST1VORF9VUCgodmFsICYgU0tMX1JFUV9EQVRBX01BU0spICoKLQkJCQkgICAgU0tMX01F
TU9SWV9GUkVRX01VTFRJUExJRVJfSFosIDEwMDApOwotCi0JZHJhbV9pbmZvLT5iYW5kd2lkdGhf
a2JwcyA9IGRyYW1faW5mby0+bnVtX2NoYW5uZWxzICoKLQkJCQkJCQltZW1fZnJlcV9raHogKiA4
OwotCi0JaWYgKGRyYW1faW5mby0+YmFuZHdpZHRoX2ticHMgPT0gMCkgewotCQlkcm1faW5mbygm
ZGV2X3ByaXYtPmRybSwKLQkJCSAiQ291bGRuJ3QgZ2V0IHN5c3RlbSBtZW1vcnkgYmFuZHdpZHRo
XG4iKTsKLQkJcmV0dXJuIC1FSU5WQUw7Ci0JfQotCi0JZHJhbV9pbmZvLT52YWxpZCA9IHRydWU7
Ci0JcmV0dXJuIDA7Ci19Ci0KLS8qIFJldHVybnMgR2IgcGVyIERSQU0gZGV2aWNlICovCi1zdGF0
aWMgaW50IGJ4dF9nZXRfZGltbV9zaXplKHUzMiB2YWwpCi17Ci0Jc3dpdGNoICh2YWwgJiBCWFRf
RFJBTV9TSVpFX01BU0spIHsKLQljYXNlIEJYVF9EUkFNX1NJWkVfNEdCSVQ6Ci0JCXJldHVybiA0
OwotCWNhc2UgQlhUX0RSQU1fU0laRV82R0JJVDoKLQkJcmV0dXJuIDY7Ci0JY2FzZSBCWFRfRFJB
TV9TSVpFXzhHQklUOgotCQlyZXR1cm4gODsKLQljYXNlIEJYVF9EUkFNX1NJWkVfMTJHQklUOgot
CQlyZXR1cm4gMTI7Ci0JY2FzZSBCWFRfRFJBTV9TSVpFXzE2R0JJVDoKLQkJcmV0dXJuIDE2Owot
CWRlZmF1bHQ6Ci0JCU1JU1NJTkdfQ0FTRSh2YWwpOwotCQlyZXR1cm4gMDsKLQl9Ci19Ci0KLXN0
YXRpYyBpbnQgYnh0X2dldF9kaW1tX3dpZHRoKHUzMiB2YWwpCi17Ci0JaWYgKCFieHRfZ2V0X2Rp
bW1fc2l6ZSh2YWwpKQotCQlyZXR1cm4gMDsKLQotCXZhbCA9ICh2YWwgJiBCWFRfRFJBTV9XSURU
SF9NQVNLKSA+PiBCWFRfRFJBTV9XSURUSF9TSElGVDsKLQotCXJldHVybiA4IDw8IHZhbDsKLX0K
LQotc3RhdGljIGludCBieHRfZ2V0X2RpbW1fcmFua3ModTMyIHZhbCkKLXsKLQlpZiAoIWJ4dF9n
ZXRfZGltbV9zaXplKHZhbCkpCi0JCXJldHVybiAwOwotCi0Jc3dpdGNoICh2YWwgJiBCWFRfRFJB
TV9SQU5LX01BU0spIHsKLQljYXNlIEJYVF9EUkFNX1JBTktfU0lOR0xFOgotCQlyZXR1cm4gMTsK
LQljYXNlIEJYVF9EUkFNX1JBTktfRFVBTDoKLQkJcmV0dXJuIDI7Ci0JZGVmYXVsdDoKLQkJTUlT
U0lOR19DQVNFKHZhbCk7Ci0JCXJldHVybiAwOwotCX0KLX0KLQotc3RhdGljIGVudW0gaW50ZWxf
ZHJhbV90eXBlIGJ4dF9nZXRfZGltbV90eXBlKHUzMiB2YWwpCi17Ci0JaWYgKCFieHRfZ2V0X2Rp
bW1fc2l6ZSh2YWwpKQotCQlyZXR1cm4gSU5URUxfRFJBTV9VTktOT1dOOwotCi0Jc3dpdGNoICh2
YWwgJiBCWFRfRFJBTV9UWVBFX01BU0spIHsKLQljYXNlIEJYVF9EUkFNX1RZUEVfRERSMzoKLQkJ
cmV0dXJuIElOVEVMX0RSQU1fRERSMzsKLQljYXNlIEJYVF9EUkFNX1RZUEVfTFBERFIzOgotCQly
ZXR1cm4gSU5URUxfRFJBTV9MUEREUjM7Ci0JY2FzZSBCWFRfRFJBTV9UWVBFX0REUjQ6Ci0JCXJl
dHVybiBJTlRFTF9EUkFNX0REUjQ7Ci0JY2FzZSBCWFRfRFJBTV9UWVBFX0xQRERSNDoKLQkJcmV0
dXJuIElOVEVMX0RSQU1fTFBERFI0OwotCWRlZmF1bHQ6Ci0JCU1JU1NJTkdfQ0FTRSh2YWwpOwot
CQlyZXR1cm4gSU5URUxfRFJBTV9VTktOT1dOOwotCX0KLX0KLQotc3RhdGljIHZvaWQgYnh0X2dl
dF9kaW1tX2luZm8oc3RydWN0IGRyYW1fZGltbV9pbmZvICpkaW1tLAotCQkJICAgICAgdTMyIHZh
bCkKLXsKLQlkaW1tLT53aWR0aCA9IGJ4dF9nZXRfZGltbV93aWR0aCh2YWwpOwotCWRpbW0tPnJh
bmtzID0gYnh0X2dldF9kaW1tX3JhbmtzKHZhbCk7Ci0KLQkvKgotCSAqIFNpemUgaW4gcmVnaXN0
ZXIgaXMgR2IgcGVyIERSQU0gZGV2aWNlLiBDb252ZXJ0IHRvIHRvdGFsCi0JICogR0IgdG8gbWF0
Y2ggdGhlIHdheSB3ZSByZXBvcnQgdGhpcyBmb3Igbm9uLUxQIHBsYXRmb3Jtcy4KLQkgKi8KLQlk
aW1tLT5zaXplID0gYnh0X2dldF9kaW1tX3NpemUodmFsKSAqIGludGVsX2RpbW1fbnVtX2Rldmlj
ZXMoZGltbSkgLyA4OwotfQotCi1zdGF0aWMgaW50Ci1ieHRfZ2V0X2RyYW1faW5mbyhzdHJ1Y3Qg
ZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYpCi17Ci0Jc3RydWN0IGRyYW1faW5mbyAqZHJhbV9p
bmZvID0gJmRldl9wcml2LT5kcmFtX2luZm87Ci0JdTMyIGRyYW1fY2hhbm5lbHM7Ci0JdTMyIG1l
bV9mcmVxX2toeiwgdmFsOwotCXU4IG51bV9hY3RpdmVfY2hhbm5lbHM7Ci0JaW50IGk7Ci0KLQl2
YWwgPSBJOTE1X1JFQUQoQlhUX1BfQ1JfTUNfQklPU19SRVFfMF8wXzApOwotCW1lbV9mcmVxX2to
eiA9IERJVl9ST1VORF9VUCgodmFsICYgQlhUX1JFUV9EQVRBX01BU0spICoKLQkJCQkgICAgQlhU
X01FTU9SWV9GUkVRX01VTFRJUExJRVJfSFosIDEwMDApOwotCi0JZHJhbV9jaGFubmVscyA9IHZh
bCAmIEJYVF9EUkFNX0NIQU5ORUxfQUNUSVZFX01BU0s7Ci0JbnVtX2FjdGl2ZV9jaGFubmVscyA9
IGh3ZWlnaHQzMihkcmFtX2NoYW5uZWxzKTsKLQotCS8qIEVhY2ggYWN0aXZlIGJpdCByZXByZXNl
bnRzIDQtYnl0ZSBjaGFubmVsICovCi0JZHJhbV9pbmZvLT5iYW5kd2lkdGhfa2JwcyA9IChtZW1f
ZnJlcV9raHogKiBudW1fYWN0aXZlX2NoYW5uZWxzICogNCk7Ci0KLQlpZiAoZHJhbV9pbmZvLT5i
YW5kd2lkdGhfa2JwcyA9PSAwKSB7Ci0JCWRybV9pbmZvKCZkZXZfcHJpdi0+ZHJtLAotCQkJICJD
b3VsZG4ndCBnZXQgc3lzdGVtIG1lbW9yeSBiYW5kd2lkdGhcbiIpOwotCQlyZXR1cm4gLUVJTlZB
TDsKLQl9Ci0KLQkvKgotCSAqIE5vdyByZWFkIGVhY2ggRFVOSVQ4LzkvMTAvMTEgdG8gY2hlY2sg
dGhlIHJhbmsgb2YgZWFjaCBkaW1tcy4KLQkgKi8KLQlmb3IgKGkgPSBCWFRfRF9DUl9EUlAwX0RV
TklUX1NUQVJUOyBpIDw9IEJYVF9EX0NSX0RSUDBfRFVOSVRfRU5EOyBpKyspIHsKLQkJc3RydWN0
IGRyYW1fZGltbV9pbmZvIGRpbW07Ci0JCWVudW0gaW50ZWxfZHJhbV90eXBlIHR5cGU7Ci0KLQkJ
dmFsID0gSTkxNV9SRUFEKEJYVF9EX0NSX0RSUDBfRFVOSVQoaSkpOwotCQlpZiAodmFsID09IDB4
RkZGRkZGRkYpCi0JCQljb250aW51ZTsKLQotCQlkcmFtX2luZm8tPm51bV9jaGFubmVscysrOwot
Ci0JCWJ4dF9nZXRfZGltbV9pbmZvKCZkaW1tLCB2YWwpOwotCQl0eXBlID0gYnh0X2dldF9kaW1t
X3R5cGUodmFsKTsKLQotCQlkcm1fV0FSTl9PTigmZGV2X3ByaXYtPmRybSwgdHlwZSAhPSBJTlRF
TF9EUkFNX1VOS05PV04gJiYKLQkJCSAgICBkcmFtX2luZm8tPnR5cGUgIT0gSU5URUxfRFJBTV9V
TktOT1dOICYmCi0JCQkgICAgZHJhbV9pbmZvLT50eXBlICE9IHR5cGUpOwotCi0JCWRybV9kYmdf
a21zKCZkZXZfcHJpdi0+ZHJtLAotCQkJICAgICJDSCV1IERJTU0gc2l6ZTogJXUgR0IsIHdpZHRo
OiBYJXUsIHJhbmtzOiAldSwgdHlwZTogJXNcbiIsCi0JCQkgICAgaSAtIEJYVF9EX0NSX0RSUDBf
RFVOSVRfU1RBUlQsCi0JCQkgICAgZGltbS5zaXplLCBkaW1tLndpZHRoLCBkaW1tLnJhbmtzLAot
CQkJICAgIGludGVsX2RyYW1fdHlwZV9zdHIodHlwZSkpOwotCi0JCS8qCi0JCSAqIElmIGFueSBv
ZiB0aGUgY2hhbm5lbCBpcyBzaW5nbGUgcmFuayBjaGFubmVsLAotCQkgKiB3b3JzdCBjYXNlIG91
dHB1dCB3aWxsIGJlIHNhbWUgYXMgaWYgc2luZ2xlIHJhbmsKLQkJICogbWVtb3J5LCBzbyBjb25z
aWRlciBzaW5nbGUgcmFuayBtZW1vcnkuCi0JCSAqLwotCQlpZiAoZHJhbV9pbmZvLT5yYW5rcyA9
PSAwKQotCQkJZHJhbV9pbmZvLT5yYW5rcyA9IGRpbW0ucmFua3M7Ci0JCWVsc2UgaWYgKGRpbW0u
cmFua3MgPT0gMSkKLQkJCWRyYW1faW5mby0+cmFua3MgPSAxOwotCi0JCWlmICh0eXBlICE9IElO
VEVMX0RSQU1fVU5LTk9XTikKLQkJCWRyYW1faW5mby0+dHlwZSA9IHR5cGU7Ci0JfQotCi0JaWYg
KGRyYW1faW5mby0+dHlwZSA9PSBJTlRFTF9EUkFNX1VOS05PV04gfHwKLQkgICAgZHJhbV9pbmZv
LT5yYW5rcyA9PSAwKSB7Ci0JCWRybV9pbmZvKCZkZXZfcHJpdi0+ZHJtLCAiY291bGRuJ3QgZ2V0
IG1lbW9yeSBpbmZvcm1hdGlvblxuIik7Ci0JCXJldHVybiAtRUlOVkFMOwotCX0KLQotCWRyYW1f
aW5mby0+dmFsaWQgPSB0cnVlOwotCXJldHVybiAwOwotfQotCi1zdGF0aWMgdm9pZAotaW50ZWxf
Z2V0X2RyYW1faW5mbyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYpCi17Ci0Jc3Ry
dWN0IGRyYW1faW5mbyAqZHJhbV9pbmZvID0gJmRldl9wcml2LT5kcmFtX2luZm87Ci0JaW50IHJl
dDsKLQotCS8qCi0JICogQXNzdW1lIDE2R2IgRElNTXMgYXJlIHByZXNlbnQgdW50aWwgcHJvdmVu
IG90aGVyd2lzZS4KLQkgKiBUaGlzIGlzIG9ubHkgdXNlZCBmb3IgdGhlIGxldmVsIDAgd2F0ZXJt
YXJrIGxhdGVuY3kKLQkgKiB3L2Egd2hpY2ggZG9lcyBub3QgYXBwbHkgdG8gYnh0L2dsay4KLQkg
Ki8KLQlkcmFtX2luZm8tPmlzXzE2Z2JfZGltbSA9ICFJU19HRU45X0xQKGRldl9wcml2KTsKLQot
CWlmIChJTlRFTF9HRU4oZGV2X3ByaXYpIDwgOSB8fCAhSEFTX0RJU1BMQVkoZGV2X3ByaXYpKQot
CQlyZXR1cm47Ci0KLQlpZiAoSVNfR0VOOV9MUChkZXZfcHJpdikpCi0JCXJldCA9IGJ4dF9nZXRf
ZHJhbV9pbmZvKGRldl9wcml2KTsKLQllbHNlCi0JCXJldCA9IHNrbF9nZXRfZHJhbV9pbmZvKGRl
dl9wcml2KTsKLQlpZiAocmV0KQotCQlyZXR1cm47Ci0KLQlkcm1fZGJnX2ttcygmZGV2X3ByaXYt
PmRybSwgIkRSQU0gYmFuZHdpZHRoOiAldSBrQnBzLCBjaGFubmVsczogJXVcbiIsCi0JCSAgICBk
cmFtX2luZm8tPmJhbmR3aWR0aF9rYnBzLAotCQkgICAgZHJhbV9pbmZvLT5udW1fY2hhbm5lbHMp
OwotCi0JZHJtX2RiZ19rbXMoJmRldl9wcml2LT5kcm0sICJEUkFNIHJhbmtzOiAldSwgMTZHYiBE
SU1NczogJXNcbiIsCi0JCSAgICBkcmFtX2luZm8tPnJhbmtzLCB5ZXNubyhkcmFtX2luZm8tPmlz
XzE2Z2JfZGltbSkpOwotfQotCi1zdGF0aWMgdTMyIGdlbjlfZWRyYW1fc2l6ZV9tYihzdHJ1Y3Qg
ZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYsIHUzMiBjYXApCi17Ci0Jc3RhdGljIGNvbnN0IHU4
IHdheXNbOF0gPSB7IDQsIDgsIDEyLCAxNiwgMTYsIDE2LCAxNiwgMTYgfTsKLQlzdGF0aWMgY29u
c3QgdTggc2V0c1s0XSA9IHsgMSwgMSwgMiwgMiB9OwotCi0JcmV0dXJuIEVEUkFNX05VTV9CQU5L
UyhjYXApICoKLQkJd2F5c1tFRFJBTV9XQVlTX0lEWChjYXApXSAqCi0JCXNldHNbRURSQU1fU0VU
U19JRFgoY2FwKV07Ci19Ci0KLXN0YXRpYyB2b2lkIGVkcmFtX2RldGVjdChzdHJ1Y3QgZHJtX2k5
MTVfcHJpdmF0ZSAqZGV2X3ByaXYpCi17Ci0JdTMyIGVkcmFtX2NhcCA9IDA7Ci0KLQlpZiAoIShJ
U19IQVNXRUxMKGRldl9wcml2KSB8fAotCSAgICAgIElTX0JST0FEV0VMTChkZXZfcHJpdikgfHwK
LQkgICAgICBJTlRFTF9HRU4oZGV2X3ByaXYpID49IDkpKQotCQlyZXR1cm47Ci0KLQllZHJhbV9j
YXAgPSBfX3Jhd191bmNvcmVfcmVhZDMyKCZkZXZfcHJpdi0+dW5jb3JlLCBIU1dfRURSQU1fQ0FQ
KTsKLQotCS8qIE5COiBXZSBjYW4ndCB3cml0ZSBJRElDUiB5ZXQgYmVjYXVzZSB3ZSBkb24ndCBo
YXZlIGd0IGZ1bmNzIHNldCB1cCAqLwotCi0JaWYgKCEoZWRyYW1fY2FwICYgRURSQU1fRU5BQkxF
RCkpCi0JCXJldHVybjsKLQotCS8qCi0JICogVGhlIG5lZWRlZCBjYXBhYmlsaXR5IGJpdHMgZm9y
IHNpemUgY2FsY3VsYXRpb24gYXJlIG5vdCB0aGVyZSB3aXRoCi0JICogcHJlIGdlbjkgc28gcmV0
dXJuIDEyOE1CIGFsd2F5cy4KLQkgKi8KLQlpZiAoSU5URUxfR0VOKGRldl9wcml2KSA8IDkpCi0J
CWRldl9wcml2LT5lZHJhbV9zaXplX21iID0gMTI4OwotCWVsc2UKLQkJZGV2X3ByaXYtPmVkcmFt
X3NpemVfbWIgPQotCQkJZ2VuOV9lZHJhbV9zaXplX21iKGRldl9wcml2LCBlZHJhbV9jYXApOwot
Ci0JZGV2X2luZm8oZGV2X3ByaXYtPmRybS5kZXYsCi0JCSAiRm91bmQgJXVNQiBvZiBlRFJBTVxu
IiwgZGV2X3ByaXYtPmVkcmFtX3NpemVfbWIpOwotfQotCiAvKioKICAqIGk5MTVfZHJpdmVyX2h3
X3Byb2JlIC0gc2V0dXAgc3RhdGUgcmVxdWlyaW5nIGRldmljZSBhY2Nlc3MKICAqIEBkZXZfcHJp
djogZGV2aWNlIHByaXZhdGUKQEAgLTEwODksNyArNjAyLDcgQEAgc3RhdGljIGludCBpOTE1X2Ry
aXZlcl9od19wcm9iZShzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYpCiAJaW50ZWxf
c2FuaXRpemVfb3B0aW9ucyhkZXZfcHJpdik7CiAKIAkvKiBuZWVkcyB0byBiZSBkb25lIGJlZm9y
ZSBnZ3R0IHByb2JlICovCi0JZWRyYW1fZGV0ZWN0KGRldl9wcml2KTsKKwlpbnRlbF9kcmFtX2Vk
cmFtX2RldGVjdChkZXZfcHJpdik7CiAKIAlpOTE1X3BlcmZfaW5pdChkZXZfcHJpdik7CiAKQEAg
LTExOTEsNyArNzA0LDcgQEAgc3RhdGljIGludCBpOTE1X2RyaXZlcl9od19wcm9iZShzdHJ1Y3Qg
ZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYpCiAJICogRmlsbCB0aGUgZHJhbSBzdHJ1Y3R1cmUg
dG8gZ2V0IHRoZSBzeXN0ZW0gcmF3IGJhbmR3aWR0aCBhbmQKIAkgKiBkcmFtIGluZm8uIFRoaXMg
d2lsbCBiZSB1c2VkIGZvciBtZW1vcnkgbGF0ZW5jeSBjYWxjdWxhdGlvbi4KIAkgKi8KLQlpbnRl
bF9nZXRfZHJhbV9pbmZvKGRldl9wcml2KTsKKwlpbnRlbF9kcmFtX2RldGVjdChkZXZfcHJpdik7
CiAKIAlpbnRlbF9id19pbml0X2h3KGRldl9wcml2KTsKIApkaWZmIC0tZ2l0IGEvZHJpdmVycy9n
cHUvZHJtL2k5MTUvaW50ZWxfZHJhbS5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfZHJh
bS5jCm5ldyBmaWxlIG1vZGUgMTAwNjQ0CmluZGV4IDAwMDAwMDAwMDAwMC4uY2FiZTdiNWRlNGUw
Ci0tLSAvZGV2L251bGwKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfZHJhbS5jCkBA
IC0wLDAgKzEsNDg3IEBACisvLyBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogTUlUCisvKgorICog
Q29weXJpZ2h0IMKpIDIwMjAgSW50ZWwgQ29ycG9yYXRpb24KKyAqLworCisjaW5jbHVkZSAiaTkx
NV9kcnYuaCIKKyNpbmNsdWRlICJpbnRlbF9kcmFtLmgiCisKKyNkZWZpbmUgRFJBTV9UWVBFX1NU
Uih0eXBlKSBbSU5URUxfRFJBTV8gIyMgdHlwZV0gPSAjdHlwZQorCitzdGF0aWMgY29uc3QgY2hh
ciAqaW50ZWxfZHJhbV90eXBlX3N0cihlbnVtIGludGVsX2RyYW1fdHlwZSB0eXBlKQoreworCXN0
YXRpYyBjb25zdCBjaGFyICogY29uc3Qgc3RyW10gPSB7CisJCURSQU1fVFlQRV9TVFIoVU5LTk9X
TiksCisJCURSQU1fVFlQRV9TVFIoRERSMyksCisJCURSQU1fVFlQRV9TVFIoRERSNCksCisJCURS
QU1fVFlQRV9TVFIoTFBERFIzKSwKKwkJRFJBTV9UWVBFX1NUUihMUEREUjQpLAorCX07CisKKwlp
ZiAodHlwZSA+PSBBUlJBWV9TSVpFKHN0cikpCisJCXR5cGUgPSBJTlRFTF9EUkFNX1VOS05PV047
CisKKwlyZXR1cm4gc3RyW3R5cGVdOworfQorCisjdW5kZWYgRFJBTV9UWVBFX1NUUgorCitzdGF0
aWMgaW50IGludGVsX2RpbW1fbnVtX2RldmljZXMoY29uc3Qgc3RydWN0IGRyYW1fZGltbV9pbmZv
ICpkaW1tKQoreworCXJldHVybiBkaW1tLT5yYW5rcyAqIDY0IC8gKGRpbW0tPndpZHRoID86IDEp
OworfQorCisvKiBSZXR1cm5zIHRvdGFsIEdCIGZvciB0aGUgd2hvbGUgRElNTSAqLworc3RhdGlj
IGludCBza2xfZ2V0X2RpbW1fc2l6ZSh1MTYgdmFsKQoreworCXJldHVybiB2YWwgJiBTS0xfRFJB
TV9TSVpFX01BU0s7Cit9CisKK3N0YXRpYyBpbnQgc2tsX2dldF9kaW1tX3dpZHRoKHUxNiB2YWwp
Cit7CisJaWYgKHNrbF9nZXRfZGltbV9zaXplKHZhbCkgPT0gMCkKKwkJcmV0dXJuIDA7CisKKwlz
d2l0Y2ggKHZhbCAmIFNLTF9EUkFNX1dJRFRIX01BU0spIHsKKwljYXNlIFNLTF9EUkFNX1dJRFRI
X1g4OgorCWNhc2UgU0tMX0RSQU1fV0lEVEhfWDE2OgorCWNhc2UgU0tMX0RSQU1fV0lEVEhfWDMy
OgorCQl2YWwgPSAodmFsICYgU0tMX0RSQU1fV0lEVEhfTUFTSykgPj4gU0tMX0RSQU1fV0lEVEhf
U0hJRlQ7CisJCXJldHVybiA4IDw8IHZhbDsKKwlkZWZhdWx0OgorCQlNSVNTSU5HX0NBU0UodmFs
KTsKKwkJcmV0dXJuIDA7CisJfQorfQorCitzdGF0aWMgaW50IHNrbF9nZXRfZGltbV9yYW5rcyh1
MTYgdmFsKQoreworCWlmIChza2xfZ2V0X2RpbW1fc2l6ZSh2YWwpID09IDApCisJCXJldHVybiAw
OworCisJdmFsID0gKHZhbCAmIFNLTF9EUkFNX1JBTktfTUFTSykgPj4gU0tMX0RSQU1fUkFOS19T
SElGVDsKKworCXJldHVybiB2YWwgKyAxOworfQorCisvKiBSZXR1cm5zIHRvdGFsIEdCIGZvciB0
aGUgd2hvbGUgRElNTSAqLworc3RhdGljIGludCBjbmxfZ2V0X2RpbW1fc2l6ZSh1MTYgdmFsKQor
eworCXJldHVybiAodmFsICYgQ05MX0RSQU1fU0laRV9NQVNLKSAvIDI7Cit9CisKK3N0YXRpYyBp
bnQgY25sX2dldF9kaW1tX3dpZHRoKHUxNiB2YWwpCit7CisJaWYgKGNubF9nZXRfZGltbV9zaXpl
KHZhbCkgPT0gMCkKKwkJcmV0dXJuIDA7CisKKwlzd2l0Y2ggKHZhbCAmIENOTF9EUkFNX1dJRFRI
X01BU0spIHsKKwljYXNlIENOTF9EUkFNX1dJRFRIX1g4OgorCWNhc2UgQ05MX0RSQU1fV0lEVEhf
WDE2OgorCWNhc2UgQ05MX0RSQU1fV0lEVEhfWDMyOgorCQl2YWwgPSAodmFsICYgQ05MX0RSQU1f
V0lEVEhfTUFTSykgPj4gQ05MX0RSQU1fV0lEVEhfU0hJRlQ7CisJCXJldHVybiA4IDw8IHZhbDsK
KwlkZWZhdWx0OgorCQlNSVNTSU5HX0NBU0UodmFsKTsKKwkJcmV0dXJuIDA7CisJfQorfQorCitz
dGF0aWMgaW50IGNubF9nZXRfZGltbV9yYW5rcyh1MTYgdmFsKQoreworCWlmIChjbmxfZ2V0X2Rp
bW1fc2l6ZSh2YWwpID09IDApCisJCXJldHVybiAwOworCisJdmFsID0gKHZhbCAmIENOTF9EUkFN
X1JBTktfTUFTSykgPj4gQ05MX0RSQU1fUkFOS19TSElGVDsKKworCXJldHVybiB2YWwgKyAxOwor
fQorCitzdGF0aWMgYm9vbAorc2tsX2lzXzE2Z2JfZGltbShjb25zdCBzdHJ1Y3QgZHJhbV9kaW1t
X2luZm8gKmRpbW0pCit7CisJLyogQ29udmVydCB0b3RhbCBHQiB0byBHYiBwZXIgRFJBTSBkZXZp
Y2UgKi8KKwlyZXR1cm4gOCAqIGRpbW0tPnNpemUgLyAoaW50ZWxfZGltbV9udW1fZGV2aWNlcyhk
aW1tKSA/OiAxKSA9PSAxNjsKK30KKworc3RhdGljIHZvaWQKK3NrbF9kcmFtX2dldF9kaW1tX2lu
Zm8oc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUsCisJCSAgICAgICBzdHJ1Y3QgZHJhbV9k
aW1tX2luZm8gKmRpbW0sCisJCSAgICAgICBpbnQgY2hhbm5lbCwgY2hhciBkaW1tX25hbWUsIHUx
NiB2YWwpCit7CisJaWYgKElOVEVMX0dFTihpOTE1KSA+PSAxMCkgeworCQlkaW1tLT5zaXplID0g
Y25sX2dldF9kaW1tX3NpemUodmFsKTsKKwkJZGltbS0+d2lkdGggPSBjbmxfZ2V0X2RpbW1fd2lk
dGgodmFsKTsKKwkJZGltbS0+cmFua3MgPSBjbmxfZ2V0X2RpbW1fcmFua3ModmFsKTsKKwl9IGVs
c2UgeworCQlkaW1tLT5zaXplID0gc2tsX2dldF9kaW1tX3NpemUodmFsKTsKKwkJZGltbS0+d2lk
dGggPSBza2xfZ2V0X2RpbW1fd2lkdGgodmFsKTsKKwkJZGltbS0+cmFua3MgPSBza2xfZ2V0X2Rp
bW1fcmFua3ModmFsKTsKKwl9CisKKwlkcm1fZGJnX2ttcygmaTkxNS0+ZHJtLAorCQkgICAgIkNI
JXUgRElNTSAlYyBzaXplOiAldSBHQiwgd2lkdGg6IFgldSwgcmFua3M6ICV1LCAxNkdiIERJTU1z
OiAlc1xuIiwKKwkJICAgIGNoYW5uZWwsIGRpbW1fbmFtZSwgZGltbS0+c2l6ZSwgZGltbS0+d2lk
dGgsIGRpbW0tPnJhbmtzLAorCQkgICAgeWVzbm8oc2tsX2lzXzE2Z2JfZGltbShkaW1tKSkpOwor
fQorCitzdGF0aWMgaW50Citza2xfZHJhbV9nZXRfY2hhbm5lbF9pbmZvKHN0cnVjdCBkcm1faTkx
NV9wcml2YXRlICppOTE1LAorCQkJICBzdHJ1Y3QgZHJhbV9jaGFubmVsX2luZm8gKmNoLAorCQkJ
ICBpbnQgY2hhbm5lbCwgdTMyIHZhbCkKK3sKKwlza2xfZHJhbV9nZXRfZGltbV9pbmZvKGk5MTUs
ICZjaC0+ZGltbV9sLAorCQkJICAgICAgIGNoYW5uZWwsICdMJywgdmFsICYgMHhmZmZmKTsKKwlz
a2xfZHJhbV9nZXRfZGltbV9pbmZvKGk5MTUsICZjaC0+ZGltbV9zLAorCQkJICAgICAgIGNoYW5u
ZWwsICdTJywgdmFsID4+IDE2KTsKKworCWlmIChjaC0+ZGltbV9sLnNpemUgPT0gMCAmJiBjaC0+
ZGltbV9zLnNpemUgPT0gMCkgeworCQlkcm1fZGJnX2ttcygmaTkxNS0+ZHJtLCAiQ0gldSBub3Qg
cG9wdWxhdGVkXG4iLCBjaGFubmVsKTsKKwkJcmV0dXJuIC1FSU5WQUw7CisJfQorCisJaWYgKGNo
LT5kaW1tX2wucmFua3MgPT0gMiB8fCBjaC0+ZGltbV9zLnJhbmtzID09IDIpCisJCWNoLT5yYW5r
cyA9IDI7CisJZWxzZSBpZiAoY2gtPmRpbW1fbC5yYW5rcyA9PSAxICYmIGNoLT5kaW1tX3MucmFu
a3MgPT0gMSkKKwkJY2gtPnJhbmtzID0gMjsKKwllbHNlCisJCWNoLT5yYW5rcyA9IDE7CisKKwlj
aC0+aXNfMTZnYl9kaW1tID0gc2tsX2lzXzE2Z2JfZGltbSgmY2gtPmRpbW1fbCkgfHwKKwkJc2ts
X2lzXzE2Z2JfZGltbSgmY2gtPmRpbW1fcyk7CisKKwlkcm1fZGJnX2ttcygmaTkxNS0+ZHJtLCAi
Q0gldSByYW5rczogJXUsIDE2R2IgRElNTXM6ICVzXG4iLAorCQkgICAgY2hhbm5lbCwgY2gtPnJh
bmtzLCB5ZXNubyhjaC0+aXNfMTZnYl9kaW1tKSk7CisKKwlyZXR1cm4gMDsKK30KKworc3RhdGlj
IGJvb2wKK2ludGVsX2lzX2RyYW1fc3ltbWV0cmljKGNvbnN0IHN0cnVjdCBkcmFtX2NoYW5uZWxf
aW5mbyAqY2gwLAorCQkJY29uc3Qgc3RydWN0IGRyYW1fY2hhbm5lbF9pbmZvICpjaDEpCit7CisJ
cmV0dXJuICFtZW1jbXAoY2gwLCBjaDEsIHNpemVvZigqY2gwKSkgJiYKKwkJKGNoMC0+ZGltbV9z
LnNpemUgPT0gMCB8fAorCQkgIW1lbWNtcCgmY2gwLT5kaW1tX2wsICZjaDAtPmRpbW1fcywgc2l6
ZW9mKGNoMC0+ZGltbV9sKSkpOworfQorCitzdGF0aWMgaW50Citza2xfZHJhbV9nZXRfY2hhbm5l
bHNfaW5mbyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYpCit7CisJc3RydWN0IGRy
YW1faW5mbyAqZHJhbV9pbmZvID0gJmRldl9wcml2LT5kcmFtX2luZm87CisJc3RydWN0IGRyYW1f
Y2hhbm5lbF9pbmZvIGNoMCA9IHt9LCBjaDEgPSB7fTsKKwl1MzIgdmFsOworCWludCByZXQ7CisK
Kwl2YWwgPSBJOTE1X1JFQUQoU0tMX01BRF9ESU1NX0NIMF8wXzBfMF9NQ0hCQVJfTUNNQUlOKTsK
KwlyZXQgPSBza2xfZHJhbV9nZXRfY2hhbm5lbF9pbmZvKGRldl9wcml2LCAmY2gwLCAwLCB2YWwp
OworCWlmIChyZXQgPT0gMCkKKwkJZHJhbV9pbmZvLT5udW1fY2hhbm5lbHMrKzsKKworCXZhbCA9
IEk5MTVfUkVBRChTS0xfTUFEX0RJTU1fQ0gxXzBfMF8wX01DSEJBUl9NQ01BSU4pOworCXJldCA9
IHNrbF9kcmFtX2dldF9jaGFubmVsX2luZm8oZGV2X3ByaXYsICZjaDEsIDEsIHZhbCk7CisJaWYg
KHJldCA9PSAwKQorCQlkcmFtX2luZm8tPm51bV9jaGFubmVscysrOworCisJaWYgKGRyYW1faW5m
by0+bnVtX2NoYW5uZWxzID09IDApIHsKKwkJZHJtX2luZm8oJmRldl9wcml2LT5kcm0sICJOdW1i
ZXIgb2YgbWVtb3J5IGNoYW5uZWxzIGlzIHplcm9cbiIpOworCQlyZXR1cm4gLUVJTlZBTDsKKwl9
CisKKwkvKgorCSAqIElmIGFueSBvZiB0aGUgY2hhbm5lbCBpcyBzaW5nbGUgcmFuayBjaGFubmVs
LCB3b3JzdCBjYXNlIG91dHB1dAorCSAqIHdpbGwgYmUgc2FtZSBhcyBpZiBzaW5nbGUgcmFuayBt
ZW1vcnksIHNvIGNvbnNpZGVyIHNpbmdsZSByYW5rCisJICogbWVtb3J5LgorCSAqLworCWlmIChj
aDAucmFua3MgPT0gMSB8fCBjaDEucmFua3MgPT0gMSkKKwkJZHJhbV9pbmZvLT5yYW5rcyA9IDE7
CisJZWxzZQorCQlkcmFtX2luZm8tPnJhbmtzID0gbWF4KGNoMC5yYW5rcywgY2gxLnJhbmtzKTsK
KworCWlmIChkcmFtX2luZm8tPnJhbmtzID09IDApIHsKKwkJZHJtX2luZm8oJmRldl9wcml2LT5k
cm0sCisJCQkgImNvdWxkbid0IGdldCBtZW1vcnkgcmFuayBpbmZvcm1hdGlvblxuIik7CisJCXJl
dHVybiAtRUlOVkFMOworCX0KKworCWRyYW1faW5mby0+aXNfMTZnYl9kaW1tID0gY2gwLmlzXzE2
Z2JfZGltbSB8fCBjaDEuaXNfMTZnYl9kaW1tOworCisJZHJhbV9pbmZvLT5zeW1tZXRyaWNfbWVt
b3J5ID0gaW50ZWxfaXNfZHJhbV9zeW1tZXRyaWMoJmNoMCwgJmNoMSk7CisKKwlkcm1fZGJnX2tt
cygmZGV2X3ByaXYtPmRybSwgIk1lbW9yeSBjb25maWd1cmF0aW9uIGlzIHN5bW1ldHJpYz8gJXNc
biIsCisJCSAgICB5ZXNubyhkcmFtX2luZm8tPnN5bW1ldHJpY19tZW1vcnkpKTsKKworCXJldHVy
biAwOworfQorCitzdGF0aWMgZW51bSBpbnRlbF9kcmFtX3R5cGUKK3NrbF9nZXRfZHJhbV90eXBl
KHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdikKK3sKKwl1MzIgdmFsOworCisJdmFs
ID0gSTkxNV9SRUFEKFNLTF9NQURfSU5URVJfQ0hBTk5FTF8wXzBfMF9NQ0hCQVJfTUNNQUlOKTsK
KworCXN3aXRjaCAodmFsICYgU0tMX0RSQU1fRERSX1RZUEVfTUFTSykgeworCWNhc2UgU0tMX0RS
QU1fRERSX1RZUEVfRERSMzoKKwkJcmV0dXJuIElOVEVMX0RSQU1fRERSMzsKKwljYXNlIFNLTF9E
UkFNX0REUl9UWVBFX0REUjQ6CisJCXJldHVybiBJTlRFTF9EUkFNX0REUjQ7CisJY2FzZSBTS0xf
RFJBTV9ERFJfVFlQRV9MUEREUjM6CisJCXJldHVybiBJTlRFTF9EUkFNX0xQRERSMzsKKwljYXNl
IFNLTF9EUkFNX0REUl9UWVBFX0xQRERSNDoKKwkJcmV0dXJuIElOVEVMX0RSQU1fTFBERFI0Owor
CWRlZmF1bHQ6CisJCU1JU1NJTkdfQ0FTRSh2YWwpOworCQlyZXR1cm4gSU5URUxfRFJBTV9VTktO
T1dOOworCX0KK30KKworc3RhdGljIGludAorc2tsX2dldF9kcmFtX2luZm8oc3RydWN0IGRybV9p
OTE1X3ByaXZhdGUgKmRldl9wcml2KQoreworCXN0cnVjdCBkcmFtX2luZm8gKmRyYW1faW5mbyA9
ICZkZXZfcHJpdi0+ZHJhbV9pbmZvOworCXUzMiBtZW1fZnJlcV9raHosIHZhbDsKKwlpbnQgcmV0
OworCisJZHJhbV9pbmZvLT50eXBlID0gc2tsX2dldF9kcmFtX3R5cGUoZGV2X3ByaXYpOworCWRy
bV9kYmdfa21zKCZkZXZfcHJpdi0+ZHJtLCAiRFJBTSB0eXBlOiAlc1xuIiwKKwkJICAgIGludGVs
X2RyYW1fdHlwZV9zdHIoZHJhbV9pbmZvLT50eXBlKSk7CisKKwlyZXQgPSBza2xfZHJhbV9nZXRf
Y2hhbm5lbHNfaW5mbyhkZXZfcHJpdik7CisJaWYgKHJldCkKKwkJcmV0dXJuIHJldDsKKworCXZh
bCA9IEk5MTVfUkVBRChTS0xfTUNfQklPU19EQVRBXzBfMF8wX01DSEJBUl9QQ1UpOworCW1lbV9m
cmVxX2toeiA9IERJVl9ST1VORF9VUCgodmFsICYgU0tMX1JFUV9EQVRBX01BU0spICoKKwkJCQkg
ICAgU0tMX01FTU9SWV9GUkVRX01VTFRJUExJRVJfSFosIDEwMDApOworCisJZHJhbV9pbmZvLT5i
YW5kd2lkdGhfa2JwcyA9IGRyYW1faW5mby0+bnVtX2NoYW5uZWxzICoKKwkJbWVtX2ZyZXFfa2h6
ICogODsKKworCWlmIChkcmFtX2luZm8tPmJhbmR3aWR0aF9rYnBzID09IDApIHsKKwkJZHJtX2lu
Zm8oJmRldl9wcml2LT5kcm0sCisJCQkgIkNvdWxkbid0IGdldCBzeXN0ZW0gbWVtb3J5IGJhbmR3
aWR0aFxuIik7CisJCXJldHVybiAtRUlOVkFMOworCX0KKworCWRyYW1faW5mby0+dmFsaWQgPSB0
cnVlOworCXJldHVybiAwOworfQorCisvKiBSZXR1cm5zIEdiIHBlciBEUkFNIGRldmljZSAqLwor
c3RhdGljIGludCBieHRfZ2V0X2RpbW1fc2l6ZSh1MzIgdmFsKQoreworCXN3aXRjaCAodmFsICYg
QlhUX0RSQU1fU0laRV9NQVNLKSB7CisJY2FzZSBCWFRfRFJBTV9TSVpFXzRHQklUOgorCQlyZXR1
cm4gNDsKKwljYXNlIEJYVF9EUkFNX1NJWkVfNkdCSVQ6CisJCXJldHVybiA2OworCWNhc2UgQlhU
X0RSQU1fU0laRV84R0JJVDoKKwkJcmV0dXJuIDg7CisJY2FzZSBCWFRfRFJBTV9TSVpFXzEyR0JJ
VDoKKwkJcmV0dXJuIDEyOworCWNhc2UgQlhUX0RSQU1fU0laRV8xNkdCSVQ6CisJCXJldHVybiAx
NjsKKwlkZWZhdWx0OgorCQlNSVNTSU5HX0NBU0UodmFsKTsKKwkJcmV0dXJuIDA7CisJfQorfQor
CitzdGF0aWMgaW50IGJ4dF9nZXRfZGltbV93aWR0aCh1MzIgdmFsKQoreworCWlmICghYnh0X2dl
dF9kaW1tX3NpemUodmFsKSkKKwkJcmV0dXJuIDA7CisKKwl2YWwgPSAodmFsICYgQlhUX0RSQU1f
V0lEVEhfTUFTSykgPj4gQlhUX0RSQU1fV0lEVEhfU0hJRlQ7CisKKwlyZXR1cm4gOCA8PCB2YWw7
Cit9CisKK3N0YXRpYyBpbnQgYnh0X2dldF9kaW1tX3JhbmtzKHUzMiB2YWwpCit7CisJaWYgKCFi
eHRfZ2V0X2RpbW1fc2l6ZSh2YWwpKQorCQlyZXR1cm4gMDsKKworCXN3aXRjaCAodmFsICYgQlhU
X0RSQU1fUkFOS19NQVNLKSB7CisJY2FzZSBCWFRfRFJBTV9SQU5LX1NJTkdMRToKKwkJcmV0dXJu
IDE7CisJY2FzZSBCWFRfRFJBTV9SQU5LX0RVQUw6CisJCXJldHVybiAyOworCWRlZmF1bHQ6CisJ
CU1JU1NJTkdfQ0FTRSh2YWwpOworCQlyZXR1cm4gMDsKKwl9Cit9CisKK3N0YXRpYyBlbnVtIGlu
dGVsX2RyYW1fdHlwZSBieHRfZ2V0X2RpbW1fdHlwZSh1MzIgdmFsKQoreworCWlmICghYnh0X2dl
dF9kaW1tX3NpemUodmFsKSkKKwkJcmV0dXJuIElOVEVMX0RSQU1fVU5LTk9XTjsKKworCXN3aXRj
aCAodmFsICYgQlhUX0RSQU1fVFlQRV9NQVNLKSB7CisJY2FzZSBCWFRfRFJBTV9UWVBFX0REUjM6
CisJCXJldHVybiBJTlRFTF9EUkFNX0REUjM7CisJY2FzZSBCWFRfRFJBTV9UWVBFX0xQRERSMzoK
KwkJcmV0dXJuIElOVEVMX0RSQU1fTFBERFIzOworCWNhc2UgQlhUX0RSQU1fVFlQRV9ERFI0Ogor
CQlyZXR1cm4gSU5URUxfRFJBTV9ERFI0OworCWNhc2UgQlhUX0RSQU1fVFlQRV9MUEREUjQ6CisJ
CXJldHVybiBJTlRFTF9EUkFNX0xQRERSNDsKKwlkZWZhdWx0OgorCQlNSVNTSU5HX0NBU0UodmFs
KTsKKwkJcmV0dXJuIElOVEVMX0RSQU1fVU5LTk9XTjsKKwl9Cit9CisKK3N0YXRpYyB2b2lkIGJ4
dF9nZXRfZGltbV9pbmZvKHN0cnVjdCBkcmFtX2RpbW1faW5mbyAqZGltbSwgdTMyIHZhbCkKK3sK
KwlkaW1tLT53aWR0aCA9IGJ4dF9nZXRfZGltbV93aWR0aCh2YWwpOworCWRpbW0tPnJhbmtzID0g
Ynh0X2dldF9kaW1tX3JhbmtzKHZhbCk7CisKKwkvKgorCSAqIFNpemUgaW4gcmVnaXN0ZXIgaXMg
R2IgcGVyIERSQU0gZGV2aWNlLiBDb252ZXJ0IHRvIHRvdGFsCisJICogR0IgdG8gbWF0Y2ggdGhl
IHdheSB3ZSByZXBvcnQgdGhpcyBmb3Igbm9uLUxQIHBsYXRmb3Jtcy4KKwkgKi8KKwlkaW1tLT5z
aXplID0gYnh0X2dldF9kaW1tX3NpemUodmFsKSAqIGludGVsX2RpbW1fbnVtX2RldmljZXMoZGlt
bSkgLyA4OworfQorCitzdGF0aWMgaW50IGJ4dF9nZXRfZHJhbV9pbmZvKHN0cnVjdCBkcm1faTkx
NV9wcml2YXRlICpkZXZfcHJpdikKK3sKKwlzdHJ1Y3QgZHJhbV9pbmZvICpkcmFtX2luZm8gPSAm
ZGV2X3ByaXYtPmRyYW1faW5mbzsKKwl1MzIgZHJhbV9jaGFubmVsczsKKwl1MzIgbWVtX2ZyZXFf
a2h6LCB2YWw7CisJdTggbnVtX2FjdGl2ZV9jaGFubmVsczsKKwlpbnQgaTsKKworCXZhbCA9IEk5
MTVfUkVBRChCWFRfUF9DUl9NQ19CSU9TX1JFUV8wXzBfMCk7CisJbWVtX2ZyZXFfa2h6ID0gRElW
X1JPVU5EX1VQKCh2YWwgJiBCWFRfUkVRX0RBVEFfTUFTSykgKgorCQkJCSAgICBCWFRfTUVNT1JZ
X0ZSRVFfTVVMVElQTElFUl9IWiwgMTAwMCk7CisKKwlkcmFtX2NoYW5uZWxzID0gdmFsICYgQlhU
X0RSQU1fQ0hBTk5FTF9BQ1RJVkVfTUFTSzsKKwludW1fYWN0aXZlX2NoYW5uZWxzID0gaHdlaWdo
dDMyKGRyYW1fY2hhbm5lbHMpOworCisJLyogRWFjaCBhY3RpdmUgYml0IHJlcHJlc2VudHMgNC1i
eXRlIGNoYW5uZWwgKi8KKwlkcmFtX2luZm8tPmJhbmR3aWR0aF9rYnBzID0gKG1lbV9mcmVxX2to
eiAqIG51bV9hY3RpdmVfY2hhbm5lbHMgKiA0KTsKKworCWlmIChkcmFtX2luZm8tPmJhbmR3aWR0
aF9rYnBzID09IDApIHsKKwkJZHJtX2luZm8oJmRldl9wcml2LT5kcm0sCisJCQkgIkNvdWxkbid0
IGdldCBzeXN0ZW0gbWVtb3J5IGJhbmR3aWR0aFxuIik7CisJCXJldHVybiAtRUlOVkFMOworCX0K
KworCS8qCisJICogTm93IHJlYWQgZWFjaCBEVU5JVDgvOS8xMC8xMSB0byBjaGVjayB0aGUgcmFu
ayBvZiBlYWNoIGRpbW1zLgorCSAqLworCWZvciAoaSA9IEJYVF9EX0NSX0RSUDBfRFVOSVRfU1RB
UlQ7IGkgPD0gQlhUX0RfQ1JfRFJQMF9EVU5JVF9FTkQ7IGkrKykgeworCQlzdHJ1Y3QgZHJhbV9k
aW1tX2luZm8gZGltbTsKKwkJZW51bSBpbnRlbF9kcmFtX3R5cGUgdHlwZTsKKworCQl2YWwgPSBJ
OTE1X1JFQUQoQlhUX0RfQ1JfRFJQMF9EVU5JVChpKSk7CisJCWlmICh2YWwgPT0gMHhGRkZGRkZG
RikKKwkJCWNvbnRpbnVlOworCisJCWRyYW1faW5mby0+bnVtX2NoYW5uZWxzKys7CisKKwkJYnh0
X2dldF9kaW1tX2luZm8oJmRpbW0sIHZhbCk7CisJCXR5cGUgPSBieHRfZ2V0X2RpbW1fdHlwZSh2
YWwpOworCisJCWRybV9XQVJOX09OKCZkZXZfcHJpdi0+ZHJtLCB0eXBlICE9IElOVEVMX0RSQU1f
VU5LTk9XTiAmJgorCQkJICAgIGRyYW1faW5mby0+dHlwZSAhPSBJTlRFTF9EUkFNX1VOS05PV04g
JiYKKwkJCSAgICBkcmFtX2luZm8tPnR5cGUgIT0gdHlwZSk7CisKKwkJZHJtX2RiZ19rbXMoJmRl
dl9wcml2LT5kcm0sCisJCQkgICAgIkNIJXUgRElNTSBzaXplOiAldSBHQiwgd2lkdGg6IFgldSwg
cmFua3M6ICV1LCB0eXBlOiAlc1xuIiwKKwkJCSAgICBpIC0gQlhUX0RfQ1JfRFJQMF9EVU5JVF9T
VEFSVCwKKwkJCSAgICBkaW1tLnNpemUsIGRpbW0ud2lkdGgsIGRpbW0ucmFua3MsCisJCQkgICAg
aW50ZWxfZHJhbV90eXBlX3N0cih0eXBlKSk7CisKKwkJLyoKKwkJICogSWYgYW55IG9mIHRoZSBj
aGFubmVsIGlzIHNpbmdsZSByYW5rIGNoYW5uZWwsCisJCSAqIHdvcnN0IGNhc2Ugb3V0cHV0IHdp
bGwgYmUgc2FtZSBhcyBpZiBzaW5nbGUgcmFuaworCQkgKiBtZW1vcnksIHNvIGNvbnNpZGVyIHNp
bmdsZSByYW5rIG1lbW9yeS4KKwkJICovCisJCWlmIChkcmFtX2luZm8tPnJhbmtzID09IDApCisJ
CQlkcmFtX2luZm8tPnJhbmtzID0gZGltbS5yYW5rczsKKwkJZWxzZSBpZiAoZGltbS5yYW5rcyA9
PSAxKQorCQkJZHJhbV9pbmZvLT5yYW5rcyA9IDE7CisKKwkJaWYgKHR5cGUgIT0gSU5URUxfRFJB
TV9VTktOT1dOKQorCQkJZHJhbV9pbmZvLT50eXBlID0gdHlwZTsKKwl9CisKKwlpZiAoZHJhbV9p
bmZvLT50eXBlID09IElOVEVMX0RSQU1fVU5LTk9XTiB8fCBkcmFtX2luZm8tPnJhbmtzID09IDAp
IHsKKwkJZHJtX2luZm8oJmRldl9wcml2LT5kcm0sICJjb3VsZG4ndCBnZXQgbWVtb3J5IGluZm9y
bWF0aW9uXG4iKTsKKwkJcmV0dXJuIC1FSU5WQUw7CisJfQorCisJZHJhbV9pbmZvLT52YWxpZCA9
IHRydWU7CisKKwlyZXR1cm4gMDsKK30KKwordm9pZCBpbnRlbF9kcmFtX2RldGVjdChzdHJ1Y3Qg
ZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKK3sKKwlzdHJ1Y3QgZHJhbV9pbmZvICpkcmFtX2luZm8g
PSAmaTkxNS0+ZHJhbV9pbmZvOworCWludCByZXQ7CisKKwkvKgorCSAqIEFzc3VtZSAxNkdiIERJ
TU1zIGFyZSBwcmVzZW50IHVudGlsIHByb3ZlbiBvdGhlcndpc2UuCisJICogVGhpcyBpcyBvbmx5
IHVzZWQgZm9yIHRoZSBsZXZlbCAwIHdhdGVybWFyayBsYXRlbmN5CisJICogdy9hIHdoaWNoIGRv
ZXMgbm90IGFwcGx5IHRvIGJ4dC9nbGsuCisJICovCisJZHJhbV9pbmZvLT5pc18xNmdiX2RpbW0g
PSAhSVNfR0VOOV9MUChpOTE1KTsKKworCWlmIChJTlRFTF9HRU4oaTkxNSkgPCA5IHx8ICFIQVNf
RElTUExBWShpOTE1KSkKKwkJcmV0dXJuOworCisJaWYgKElTX0dFTjlfTFAoaTkxNSkpCisJCXJl
dCA9IGJ4dF9nZXRfZHJhbV9pbmZvKGk5MTUpOworCWVsc2UKKwkJcmV0ID0gc2tsX2dldF9kcmFt
X2luZm8oaTkxNSk7CisJaWYgKHJldCkKKwkJcmV0dXJuOworCisJZHJtX2RiZ19rbXMoJmk5MTUt
PmRybSwgIkRSQU0gYmFuZHdpZHRoOiAldSBrQnBzLCBjaGFubmVsczogJXVcbiIsCisJCSAgICBk
cmFtX2luZm8tPmJhbmR3aWR0aF9rYnBzLCBkcmFtX2luZm8tPm51bV9jaGFubmVscyk7CisKKwlk
cm1fZGJnX2ttcygmaTkxNS0+ZHJtLCAiRFJBTSByYW5rczogJXUsIDE2R2IgRElNTXM6ICVzXG4i
LAorCQkgICAgZHJhbV9pbmZvLT5yYW5rcywgeWVzbm8oZHJhbV9pbmZvLT5pc18xNmdiX2RpbW0p
KTsKK30KKworc3RhdGljIHUzMiBnZW45X2VkcmFtX3NpemVfbWIoc3RydWN0IGRybV9pOTE1X3By
aXZhdGUgKmk5MTUsIHUzMiBjYXApCit7CisJc3RhdGljIGNvbnN0IHU4IHdheXNbOF0gPSB7IDQs
IDgsIDEyLCAxNiwgMTYsIDE2LCAxNiwgMTYgfTsKKwlzdGF0aWMgY29uc3QgdTggc2V0c1s0XSA9
IHsgMSwgMSwgMiwgMiB9OworCisJcmV0dXJuIEVEUkFNX05VTV9CQU5LUyhjYXApICoKKwkJd2F5
c1tFRFJBTV9XQVlTX0lEWChjYXApXSAqCisJCXNldHNbRURSQU1fU0VUU19JRFgoY2FwKV07Cit9
CisKK3ZvaWQgaW50ZWxfZHJhbV9lZHJhbV9kZXRlY3Qoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUg
Kmk5MTUpCit7CisJdTMyIGVkcmFtX2NhcCA9IDA7CisKKwlpZiAoIShJU19IQVNXRUxMKGk5MTUp
IHx8IElTX0JST0FEV0VMTChpOTE1KSB8fCBJTlRFTF9HRU4oaTkxNSkgPj0gOSkpCisJCXJldHVy
bjsKKworCWVkcmFtX2NhcCA9IF9fcmF3X3VuY29yZV9yZWFkMzIoJmk5MTUtPnVuY29yZSwgSFNX
X0VEUkFNX0NBUCk7CisKKwkvKiBOQjogV2UgY2FuJ3Qgd3JpdGUgSURJQ1IgeWV0IGJlY2F1c2Ug
d2UgZG9uJ3QgaGF2ZSBndCBmdW5jcyBzZXQgdXAgKi8KKworCWlmICghKGVkcmFtX2NhcCAmIEVE
UkFNX0VOQUJMRUQpKQorCQlyZXR1cm47CisKKwkvKgorCSAqIFRoZSBuZWVkZWQgY2FwYWJpbGl0
eSBiaXRzIGZvciBzaXplIGNhbGN1bGF0aW9uIGFyZSBub3QgdGhlcmUgd2l0aAorCSAqIHByZSBn
ZW45IHNvIHJldHVybiAxMjhNQiBhbHdheXMuCisJICovCisJaWYgKElOVEVMX0dFTihpOTE1KSA8
IDkpCisJCWk5MTUtPmVkcmFtX3NpemVfbWIgPSAxMjg7CisJZWxzZQorCQlpOTE1LT5lZHJhbV9z
aXplX21iID0gZ2VuOV9lZHJhbV9zaXplX21iKGk5MTUsIGVkcmFtX2NhcCk7CisKKwlkZXZfaW5m
byhpOTE1LT5kcm0uZGV2LAorCQkgIkZvdW5kICV1TUIgb2YgZURSQU1cbiIsIGk5MTUtPmVkcmFt
X3NpemVfbWIpOworfQpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfZHJh
bS5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfZHJhbS5oCm5ldyBmaWxlIG1vZGUgMTAw
NjQ0CmluZGV4IDAwMDAwMDAwMDAwMC4uNGJhMTNjMTMxNjJjCi0tLSAvZGV2L251bGwKKysrIGIv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfZHJhbS5oCkBAIC0wLDAgKzEsMTQgQEAKKy8qIFNQ
RFgtTGljZW5zZS1JZGVudGlmaWVyOiBNSVQgKi8KKy8qCisgKiBDb3B5cmlnaHQgwqkgMjAyMCBJ
bnRlbCBDb3Jwb3JhdGlvbgorICovCisKKyNpZm5kZWYgX19JTlRFTF9EUkFNX0hfXworI2RlZmlu
ZSBfX0lOVEVMX0RSQU1fSF9fCisKK3N0cnVjdCBkcm1faTkxNV9wcml2YXRlOworCit2b2lkIGlu
dGVsX2RyYW1fZWRyYW1fZGV0ZWN0KHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KTsKK3Zv
aWQgaW50ZWxfZHJhbV9kZXRlY3Qoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpOworCisj
ZW5kaWYgLyogX19JTlRFTF9EUkFNX0hfXyAqLwotLSAKMi4yMC4xCgpfX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpJbnRlbC1nZnggbWFpbGluZyBsaXN0Cklu
dGVsLWdmeEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5v
cmcvbWFpbG1hbi9saXN0aW5mby9pbnRlbC1nZngK

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 0B87C9CA09
	for <lists+intel-gfx@lfdr.de>; Mon, 26 Aug 2019 09:22:17 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id EB3F66E1B9;
	Mon, 26 Aug 2019 07:22:14 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 64B866E194
 for <intel-gfx@lists.freedesktop.org>; Mon, 26 Aug 2019 07:22:13 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18262702-1500050 
 for multiple; Mon, 26 Aug 2019 08:21:56 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 26 Aug 2019 08:21:48 +0100
Message-Id: <20190826072149.9447-27-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20190826072149.9447-1-chris@chris-wilson.co.uk>
References: <20190826072149.9447-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 27/28] drm/i915: Cancel non-persistent contexts
 on close
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

Tm9ybWFsbHksIHdlIHJlbHkgb24gb3VyIGhhbmdjaGVjayB0byBwcmV2ZW50IHBlcnNpc3RlbnQg
YmF0Y2hlcyBmcm9tCmhvZ2dpbmcgdGhlIEdQVS4gSG93ZXZlciwgaWYgdGhlIHVzZXIgZGlzYWJs
ZXMgaGFuZ2NoZWNrLCB0aGlzIG1lY2hhbmlzbQpicmVha3MgZG93bi4gRGVzcGl0ZSBvdXIgaW5z
aXN0ZW5jZSB0aGF0IHRoaXMgaXMgdW5zYWZlLCB0aGUgdXNlcnMgYXJlCmVxdWFsbHkgaW5zaXN0
ZW50IHRoYXQgdGhleSB3YW50IHRvIHVzZSBlbmRsZXNzIGJhdGNoZXMgYW5kIHdpbGwgZGlzYWJs
ZQp0aGUgaGFuZ2NoZWNrIG1lY2hhbmlzbS4gV2UgYXJlIGxvb2tpbmcgYXJlIHBlcmhhcHMgcmVw
bGFjaW5nIGhhbmdjaGVjawp3aXRoIGEgc29mdGVyIG1lY2hhbmlzbSwgdGhhdCBzZW5kcyBhIHB1
bHNlIGRvd24gdGhlIGVuZ2luZSB0byBjaGVjayBpZgppdCBpcyB3ZWxsLiBXZSBjYW4gdXNlIHRo
ZSBzYW1lIHByZWVtcHRpdmUgcHVsc2UgdG8gZmx1c2ggYW4gYWN0aXZlCnBlcnNpc3RlbnQgY29u
dGV4dCBvZmYgdGhlIEdQVSB1cG9uIGNvbnRleHQgY2xvc2UsIHByZXZlbnRpbmcgcmVzb3VyY2Vz
CmJlaW5nIGxvc3QgYW5kIHVua2lsbGFibGUgcmVxdWVzdHMgcmVtYWluaW5nIG9uIHRoZSBHUFUg
YWZ0ZXIgcHJvY2Vzcwp0ZXJtaW5hdGlvbi4gVG8gYXZvaWQgY2hhbmdpbmcgdGhlIEFCSSBhbmQg
YWNjaWRlbnRhbGx5IGJyZWFraW5nCmV4aXN0aW5nIHVzZXJzcGFjZSwgd2UgbWFrZSB0aGUgcGVy
c2lzdGVuY2Ugb2YgYSBjb250ZXh0IGV4cGxpY2l0IGFuZAplbmFibGUgaXQgYnkgZGVmYXVsdCAo
bWF0Y2hpbmcgY3VycmVudCBBQkkpLiBVc2Vyc3BhY2UgY2FuIG9wdCBvdXQgb2YKcGVyc2lzdGVu
dCBtb2RlIChmb3JjaW5nIHJlcXVlc3RzIHRvIGJlIGNhbmNlbGxlZCB3aGVuIHRoZSBjb250ZXh0
IGlzCmNsb3NlZCBieSBwcm9jZXNzIHRlcm1pbmF0aW9uIG9yIGV4cGxpY2l0bHkpIGJ5IGEgY29u
dGV4dCBwYXJhbWV0ZXIuIFRvCmZhY2lsaXRhdGUgZXhpc3RpbmcgdXNlLWNhc2VzIG9mIGRpc2Fi
bGluZyBoYW5nY2hlY2ssIGlmIHRoZSBtb2RwYXJhbSBpcwpkaXNhYmxlZCAoaTkxNS5lbmFibGVf
aGFuZ2NoZWNrPTApLCB3ZSBkaXNhYmxlIHBlcmlzdGVuY2UgbW9kZSBieQpkZWZhdWx0LiAgKE5v
dGUsIG9uZSBvZiB0aGUgb3V0Y29tZXMgZm9yIHN1cHBvcnRpbmcgZW5kbGVzcyBtb2RlIHdpbGwg
YmUKdGhlIHJlbW92YWwgb2YgaGFuZ2NoZWNraW5nLCBhdCB3aGljaCBwb2ludCBvcHRpbmcgaW50
byBwZXJzaXN0ZW50IG1vZGUKd2lsbCBiZSBtYW5kYXRvcnksIG9yIG1heWJlIHRoZSBkZWZhdWx0
IHBlcmhhcHMgY29udHJvbGxlZCBieSBjZ3JvdXBzLikKClRlc3RjYXNlOiBpZ3QvZ2VtX2N0eF9w
ZXJzaXN0ZW5jZQpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNocmlzQGNocmlzLXdpbHNv
bi5jby51az4KQ2M6IEpvb25hcyBMYWh0aW5lbiA8am9vbmFzLmxhaHRpbmVuQGxpbnV4LmludGVs
LmNvbT4KQ2M6IE1pY2hhxYIgV2luaWFyc2tpIDxtaWNoYWwud2luaWFyc2tpQGludGVsLmNvbT4K
Q2M6IEpvbiBCbG9vbWZpZWxkIDxqb24uYmxvb21maWVsZEBpbnRlbC5jb20+Ci0tLQogZHJpdmVy
cy9ncHUvZHJtL2k5MTUvTWFrZWZpbGUgICAgICAgICAgICAgICAgIHwgICAzICstCiBkcml2ZXJz
L2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fY29udGV4dC5jICAgfCAxMjIgKysrKysrKysrKysr
KysrKysrCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fY29udGV4dC5oICAgfCAg
MTUgKysrCiAuLi4vZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jb250ZXh0X3R5cGVzLmggfCAg
IDEgKwogLi4uL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfaGVhcnRiZWF0LmMgIHwgIDU0
ICsrKysrKysrCiAuLi4vZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZV9oZWFydGJlYXQuaCAg
fCAgMTQgKysKIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZV9wbS5jICAgICB8
ICAgMiArLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wcmlvbGlzdF90eXBlcy5oICAgIHwg
ICAxICsKIGluY2x1ZGUvdWFwaS9kcm0vaTkxNV9kcm0uaCAgICAgICAgICAgICAgICAgICB8ICAx
NSArKysKIDkgZmlsZXMgY2hhbmdlZCwgMjI1IGluc2VydGlvbnMoKyksIDIgZGVsZXRpb25zKC0p
CiBjcmVhdGUgbW9kZSAxMDA2NDQgZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZW5naW5l
X2hlYXJ0YmVhdC5jCiBjcmVhdGUgbW9kZSAxMDA2NDQgZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Qv
aW50ZWxfZW5naW5lX2hlYXJ0YmVhdC5oCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvTWFrZWZpbGUgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9NYWtlZmlsZQppbmRleCA2NThiOTMw
ZDM0YTguLmVhYTc0ZTAwMDk4NSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvTWFr
ZWZpbGUKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvTWFrZWZpbGUKQEAgLTc2LDggKzc2LDkg
QEAgZ3QteSArPSBcCiAJZ3QvaW50ZWxfYnJlYWRjcnVtYnMubyBcCiAJZ3QvaW50ZWxfY29udGV4
dC5vIFwKIAlndC9pbnRlbF9lbmdpbmVfY3MubyBcCi0JZ3QvaW50ZWxfZW5naW5lX3Bvb2wubyBc
CisJZ3QvaW50ZWxfZW5naW5lX2hlYXJ0YmVhdC5vIFwKIAlndC9pbnRlbF9lbmdpbmVfcG0ubyBc
CisJZ3QvaW50ZWxfZW5naW5lX3Bvb2wubyBcCiAJZ3QvaW50ZWxfZW5naW5lX3VzZXIubyBcCiAJ
Z3QvaW50ZWxfZ3QubyBcCiAJZ3QvaW50ZWxfZ3RfaXJxLm8gXApkaWZmIC0tZ2l0IGEvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRleHQuYyBiL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2dlbS9pOTE1X2dlbV9jb250ZXh0LmMKaW5kZXggYmQ5Mzk3NjY5MzMyLi41NTIwYTg5NmU3
MDEgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jb250ZXh0
LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRleHQuYwpAQCAt
NzAsNiArNzAsNyBAQAogI2luY2x1ZGUgPGRybS9pOTE1X2RybS5oPgogCiAjaW5jbHVkZSAiZ3Qv
aW50ZWxfbHJjX3JlZy5oIgorI2luY2x1ZGUgImd0L2ludGVsX2VuZ2luZV9oZWFydGJlYXQuaCIK
ICNpbmNsdWRlICJndC9pbnRlbF9lbmdpbmVfdXNlci5oIgogCiAjaW5jbHVkZSAiaTkxNV9nZW1f
Y29udGV4dC5oIgpAQCAtMzc1LDYgKzM3Niw3OCBAQCB2b2lkIGk5MTVfZ2VtX2NvbnRleHRfcmVs
ZWFzZShzdHJ1Y3Qga3JlZiAqcmVmKQogCQlxdWV1ZV93b3JrKGk5MTUtPndxLCAmaTkxNS0+Y29u
dGV4dHMuZnJlZV93b3JrKTsKIH0KIAorc3RhdGljIGlubGluZSBzdHJ1Y3QgaTkxNV9nZW1fZW5n
aW5lcyAqCitfX2NvbnRleHRfZW5naW5lc19zdGF0aWMoc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQg
KmN0eCkKK3sKKwlyZXR1cm4gcmN1X2RlcmVmZXJlbmNlX3Byb3RlY3RlZChjdHgtPmVuZ2luZXMs
IHRydWUpOworfQorCitzdGF0aWMgdm9pZCBraWxsX2NvbnRleHQoc3RydWN0IGk5MTVfZ2VtX2Nv
bnRleHQgKmN0eCkKK3sKKwlpbnRlbF9lbmdpbmVfbWFza190IHRtcCwgYWN0aXZlLCByZXNldDsK
KwlzdHJ1Y3QgaW50ZWxfZ3QgKmd0ID0gJmN0eC0+aTkxNS0+Z3Q7CisJc3RydWN0IGk5MTVfZ2Vt
X2VuZ2luZXNfaXRlciBpdDsKKwlzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmU7CisJc3Ry
dWN0IGludGVsX2NvbnRleHQgKmNlOworCisJLyoKKwkgKiBJZiB3ZSBhcmUgYWxyZWFkeSBiYW5u
ZWQsIGl0IHdhcyBkdWUgdG8gYSBndWlsdHkgcmVxdWVzdCBjYXVzaW5nCisJICogYSByZXNldCBh
bmQgdGhlIGVudGlyZSBjb250ZXh0IGJlaW5nIGV2aWN0ZWQgZnJvbSB0aGUgR1BVLgorCSAqLwor
CWlmIChpOTE1X2dlbV9jb250ZXh0X2lzX2Jhbm5lZChjdHgpKQorCQlyZXR1cm47CisKKwlpOTE1
X2dlbV9jb250ZXh0X3NldF9iYW5uZWQoY3R4KTsKKworCS8qCisJICogTWFwIHRoZSB1c2VyJ3Mg
ZW5naW5lIGJhY2sgdG8gdGhlIGFjdHVhbCBlbmdpbmVzOyBvbmUgdmlydHVhbAorCSAqIGVuZ2lu
ZSB3aWxsIGJlIG1hcHBlZCB0byBtdWx0aXBsZSBlbmdpbmVzLCBhbmQgdXNpbmcgY3R4LT5lbmdp
bmVbXQorCSAqIHRoZSBzYW1lIGVuZ2luZSBtYXkgYmUgaGF2ZSBtdWx0aXBsZSBpbnN0YW5jZXMg
aW4gdGhlIHVzZXIncyBtYXAuCisJICogSG93ZXZlciwgd2Ugb25seSBjYXJlIGFib3V0IHBlbmRp
bmcgcmVxdWVzdHMsIHNvIG9ubHkgaW5jbHVkZQorCSAqIGVuZ2luZXMgb24gd2hpY2ggdGhlcmUg
YXJlIGluY29tcGxldGUgcmVxdWVzdHMuCisJICovCisJYWN0aXZlID0gMDsKKwlmb3JfZWFjaF9n
ZW1fZW5naW5lKGNlLCBfX2NvbnRleHRfZW5naW5lc19zdGF0aWMoY3R4KSwgaXQpIHsKKwkJc3Ry
dWN0IGRtYV9mZW5jZSAqZmVuY2U7CisKKwkJaWYgKCFjZS0+dGltZWxpbmUpCisJCQljb250aW51
ZTsKKworCQlmZW5jZSA9IGk5MTVfYWN0aXZlX2ZlbmNlX2dldCgmY2UtPnRpbWVsaW5lLT5sYXN0
X3JlcXVlc3QpOworCQlpZiAoIWZlbmNlKQorCQkJY29udGludWU7CisKKwkJZW5naW5lID0gdG9f
cmVxdWVzdChmZW5jZSktPmVuZ2luZTsKKwkJaWYgKEhBU19FWEVDTElTVFMoZ3QtPmk5MTUpKQor
CQkJZW5naW5lID0gaW50ZWxfY29udGV4dF9pbmZsaWdodChjZSk7CisJCWlmIChlbmdpbmUpCisJ
CQlhY3RpdmUgfD0gZW5naW5lLT5tYXNrOworCisJCWRtYV9mZW5jZV9wdXQoZmVuY2UpOworCX0K
KworCS8qCisJICogU2VuZCBhICJoaWdoIHByaW9yaXR5IHB1bHNlIiBkb3duIHRoZSBlbmdpbmUg
dG8gY2F1c2UgdGhlCisJICogY3VycmVudCByZXF1ZXN0IHRvIGJlIG1vbWVudGFyaWx5IHByZWVt
cHRlZC4gKElmIGl0IGZhaWxzIHRvCisJICogYmUgcHJlZW1wdGVkLCBpdCB3aWxsIGJlIHJlc2V0
KS4gQXMgd2UgaGF2ZSBtYXJrZWQgb3VyIGNvbnRleHQKKwkgKiBhcyBiYW5uZWQsIGFueSBpbmNv
bXBsZXRlIHJlcXVlc3QsIGluY2x1ZGluZyBhbnkgcnVubmluZywgd2lsbAorCSAqIGJlIHNraXBw
ZWQgZm9sbG93aW5nIHRoZSBwcmVlbXB0aW9uLgorCSAqLworCXJlc2V0ID0gMDsKKwlmb3JfZWFj
aF9lbmdpbmVfbWFza2VkKGVuZ2luZSwgZ3QtPmk5MTUsIGFjdGl2ZSwgdG1wKQorCQlpZiAoaW50
ZWxfZW5naW5lX3B1bHNlKGVuZ2luZSkpCisJCQlyZXNldCB8PSBlbmdpbmUtPm1hc2s7CisKKwkv
KgorCSAqIElmIHdlIGFyZSB1bmFibGUgdG8gc2VuZCBhIHByZWVtcHRpdmUgcHVsc2UgdG8gYnVt
cAorCSAqIHRoZSBjb250ZXh0IGZyb20gdGhlIEdQVSwgd2UgaGF2ZSB0byByZXNvcnQgdG8gYSBm
dWxsCisJICogcmVzZXQuIFdlIGhvcGUgdGhlIGNvbGxhdGVyYWwgZGFtYWdlIGlzIHdvcnRoIGl0
LgorCSAqLworCWlmIChyZXNldCkKKwkJaW50ZWxfZ3RfaGFuZGxlX2Vycm9yKGd0LCByZXNldCwg
MCwKKwkJCQkgICAgICAiY29udGV4dCBjbG9zdXJlIGluICVzIiwgY3R4LT5uYW1lKTsKK30KKwog
c3RhdGljIHZvaWQgY29udGV4dF9jbG9zZShzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4KQog
ewogCWk5MTVfZ2VtX2NvbnRleHRfc2V0X2Nsb3NlZChjdHgpOwpAQCAtNDAwLDYgKzQ3MywxMCBA
QCBzdGF0aWMgdm9pZCBjb250ZXh0X2Nsb3NlKHN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICpjdHgp
CiAJbHV0X2Nsb3NlKGN0eCk7CiAKIAltdXRleF91bmxvY2soJmN0eC0+bXV0ZXgpOworCisJaWYg
KCFpOTE1X2dlbV9jb250ZXh0X2lzX3BlcnNpc3RlbnQoY3R4KSkKKwkJa2lsbF9jb250ZXh0KGN0
eCk7CisKIAlpOTE1X2dlbV9jb250ZXh0X3B1dChjdHgpOwogfQogCkBAIC00NDAsNiArNTE3LDIx
IEBAIF9fY3JlYXRlX2NvbnRleHQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCiAJaTkx
NV9nZW1fY29udGV4dF9zZXRfYmFubmFibGUoY3R4KTsKIAlpOTE1X2dlbV9jb250ZXh0X3NldF9y
ZWNvdmVyYWJsZShjdHgpOwogCisJLyoKKwkgKiBJZiB0aGUgdXNlciBoYXMgZGlzYWJsZWQgaGFu
Z2NoZWNraW5nLCB3ZSBjYW4gbm90IGJlIHN1cmUgdGhhdAorCSAqIHRoZSBiYXRjaGVzIHdpbGwg
ZXZlciBjb21wbGV0ZSBhZnRlciB0aGUgY29udGV4dCBpcyBjbG9zZWQsCisJICoga2VlcCB0aGUg
Y29udGV4dCBhbmQgYWxsIHJlc291cmNlcyBwaW5uZWQgZm9yZXZlci4gU28gaW4gdGhpcworCSAq
IGNhc2Ugd2Ugb3B0IHRvIGZvcmNpYmx5IGtpbGwgb2ZmIGFsbCByZW1haW5pbmcgcmVxdWVzdHMg
b24KKwkgKiBjb250ZXh0IGNsb3NlLgorCSAqCisJICogTm90ZSB0aGF0IHRoZSB1c2VyIG1heSBj
aGFuY2UgdGhlIHZhbHVlIG9mIHRoZSBtb2RwYXJhbSBiZXR3ZWVuCisJICogY29udGV4dCBjcmVh
dGlvbiBhbmQgY2xvc2UsIHdlIGNob29zZSB0byBpZ25vcmUgdGhpcyBmb3IgdGhlCisJICogc2Fr
ZSBvZiBkZXRlcm1pbmlzbSBhbmQgZXhwZWN0IHRoZSB1c2VyIHRvIHNldCB0aGUgcGFyYW1ldGVy
CisJICogb24gbW9kdWxlIGxvYWQgYW5kIG5ldmVyIHRvdWNoIGl0IGFnYWluLgorCSAqLworCWlm
IChpOTE1X21vZHBhcmFtcy5lbmFibGVfaGFuZ2NoZWNrKSAvKiBjZ3JvdXAgaG9vaz8gKi8KKwkJ
aTkxNV9nZW1fY29udGV4dF9zZXRfcGVyc2lzdGVuY2UoY3R4KTsKKwogCWZvciAoaSA9IDA7IGkg
PCBBUlJBWV9TSVpFKGN0eC0+aGFuZ190aW1lc3RhbXApOyBpKyspCiAJCWN0eC0+aGFuZ190aW1l
c3RhbXBbaV0gPSBqaWZmaWVzIC0gQ09OVEVYVF9GQVNUX0hBTkdfSklGRklFUzsKIApAQCAtNTk4
LDYgKzY5MCw3IEBAIGk5MTVfZ2VtX2NvbnRleHRfY3JlYXRlX2tlcm5lbChzdHJ1Y3QgZHJtX2k5
MTVfcHJpdmF0ZSAqaTkxNSwgaW50IHByaW8pCiAJfQogCiAJaTkxNV9nZW1fY29udGV4dF9jbGVh
cl9iYW5uYWJsZShjdHgpOworCWk5MTVfZ2VtX2NvbnRleHRfc2V0X3BlcnNpc3RlbmNlKGN0eCk7
CiAJY3R4LT5zY2hlZC5wcmlvcml0eSA9IEk5MTVfVVNFUl9QUklPUklUWShwcmlvKTsKIAogCUdF
TV9CVUdfT04oIWk5MTVfZ2VtX2NvbnRleHRfaXNfa2VybmVsKGN0eCkpOwpAQCAtMTczMCw2ICsx
ODIzLDI2IEBAIGdldF9lbmdpbmVzKHN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICpjdHgsCiAJcmV0
dXJuIGVycjsKIH0KIAorc3RhdGljIGludAorc2V0X3BlcnNpc3RlbmNlKHN0cnVjdCBpOTE1X2dl
bV9jb250ZXh0ICpjdHgsCisJCWNvbnN0IHN0cnVjdCBkcm1faTkxNV9nZW1fY29udGV4dF9wYXJh
bSAqYXJncykKK3sKKwlpZiAoYXJncy0+c2l6ZSkKKwkJcmV0dXJuIC1FSU5WQUw7CisKKwlpZiAo
YXJncy0+dmFsdWUpIHsKKwkJaTkxNV9nZW1fY29udGV4dF9zZXRfcGVyc2lzdGVuY2UoY3R4KTsK
KwkJcmV0dXJuIDA7CisJfQorCisJLyogVG8gY2FuY2VsIGEgY29udGV4dCB3ZSB1c2UgInByZWVt
cHQtdG8taWRsZSIgKi8KKwlpZiAoIShjdHgtPmk5MTUtPmNhcHMuc2NoZWR1bGVyICYgSTkxNV9T
Q0hFRFVMRVJfQ0FQX1BSRUVNUFRJT04pKQorCQlyZXR1cm4gLUVOT0RFVjsKKworCWk5MTVfZ2Vt
X2NvbnRleHRfY2xlYXJfcGVyc2lzdGVuY2UoY3R4KTsKKwlyZXR1cm4gMDsKK30KKwogc3RhdGlj
IGludCBjdHhfc2V0cGFyYW0oc3RydWN0IGRybV9pOTE1X2ZpbGVfcHJpdmF0ZSAqZnByaXYsCiAJ
CQlzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4LAogCQkJc3RydWN0IGRybV9pOTE1X2dlbV9j
b250ZXh0X3BhcmFtICphcmdzKQpAQCAtMTgwNyw2ICsxOTIwLDEwIEBAIHN0YXRpYyBpbnQgY3R4
X3NldHBhcmFtKHN0cnVjdCBkcm1faTkxNV9maWxlX3ByaXZhdGUgKmZwcml2LAogCQlyZXQgPSBz
ZXRfZW5naW5lcyhjdHgsIGFyZ3MpOwogCQlicmVhazsKIAorCWNhc2UgSTkxNV9DT05URVhUX1BB
UkFNX1BFUlNJU1RFTkNFOgorCQlyZXQgPSBzZXRfcGVyc2lzdGVuY2UoY3R4LCBhcmdzKTsKKwkJ
YnJlYWs7CisKIAljYXNlIEk5MTVfQ09OVEVYVF9QQVJBTV9CQU5fUEVSSU9EOgogCWRlZmF1bHQ6
CiAJCXJldCA9IC1FSU5WQUw7CkBAIC0yMjU4LDYgKzIzNzUsMTEgQEAgaW50IGk5MTVfZ2VtX2Nv
bnRleHRfZ2V0cGFyYW1faW9jdGwoc3RydWN0IGRybV9kZXZpY2UgKmRldiwgdm9pZCAqZGF0YSwK
IAkJcmV0ID0gZ2V0X2VuZ2luZXMoY3R4LCBhcmdzKTsKIAkJYnJlYWs7CiAKKwljYXNlIEk5MTVf
Q09OVEVYVF9QQVJBTV9QRVJTSVNURU5DRToKKwkJYXJncy0+c2l6ZSA9IDA7CisJCWFyZ3MtPnZh
bHVlID0gaTkxNV9nZW1fY29udGV4dF9pc19wZXJzaXN0ZW50KGN0eCk7CisJCWJyZWFrOworCiAJ
Y2FzZSBJOTE1X0NPTlRFWFRfUEFSQU1fQkFOX1BFUklPRDoKIAlkZWZhdWx0OgogCQlyZXQgPSAt
RUlOVkFMOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2Nv
bnRleHQuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jb250ZXh0LmgKaW5k
ZXggMTc2OTc4NjA4YjZmLi5lMGY1YjZjNmEzMzEgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2dlbS9pOTE1X2dlbV9jb250ZXh0LmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUv
Z2VtL2k5MTVfZ2VtX2NvbnRleHQuaApAQCAtNzQsNiArNzQsMjEgQEAgc3RhdGljIGlubGluZSB2
b2lkIGk5MTVfZ2VtX2NvbnRleHRfY2xlYXJfcmVjb3ZlcmFibGUoc3RydWN0IGk5MTVfZ2VtX2Nv
bnRleHQgKmMKIAljbGVhcl9iaXQoVUNPTlRFWFRfUkVDT1ZFUkFCTEUsICZjdHgtPnVzZXJfZmxh
Z3MpOwogfQogCitzdGF0aWMgaW5saW5lIGJvb2wgaTkxNV9nZW1fY29udGV4dF9pc19wZXJzaXN0
ZW50KGNvbnN0IHN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICpjdHgpCit7CisJcmV0dXJuIHRlc3Rf
Yml0KFVDT05URVhUX1BFUlNJU1RFTkNFLCAmY3R4LT51c2VyX2ZsYWdzKTsKK30KKworc3RhdGlj
IGlubGluZSB2b2lkIGk5MTVfZ2VtX2NvbnRleHRfc2V0X3BlcnNpc3RlbmNlKHN0cnVjdCBpOTE1
X2dlbV9jb250ZXh0ICpjdHgpCit7CisJc2V0X2JpdChVQ09OVEVYVF9QRVJTSVNURU5DRSwgJmN0
eC0+dXNlcl9mbGFncyk7Cit9CisKK3N0YXRpYyBpbmxpbmUgdm9pZCBpOTE1X2dlbV9jb250ZXh0
X2NsZWFyX3BlcnNpc3RlbmNlKHN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICpjdHgpCit7CisJY2xl
YXJfYml0KFVDT05URVhUX1BFUlNJU1RFTkNFLCAmY3R4LT51c2VyX2ZsYWdzKTsKK30KKwogc3Rh
dGljIGlubGluZSBib29sIGk5MTVfZ2VtX2NvbnRleHRfaXNfYmFubmVkKGNvbnN0IHN0cnVjdCBp
OTE1X2dlbV9jb250ZXh0ICpjdHgpCiB7CiAJcmV0dXJuIHRlc3RfYml0KENPTlRFWFRfQkFOTkVE
LCAmY3R4LT5mbGFncyk7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkx
NV9nZW1fY29udGV4dF90eXBlcy5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2Vt
X2NvbnRleHRfdHlwZXMuaAppbmRleCAyNjBkNTljYzNkZTguLmRhZjFlYTUwNzVhNiAxMDA2NDQK
LS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRleHRfdHlwZXMuaAor
KysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fY29udGV4dF90eXBlcy5oCkBA
IC0xMzcsNiArMTM3LDcgQEAgc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgewogI2RlZmluZSBVQ09O
VEVYVF9OT19FUlJPUl9DQVBUVVJFCTEKICNkZWZpbmUgVUNPTlRFWFRfQkFOTkFCTEUJCTIKICNk
ZWZpbmUgVUNPTlRFWFRfUkVDT1ZFUkFCTEUJCTMKKyNkZWZpbmUgVUNPTlRFWFRfUEVSU0lTVEVO
Q0UJCTQKIAogCS8qKgogCSAqIEBmbGFnczogc21hbGwgc2V0IG9mIGJvb2xlYW5zCmRpZmYgLS1n
aXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfaGVhcnRiZWF0LmMgYi9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfaGVhcnRiZWF0LmMKbmV3IGZpbGUg
bW9kZSAxMDA2NDQKaW5kZXggMDAwMDAwMDAwMDAwLi40M2QxMzcwZWFhN2YKLS0tIC9kZXYvbnVs
bAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfaGVhcnRiZWF0LmMK
QEAgLTAsMCArMSw1NCBAQAorLyoKKyAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNSVQKKyAq
CisgKiBDb3B5cmlnaHQgwqkgMjAxOSBJbnRlbCBDb3Jwb3JhdGlvbgorICovCisKKyNpbmNsdWRl
ICJpOTE1X3JlcXVlc3QuaCIKKworI2luY2x1ZGUgImludGVsX2NvbnRleHQuaCIKKyNpbmNsdWRl
ICJpbnRlbF9lbmdpbmVfaGVhcnRiZWF0LmgiCisjaW5jbHVkZSAiaW50ZWxfZW5naW5lX3BtLmgi
CisjaW5jbHVkZSAiaW50ZWxfZW5naW5lLmgiCisjaW5jbHVkZSAiaW50ZWxfZ3QuaCIKKworc3Rh
dGljIHZvaWQgaWRsZV9wdWxzZShzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUsIHN0cnVj
dCBpOTE1X3JlcXVlc3QgKnJxKQoreworCWVuZ2luZS0+d2FrZXJlZl9zZXJpYWwgPSBSRUFEX09O
Q0UoZW5naW5lLT5zZXJpYWwpICsgMTsKKwlpOTE1X3JlcXVlc3RfYWRkX2FjdGl2ZV9iYXJyaWVy
cyhycSk7Cit9CisKK2ludCBpbnRlbF9lbmdpbmVfcHVsc2Uoc3RydWN0IGludGVsX2VuZ2luZV9j
cyAqZW5naW5lKQoreworCXN0cnVjdCBpOTE1X3NjaGVkX2F0dHIgYXR0ciA9IHsgLnByaW9yaXR5
ID0gSTkxNV9QUklPUklUWV9CQVJSSUVSIH07CisJc3RydWN0IGludGVsX2NvbnRleHQgKmNlID0g
ZW5naW5lLT5rZXJuZWxfY29udGV4dDsKKwlzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycTsKKwlpbnQg
ZXJyID0gMDsKKworCWlmICghaW50ZWxfZW5naW5lX2hhc19wcmVlbXB0aW9uKGVuZ2luZSkpCisJ
CXJldHVybiAtRU5PREVWOworCisJaWYgKCFpbnRlbF9lbmdpbmVfcG1fZ2V0X2lmX2F3YWtlKGVu
Z2luZSkpCisJCXJldHVybiAwOworCisJbXV0ZXhfbG9jaygmY2UtPnRpbWVsaW5lLT5tdXRleCk7
CisKKwlpbnRlbF9jb250ZXh0X2VudGVyKGNlKTsKKwlycSA9IF9faTkxNV9yZXF1ZXN0X2NyZWF0
ZShjZSwgR0ZQX05PV0FJVCB8IF9fR0ZQX05PV0FSTik7CisJaW50ZWxfY29udGV4dF9leGl0KGNl
KTsKKwlpZiAoSVNfRVJSKHJxKSkgeworCQllcnIgPSBQVFJfRVJSKHJxKTsKKwkJZ290byBvdXRf
dW5sb2NrOworCX0KKworCXJxLT5mbGFncyB8PSBJOTE1X1JFUVVFU1RfU0VOVElORUw7CisJaWRs
ZV9wdWxzZShlbmdpbmUsIHJxKTsKKworCV9faTkxNV9yZXF1ZXN0X2NvbW1pdChycSk7CisJX19p
OTE1X3JlcXVlc3RfcXVldWUocnEsICZhdHRyKTsKKworb3V0X3VubG9jazoKKwltdXRleF91bmxv
Y2soJmNlLT50aW1lbGluZS0+bXV0ZXgpOworCWludGVsX2VuZ2luZV9wbV9wdXQoZW5naW5lKTsK
KwlyZXR1cm4gZXJyOworfQpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50
ZWxfZW5naW5lX2hlYXJ0YmVhdC5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZW5n
aW5lX2hlYXJ0YmVhdC5oCm5ldyBmaWxlIG1vZGUgMTAwNjQ0CmluZGV4IDAwMDAwMDAwMDAwMC4u
Yjk1MDQ1MWI1OTk4Ci0tLSAvZGV2L251bGwKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Qv
aW50ZWxfZW5naW5lX2hlYXJ0YmVhdC5oCkBAIC0wLDAgKzEsMTQgQEAKKy8qCisgKiBTUERYLUxp
Y2Vuc2UtSWRlbnRpZmllcjogTUlUCisgKgorICogQ29weXJpZ2h0IMKpIDIwMTkgSW50ZWwgQ29y
cG9yYXRpb24KKyAqLworCisjaWZuZGVmIElOVEVMX0VOR0lORV9IRUFSVEJFQVRfSAorI2RlZmlu
ZSBJTlRFTF9FTkdJTkVfSEVBUlRCRUFUX0gKKworc3RydWN0IGludGVsX2VuZ2luZV9jczsKKwor
aW50IGludGVsX2VuZ2luZV9wdWxzZShzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUpOwor
CisjZW5kaWYgLyogSU5URUxfRU5HSU5FX0hFQVJUQkVBVF9IICovCmRpZmYgLS1naXQgYS9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfcG0uYyBiL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2d0L2ludGVsX2VuZ2luZV9wbS5jCmluZGV4IDQ3MmIyMjU5ZjYyOS4uMTJhMjYwOGE4ODg5
IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfcG0uYwor
KysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfcG0uYwpAQCAtMTEwLDcg
KzExMCw3IEBAIHN0YXRpYyBib29sIHN3aXRjaF90b19rZXJuZWxfY29udGV4dChzdHJ1Y3QgaW50
ZWxfZW5naW5lX2NzICplbmdpbmUpCiAJaTkxNV9yZXF1ZXN0X2FkZF9hY3RpdmVfYmFycmllcnMo
cnEpOwogCiAJLyogSW5zdGFsbCBvdXJzZWx2ZXMgYXMgYSBwcmVlbXB0aW9uIGJhcnJpZXIgKi8K
LQlycS0+c2NoZWQuYXR0ci5wcmlvcml0eSA9IEk5MTVfUFJJT1JJVFlfVU5QUkVFTVBUQUJMRTsK
KwlycS0+c2NoZWQuYXR0ci5wcmlvcml0eSA9IEk5MTVfUFJJT1JJVFlfQkFSUklFUjsKIAlfX2k5
MTVfcmVxdWVzdF9jb21taXQocnEpOwogCiAJLyogUmVsZWFzZSBvdXIgZXhjbHVzaXZlIGhvbGQg
b24gdGhlIGVuZ2luZSAqLwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9w
cmlvbGlzdF90eXBlcy5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wcmlvbGlzdF90eXBl
cy5oCmluZGV4IDIxMDM3YTJlMjAzOC4uYWU4YmIzY2I2MjdlIDEwMDY0NAotLS0gYS9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9pOTE1X3ByaW9saXN0X3R5cGVzLmgKKysrIGIvZHJpdmVycy9ncHUvZHJt
L2k5MTUvaTkxNV9wcmlvbGlzdF90eXBlcy5oCkBAIC0zOSw2ICszOSw3IEBAIGVudW0gewogICog
YWN0aXZlIHJlcXVlc3QuCiAgKi8KICNkZWZpbmUgSTkxNV9QUklPUklUWV9VTlBSRUVNUFRBQkxF
IElOVF9NQVgKKyNkZWZpbmUgSTkxNV9QUklPUklUWV9CQVJSSUVSIElOVF9NQVgKIAogI2RlZmlu
ZSBfX05PX1BSRUVNUFRJT04gKEk5MTVfUFJJT1JJVFlfV0FJVCkKIApkaWZmIC0tZ2l0IGEvaW5j
bHVkZS91YXBpL2RybS9pOTE1X2RybS5oIGIvaW5jbHVkZS91YXBpL2RybS9pOTE1X2RybS5oCmlu
ZGV4IDQ2OWRjNTEyY2NhMy4uZGJjODY5MWQ3NWQwIDEwMDY0NAotLS0gYS9pbmNsdWRlL3VhcGkv
ZHJtL2k5MTVfZHJtLmgKKysrIGIvaW5jbHVkZS91YXBpL2RybS9pOTE1X2RybS5oCkBAIC0xNTY1
LDYgKzE1NjUsMjEgQEAgc3RydWN0IGRybV9pOTE1X2dlbV9jb250ZXh0X3BhcmFtIHsKICAqICAg
aTkxNV9jb250ZXh0X2VuZ2luZXNfYm9uZCAoSTkxNV9DT05URVhUX0VOR0lORVNfRVhUX0JPTkQp
CiAgKi8KICNkZWZpbmUgSTkxNV9DT05URVhUX1BBUkFNX0VOR0lORVMJMHhhCisKKy8qCisgKiBJ
OTE1X0NPTlRFWFRfUEFSQU1fUEVSU0lTVEVOQ0U6CisgKgorICogQWxsb3cgdGhlIGNvbnRleHQg
YW5kIGFjdGl2ZSByZW5kZXJpbmcgdG8gc3Vydml2ZSB0aGUgcHJvY2VzcyB1bnRpbAorICogY29t
cGxldGlvbi4gUGVyc2lzdGVuY2UgYWxsb3dzIGZpcmUtYW5kLWZvcmdldCBjbGllbnRzIHRvIHF1
ZXVlIHVwIGEKKyAqIGJ1bmNoIG9mIHdvcmssIGhhbmQgdGhlIG91dHB1dCBvdmVyIHRvIGEgZGlz
cGxheSBzZXJ2ZXIgYW5kIHRoZSBxdWl0LgorICogSWYgdGhlIGNvbnRleHQgaXMgbm90IG1hcmtl
ZCBhcyBwZXJzaXN0ZW50LCB1cG9uIGNsb3NpbmcgKGVpdGhlciB2aWEKKyAqIGFuIGV4cGxpY2l0
IERSTV9JOTE1X0dFTV9DT05URVhUX0RFU1RST1kgb3IgaW1wbGljaXRseSBmcm9tIGZpbGUgY2xv
c3VyZQorICogb3IgcHJvY2VzcyB0ZXJtaW5hdGlvbiksIHRoZSBjb250ZXh0IGFuZCBhbnkgb3V0
c3RhbmRpbmcgcmVxdWVzdHMgd2lsbCBiZQorICogY2FuY2VsbGVkIChhbmQgZXhwb3J0ZWQgZmVu
Y2VzIGZvciBjYW5jZWxsZWQgcmVxdWVzdHMgbWFya2VkIGFzIC1FSU8pLgorICoKKyAqIEJ5IGRl
ZmF1bHQsIG5ldyBjb250ZXh0cyBhbGxvdyBwZXJzaXN0ZW5jZS4KKyAqLworI2RlZmluZSBJOTE1
X0NPTlRFWFRfUEFSQU1fUEVSU0lTVEVOQ0UJMHhiCiAvKiBNdXN0IGJlIGtlcHQgY29tcGFjdCAt
LSBubyBob2xlcyBhbmQgd2VsbCBkb2N1bWVudGVkICovCiAKIAlfX3U2NCB2YWx1ZTsKLS0gCjIu
MjMuMAoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50
ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBz
Oi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id B1BD734C61
	for <lists+intel-gfx@lfdr.de>; Tue,  4 Jun 2019 17:38:37 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 81A3489A34;
	Tue,  4 Jun 2019 15:38:35 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 12E0B89A34
 for <intel-gfx@lists.freedesktop.org>; Tue,  4 Jun 2019 15:38:33 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 16790871-1500050 
 for <intel-gfx@lists.freedesktop.org>; Tue, 04 Jun 2019 16:38:33 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Tue,  4 Jun 2019 16:38:30 +0100
Message-Id: <20190604153830.19096-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
MIME-Version: 1.0
Subject: [Intel-gfx] [CI] drm/i915/gtt: Replace struct_mutex serialisation
 for allocation
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SW5zdGVhZCBvZiByZWx5aW5nIG9uIHRoZSBjYWxsZXIgaG9sZGluZyBzdHJ1Y3RfbXV0ZXggYWNy
b3NzIHRoZQphbGxvY2F0aW9uLCBwdXNoIHRoZSBhbGxvY2F0aW9uIHVuZGVyIGEgdHJlZSBvZiBz
cGlubG9ja3Mgc3RvcmVkIGluc2lkZQp0aGUgcGFnZSB0YWJsZXMuIE5vdCBvbmx5IHNob3VsZCB0
aGlzIGFsbG93IHVzIHRvIGF2b2lkIHN0cnVjdF9tdXRleApoZXJlLCBidXQgaXQgd2lsbCBhbGxv
dyBtdWx0aXBsZSB1c2VycyB0byBsb2NrIGluZGVwZW5kZW50IHJhbmdlcyBmb3IKY29uY3VycmVu
dCBhbGxvY2F0aW9ucywgYW5kIG9wZXJhdGUgaW5kZXBlbmRlbnRseS4gVGhpcyBpcyB2aXRhbCBm
b3IKcHVzaGluZyB0aGUgR1RUIG1hbmlwdWxhdGlvbiBpbnRvIGEgYmFja2dyb3VuZCB0aHJlYWQg
d2hlcmUgZGVwZW5kZW5jeQpvbiBzdHJ1Y3RfbXV0ZXggaXMgdmVyYm90ZW4sIGFuZCBmb3IgYWxs
b3dpbmcgb3RoZXIgY2FsbGVycyB0byBhdm9pZApzdHJ1Y3RfbXV0ZXggYWx0b2dldGhlci4KCnYy
OiBSZXN0b3JlIGxvc3QgR0VNX0JVR19PTiBmb3IgcmVtb3ZpbmcgdG9vIG1hbnkgUFRFIGZyb20K
Z2VuNl9wcGd0dF9jbGVhcl9yYW5nZS4KClNpZ25lZC1vZmYtYnk6IENocmlzIFdpbHNvbiA8Y2hy
aXNAY2hyaXMtd2lsc29uLmNvLnVrPgpDYzogTWF0dGhldyBBdWxkIDxtYXR0aGV3LmF1bGRAaW50
ZWwuY29tPgpDYzogTWlrYSBLdW9wcGFsYSA8bWlrYS5rdW9wcGFsYUBpbnRlbC5jb20+ClJldmll
d2VkLWJ5OiBKb29uYXMgTGFodGluZW4gPGpvb25hcy5sYWh0aW5lbkBsaW51eC5pbnRlbC5jb20+
CkFja2VkLWJ5OiBNaWthIEt1b3BwYWxhIDxtaWthLmt1b3BwYWxhQGludGVsLmNvbT4KLS0tCiBk
cml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuYyB8IDIxMyArKysrKysrKysrKysrKysr
KysrLS0tLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuaCB8ICAgOSAr
LQogMiBmaWxlcyBjaGFuZ2VkLCAxNTMgaW5zZXJ0aW9ucygrKSwgNjkgZGVsZXRpb25zKC0pCgpk
aWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW1fZ3R0LmMgYi9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuYwppbmRleCBjYThhNjllOGIwOTguLjljYTEzZTUy
MjBkZCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW1fZ3R0LmMKKysr
IGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW1fZ3R0LmMKQEAgLTY1NSw3ICs2NTUsNyBA
QCBzdGF0aWMgc3RydWN0IGk5MTVfcGFnZV90YWJsZSAqYWxsb2NfcHQoc3RydWN0IGk5MTVfYWRk
cmVzc19zcGFjZSAqdm0pCiAJCXJldHVybiBFUlJfUFRSKC1FTk9NRU0pOwogCX0KIAotCXB0LT51
c2VkX3B0ZXMgPSAwOworCWF0b21pY19zZXQoJnB0LT51c2VkX3B0ZXMsIDApOwogCXJldHVybiBw
dDsKIH0KIApAQCAtNjkwLDcgKzY5MCw4IEBAIHN0YXRpYyBzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVj
dG9yeSAqYWxsb2NfcGQoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0pCiAJCXJldHVybiBF
UlJfUFRSKC1FTk9NRU0pOwogCX0KIAotCXBkLT51c2VkX3BkZXMgPSAwOworCWF0b21pY19zZXQo
JnBkLT51c2VkX3BkZXMsIDApOworCXNwaW5fbG9ja19pbml0KCZwZC0+bG9jayk7CiAJcmV0dXJu
IHBkOwogfQogCkBAIC03MjEsNiArNzIyLDggQEAgc3RhdGljIGludCBfX3BkcF9pbml0KHN0cnVj
dCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAogCiAJbWVtc2V0X3AoKHZvaWQgKiopcGRwLT5wYWdl
X2RpcmVjdG9yeSwgdm0tPnNjcmF0Y2hfcGQsIHBkcGVzKTsKIAorCWF0b21pY19zZXQoJnBkcC0+
dXNlZF9wZHBlcywgMCk7CisJc3Bpbl9sb2NrX2luaXQoJnBkcC0+bG9jayk7CiAJcmV0dXJuIDA7
CiB9CiAKQEAgLTc3NSwxMSArNzc4LDggQEAgc3RhdGljIHZvaWQgZnJlZV9wZHAoc3RydWN0IGk5
MTVfYWRkcmVzc19zcGFjZSAqdm0sCiBzdGF0aWMgdm9pZCBnZW44X2luaXRpYWxpemVfcGRwKHN0
cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAogCQkJCXN0cnVjdCBpOTE1X3BhZ2VfZGlyZWN0
b3J5X3BvaW50ZXIgKnBkcCkKIHsKLQlnZW44X3BwZ3R0X3BkcGVfdCBzY3JhdGNoX3BkcGU7Ci0K
LQlzY3JhdGNoX3BkcGUgPSBnZW44X3BkcGVfZW5jb2RlKHB4X2RtYSh2bS0+c2NyYXRjaF9wZCks
IEk5MTVfQ0FDSEVfTExDKTsKLQotCWZpbGxfcHgodm0sIHBkcCwgc2NyYXRjaF9wZHBlKTsKKwlm
aWxsX3B4KHZtLCBwZHAsCisJCWdlbjhfcGRwZV9lbmNvZGUocHhfZG1hKHZtLT5zY3JhdGNoX3Bk
KSwgSTkxNV9DQUNIRV9MTEMpKTsKIH0KIAogc3RhdGljIHZvaWQgZ2VuOF9pbml0aWFsaXplX3Bt
bDQoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCkBAIC03ODgsNiArNzg4LDcgQEAgc3Rh
dGljIHZvaWQgZ2VuOF9pbml0aWFsaXplX3BtbDQoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAq
dm0sCiAJZmlsbF9weCh2bSwgcG1sNCwKIAkJZ2VuOF9wbWw0ZV9lbmNvZGUocHhfZG1hKHZtLT5z
Y3JhdGNoX3BkcCksIEk5MTVfQ0FDSEVfTExDKSk7CiAJbWVtc2V0X3AoKHZvaWQgKiopcG1sNC0+
cGRwcywgdm0tPnNjcmF0Y2hfcGRwLCBHRU44X1BNTDRFU19QRVJfUE1MNCk7CisJc3Bpbl9sb2Nr
X2luaXQoJnBtbDQtPmxvY2spOwogfQogCiAvKgpAQCAtODExLDE3ICs4MTIsMTIgQEAgc3RhdGlj
IGJvb2wgZ2VuOF9wcGd0dF9jbGVhcl9wdChjb25zdCBzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNl
ICp2bSwKIAl1bnNpZ25lZCBpbnQgbnVtX2VudHJpZXMgPSBnZW44X3B0ZV9jb3VudChzdGFydCwg
bGVuZ3RoKTsKIAlnZW44X3B0ZV90ICp2YWRkcjsKIAotCUdFTV9CVUdfT04obnVtX2VudHJpZXMg
PiBwdC0+dXNlZF9wdGVzKTsKLQotCXB0LT51c2VkX3B0ZXMgLT0gbnVtX2VudHJpZXM7Ci0JaWYg
KCFwdC0+dXNlZF9wdGVzKQotCQlyZXR1cm4gdHJ1ZTsKLQogCXZhZGRyID0ga21hcF9hdG9taWNf
cHgocHQpOwogCW1lbXNldDY0KHZhZGRyICsgZ2VuOF9wdGVfaW5kZXgoc3RhcnQpLCB2bS0+c2Ny
YXRjaF9wdGUsIG51bV9lbnRyaWVzKTsKIAlrdW5tYXBfYXRvbWljKHZhZGRyKTsKIAotCXJldHVy
biBmYWxzZTsKKwlHRU1fQlVHX09OKG51bV9lbnRyaWVzID4gYXRvbWljX3JlYWQoJnB0LT51c2Vk
X3B0ZXMpKTsKKwlyZXR1cm4gIWF0b21pY19zdWJfcmV0dXJuKG51bV9lbnRyaWVzLCAmcHQtPnVz
ZWRfcHRlcyk7CiB9CiAKIHN0YXRpYyB2b2lkIGdlbjhfcHBndHRfc2V0X3BkZShzdHJ1Y3QgaTkx
NV9hZGRyZXNzX3NwYWNlICp2bSwKQEAgLTgzMSw4ICs4MjcsNiBAQCBzdGF0aWMgdm9pZCBnZW44
X3BwZ3R0X3NldF9wZGUoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCiB7CiAJZ2VuOF9w
ZGVfdCAqdmFkZHI7CiAKLQlwZC0+cGFnZV90YWJsZVtwZGVdID0gcHQ7Ci0KIAl2YWRkciA9IGtt
YXBfYXRvbWljX3B4KHBkKTsKIAl2YWRkcltwZGVdID0gZ2VuOF9wZGVfZW5jb2RlKHB4X2RtYShw
dCksIEk5MTVfQ0FDSEVfTExDKTsKIAlrdW5tYXBfYXRvbWljKHZhZGRyKTsKQEAgLTg0NiwxOSAr
ODQwLDI4IEBAIHN0YXRpYyBib29sIGdlbjhfcHBndHRfY2xlYXJfcGQoc3RydWN0IGk5MTVfYWRk
cmVzc19zcGFjZSAqdm0sCiAJdTMyIHBkZTsKIAogCWdlbjhfZm9yX2VhY2hfcGRlKHB0LCBwZCwg
c3RhcnQsIGxlbmd0aCwgcGRlKSB7CisJCWJvb2wgZnJlZSA9IGZhbHNlOworCiAJCUdFTV9CVUdf
T04ocHQgPT0gdm0tPnNjcmF0Y2hfcHQpOwogCiAJCWlmICghZ2VuOF9wcGd0dF9jbGVhcl9wdCh2
bSwgcHQsIHN0YXJ0LCBsZW5ndGgpKQogCQkJY29udGludWU7CiAKLQkJZ2VuOF9wcGd0dF9zZXRf
cGRlKHZtLCBwZCwgdm0tPnNjcmF0Y2hfcHQsIHBkZSk7Ci0JCUdFTV9CVUdfT04oIXBkLT51c2Vk
X3BkZXMpOwotCQlwZC0+dXNlZF9wZGVzLS07CisJCXNwaW5fbG9jaygmcGQtPmxvY2spOworCQlp
ZiAoIWF0b21pY19yZWFkKCZwdC0+dXNlZF9wdGVzKSkgeworCQkJZ2VuOF9wcGd0dF9zZXRfcGRl
KHZtLCBwZCwgdm0tPnNjcmF0Y2hfcHQsIHBkZSk7CisJCQlwZC0+cGFnZV90YWJsZVtwZGVdID0g
dm0tPnNjcmF0Y2hfcHQ7CiAKLQkJZnJlZV9wdCh2bSwgcHQpOworCQkJR0VNX0JVR19PTighYXRv
bWljX3JlYWQoJnBkLT51c2VkX3BkZXMpKTsKKwkJCWF0b21pY19kZWMoJnBkLT51c2VkX3BkZXMp
OworCQkJZnJlZSA9IHRydWU7CisJCX0KKwkJc3Bpbl91bmxvY2soJnBkLT5sb2NrKTsKKwkJaWYg
KGZyZWUpCisJCQlmcmVlX3B0KHZtLCBwdCk7CiAJfQogCi0JcmV0dXJuICFwZC0+dXNlZF9wZGVz
OworCXJldHVybiAhYXRvbWljX3JlYWQoJnBkLT51c2VkX3BkZXMpOwogfQogCiBzdGF0aWMgdm9p
ZCBnZW44X3BwZ3R0X3NldF9wZHBlKHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLApAQCAt
ODY4LDcgKzg3MSw2IEBAIHN0YXRpYyB2b2lkIGdlbjhfcHBndHRfc2V0X3BkcGUoc3RydWN0IGk5
MTVfYWRkcmVzc19zcGFjZSAqdm0sCiB7CiAJZ2VuOF9wcGd0dF9wZHBlX3QgKnZhZGRyOwogCi0J
cGRwLT5wYWdlX2RpcmVjdG9yeVtwZHBlXSA9IHBkOwogCWlmICghaTkxNV92bV9pc180bHZsKHZt
KSkKIAkJcmV0dXJuOwogCkBAIC04ODgsMTkgKzg5MCwyOCBAQCBzdGF0aWMgYm9vbCBnZW44X3Bw
Z3R0X2NsZWFyX3BkcChzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKIAl1bnNpZ25lZCBp
bnQgcGRwZTsKIAogCWdlbjhfZm9yX2VhY2hfcGRwZShwZCwgcGRwLCBzdGFydCwgbGVuZ3RoLCBw
ZHBlKSB7CisJCWJvb2wgZnJlZSA9IGZhbHNlOworCiAJCUdFTV9CVUdfT04ocGQgPT0gdm0tPnNj
cmF0Y2hfcGQpOwogCiAJCWlmICghZ2VuOF9wcGd0dF9jbGVhcl9wZCh2bSwgcGQsIHN0YXJ0LCBs
ZW5ndGgpKQogCQkJY29udGludWU7CiAKLQkJZ2VuOF9wcGd0dF9zZXRfcGRwZSh2bSwgcGRwLCB2
bS0+c2NyYXRjaF9wZCwgcGRwZSk7Ci0JCUdFTV9CVUdfT04oIXBkcC0+dXNlZF9wZHBlcyk7Ci0J
CXBkcC0+dXNlZF9wZHBlcy0tOworCQlzcGluX2xvY2soJnBkcC0+bG9jayk7CisJCWlmICghYXRv
bWljX3JlYWQoJnBkLT51c2VkX3BkZXMpKSB7CisJCQlnZW44X3BwZ3R0X3NldF9wZHBlKHZtLCBw
ZHAsIHZtLT5zY3JhdGNoX3BkLCBwZHBlKTsKKwkJCXBkcC0+cGFnZV9kaXJlY3RvcnlbcGRwZV0g
PSB2bS0+c2NyYXRjaF9wZDsKIAotCQlmcmVlX3BkKHZtLCBwZCk7CisJCQlHRU1fQlVHX09OKCFh
dG9taWNfcmVhZCgmcGRwLT51c2VkX3BkcGVzKSk7CisJCQlhdG9taWNfZGVjKCZwZHAtPnVzZWRf
cGRwZXMpOworCQkJZnJlZSA9IHRydWU7CisJCX0KKwkJc3Bpbl91bmxvY2soJnBkcC0+bG9jayk7
CisJCWlmIChmcmVlKQorCQkJZnJlZV9wZCh2bSwgcGQpOwogCX0KIAotCXJldHVybiAhcGRwLT51
c2VkX3BkcGVzOworCXJldHVybiAhYXRvbWljX3JlYWQoJnBkcC0+dXNlZF9wZHBlcyk7CiB9CiAK
IHN0YXRpYyB2b2lkIGdlbjhfcHBndHRfY2xlYXJfM2x2bChzdHJ1Y3QgaTkxNV9hZGRyZXNzX3Nw
YWNlICp2bSwKQEAgLTkxNSw4ICs5MjYsNiBAQCBzdGF0aWMgdm9pZCBnZW44X3BwZ3R0X3NldF9w
bWw0ZShzdHJ1Y3QgaTkxNV9wbWw0ICpwbWw0LAogewogCWdlbjhfcHBndHRfcG1sNGVfdCAqdmFk
ZHI7CiAKLQlwbWw0LT5wZHBzW3BtbDRlXSA9IHBkcDsKLQogCXZhZGRyID0ga21hcF9hdG9taWNf
cHgocG1sNCk7CiAJdmFkZHJbcG1sNGVdID0gZ2VuOF9wbWw0ZV9lbmNvZGUocHhfZG1hKHBkcCks
IEk5MTVfQ0FDSEVfTExDKTsKIAlrdW5tYXBfYXRvbWljKHZhZGRyKTsKQEAgLTkzNywxNCArOTQ2
LDIxIEBAIHN0YXRpYyB2b2lkIGdlbjhfcHBndHRfY2xlYXJfNGx2bChzdHJ1Y3QgaTkxNV9hZGRy
ZXNzX3NwYWNlICp2bSwKIAlHRU1fQlVHX09OKCFpOTE1X3ZtX2lzXzRsdmwodm0pKTsKIAogCWdl
bjhfZm9yX2VhY2hfcG1sNGUocGRwLCBwbWw0LCBzdGFydCwgbGVuZ3RoLCBwbWw0ZSkgeworCQli
b29sIGZyZWUgPSBmYWxzZTsKIAkJR0VNX0JVR19PTihwZHAgPT0gdm0tPnNjcmF0Y2hfcGRwKTsK
IAogCQlpZiAoIWdlbjhfcHBndHRfY2xlYXJfcGRwKHZtLCBwZHAsIHN0YXJ0LCBsZW5ndGgpKQog
CQkJY29udGludWU7CiAKLQkJZ2VuOF9wcGd0dF9zZXRfcG1sNGUocG1sNCwgdm0tPnNjcmF0Y2hf
cGRwLCBwbWw0ZSk7Ci0KLQkJZnJlZV9wZHAodm0sIHBkcCk7CisJCXNwaW5fbG9jaygmcG1sNC0+
bG9jayk7CisJCWlmICghYXRvbWljX3JlYWQoJnBkcC0+dXNlZF9wZHBlcykpIHsKKwkJCWdlbjhf
cHBndHRfc2V0X3BtbDRlKHBtbDQsIHZtLT5zY3JhdGNoX3BkcCwgcG1sNGUpOworCQkJcG1sNC0+
cGRwc1twbWw0ZV0gPSB2bS0+c2NyYXRjaF9wZHA7CisJCQlmcmVlID0gdHJ1ZTsKKwkJfQorCQlz
cGluX3VubG9jaygmcG1sNC0+bG9jayk7CisJCWlmIChmcmVlKQorCQkJZnJlZV9wZHAodm0sIHBk
cCk7CiAJfQogfQogCkBAIC0xMzY5LDI3ICsxMzg1LDM4IEBAIHN0YXRpYyBpbnQgZ2VuOF9wcGd0
dF9hbGxvY19wZChzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKIAl1NjQgZnJvbSA9IHN0
YXJ0OwogCXVuc2lnbmVkIGludCBwZGU7CiAKKwlzcGluX2xvY2soJnBkLT5sb2NrKTsKIAlnZW44
X2Zvcl9lYWNoX3BkZShwdCwgcGQsIHN0YXJ0LCBsZW5ndGgsIHBkZSkgewotCQlpbnQgY291bnQg
PSBnZW44X3B0ZV9jb3VudChzdGFydCwgbGVuZ3RoKTsKKwkJY29uc3QgaW50IGNvdW50ID0gZ2Vu
OF9wdGVfY291bnQoc3RhcnQsIGxlbmd0aCk7CiAKIAkJaWYgKHB0ID09IHZtLT5zY3JhdGNoX3B0
KSB7Ci0JCQlwZC0+dXNlZF9wZGVzKys7CisJCQlzdHJ1Y3QgaTkxNV9wYWdlX3RhYmxlICpvbGQ7
CisKKwkJCXNwaW5fdW5sb2NrKCZwZC0+bG9jayk7CiAKIAkJCXB0ID0gYWxsb2NfcHQodm0pOwot
CQkJaWYgKElTX0VSUihwdCkpIHsKLQkJCQlwZC0+dXNlZF9wZGVzLS07CisJCQlpZiAoSVNfRVJS
KHB0KSkKIAkJCQlnb3RvIHVud2luZDsKLQkJCX0KIAogCQkJaWYgKGNvdW50IDwgR0VOOF9QVEVT
IHx8IGludGVsX3ZncHVfYWN0aXZlKHZtLT5pOTE1KSkKIAkJCQlnZW44X2luaXRpYWxpemVfcHQo
dm0sIHB0KTsKIAotCQkJZ2VuOF9wcGd0dF9zZXRfcGRlKHZtLCBwZCwgcHQsIHBkZSk7Ci0JCQlH
RU1fQlVHX09OKHBkLT51c2VkX3BkZXMgPiBJOTE1X1BERVMpOworCQkJb2xkID0gY21weGNoZygm
cGQtPnBhZ2VfdGFibGVbcGRlXSwgdm0tPnNjcmF0Y2hfcHQsIHB0KTsKKwkJCWlmIChvbGQgPT0g
dm0tPnNjcmF0Y2hfcHQpIHsKKwkJCQlnZW44X3BwZ3R0X3NldF9wZGUodm0sIHBkLCBwdCwgcGRl
KTsKKwkJCQlhdG9taWNfaW5jKCZwZC0+dXNlZF9wZGVzKTsKKwkJCX0gZWxzZSB7CisJCQkJZnJl
ZV9wdCh2bSwgcHQpOworCQkJCXB0ID0gb2xkOworCQkJfQorCisJCQlzcGluX2xvY2soJnBkLT5s
b2NrKTsKIAkJfQogCi0JCXB0LT51c2VkX3B0ZXMgKz0gY291bnQ7CisJCWF0b21pY19hZGQoY291
bnQsICZwdC0+dXNlZF9wdGVzKTsKIAl9CisJc3Bpbl91bmxvY2soJnBkLT5sb2NrKTsKKwogCXJl
dHVybiAwOwogCiB1bndpbmQ6CkBAIC0xNDA2LDM1ICsxNDMzLDU0IEBAIHN0YXRpYyBpbnQgZ2Vu
OF9wcGd0dF9hbGxvY19wZHAoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCiAJdW5zaWdu
ZWQgaW50IHBkcGU7CiAJaW50IHJldDsKIAorCXNwaW5fbG9jaygmcGRwLT5sb2NrKTsKIAlnZW44
X2Zvcl9lYWNoX3BkcGUocGQsIHBkcCwgc3RhcnQsIGxlbmd0aCwgcGRwZSkgewogCQlpZiAocGQg
PT0gdm0tPnNjcmF0Y2hfcGQpIHsKLQkJCXBkcC0+dXNlZF9wZHBlcysrOworCQkJc3RydWN0IGk5
MTVfcGFnZV9kaXJlY3RvcnkgKm9sZDsKKworCQkJc3Bpbl91bmxvY2soJnBkcC0+bG9jayk7CiAK
IAkJCXBkID0gYWxsb2NfcGQodm0pOwotCQkJaWYgKElTX0VSUihwZCkpIHsKLQkJCQlwZHAtPnVz
ZWRfcGRwZXMtLTsKKwkJCWlmIChJU19FUlIocGQpKQogCQkJCWdvdG8gdW53aW5kOwotCQkJfQog
CiAJCQlnZW44X2luaXRpYWxpemVfcGQodm0sIHBkKTsKLQkJCWdlbjhfcHBndHRfc2V0X3BkcGUo
dm0sIHBkcCwgcGQsIHBkcGUpOwotCQkJR0VNX0JVR19PTihwZHAtPnVzZWRfcGRwZXMgPiBpOTE1
X3BkcGVzX3Blcl9wZHAodm0pKTsKKworCQkJb2xkID0gY21weGNoZygmcGRwLT5wYWdlX2RpcmVj
dG9yeVtwZHBlXSwKKwkJCQkgICAgICB2bS0+c2NyYXRjaF9wZCwgcGQpOworCQkJaWYgKG9sZCA9
PSB2bS0+c2NyYXRjaF9wZCkgeworCQkJCWdlbjhfcHBndHRfc2V0X3BkcGUodm0sIHBkcCwgcGQs
IHBkcGUpOworCQkJCWF0b21pY19pbmMoJnBkcC0+dXNlZF9wZHBlcyk7CisJCQl9IGVsc2Ugewor
CQkJCWZyZWVfcGQodm0sIHBkKTsKKwkJCQlwZCA9IG9sZDsKKwkJCX0KKworCQkJc3Bpbl9sb2Nr
KCZwZHAtPmxvY2spOwogCQl9CisJCWF0b21pY19pbmMoJnBkLT51c2VkX3BkZXMpOworCQlzcGlu
X3VubG9jaygmcGRwLT5sb2NrKTsKIAogCQlyZXQgPSBnZW44X3BwZ3R0X2FsbG9jX3BkKHZtLCBw
ZCwgc3RhcnQsIGxlbmd0aCk7CiAJCWlmICh1bmxpa2VseShyZXQpKQogCQkJZ290byB1bndpbmRf
cGQ7CisKKwkJc3Bpbl9sb2NrKCZwZHAtPmxvY2spOworCQlhdG9taWNfZGVjKCZwZC0+dXNlZF9w
ZGVzKTsKIAl9CisJc3Bpbl91bmxvY2soJnBkcC0+bG9jayk7CiAKIAlyZXR1cm4gMDsKIAogdW53
aW5kX3BkOgotCWlmICghcGQtPnVzZWRfcGRlcykgeworCXNwaW5fbG9jaygmcGRwLT5sb2NrKTsK
KwlpZiAoYXRvbWljX2RlY19hbmRfdGVzdCgmcGQtPnVzZWRfcGRlcykpIHsKIAkJZ2VuOF9wcGd0
dF9zZXRfcGRwZSh2bSwgcGRwLCB2bS0+c2NyYXRjaF9wZCwgcGRwZSk7Ci0JCUdFTV9CVUdfT04o
IXBkcC0+dXNlZF9wZHBlcyk7Ci0JCXBkcC0+dXNlZF9wZHBlcy0tOworCQlHRU1fQlVHX09OKCFh
dG9taWNfcmVhZCgmcGRwLT51c2VkX3BkcGVzKSk7CisJCWF0b21pY19kZWMoJnBkcC0+dXNlZF9w
ZHBlcyk7CiAJCWZyZWVfcGQodm0sIHBkKTsKIAl9CisJc3Bpbl91bmxvY2soJnBkcC0+bG9jayk7
CiB1bndpbmQ6CiAJZ2VuOF9wcGd0dF9jbGVhcl9wZHAodm0sIHBkcCwgZnJvbSwgc3RhcnQgLSBm
cm9tKTsKIAlyZXR1cm4gLUVOT01FTTsKQEAgLTE0NTcsMjggKzE1MDMsNTAgQEAgc3RhdGljIGlu
dCBnZW44X3BwZ3R0X2FsbG9jXzRsdmwoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCiAJ
dTMyIHBtbDRlOwogCWludCByZXQ7CiAKKwlzcGluX2xvY2soJnBtbDQtPmxvY2spOwogCWdlbjhf
Zm9yX2VhY2hfcG1sNGUocGRwLCBwbWw0LCBzdGFydCwgbGVuZ3RoLCBwbWw0ZSkgewotCQlpZiAo
cG1sNC0+cGRwc1twbWw0ZV0gPT0gdm0tPnNjcmF0Y2hfcGRwKSB7CisJCWlmIChwZHAgPT0gdm0t
PnNjcmF0Y2hfcGRwKSB7CisJCQlzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeV9wb2ludGVyICpv
bGQ7CisKKwkJCXNwaW5fdW5sb2NrKCZwbWw0LT5sb2NrKTsKKwogCQkJcGRwID0gYWxsb2NfcGRw
KHZtKTsKIAkJCWlmIChJU19FUlIocGRwKSkKIAkJCQlnb3RvIHVud2luZDsKIAogCQkJZ2VuOF9p
bml0aWFsaXplX3BkcCh2bSwgcGRwKTsKLQkJCWdlbjhfcHBndHRfc2V0X3BtbDRlKHBtbDQsIHBk
cCwgcG1sNGUpOworCisJCQlvbGQgPSBjbXB4Y2hnKCZwbWw0LT5wZHBzW3BtbDRlXSwgdm0tPnNj
cmF0Y2hfcGRwLCBwZHApOworCQkJaWYgKG9sZCA9PSB2bS0+c2NyYXRjaF9wZHApIHsKKwkJCQln
ZW44X3BwZ3R0X3NldF9wbWw0ZShwbWw0LCBwZHAsIHBtbDRlKTsKKwkJCX0gZWxzZSB7CisJCQkJ
ZnJlZV9wZHAodm0sIHBkcCk7CisJCQkJcGRwID0gb2xkOworCQkJfQorCisJCQlzcGluX2xvY2so
JnBtbDQtPmxvY2spOwogCQl9CisJCWF0b21pY19pbmMoJnBkcC0+dXNlZF9wZHBlcyk7CisJCXNw
aW5fdW5sb2NrKCZwbWw0LT5sb2NrKTsKIAogCQlyZXQgPSBnZW44X3BwZ3R0X2FsbG9jX3BkcCh2
bSwgcGRwLCBzdGFydCwgbGVuZ3RoKTsKIAkJaWYgKHVubGlrZWx5KHJldCkpCiAJCQlnb3RvIHVu
d2luZF9wZHA7CisKKwkJc3Bpbl9sb2NrKCZwbWw0LT5sb2NrKTsKKwkJYXRvbWljX2RlYygmcGRw
LT51c2VkX3BkcGVzKTsKIAl9CisJc3Bpbl91bmxvY2soJnBtbDQtPmxvY2spOwogCiAJcmV0dXJu
IDA7CiAKIHVud2luZF9wZHA6Ci0JaWYgKCFwZHAtPnVzZWRfcGRwZXMpIHsKKwlzcGluX2xvY2so
JnBtbDQtPmxvY2spOworCWlmIChhdG9taWNfZGVjX2FuZF90ZXN0KCZwZHAtPnVzZWRfcGRwZXMp
KSB7CiAJCWdlbjhfcHBndHRfc2V0X3BtbDRlKHBtbDQsIHZtLT5zY3JhdGNoX3BkcCwgcG1sNGUp
OwogCQlmcmVlX3BkcCh2bSwgcGRwKTsKIAl9CisJc3Bpbl91bmxvY2soJnBtbDQtPmxvY2spOwog
dW53aW5kOgogCWdlbjhfcHBndHRfY2xlYXJfNGx2bCh2bSwgZnJvbSwgc3RhcnQgLSBmcm9tKTsK
IAlyZXR1cm4gLUVOT01FTTsKQEAgLTE1MDAsMTAgKzE1NjgsMTAgQEAgc3RhdGljIGludCBnZW44
X3ByZWFsbG9jYXRlX3RvcF9sZXZlbF9wZHAoc3RydWN0IGk5MTVfaHdfcHBndHQgKnBwZ3R0KQog
CiAJCWdlbjhfaW5pdGlhbGl6ZV9wZCh2bSwgcGQpOwogCQlnZW44X3BwZ3R0X3NldF9wZHBlKHZt
LCBwZHAsIHBkLCBwZHBlKTsKLQkJcGRwLT51c2VkX3BkcGVzKys7CisJCWF0b21pY19pbmMoJnBk
cC0+dXNlZF9wZHBlcyk7CiAJfQogCi0JcGRwLT51c2VkX3BkcGVzKys7IC8qIG5ldmVyIHJlbW92
ZSAqLworCWF0b21pY19pbmMoJnBkcC0+dXNlZF9wZHBlcyk7IC8qIG5ldmVyIHJlbW92ZSAqLwog
CXJldHVybiAwOwogCiB1bndpbmQ6CkBAIC0xNTEyLDcgKzE1ODAsNyBAQCBzdGF0aWMgaW50IGdl
bjhfcHJlYWxsb2NhdGVfdG9wX2xldmVsX3BkcChzdHJ1Y3QgaTkxNV9od19wcGd0dCAqcHBndHQp
CiAJCWdlbjhfcHBndHRfc2V0X3BkcGUodm0sIHBkcCwgdm0tPnNjcmF0Y2hfcGQsIHBkcGUpOwog
CQlmcmVlX3BkKHZtLCBwZCk7CiAJfQotCXBkcC0+dXNlZF9wZHBlcyA9IDA7CisJYXRvbWljX3Nl
dCgmcGRwLT51c2VkX3BkcGVzLCAwKTsKIAlyZXR1cm4gLUVOT01FTTsKIH0KIApAQCAtMTY4NCw5
ICsxNzUyLDggQEAgc3RhdGljIHZvaWQgZ2VuNl9wcGd0dF9jbGVhcl9yYW5nZShzdHJ1Y3QgaTkx
NV9hZGRyZXNzX3NwYWNlICp2bSwKIAogCQludW1fZW50cmllcyAtPSBjb3VudDsKIAotCQlHRU1f
QlVHX09OKGNvdW50ID4gcHQtPnVzZWRfcHRlcyk7Ci0JCXB0LT51c2VkX3B0ZXMgLT0gY291bnQ7
Ci0JCWlmICghcHQtPnVzZWRfcHRlcykKKwkJR0VNX0JVR19PTihjb3VudCA+IGF0b21pY19yZWFk
KCZwdC0+dXNlZF9wdGVzKSk7CisJCWlmICghYXRvbWljX3N1Yl9yZXR1cm4oY291bnQsICZwdC0+
dXNlZF9wdGVzKSkKIAkJCXBwZ3R0LT5zY2FuX2Zvcl91bnVzZWRfcHQgPSB0cnVlOwogCiAJCS8q
CkBAIC0xNzU2LDI4ICsxODIzLDQxIEBAIHN0YXRpYyBpbnQgZ2VuNl9hbGxvY192YV9yYW5nZShz
dHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKIAogCXdha2VyZWYgPSBpbnRlbF9ydW50aW1l
X3BtX2dldCh2bS0+aTkxNSk7CiAKKwlzcGluX2xvY2soJnBwZ3R0LT5iYXNlLnBkLmxvY2spOwog
CWdlbjZfZm9yX2VhY2hfcGRlKHB0LCAmcHBndHQtPmJhc2UucGQsIHN0YXJ0LCBsZW5ndGgsIHBk
ZSkgewogCQljb25zdCB1bnNpZ25lZCBpbnQgY291bnQgPSBnZW42X3B0ZV9jb3VudChzdGFydCwg
bGVuZ3RoKTsKIAogCQlpZiAocHQgPT0gdm0tPnNjcmF0Y2hfcHQpIHsKKwkJCXN0cnVjdCBpOTE1
X3BhZ2VfdGFibGUgKm9sZDsKKworCQkJc3Bpbl91bmxvY2soJnBwZ3R0LT5iYXNlLnBkLmxvY2sp
OworCiAJCQlwdCA9IGFsbG9jX3B0KHZtKTsKIAkJCWlmIChJU19FUlIocHQpKQogCQkJCWdvdG8g
dW53aW5kX291dDsKIAogCQkJZ2VuNl9pbml0aWFsaXplX3B0KHZtLCBwdCk7Ci0JCQlwcGd0dC0+
YmFzZS5wZC5wYWdlX3RhYmxlW3BkZV0gPSBwdDsKIAotCQkJaWYgKGk5MTVfdm1hX2lzX2JvdW5k
KHBwZ3R0LT52bWEsCi0JCQkJCSAgICAgIEk5MTVfVk1BX0dMT0JBTF9CSU5EKSkgewotCQkJCWdl
bjZfd3JpdGVfcGRlKHBwZ3R0LCBwZGUsIHB0KTsKLQkJCQlmbHVzaCA9IHRydWU7CisJCQlvbGQg
PSBjbXB4Y2hnKCZwcGd0dC0+YmFzZS5wZC5wYWdlX3RhYmxlW3BkZV0sCisJCQkJICAgICAgdm0t
PnNjcmF0Y2hfcHQsIHB0KTsKKwkJCWlmIChvbGQgPT0gdm0tPnNjcmF0Y2hfcHQpIHsKKwkJCQlw
cGd0dC0+YmFzZS5wZC5wYWdlX3RhYmxlW3BkZV0gPSBwdDsKKwkJCQlpZiAoaTkxNV92bWFfaXNf
Ym91bmQocHBndHQtPnZtYSwKKwkJCQkJCSAgICAgIEk5MTVfVk1BX0dMT0JBTF9CSU5EKSkgewor
CQkJCQlnZW42X3dyaXRlX3BkZShwcGd0dCwgcGRlLCBwdCk7CisJCQkJCWZsdXNoID0gdHJ1ZTsK
KwkJCQl9CisJCQl9IGVsc2UgeworCQkJCWZyZWVfcHQodm0sIHB0KTsKKwkJCQlwdCA9IG9sZDsK
IAkJCX0KIAotCQkJR0VNX0JVR19PTihwdC0+dXNlZF9wdGVzKTsKKwkJCXNwaW5fbG9jaygmcHBn
dHQtPmJhc2UucGQubG9jayk7CiAJCX0KIAotCQlwdC0+dXNlZF9wdGVzICs9IGNvdW50OworCQlh
dG9taWNfYWRkKGNvdW50LCAmcHQtPnVzZWRfcHRlcyk7CiAJfQorCXNwaW5fdW5sb2NrKCZwcGd0
dC0+YmFzZS5wZC5sb2NrKTsKIAogCWlmIChmbHVzaCkgewogCQltYXJrX3RsYnNfZGlydHkoJnBw
Z3R0LT5iYXNlKTsKQEAgLTE4MTgsNiArMTg5OCw3IEBAIHN0YXRpYyBpbnQgZ2VuNl9wcGd0dF9p
bml0X3NjcmF0Y2goc3RydWN0IGdlbjZfaHdfcHBndHQgKnBwZ3R0KQogCWdlbjZfaW5pdGlhbGl6
ZV9wdCh2bSwgdm0tPnNjcmF0Y2hfcHQpOwogCWdlbjZfZm9yX2FsbF9wZGVzKHVudXNlZCwgJnBw
Z3R0LT5iYXNlLnBkLCBwZGUpCiAJCXBwZ3R0LT5iYXNlLnBkLnBhZ2VfdGFibGVbcGRlXSA9IHZt
LT5zY3JhdGNoX3B0OworCXNwaW5fbG9ja19pbml0KCZwcGd0dC0+YmFzZS5wZC5sb2NrKTsKIAog
CXJldHVybiAwOwogfQpAQCAtMTk0Niw3ICsyMDI3LDcgQEAgc3RhdGljIHZvaWQgcGRfdm1hX3Vu
YmluZChzdHJ1Y3QgaTkxNV92bWEgKnZtYSkKIAogCS8qIEZyZWUgYWxsIG5vIGxvbmdlciB1c2Vk
IHBhZ2UgdGFibGVzICovCiAJZ2VuNl9mb3JfYWxsX3BkZXMocHQsICZwcGd0dC0+YmFzZS5wZCwg
cGRlKSB7Ci0JCWlmIChwdC0+dXNlZF9wdGVzIHx8IHB0ID09IHNjcmF0Y2hfcHQpCisJCWlmIChh
dG9taWNfcmVhZCgmcHQtPnVzZWRfcHRlcykgfHwgcHQgPT0gc2NyYXRjaF9wdCkKIAkJCWNvbnRp
bnVlOwogCiAJCWZyZWVfcHQoJnBwZ3R0LT5iYXNlLnZtLCBwdCk7CmRpZmYgLS1naXQgYS9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5
MTVfZ2VtX2d0dC5oCmluZGV4IDczYjY2MDg3NDBmMi4uMTUyYTAzNTYwYzIyIDEwMDY0NAotLS0g
YS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuaAorKysgYi9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9pOTE1X2dlbV9ndHQuaApAQCAtMjQ4LDI1ICsyNDgsMjggQEAgc3RydWN0IGk5MTVf
cGFnZV9kbWEgewogCiBzdHJ1Y3QgaTkxNV9wYWdlX3RhYmxlIHsKIAlzdHJ1Y3QgaTkxNV9wYWdl
X2RtYSBiYXNlOwotCXVuc2lnbmVkIGludCB1c2VkX3B0ZXM7CisJYXRvbWljX3QgdXNlZF9wdGVz
OwogfTsKIAogc3RydWN0IGk5MTVfcGFnZV9kaXJlY3RvcnkgewogCXN0cnVjdCBpOTE1X3BhZ2Vf
ZG1hIGJhc2U7CiAKIAlzdHJ1Y3QgaTkxNV9wYWdlX3RhYmxlICpwYWdlX3RhYmxlW0k5MTVfUERF
U107IC8qIFBERXMgKi8KLQl1bnNpZ25lZCBpbnQgdXNlZF9wZGVzOworCWF0b21pY190IHVzZWRf
cGRlczsKKwlzcGlubG9ja190IGxvY2s7CiB9OwogCiBzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9y
eV9wb2ludGVyIHsKIAlzdHJ1Y3QgaTkxNV9wYWdlX2RtYSBiYXNlOwogCXN0cnVjdCBpOTE1X3Bh
Z2VfZGlyZWN0b3J5ICoqcGFnZV9kaXJlY3Rvcnk7Ci0JdW5zaWduZWQgaW50IHVzZWRfcGRwZXM7
CisJYXRvbWljX3QgdXNlZF9wZHBlczsKKwlzcGlubG9ja190IGxvY2s7CiB9OwogCiBzdHJ1Y3Qg
aTkxNV9wbWw0IHsKIAlzdHJ1Y3QgaTkxNV9wYWdlX2RtYSBiYXNlOwogCXN0cnVjdCBpOTE1X3Bh
Z2VfZGlyZWN0b3J5X3BvaW50ZXIgKnBkcHNbR0VOOF9QTUw0RVNfUEVSX1BNTDRdOworCXNwaW5s
b2NrX3QgbG9jazsKIH07CiAKIHN0cnVjdCBpOTE1X3ZtYV9vcHMgewotLSAKMi4yMC4xCgpfX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpJbnRlbC1nZnggbWFp
bGluZyBsaXN0CkludGVsLWdmeEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5m
cmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9pbnRlbC1nZng=

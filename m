Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 4415D3AF77
	for <lists+intel-gfx@lfdr.de>; Mon, 10 Jun 2019 09:21:40 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 36F1489105;
	Mon, 10 Jun 2019 07:21:36 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 0A93288FA4
 for <intel-gfx@lists.freedesktop.org>; Mon, 10 Jun 2019 07:21:34 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 16848380-1500050 
 for multiple; Mon, 10 Jun 2019 08:21:31 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 10 Jun 2019 08:21:25 +0100
Message-Id: <20190610072126.6355-28-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190610072126.6355-1-chris@chris-wilson.co.uk>
References: <20190610072126.6355-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 27/28] drm/i915: Allow vma binding to occur
 asynchronously
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SWYgd2UgbGV0IHBhZ2VzIGJlIGFsbG9jYXRlZCBhc3luY2hyb25vdXNseSwgd2UgYWxzbyB0aGVu
IHdhbnQgdG8gcHVzaAp0aGUgYmluZGluZyBwcm9jZXNzIGludG8gYW4gYXN5bmNocm9ub3VzIHRh
c2suIE1ha2UgaXQgc28sIHV0aWxpc2luZyB0aGUKcmVjZW50IGltcHJvdmVtZW50cyB0byBmZW5j
ZSBlcnJvciB0cmFja2luZyBhbmQgc3RydWN0X211dGV4IHJlZHVjdGlvbi4KClNpZ25lZC1vZmYt
Ynk6IENocmlzIFdpbHNvbiA8Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPgotLS0KIC4uLi9ncHUv
ZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2V4ZWNidWZmZXIuYyAgICB8ICAxNiArLQogLi4uL2RybS9p
OTE1L2dlbS9zZWxmdGVzdHMvaTkxNV9nZW1fY29udGV4dC5jIHwgICA0ICsKIGRyaXZlcnMvZ3B1
L2RybS9pOTE1L2k5MTVfZ2VtX2d0dC5jICAgICAgICAgICB8ICAyOCArKy0KIGRyaXZlcnMvZ3B1
L2RybS9pOTE1L2k5MTVfdm1hLmMgICAgICAgICAgICAgICB8IDE2MCArKysrKysrKysrKysrKyst
LS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfdm1hLmggICAgICAgICAgICAgICB8ICAxNCAr
KwogZHJpdmVycy9ncHUvZHJtL2k5MTUvc2VsZnRlc3RzL2k5MTVfdm1hLmMgICAgIHwgICA0ICst
CiA2IGZpbGVzIGNoYW5nZWQsIDE4OSBpbnNlcnRpb25zKCspLCAzNyBkZWxldGlvbnMoLSkKCmRp
ZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fZXhlY2J1ZmZlci5j
IGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2V4ZWNidWZmZXIuYwppbmRleCBl
ZWI0YzZjZGIwMWQuLmNjYjA4OTQyMDgzMCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ2VtL2k5MTVfZ2VtX2V4ZWNidWZmZXIuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9n
ZW0vaTkxNV9nZW1fZXhlY2J1ZmZlci5jCkBAIC01ODAsNiArNTgwLDE1IEBAIHN0YXRpYyBpbnQg
ZWJfcmVzZXJ2ZV92bWEoY29uc3Qgc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIsCiAJdTY0IHBp
bl9mbGFnczsKIAlpbnQgZXJyOwogCisJLyoKKwkgKiBJZiB3ZSBsb2FkIHRoZSBwYWdlcyBhc3lu
Y2hyb25vdXNseSwgdGhlbiB0aGUgdXNlciAqbXVzdCoKKwkgKiBvYmV5IHRoZSByZXNlcnZhdGlv
bl9vYmplY3QgYW5kIG5vdCBieXBhc3Mgd2FpdGluZyBvbiBpdC4KKwkgKiBPbiB0aGUgcG9zaXRp
dmUgc2lkZSwgaWYgdGhlIHZtYSBpcyBub3QgeWV0IGJvdW5kIChubyBwYWdlcyEpLAorCSAqIHRo
ZW4gaXQgc2hvdWxkIG5vdCBoYXZlIGFueSBhbm5veWluZyBpbXBsaWNpdCBmZW5jZXMuCisJICov
CisJaWYgKGV4ZWNfZmxhZ3MgJiBFWEVDX09CSkVDVF9BU1lOQyAmJiAhdm1hLT5wYWdlcykKKwkJ
KnZtYS0+ZXhlY19mbGFncyAmPSB+RVhFQ19PQkpFQ1RfQVNZTkM7CisKIAlwaW5fZmxhZ3MgPSBQ
SU5fVVNFUiB8IFBJTl9OT05CTE9DSzsKIAlpZiAoZXhlY19mbGFncyAmIEVYRUNfT0JKRUNUX05F
RURTX0dUVCkKIAkJcGluX2ZsYWdzIHw9IFBJTl9HTE9CQUw7CkBAIC0xMTg3LDcgKzExOTYsNyBA
QCBzdGF0aWMgaW50IHJlbG9jX21vdmVfdG9fZ3B1KHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxLCBz
dHJ1Y3QgaTkxNV92bWEgKnZtYSkKIAlvYmotPndyaXRlX2RvbWFpbiA9IDA7CiAKIAllcnIgPSBp
OTE1X3JlcXVlc3RfYXdhaXRfb2JqZWN0KHJxLCB2bWEtPm9iaiwgdHJ1ZSk7Ci0JaWYgKGVyciA9
PSAwKQorCWlmICghZXJyKQogCQllcnIgPSBpOTE1X3ZtYV9tb3ZlX3RvX2FjdGl2ZSh2bWEsIHJx
LCBFWEVDX09CSkVDVF9XUklURSk7CiAKIAlpOTE1X3ZtYV91bmxvY2sodm1hKTsKQEAgLTEyNDUs
OCArMTI1NCw5IEBAIHN0YXRpYyBpbnQgX19yZWxvY19ncHVfYWxsb2Moc3RydWN0IGk5MTVfZXhl
Y2J1ZmZlciAqZWIsCiAJCWdvdG8gc2tpcF9yZXF1ZXN0OwogCiAJaTkxNV92bWFfbG9jayhiYXRj
aCk7Ci0JR0VNX0JVR19PTighcmVzZXJ2YXRpb25fb2JqZWN0X3Rlc3Rfc2lnbmFsZWRfcmN1KGJh
dGNoLT5yZXN2LCB0cnVlKSk7Ci0JZXJyID0gaTkxNV92bWFfbW92ZV90b19hY3RpdmUoYmF0Y2gs
IHJxLCAwKTsKKwllcnIgPSBpOTE1X3JlcXVlc3RfYXdhaXRfb2JqZWN0KHJxLCBiYXRjaC0+b2Jq
LCBmYWxzZSk7CisJaWYgKGVyciA9PSAwKQorCQllcnIgPSBpOTE1X3ZtYV9tb3ZlX3RvX2FjdGl2
ZShiYXRjaCwgcnEsIDApOwogCWk5MTVfdm1hX3VubG9jayhiYXRjaCk7CiAJaWYgKGVycikKIAkJ
Z290byBza2lwX3JlcXVlc3Q7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0v
c2VsZnRlc3RzL2k5MTVfZ2VtX2NvbnRleHQuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9z
ZWxmdGVzdHMvaTkxNV9nZW1fY29udGV4dC5jCmluZGV4IDc0YjBlNTg3MWM0Yi4uZThhNDM4ZDBi
OGEyIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vc2VsZnRlc3RzL2k5MTVf
Z2VtX2NvbnRleHQuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vc2VsZnRlc3RzL2k5
MTVfZ2VtX2NvbnRleHQuYwpAQCAtMjk1LDYgKzI5NSwxMCBAQCBzdGF0aWMgaW50IGdwdV9maWxs
KHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmosCiAJCWdvdG8gZXJyX2JhdGNoOwogCX0K
IAorCWVyciA9IGk5MTVfcmVxdWVzdF9hd2FpdF9vYmplY3QocnEsIGJhdGNoLT5vYmosIGZhbHNl
KTsKKwlpZiAoZXJyKQorCQlnb3RvIGVycl9yZXF1ZXN0OworCiAJZmxhZ3MgPSAwOwogCWlmIChJ
TlRFTF9HRU4odm0tPmk5MTUpIDw9IDUpCiAJCWZsYWdzIHw9IEk5MTVfRElTUEFUQ0hfU0VDVVJF
OwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW1fZ3R0LmMgYi9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuYwppbmRleCAxYTE1N2JkNDNjMmMuLmJmY2E4
YTRhODhlMiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW1fZ3R0LmMK
KysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW1fZ3R0LmMKQEAgLTMwLDYgKzMwLDcg
QEAKICNpbmNsdWRlIDxsaW51eC9yYW5kb20uaD4KICNpbmNsdWRlIDxsaW51eC9zZXFfZmlsZS5o
PgogI2luY2x1ZGUgPGxpbnV4L3N0b3BfbWFjaGluZS5oPgorI2luY2x1ZGUgPGxpbnV4L3dvcmtx
dWV1ZS5oPgogCiAjaW5jbHVkZSA8YXNtL3NldF9tZW1vcnkuaD4KIApAQCAtMTM5LDE0ICsxNDAs
MTQgQEAgc3RhdGljIGlubGluZSB2b2lkIGk5MTVfZ2d0dF9pbnZhbGlkYXRlKHN0cnVjdCBkcm1f
aTkxNV9wcml2YXRlICppOTE1KQogCiBzdGF0aWMgaW50IHBwZ3R0X2JpbmRfdm1hKHN0cnVjdCBp
OTE1X3ZtYSAqdm1hLAogCQkJICBlbnVtIGk5MTVfY2FjaGVfbGV2ZWwgY2FjaGVfbGV2ZWwsCi0J
CQkgIHUzMiB1bnVzZWQpCisJCQkgIHUzMiBmbGFncykKIHsKKwlzdHJ1Y3QgaTkxNV9hZGRyZXNz
X3NwYWNlICp2bSA9IHZtYS0+dm07CiAJdTMyIHB0ZV9mbGFnczsKIAlpbnQgZXJyOwogCi0JaWYg
KCEodm1hLT5mbGFncyAmIEk5MTVfVk1BX0xPQ0FMX0JJTkQpKSB7Ci0JCWVyciA9IHZtYS0+dm0t
PmFsbG9jYXRlX3ZhX3JhbmdlKHZtYS0+dm0sCi0JCQkJCQkgdm1hLT5ub2RlLnN0YXJ0LCB2bWEt
PnNpemUpOworCWlmIChmbGFncyAmIEk5MTVfVk1BX0FMTE9DX0JJTkQpIHsKKwkJZXJyID0gdm0t
PmFsbG9jYXRlX3ZhX3JhbmdlKHZtLCB2bWEtPm5vZGUuc3RhcnQsIHZtYS0+c2l6ZSk7CiAJCWlm
IChlcnIpCiAJCQlyZXR1cm4gZXJyOwogCX0KQEAgLTE1NiwyMCArMTU3LDI2IEBAIHN0YXRpYyBp
bnQgcHBndHRfYmluZF92bWEoc3RydWN0IGk5MTVfdm1hICp2bWEsCiAJaWYgKGk5MTVfZ2VtX29i
amVjdF9pc19yZWFkb25seSh2bWEtPm9iaikpCiAJCXB0ZV9mbGFncyB8PSBQVEVfUkVBRF9PTkxZ
OwogCi0Jdm1hLT52bS0+aW5zZXJ0X2VudHJpZXModm1hLT52bSwgdm1hLCBjYWNoZV9sZXZlbCwg
cHRlX2ZsYWdzKTsKKwl2bS0+aW5zZXJ0X2VudHJpZXModm0sIHZtYSwgY2FjaGVfbGV2ZWwsIHB0
ZV9mbGFncyk7CiAKIAlyZXR1cm4gMDsKIH0KIAogc3RhdGljIHZvaWQgcHBndHRfdW5iaW5kX3Zt
YShzdHJ1Y3QgaTkxNV92bWEgKnZtYSkKIHsKLQl2bWEtPnZtLT5jbGVhcl9yYW5nZSh2bWEtPnZt
LCB2bWEtPm5vZGUuc3RhcnQsIHZtYS0+c2l6ZSk7CisJc3RydWN0IGk5MTVfYWRkcmVzc19zcGFj
ZSAqdm0gPSB2bWEtPnZtOworCisJdm0tPmNsZWFyX3JhbmdlKHZtLCB2bWEtPm5vZGUuc3RhcnQs
IHZtYS0+c2l6ZSk7CiB9CiAKIHN0YXRpYyBpbnQgcHBndHRfc2V0X3BhZ2VzKHN0cnVjdCBpOTE1
X3ZtYSAqdm1hKQogewogCUdFTV9CVUdfT04odm1hLT5wYWdlcyk7CiAKKwl3YWl0X2Zvcl9jb21w
bGV0aW9uKCZ2bWEtPm9iai0+bW0uY29tcGxldGlvbik7CisJaWYgKElTX0VSUih2bWEtPm9iai0+
bW0ucGFnZXMpKQorCQlyZXR1cm4gUFRSX0VSUih2bWEtPm9iai0+bW0ucGFnZXMpOworCiAJdm1h
LT5wYWdlcyA9IHZtYS0+b2JqLT5tbS5wYWdlczsKIAogCXZtYS0+cGFnZV9zaXplcyA9IHZtYS0+
b2JqLT5tbS5wYWdlX3NpemVzOwpAQCAtMjcwNyw3ICsyNzE0LDcgQEAgc3RhdGljIGludCBhbGlh
c2luZ19ndHRfYmluZF92bWEoc3RydWN0IGk5MTVfdm1hICp2bWEsCiAJaWYgKGZsYWdzICYgSTkx
NV9WTUFfTE9DQUxfQklORCkgewogCQlzdHJ1Y3QgaTkxNV9wcGd0dCAqYXBwZ3R0ID0gaTkxNS0+
bW0uYWxpYXNpbmdfcHBndHQ7CiAKLQkJaWYgKCEodm1hLT5mbGFncyAmIEk5MTVfVk1BX0xPQ0FM
X0JJTkQpKSB7CisJCWlmIChmbGFncyAmIEk5MTVfVk1BX0FMTE9DX0JJTkQpIHsKIAkJCXJldCA9
IGFwcGd0dC0+dm0uYWxsb2NhdGVfdmFfcmFuZ2UoJmFwcGd0dC0+dm0sCiAJCQkJCQkJICAgdm1h
LT5ub2RlLnN0YXJ0LAogCQkJCQkJCSAgIHZtYS0+c2l6ZSk7CkBAIC0zODk2LDEzICszOTAzLDE4
IEBAIGk5MTVfZ2V0X2dndHRfdm1hX3BhZ2VzKHN0cnVjdCBpOTE1X3ZtYSAqdm1hKQogewogCWlu
dCByZXQ7CiAKLQkvKiBUaGUgdm1hLT5wYWdlcyBhcmUgb25seSB2YWxpZCB3aXRoaW4gdGhlIGxp
ZmVzcGFuIG9mIHRoZSBib3Jyb3dlZAorCS8qCisJICogVGhlIHZtYS0+cGFnZXMgYXJlIG9ubHkg
dmFsaWQgd2l0aGluIHRoZSBsaWZlc3BhbiBvZiB0aGUgYm9ycm93ZWQKIAkgKiBvYmotPm1tLnBh
Z2VzLiBXaGVuIHRoZSBvYmotPm1tLnBhZ2VzIHNnX3RhYmxlIGlzIHJlZ2VuZXJhdGVkLCBzbwog
CSAqIG11c3QgYmUgdGhlIHZtYS0+cGFnZXMuIEEgc2ltcGxlIHJ1bGUgaXMgdGhhdCB2bWEtPnBh
Z2VzIG11c3Qgb25seQogCSAqIGJlIGFjY2Vzc2VkIHdoZW4gdGhlIG9iai0+bW0ucGFnZXMgYXJl
IHBpbm5lZC4KIAkgKi8KIAlHRU1fQlVHX09OKCFpOTE1X2dlbV9vYmplY3RfaGFzX3Bpbm5lZF9w
YWdlcyh2bWEtPm9iaikpOwogCisJd2FpdF9mb3JfY29tcGxldGlvbigmdm1hLT5vYmotPm1tLmNv
bXBsZXRpb24pOworCWlmIChJU19FUlIodm1hLT5vYmotPm1tLnBhZ2VzKSkKKwkJcmV0dXJuIFBU
Ul9FUlIodm1hLT5vYmotPm1tLnBhZ2VzKTsKKwogCXN3aXRjaCAodm1hLT5nZ3R0X3ZpZXcudHlw
ZSkgewogCWRlZmF1bHQ6CiAJCUdFTV9CVUdfT04odm1hLT5nZ3R0X3ZpZXcudHlwZSk7CmRpZmYg
LS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3ZtYS5jIGIvZHJpdmVycy9ncHUvZHJt
L2k5MTUvaTkxNV92bWEuYwppbmRleCAyZDdhZjc2M2I5MjguLjg5MDc5NjMwZDBhZiAxMDA2NDQK
LS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV92bWEuYworKysgYi9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9pOTE1X3ZtYS5jCkBAIC05Miw2ICs5Miw3MCBAQCBzdGF0aWMgdm9pZCBfX2k5MTVf
dm1hX3JldGlyZShzdHJ1Y3QgaTkxNV9hY3RpdmUgKnJlZikKIAlpOTE1X3ZtYV9wdXQodm1hKTsK
IH0KIAorc3RhdGljIGludCBfX3ZtYV9iaW5kKHN0cnVjdCBpOTE1X3ZtYSAqdm1hLAorCQkgICAg
ICB1bnNpZ25lZCBpbnQgY2FjaGVfbGV2ZWwsCisJCSAgICAgIHVuc2lnbmVkIGludCBmbGFncykK
K3sKKwlpbnQgZXJyOworCisJaWYgKCF2bWEtPnBhZ2VzKSB7CisJCWVyciA9IHZtYS0+b3BzLT5z
ZXRfcGFnZXModm1hKTsKKwkJaWYgKGVycikKKwkJCXJldHVybiBlcnI7CisJfQorCisJcmV0dXJu
IHZtYS0+b3BzLT5iaW5kX3ZtYSh2bWEsIGNhY2hlX2xldmVsLCBmbGFncyk7Cit9CisKK3N0YXRp
YyB2b2lkIGRvX2FzeW5jX2JpbmQoc3RydWN0IHdvcmtfc3RydWN0ICp3b3JrKQoreworCXN0cnVj
dCBpOTE1X3ZtYSAqdm1hID0gY29udGFpbmVyX29mKHdvcmssIHR5cGVvZigqdm1hKSwgYXN5bmMu
d29yayk7CisJc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0gPSB2bWEtPnZtOworCWludCBl
cnI7CisKKwlpZiAodm1hLT5hc3luYy5kbWEtPmVycm9yKQorCQlnb3RvIG91dDsKKworCWVyciA9
IF9fdm1hX2JpbmQodm1hLCB2bWEtPmFzeW5jLmNhY2hlX2xldmVsLCB2bWEtPmFzeW5jLmZsYWdz
KTsKKwlpZiAoZXJyKQorCQlkbWFfZmVuY2Vfc2V0X2Vycm9yKHZtYS0+YXN5bmMuZG1hLCBlcnIp
OworCitvdXQ6CisJZG1hX2ZlbmNlX3NpZ25hbCh2bWEtPmFzeW5jLmRtYSk7CisKKwlpOTE1X3Zt
YV91bnBpbih2bWEpOworCWk5MTVfdm1hX3B1dCh2bWEpOworCWk5MTVfdm1fcHV0KHZtKTsKK30K
Kworc3RhdGljIHZvaWQgX19xdWV1ZV9hc3luY19iaW5kKHN0cnVjdCBkbWFfZmVuY2UgKmYsIHN0
cnVjdCBkbWFfZmVuY2VfY2IgKmNiKQoreworCXN0cnVjdCBpOTE1X3ZtYSAqdm1hID0gY29udGFp
bmVyX29mKGNiLCB0eXBlb2YoKnZtYSksIGFzeW5jLmNiKTsKKworCWlmIChmLT5lcnJvcikKKwkJ
ZG1hX2ZlbmNlX3NldF9lcnJvcih2bWEtPmFzeW5jLmRtYSwgZi0+ZXJyb3IpOworCisJSU5JVF9X
T1JLKCZ2bWEtPmFzeW5jLndvcmssIGRvX2FzeW5jX2JpbmQpOworCXF1ZXVlX3dvcmsoc3lzdGVt
X3VuYm91bmRfd3EsICZ2bWEtPmFzeW5jLndvcmspOworfQorCitzdGF0aWMgY29uc3QgY2hhciAq
YXN5bmNfYmluZF9kcml2ZXJfbmFtZShzdHJ1Y3QgZG1hX2ZlbmNlICpmZW5jZSkKK3sKKwlyZXR1
cm4gRFJJVkVSX05BTUU7Cit9CisKK3N0YXRpYyBjb25zdCBjaGFyICphc3luY19iaW5kX3RpbWVs
aW5lX25hbWUoc3RydWN0IGRtYV9mZW5jZSAqZmVuY2UpCit7CisJcmV0dXJuICJiaW5kIjsKK30K
Kworc3RhdGljIGNvbnN0IHN0cnVjdCBkbWFfZmVuY2Vfb3BzIGFzeW5jX2JpbmRfb3BzID0gewor
CS5nZXRfZHJpdmVyX25hbWUgPSBhc3luY19iaW5kX2RyaXZlcl9uYW1lLAorCS5nZXRfdGltZWxp
bmVfbmFtZSA9IGFzeW5jX2JpbmRfdGltZWxpbmVfbmFtZSwKK307CisKK3N0YXRpYyBERUZJTkVf
U1BJTkxPQ0soYXN5bmNfbG9jayk7CisKIHN0YXRpYyBzdHJ1Y3QgaTkxNV92bWEgKgogdm1hX2Ny
ZWF0ZShzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqLAogCSAgIHN0cnVjdCBpOTE1X2Fk
ZHJlc3Nfc3BhY2UgKnZtLApAQCAtMjc2LDYgKzM0MCw1NCBAQCBpOTE1X3ZtYV9pbnN0YW5jZShz
dHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqLAogCXJldHVybiB2bWE7CiB9CiAKK3N0YXRp
YyBpbnQgcXVldWVfYXN5bmNfYmluZChzdHJ1Y3QgaTkxNV92bWEgKnZtYSwKKwkJCSAgICBlbnVt
IGk5MTVfY2FjaGVfbGV2ZWwgY2FjaGVfbGV2ZWwsCisJCQkgICAgdTMyIGZsYWdzKQoreworCWJv
b2wgcmVhZHkgPSB0cnVlOworCisJLyogV2UgYXJlIG5vdCBhbGxvd2VkIHRvIHNocmluayBpbnNp
ZGUgdm0tPm11dGV4ISAqLworCXZtYS0+YXN5bmMuZG1hID0ga21hbGxvYyhzaXplb2YoKnZtYS0+
YXN5bmMuZG1hKSwKKwkJCQkgR0ZQX05PV0FJVCB8IF9fR0ZQX05PV0FSTik7CisJaWYgKCF2bWEt
PmFzeW5jLmRtYSkKKwkJcmV0dXJuIC1FTk9NRU07CisKKwlkbWFfZmVuY2VfaW5pdCh2bWEtPmFz
eW5jLmRtYSwKKwkJICAgICAgICZhc3luY19iaW5kX29wcywKKwkJICAgICAgICZhc3luY19sb2Nr
LAorCQkgICAgICAgdm1hLT52bS0+aTkxNS0+bW0udW5vcmRlcmVkX3RpbWVsaW5lLAorCQkgICAg
ICAgMCk7CisKKwkvKiBYWFggZmluZCBhbmQgYXZvaWQgYWxsb2NhdGlvbnMgdW5kZXIgcmVzZXJ2
YXRpb25fb2JqZWN0IGxvY2tzICovCisJaWYgKCFpOTE1X3ZtYV90cnlsb2NrKHZtYSkpIHsKKwkJ
a2ZyZWUoZmV0Y2hfYW5kX3plcm8oJnZtYS0+YXN5bmMuZG1hKSk7CisJCXJldHVybiAtRUFHQUlO
OworCX0KKworCWlmIChyY3VfYWNjZXNzX3BvaW50ZXIodm1hLT5yZXN2LT5mZW5jZV9leGNsKSkg
eyAvKiBhc3luYyBwYWdlcyAqLworCQlzdHJ1Y3QgZG1hX2ZlbmNlICpmID0gcmVzZXJ2YXRpb25f
b2JqZWN0X2dldF9leGNsKHZtYS0+cmVzdik7CisKKwkJaWYgKCFkbWFfZmVuY2VfYWRkX2NhbGxi
YWNrKGYsCisJCQkJCSAgICAmdm1hLT5hc3luYy5jYiwKKwkJCQkJICAgIF9fcXVldWVfYXN5bmNf
YmluZCkpCisJCQlyZWFkeSA9IGZhbHNlOworCX0KKwlyZXNlcnZhdGlvbl9vYmplY3RfYWRkX2V4
Y2xfZmVuY2Uodm1hLT5yZXN2LCB2bWEtPmFzeW5jLmRtYSk7CisJaTkxNV92bWFfdW5sb2NrKHZt
YSk7CisKKwlpOTE1X3ZtX2dldCh2bWEtPnZtKTsKKwlpOTE1X3ZtYV9nZXQodm1hKTsKKwlfX2k5
MTVfdm1hX3Bpbih2bWEpOyAvKiBhdm9pZCBiZWluZyBzaHJ1bmsgKi8KKworCXZtYS0+YXN5bmMu
Y2FjaGVfbGV2ZWwgPSBjYWNoZV9sZXZlbDsKKwl2bWEtPmFzeW5jLmZsYWdzID0gZmxhZ3M7CisK
KwlpZiAocmVhZHkpCisJCV9fcXVldWVfYXN5bmNfYmluZCh2bWEtPmFzeW5jLmRtYSwgJnZtYS0+
YXN5bmMuY2IpOworCisJcmV0dXJuIDA7Cit9CisKIC8qKgogICogaTkxNV92bWFfYmluZCAtIFNl
dHMgdXAgUFRFcyBmb3IgYW4gVk1BIGluIGl0J3MgY29ycmVzcG9uZGluZyBhZGRyZXNzIHNwYWNl
LgogICogQHZtYTogVk1BIHRvIG1hcApAQCAtMjkzLDE3ICs0MDUsMTIgQEAgaW50IGk5MTVfdm1h
X2JpbmQoc3RydWN0IGk5MTVfdm1hICp2bWEsIGVudW0gaTkxNV9jYWNoZV9sZXZlbCBjYWNoZV9s
ZXZlbCwKIAl1MzIgdm1hX2ZsYWdzOwogCWludCByZXQ7CiAKKwlHRU1fQlVHX09OKCFmbGFncyk7
CiAJR0VNX0JVR19PTighZHJtX21tX25vZGVfYWxsb2NhdGVkKCZ2bWEtPm5vZGUpKTsKIAlHRU1f
QlVHX09OKHZtYS0+c2l6ZSA+IHZtYS0+bm9kZS5zaXplKTsKLQotCWlmIChHRU1fREVCVUdfV0FS
Tl9PTihyYW5nZV9vdmVyZmxvd3Modm1hLT5ub2RlLnN0YXJ0LAotCQkJCQkgICAgICB2bWEtPm5v
ZGUuc2l6ZSwKLQkJCQkJICAgICAgdm1hLT52bS0+dG90YWwpKSkKLQkJcmV0dXJuIC1FTk9ERVY7
Ci0KLQlpZiAoR0VNX0RFQlVHX1dBUk5fT04oIWZsYWdzKSkKLQkJcmV0dXJuIC1FSU5WQUw7Ci0K
KwlHRU1fQlVHX09OKHJhbmdlX292ZXJmbG93cyh2bWEtPm5vZGUuc3RhcnQsCisJCQkJICAgdm1h
LT5ub2RlLnNpemUsCisJCQkJICAgdm1hLT52bS0+dG90YWwpKTsKIAliaW5kX2ZsYWdzID0gMDsK
IAlpZiAoZmxhZ3MgJiBQSU5fR0xPQkFMKQogCQliaW5kX2ZsYWdzIHw9IEk5MTVfVk1BX0dMT0JB
TF9CSU5EOwpAQCAtMzE4LDE0ICs0MjUsMTggQEAgaW50IGk5MTVfdm1hX2JpbmQoc3RydWN0IGk5
MTVfdm1hICp2bWEsIGVudW0gaTkxNV9jYWNoZV9sZXZlbCBjYWNoZV9sZXZlbCwKIAlpZiAoYmlu
ZF9mbGFncyA9PSAwKQogCQlyZXR1cm4gMDsKIAotCUdFTV9CVUdfT04oIXZtYS0+cGFnZXMpOwor
CWlmICgoYmluZF9mbGFncyAmIH52bWFfZmxhZ3MpICYgSTkxNV9WTUFfTE9DQUxfQklORCkKKwkJ
YmluZF9mbGFncyB8PSBJOTE1X1ZNQV9BTExPQ19CSU5EOwogCiAJdHJhY2VfaTkxNV92bWFfYmlu
ZCh2bWEsIGJpbmRfZmxhZ3MpOwotCXJldCA9IHZtYS0+b3BzLT5iaW5kX3ZtYSh2bWEsIGNhY2hl
X2xldmVsLCBiaW5kX2ZsYWdzKTsKKwlpZiAoYmluZF9mbGFncyAmIEk5MTVfVk1BX0FMTE9DX0JJ
TkQpCisJCXJldCA9IHF1ZXVlX2FzeW5jX2JpbmQodm1hLCBjYWNoZV9sZXZlbCwgYmluZF9mbGFn
cyk7CisJZWxzZQorCQlyZXQgPSBfX3ZtYV9iaW5kKHZtYSwgY2FjaGVfbGV2ZWwsIGJpbmRfZmxh
Z3MpOwogCWlmIChyZXQpCiAJCXJldHVybiByZXQ7CiAKLQl2bWEtPmZsYWdzIHw9IGJpbmRfZmxh
Z3M7CisJdm1hLT5mbGFncyB8PSBiaW5kX2ZsYWdzICYgfkk5MTVfVk1BX0FMTE9DX0JJTkQ7CiAJ
cmV0dXJuIDA7CiB9CiAKQEAgLTU2OSw3ICs2ODAsNyBAQCBpOTE1X3ZtYV9pbnNlcnQoc3RydWN0
IGk5MTVfdm1hICp2bWEsIHU2NCBzaXplLCB1NjQgYWxpZ25tZW50LCB1NjQgZmxhZ3MpCiAJfQog
CiAJaWYgKHZtYS0+b2JqKSB7Ci0JCXJldCA9IGk5MTVfZ2VtX29iamVjdF9waW5fcGFnZXModm1h
LT5vYmopOworCQlyZXQgPSBpOTE1X2dlbV9vYmplY3RfcGluX3BhZ2VzX2FzeW5jKHZtYS0+b2Jq
KTsKIAkJaWYgKHJldCkKIAkJCXJldHVybiByZXQ7CiAKQEAgLTU3OCwyNSArNjg5LDE5IEBAIGk5
MTVfdm1hX2luc2VydChzdHJ1Y3QgaTkxNV92bWEgKnZtYSwgdTY0IHNpemUsIHU2NCBhbGlnbm1l
bnQsIHU2NCBmbGFncykKIAkJY2FjaGVfbGV2ZWwgPSAwOwogCX0KIAotCUdFTV9CVUdfT04odm1h
LT5wYWdlcyk7Ci0KLQlyZXQgPSB2bWEtPm9wcy0+c2V0X3BhZ2VzKHZtYSk7Ci0JaWYgKHJldCkK
LQkJZ290byBlcnJfdW5waW47Ci0KIAlpZiAoZmxhZ3MgJiBQSU5fT0ZGU0VUX0ZJWEVEKSB7CiAJ
CXU2NCBvZmZzZXQgPSBmbGFncyAmIFBJTl9PRkZTRVRfTUFTSzsKIAkJaWYgKCFJU19BTElHTkVE
KG9mZnNldCwgYWxpZ25tZW50KSB8fAogCQkgICAgcmFuZ2Vfb3ZlcmZsb3dzKG9mZnNldCwgc2l6
ZSwgZW5kKSkgewogCQkJcmV0ID0gLUVJTlZBTDsKLQkJCWdvdG8gZXJyX2NsZWFyOworCQkJZ290
byBlcnJfdW5waW47CiAJCX0KIAogCQlyZXQgPSBpOTE1X2dlbV9ndHRfcmVzZXJ2ZSh2bWEtPnZt
LCAmdm1hLT5ub2RlLAogCQkJCQkgICBzaXplLCBvZmZzZXQsIGNhY2hlX2xldmVsLAogCQkJCQkg
ICBmbGFncyk7CiAJCWlmIChyZXQpCi0JCQlnb3RvIGVycl9jbGVhcjsKKwkJCWdvdG8gZXJyX3Vu
cGluOwogCX0gZWxzZSB7CiAJCS8qCiAJCSAqIFdlIG9ubHkgc3VwcG9ydCBodWdlIGd0dCBwYWdl
cyB0aHJvdWdoIHRoZSA0OGIgUFBHVFQsCkBAIC02MzUsNyArNzQwLDcgQEAgaTkxNV92bWFfaW5z
ZXJ0KHN0cnVjdCBpOTE1X3ZtYSAqdm1hLCB1NjQgc2l6ZSwgdTY0IGFsaWdubWVudCwgdTY0IGZs
YWdzKQogCQkJCQkgIHNpemUsIGFsaWdubWVudCwgY2FjaGVfbGV2ZWwsCiAJCQkJCSAgc3RhcnQs
IGVuZCwgZmxhZ3MpOwogCQlpZiAocmV0KQotCQkJZ290byBlcnJfY2xlYXI7CisJCQlnb3RvIGVy
cl91bnBpbjsKIAogCQlHRU1fQlVHX09OKHZtYS0+bm9kZS5zdGFydCA8IHN0YXJ0KTsKIAkJR0VN
X0JVR19PTih2bWEtPm5vZGUuc3RhcnQgKyB2bWEtPm5vZGUuc2l6ZSA+IGVuZCk7CkBAIC02NTQs
OCArNzU5LDYgQEAgaTkxNV92bWFfaW5zZXJ0KHN0cnVjdCBpOTE1X3ZtYSAqdm1hLCB1NjQgc2l6
ZSwgdTY0IGFsaWdubWVudCwgdTY0IGZsYWdzKQogCiAJcmV0dXJuIDA7CiAKLWVycl9jbGVhcjoK
LQl2bWEtPm9wcy0+Y2xlYXJfcGFnZXModm1hKTsKIGVycl91bnBpbjoKIAlpZiAodm1hLT5vYmop
CiAJCWk5MTVfZ2VtX29iamVjdF91bnBpbl9wYWdlcyh2bWEtPm9iaik7CkBAIC03OTAsNyArODkz
LDcgQEAgc3RhdGljIHZvaWQgX19pOTE1X3ZtYV9kZXN0cm95KHN0cnVjdCBpOTE1X3ZtYSAqdm1h
KQogCiAJCXNwaW5fbG9jaygmb2JqLT52bWEubG9jayk7CiAJCWxpc3RfZGVsKCZ2bWEtPm9ial9s
aW5rKTsKLQkJcmJfZXJhc2UoJnZtYS0+b2JqX25vZGUsICZ2bWEtPm9iai0+dm1hLnRyZWUpOwor
CQlyYl9lcmFzZSgmdm1hLT5vYmpfbm9kZSwgJm9iai0+dm1hLnRyZWUpOwogCQlzcGluX3VubG9j
aygmb2JqLT52bWEubG9jayk7CiAJfQogCkBAIC05MzAsNiArMTAzMywxMSBAQCBpbnQgaTkxNV92
bWFfdW5iaW5kKHN0cnVjdCBpOTE1X3ZtYSAqdm1hKQogCiAJbG9ja2RlcF9hc3NlcnRfaGVsZCgm
dm1hLT52bS0+aTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CiAKKwlpZiAodm1hLT5hc3luYy5kbWEg
JiYKKwkgICAgZG1hX2ZlbmNlX3dhaXRfdGltZW91dCh2bWEtPmFzeW5jLmRtYSwgdHJ1ZSwKKwkJ
CQkgICBNQVhfU0NIRURVTEVfVElNRU9VVCkgPCAwKQorCQlyZXR1cm4gLUVJTlRSOworCiAJcmV0
ID0gaTkxNV9hY3RpdmVfd2FpdCgmdm1hLT5hY3RpdmUpOwogCWlmIChyZXQpCiAJCXJldHVybiBy
ZXQ7CkBAIC05NzUsNiArMTA4Myw4IEBAIGludCBpOTE1X3ZtYV91bmJpbmQoc3RydWN0IGk5MTVf
dm1hICp2bWEpCiAJfQogCXZtYS0+ZmxhZ3MgJj0gfihJOTE1X1ZNQV9HTE9CQUxfQklORCB8IEk5
MTVfVk1BX0xPQ0FMX0JJTkQpOwogCisJZG1hX2ZlbmNlX3B1dChmZXRjaF9hbmRfemVybygmdm1h
LT5hc3luYy5kbWEpKTsKKwogCWk5MTVfdm1hX3JlbW92ZSh2bWEpOwogCiAJcmV0dXJuIDA7CmRp
ZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3ZtYS5oIGIvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvaTkxNV92bWEuaAppbmRleCA3MTA4OGZmNGFkNTkuLjY3ZTQzZjVkMDFmNiAxMDA2
NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV92bWEuaAorKysgYi9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9pOTE1X3ZtYS5oCkBAIC0xMDMsNiArMTAzLDcgQEAgc3RydWN0IGk5MTVfdm1h
IHsKICNkZWZpbmUgSTkxNV9WTUFfR0xPQkFMX0JJTkQJQklUKDkpCiAjZGVmaW5lIEk5MTVfVk1B
X0xPQ0FMX0JJTkQJQklUKDEwKQogI2RlZmluZSBJOTE1X1ZNQV9CSU5EX01BU0sgKEk5MTVfVk1B
X0dMT0JBTF9CSU5EIHwgSTkxNV9WTUFfTE9DQUxfQklORCB8IEk5MTVfVk1BX1BJTl9PVkVSRkxP
VykKKyNkZWZpbmUgSTkxNV9WTUFfQUxMT0NfQklORAlJOTE1X1ZNQV9QSU5fT1ZFUkZMT1cgLyog
bm90IHN0b3JlZCAqLwogCiAjZGVmaW5lIEk5MTVfVk1BX0dHVFQJCUJJVCgxMSkKICNkZWZpbmUg
STkxNV9WTUFfQ0FOX0ZFTkNFCUJJVCgxMikKQEAgLTE0Myw2ICsxNDQsMTQgQEAgc3RydWN0IGk5
MTVfdm1hIHsKIAl1bnNpZ25lZCBpbnQgKmV4ZWNfZmxhZ3M7CiAJc3RydWN0IGhsaXN0X25vZGUg
ZXhlY19ub2RlOwogCXUzMiBleGVjX2hhbmRsZTsKKworCXN0cnVjdCBpOTE1X3ZtYV9hc3luY19i
aW5kIHsKKwkJc3RydWN0IGRtYV9mZW5jZSAqZG1hOworCQlzdHJ1Y3QgZG1hX2ZlbmNlX2NiIGNi
OworCQlzdHJ1Y3Qgd29ya19zdHJ1Y3Qgd29yazsKKwkJdW5zaWduZWQgaW50IGNhY2hlX2xldmVs
OworCQl1bnNpZ25lZCBpbnQgZmxhZ3M7CisJfSBhc3luYzsKIH07CiAKIHN0cnVjdCBpOTE1X3Zt
YSAqCkBAIC0zMDUsNiArMzE0LDExIEBAIHN0YXRpYyBpbmxpbmUgdm9pZCBpOTE1X3ZtYV9sb2Nr
KHN0cnVjdCBpOTE1X3ZtYSAqdm1hKQogCXJlc2VydmF0aW9uX29iamVjdF9sb2NrKHZtYS0+cmVz
diwgTlVMTCk7CiB9CiAKK3N0YXRpYyBpbmxpbmUgYm9vbCBpOTE1X3ZtYV90cnlsb2NrKHN0cnVj
dCBpOTE1X3ZtYSAqdm1hKQoreworCXJldHVybiByZXNlcnZhdGlvbl9vYmplY3RfdHJ5bG9jayh2
bWEtPnJlc3YpOworfQorCiBzdGF0aWMgaW5saW5lIHZvaWQgaTkxNV92bWFfdW5sb2NrKHN0cnVj
dCBpOTE1X3ZtYSAqdm1hKQogewogCXJlc2VydmF0aW9uX29iamVjdF91bmxvY2sodm1hLT5yZXN2
KTsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L3NlbGZ0ZXN0cy9pOTE1X3ZtYS5j
IGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvc2VsZnRlc3RzL2k5MTVfdm1hLmMKaW5kZXggYTE2NmQ5
NDA1YTk0Li42MTVhYzQ4NWM3MzEgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L3Nl
bGZ0ZXN0cy9pOTE1X3ZtYS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L3NlbGZ0ZXN0cy9p
OTE1X3ZtYS5jCkBAIC0yMDQsOCArMjA0LDEwIEBAIHN0YXRpYyBpbnQgaWd0X3ZtYV9jcmVhdGUo
dm9pZCAqYXJnKQogCQltb2NrX2NvbnRleHRfY2xvc2UoY3R4KTsKIAl9CiAKLQlsaXN0X2Zvcl9l
YWNoX2VudHJ5X3NhZmUob2JqLCBvbiwgJm9iamVjdHMsIHN0X2xpbmspCisJbGlzdF9mb3JfZWFj
aF9lbnRyeV9zYWZlKG9iaiwgb24sICZvYmplY3RzLCBzdF9saW5rKSB7CisJCWk5MTVfZ2VtX29i
amVjdF93YWl0KG9iaiwgSTkxNV9XQUlUX0FMTCwgTUFYX1NDSEVEVUxFX1RJTUVPVVQpOwogCQlp
OTE1X2dlbV9vYmplY3RfcHV0KG9iaik7CisJfQogCXJldHVybiBlcnI7CiB9CiAKLS0gCjIuMjAu
MQoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwt
Z2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8v
bGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

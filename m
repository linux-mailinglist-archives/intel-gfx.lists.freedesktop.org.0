Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 0594E115DA8
	for <lists+intel-gfx@lfdr.de>; Sat,  7 Dec 2019 18:01:48 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 646F36E1F5;
	Sat,  7 Dec 2019 17:01:46 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 22A816E1F3
 for <intel-gfx@lists.freedesktop.org>; Sat,  7 Dec 2019 17:01:43 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 19496910-1500050 
 for multiple; Sat, 07 Dec 2019 17:01:12 +0000
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Sat,  7 Dec 2019 17:01:08 +0000
Message-Id: <20191207170110.2200142-6-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.24.0
In-Reply-To: <20191207170110.2200142-1-chris@chris-wilson.co.uk>
References: <20191207170110.2200142-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 6/8] drm/i915: Prepare gen7 cmdparser for async
 execution
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

VGhlIGdlbjcgY21kcGFyc2VyIGlzIHByaW1hcmlseSBhIHByb21vdGlvbi1iYXNlZCBzeXN0ZW0g
dG8gYWxsb3cgYWNjZXNzCnRvIGFkZGl0aW9uYWwgcmVnaXN0ZXJzIGJleW9uZCB0aGUgSFcgdmFs
aWRhdGlvbiwgYW5kIGFsbG93cyBmYWxsYmFjayB0bwpub3JtYWwgZXhlY3V0aW9uIG9mIHRoZSB1
c2VyIGJhdGNoIGJ1ZmZlciBpZiB2YWxpZCBhbmQgcmVxdWlyZXMKY2hhaW5pbmcuIEluIHRoZSBu
ZXh0IHBhdGNoLCB3ZSB3aWxsIGRvIHRoZSBjbWRwYXJzZXIgdmFsaWRhdGlvbiBpbiB0aGUKcGlw
ZWxpbmUgYXN5bmNocm9ub3VzbHkgYW5kIHNvIGF0IHRoZSBwb2ludCBvZiByZXF1ZXN0IGNvbnN0
cnVjdGlvbiB3ZQp3aWxsIG5vdCBrbm93IGlmIHdlIHdhbnQgdG8gZXhlY3V0ZSB0aGUgcHJpdmls
ZWdlZCBhbmQgdmFsaWRhdGVkIGJhdGNoLApvciB0aGUgb3JpZ2luYWwgdXNlciBiYXRjaC4gVGhl
IHNvbHV0aW9uIGVtcGxveWVkIGhlcmUgaXMgdG8gZXhlY3V0ZQpib3RoIGJhdGNoZXMsIG9uZSB3
aXRoIHJhaXNlZCBwcml2aWxlZ2VzIGFuZCBvbmUgYXMgbm9ybWFsLiBUaGlzIGlzCmJlY2F1c2Ug
dGhlIGdlbjcgTUlfQkFUQ0hfQlVGRkVSX1NUQVJUIGNvbW1hbmQgY2Fubm90IGNoYW5nZSBwcml2
aWxlZ2UKbGV2ZWwgd2l0aGluIGEgYmF0Y2ggYW5kIG11c3Qgc3RyaWN0bHkgdXNlIHRoZSBjdXJy
ZW50IHByaXZpbGVnZSBsZXZlbAoob3IgdW5kZWZpbmVkIGJlaGF2aW91ciBraWxscyB0aGUgR1BV
KS4gU28gaW4gb3JkZXIgdG8gZXhlY3V0ZSB0aGUKb3JpZ2luYWwgYmF0Y2gsIHdlIG5lZWQgYSBz
ZWNvbmQgbm9uLXByaXZpbGVkZ2VkIGJhdGNoIGJ1ZmZlciBjaGFpbiBmcm9tCnRoZSByaW5nLCBp
LmUuIHdlIG5lZWQgdG8gZW1pdCB0d28gYmF0Y2hlcyBmb3IgZWFjaCB1c2VyIGJhdGNoLiBJbnNp
ZGUKdGhlIHR3byBiYXRjaGVzIHdlIGRldGVybWluZSB3aGljaCBvbmUgc2hvdWxkIGFjdHVhbGx5
IGV4ZWN1dGUsIHdlCnByb3ZpZGUgYSBjb25kaXRpb25hbCB0cmFtcG9saW5lIHRvIGNhbGwgdGhl
IG9yaWdpbmFsIGJhdGNoLgoKU2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJp
cy13aWxzb24uY28udWs+Ci0tLQogLi4uL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fZXhlY2J1
ZmZlci5jICAgIHwgMTI3ICsrKysrKysrKystLS0tLS0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUv
aTkxNV9jbWRfcGFyc2VyLmMgICAgICAgIHwgIDI3ICsrKysKIDIgZmlsZXMgY2hhbmdlZCwgMTAw
IGluc2VydGlvbnMoKyksIDU0IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9leGVjYnVmZmVyLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9nZW0vaTkxNV9nZW1fZXhlY2J1ZmZlci5jCmluZGV4IDY5MGEzNjcwZWQwOC4uNWY0ZTQ2MDcw
MWNhIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fZXhlY2J1
ZmZlci5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9leGVjYnVmZmVy
LmMKQEAgLTQ3LDYgKzQ3LDggQEAgZW51bSB7CiAjZGVmaW5lIF9fRVhFQ19JTlRFUk5BTF9GTEFH
UwkofjB1IDw8IDMwKQogI2RlZmluZSBVUERBVEUJCQlQSU5fT0ZGU0VUX0ZJWEVECiAKKyNkZWZp
bmUgTlVNX0VYVFJBIDIKKwogI2RlZmluZSBCQVRDSF9PRkZTRVRfQklBUyAoMjU2KjEwMjQpCiAK
ICNkZWZpbmUgX19JOTE1X0VYRUNfSUxMRUdBTF9GTEFHUyBcCkBAIC0yMjgsNiArMjMwLDcgQEAg
c3RydWN0IGk5MTVfZXhlY2J1ZmZlciB7CiAKIAlzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpyZXF1ZXN0
OyAvKiogb3VyIHJlcXVlc3QgdG8gYnVpbGQgKi8KIAlzdHJ1Y3QgaTkxNV92bWEgKmJhdGNoOyAv
KiogaWRlbnRpdHkgb2YgdGhlIGJhdGNoIG9iai92bWEgKi8KKwlzdHJ1Y3QgaTkxNV92bWEgKnRy
YW1wb2xpbmU7IC8qKiB0cmFtcG9saW5lIHVzZWQgZm9yIGNoYWluaW5nICovCiAKIAkvKiogYWN0
dWFsIHNpemUgb2YgZXhlY29ialtdIGFzIHdlIG1heSBleHRlbmQgaXQgZm9yIHRoZSBjbWRwYXJz
ZXIgKi8KIAl1bnNpZ25lZCBpbnQgYnVmZmVyX2NvdW50OwpAQCAtMTk0NiwzMSArMTk0OSwxMyBA
QCBzdGF0aWMgaW50IGk5MTVfcmVzZXRfZ2VuN19zb2xfb2Zmc2V0cyhzdHJ1Y3QgaTkxNV9yZXF1
ZXN0ICpycSkKIH0KIAogc3RhdGljIHN0cnVjdCBpOTE1X3ZtYSAqCi1zaGFkb3dfYmF0Y2hfcGlu
KHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViLCBzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAq
b2JqKQorc2hhZG93X2JhdGNoX3BpbihzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqLAor
CQkgc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCisJCSB1bnNpZ25lZCBpbnQgZmxhZ3Mp
CiB7Ci0Jc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm07CiAJc3RydWN0IGk5MTVfdm1hICp2
bWE7Ci0JdTY0IGZsYWdzOwogCWludCBlcnI7CiAKLQkvKgotCSAqIFBQR1RUIGJhY2tlZCBzaGFk
b3cgYnVmZmVycyBtdXN0IGJlIG1hcHBlZCBSTywgdG8gcHJldmVudAotCSAqIHBvc3Qtc2NhbiB0
YW1wZXJpbmcKLQkgKi8KLQlpZiAoQ01EUEFSU0VSX1VTRVNfR0dUVChlYi0+aTkxNSkpIHsKLQkJ
dm0gPSAmZWItPmVuZ2luZS0+Z3QtPmdndHQtPnZtOwotCQlmbGFncyA9IFBJTl9HTE9CQUw7Ci0J
fSBlbHNlIHsKLQkJdm0gPSBlYi0+Y29udGV4dC0+dm07Ci0JCWlmICghdm0tPmhhc19yZWFkX29u
bHkpIHsKLQkJCURSTV9ERUJVRygiQ2Fubm90IHByZXZlbnQgcG9zdC1zY2FuIHRhbXBlcmluZyB3
aXRob3V0IFJPIGNhcGFibGUgdm1cbiIpOwotCQkJcmV0dXJuIEVSUl9QVFIoLUVJTlZBTCk7Ci0J
CX0KLQotCQlpOTE1X2dlbV9vYmplY3Rfc2V0X3JlYWRvbmx5KG9iaik7Ci0JCWZsYWdzID0gUElO
X1VTRVI7Ci0JfQotCiAJdm1hID0gaTkxNV92bWFfaW5zdGFuY2Uob2JqLCB2bSwgTlVMTCk7CiAJ
aWYgKElTX0VSUih2bWEpKQogCQlyZXR1cm4gdm1hOwpAQCAtMTk4NSw1OSArMTk3MCw4MCBAQCBz
aGFkb3dfYmF0Y2hfcGluKHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViLCBzdHJ1Y3QgZHJtX2k5
MTVfZ2VtX29iamVjdCAqb2JqKQogc3RhdGljIGludCBlYl9wYXJzZShzdHJ1Y3QgaTkxNV9leGVj
YnVmZmVyICplYikKIHsKIAlzdHJ1Y3QgaW50ZWxfZW5naW5lX3Bvb2xfbm9kZSAqcG9vbDsKLQlz
dHJ1Y3QgaTkxNV92bWEgKnZtYTsKKwlzdHJ1Y3QgaTkxNV92bWEgKnNoYWRvdywgKnRyYW1wb2xp
bmU7CisJdW5zaWduZWQgaW50IGxlbjsKIAlpbnQgZXJyOwogCiAJaWYgKCFlYl91c2VfY21kcGFy
c2VyKGViKSkKIAkJcmV0dXJuIDA7CiAKLQlwb29sID0gaW50ZWxfZW5naW5lX2dldF9wb29sKGVi
LT5lbmdpbmUsIGViLT5iYXRjaF9sZW4pOworCWxlbiA9IGViLT5iYXRjaF9sZW47CisJaWYgKCFD
TURQQVJTRVJfVVNFU19HR1RUKGViLT5pOTE1KSkgeworCQkvKgorCQkgKiBQUEdUVCBiYWNrZWQg
c2hhZG93IGJ1ZmZlcnMgbXVzdCBiZSBtYXBwZWQgUk8sIHRvIHByZXZlbnQKKwkJICogcG9zdC1z
Y2FuIHRhbXBlcmluZworCQkgKi8KKwkJaWYgKCFlYi0+Y29udGV4dC0+dm0tPmhhc19yZWFkX29u
bHkpIHsKKwkJCURSTV9ERUJVRygiQ2Fubm90IHByZXZlbnQgcG9zdC1zY2FuIHRhbXBlcmluZyB3
aXRob3V0IFJPIGNhcGFibGUgdm1cbiIpOworCQkJcmV0dXJuIC1FSU5WQUw7CisJCX0KKwl9IGVs
c2UgeworCQlsZW4gKz0gODsKKwl9CisKKwlwb29sID0gaW50ZWxfZW5naW5lX2dldF9wb29sKGVi
LT5lbmdpbmUsIGxlbik7CiAJaWYgKElTX0VSUihwb29sKSkKIAkJcmV0dXJuIFBUUl9FUlIocG9v
bCk7CiAKLQl2bWEgPSBzaGFkb3dfYmF0Y2hfcGluKGViLCBwb29sLT5vYmopOwotCWlmIChJU19F
UlIodm1hKSkgewotCQllcnIgPSBQVFJfRVJSKHZtYSk7CisJc2hhZG93ID0gc2hhZG93X2JhdGNo
X3Bpbihwb29sLT5vYmosIGViLT5jb250ZXh0LT52bSwgUElOX1VTRVIpOworCWlmIChJU19FUlIo
c2hhZG93KSkgeworCQllcnIgPSBQVFJfRVJSKHNoYWRvdyk7CiAJCWdvdG8gZXJyOwogCX0KKwlp
OTE1X2dlbV9vYmplY3Rfc2V0X3JlYWRvbmx5KHNoYWRvdy0+b2JqKTsKKworCXRyYW1wb2xpbmUg
PSBOVUxMOworCWlmIChDTURQQVJTRVJfVVNFU19HR1RUKGViLT5pOTE1KSkgeworCQl0cmFtcG9s
aW5lID0gc2hhZG93OworCisJCXNoYWRvdyA9IHNoYWRvd19iYXRjaF9waW4ocG9vbC0+b2JqLAor
CQkJCQkgICZlYi0+ZW5naW5lLT5ndC0+Z2d0dC0+dm0sCisJCQkJCSAgUElOX0dMT0JBTCk7CisJ
CWlmIChJU19FUlIoc2hhZG93KSkgeworCQkJZXJyID0gUFRSX0VSUihzaGFkb3cpOworCQkJc2hh
ZG93ID0gdHJhbXBvbGluZTsKKwkJCWdvdG8gZXJyX3NoYWRvdzsKKwkJfQorCisJCWViLT5iYXRj
aF9mbGFncyB8PSBJOTE1X0RJU1BBVENIX1NFQ1VSRTsKKwl9CiAKIAllcnIgPSBpbnRlbF9lbmdp
bmVfY21kX3BhcnNlcihlYi0+ZW5naW5lLAogCQkJCSAgICAgIGViLT5iYXRjaCwKIAkJCQkgICAg
ICBlYi0+YmF0Y2hfc3RhcnRfb2Zmc2V0LAogCQkJCSAgICAgIGViLT5iYXRjaF9sZW4sCi0JCQkJ
ICAgICAgdm1hKTsKLQlpZiAoZXJyKSB7Ci0JCS8qCi0JCSAqIFVuc2FmZSBHR1RULWJhY2tlZCBi
dWZmZXJzIGNhbiBzdGlsbCBiZSBzdWJtaXR0ZWQgc2FmZWx5Ci0JCSAqIGFzIG5vbi1zZWN1cmUu
Ci0JCSAqIEZvciBQUEdUVCBiYWNraW5nIGhvd2V2ZXIsIHdlIGhhdmUgbm8gY2hvaWNlIGJ1dCB0
byBmb3JjaWJseQotCQkgKiByZWplY3QgdW5zYWZlIGJ1ZmZlcnMKLQkJICovCi0JCWlmIChpOTE1
X3ZtYV9pc19nZ3R0KHZtYSkgJiYgZXJyID09IC1FQUNDRVMpCi0JCQkvKiBFeGVjdXRlIG9yaWdp
bmFsIGJ1ZmZlciBub24tc2VjdXJlICovCi0JCQllcnIgPSAwOwotCQlnb3RvIGVycl91bnBpbjsK
LQl9CisJCQkJICAgICAgc2hhZG93KTsKKwlpZiAoZXJyKQorCQlnb3RvIGVycl90cmFtcG9saW5l
OwogCi0JZWItPnZtYVtlYi0+YnVmZmVyX2NvdW50XSA9IGk5MTVfdm1hX2dldCh2bWEpOworCWVi
LT52bWFbZWItPmJ1ZmZlcl9jb3VudF0gPSBpOTE1X3ZtYV9nZXQoc2hhZG93KTsKIAllYi0+Zmxh
Z3NbZWItPmJ1ZmZlcl9jb3VudF0gPQogCQlfX0VYRUNfT0JKRUNUX0hBU19QSU4gfCBfX0VYRUNf
T0JKRUNUX0hBU19SRUY7Ci0Jdm1hLT5leGVjX2ZsYWdzID0gJmViLT5mbGFnc1tlYi0+YnVmZmVy
X2NvdW50XTsKKwlzaGFkb3ctPmV4ZWNfZmxhZ3MgPSAmZWItPmZsYWdzW2ViLT5idWZmZXJfY291
bnRdOwogCWViLT5idWZmZXJfY291bnQrKzsKIAorCWViLT50cmFtcG9saW5lID0gdHJhbXBvbGlu
ZTsKIAllYi0+YmF0Y2hfc3RhcnRfb2Zmc2V0ID0gMDsKLQllYi0+YmF0Y2ggPSB2bWE7Ci0KLQlp
ZiAoaTkxNV92bWFfaXNfZ2d0dCh2bWEpKQotCQllYi0+YmF0Y2hfZmxhZ3MgfD0gSTkxNV9ESVNQ
QVRDSF9TRUNVUkU7Ci0KLQkvKiBlYi0+YmF0Y2hfbGVuIHVuY2hhbmdlZCAqLworCWViLT5iYXRj
aCA9IHNoYWRvdzsKIAotCXZtYS0+cHJpdmF0ZSA9IHBvb2w7CisJc2hhZG93LT5wcml2YXRlID0g
cG9vbDsKIAlyZXR1cm4gMDsKIAotZXJyX3VucGluOgotCWk5MTVfdm1hX3VucGluKHZtYSk7Citl
cnJfdHJhbXBvbGluZToKKwlpZiAodHJhbXBvbGluZSkKKwkJaTkxNV92bWFfdW5waW4odHJhbXBv
bGluZSk7CitlcnJfc2hhZG93OgorCWk5MTVfdm1hX3VucGluKHNoYWRvdyk7CiBlcnI6CiAJaW50
ZWxfZW5naW5lX3Bvb2xfcHV0KHBvb2wpOwogCXJldHVybiBlcnI7CkBAIC0yMDg5LDYgKzIwOTUs
MTYgQEAgc3RhdGljIGludCBlYl9zdWJtaXQoc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIpCiAJ
aWYgKGVycikKIAkJcmV0dXJuIGVycjsKIAorCWlmIChlYi0+dHJhbXBvbGluZSkgeworCQlHRU1f
QlVHX09OKGViLT5iYXRjaF9zdGFydF9vZmZzZXQpOworCQllcnIgPSBlYi0+ZW5naW5lLT5lbWl0
X2JiX3N0YXJ0KGViLT5yZXF1ZXN0LAorCQkJCQkJZWItPnRyYW1wb2xpbmUtPm5vZGUuc3RhcnQg
KworCQkJCQkJZWItPmJhdGNoX2xlbiwKKwkJCQkJCTgsIDApOworCQlpZiAoZXJyKQorCQkJcmV0
dXJuIGVycjsKKwl9CisKIAlpZiAoaTkxNV9nZW1fY29udGV4dF9ub3ByZWVtcHQoZWItPmdlbV9j
b250ZXh0KSkKIAkJZWItPnJlcXVlc3QtPmZsYWdzIHw9IEk5MTVfUkVRVUVTVF9OT1BSRUVNUFQ7
CiAKQEAgLTI0NjAsOSArMjQ3Niw5IEBAIGk5MTVfZ2VtX2RvX2V4ZWNidWZmZXIoc3RydWN0IGRy
bV9kZXZpY2UgKmRldiwKIAkJYXJncy0+ZmxhZ3MgfD0gX19FWEVDX0hBU19SRUxPQzsKIAogCWVi
LmV4ZWMgPSBleGVjOwotCWViLnZtYSA9IChzdHJ1Y3QgaTkxNV92bWEgKiopKGV4ZWMgKyBhcmdz
LT5idWZmZXJfY291bnQgKyAxKTsKKwllYi52bWEgPSAoc3RydWN0IGk5MTVfdm1hICoqKShleGVj
ICsgYXJncy0+YnVmZmVyX2NvdW50ICsgTlVNX0VYVFJBKTsKIAllYi52bWFbMF0gPSBOVUxMOwot
CWViLmZsYWdzID0gKHVuc2lnbmVkIGludCAqKShlYi52bWEgKyBhcmdzLT5idWZmZXJfY291bnQg
KyAxKTsKKwllYi5mbGFncyA9ICh1bnNpZ25lZCBpbnQgKikoZWIudm1hICsgYXJncy0+YnVmZmVy
X2NvdW50ICsgTlVNX0VYVFJBKTsKIAogCWViLmludmFsaWRfZmxhZ3MgPSBfX0VYRUNfT0JKRUNU
X1VOS05PV05fRkxBR1M7CiAJcmVsb2NfY2FjaGVfaW5pdCgmZWIucmVsb2NfY2FjaGUsIGViLmk5
MTUpOwpAQCAtMjQ3MCw2ICsyNDg2LDcgQEAgaTkxNV9nZW1fZG9fZXhlY2J1ZmZlcihzdHJ1Y3Qg
ZHJtX2RldmljZSAqZGV2LAogCWViLmJ1ZmZlcl9jb3VudCA9IGFyZ3MtPmJ1ZmZlcl9jb3VudDsK
IAllYi5iYXRjaF9zdGFydF9vZmZzZXQgPSBhcmdzLT5iYXRjaF9zdGFydF9vZmZzZXQ7CiAJZWIu
YmF0Y2hfbGVuID0gYXJncy0+YmF0Y2hfbGVuOworCWViLnRyYW1wb2xpbmUgPSBOVUxMOwogCiAJ
ZWIuYmF0Y2hfZmxhZ3MgPSAwOwogCWlmIChhcmdzLT5mbGFncyAmIEk5MTVfRVhFQ19TRUNVUkUp
IHsKQEAgLTI2NjcsNiArMjY4NCw4IEBAIGk5MTVfZ2VtX2RvX2V4ZWNidWZmZXIoc3RydWN0IGRy
bV9kZXZpY2UgKmRldiwKIGVycl92bWE6CiAJaWYgKGViLmV4ZWMpCiAJCWViX3JlbGVhc2Vfdm1h
cygmZWIpOworCWlmIChlYi50cmFtcG9saW5lKQorCQlpOTE1X3ZtYV91bnBpbihlYi50cmFtcG9s
aW5lKTsKIAltdXRleF91bmxvY2soJmRldi0+c3RydWN0X211dGV4KTsKIGVycl9lbmdpbmU6CiAJ
ZWJfdW5waW5fZW5naW5lKCZlYik7CkBAIC0yNzQyLDcgKzI3NjEsNyBAQCBpOTE1X2dlbV9leGVj
YnVmZmVyX2lvY3RsKHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsIHZvaWQgKmRhdGEsCiAJLyogQ29w
eSBpbiB0aGUgZXhlYyBsaXN0IGZyb20gdXNlcmxhbmQgKi8KIAlleGVjX2xpc3QgPSBrdm1hbGxv
Y19hcnJheShjb3VudCwgc2l6ZW9mKCpleGVjX2xpc3QpLAogCQkJCSAgIF9fR0ZQX05PV0FSTiB8
IEdGUF9LRVJORUwpOwotCWV4ZWMyX2xpc3QgPSBrdm1hbGxvY19hcnJheShjb3VudCArIDEsIGVi
X2VsZW1lbnRfc2l6ZSgpLAorCWV4ZWMyX2xpc3QgPSBrdm1hbGxvY19hcnJheShjb3VudCArIE5V
TV9FWFRSQSwgZWJfZWxlbWVudF9zaXplKCksCiAJCQkJICAgIF9fR0ZQX05PV0FSTiB8IEdGUF9L
RVJORUwpOwogCWlmIChleGVjX2xpc3QgPT0gTlVMTCB8fCBleGVjMl9saXN0ID09IE5VTEwpIHsK
IAkJRFJNX0RFQlVHKCJGYWlsZWQgdG8gYWxsb2NhdGUgZXhlYyBsaXN0IGZvciAlZCBidWZmZXJz
XG4iLApAQCAtMjgxOCw3ICsyODM3LDcgQEAgaTkxNV9nZW1fZXhlY2J1ZmZlcjJfaW9jdGwoc3Ry
dWN0IGRybV9kZXZpY2UgKmRldiwgdm9pZCAqZGF0YSwKIAkJcmV0dXJuIC1FSU5WQUw7CiAKIAkv
KiBBbGxvY2F0ZSBhbiBleHRyYSBzbG90IGZvciB1c2UgYnkgdGhlIGNvbW1hbmQgcGFyc2VyICov
Ci0JZXhlYzJfbGlzdCA9IGt2bWFsbG9jX2FycmF5KGNvdW50ICsgMSwgZWJfZWxlbWVudF9zaXpl
KCksCisJZXhlYzJfbGlzdCA9IGt2bWFsbG9jX2FycmF5KGNvdW50ICsgTlVNX0VYVFJBLCBlYl9l
bGVtZW50X3NpemUoKSwKIAkJCQkgICAgX19HRlBfTk9XQVJOIHwgR0ZQX0tFUk5FTCk7CiAJaWYg
KGV4ZWMyX2xpc3QgPT0gTlVMTCkgewogCQlEUk1fREVCVUcoIkZhaWxlZCB0byBhbGxvY2F0ZSBl
eGVjIGxpc3QgZm9yICV6ZCBidWZmZXJzXG4iLApkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJt
L2k5MTUvaTkxNV9jbWRfcGFyc2VyLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2NtZF9w
YXJzZXIuYwppbmRleCAyOTc3MzE2ZDY0YWUuLjVjOTQyYTU4MmIwNiAxMDA2NDQKLS0tIGEvZHJp
dmVycy9ncHUvZHJtL2k5MTUvaTkxNV9jbWRfcGFyc2VyLmMKKysrIGIvZHJpdmVycy9ncHUvZHJt
L2k5MTUvaTkxNV9jbWRfcGFyc2VyLmMKQEAgLTE1MDQsNiArMTUwNCwzMyBAQCBpbnQgaW50ZWxf
ZW5naW5lX2NtZF9wYXJzZXIoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lLAogCQl9CiAJ
fSB3aGlsZSAoMSk7CiAKKwlpZiAoIWp1bXBfd2hpdGVsaXN0KSB7IC8qIHNldHVwIHVwIHRoZSB0
cmFtcG9saW5lIGZvciBjaGFpbmluZyAqLworCQljbWQgPSBwYWdlX21hc2tfYml0cyhzaGFkb3ct
Pm9iai0+bW0ubWFwcGluZyk7CisJCWlmICghcmV0KSB7CisJCQljbWQgKz0gYmF0Y2hfbGVuZ3Ro
IC8gc2l6ZW9mKCpjbWQpOworCQkJKmNtZCA9IE1JX0JBVENIX0JVRkZFUl9FTkQ7CisJCX0gZWxz
ZSB7CisJCQkqY21kID0gTUlfQkFUQ0hfQlVGRkVSX0VORDsKKwkJCWNtZCArPSBiYXRjaF9sZW5n
dGggLyBzaXplb2YoKmNtZCk7CisKKwkJCWlmIChyZXQgPT0gLUVBQ0NFUykgeworCQkJCXUzMiBi
YnM7CisKKwkJCQliYnMgPSBNSV9CQVRDSF9CVUZGRVJfU1RBUlQ7CisJCQkJYmJzIHw9IE1JX0JB
VENIX05PTl9TRUNVUkVfSTk2NTsKKwkJCQlpZiAoSVNfSEFTV0VMTChlbmdpbmUtPmk5MTUpKQor
CQkJCQliYnMgfD0gTUlfQkFUQ0hfTk9OX1NFQ1VSRV9IU1c7CisKKwkJCQljbWRbMF0gPSBiYnM7
CisJCQkJY21kWzFdID0gYmF0Y2hfYWRkcjsKKworCQkJCXJldCA9IDA7CisJCQl9IGVsc2Ugewor
CQkJCSpjbWQgPSBNSV9CQVRDSF9CVUZGRVJfRU5EOworCQkJfQorCQl9CisJfQorCiAJaWYgKG5l
ZWRzX2NsZmx1c2hfYWZ0ZXIpIHsKIAkJdm9pZCAqcHRyID0gcGFnZV9tYXNrX2JpdHMoc2hhZG93
LT5vYmotPm1tLm1hcHBpbmcpOwogCi0tIAoyLjI0LjAKCl9fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4
QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWls
bWFuL2xpc3RpbmZvL2ludGVsLWdmeA==

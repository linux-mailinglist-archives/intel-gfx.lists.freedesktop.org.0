Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id D91022EAF08
	for <lists+intel-gfx@lfdr.de>; Tue,  5 Jan 2021 16:46:02 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 5CB9F6E12E;
	Tue,  5 Jan 2021 15:45:45 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mblankhorst.nl (mblankhorst.nl [141.105.120.124])
 by gabe.freedesktop.org (Postfix) with ESMTPS id AC4F06E145
 for <intel-gfx@lists.freedesktop.org>; Tue,  5 Jan 2021 15:45:40 +0000 (UTC)
From: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
To: intel-gfx@lists.freedesktop.org
Date: Tue,  5 Jan 2021 16:35:30 +0100
Message-Id: <20210105153558.134272-37-maarten.lankhorst@linux.intel.com>
X-Mailer: git-send-email 2.30.0.rc1
In-Reply-To: <20210105153558.134272-1-maarten.lankhorst@linux.intel.com>
References: <20210105153558.134272-1-maarten.lankhorst@linux.intel.com>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v6 36/64] drm/i915: Lock ww in ucode objects
 correctly
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: =?UTF-8?q?Thomas=20Hellstr=C3=B6m?= <thomas.hellstrom@linux.intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SW4gdGhlIHVjb2RlIGZ1bmN0aW9ucywgdGhlIGNhbGxzIGFyZSBkb25lIGJlZm9yZSB1c2Vyc3Bh
Y2UgcnVucywKd2hlbiBkZWJ1Z2dpbmcgdXNpbmcgZGVidWdmcywgb3Igd2hlbiBjcmVhdGluZyBz
ZW1pLXBlcm1hbmVudCBtYXBwaW5nczsKd2UgY2FuIHNhZmVseSB1c2UgdGhlIHVubG9ja2VkIHZl
cnNpb25zIHRoYXQgZG9lcyB0aGUgd3cgZGFuY2UgZm9yIHVzLgoKQmVjYXVzZSB0aGVyZSBpcyBu
byBwaW5fcGFnZXNfdW5sb2NrZWQgeWV0LCBhZGQgaXQgYXMgY29udmVuaWVuY2UgZnVuY3Rpb24u
CgpUaGlzIHJlbW92ZXMgcG9zc2libGUgbG9ja2RlcCBzcGxhdHMgYWJvdXQgbWlzc2luZyByZXN2
IGxvY2sgZm9yIHVjb2RlLgoKU2lnbmVkLW9mZi1ieTogTWFhcnRlbiBMYW5raG9yc3QgPG1hYXJ0
ZW4ubGFua2hvcnN0QGxpbnV4LmludGVsLmNvbT4KUmV2aWV3ZWQtYnk6IFRob21hcyBIZWxsc3Ry
w7ZtIDx0aG9tYXMuaGVsbHN0cm9tQGxpbnV4LmludGVsLmNvbT4KLS0tCiBkcml2ZXJzL2dwdS9k
cm0vaTkxNS9nZW0vaTkxNV9nZW1fb2JqZWN0LmggfCAgMiArKwogZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ2VtL2k5MTVfZ2VtX3BhZ2VzLmMgIHwgMjAgKysrKysrKysrKysrKysrKysrKysKIGRyaXZl
cnMvZ3B1L2RybS9pOTE1L2d0L3VjL2ludGVsX2d1Yy5jICAgICB8ICAyICstCiBkcml2ZXJzL2dw
dS9kcm0vaTkxNS9ndC91Yy9pbnRlbF9ndWNfbG9nLmMgfCAgNCArKy0tCiBkcml2ZXJzL2dwdS9k
cm0vaTkxNS9ndC91Yy9pbnRlbF9odWMuYyAgICAgfCAgMiArLQogZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ3QvdWMvaW50ZWxfdWNfZncuYyAgIHwgIDIgKy0KIDYgZmlsZXMgY2hhbmdlZCwgMjcgaW5z
ZXJ0aW9ucygrKSwgNSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9nZW0vaTkxNV9nZW1fb2JqZWN0LmggYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkx
NV9nZW1fb2JqZWN0LmgKaW5kZXggMTA1YTQ5MTAyODI3Li4zZmU0MTE4MGNjODEgMTAwNjQ0Ci0t
LSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9vYmplY3QuaAorKysgYi9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fb2JqZWN0LmgKQEAgLTM0Miw2ICszNDIsOCBA
QCBpOTE1X2dlbV9vYmplY3RfcGluX3BhZ2VzKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpv
YmopCiAJcmV0dXJuIF9faTkxNV9nZW1fb2JqZWN0X2dldF9wYWdlcyhvYmopOwogfQogCitpbnQg
aTkxNV9nZW1fb2JqZWN0X3Bpbl9wYWdlc191bmxvY2tlZChzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29i
amVjdCAqb2JqKTsKKwogc3RhdGljIGlubGluZSBib29sCiBpOTE1X2dlbV9vYmplY3RfaGFzX3Bh
Z2VzKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmopCiB7CmRpZmYgLS1naXQgYS9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fcGFnZXMuYyBiL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2dlbS9pOTE1X2dlbV9wYWdlcy5jCmluZGV4IGI4NmJlZjRmYjYwMi4uOGE2YzBkZDFiZmRk
IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fcGFnZXMuYwor
KysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fcGFnZXMuYwpAQCAtMTM2LDYg
KzEzNiwyNiBAQCBpbnQgX19pOTE1X2dlbV9vYmplY3RfZ2V0X3BhZ2VzKHN0cnVjdCBkcm1faTkx
NV9nZW1fb2JqZWN0ICpvYmopCiAJcmV0dXJuIGVycjsKIH0KIAoraW50IGk5MTVfZ2VtX29iamVj
dF9waW5fcGFnZXNfdW5sb2NrZWQoc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaikKK3sK
KwlzdHJ1Y3QgaTkxNV9nZW1fd3dfY3R4IHd3OworCWludCBlcnI7CisKKwlpOTE1X2dlbV93d19j
dHhfaW5pdCgmd3csIHRydWUpOworcmV0cnk6CisJZXJyID0gaTkxNV9nZW1fb2JqZWN0X2xvY2so
b2JqLCAmd3cpOworCWlmICghZXJyKQorCQllcnIgPSBpOTE1X2dlbV9vYmplY3RfcGluX3BhZ2Vz
KG9iaik7CisKKwlpZiAoZXJyID09IC1FREVBRExLKSB7CisJCWVyciA9IGk5MTVfZ2VtX3d3X2N0
eF9iYWNrb2ZmKCZ3dyk7CisJCWlmICghZXJyKQorCQkJZ290byByZXRyeTsKKwl9CisJaTkxNV9n
ZW1fd3dfY3R4X2ZpbmkoJnd3KTsKKwlyZXR1cm4gZXJyOworfQorCiAvKiBJbW1lZGlhdGVseSBk
aXNjYXJkIHRoZSBiYWNraW5nIHN0b3JhZ2UgKi8KIHZvaWQgaTkxNV9nZW1fb2JqZWN0X3RydW5j
YXRlKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmopCiB7CmRpZmYgLS1naXQgYS9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9ndC91Yy9pbnRlbF9ndWMuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2d0L3VjL2ludGVsX2d1Yy5jCmluZGV4IDJhMzQzYTk3Nzk4Ny4uYTY1NjYxZWI1ZDVkIDEwMDY0
NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC91Yy9pbnRlbF9ndWMuYworKysgYi9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9ndC91Yy9pbnRlbF9ndWMuYwpAQCAtNjk0LDcgKzY5NCw3IEBAIGlu
dCBpbnRlbF9ndWNfYWxsb2NhdGVfYW5kX21hcF92bWEoc3RydWN0IGludGVsX2d1YyAqZ3VjLCB1
MzIgc2l6ZSwKIAlpZiAoSVNfRVJSKHZtYSkpCiAJCXJldHVybiBQVFJfRVJSKHZtYSk7CiAKLQl2
YWRkciA9IGk5MTVfZ2VtX29iamVjdF9waW5fbWFwKHZtYS0+b2JqLCBJOTE1X01BUF9XQik7CisJ
dmFkZHIgPSBpOTE1X2dlbV9vYmplY3RfcGluX21hcF91bmxvY2tlZCh2bWEtPm9iaiwgSTkxNV9N
QVBfV0IpOwogCWlmIChJU19FUlIodmFkZHIpKSB7CiAJCWk5MTVfdm1hX3VucGluX2FuZF9yZWxl
YXNlKCZ2bWEsIDApOwogCQlyZXR1cm4gUFRSX0VSUih2YWRkcik7CmRpZmYgLS1naXQgYS9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9ndC91Yy9pbnRlbF9ndWNfbG9nLmMgYi9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9ndC91Yy9pbnRlbF9ndWNfbG9nLmMKaW5kZXggYzkyZjJjMDU2ZGI0Li5jMzZkNWViNWJi
YjkgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L3VjL2ludGVsX2d1Y19sb2cu
YworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC91Yy9pbnRlbF9ndWNfbG9nLmMKQEAgLTMz
NSw3ICszMzUsNyBAQCBzdGF0aWMgaW50IGd1Y19sb2dfbWFwKHN0cnVjdCBpbnRlbF9ndWNfbG9n
ICpsb2cpCiAJICogYnVmZmVyIHBhZ2VzLCBzbyB0aGF0IHdlIGNhbiBkaXJlY3RseSBnZXQgdGhl
IGRhdGEKIAkgKiAodXAtdG8tZGF0ZSkgZnJvbSBtZW1vcnkuCiAJICovCi0JdmFkZHIgPSBpOTE1
X2dlbV9vYmplY3RfcGluX21hcChsb2ctPnZtYS0+b2JqLCBJOTE1X01BUF9XQyk7CisJdmFkZHIg
PSBpOTE1X2dlbV9vYmplY3RfcGluX21hcF91bmxvY2tlZChsb2ctPnZtYS0+b2JqLCBJOTE1X01B
UF9XQyk7CiAJaWYgKElTX0VSUih2YWRkcikpCiAJCXJldHVybiBQVFJfRVJSKHZhZGRyKTsKIApA
QCAtNzQ0LDcgKzc0NCw3IEBAIGludCBpbnRlbF9ndWNfbG9nX2R1bXAoc3RydWN0IGludGVsX2d1
Y19sb2cgKmxvZywgc3RydWN0IGRybV9wcmludGVyICpwLAogCWlmICghb2JqKQogCQlyZXR1cm4g
MDsKIAotCW1hcCA9IGk5MTVfZ2VtX29iamVjdF9waW5fbWFwKG9iaiwgSTkxNV9NQVBfV0MpOwor
CW1hcCA9IGk5MTVfZ2VtX29iamVjdF9waW5fbWFwX3VubG9ja2VkKG9iaiwgSTkxNV9NQVBfV0Mp
OwogCWlmIChJU19FUlIobWFwKSkgewogCQlEUk1fREVCVUcoIkZhaWxlZCB0byBwaW4gb2JqZWN0
XG4iKTsKIAkJZHJtX3B1dHMocCwgIihsb2cgZGF0YSB1bmFjY2Vzc2libGUpXG4iKTsKZGlmZiAt
LWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L3VjL2ludGVsX2h1Yy5jIGIvZHJpdmVycy9n
cHUvZHJtL2k5MTUvZ3QvdWMvaW50ZWxfaHVjLmMKaW5kZXggNjVlZWI0NGIzOTdkLi4yMTI2ZGQ4
MWFjMzggMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L3VjL2ludGVsX2h1Yy5j
CisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L3VjL2ludGVsX2h1Yy5jCkBAIC04Miw3ICs4
Miw3IEBAIHN0YXRpYyBpbnQgaW50ZWxfaHVjX3JzYV9kYXRhX2NyZWF0ZShzdHJ1Y3QgaW50ZWxf
aHVjICpodWMpCiAJaWYgKElTX0VSUih2bWEpKQogCQlyZXR1cm4gUFRSX0VSUih2bWEpOwogCi0J
dmFkZHIgPSBpOTE1X2dlbV9vYmplY3RfcGluX21hcCh2bWEtPm9iaiwgSTkxNV9NQVBfV0IpOwor
CXZhZGRyID0gaTkxNV9nZW1fb2JqZWN0X3Bpbl9tYXBfdW5sb2NrZWQodm1hLT5vYmosIEk5MTVf
TUFQX1dCKTsKIAlpZiAoSVNfRVJSKHZhZGRyKSkgewogCQlpOTE1X3ZtYV91bnBpbl9hbmRfcmVs
ZWFzZSgmdm1hLCAwKTsKIAkJcmV0dXJuIFBUUl9FUlIodmFkZHIpOwpkaWZmIC0tZ2l0IGEvZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ3QvdWMvaW50ZWxfdWNfZncuYyBiL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2d0L3VjL2ludGVsX3VjX2Z3LmMKaW5kZXggNjAyZjFhMGJjNTg3Li5mNDBiZDQ1NTgzMGUg
MTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L3VjL2ludGVsX3VjX2Z3LmMKKysr
IGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvdWMvaW50ZWxfdWNfZncuYwpAQCAtNTQyLDcgKzU0
Miw3IEBAIGludCBpbnRlbF91Y19md19pbml0KHN0cnVjdCBpbnRlbF91Y19mdyAqdWNfZncpCiAJ
aWYgKCFpbnRlbF91Y19md19pc19hdmFpbGFibGUodWNfZncpKQogCQlyZXR1cm4gLUVOT0VYRUM7
CiAKLQllcnIgPSBpOTE1X2dlbV9vYmplY3RfcGluX3BhZ2VzKHVjX2Z3LT5vYmopOworCWVyciA9
IGk5MTVfZ2VtX29iamVjdF9waW5fcGFnZXNfdW5sb2NrZWQodWNfZnctPm9iaik7CiAJaWYgKGVy
cikgewogCQlEUk1fREVCVUdfRFJJVkVSKCIlcyBmdyBwaW4tcGFnZXMgZXJyPSVkXG4iLAogCQkJ
CSBpbnRlbF91Y19md190eXBlX3JlcHIodWNfZnctPnR5cGUpLCBlcnIpOwotLSAKMi4zMC4wLnJj
MQoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwt
Z2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8v
bGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4Cg==

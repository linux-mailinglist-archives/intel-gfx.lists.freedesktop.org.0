Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 74951CF7A0
	for <lists+intel-gfx@lfdr.de>; Tue,  8 Oct 2019 12:57:08 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id A257C6E0ED;
	Tue,  8 Oct 2019 10:57:06 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 2740E6E0ED
 for <intel-gfx@lists.freedesktop.org>; Tue,  8 Oct 2019 10:57:04 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18762533-1500050 
 for multiple; Tue, 08 Oct 2019 11:56:57 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Tue,  8 Oct 2019 11:56:55 +0100
Message-Id: <20191008105655.13256-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH] drm/i915/gt: Flush submission tasklet before
 waiting/retiring
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

QSBjb21tb24gYmFuZSBvZiBvdXJzIGlzIGFyYml0cmFyeSBkZWxheXMgaW4ga3NvZnRpcnFkIHBy
b2Nlc3Npbmcgb3VyCnN1Ym1pc3Npb24gdGFza2xldC4gR2l2ZSB0aGUgc3VibWlzc2lvbiB0YXNr
bGV0IGEga2ljayBiZWZvcmUgd2Ugd2FpdCB0bwphdm9pZCB0aG9zZSBkZWxheXMgZWF0aW5nIGlu
dG8gYSB0aWdodCB0aW1lb3V0LgoKU2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0Bj
aHJpcy13aWxzb24uY28udWs+Ci0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZW5n
aW5lLmggICAgICB8ICAzICstCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVf
Y3MuYyAgIHwgMzMgKysrKysrKysrKysrKy0tLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9n
dC9pbnRlbF9ndF9yZXF1ZXN0cy5jIHwgMTIgKysrKysrKysKIDMgZmlsZXMgY2hhbmdlZCwgMzQg
aW5zZXJ0aW9ucygrKSwgMTQgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvZ3QvaW50ZWxfZW5naW5lLmggYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRl
bF9lbmdpbmUuaAppbmRleCBjOWU4YzhjY2JkNDcuLmQ2MjQ3NTJmMmE5MiAxMDA2NDQKLS0tIGEv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZW5naW5lLmgKKysrIGIvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvZ3QvaW50ZWxfZW5naW5lLmgKQEAgLTQwNyw4ICs0MDcsOSBAQCBzdGF0aWMgaW5s
aW5lIHZvaWQgX19pbnRlbF9lbmdpbmVfcmVzZXQoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5n
aW5lLAogCWVuZ2luZS0+c2VyaWFsKys7IC8qIGNvbnRleHRzIGxvc3QgKi8KIH0KIAotYm9vbCBp
bnRlbF9lbmdpbmVfaXNfaWRsZShzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUpOwogYm9v
bCBpbnRlbF9lbmdpbmVzX2FyZV9pZGxlKHN0cnVjdCBpbnRlbF9ndCAqZ3QpOworYm9vbCBpbnRl
bF9lbmdpbmVfaXNfaWRsZShzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUpOwordm9pZCBp
bnRlbF9lbmdpbmVfZmx1c2hfc3VibWlzc2lvbihzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdp
bmUpOwogCiB2b2lkIGludGVsX2VuZ2luZXNfcmVzZXRfZGVmYXVsdF9zdWJtaXNzaW9uKHN0cnVj
dCBpbnRlbF9ndCAqZ3QpOwogCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9p
bnRlbF9lbmdpbmVfY3MuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZV9j
cy5jCmluZGV4IDYyMjBiNzE1MWJiOS4uN2UyYWE3YTZiZWYwIDEwMDY0NAotLS0gYS9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfY3MuYworKysgYi9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9ndC9pbnRlbF9lbmdpbmVfY3MuYwpAQCAtMTA0MCw2ICsxMDQwLDI1IEBAIHN0YXRpYyBi
b29sIHJpbmdfaXNfaWRsZShzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUpCiAJcmV0dXJu
IGlkbGU7CiB9CiAKK3ZvaWQgaW50ZWxfZW5naW5lX2ZsdXNoX3N1Ym1pc3Npb24oc3RydWN0IGlu
dGVsX2VuZ2luZV9jcyAqZW5naW5lKQoreworCXN0cnVjdCB0YXNrbGV0X3N0cnVjdCAqdCA9ICZl
bmdpbmUtPmV4ZWNsaXN0cy50YXNrbGV0OworCisJaWYgKF9fdGFza2xldF9pc19zY2hlZHVsZWQo
dCkpIHsKKwkJbG9jYWxfYmhfZGlzYWJsZSgpOworCQlpZiAodGFza2xldF90cnlsb2NrKHQpKSB7
CisJCQkvKiBNdXN0IHdhaXQgZm9yIGFueSBHUFUgcmVzZXQgaW4gcHJvZ3Jlc3MuICovCisJCQlp
ZiAoX190YXNrbGV0X2lzX2VuYWJsZWQodCkpCisJCQkJdC0+ZnVuYyh0LT5kYXRhKTsKKwkJCXRh
c2tsZXRfdW5sb2NrKHQpOworCQl9CisJCWxvY2FsX2JoX2VuYWJsZSgpOworCX0KKworCS8qIE90
aGVyd2lzZSBmbHVzaCB0aGUgdGFza2xldCBpZiBpdCB3YXMgcnVubmluZyBvbiBhbm90aGVyIGNw
dSAqLworCXRhc2tsZXRfdW5sb2NrX3dhaXQodCk7Cit9CisKIC8qKgogICogaW50ZWxfZW5naW5l
X2lzX2lkbGUoKSAtIFJlcG9ydCBpZiB0aGUgZW5naW5lIGhhcyBmaW5pc2hlZCBwcm9jZXNzIGFs
bCB3b3JrCiAgKiBAZW5naW5lOiB0aGUgaW50ZWxfZW5naW5lX2NzCkBAIC0xMDU4LDIxICsxMDc3
LDkgQEAgYm9vbCBpbnRlbF9lbmdpbmVfaXNfaWRsZShzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICpl
bmdpbmUpCiAKIAkvKiBXYWl0aW5nIHRvIGRyYWluIEVMU1A/ICovCiAJaWYgKGV4ZWNsaXN0c19h
Y3RpdmUoJmVuZ2luZS0+ZXhlY2xpc3RzKSkgewotCQlzdHJ1Y3QgdGFza2xldF9zdHJ1Y3QgKnQg
PSAmZW5naW5lLT5leGVjbGlzdHMudGFza2xldDsKLQogCQlzeW5jaHJvbml6ZV9oYXJkaXJxKGVu
Z2luZS0+aTkxNS0+ZHJtLnBkZXYtPmlycSk7CiAKLQkJbG9jYWxfYmhfZGlzYWJsZSgpOwotCQlp
ZiAodGFza2xldF90cnlsb2NrKHQpKSB7Ci0JCQkvKiBNdXN0IHdhaXQgZm9yIGFueSBHUFUgcmVz
ZXQgaW4gcHJvZ3Jlc3MuICovCi0JCQlpZiAoX190YXNrbGV0X2lzX2VuYWJsZWQodCkpCi0JCQkJ
dC0+ZnVuYyh0LT5kYXRhKTsKLQkJCXRhc2tsZXRfdW5sb2NrKHQpOwotCQl9Ci0JCWxvY2FsX2Jo
X2VuYWJsZSgpOwotCi0JCS8qIE90aGVyd2lzZSBmbHVzaCB0aGUgdGFza2xldCBpZiBpdCB3YXMg
b24gYW5vdGhlciBjcHUgKi8KLQkJdGFza2xldF91bmxvY2tfd2FpdCh0KTsKKwkJaW50ZWxfZW5n
aW5lX2ZsdXNoX3N1Ym1pc3Npb24oZW5naW5lKTsKIAogCQlpZiAoZXhlY2xpc3RzX2FjdGl2ZSgm
ZW5naW5lLT5leGVjbGlzdHMpKQogCQkJcmV0dXJuIGZhbHNlOwpkaWZmIC0tZ2l0IGEvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZ3RfcmVxdWVzdHMuYyBiL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2d0L2ludGVsX2d0X3JlcXVlc3RzLmMKaW5kZXggY2E2MDZiNzlmZDVlLi5jYmI0MDY5YjEx
ZTEgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2d0X3JlcXVlc3Rz
LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZ3RfcmVxdWVzdHMuYwpAQCAt
NCw2ICs0LDcgQEAKICAqIENvcHlyaWdodCDCqSAyMDE5IEludGVsIENvcnBvcmF0aW9uCiAgKi8K
IAorI2luY2x1ZGUgImk5MTVfZHJ2LmgiIC8qIGZvcl9lYWNoX2VuZ2luZSgpICovCiAjaW5jbHVk
ZSAiaTkxNV9yZXF1ZXN0LmgiCiAjaW5jbHVkZSAiaW50ZWxfZ3QuaCIKICNpbmNsdWRlICJpbnRl
bF9ndF9wbS5oIgpAQCAtMTksNiArMjAsMTUgQEAgc3RhdGljIHZvaWQgcmV0aXJlX3JlcXVlc3Rz
KHN0cnVjdCBpbnRlbF90aW1lbGluZSAqdGwpCiAJCQlicmVhazsKIH0KIAorc3RhdGljIHZvaWQg
Zmx1c2hfc3VibWlzc2lvbihzdHJ1Y3QgaW50ZWxfZ3QgKmd0KQoreworCXN0cnVjdCBpbnRlbF9l
bmdpbmVfY3MgKmVuZ2luZTsKKwllbnVtIGludGVsX2VuZ2luZV9pZCBpZDsKKworCWZvcl9lYWNo
X2VuZ2luZShlbmdpbmUsIGd0LT5pOTE1LCBpZCkKKwkJaW50ZWxfZW5naW5lX2ZsdXNoX3N1Ym1p
c3Npb24oZW5naW5lKTsKK30KKwogbG9uZyBpbnRlbF9ndF9yZXRpcmVfcmVxdWVzdHNfdGltZW91
dChzdHJ1Y3QgaW50ZWxfZ3QgKmd0LCBsb25nIHRpbWVvdXQpCiB7CiAJc3RydWN0IGludGVsX2d0
X3RpbWVsaW5lcyAqdGltZWxpbmVzID0gJmd0LT50aW1lbGluZXM7CkBAIC0zMiw2ICs0Miw4IEBA
IGxvbmcgaW50ZWxfZ3RfcmV0aXJlX3JlcXVlc3RzX3RpbWVvdXQoc3RydWN0IGludGVsX2d0ICpn
dCwgbG9uZyB0aW1lb3V0KQogCWlmICh1bmxpa2VseSh0aW1lb3V0IDwgMCkpCiAJCXRpbWVvdXQg
PSAtdGltZW91dCwgaW50ZXJydXB0aWJsZSA9IGZhbHNlOwogCisJZmx1c2hfc3VibWlzc2lvbihn
dCk7IC8qIGtpY2sgdGhlIGtzb2Z0aXJxZCB0YXNrbGV0cyAqLworCiAJc3Bpbl9sb2NrX2lycXNh
dmUoJnRpbWVsaW5lcy0+bG9jaywgZmxhZ3MpOwogCWxpc3RfZm9yX2VhY2hfZW50cnlfc2FmZSh0
bCwgdG4sICZ0aW1lbGluZXMtPmFjdGl2ZV9saXN0LCBsaW5rKSB7CiAJCWlmICghbXV0ZXhfdHJ5
bG9jaygmdGwtPm11dGV4KSkgewotLSAKMi4yMy4wCgpfX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fXwpJbnRlbC1nZnggbWFpbGluZyBsaXN0CkludGVsLWdmeEBs
aXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1h
bi9saXN0aW5mby9pbnRlbC1nZng=

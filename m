Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 3BCFC605EF
	for <lists+intel-gfx@lfdr.de>; Fri,  5 Jul 2019 14:31:18 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 9C25D6E497;
	Fri,  5 Jul 2019 12:31:16 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id F07CF6E497
 for <intel-gfx@lists.freedesktop.org>; Fri,  5 Jul 2019 12:31:14 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17142760-1500050 
 for multiple; Fri, 05 Jul 2019 13:30:58 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Fri,  5 Jul 2019 13:30:57 +0100
Message-Id: <20190705123057.19346-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH] drm/i915/oa: Reconfigure contexts on the fly
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

QXZvaWQgYSBnbG9iYWwgaWRsZSBiYXJyaWVyIGJ5IHJlY29uZmlndXJpbmcgZWFjaCBjb250ZXh0
IGJ5IHJld3JpdGluZwp0aGVtIHdpdGggTUlfU1RPUkVfRFdPUkQgZnJvbSB0aGUga2VybmVsIGNv
bnRleHQuCgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNocmlzQGNocmlzLXdpbHNvbi5j
by51az4KQ2M6IExpb25lbCBMYW5kd2VybGluIDxsaW9uZWwuZy5sYW5kd2VybGluQGludGVsLmNv
bT4KQ2M6IFR2cnRrbyBVcnN1bGluIDx0dnJ0a28udXJzdWxpbkBpbnRlbC5jb20+Ci0tLQogZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRleHQuYyB8ICAgMiArCiBkcml2ZXJz
L2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9scmMuYyAgICAgICAgIHwgICA3ICstCiBkcml2ZXJzL2dw
dS9kcm0vaTkxNS9pOTE1X3BlcmYuYyAgICAgICAgICAgIHwgMjU1ICsrKysrKysrKysrKysrKy0t
LS0tCiAzIGZpbGVzIGNoYW5nZWQsIDIwMCBpbnNlcnRpb25zKCspLCA2NCBkZWxldGlvbnMoLSkK
CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fY29udGV4dC5j
IGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRleHQuYwppbmRleCBlMzY3
ZGNlMmE2OTYuLjFmMGQxMGJiODhjMSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUv
Z2VtL2k5MTVfZ2VtX2NvbnRleHQuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkx
NV9nZW1fY29udGV4dC5jCkBAIC02MjQsNyArNjI0LDkgQEAgaTkxNV9nZW1fY29udGV4dF9jcmVh
dGVfa2VybmVsKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1LCBpbnQgcHJpbykKIAljdHgt
PnNjaGVkLnByaW9yaXR5ID0gSTkxNV9VU0VSX1BSSU9SSVRZKHByaW8pOwogCWN0eC0+cmluZ19z
aXplID0gUEFHRV9TSVpFOwogCisJLyogSXNvbGF0ZSB0aGUga2VybmVsIGNvbnRleHQgZnJvbSBw
cnlpbmcgZXllcyBhbmQgc3RpY2t5IGZpbmdlcnMgKi8KIAlHRU1fQlVHX09OKCFpOTE1X2dlbV9j
b250ZXh0X2lzX2tlcm5lbChjdHgpKTsKKwlsaXN0X2RlbF9pbml0KCZjdHgtPmxpbmspOwogCiAJ
cmV0dXJuIGN0eDsKIH0KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVs
X2xyYy5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjLmMKaW5kZXggZTFhZTEz
OTljNzJiLi45Y2M1Mzc0NDAxZTEgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0
L2ludGVsX2xyYy5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2xyYy5jCkBA
IC0xNTUyLDkgKzE1NTIsMTIgQEAgX19leGVjbGlzdHNfdXBkYXRlX3JlZ19zdGF0ZShzdHJ1Y3Qg
aW50ZWxfY29udGV4dCAqY2UsCiAJcmVnc1tDVFhfUklOR19UQUlMICsgMV0gPSByaW5nLT50YWls
OwogCiAJLyogUlBDUyAqLwotCWlmIChlbmdpbmUtPmNsYXNzID09IFJFTkRFUl9DTEFTUykKKwlp
ZiAoZW5naW5lLT5jbGFzcyA9PSBSRU5ERVJfQ0xBU1MpIHsKIAkJcmVnc1tDVFhfUl9QV1JfQ0xL
X1NUQVRFICsgMV0gPQogCQkJaW50ZWxfc3NldV9tYWtlX3JwY3MoZW5naW5lLT5pOTE1LCAmY2Ut
PnNzZXUpOworCisJCWk5MTVfb2FfaW5pdF9yZWdfc3RhdGUoZW5naW5lLCBjZSwgcmVncyk7CisJ
fQogfQogCiBzdGF0aWMgaW50CkBAIC0yOTY2LDggKzI5NjksNiBAQCBzdGF0aWMgdm9pZCBleGVj
bGlzdHNfaW5pdF9yZWdfc3RhdGUodTMyICpyZWdzLAogCWlmIChyY3MpIHsKIAkJcmVnc1tDVFhf
TFJJX0hFQURFUl8yXSA9IE1JX0xPQURfUkVHSVNURVJfSU1NKDEpOwogCQlDVFhfUkVHKHJlZ3Ms
IENUWF9SX1BXUl9DTEtfU1RBVEUsIEdFTjhfUl9QV1JfQ0xLX1NUQVRFLCAwKTsKLQotCQlpOTE1
X29hX2luaXRfcmVnX3N0YXRlKGVuZ2luZSwgY2UsIHJlZ3MpOwogCX0KIAogCXJlZ3NbQ1RYX0VO
RF0gPSBNSV9CQVRDSF9CVUZGRVJfRU5EOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvaTkxNV9wZXJmLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3BlcmYuYwppbmRleCAz
NTdlNjNiZWIzNzMuLmEyYTA3NTJmZmE1NyAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvaTkxNV9wZXJmLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wZXJmLmMKQEAg
LTE2MzAsNiArMTYzMCwyNyBAQCBzdGF0aWMgdm9pZCBoc3dfZGlzYWJsZV9tZXRyaWNfc2V0KHN0
cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdikKIAkJCQkgICAgICB+R1RfTk9BX0VOQUJM
RSkpOwogfQogCitzdGF0aWMgdTMyIG9hX2NvbmZpZ19mbGV4X3JlZyhjb25zdCBzdHJ1Y3QgaTkx
NV9vYV9jb25maWcgKm9hX2NvbmZpZywKKwkJCSAgICAgIGk5MTVfcmVnX3QgcmVnKQoreworCXUz
MiBtbWlvID0gaTkxNV9tbWlvX3JlZ19vZmZzZXQocmVnKTsKKwlpbnQgaTsKKworCS8qCisJICog
VGhpcyBhcmJpdHJhcnkgZGVmYXVsdCB3aWxsIHNlbGVjdCB0aGUgJ0VVIEZQVTAgUGlwZWxpbmUK
KwkgKiBBY3RpdmUnIGV2ZW50LiBJbiB0aGUgZnV0dXJlIGl0J3MgYW50aWNpcGF0ZWQgdGhhdCB0
aGVyZQorCSAqIHdpbGwgYmUgYW4gZXhwbGljaXQgJ05vIEV2ZW50JyB3ZSBjYW4gc2VsZWN0LCBi
dXQgbm90IHlldC4uLgorCSAqLworCWlmICghb2FfY29uZmlnKQorCQlyZXR1cm4gMDsKKworCWZv
ciAoaSA9IDA7IGkgPCBvYV9jb25maWctPmZsZXhfcmVnc19sZW47IGkrKykgeworCQlpZiAoaTkx
NV9tbWlvX3JlZ19vZmZzZXQob2FfY29uZmlnLT5mbGV4X3JlZ3NbaV0uYWRkcikgPT0gbW1pbykK
KwkJCXJldHVybiBvYV9jb25maWctPmZsZXhfcmVnc1tpXS52YWx1ZTsKKwl9CisKKwlyZXR1cm4g
MDsKK30KIC8qCiAgKiBOQjogSXQgbXVzdCBhbHdheXMgcmVtYWluIHBvaW50ZXIgc2FmZSB0byBy
dW4gdGhpcyBldmVuIGlmIHRoZSBPQSB1bml0CiAgKiBoYXMgYmVlbiBkaXNhYmxlZC4KQEAgLTE2
NjMsMjggKzE2ODQsOCBAQCBnZW44X3VwZGF0ZV9yZWdfc3RhdGVfdW5sb2NrZWQoc3RydWN0IGlu
dGVsX2NvbnRleHQgKmNlLAogCQlHRU44X09BX0NPVU5URVJfUkVTVU1FKTsKIAogCWZvciAoaSA9
IDA7IGkgPCBBUlJBWV9TSVpFKGZsZXhfcmVncyk7IGkrKykgewotCQl1MzIgc3RhdGVfb2Zmc2V0
ID0gY3R4X2ZsZXhldTAgKyBpICogMjsKLQkJdTMyIG1taW8gPSBpOTE1X21taW9fcmVnX29mZnNl
dChmbGV4X3JlZ3NbaV0pOwotCi0JCS8qCi0JCSAqIFRoaXMgYXJiaXRyYXJ5IGRlZmF1bHQgd2ls
bCBzZWxlY3QgdGhlICdFVSBGUFUwIFBpcGVsaW5lCi0JCSAqIEFjdGl2ZScgZXZlbnQuIEluIHRo
ZSBmdXR1cmUgaXQncyBhbnRpY2lwYXRlZCB0aGF0IHRoZXJlCi0JCSAqIHdpbGwgYmUgYW4gZXhw
bGljaXQgJ05vIEV2ZW50JyB3ZSBjYW4gc2VsZWN0LCBidXQgbm90IHlldC4uLgotCQkgKi8KLQkJ
dTMyIHZhbHVlID0gMDsKLQotCQlpZiAob2FfY29uZmlnKSB7Ci0JCQl1MzIgajsKLQotCQkJZm9y
IChqID0gMDsgaiA8IG9hX2NvbmZpZy0+ZmxleF9yZWdzX2xlbjsgaisrKSB7Ci0JCQkJaWYgKGk5
MTVfbW1pb19yZWdfb2Zmc2V0KG9hX2NvbmZpZy0+ZmxleF9yZWdzW2pdLmFkZHIpID09IG1taW8p
IHsKLQkJCQkJdmFsdWUgPSBvYV9jb25maWctPmZsZXhfcmVnc1tqXS52YWx1ZTsKLQkJCQkJYnJl
YWs7Ci0JCQkJfQotCQkJfQotCQl9Ci0KLQkJQ1RYX1JFRyhyZWdfc3RhdGUsIHN0YXRlX29mZnNl
dCwgZmxleF9yZWdzW2ldLCB2YWx1ZSk7CisJCUNUWF9SRUcocmVnX3N0YXRlLCBjdHhfZmxleGV1
MCArIGkgKiAyLCBmbGV4X3JlZ3NbaV0sCisJCQlvYV9jb25maWdfZmxleF9yZWcob2FfY29uZmln
LCBmbGV4X3JlZ3NbaV0pKTsKIAl9CiAKIAlDVFhfUkVHKHJlZ19zdGF0ZSwKQEAgLTE2OTIsNiAr
MTY5MywxNTAgQEAgZ2VuOF91cGRhdGVfcmVnX3N0YXRlX3VubG9ja2VkKHN0cnVjdCBpbnRlbF9j
b250ZXh0ICpjZSwKIAkJaW50ZWxfc3NldV9tYWtlX3JwY3MoaTkxNSwgJmNlLT5zc2V1KSk7CiB9
CiAKK3N0cnVjdCBmbGV4IHsKKwlpOTE1X3JlZ190IHJlZzsKKwl1MzIgb2Zmc2V0OworCXUzMiB2
YWx1ZTsKK307CisKK3N0YXRpYyBpbnQKK2dlbjhfc3RvcmVfZmxleChzdHJ1Y3QgaTkxNV9yZXF1
ZXN0ICpycSwKKwkJc3RydWN0IGludGVsX2NvbnRleHQgKmNlLAorCQljb25zdCBzdHJ1Y3QgZmxl
eCAqZmxleCwgdW5zaWduZWQgaW50IGNvdW50KQoreworCXUzMiBvZmZzZXQ7CisJdTMyICpjczsK
KworCWNzID0gaW50ZWxfcmluZ19iZWdpbihycSwgNCAqIGNvdW50KTsKKwlpZiAoSVNfRVJSKGNz
KSkKKwkJcmV0dXJuIFBUUl9FUlIoY3MpOworCisJb2Zmc2V0ID0gaTkxNV9nZ3R0X29mZnNldChj
ZS0+c3RhdGUpICsgTFJDX1NUQVRFX1BOICogUEFHRV9TSVpFOworCWRvIHsKKwkJKmNzKysgPSBN
SV9TVE9SRV9EV09SRF9JTU1fR0VONCB8IE1JX1VTRV9HR1RUOworCQkqY3MrKyA9IG9mZnNldCAr
IChmbGV4LT5vZmZzZXQgKyAxKSAqIHNpemVvZih1MzIpOworCQkqY3MrKyA9IDA7CisJCSpjcysr
ID0gZmxleC0+dmFsdWU7CisJfSB3aGlsZSAoZmxleCsrLCAtLWNvdW50KTsKKworCWludGVsX3Jp
bmdfYWR2YW5jZShycSwgY3MpOworCisJcmV0dXJuIDA7Cit9CisKK3N0YXRpYyBpbnQKK2dlbjhf
bG9hZF9mbGV4KHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxLAorCSAgICAgICBzdHJ1Y3QgaW50ZWxf
Y29udGV4dCAqY2UsCisJICAgICAgIGNvbnN0IHN0cnVjdCBmbGV4ICpmbGV4LCB1bnNpZ25lZCBp
bnQgY291bnQpCit7CisJdTMyICpjczsKKworCUdFTV9CVUdfT04oIWNvdW50IHx8IGNvdW50ID4g
NjMpOworCisJY3MgPSBpbnRlbF9yaW5nX2JlZ2luKHJxLCAyICogY291bnQgKyAyKTsKKwlpZiAo
SVNfRVJSKGNzKSkKKwkJcmV0dXJuIFBUUl9FUlIoY3MpOworCisJKmNzKysgPSBNSV9MT0FEX1JF
R0lTVEVSX0lNTShjb3VudCk7CisJZG8geworCQkqY3MrKyA9IGk5MTVfbW1pb19yZWdfb2Zmc2V0
KGZsZXgtPnJlZyk7CisJCSpjcysrID0gZmxleC0+dmFsdWU7CisJfSB3aGlsZSAoZmxleCsrLCAt
LWNvdW50KTsKKwkqY3MrKyA9IE1JX05PT1A7CisKKwlpbnRlbF9yaW5nX2FkdmFuY2UocnEsIGNz
KTsKKworCXJldHVybiAwOworfQorCitzdGF0aWMgaW50CitnZW44X2VtaXRfb2FfY29uZmlnKHN0
cnVjdCBpOTE1X3JlcXVlc3QgKnJxLAorCQkgICAgc3RydWN0IGludGVsX2NvbnRleHQgKmNlLAor
CQkgICAgY29uc3Qgc3RydWN0IGk5MTVfb2FfY29uZmlnICpvYV9jb25maWcsCisJCSAgICBib29s
IHNlbGYpCit7CisJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUgPSBycS0+aTkxNTsKKwkv
KiBUaGUgTU1JTyBvZmZzZXRzIGZvciBGbGV4IEVVIHJlZ2lzdGVycyBhcmVuJ3QgY29udGlndW91
cyAqLworCWNvbnN0IHUzMiBjdHhfZmxleGV1MCA9IGk5MTUtPnBlcmYub2EuY3R4X2ZsZXhldTBf
b2Zmc2V0OworI2RlZmluZSBjdHhfZmxleGV1TihOKSAoY3R4X2ZsZXhldTAgKyAyICogKE4pKQor
CXN0cnVjdCBmbGV4IHJlZ3NbXSA9IHsKKwkJeworCQkJR0VOOF9SX1BXUl9DTEtfU1RBVEUsCisJ
CQlDVFhfUl9QV1JfQ0xLX1NUQVRFLAorCQkJaW50ZWxfc3NldV9tYWtlX3JwY3MoaTkxNSwgJmNl
LT5zc2V1KQorCQl9LAorCQl7CisJCQlHRU44X09BQ1RYQ09OVFJPTCwKKwkJCWk5MTUtPnBlcmYu
b2EuY3R4X29hY3R4Y3RybF9vZmZzZXQsCisJCQkoKGk5MTUtPnBlcmYub2EucGVyaW9kX2V4cG9u
ZW50IDw8IEdFTjhfT0FfVElNRVJfUEVSSU9EX1NISUZUKSB8CisJCQkgKGk5MTUtPnBlcmYub2Eu
cGVyaW9kaWMgPyBHRU44X09BX1RJTUVSX0VOQUJMRSA6IDApIHwKKwkJCSBHRU44X09BX0NPVU5U
RVJfUkVTVU1FKQorCQl9LAorCQl7IEVVX1BFUkZfQ05UTDAsIGN0eF9mbGV4ZXVOKDApIH0sCisJ
CXsgRVVfUEVSRl9DTlRMMSwgY3R4X2ZsZXhldU4oMSkgfSwKKwkJeyBFVV9QRVJGX0NOVEwyLCBj
dHhfZmxleGV1TigyKSB9LAorCQl7IEVVX1BFUkZfQ05UTDMsIGN0eF9mbGV4ZXVOKDMpIH0sCisJ
CXsgRVVfUEVSRl9DTlRMNCwgY3R4X2ZsZXhldU4oNCkgfSwKKwkJeyBFVV9QRVJGX0NOVEw1LCBj
dHhfZmxleGV1Tig1KSB9LAorCQl7IEVVX1BFUkZfQ05UTDYsIGN0eF9mbGV4ZXVOKDYpIH0sCisJ
fTsKKyN1bmRlZiBjdHhfZmxleGV1TgorCWludCBpOworCisJZm9yIChpID0gMjsgaSA8IEFSUkFZ
X1NJWkUocmVncyk7IGkrKykKKwkJcmVnc1tpXS52YWx1ZSA9IG9hX2NvbmZpZ19mbGV4X3JlZyhv
YV9jb25maWcsIHJlZ3NbaV0ucmVnKTsKKworCWlmIChzZWxmKQorCQlyZXR1cm4gZ2VuOF9sb2Fk
X2ZsZXgocnEsIGNlLCByZWdzLCBBUlJBWV9TSVpFKHJlZ3MpKTsKKwllbHNlCisJCXJldHVybiBn
ZW44X3N0b3JlX2ZsZXgocnEsIGNlLCByZWdzLCBBUlJBWV9TSVpFKHJlZ3MpKTsKK30KKworc3Rh
dGljIGludCBnZW44X21vZGlmeV9jb250ZXh0KHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSwKKwkJ
CSAgICAgICBjb25zdCBzdHJ1Y3QgaTkxNV9vYV9jb25maWcgKm9hX2NvbmZpZykKK3sKKwlzdHJ1
Y3QgaTkxNV9yZXF1ZXN0ICpycTsKKwlpbnQgZXJyOworCisJbG9ja2RlcF9hc3NlcnRfaGVsZCgm
Y2UtPnBpbl9tdXRleCk7CisKKwlycSA9IGk5MTVfcmVxdWVzdF9jcmVhdGUoY2UtPmVuZ2luZS0+
a2VybmVsX2NvbnRleHQpOworCWlmIChJU19FUlIocnEpKQorCQlyZXR1cm4gUFRSX0VSUihycSk7
CisKKwkvKiBTZXJpYWxpc2Ugd2l0aCB0aGUgcmVtb3RlIGNvbnRleHQgKi8KKwllcnIgPSBpOTE1
X2FjdGl2ZV9yZXF1ZXN0X3NldCgmY2UtPnJpbmctPnRpbWVsaW5lLT5sYXN0X3JlcXVlc3QsIHJx
KTsKKwlpZiAoZXJyKQorCQlnb3RvIG91dF9hZGQ7CisKKwkvKiBLZWVwIHRoZSByZW1vdGUgY29u
dGV4dCBhbGl2ZSB1bnRpbCBhZnRlciB3ZSBmaW5pc2ggZWRpdGluZyAqLworCWVyciA9IGk5MTVf
YWN0aXZlX3JlZigmY2UtPmFjdGl2ZSwgcnEtPmZlbmNlLmNvbnRleHQsIHJxKTsKKwlpZiAoZXJy
KQorCQlnb3RvIG91dF9hZGQ7CisKKwllcnIgPSBnZW44X2VtaXRfb2FfY29uZmlnKHJxLCBjZSwg
b2FfY29uZmlnLCBmYWxzZSk7CisKK291dF9hZGQ6CisJaTkxNV9yZXF1ZXN0X2FkZChycSk7CisJ
cmV0dXJuIGVycjsKK30KKworc3RhdGljIGludCBnZW44X21vZGlmeV9zZWxmKHN0cnVjdCBpbnRl
bF9jb250ZXh0ICpjZSwKKwkJCSAgICBjb25zdCBzdHJ1Y3QgaTkxNV9vYV9jb25maWcgKm9hX2Nv
bmZpZykKK3sKKwlzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycTsKKwlpbnQgZXJyOworCisJcnEgPSBp
OTE1X3JlcXVlc3RfY3JlYXRlKGNlKTsKKwlpZiAoSVNfRVJSKHJxKSkKKwkJcmV0dXJuIFBUUl9F
UlIocnEpOworCisJZXJyID0gZ2VuOF9lbWl0X29hX2NvbmZpZyhycSwgY2UsIG9hX2NvbmZpZywg
dHJ1ZSk7CisKKwlpOTE1X3JlcXVlc3RfYWRkKHJxKTsKKwlyZXR1cm4gZXJyOworfQorCiAvKgog
ICogTWFuYWdlcyB1cGRhdGluZyB0aGUgcGVyLWNvbnRleHQgYXNwZWN0cyBvZiB0aGUgT0Egc3Ry
ZWFtCiAgKiBjb25maWd1cmF0aW9uIGFjcm9zcyBhbGwgY29udGV4dHMuCkBAIC0xNzE2LDE1ICsx
ODYxLDE1IEBAIGdlbjhfdXBkYXRlX3JlZ19zdGF0ZV91bmxvY2tlZChzdHJ1Y3QgaW50ZWxfY29u
dGV4dCAqY2UsCiAgKgogICogTm90ZTogaXQncyBvbmx5IHRoZSBSQ1MvUmVuZGVyIGNvbnRleHQg
dGhhdCBoYXMgYW55IE9BIHN0YXRlLgogICovCi1zdGF0aWMgaW50IGdlbjhfY29uZmlndXJlX2Fs
bF9jb250ZXh0cyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYsCitzdGF0aWMgaW50
IGdlbjhfY29uZmlndXJlX2FsbF9jb250ZXh0cyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkx
NSwKIAkJCQkgICAgICAgY29uc3Qgc3RydWN0IGk5MTVfb2FfY29uZmlnICpvYV9jb25maWcpCiB7
Ci0JdW5zaWduZWQgaW50IG1hcF90eXBlID0gaTkxNV9jb2hlcmVudF9tYXBfdHlwZShkZXZfcHJp
dik7CiAJc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eDsKLQlzdHJ1Y3QgaTkxNV9yZXF1ZXN0
ICpycTsKLQlpbnQgcmV0OworCXN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZTsKKwllbnVt
IGludGVsX2VuZ2luZV9pZCBpZDsKKwlpbnQgZXJyOwogCi0JbG9ja2RlcF9hc3NlcnRfaGVsZCgm
ZGV2X3ByaXYtPmRybS5zdHJ1Y3RfbXV0ZXgpOworCWxvY2tkZXBfYXNzZXJ0X2hlbGQoJmk5MTUt
PmRybS5zdHJ1Y3RfbXV0ZXgpOwogCiAJLyoKIAkgKiBUaGUgT0EgcmVnaXN0ZXIgY29uZmlnIGlz
IHNldHVwIHRocm91Z2ggdGhlIGNvbnRleHQgaW1hZ2UuIFRoaXMgaW1hZ2UKQEAgLTE3MzUsNTkg
KzE4ODAsNDcgQEAgc3RhdGljIGludCBnZW44X2NvbmZpZ3VyZV9hbGxfY29udGV4dHMoc3RydWN0
IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2LAogCSAqIFdlIGNvdWxkIGVtaXQgdGhlIE9BIHJl
Z2lzdGVyIGNvbmZpZyB0aHJvdWdoIHRoZSBiYXRjaCBidWZmZXIgYnV0CiAJICogdGhpcyBtaWdo
dCBsZWF2ZSBzbWFsbCBpbnRlcnZhbCBvZiB0aW1lIHdoZXJlIHRoZSBPQSB1bml0IGlzCiAJICog
Y29uZmlndXJlZCBhdCBhbiBpbnZhbGlkIHNhbXBsaW5nIHBlcmlvZC4KLQkgKgotCSAqIFNvIGZh
ciB0aGUgYmVzdCB3YXkgdG8gd29yayBhcm91bmQgdGhpcyBpc3N1ZSBzZWVtcyB0byBiZSBkcmFp
bmluZwotCSAqIHRoZSBHUFUgZnJvbSBhbnkgc3VibWl0dGVkIHdvcmsuCiAJICovCi0JcmV0ID0g
aTkxNV9nZW1fd2FpdF9mb3JfaWRsZShkZXZfcHJpdiwKLQkJCQkgICAgIEk5MTVfV0FJVF9MT0NL
RUQsCi0JCQkJICAgICBNQVhfU0NIRURVTEVfVElNRU9VVCk7Ci0JaWYgKHJldCkKLQkJcmV0dXJu
IHJldDsKLQotCS8qIFVwZGF0ZSBhbGwgY29udGV4dHMgbm93IHRoYXQgd2UndmUgc3RhbGxlZCB0
aGUgc3VibWlzc2lvbi4gKi8KLQlsaXN0X2Zvcl9lYWNoX2VudHJ5KGN0eCwgJmRldl9wcml2LT5j
b250ZXh0cy5saXN0LCBsaW5rKSB7CisJbGlzdF9mb3JfZWFjaF9lbnRyeShjdHgsICZpOTE1LT5j
b250ZXh0cy5saXN0LCBsaW5rKSB7CiAJCXN0cnVjdCBpOTE1X2dlbV9lbmdpbmVzX2l0ZXIgaXQ7
CiAJCXN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZTsKIAogCQlmb3JfZWFjaF9nZW1fZW5naW5lKGNl
LAogCQkJCSAgICBpOTE1X2dlbV9jb250ZXh0X2xvY2tfZW5naW5lcyhjdHgpLAogCQkJCSAgICBp
dCkgewotCQkJdTMyICpyZWdzOwotCiAJCQlpZiAoY2UtPmVuZ2luZS0+Y2xhc3MgIT0gUkVOREVS
X0NMQVNTKQogCQkJCWNvbnRpbnVlOwogCi0JCQkvKiBPQSBzZXR0aW5ncyB3aWxsIGJlIHNldCB1
cG9uIGZpcnN0IHVzZSAqLwotCQkJaWYgKCFjZS0+c3RhdGUpCi0JCQkJY29udGludWU7Ci0KLQkJ
CXJlZ3MgPSBpOTE1X2dlbV9vYmplY3RfcGluX21hcChjZS0+c3RhdGUtPm9iaiwKLQkJCQkJCSAg
ICAgICBtYXBfdHlwZSk7Ci0JCQlpZiAoSVNfRVJSKHJlZ3MpKSB7Ci0JCQkJaTkxNV9nZW1fY29u
dGV4dF91bmxvY2tfZW5naW5lcyhjdHgpOwotCQkJCXJldHVybiBQVFJfRVJSKHJlZ3MpOwotCQkJ
fQotCi0JCQljZS0+c3RhdGUtPm9iai0+bW0uZGlydHkgPSB0cnVlOwotCQkJcmVncyArPSBMUkNf
U1RBVEVfUE4gKiBQQUdFX1NJWkUgLyBzaXplb2YoKnJlZ3MpOworCQkJZXJyID0gaW50ZWxfY29u
dGV4dF9sb2NrX3Bpbm5lZChjZSk7CisJCQlpZiAoZXJyKQorCQkJCWJyZWFrOwogCi0JCQlnZW44
X3VwZGF0ZV9yZWdfc3RhdGVfdW5sb2NrZWQoY2UsIHJlZ3MsIG9hX2NvbmZpZyk7CisJCQkvKiBP
dGhlcndpc2UgT0Egc2V0dGluZ3Mgd2lsbCBiZSBzZXQgdXBvbiBmaXJzdCB1c2UgKi8KKwkJCWlm
IChpbnRlbF9jb250ZXh0X2lzX3Bpbm5lZChjZSkpCisJCQkJZXJyID0gZ2VuOF9tb2RpZnlfY29u
dGV4dChjZSwgb2FfY29uZmlnKTsKIAotCQkJaTkxNV9nZW1fb2JqZWN0X3VucGluX21hcChjZS0+
c3RhdGUtPm9iaik7CisJCQlpbnRlbF9jb250ZXh0X3VubG9ja19waW5uZWQoY2UpOworCQkJaWYg
KGVycikKKwkJCQlicmVhazsKIAkJfQogCQlpOTE1X2dlbV9jb250ZXh0X3VubG9ja19lbmdpbmVz
KGN0eCk7CisJCWlmIChlcnIpCisJCQlyZXR1cm4gZXJyOwogCX0KIAogCS8qCi0JICogQXBwbHkg
dGhlIGNvbmZpZ3VyYXRpb24gYnkgZG9pbmcgb25lIGNvbnRleHQgcmVzdG9yZSBvZiB0aGUgZWRp
dGVkCi0JICogY29udGV4dCBpbWFnZS4KKwkgKiBBZnRlciB1cGRhdGluZyBhbGwgb3RoZXIgY29u
dGV4dHMsIHdlIG5lZWQgdG8gbW9kaWZ5IG91cnNlbHZlcy4KKwkgKiBJZiB3ZSBkb24ndCBtb2Rp
ZnkgdGhlIGtlcm5lbF9jb250ZXh0LCB3ZSBkbyBub3QgZ2V0IGV2ZW50cyB3aGlsZQorCSAqIGlk
bGUuCiAJICovCi0JcnEgPSBpOTE1X3JlcXVlc3RfY3JlYXRlKGRldl9wcml2LT5lbmdpbmVbUkNT
MF0tPmtlcm5lbF9jb250ZXh0KTsKLQlpZiAoSVNfRVJSKHJxKSkKLQkJcmV0dXJuIFBUUl9FUlIo
cnEpOworCWZvcl9lYWNoX2VuZ2luZShlbmdpbmUsIGk5MTUsIGlkKSB7CisJCWlmIChlbmdpbmUt
PmNsYXNzICE9IFJFTkRFUl9DTEFTUykKKwkJCWNvbnRpbnVlOwogCi0JaTkxNV9yZXF1ZXN0X2Fk
ZChycSk7CisJCWVyciA9IGdlbjhfbW9kaWZ5X3NlbGYoZW5naW5lLT5rZXJuZWxfY29udGV4dCwg
b2FfY29uZmlnKTsKKwkJaWYgKGVycikKKwkJCXJldHVybiBlcnI7CisJfQogCiAJcmV0dXJuIDA7
CiB9Ci0tIAoyLjIwLjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9w
Lm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVs
LWdmeA==

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 043B547AA4
	for <lists+intel-gfx@lfdr.de>; Mon, 17 Jun 2019 09:19:40 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 92C86891A8;
	Mon, 17 Jun 2019 07:19:37 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 87663891AB
 for <intel-gfx@lists.freedesktop.org>; Mon, 17 Jun 2019 07:19:36 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 16923038-1500050 
 for multiple; Mon, 17 Jun 2019 08:19:12 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 17 Jun 2019 08:18:53 +0100
Message-Id: <20190617071912.20256-3-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190617071912.20256-1-chris@chris-wilson.co.uk>
References: <20190617071912.20256-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 03/22] drm/i915: Skip shrinking already freed
 pages
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: matthew.auld@intel.com, mika.kuoppala@intel.com
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

UHJldmlvdXNseSwgd2Ugd2FudCB0byBzaHJpbmsgdGhlIHBhZ2VzIG9mIGZyZWVkIG9iamVjdHMg
YmVmb3JlIHRoZXkKd2VyZSBSQ1UgY29sbGVjdGVkLiBIb3dldmVyLCBieSByZW1vdmluZyB0aGUg
c3RydWN0X211dGV4IHNlcmlhbGlzYXRpb24KYXJvdW5kIHRoZSBhY3RpdmUgcmVmZXJlbmNlLCB3
ZSBuZWVkIHRvIGFjcXVpcmUgYW4gZXh0cmEgcmVmZXJlbmNlCmFyb3VuZCB0aGUgd2FpdC4gVW5m
b3J0dW5hdGVseSB0aGlzIG1lYW5zIHRoYXQgd2UgaGF2ZSB0byBza2lwIG9iamVjdHMKdGhhdCBh
cmUgd2FpdGluZyBSQ1UgY29sbGVjdGlvbi4KClNpZ25lZC1vZmYtYnk6IENocmlzIFdpbHNvbiA8
Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9p
OTE1X2dlbV9vYmplY3QuYyAgIHwgNDcgKy0tLS0tLS0tLS0tLS0tLS0tLS0KIGRyaXZlcnMvZ3B1
L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9zaHJpbmtlci5jIHwgIDUgKysrCiAyIGZpbGVzIGNoYW5n
ZWQsIDYgaW5zZXJ0aW9ucygrKSwgNDYgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX29iamVjdC5jIGIvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ2VtL2k5MTVfZ2VtX29iamVjdC5jCmluZGV4IGE0MDQ3YTU4NWM4Yi4uYmI1YjZlNjNhMmNj
IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fb2JqZWN0LmMK
KysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX29iamVjdC5jCkBAIC0xNDgs
MzMgKzE0OCw2IEBAIHZvaWQgaTkxNV9nZW1fY2xvc2Vfb2JqZWN0KHN0cnVjdCBkcm1fZ2VtX29i
amVjdCAqZ2VtLCBzdHJ1Y3QgZHJtX2ZpbGUgKmZpbGUpCiAJfQogfQogCi1zdGF0aWMgYm9vbCBk
aXNjYXJkX2JhY2tpbmdfc3RvcmFnZShzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqKQot
ewotCS8qCi0JICogSWYgd2UgYXJlIHRoZSBsYXN0IHVzZXIgb2YgdGhlIGJhY2tpbmcgc3RvcmFn
ZSAoYmUgaXQgc2htZW1mcwotCSAqIHBhZ2VzIG9yIHN0b2xlbiBldGMpLCB3ZSBrbm93IHRoYXQg
dGhlIHBhZ2VzIGFyZSBnb2luZyB0byBiZQotCSAqIGltbWVkaWF0ZWx5IHJlbGVhc2VkLiBJbiB0
aGlzIGNhc2UsIHdlIGNhbiB0aGVuIHNraXAgY29weWluZwotCSAqIGJhY2sgdGhlIGNvbnRlbnRz
IGZyb20gdGhlIEdQVS4KLQkgKi8KLQlpZiAoIWk5MTVfZ2VtX29iamVjdF9pc19zaHJpbmthYmxl
KG9iaikpCi0JCXJldHVybiBmYWxzZTsKLQotCWlmIChvYmotPm1tLm1hZHYgIT0gSTkxNV9NQURW
X1dJTExORUVEKQotCQlyZXR1cm4gZmFsc2U7Ci0KLQlpZiAoIW9iai0+YmFzZS5maWxwKQotCQly
ZXR1cm4gdHJ1ZTsKLQotCS8qIEF0IGZpcnN0IGdsYW5jZSwgdGhpcyBsb29rcyByYWN5LCBidXQg
dGhlbiBhZ2FpbiBzbyB3b3VsZCBiZQotCSAqIHVzZXJzcGFjZSByYWNpbmcgbW1hcCBhZ2FpbnN0
IGNsb3NlLiBIb3dldmVyLCB0aGUgZmlyc3QgZXh0ZXJuYWwKLQkgKiByZWZlcmVuY2UgdG8gdGhl
IGZpbHAgY2FuIG9ubHkgYmUgb2J0YWluZWQgdGhyb3VnaCB0aGUKLQkgKiBpOTE1X2dlbV9tbWFw
X2lvY3RsKCkgd2hpY2ggc2FmZWd1YXJkcyB1cyBhZ2FpbnN0IHRoZSB1c2VyCi0JICogYWNxdWly
aW5nIHN1Y2ggYSByZWZlcmVuY2Ugd2hpbHN0IHdlIGFyZSBpbiB0aGUgbWlkZGxlIG9mCi0JICog
ZnJlZWluZyB0aGUgb2JqZWN0LgotCSAqLwotCXJldHVybiBmaWxlX2NvdW50KG9iai0+YmFzZS5m
aWxwKSA9PSAxOwotfQotCiBzdGF0aWMgdm9pZCBfX2k5MTVfZ2VtX2ZyZWVfb2JqZWN0cyhzdHJ1
Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSwKIAkJCQkgICAgc3RydWN0IGxsaXN0X25vZGUgKmZy
ZWVkKQogewpAQCAtMjI0LDggKzE5Nyw3IEBAIHN0YXRpYyB2b2lkIF9faTkxNV9nZW1fZnJlZV9v
YmplY3RzKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1LAogCQlpZiAob2JqLT5vcHMtPnJl
bGVhc2UpCiAJCQlvYmotPm9wcy0+cmVsZWFzZShvYmopOwogCi0JCWlmIChXQVJOX09OKGk5MTVf
Z2VtX29iamVjdF9oYXNfcGlubmVkX3BhZ2VzKG9iaikpKQotCQkJYXRvbWljX3NldCgmb2JqLT5t
bS5wYWdlc19waW5fY291bnQsIDApOworCQlhdG9taWNfc2V0KCZvYmotPm1tLnBhZ2VzX3Bpbl9j
b3VudCwgMCk7CiAJCV9faTkxNV9nZW1fb2JqZWN0X3B1dF9wYWdlcyhvYmosIEk5MTVfTU1fTk9S
TUFMKTsKIAkJR0VNX0JVR19PTihpOTE1X2dlbV9vYmplY3RfaGFzX3BhZ2VzKG9iaikpOwogCkBA
IC0zMjMsMjMgKzI5NSw2IEBAIHZvaWQgaTkxNV9nZW1fZnJlZV9vYmplY3Qoc3RydWN0IGRybV9n
ZW1fb2JqZWN0ICpnZW1fb2JqKQogewogCXN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmog
PSB0b19pbnRlbF9ibyhnZW1fb2JqKTsKIAotCWlmIChvYmotPm1tLnF1aXJrZWQpCi0JCV9faTkx
NV9nZW1fb2JqZWN0X3VucGluX3BhZ2VzKG9iaik7Ci0KLQlpZiAoZGlzY2FyZF9iYWNraW5nX3N0
b3JhZ2Uob2JqKSkgewotCQlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSA9IHRvX2k5MTUo
b2JqLT5iYXNlLmRldik7Ci0KLQkJb2JqLT5tbS5tYWR2ID0gSTkxNV9NQURWX0RPTlRORUVEOwot
Ci0JCWlmIChpOTE1X2dlbV9vYmplY3RfaGFzX3BhZ2VzKG9iaikpIHsKLQkJCXVuc2lnbmVkIGxv
bmcgZmxhZ3M7Ci0KLQkJCXNwaW5fbG9ja19pcnFzYXZlKCZpOTE1LT5tbS5vYmpfbG9jaywgZmxh
Z3MpOwotCQkJbGlzdF9tb3ZlX3RhaWwoJm9iai0+bW0ubGluaywgJmk5MTUtPm1tLnB1cmdlX2xp
c3QpOwotCQkJc3Bpbl91bmxvY2tfaXJxcmVzdG9yZSgmaTkxNS0+bW0ub2JqX2xvY2ssIGZsYWdz
KTsKLQkJfQotCX0KLQogCS8qCiAJICogQmVmb3JlIHdlIGZyZWUgdGhlIG9iamVjdCwgbWFrZSBz
dXJlIGFueSBwdXJlIFJDVS1vbmx5CiAJICogcmVhZC1zaWRlIGNyaXRpY2FsIHNlY3Rpb25zIGFy
ZSBjb21wbGV0ZSwgZS5nLgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5
MTVfZ2VtX3Nocmlua2VyLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fc2hy
aW5rZXIuYwppbmRleCBjODUxYzQwMjk1OTcuLjNhOTI2YTg3NTVjNiAxMDA2NDQKLS0tIGEvZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3Nocmlua2VyLmMKKysrIGIvZHJpdmVycy9n
cHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3Nocmlua2VyLmMKQEAgLTI0MSw2ICsyNDEsOSBAQCBp
OTE1X2dlbV9zaHJpbmsoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUsCiAJCQlpZiAoIWNh
bl9yZWxlYXNlX3BhZ2VzKG9iaikpCiAJCQkJY29udGludWU7CiAKKwkJCWlmICgha3JlZl9nZXRf
dW5sZXNzX3plcm8oJm9iai0+YmFzZS5yZWZjb3VudCkpCisJCQkJY29udGludWU7CisKIAkJCXNw
aW5fdW5sb2NrX2lycXJlc3RvcmUoJmk5MTUtPm1tLm9ial9sb2NrLCBmbGFncyk7CiAKIAkJCWlm
ICh1bnNhZmVfZHJvcF9wYWdlcyhvYmopKSB7CkBAIC0yNTMsNyArMjU2LDkgQEAgaTkxNV9nZW1f
c2hyaW5rKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1LAogCQkJCX0KIAkJCQltdXRleF91
bmxvY2soJm9iai0+bW0ubG9jayk7CiAJCQl9CisKIAkJCXNjYW5uZWQgKz0gb2JqLT5iYXNlLnNp
emUgPj4gUEFHRV9TSElGVDsKKwkJCWk5MTVfZ2VtX29iamVjdF9wdXQob2JqKTsKIAogCQkJc3Bp
bl9sb2NrX2lycXNhdmUoJmk5MTUtPm1tLm9ial9sb2NrLCBmbGFncyk7CiAJCX0KLS0gCjIuMjAu
MQoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwt
Z2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8v
bGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

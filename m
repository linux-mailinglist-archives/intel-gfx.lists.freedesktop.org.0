Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id ECB99BB244
	for <lists+intel-gfx@lfdr.de>; Mon, 23 Sep 2019 12:30:29 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 19AC76E866;
	Mon, 23 Sep 2019 10:30:27 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mga03.intel.com (mga03.intel.com [134.134.136.65])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 8FAA66E854
 for <intel-gfx@lists.freedesktop.org>; Mon, 23 Sep 2019 10:30:16 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga008.jf.intel.com ([10.7.209.65])
 by orsmga103.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 23 Sep 2019 03:30:16 -0700
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.64,539,1559545200"; d="scan'208";a="182494692"
Received: from mrnaghsh-mobl1.amr.corp.intel.com (HELO
 dk-ThinkPad-X260.fios-router.home) ([10.254.177.243])
 by orsmga008.jf.intel.com with ESMTP; 23 Sep 2019 03:30:15 -0700
From: Dhinakaran Pandiyan <dhinakaran.pandiyan@intel.com>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 23 Sep 2019 03:29:35 -0700
Message-Id: <20190923102935.5860-10-dhinakaran.pandiyan@intel.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20190923102935.5860-1-dhinakaran.pandiyan@intel.com>
References: <20190923102935.5860-1-dhinakaran.pandiyan@intel.com>
MIME-Version: 1.0
Subject: [Intel-gfx] [RFC v3 9/9] Gen-12 display can decompress surfaces
 compressed by the media engine.
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Nanley G Chery <nanley.g.chery@intel.com>,
 Lucas De Marchi <lucas.demarchi@intel.com>,
 Dhinakaran Pandiyan <dhinakaran.pandiyan@intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

RGV0ZWN0IHRoZSBtb2RpZmllciBjb3JyZXNwb25kaW5nIHRvIG1lZGlhIGNvbXByZXNzaW9uIHRv
IGVuYWJsZQpkaXNwbGF5IGRlY29tcHJlc3Npb24gZm9yIFlVViBhbmQgeFJHQiBwYWNrZWQgZm9y
bWF0cy4gQSBuZXcgbW9kaWZpZXIgaXMKYWRkZWQgc28gdGhhdCB0aGUgZHJpdmVyIGNhbiBkaXN0
aW5ndWlzaCBiZXR3ZWVuIG1lZGlhIGFuZCByZW5kZXIKY29tcHJlc3NlZCBidWZmZXJzLiBVbmxp
a2UgcmVuZGVyIGRlY29tcHJlc3Npb24sIHBsYW5lIDYgYW5kICBwbGFuZSA3IGRvIG5vdApzdXBw
b3J0IG1lZGlhIGRlY29tcHJlc3Npb24uCgp2MjogRml4IGNoZWNrcGF0Y2ggd2FybmluZ3Mgb24g
Y29kZSBzdHlsZSAoTHVjYXMpCgpGcm9tIERLOgpTZXBhcmF0ZSBtb2RpZmllciBhcnJheSBmb3Ig
cGxhbmVzIHRoYXQgY2Fubm90IGRlY29tcHJlc3MgbWVkaWEgKFZpbGxlKQoKdjM6IFN1cHBvcnQg
cGxhbmFyIGZvcm1hdHMKCkNjOiBOYW5sZXkgRyBDaGVyeSA8bmFubGV5LmcuY2hlcnlAaW50ZWwu
Y29tPgpDYzogVmlsbGUgU3lyasOkbMOkIDx2aWxsZS5zeXJqYWxhQGxpbnV4LmludGVsLmNvbT4K
Q2M6IE1hdHQgUm9wZXIgPG1hdHRoZXcuZC5yb3BlckBpbnRlbC5jb20+ClNpZ25lZC1vZmYtYnk6
IERoaW5ha2FyYW4gUGFuZGl5YW4gPGRoaW5ha2FyYW4ucGFuZGl5YW5AaW50ZWwuY29tPgpTaWdu
ZWQtb2ZmLWJ5OiBMdWNhcyBEZSBNYXJjaGkgPGx1Y2FzLmRlbWFyY2hpQGludGVsLmNvbT4KLS0t
CiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9kaXNwbGF5L2ludGVsX2Rpc3BsYXkuYyAgfCAyMzkgKysr
KysrKysrKysrKy0tLS0tCiAuLi4vZHJtL2k5MTUvZGlzcGxheS9pbnRlbF9kaXNwbGF5X3R5cGVz
LmggICAgfCAgIDIgKy0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2Rpc3BsYXkvaW50ZWxfc3ByaXRl
LmMgICB8ICA0NCArKystCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3JlZy5oICAgICAgICAg
ICAgICAgfCAgIDEgKwogNCBmaWxlcyBjaGFuZ2VkLCAyMjIgaW5zZXJ0aW9ucygrKSwgNjQgZGVs
ZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZGlzcGxheS9pbnRl
bF9kaXNwbGF5LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9kaXNwbGF5L2ludGVsX2Rpc3BsYXku
YwppbmRleCA2ZjBmMzgxNTc2OTcuLmU1NWVmNzE1YjUzZCAxMDA2NDQKLS0tIGEvZHJpdmVycy9n
cHUvZHJtL2k5MTUvZGlzcGxheS9pbnRlbF9kaXNwbGF5LmMKKysrIGIvZHJpdmVycy9ncHUvZHJt
L2k5MTUvZGlzcGxheS9pbnRlbF9kaXNwbGF5LmMKQEAgLTE5MTEsNiArMTkxMSwxMCBAQCBpbnRl
bF90aWxlX3dpZHRoX2J5dGVzKGNvbnN0IHN0cnVjdCBkcm1fZnJhbWVidWZmZXIgKmZiLCBpbnQg
Y29sb3JfcGxhbmUpCiAJCWlmIChjb2xvcl9wbGFuZSA9PSAxKQogCQkJcmV0dXJuIDEyODsKIAkJ
LyogZmFsbCB0aHJvdWdoICovCisJY2FzZSBJOTE1X0ZPUk1BVF9NT0RfWV9USUxFRF9HRU4xMl9N
Q19DQ1M6CisJCWlmIChjb2xvcl9wbGFuZSA9PSAzKQorCQkJcmV0dXJuIDY0OworCQkvKiBmYWxs
IHRocm91Z2ggKi8KIAljYXNlIEk5MTVfRk9STUFUX01PRF9ZX1RJTEVEX0dFTjEyX1JDX0NDUzoK
IAkJaWYgKGNvbG9yX3BsYW5lID09IDEpCiAJCQlyZXR1cm4gNjQ7CkBAIC0yMjU2LDggKzIyNjAs
MTYgQEAgc3RhdGljIHUzMiBpbnRlbF9hZGp1c3RfdGlsZV9vZmZzZXQoaW50ICp4LCBpbnQgKnks
CiAKIHN0YXRpYyBib29sIGlzX3N1cmZhY2VfbGluZWFyKHU2NCBtb2RpZmllciwgaW50IGNvbG9y
X3BsYW5lKQogewotCXJldHVybiBtb2RpZmllciA9PSBEUk1fRk9STUFUX01PRF9MSU5FQVIgfHwK
LQkgICAgICAgKG1vZGlmaWVyID09IEk5MTVfRk9STUFUX01PRF9ZX1RJTEVEX0dFTjEyX1JDX0ND
UyAmJiBjb2xvcl9wbGFuZSA9PSAxKTsKKwlzd2l0Y2ggKG1vZGlmaWVyKSB7CisJY2FzZSBEUk1f
Rk9STUFUX01PRF9MSU5FQVI6CisJCXJldHVybiB0cnVlOworCWNhc2UgSTkxNV9GT1JNQVRfTU9E
X1lfVElMRURfR0VOMTJfUkNfQ0NTOgorCQlyZXR1cm4gY29sb3JfcGxhbmUgPT0gMTsKKwljYXNl
IEk5MTVfRk9STUFUX01PRF9ZX1RJTEVEX0dFTjEyX01DX0NDUzoKKwkJcmV0dXJuIGNvbG9yX3Bs
YW5lID09IDEgfHwgY29sb3JfcGxhbmUgPT0gMzsKKwlkZWZhdWx0OgorCQlyZXR1cm4gZmFsc2U7
CisJfQogfQogCiBzdGF0aWMgdTMyIGludGVsX2FkanVzdF9hbGlnbmVkX29mZnNldChpbnQgKngs
IGludCAqeSwKQEAgLTI0NDUsNiArMjQ1Nyw3IEBAIHN0YXRpYyB1bnNpZ25lZCBpbnQgaW50ZWxf
ZmJfbW9kaWZpZXJfdG9fdGlsaW5nKHU2NCBmYl9tb2RpZmllcikKIAljYXNlIEk5MTVfRk9STUFU
X01PRF9ZX1RJTEVEOgogCWNhc2UgSTkxNV9GT1JNQVRfTU9EX1lfVElMRURfQ0NTOgogCWNhc2Ug
STkxNV9GT1JNQVRfTU9EX1lfVElMRURfR0VOMTJfUkNfQ0NTOgorCWNhc2UgSTkxNV9GT1JNQVRf
TU9EX1lfVElMRURfR0VOMTJfTUNfQ0NTOgogCQlyZXR1cm4gSTkxNV9USUxJTkdfWTsKIAlkZWZh
dWx0OgogCQlyZXR1cm4gSTkxNV9USUxJTkdfTk9ORTsKQEAgLTI0OTIsNiArMjUwNSwxMCBAQCBz
dGF0aWMgY29uc3Qgc3RydWN0IGRybV9mb3JtYXRfaW5mbyBnZW4xMl9jY3NfZm9ybWF0c1tdID0g
ewogCSAgLmNwcCA9IHsgNCwgMSwgfSwgLmhzdWIgPSAyLCAudnN1YiA9IDMyLCAuaGFzX2FscGhh
ID0gdHJ1ZSB9LAogCXsgLmZvcm1hdCA9IERSTV9GT1JNQVRfQUJHUjg4ODgsIC5kZXB0aCA9IDMy
LCAubnVtX3BsYW5lcyA9IDIsCiAJICAuY3BwID0geyA0LCAxLCB9LCAuaHN1YiA9IDIsIC52c3Vi
ID0gMzIsIC5oYXNfYWxwaGEgPSB0cnVlIH0sCisJeyAuZm9ybWF0ID0gRFJNX0ZPUk1BVF9ZVVlW
LCAubnVtX3BsYW5lcyA9IDIsCisJICAuY3BwID0geyAyLCAxLCB9LCAuaHN1YiA9IDQsIC52c3Vi
ID0gMzIsIC5pc195dXYgPSB0cnVlIH0sCisJeyAuZm9ybWF0ID0gRFJNX0ZPUk1BVF9OVjEyLCAu
bnVtX3BsYW5lcyA9IDQsCisJICAuY3BwID0geyAxLCAxLCAyLCAxfSwgLmhzdWIgPSAyLCAudnN1
YiA9IDIsIC5pc195dXYgPSB0cnVlIH0sCiB9OwogCiBzdGF0aWMgY29uc3Qgc3RydWN0IGRybV9m
b3JtYXRfaW5mbyAqCkBAIC0yNTI5LDYgKzI1NDYsNyBAQCBpbnRlbF9nZXRfZm9ybWF0X2luZm8o
Y29uc3Qgc3RydWN0IGRybV9tb2RlX2ZiX2NtZDIgKmNtZCkKIGJvb2wgaXNfY2NzX21vZGlmaWVy
KHU2NCBtb2RpZmllcikKIHsKIAlyZXR1cm4gbW9kaWZpZXIgPT0gSTkxNV9GT1JNQVRfTU9EX1lf
VElMRURfR0VOMTJfUkNfQ0NTIHx8CisJICAgICAgIG1vZGlmaWVyID09IEk5MTVfRk9STUFUX01P
RF9ZX1RJTEVEX0dFTjEyX01DX0NDUyB8fAogCSAgICAgICBtb2RpZmllciA9PSBJOTE1X0ZPUk1B
VF9NT0RfWV9USUxFRF9DQ1MgfHwKIAkgICAgICAgbW9kaWZpZXIgPT0gSTkxNV9GT1JNQVRfTU9E
X1lmX1RJTEVEX0NDUzsKIH0KQEAgLTI1OTIsNyArMjYxMCw3IEBAIGludGVsX2ZiX3N0cmlkZV9h
bGlnbm1lbnQoY29uc3Qgc3RydWN0IGRybV9mcmFtZWJ1ZmZlciAqZmIsIGludCBjb2xvcl9wbGFu
ZSkKIAl9CiAKIAl0aWxlX3dpZHRoID0gaW50ZWxfdGlsZV93aWR0aF9ieXRlcyhmYiwgY29sb3Jf
cGxhbmUpOwotCWlmIChpc19jY3NfbW9kaWZpZXIoZmItPm1vZGlmaWVyKSAmJiBjb2xvcl9wbGFu
ZSA9PSAwKSB7CisJaWYgKGlzX2Njc19tb2RpZmllcihmYi0+bW9kaWZpZXIpKSB7CiAJCS8qCiAJ
CSAqIERpc3BsYXkgV0EgIzA1MzE6IHNrbCxieHQsa2JsLGdsawogCQkgKgpAQCAtMjYwMiw3ICsy
NjIwLDcgQEAgaW50ZWxfZmJfc3RyaWRlX2FsaWdubWVudChjb25zdCBzdHJ1Y3QgZHJtX2ZyYW1l
YnVmZmVyICpmYiwgaW50IGNvbG9yX3BsYW5lKQogCQkgKiByZXF1aXJlIHRoZSBlbnRpcmUgZmIg
dG8gYWNjb21tb2RhdGUgdGhhdCB0byBhdm9pZAogCQkgKiBwb3RlbnRpYWwgcnVudGltZSBlcnJv
cnMgYXQgcGxhbmUgY29uZmlndXJhdGlvbiB0aW1lLgogCQkgKi8KLQkJaWYgKElTX0dFTihkZXZf
cHJpdiwgOSkgJiYgZmItPndpZHRoID4gMzg0MCkKKwkJaWYgKElTX0dFTihkZXZfcHJpdiwgOSkg
JiYgY29sb3JfcGxhbmUgPT0gMCAmJiBmYi0+d2lkdGggPiAzODQwKQogCQkJdGlsZV93aWR0aCAq
PSA0OwogCQkvKgogCQkgKiBUaGUgbWFpbiBzdXJmYWNlIHBpdGNoIG11c3QgYmUgcGFkZGVkIHRv
IGEgbXVsdGlwbGUgb2YgZm91cgpAQCAtMjY4MiwyNSArMjcwMCw3MSBAQCBzdGF0aWMgYm9vbCBp
bnRlbF9wbGFuZV9uZWVkc19yZW1hcChjb25zdCBzdHJ1Y3QgaW50ZWxfcGxhbmVfc3RhdGUgKnBs
YW5lX3N0YXRlKQogCXJldHVybiBzdHJpZGUgPiBtYXhfc3RyaWRlOwogfQogCitzdGF0aWMgdm9p
ZAoraW50ZWxfZmJfcGxhbmVfZ2V0X3N1YnNhbXBsaW5nKGludCAqaHN1YiwgaW50ICp2c3ViLCBj
b25zdCBzdHJ1Y3QgZHJtX2ZyYW1lYnVmZmVyICpmYiwgaW50IGNvbG9yX3BsYW5lKQoreworCWlm
IChmYi0+bW9kaWZpZXIgPT0gSTkxNV9GT1JNQVRfTU9EX1lfVElMRURfR0VOMTJfTUNfQ0NTKSB7
CisJCXN0YXRpYyBjb25zdCBzdHJ1Y3QgeworCQkJaW50IGNwcFs0XTsKKwkJCWludCB2c3ViWzRd
OworCQkJaW50IGhzdWJbNF07CisJCX0gbWNfY2NzX3N1YnNhbXBsaW5nID0gey5jcHAgPSB7MSwg
MSwgMiwgMX0sIC5oc3ViID0gezEsIDgsIDIsIDE2fSwgLnZzdWIgPSB7MSwgMzIsIDIsIDMyfX07
CisKKwkJKmhzdWIgPSBtY19jY3Nfc3Vic2FtcGxpbmcuaHN1Yltjb2xvcl9wbGFuZV07CisJCSp2
c3ViID0gbWNfY2NzX3N1YnNhbXBsaW5nLnZzdWJbY29sb3JfcGxhbmVdOworCX0gZWxzZSB7CisJ
CSpoc3ViID0gZmItPmZvcm1hdC0+aHN1YjsKKwkJKnZzdWIgPSBmYi0+Zm9ybWF0LT52c3ViOwor
CX0KK30KKworc3RhdGljIHZvaWQKK2ludGVsX2ZiX3BsYW5lX2RpbXMoaW50ICp3LCBpbnQgKmgs
IHN0cnVjdCBkcm1fZnJhbWVidWZmZXIgKmZiLCBpbnQgY29sb3JfcGxhbmUpCit7CisJaW50IGhz
dWIsIHZzdWI7CisKKwlpbnRlbF9mYl9wbGFuZV9nZXRfc3Vic2FtcGxpbmcoJmhzdWIsICZ2c3Vi
LCBmYiwgY29sb3JfcGxhbmUpOworCSp3ID0gZmItPndpZHRoL2hzdWI7CisJKmggPSBmYi0+aGVp
Z2h0L3ZzdWI7Cit9CisKK3N0YXRpYyBib29sIGlzX2Njc19wbGFuZSh1NjQgbW9kaWZpZXIsIGlu
dCBjb2xvcl9wbGFuZSkKK3sKKwlpZiAoIWlzX2Njc19tb2RpZmllcihtb2RpZmllcikpCisJCXJl
dHVybiBmYWxzZTsKKwllbHNlIGlmIChtb2RpZmllciA9PSBJOTE1X0ZPUk1BVF9NT0RfWV9USUxF
RF9HRU4xMl9NQ19DQ1MpCisJCXJldHVybiBjb2xvcl9wbGFuZSA9PSAzIHx8IGNvbG9yX3BsYW5l
ID09IDE7CisJZWxzZQorCQlyZXR1cm4gY29sb3JfcGxhbmUgPT0gMTsKK30KKwogc3RhdGljIGlu
dAotaW50ZWxfZmJfY2hlY2tfY2NzX3h5KHN0cnVjdCBkcm1fZnJhbWVidWZmZXIgKmZiLCBpbnQg
eCwgaW50IHkpCitpbnRlbF9mYl9jaGVja19jY3NfeHkoc3RydWN0IGRybV9mcmFtZWJ1ZmZlciAq
ZmIsIGludCBjb2xvcl9wbGFuZSwgaW50IHgsIGludCB5KQogewogCXN0cnVjdCBpbnRlbF9mcmFt
ZWJ1ZmZlciAqaW50ZWxfZmIgPSB0b19pbnRlbF9mcmFtZWJ1ZmZlcihmYik7Ci0JaW50IGhzdWIg
PSBmYi0+Zm9ybWF0LT5oc3ViOwotCWludCB2c3ViID0gZmItPmZvcm1hdC0+dnN1YjsKKwlpbnQg
aHN1YiwgdnN1YjsKKwlpbnQgaHN1Yl9tYWluLCB2c3ViX21haW47CiAJaW50IHRpbGVfd2lkdGgs
IHRpbGVfaGVpZ2h0OwogCWludCBjY3NfeCwgY2NzX3k7CiAJaW50IG1haW5feCwgbWFpbl95Owog
Ci0JaW50ZWxfdGlsZV9kaW1zKGZiLCAxLCAmdGlsZV93aWR0aCwgJnRpbGVfaGVpZ2h0KTsKKwlp
ZiAoIWlzX2Njc19wbGFuZShmYi0+bW9kaWZpZXIsIGNvbG9yX3BsYW5lKSkKKwkJcmV0dXJuIDA7
CisKKwlpbnRlbF90aWxlX2RpbXMoZmIsIGNvbG9yX3BsYW5lLCAmdGlsZV93aWR0aCwgJnRpbGVf
aGVpZ2h0KTsKKwlpbnRlbF9mYl9wbGFuZV9nZXRfc3Vic2FtcGxpbmcoJmhzdWIsICZ2c3ViLCBm
YiwgY29sb3JfcGxhbmUpOworCWludGVsX2ZiX3BsYW5lX2dldF9zdWJzYW1wbGluZygmaHN1Yl9t
YWluLCAmdnN1Yl9tYWluLCBmYiwgY29sb3JfcGxhbmUgLSAxKTsKKworCWhzdWIgLz0gaHN1Yl9t
YWluOworCXZzdWIgLz0gdnN1Yl9tYWluOwogCiAJdGlsZV93aWR0aCAqPSBoc3ViOwogCXRpbGVf
aGVpZ2h0ICo9IHZzdWI7CiAKIAljY3NfeCA9ICh4ICogaHN1YikgJSB0aWxlX3dpZHRoOwogCWNj
c195ID0gKHkgKiB2c3ViKSAlIHRpbGVfaGVpZ2h0OwotCW1haW5feCA9IGludGVsX2ZiLT5ub3Jt
YWxbMF0ueCAlIHRpbGVfd2lkdGg7Ci0JbWFpbl95ID0gaW50ZWxfZmItPm5vcm1hbFswXS55ICUg
dGlsZV9oZWlnaHQ7CisJbWFpbl94ID0gaW50ZWxfZmItPm5vcm1hbFtjb2xvcl9wbGFuZSAtIDFd
LnggJSB0aWxlX3dpZHRoOworCW1haW5feSA9IGludGVsX2ZiLT5ub3JtYWxbY29sb3JfcGxhbmUg
LSAxXS55ICUgdGlsZV9oZWlnaHQ7CiAKIAkvKgogCSogQ0NTIGRvZXNuJ3QgaGF2ZSBpdHMgb3du
IHgveSBvZmZzZXQgcmVnaXN0ZXIsIHNvIHRoZSBpbnRyYSBDQ1MgdGlsZQpAQCAtMjcxMCw4ICsy
Nzc0LDggQEAgaW50ZWxfZmJfY2hlY2tfY2NzX3h5KHN0cnVjdCBkcm1fZnJhbWVidWZmZXIgKmZi
LCBpbnQgeCwgaW50IHkpCiAJCURSTV9ERUJVR19LTVMoIkJhZCBDQ1MgeC95IChtYWluICVkLCVk
IGNjcyAlZCwlZCkgZnVsbCAobWFpbiAlZCwlZCBjY3MgJWQsJWQpXG4iLAogCQkJICAgICAgbWFp
bl94LCBtYWluX3ksCiAJCQkgICAgICBjY3NfeCwgY2NzX3ksCi0JCQkgICAgICBpbnRlbF9mYi0+
bm9ybWFsWzBdLngsCi0JCQkgICAgICBpbnRlbF9mYi0+bm9ybWFsWzBdLnksCisJCQkgICAgICBp
bnRlbF9mYi0+bm9ybWFsW2NvbG9yX3BsYW5lIC0gMV0ueCwKKwkJCSAgICAgIGludGVsX2ZiLT5u
b3JtYWxbY29sb3JfcGxhbmUgLSAxXS55LAogCQkJICAgICAgeCwgeSk7CiAJCXJldHVybiAtRUlO
VkFMOwogCX0KQEAgLTI3MzksOCArMjgwMyw3IEBAIGludGVsX2ZpbGxfZmJfaW5mbyhzdHJ1Y3Qg
ZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYsCiAJCWludCByZXQ7CiAKIAkJY3BwID0gZmItPmZv
cm1hdC0+Y3BwW2ldOwotCQl3aWR0aCA9IGRybV9mcmFtZWJ1ZmZlcl9wbGFuZV93aWR0aChmYi0+
d2lkdGgsIGZiLCBpKTsKLQkJaGVpZ2h0ID0gZHJtX2ZyYW1lYnVmZmVyX3BsYW5lX2hlaWdodChm
Yi0+aGVpZ2h0LCBmYiwgaSk7CisJCWludGVsX2ZiX3BsYW5lX2RpbXMoJndpZHRoLCAmaGVpZ2h0
LCBmYiwgaSk7CiAKIAkJcmV0ID0gaW50ZWxfZmJfb2Zmc2V0X3RvX3h5KCZ4LCAmeSwgZmIsIGkp
OwogCQlpZiAocmV0KSB7CkBAIC0yNzQ5LDExICsyODEyLDkgQEAgaW50ZWxfZmlsbF9mYl9pbmZv
KHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiwKIAkJCXJldHVybiByZXQ7CiAJCX0K
IAotCQlpZiAoaXNfY2NzX21vZGlmaWVyKGZiLT5tb2RpZmllcikgJiYgaSA9PSAxKSB7Ci0JCQly
ZXQgPSBpbnRlbF9mYl9jaGVja19jY3NfeHkoZmIsIHgsIHkpOwotCQkJaWYgKHJldCkKLQkJCQly
ZXR1cm4gcmV0OwotCQl9CisJCXJldCA9IGludGVsX2ZiX2NoZWNrX2Njc194eShmYiwgaSwgeCwg
eSk7CisJCWlmIChyZXQpCisJCQlyZXR1cm4gcmV0OwogCiAJCS8qCiAJCSAqIFRoZSBmZW5jZSAo
aWYgdXNlZCkgaXMgYWxpZ25lZCB0byB0aGUgc3RhcnQgb2YgdGhlIG9iamVjdApAQCAtMzM3MSw2
ICszNDMyLDcgQEAgc3RhdGljIGludCBza2xfbWF4X3BsYW5lX3dpZHRoKGNvbnN0IHN0cnVjdCBk
cm1fZnJhbWVidWZmZXIgKmZiLAogCQkJcmV0dXJuIDUxMjA7CiAJY2FzZSBJOTE1X0ZPUk1BVF9N
T0RfWV9USUxFRF9DQ1M6CiAJY2FzZSBJOTE1X0ZPUk1BVF9NT0RfWWZfVElMRURfQ0NTOgorCWNh
c2UgSTkxNV9GT1JNQVRfTU9EX1lfVElMRURfR0VOMTJfTUNfQ0NTOgogCQkvKiBGSVhNRSBBVVgg
cGxhbmU/ICovCiAJY2FzZSBJOTE1X0ZPUk1BVF9NT0RfWV9USUxFRDoKIAljYXNlIEk5MTVfRk9S
TUFUX01PRF9ZZl9USUxFRDoKQEAgLTM0MzAsMTYgKzM0OTIsMTggQEAgc3RhdGljIGludCBpY2xf
bWF4X3BsYW5lX2hlaWdodCh2b2lkKQogfQogCiBzdGF0aWMgYm9vbCBza2xfY2hlY2tfbWFpbl9j
Y3NfY29vcmRpbmF0ZXMoc3RydWN0IGludGVsX3BsYW5lX3N0YXRlICpwbGFuZV9zdGF0ZSwKLQkJ
CQkJICAgaW50IG1haW5feCwgaW50IG1haW5feSwgdTMyIG1haW5fb2Zmc2V0KQorCQkJCQkgICBp
bnQgbWFpbl94LCBpbnQgbWFpbl95LCB1MzIgbWFpbl9vZmZzZXQsCisJCQkJCSAgIGludCBhdXhf
cGxhbmUpCiB7CiAJY29uc3Qgc3RydWN0IGRybV9mcmFtZWJ1ZmZlciAqZmIgPSBwbGFuZV9zdGF0
ZS0+YmFzZS5mYjsKLQlpbnQgaHN1YiA9IGZiLT5mb3JtYXQtPmhzdWI7Ci0JaW50IHZzdWIgPSBm
Yi0+Zm9ybWF0LT52c3ViOwotCWludCBhdXhfeCA9IHBsYW5lX3N0YXRlLT5jb2xvcl9wbGFuZVsx
XS54OwotCWludCBhdXhfeSA9IHBsYW5lX3N0YXRlLT5jb2xvcl9wbGFuZVsxXS55OwotCXUzMiBh
dXhfb2Zmc2V0ID0gcGxhbmVfc3RhdGUtPmNvbG9yX3BsYW5lWzFdLm9mZnNldDsKLQl1MzIgYWxp
Z25tZW50ID0gaW50ZWxfc3VyZl9hbGlnbm1lbnQoZmIsIDEpOwotCisJaW50IGhzdWI7CisJaW50
IHZzdWI7CisJaW50IGF1eF94ID0gcGxhbmVfc3RhdGUtPmNvbG9yX3BsYW5lW2F1eF9wbGFuZV0u
eDsKKwlpbnQgYXV4X3kgPSBwbGFuZV9zdGF0ZS0+Y29sb3JfcGxhbmVbYXV4X3BsYW5lXS55Owor
CXUzMiBhdXhfb2Zmc2V0ID0gcGxhbmVfc3RhdGUtPmNvbG9yX3BsYW5lW2F1eF9wbGFuZV0ub2Zm
c2V0OworCXUzMiBhbGlnbm1lbnQgPSBpbnRlbF9zdXJmX2FsaWdubWVudChmYiwgYXV4X3BsYW5l
KTsKKworCWludGVsX2ZiX3BsYW5lX2dldF9zdWJzYW1wbGluZygmaHN1YiwgJnZzdWIsIGZiLCBh
dXhfcGxhbmUpOwogCXdoaWxlIChhdXhfb2Zmc2V0ID49IG1haW5fb2Zmc2V0ICYmIGF1eF95IDw9
IG1haW5feSkgewogCQlpbnQgeCwgeTsKIApAQCAtMzQ1MSw3ICszNTE1LDcgQEAgc3RhdGljIGJv
b2wgc2tsX2NoZWNrX21haW5fY2NzX2Nvb3JkaW5hdGVzKHN0cnVjdCBpbnRlbF9wbGFuZV9zdGF0
ZSAqcGxhbmVfc3RhdGUKIAogCQl4ID0gYXV4X3ggLyBoc3ViOwogCQl5ID0gYXV4X3kgLyB2c3Vi
OwotCQlhdXhfb2Zmc2V0ID0gaW50ZWxfcGxhbmVfYWRqdXN0X2FsaWduZWRfb2Zmc2V0KCZ4LCAm
eSwgcGxhbmVfc3RhdGUsIDEsCisJCWF1eF9vZmZzZXQgPSBpbnRlbF9wbGFuZV9hZGp1c3RfYWxp
Z25lZF9vZmZzZXQoJngsICZ5LCBwbGFuZV9zdGF0ZSwgYXV4X3BsYW5lLAogCQkJCQkJCSAgICAg
ICBhdXhfb2Zmc2V0LCBhdXhfb2Zmc2V0IC0gYWxpZ25tZW50KTsKIAkJYXV4X3ggPSB4ICogaHN1
YiArIGF1eF94ICUgaHN1YjsKIAkJYXV4X3kgPSB5ICogdnN1YiArIGF1eF95ICUgdnN1YjsKQEAg
LTM0NjAsOSArMzUyNCw5IEBAIHN0YXRpYyBib29sIHNrbF9jaGVja19tYWluX2Njc19jb29yZGlu
YXRlcyhzdHJ1Y3QgaW50ZWxfcGxhbmVfc3RhdGUgKnBsYW5lX3N0YXRlCiAJaWYgKGF1eF94ICE9
IG1haW5feCB8fCBhdXhfeSAhPSBtYWluX3kpCiAJCXJldHVybiBmYWxzZTsKIAotCXBsYW5lX3N0
YXRlLT5jb2xvcl9wbGFuZVsxXS5vZmZzZXQgPSBhdXhfb2Zmc2V0OwotCXBsYW5lX3N0YXRlLT5j
b2xvcl9wbGFuZVsxXS54ID0gYXV4X3g7Ci0JcGxhbmVfc3RhdGUtPmNvbG9yX3BsYW5lWzFdLnkg
PSBhdXhfeTsKKwlwbGFuZV9zdGF0ZS0+Y29sb3JfcGxhbmVbYXV4X3BsYW5lXS5vZmZzZXQgPSBh
dXhfb2Zmc2V0OworCXBsYW5lX3N0YXRlLT5jb2xvcl9wbGFuZVthdXhfcGxhbmVdLnggPSBhdXhf
eDsKKwlwbGFuZV9zdGF0ZS0+Y29sb3JfcGxhbmVbYXV4X3BsYW5lXS55ID0gYXV4X3k7CiAKIAly
ZXR1cm4gdHJ1ZTsKIH0KQEAgLTM1MzYsNyArMzYwMCw3IEBAIHN0YXRpYyBpbnQgc2tsX2NoZWNr
X21haW5fc3VyZmFjZShzdHJ1Y3QgaW50ZWxfcGxhbmVfc3RhdGUgKnBsYW5lX3N0YXRlKQogCSAq
IHRoZXkgbWF0Y2ggd2l0aCB0aGUgbWFpbiBzdXJmYWNlIHgveSBvZmZzZXRzLgogCSAqLwogCWlm
IChpc19jY3NfbW9kaWZpZXIoZmItPm1vZGlmaWVyKSkgewotCQl3aGlsZSAoIXNrbF9jaGVja19t
YWluX2Njc19jb29yZGluYXRlcyhwbGFuZV9zdGF0ZSwgeCwgeSwgb2Zmc2V0KSkgeworCQl3aGls
ZSAoIXNrbF9jaGVja19tYWluX2Njc19jb29yZGluYXRlcyhwbGFuZV9zdGF0ZSwgeCwgeSwgb2Zm
c2V0LCAxKSkgewogCQkJaWYgKG9mZnNldCA9PSAwKQogCQkJCWJyZWFrOwogCkBAIC0zNTY5LDcg
KzM2MzMsOCBAQCBzdGF0aWMgaW50IHNrbF9jaGVja19udjEyX2F1eF9zdXJmYWNlKHN0cnVjdCBp
bnRlbF9wbGFuZV9zdGF0ZSAqcGxhbmVfc3RhdGUpCiB7CiAJY29uc3Qgc3RydWN0IGRybV9mcmFt
ZWJ1ZmZlciAqZmIgPSBwbGFuZV9zdGF0ZS0+YmFzZS5mYjsKIAl1bnNpZ25lZCBpbnQgcm90YXRp
b24gPSBwbGFuZV9zdGF0ZS0+YmFzZS5yb3RhdGlvbjsKLQlpbnQgbWF4X3dpZHRoID0gc2tsX21h
eF9wbGFuZV93aWR0aChmYiwgMSwgcm90YXRpb24pOworCWludCB1diA9IGlzX2Njc19tb2RpZmll
cihmYi0+bW9kaWZpZXIpID8gMiA6IDE7CisJaW50IG1heF93aWR0aCA9IHNrbF9tYXhfcGxhbmVf
d2lkdGgoZmIsIHV2LCByb3RhdGlvbik7CiAJaW50IG1heF9oZWlnaHQgPSA0MDk2OwogCWludCB4
ID0gcGxhbmVfc3RhdGUtPmJhc2Uuc3JjLngxID4+IDE3OwogCWludCB5ID0gcGxhbmVfc3RhdGUt
PmJhc2Uuc3JjLnkxID4+IDE3OwpAQCAtMzU3Nyw4ICszNjQyLDggQEAgc3RhdGljIGludCBza2xf
Y2hlY2tfbnYxMl9hdXhfc3VyZmFjZShzdHJ1Y3QgaW50ZWxfcGxhbmVfc3RhdGUgKnBsYW5lX3N0
YXRlKQogCWludCBoID0gZHJtX3JlY3RfaGVpZ2h0KCZwbGFuZV9zdGF0ZS0+YmFzZS5zcmMpID4+
IDE3OwogCXUzMiBvZmZzZXQ7CiAKLQlpbnRlbF9hZGRfZmJfb2Zmc2V0cygmeCwgJnksIHBsYW5l
X3N0YXRlLCAxKTsKLQlvZmZzZXQgPSBpbnRlbF9wbGFuZV9jb21wdXRlX2FsaWduZWRfb2Zmc2V0
KCZ4LCAmeSwgcGxhbmVfc3RhdGUsIDEpOworCWludGVsX2FkZF9mYl9vZmZzZXRzKCZ4LCAmeSwg
cGxhbmVfc3RhdGUsIHV2KTsKKwlvZmZzZXQgPSBpbnRlbF9wbGFuZV9jb21wdXRlX2FsaWduZWRf
b2Zmc2V0KCZ4LCAmeSwgcGxhbmVfc3RhdGUsIHV2KTsKIAogCS8qIEZJWE1FIG5vdCBxdWl0ZSBz
dXJlIGhvdy9pZiB0aGVzZSBhcHBseSB0byB0aGUgY2hyb21hIHBsYW5lICovCiAJaWYgKHcgPiBt
YXhfd2lkdGggfHwgaCA+IG1heF9oZWlnaHQpIHsKQEAgLTM1ODcsOSArMzY1Miw0MyBAQCBzdGF0
aWMgaW50IHNrbF9jaGVja19udjEyX2F1eF9zdXJmYWNlKHN0cnVjdCBpbnRlbF9wbGFuZV9zdGF0
ZSAqcGxhbmVfc3RhdGUpCiAJCXJldHVybiAtRUlOVkFMOwogCX0KIAotCXBsYW5lX3N0YXRlLT5j
b2xvcl9wbGFuZVsxXS5vZmZzZXQgPSBvZmZzZXQ7Ci0JcGxhbmVfc3RhdGUtPmNvbG9yX3BsYW5l
WzFdLnggPSB4OwotCXBsYW5lX3N0YXRlLT5jb2xvcl9wbGFuZVsxXS55ID0geTsKKwlpZiAoaXNf
Y2NzX21vZGlmaWVyKGZiLT5tb2RpZmllcikpIHsKKwkJaW50IGF1eF9vZmZzZXQgPSBwbGFuZV9z
dGF0ZS0+Y29sb3JfcGxhbmVbM10ub2Zmc2V0OworCQlpbnQgYWxpZ25tZW50ID0gaW50ZWxfc3Vy
Zl9hbGlnbm1lbnQoZmIsIHV2KTsKKworCQlpZiAob2Zmc2V0ID4gYXV4X29mZnNldCkgeworCQkJ
aW50IGhzdWIsIHZzdWI7CisJCQlpbnQgbWFpbl94ID0geCwgbWFpbl95ID0geTsKKworCisJCQlp
bnRlbF9mYl9wbGFuZV9nZXRfc3Vic2FtcGxpbmcoJmhzdWIsICZ2c3ViLCBmYiwgdXYpOworCQkJ
eCA9IG1haW5feCAvIGhzdWI7CisJCQl5ID0gbWFpbl95IC8gdnN1YjsKKwkJCW9mZnNldCA9IGlu
dGVsX3BsYW5lX2FkanVzdF9hbGlnbmVkX29mZnNldCgmeCwgJnksIHBsYW5lX3N0YXRlLCB1diwK
KwkJCQkJCQkJICAgb2Zmc2V0LAorCQkJCQkJCQkgICBhdXhfb2Zmc2V0ICYgfihhbGlnbm1lbnQg
LSAxKSk7CisJCQl4ID0geCAqIGhzdWIgKyBtYWluX3ggJSBoc3ViOworCQkJeSA9IHkgKiB2c3Vi
ICsgbWFpbl95ICUgdnN1YjsKKworCQl9CisKKwkJd2hpbGUgKCFza2xfY2hlY2tfbWFpbl9jY3Nf
Y29vcmRpbmF0ZXMocGxhbmVfc3RhdGUsIHgsIHksIG9mZnNldCwgMykpIHsKKwkJCWlmIChvZmZz
ZXQgPT0gMCkKKwkJCQlicmVhazsKKworCQkJb2Zmc2V0ID0gaW50ZWxfcGxhbmVfYWRqdXN0X2Fs
aWduZWRfb2Zmc2V0KCZ4LCAmeSwgcGxhbmVfc3RhdGUsIHV2LAorCQkJCQkJCQkgICBvZmZzZXQs
IG9mZnNldCAtIGFsaWdubWVudCk7CisJCX0KKworCQlpZiAoeCAhPSBwbGFuZV9zdGF0ZS0+Y29s
b3JfcGxhbmVbM10ueCB8fCB5ICE9IHBsYW5lX3N0YXRlLT5jb2xvcl9wbGFuZVszXS55KSB7CisJ
CQlEUk1fREVCVUdfS01TKCJVbmFibGUgdG8gZmluZCBzdWl0YWJsZSBkaXNwbGF5IHN1cmZhY2Ug
b2Zmc2V0IGR1ZSB0byBDQ1NcbiIpOworCQkJcmV0dXJuIC1FSU5WQUw7CisJCX0KKwl9CisKKwlw
bGFuZV9zdGF0ZS0+Y29sb3JfcGxhbmVbdXZdLm9mZnNldCA9IG9mZnNldDsKKwlwbGFuZV9zdGF0
ZS0+Y29sb3JfcGxhbmVbdXZdLnggPSB4OworCXBsYW5lX3N0YXRlLT5jb2xvcl9wbGFuZVt1dl0u
eSA9IHk7CiAKIAlyZXR1cm4gMDsKIH0KQEAgLTM1OTksMTkgKzM2OTgsMzAgQEAgc3RhdGljIGlu
dCBza2xfY2hlY2tfY2NzX2F1eF9zdXJmYWNlKHN0cnVjdCBpbnRlbF9wbGFuZV9zdGF0ZSAqcGxh
bmVfc3RhdGUpCiAJY29uc3Qgc3RydWN0IGRybV9mcmFtZWJ1ZmZlciAqZmIgPSBwbGFuZV9zdGF0
ZS0+YmFzZS5mYjsKIAlpbnQgc3JjX3ggPSBwbGFuZV9zdGF0ZS0+YmFzZS5zcmMueDEgPj4gMTY7
CiAJaW50IHNyY195ID0gcGxhbmVfc3RhdGUtPmJhc2Uuc3JjLnkxID4+IDE2OwotCWludCBoc3Vi
ID0gZmItPmZvcm1hdC0+aHN1YjsKLQlpbnQgdnN1YiA9IGZiLT5mb3JtYXQtPnZzdWI7Ci0JaW50
IHggPSBzcmNfeCAvIGhzdWI7Ci0JaW50IHkgPSBzcmNfeSAvIHZzdWI7CiAJdTMyIG9mZnNldDsK
KwlpbnQgY2NzOworCiAKLQlpbnRlbF9hZGRfZmJfb2Zmc2V0cygmeCwgJnksIHBsYW5lX3N0YXRl
LCAxKTsKLQlvZmZzZXQgPSBpbnRlbF9wbGFuZV9jb21wdXRlX2FsaWduZWRfb2Zmc2V0KCZ4LCAm
eSwgcGxhbmVfc3RhdGUsIDEpOworCWZvciAoY2NzID0gMTsgY2NzIDwgZmItPmZvcm1hdC0+bnVt
X3BsYW5lczsgY2NzICs9IDIpIHsKKwkJaW50IGhzdWIsIHZzdWI7CisJCWludCBtYWluX2hzdWIs
IG1haW5fdnN1YjsKKwkJaW50IHgsIHk7CiAKLQlwbGFuZV9zdGF0ZS0+Y29sb3JfcGxhbmVbMV0u
b2Zmc2V0ID0gb2Zmc2V0OwotCXBsYW5lX3N0YXRlLT5jb2xvcl9wbGFuZVsxXS54ID0geCAqIGhz
dWIgKyBzcmNfeCAlIGhzdWI7Ci0JcGxhbmVfc3RhdGUtPmNvbG9yX3BsYW5lWzFdLnkgPSB5ICog
dnN1YiArIHNyY195ICUgdnN1YjsKKwkJaW50ZWxfZmJfcGxhbmVfZ2V0X3N1YnNhbXBsaW5nKCZo
c3ViLCAmdnN1YiwgZmIsIGNjcyk7CisJCWludGVsX2ZiX3BsYW5lX2dldF9zdWJzYW1wbGluZygm
bWFpbl9oc3ViLCAmbWFpbl92c3ViLCBmYiwgY2NzIC0gMSk7CiAKKwkJaHN1YiAvPSBtYWluX2hz
dWI7CisJCXZzdWIgLz0gbWFpbl92c3ViOworCQl4ID0gc3JjX3ggLyBoc3ViOworCQl5ID0gc3Jj
X3kgLyB2c3ViOworCisJCWludGVsX2FkZF9mYl9vZmZzZXRzKCZ4LCAmeSwgcGxhbmVfc3RhdGUs
IGNjcyk7CisJCW9mZnNldCA9IGludGVsX3BsYW5lX2NvbXB1dGVfYWxpZ25lZF9vZmZzZXQoJngs
ICZ5LAorCQkJCQkJCSAgICBwbGFuZV9zdGF0ZSwgY2NzKTsKKwkJcGxhbmVfc3RhdGUtPmNvbG9y
X3BsYW5lW2Njc10ub2Zmc2V0ID0gb2Zmc2V0OworCQlwbGFuZV9zdGF0ZS0+Y29sb3JfcGxhbmVb
Y2NzXS54ID0geCAqIGhzdWIgKyBzcmNfeCAlIGhzdWI7CisJCXBsYW5lX3N0YXRlLT5jb2xvcl9w
bGFuZVtjY3NdLnkgPSB5ICogdnN1YiArIHNyY195ICUgdnN1YjsKKwl9CiAJcmV0dXJuIDA7CiB9
CiAKQEAgLTM2MTksNiArMzcyOSw3IEBAIGludCBza2xfY2hlY2tfcGxhbmVfc3VyZmFjZShzdHJ1
Y3QgaW50ZWxfcGxhbmVfc3RhdGUgKnBsYW5lX3N0YXRlKQogewogCWNvbnN0IHN0cnVjdCBkcm1f
ZnJhbWVidWZmZXIgKmZiID0gcGxhbmVfc3RhdGUtPmJhc2UuZmI7CiAJaW50IHJldDsKKwlib29s
IG5lZWRzX2F1eCA9IGZhbHNlOwogCiAJcmV0ID0gaW50ZWxfcGxhbmVfY29tcHV0ZV9ndHQocGxh
bmVfc3RhdGUpOwogCWlmIChyZXQpCkBAIC0zNjI4LDIxICszNzM5LDMxIEBAIGludCBza2xfY2hl
Y2tfcGxhbmVfc3VyZmFjZShzdHJ1Y3QgaW50ZWxfcGxhbmVfc3RhdGUgKnBsYW5lX3N0YXRlKQog
CQlyZXR1cm4gMDsKIAogCS8qCi0JICogSGFuZGxlIHRoZSBBVVggc3VyZmFjZSBmaXJzdCBzaW5j
ZQotCSAqIHRoZSBtYWluIHN1cmZhY2Ugc2V0dXAgZGVwZW5kcyBvbiBpdC4KKwkgKiBIYW5kbGUg
dGhlIEFVWCBzdXJmYWNlIGZpcnN0IHNpbmNlIHRoZSBtYWluIHN1cmZhY2Ugc2V0dXAgZGVwZW5k
cyBvbgorCSAqIGl0LgogCSAqLwotCWlmIChkcm1fZm9ybWF0X2luZm9faXNfeXV2X3NlbWlwbGFu
YXIoZmItPmZvcm1hdCkpIHsKLQkJcmV0ID0gc2tsX2NoZWNrX252MTJfYXV4X3N1cmZhY2UocGxh
bmVfc3RhdGUpOworCWlmIChpc19jY3NfbW9kaWZpZXIoZmItPm1vZGlmaWVyKSkgeworCQluZWVk
c19hdXggPSB0cnVlOworCQlyZXQgPSBza2xfY2hlY2tfY2NzX2F1eF9zdXJmYWNlKHBsYW5lX3N0
YXRlKTsKIAkJaWYgKHJldCkKIAkJCXJldHVybiByZXQ7Ci0JfSBlbHNlIGlmIChpc19jY3NfbW9k
aWZpZXIoZmItPm1vZGlmaWVyKSkgewotCQlyZXQgPSBza2xfY2hlY2tfY2NzX2F1eF9zdXJmYWNl
KHBsYW5lX3N0YXRlKTsKKwl9CisKKwlpZiAoZHJtX2Zvcm1hdF9pbmZvX2lzX3l1dl9zZW1pcGxh
bmFyKGZiLT5mb3JtYXQpKSB7CisJCW5lZWRzX2F1eCA9IHRydWU7CisJCXJldCA9IHNrbF9jaGVj
a19udjEyX2F1eF9zdXJmYWNlKHBsYW5lX3N0YXRlKTsKIAkJaWYgKHJldCkKIAkJCXJldHVybiBy
ZXQ7Ci0JfSBlbHNlIHsKLQkJcGxhbmVfc3RhdGUtPmNvbG9yX3BsYW5lWzFdLm9mZnNldCA9IH4w
eGZmZjsKLQkJcGxhbmVfc3RhdGUtPmNvbG9yX3BsYW5lWzFdLnggPSAwOwotCQlwbGFuZV9zdGF0
ZS0+Y29sb3JfcGxhbmVbMV0ueSA9IDA7CisJfQorCisJaWYgKCFuZWVkc19hdXgpIHsKKwkJaW50
IGk7CisKKwkJZm9yIChpID0gMTsgaSA8IGZiLT5mb3JtYXQtPm51bV9wbGFuZXM7IGkrKykgewor
CQkJcGxhbmVfc3RhdGUtPmNvbG9yX3BsYW5lW2ldLm9mZnNldCA9IH4weGZmZjsKKwkJCXBsYW5l
X3N0YXRlLT5jb2xvcl9wbGFuZVtpXS54ID0gMDsKKwkJCXBsYW5lX3N0YXRlLT5jb2xvcl9wbGFu
ZVtpXS55ID0gMDsKKwkJfQogCX0KIAogCXJldCA9IHNrbF9jaGVja19tYWluX3N1cmZhY2UocGxh
bmVfc3RhdGUpOwpAQCAtNDE2MCw2ICs0MjgxLDggQEAgc3RhdGljIHUzMiBza2xfcGxhbmVfY3Rs
X3RpbGluZyh1NjQgZmJfbW9kaWZpZXIpCiAJCXJldHVybiBQTEFORV9DVExfVElMRURfWSB8CiAJ
CSAgICAgICBQTEFORV9DVExfUkVOREVSX0RFQ09NUFJFU1NJT05fRU5BQkxFIHwKIAkJICAgICAg
IFBMQU5FX0NUTF9DTEVBUl9DT0xPUl9ESVNBQkxFOworCWNhc2UgSTkxNV9GT1JNQVRfTU9EX1lf
VElMRURfR0VOMTJfTUNfQ0NTOgorCQlyZXR1cm4gUExBTkVfQ1RMX1RJTEVEX1kgfCBQTEFORV9D
VExfTUVESUFfREVDT01QUkVTU0lPTl9FTkFCTEU7CiAJY2FzZSBJOTE1X0ZPUk1BVF9NT0RfWWZf
VElMRUQ6CiAJCXJldHVybiBQTEFORV9DVExfVElMRURfWUY7CiAJY2FzZSBJOTE1X0ZPUk1BVF9N
T0RfWWZfVElMRURfQ0NTOgpAQCAtOTk2NCw2ICsxMDA4Nyw4IEBAIHNreWxha2VfZ2V0X2luaXRp
YWxfcGxhbmVfY29uZmlnKHN0cnVjdCBpbnRlbF9jcnRjICpjcnRjLAogCQkJZmItPm1vZGlmaWVy
ID0gSU5URUxfR0VOKGRldl9wcml2KSA+PSAxMiA/CiAJCQkJSTkxNV9GT1JNQVRfTU9EX1lfVElM
RURfR0VOMTJfUkNfQ0NTIDoKIAkJCQlJOTE1X0ZPUk1BVF9NT0RfWV9USUxFRF9DQ1M7CisJCWVs
c2UgaWYgKHZhbCAmIFBMQU5FX0NUTF9NRURJQV9ERUNPTVBSRVNTSU9OX0VOQUJMRSkKKwkJCWZi
LT5tb2RpZmllciA9IEk5MTVfRk9STUFUX01PRF9ZX1RJTEVEX0dFTjEyX01DX0NDUzsKIAkJZWxz
ZQogCQkJZmItPm1vZGlmaWVyID0gSTkxNV9GT1JNQVRfTU9EX1lfVElMRUQ7CiAJCWJyZWFrOwpk
aWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZGlzcGxheS9pbnRlbF9kaXNwbGF5X3R5
cGVzLmggYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9kaXNwbGF5L2ludGVsX2Rpc3BsYXlfdHlwZXMu
aAppbmRleCA0OWM5MDJiMDA0ODQuLmE0ZDJlYmFlNDA3YSAxMDA2NDQKLS0tIGEvZHJpdmVycy9n
cHUvZHJtL2k5MTUvZGlzcGxheS9pbnRlbF9kaXNwbGF5X3R5cGVzLmgKKysrIGIvZHJpdmVycy9n
cHUvZHJtL2k5MTUvZGlzcGxheS9pbnRlbF9kaXNwbGF5X3R5cGVzLmgKQEAgLTUzMCw3ICs1MzAs
NyBAQCBzdHJ1Y3QgaW50ZWxfcGxhbmVfc3RhdGUgewogCQkgKi8KIAkJdTMyIHN0cmlkZTsKIAkJ
aW50IHgsIHk7Ci0JfSBjb2xvcl9wbGFuZVsyXTsKKwl9IGNvbG9yX3BsYW5lWzRdOwogCiAJLyog
cGxhbmUgY29udHJvbCByZWdpc3RlciAqLwogCXUzMiBjdGw7CmRpZmYgLS1naXQgYS9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9kaXNwbGF5L2ludGVsX3Nwcml0ZS5jIGIvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZGlzcGxheS9pbnRlbF9zcHJpdGUuYwppbmRleCA4NjZkMjVkMzhkMDQuLmFkMjhlZTk0Yzk2
OCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZGlzcGxheS9pbnRlbF9zcHJpdGUu
YworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9kaXNwbGF5L2ludGVsX3Nwcml0ZS5jCkBAIC0x
NzM3LDcgKzE3MzcsOCBAQCBzdGF0aWMgaW50IHNrbF9wbGFuZV9jaGVja19mYihjb25zdCBzdHJ1
Y3QgaW50ZWxfY3J0Y19zdGF0ZSAqY3J0Y19zdGF0ZSwKIAkgICAgIGZiLT5tb2RpZmllciA9PSBJ
OTE1X0ZPUk1BVF9NT0RfWWZfVElMRUQgfHwKIAkgICAgIGZiLT5tb2RpZmllciA9PSBJOTE1X0ZP
Uk1BVF9NT0RfWV9USUxFRF9DQ1MgfHwKIAkgICAgIGZiLT5tb2RpZmllciA9PSBJOTE1X0ZPUk1B
VF9NT0RfWWZfVElMRURfQ0NTIHx8Ci0JICAgICBmYi0+bW9kaWZpZXIgPT0gSTkxNV9GT1JNQVRf
TU9EX1lfVElMRURfR0VOMTJfUkNfQ0NTKSkgeworCSAgICAgZmItPm1vZGlmaWVyID09IEk5MTVf
Rk9STUFUX01PRF9ZX1RJTEVEX0dFTjEyX1JDX0NDUyB8fAorCSAgICAgZmItPm1vZGlmaWVyID09
IEk5MTVfRk9STUFUX01PRF9ZX1RJTEVEX0dFTjEyX01DX0NDUykpIHsKIAkJRFJNX0RFQlVHX0tN
UygiWS9ZZiB0aWxpbmcgbm90IHN1cHBvcnRlZCBpbiBJRi1JRCBtb2RlXG4iKTsKIAkJcmV0dXJu
IC1FSU5WQUw7CiAJfQpAQCAtMjE0OSw3ICsyMTUwLDE2IEBAIHN0YXRpYyBjb25zdCB1NjQgc2ts
X3BsYW5lX2Zvcm1hdF9tb2RpZmllcnNfY2NzW10gPSB7CiAJRFJNX0ZPUk1BVF9NT0RfSU5WQUxJ
RAogfTsKIAotc3RhdGljIGNvbnN0IHU2NCBnZW4xMl9wbGFuZV9mb3JtYXRfbW9kaWZpZXJzX2Nj
c1tdID0geworc3RhdGljIGNvbnN0IHU2NCBnZW4xMl9wbGFuZV9mb3JtYXRfbW9kaWZpZXJzX21j
X2Njc1tdID0geworCUk5MTVfRk9STUFUX01PRF9ZX1RJTEVEX0dFTjEyX01DX0NDUywKKwlJOTE1
X0ZPUk1BVF9NT0RfWV9USUxFRF9HRU4xMl9SQ19DQ1MsCisJSTkxNV9GT1JNQVRfTU9EX1lfVElM
RUQsCisJSTkxNV9GT1JNQVRfTU9EX1hfVElMRUQsCisJRFJNX0ZPUk1BVF9NT0RfTElORUFSLAor
CURSTV9GT1JNQVRfTU9EX0lOVkFMSUQKK307CisKK3N0YXRpYyBjb25zdCB1NjQgZ2VuMTJfcGxh
bmVfZm9ybWF0X21vZGlmaWVyc19yY19jY3NbXSA9IHsKIAlJOTE1X0ZPUk1BVF9NT0RfWV9USUxF
RF9HRU4xMl9SQ19DQ1MsCiAJSTkxNV9GT1JNQVRfTU9EX1lfVElMRUQsCiAJSTkxNV9GT1JNQVRf
TU9EX1hfVElMRUQsCkBAIC0yMzA1LDEwICsyMzE1LDIxIEBAIHN0YXRpYyBib29sIHNrbF9wbGFu
ZV9mb3JtYXRfbW9kX3N1cHBvcnRlZChzdHJ1Y3QgZHJtX3BsYW5lICpfcGxhbmUsCiAJfQogfQog
CitzdGF0aWMgYm9vbCBnZW4xMl9wbGFuZV9zdXBwb3J0c19tY19jY3MoZW51bSBwbGFuZV9pZCBw
bGFuZV9pZCkKK3sKKwlyZXR1cm4gcGxhbmVfaWQgPCBQTEFORV9TUFJJVEU0OworfQorCiBzdGF0
aWMgYm9vbCBnZW4xMl9wbGFuZV9mb3JtYXRfbW9kX3N1cHBvcnRlZChzdHJ1Y3QgZHJtX3BsYW5l
ICpfcGxhbmUsCiAJCQkJCSAgICAgdTMyIGZvcm1hdCwgdTY0IG1vZGlmaWVyKQogeworCXN0cnVj
dCBpbnRlbF9wbGFuZSAqcGxhbmUgPSB0b19pbnRlbF9wbGFuZShfcGxhbmUpOworCiAJc3dpdGNo
IChtb2RpZmllcikgeworCWNhc2UgSTkxNV9GT1JNQVRfTU9EX1lfVElMRURfR0VOMTJfTUNfQ0NT
OgorCQlpZiAoIWdlbjEyX3BsYW5lX3N1cHBvcnRzX21jX2NjcyhwbGFuZS0+aWQpKQorCQkJcmV0
dXJuIGZhbHNlOworCQkvKiBmYWxsIHRocm91Z2ggKi8KIAljYXNlIERSTV9GT1JNQVRfTU9EX0xJ
TkVBUjoKIAljYXNlIEk5MTVfRk9STUFUX01PRF9YX1RJTEVEOgogCWNhc2UgSTkxNV9GT1JNQVRf
TU9EX1lfVElMRUQ6CkBAIC0yMzI2LDE0ICsyMzQ3LDE3IEBAIHN0YXRpYyBib29sIGdlbjEyX3Bs
YW5lX2Zvcm1hdF9tb2Rfc3VwcG9ydGVkKHN0cnVjdCBkcm1fcGxhbmUgKl9wbGFuZSwKIAkJaWYg
KGlzX2Njc19tb2RpZmllcihtb2RpZmllcikpCiAJCQlyZXR1cm4gdHJ1ZTsKIAkJLyogZmFsbCB0
aHJvdWdoICovCi0JY2FzZSBEUk1fRk9STUFUX1JHQjU2NToKLQljYXNlIERSTV9GT1JNQVRfWFJH
QjIxMDEwMTA6Ci0JY2FzZSBEUk1fRk9STUFUX1hCR1IyMTAxMDEwOgogCWNhc2UgRFJNX0ZPUk1B
VF9ZVVlWOgogCWNhc2UgRFJNX0ZPUk1BVF9ZVllVOgogCWNhc2UgRFJNX0ZPUk1BVF9VWVZZOgog
CWNhc2UgRFJNX0ZPUk1BVF9WWVVZOgorCQlpZiAobW9kaWZpZXIgPT0gSTkxNV9GT1JNQVRfTU9E
X1lfVElMRURfR0VOMTJfTUNfQ0NTKQorCQkJcmV0dXJuIHRydWU7CisJCS8qIGZhbGwgdGhyb3Vn
aCAqLwogCWNhc2UgRFJNX0ZPUk1BVF9OVjEyOgorCWNhc2UgRFJNX0ZPUk1BVF9SR0I1NjU6CisJ
Y2FzZSBEUk1fRk9STUFUX1hSR0IyMTAxMDEwOgorCWNhc2UgRFJNX0ZPUk1BVF9YQkdSMjEwMTAx
MDoKIAljYXNlIERSTV9GT1JNQVRfUDAxMDoKIAljYXNlIERSTV9GT1JNQVRfUDAxMjoKIAljYXNl
IERSTV9GT1JNQVRfUDAxNjoKQEAgLTI0NzAsNiArMjQ5NCwxNCBAQCBzdGF0aWMgY29uc3QgdTMy
ICppY2xfZ2V0X3BsYW5lX2Zvcm1hdHMoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2
LAogCX0KIH0KIAorc3RhdGljIGNvbnN0IHU2NCAqZ2VuMTJfZ2V0X3BsYW5lX21vZGlmaWVycyhl
bnVtIHBsYW5lX2lkIHBsYW5lX2lkKQoreworCWlmIChnZW4xMl9wbGFuZV9zdXBwb3J0c19tY19j
Y3MocGxhbmVfaWQpKQorCQlyZXR1cm4gZ2VuMTJfcGxhbmVfZm9ybWF0X21vZGlmaWVyc19tY19j
Y3M7CisJZWxzZQorCQlyZXR1cm4gZ2VuMTJfcGxhbmVfZm9ybWF0X21vZGlmaWVyc19yY19jY3M7
Cit9CisKIHN0YXRpYyBib29sIHNrbF9wbGFuZV9oYXNfY2NzKHN0cnVjdCBkcm1faTkxNV9wcml2
YXRlICpkZXZfcHJpdiwKIAkJCSAgICAgIGVudW0gcGlwZSBwaXBlLCBlbnVtIHBsYW5lX2lkIHBs
YW5lX2lkKQogewpAQCAtMjUzNiw3ICsyNTY4LDcgQEAgc2tsX3VuaXZlcnNhbF9wbGFuZV9jcmVh
dGUoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2LAogCiAJcGxhbmUtPmhhc19jY3Mg
PSBza2xfcGxhbmVfaGFzX2NjcyhkZXZfcHJpdiwgcGlwZSwgcGxhbmVfaWQpOwogCWlmIChJTlRF
TF9HRU4oZGV2X3ByaXYpID49IDEyKSB7Ci0JCW1vZGlmaWVycyA9IGdlbjEyX3BsYW5lX2Zvcm1h
dF9tb2RpZmllcnNfY2NzOworCQltb2RpZmllcnMgPSBnZW4xMl9nZXRfcGxhbmVfbW9kaWZpZXJz
KHBsYW5lX2lkKTsKIAkJcGxhbmVfZnVuY3MgPSAmZ2VuMTJfcGxhbmVfZnVuY3M7CiAJfSBlbHNl
IHsKIAkJaWYgKHBsYW5lLT5oYXNfY2NzKQpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvaTkxNV9yZWcuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcmVnLmgKaW5kZXggYjQ2
NWVhZTExNzYzLi5jOGJhOGRjNmU0NWIgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2k5MTVfcmVnLmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9yZWcuaApAQCAtNjY5
Niw2ICs2Njk2LDcgQEAgZW51bSB7CiAjZGVmaW5lICAgUExBTkVfQ1RMX1RJTEVEX1kJCQkoNCA8
PCAxMCkKICNkZWZpbmUgICBQTEFORV9DVExfVElMRURfWUYJCQkoNSA8PCAxMCkKICNkZWZpbmUg
ICBQTEFORV9DVExfRkxJUF9IT1JJWk9OVEFMCQkoMSA8PCA4KQorI2RlZmluZSAgIFBMQU5FX0NU
TF9NRURJQV9ERUNPTVBSRVNTSU9OX0VOQUJMRQkoMSA8PCA0KSAvKiBUR0wrICovCiAjZGVmaW5l
ICAgUExBTkVfQ1RMX0FMUEhBX01BU0sJCQkoMHgzIDw8IDQpIC8qIFByZS1HTEsgKi8KICNkZWZp
bmUgICBQTEFORV9DVExfQUxQSEFfRElTQUJMRQkJKDAgPDwgNCkKICNkZWZpbmUgICBQTEFORV9D
VExfQUxQSEFfU1dfUFJFTVVMVElQTFkJKDIgPDwgNCkKLS0gCjIuMTcuMQoKX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlz
dApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0
b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id CF280F58CD
	for <lists+intel-gfx@lfdr.de>; Fri,  8 Nov 2019 21:49:55 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 926666FA73;
	Fri,  8 Nov 2019 20:49:53 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id F018A6FA73;
 Fri,  8 Nov 2019 20:49:51 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 19134341-1500050 
 for multiple; Fri, 08 Nov 2019 20:49:36 +0000
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Fri,  8 Nov 2019 20:49:31 +0000
Message-Id: <20191108204932.6197-2-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.24.0
In-Reply-To: <20191108204932.6197-1-chris@chris-wilson.co.uk>
References: <20191108204932.6197-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH i-g-t 2/3] i915/gem_userptr_blits: Exercise
 userptr + userfaultfd
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: igt-dev@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

UmVnaXN0ZXIgYSB1c2Vyc3BhY2UgZmF1bHQgaGFuZGxlciBmb3IgYSBtZW1vcnkgcmVnaW9uIHRo
YXQgd2UgYWxzbyBwYXNzCnRvIHRoZSBHUFUgdmlhIHVzZXJwdHIsIGFuZCBtYWtlIHN1cmUgdGhl
IHBhZ2VmYXVsdCBpcyBwcm9wZXJseSBzZXJ2aWNlZApiZWZvcmUgd2UgZXhlY3V0ZS4KClNpZ25l
ZC1vZmYtYnk6IENocmlzIFdpbHNvbiA8Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPgpDYzogVHZy
dGtvIFVyc3VsaW4gPHR2cnRrby51cnN1bGluQGludGVsLmNvbT4KLS0tCiB0ZXN0cy9pOTE1L2dl
bV91c2VycHRyX2JsaXRzLmMgfCAxMTkgKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKyst
CiAxIGZpbGUgY2hhbmdlZCwgMTE4IGluc2VydGlvbnMoKyksIDEgZGVsZXRpb24oLSkKCmRpZmYg
LS1naXQgYS90ZXN0cy9pOTE1L2dlbV91c2VycHRyX2JsaXRzLmMgYi90ZXN0cy9pOTE1L2dlbV91
c2VycHRyX2JsaXRzLmMKaW5kZXggMTFkNmY0YTFjLi43NzRhOWY5MmMgMTAwNjQ0Ci0tLSBhL3Rl
c3RzL2k5MTUvZ2VtX3VzZXJwdHJfYmxpdHMuYworKysgYi90ZXN0cy9pOTE1L2dlbV91c2VycHRy
X2JsaXRzLmMKQEAgLTM2LDYgKzM2LDggQEAKICAqIFRoZSBnb2FsIGlzIHRvIHNpbXBseSBlbnN1
cmUgdGhlIGJhc2ljcyB3b3JrLgogICovCiAKKyNpbmNsdWRlIDxsaW51eC91c2VyZmF1bHRmZC5o
PgorCiAjaW5jbHVkZSAiaWd0LmgiCiAjaW5jbHVkZSA8c3RkbGliLmg+CiAjaW5jbHVkZSA8c3Rk
aW8uaD4KQEAgLTQ0LDkgKzQ2LDExIEBACiAjaW5jbHVkZSA8aW50dHlwZXMuaD4KICNpbmNsdWRl
IDxlcnJuby5oPgogI2luY2x1ZGUgPHNldGptcC5oPgorI2luY2x1ZGUgPHN5cy9pb2N0bC5oPgor
I2luY2x1ZGUgPHN5cy9tbWFuLmg+CiAjaW5jbHVkZSA8c3lzL3N0YXQuaD4KKyNpbmNsdWRlIDxz
eXMvc3lzY2FsbC5oPgogI2luY2x1ZGUgPHN5cy90aW1lLmg+Ci0jaW5jbHVkZSA8c3lzL21tYW4u
aD4KICNpbmNsdWRlIDxnbGliLmg+CiAjaW5jbHVkZSA8c2lnbmFsLmg+CiAjaW5jbHVkZSA8cHRo
cmVhZC5oPgpAQCAtMTgzMSw2ICsxODM1LDExNiBAQCBzdGF0aWMgdm9pZCB0ZXN0X2ludmFsaWRh
dGVfY2xvc2VfcmFjZShpbnQgZmQsIGJvb2wgb3ZlcmxhcCkKIAlmcmVlKHRfZGF0YS5wdHIpOwog
fQogCitzdHJ1Y3QgdWZkX3RocmVhZCB7CisJdWludDMyX3QgKnBhZ2U7CisJaW50IGk5MTU7Cit9
OworCitzdGF0aWMgdWludDMyX3QgY3JlYXRlX3BhZ2UoaW50IGk5MTUsIHZvaWQgKnBhZ2UpCit7
CisJdWludDMyX3QgaGFuZGxlOworCisJZ2VtX3VzZXJwdHIoaTkxNSwgcGFnZSwgNDA5NiwgMCwg
MCwgJmhhbmRsZSk7CisJcmV0dXJuIGhhbmRsZTsKK30KKworc3RhdGljIHVpbnQzMl90IGNyZWF0
ZV9iYXRjaChpbnQgaTkxNSkKK3sKKwljb25zdCB1aW50MzJfdCBiYmUgPSBNSV9CQVRDSF9CVUZG
RVJfRU5EOworCXVpbnQzMl90IGhhbmRsZTsKKworCWhhbmRsZSA9IGdlbV9jcmVhdGUoaTkxNSwg
NDA5Nik7CisJZ2VtX3dyaXRlKGk5MTUsIGhhbmRsZSwgMCwgJmJiZSwgc2l6ZW9mKGJiZSkpOwor
CisJcmV0dXJuIGhhbmRsZTsKK30KKworc3RhdGljIHZvaWQgKnVmZF90aHJlYWQodm9pZCAqYXJn
KQoreworCXN0cnVjdCB1ZmRfdGhyZWFkICp0ID0gYXJnOworCXN0cnVjdCBkcm1faTkxNV9nZW1f
ZXhlY19vYmplY3QyIG9ialsyXSA9IHsKKwkJeyAuaGFuZGxlID0gY3JlYXRlX3BhZ2UodC0+aTkx
NSwgdC0+cGFnZSkgfSwKKwkJeyAuaGFuZGxlID0gY3JlYXRlX2JhdGNoKHQtPmk5MTUpIH0sCisJ
fTsKKwlzdHJ1Y3QgZHJtX2k5MTVfZ2VtX2V4ZWNidWZmZXIyIGViID0geworCQkuYnVmZmVyc19w
dHIgPSB0b191c2VyX3BvaW50ZXIob2JqKSwKKwkJLmJ1ZmZlcl9jb3VudCA9IEFSUkFZX1NJWkUo
b2JqKSwKKwl9OworCisJaWd0X2RlYnVnKCJzdWJtaXR0aW5nIGZhdWx0XG4iKTsKKwlnZW1fZXhl
Y2J1Zih0LT5pOTE1LCAmZWIpOworCWdlbV9zeW5jKHQtPmk5MTUsIG9ialsxXS5oYW5kbGUpOwor
CisJZm9yIChpbnQgaSA9IDA7IGkgPCBBUlJBWV9TSVpFKG9iaik7IGkrKykKKwkJZ2VtX2Nsb3Nl
KHQtPmk5MTUsIG9ialtpXS5oYW5kbGUpOworCisJdC0+aTkxNSA9IC0xOworCXJldHVybiBOVUxM
OworfQorCitzdGF0aWMgaW50IHVzZXJmYXVsdGZkKGludCBmbGFncykKK3sKKwlyZXR1cm4gc3lz
Y2FsbChTWVNfdXNlcmZhdWx0ZmQsIGZsYWdzKTsKK30KKworc3RhdGljIHZvaWQgdGVzdF91c2Vy
ZmF1bHQoaW50IGk5MTUpCit7CisJc3RydWN0IHVmZmRpb19hcGkgYXBpID0geyAuYXBpID0gVUZG
RF9BUEkgfTsKKwlzdHJ1Y3QgdWZmZGlvX3JlZ2lzdGVyIHJlZzsKKwlzdHJ1Y3QgdWZmZGlvX2Nv
cHkgY29weTsKKwlzdHJ1Y3QgdWZmZF9tc2cgbXNnOworCXN0cnVjdCB1ZmRfdGhyZWFkIHQ7CisJ
cHRocmVhZF90IHRocmVhZDsKKwljaGFyIHBvaXNvbls0MDk2XTsKKwlpbnQgdWZkOworCisJLyoK
KwkgKiBSZWdpc3RlciBhIHBhZ2Ugd2l0aCB1c2VyZmF1bHRmZCwgYW5kIHdyYXAgdGhhdCBpbnNp
ZGUgYSB1c2VycHRyIGJvLgorCSAqIFdoZW4gd2UgdHJ5IHRvIHVzZSBndXAgaW5zaWRlciB1c2Vy
cHRyX2dldF9wYWdlcywgaXQgd2lsbCB0cmlnZ2VyCisJICogYSBwYWdlZmF1bHQgdGhhdCBpcyBz
ZW50IHRvIHRoZSB1c2VyZmF1bHRmZCBmb3Igc2VydmljaW5nLiBUaGlzCisJICogaXMgYXJiaXRy
YXJpbHkgc2xvdywgYXMgdGhlIHN1Ym1pc3Npb24gbXVzdCB3YWl0IHVudGlsIHRoZSBmYXVsdAor
CSAqIGlzIHNlcnZpY2VkIGJ5IHRoZSB1c2Vyc3BhY2UgZmF1bHQgaGFuZGxlci4KKwkgKi8KKwor
CXVmZCA9IHVzZXJmYXVsdGZkKDApOworCWlndF9yZXF1aXJlX2YodWZkICE9IC0xLCAia2VybmVs
IHN1cHBvcnQgZm9yIHVzZXJmYXVsdGZkXG4iKTsKKwlpZ3RfcmVxdWlyZV9mKGlvY3RsKHVmZCwg
VUZGRElPX0FQSSwgJmFwaSkgPT0gMCAmJiBhcGkuYXBpID09IFVGRkRfQVBJLAorCQkgICAgICAi
dXNlcmZhdWx0ZmQgQVBJIHYlbGxkOiVsbGRcbiIsIFVGRkRfQVBJLCBhcGkuYXBpKTsKKworCXQu
aTkxNSA9IGk5MTU7CisKKwl0LnBhZ2UgPSBtbWFwKE5VTEwsIDQwOTYsIFBST1RfV1JJVEUsIE1B
UF9TSEFSRUQgfCBNQVBfQU5PTiwgMCwgMCk7CisJaWd0X2Fzc2VydCh0LnBhZ2UgIT0gTUFQX0ZB
SUxFRCk7CisKKwltZW1zZXQoJnJlZywgMCwgc2l6ZW9mKHJlZykpOworCXJlZy5tb2RlID0gVUZG
RElPX1JFR0lTVEVSX01PREVfTUlTU0lORzsKKwlyZWcucmFuZ2Uuc3RhcnQgPSB0b191c2VyX3Bv
aW50ZXIodC5wYWdlKTsKKwlyZWcucmFuZ2UubGVuID0gNDA5NjsKKwlkb19pb2N0bCh1ZmQsIFVG
RkRJT19SRUdJU1RFUiwgJnJlZyk7CisJaWd0X2Fzc2VydChyZWcuaW9jdGxzID09IFVGRkRfQVBJ
X1JBTkdFX0lPQ1RMUyk7CisKKwlpZ3RfYXNzZXJ0KHB0aHJlYWRfY3JlYXRlKCZ0aHJlYWQsIE5V
TEwsIHVmZF90aHJlYWQsICZ0KSA9PSAwKTsKKworCS8qIFdhaXQgZm9yIHRoZSBmYXVsdCAqLwor
CWlndF9hc3NlcnRfZXEocmVhZCh1ZmQsICZtc2csIHNpemVvZihtc2cpKSwgc2l6ZW9mKG1zZykp
OworCWlndF9hc3NlcnRfZXEobXNnLmV2ZW50LCBVRkZEX0VWRU5UX1BBR0VGQVVMVCk7CisJaWd0
X2Fzc2VydChmcm9tX3VzZXJfcG9pbnRlcihtc2cuYXJnLnBhZ2VmYXVsdC5hZGRyZXNzKSA9PSB0
LnBhZ2UpOworCisJLyogRmF1bHRpbmcgdGhyZWFkIHJlbWFpbnMgYmxvY2tlZCAqLworCWlndF9h
c3NlcnRfZXEodC5pOTE1LCBpOTE1KTsKKworCW1lbXNldCgmY29weSwgMCwgc2l6ZW9mKGNvcHkp
KTsKKwljb3B5LmRzdCA9IG1zZy5hcmcucGFnZWZhdWx0LmFkZHJlc3M7CisJY29weS5zcmMgPSB0
b191c2VyX3BvaW50ZXIobWVtc2V0KHBvaXNvbiwgMHhjNSwgc2l6ZW9mKHBvaXNvbikpKTsKKwlj
b3B5LmxlbiA9IDQwOTY7CisJZG9faW9jdGwodWZkLCBVRkZESU9fQ09QWSwgJmNvcHkpOworCisJ
cHRocmVhZF9qb2luKHRocmVhZCwgTlVMTCk7CisKKwltdW5tYXAodC5wYWdlLCA0MDk2KTsKKwlj
bG9zZSh1ZmQpOworfQorCiB1aW50NjRfdCB0b3RhbF9yYW07CiB1aW50NjRfdCBhcGVydHVyZV9z
aXplOwogaW50IGZkLCBjb3VudDsKQEAgLTE5MDIsNiArMjAxNiw5IEBAIGlndF9tYWluX2FyZ3Mo
ImM6IiwgTlVMTCwgaGVscF9zdHIsIG9wdF9oYW5kbGVyLCBOVUxMKQogCQlpZ3Rfc3VidGVzdCgi
Zm9yYmlkZGVuLW9wZXJhdGlvbnMiKQogCQkJdGVzdF9mb3JiaWRkZW5fb3BzKGZkKTsKIAorCQlp
Z3Rfc3VidGVzdCgidXNlcmZhdWx0IikKKwkJCXRlc3RfdXNlcmZhdWx0KGZkKTsKKwogCQlpZ3Rf
c3VidGVzdCgicmVsb2NhdGlvbnMiKQogCQkJdGVzdF9yZWxvY2F0aW9ucyhmZCk7CiAJfQotLSAK
Mi4yNC4wCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpJ
bnRlbC1nZnggbWFpbGluZyBsaXN0CkludGVsLWdmeEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0
cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9pbnRlbC1nZng=

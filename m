Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 58D3376132
	for <lists+intel-gfx@lfdr.de>; Fri, 26 Jul 2019 10:46:54 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 51C176E8BC;
	Fri, 26 Jul 2019 08:46:49 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id AB49F6E8A7
 for <intel-gfx@lists.freedesktop.org>; Fri, 26 Jul 2019 08:46:27 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17621096-1500050 
 for multiple; Fri, 26 Jul 2019 09:46:17 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Fri, 26 Jul 2019 09:46:07 +0100
Message-Id: <20190726084613.22129-21-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.22.0
In-Reply-To: <20190726084613.22129-1-chris@chris-wilson.co.uk>
References: <20190726084613.22129-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 21/27] drm/i915: Protect request retirement with
 timeline->mutex
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

Rm9yZ28gdGhlIHN0cnVjdF9tdXRleCByZXF1aXJlbWVudCBmb3IgcmVxdWVzdCByZXRpcmVtZW50
IGFzIHdlIGhhdmUKYmVlbiB0cmFuc2l0aW9uaW5nIG92ZXIgdG8gb25seSB1c2luZyB0aGUgdGlt
ZWxpbmUtPm11dGV4IGZvcgpjb250cm9sbGluZyB0aGUgbGlmZXRpbWUgb2YgYSByZXF1ZXN0IG9u
IHRoYXQgdGltZWxpbmUuCgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNocmlzQGNocmlz
LXdpbHNvbi5jby51az4KLS0tCiAuLi4vZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9leGVjYnVm
ZmVyLmMgICAgfCAxODMgKysrKysrKysrKy0tLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9n
dC9pbnRlbF9jb250ZXh0LmggICAgICAgfCAgMTggKy0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0
L2ludGVsX2VuZ2luZV9jcy5jICAgICB8ICAgMSAtCiAuLi4vZ3B1L2RybS9pOTE1L2d0L2ludGVs
X2VuZ2luZV9oZWFydGJlYXQuYyAgfCAgIDYgKy0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2lu
dGVsX2VuZ2luZV90eXBlcy5oICB8ICAgMiAtCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRl
bF9ndC5jICAgICAgICAgICAgfCAgIDEgLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxf
Z3RfdHlwZXMuaCAgICAgIHwgICAyIC0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2xy
Yy5jICAgICAgICAgICB8ICAgMSArCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9yaW5n
YnVmZmVyLmMgICAgfCAgMTMgKy0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L21vY2tfZW5naW5l
LmMgICAgICAgICB8ICAgMSAtCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVzdF9jb250
ZXh0LmMgICAgfCAgIDkgKy0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcmVxdWVzdC5jICAg
ICAgICAgICB8IDE1MSArKysrKysrLS0tLS0tLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVf
cmVxdWVzdC5oICAgICAgICAgICB8ICAgMyAtCiAxMyBmaWxlcyBjaGFuZ2VkLCAyMDggaW5zZXJ0
aW9ucygrKSwgMTgzIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2dlbS9pOTE1X2dlbV9leGVjYnVmZmVyLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0v
aTkxNV9nZW1fZXhlY2J1ZmZlci5jCmluZGV4IDhkOTA0OThlYWY0Ni4uNDRhZGQxNzJjZGM4IDEw
MDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fZXhlY2J1ZmZlci5j
CisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9leGVjYnVmZmVyLmMKQEAg
LTczNCw2MyArNzM0LDYgQEAgc3RhdGljIGludCBlYl9zZWxlY3RfY29udGV4dChzdHJ1Y3QgaTkx
NV9leGVjYnVmZmVyICplYikKIAlyZXR1cm4gMDsKIH0KIAotc3RhdGljIHN0cnVjdCBpOTE1X3Jl
cXVlc3QgKl9fZWJfd2FpdF9mb3JfcmluZyhzdHJ1Y3QgaW50ZWxfcmluZyAqcmluZykKLXsKLQlz
dHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycTsKLQotCS8qCi0JICogQ29tcGxldGVseSB1bnNjaWVudGlm
aWMgZmluZ2VyLWluLXRoZS1haXIgZXN0aW1hdGVzIGZvciBzdWl0YWJsZQotCSAqIG1heGltdW0g
dXNlciByZXF1ZXN0IHNpemUgKHRvIGF2b2lkIGJsb2NraW5nKSBhbmQgdGhlbiBiYWNrb2ZmLgot
CSAqLwotCWlmIChpbnRlbF9yaW5nX3VwZGF0ZV9zcGFjZShyaW5nKSA+PSBQQUdFX1NJWkUpCi0J
CXJldHVybiBOVUxMOwotCi0JLyoKLQkgKiBGaW5kIGEgcmVxdWVzdCB0aGF0IGFmdGVyIHdhaXRp
bmcgdXBvbiwgdGhlcmUgd2lsbCBiZSBhdCBsZWFzdCBoYWxmCi0JICogdGhlIHJpbmcgYXZhaWxh
YmxlLiBUaGUgaHlzdGVyZXNpcyBhbGxvd3MgdXMgdG8gY29tcGV0ZSBmb3IgdGhlCi0JICogc2hh
cmVkIHJpbmcgYW5kIHNob3VsZCBtZWFuIHRoYXQgd2Ugc2xlZXAgbGVzcyBvZnRlbiBwcmlvciB0
bwotCSAqIGNsYWltaW5nIG91ciByZXNvdXJjZXMsIGJ1dCBub3Qgc28gbG9uZyB0aGF0IHRoZSBy
aW5nIGNvbXBsZXRlbHkKLQkgKiBkcmFpbnMgYmVmb3JlIHdlIGNhbiBzdWJtaXQgb3VyIG5leHQg
cmVxdWVzdC4KLQkgKi8KLQlsaXN0X2Zvcl9lYWNoX2VudHJ5KHJxLCAmcmluZy0+cmVxdWVzdF9s
aXN0LCByaW5nX2xpbmspIHsKLQkJaWYgKF9faW50ZWxfcmluZ19zcGFjZShycS0+cG9zdGZpeCwK
LQkJCQkgICAgICAgcmluZy0+ZW1pdCwgcmluZy0+c2l6ZSkgPiByaW5nLT5zaXplIC8gMikKLQkJ
CWJyZWFrOwotCX0KLQlpZiAoJnJxLT5yaW5nX2xpbmsgPT0gJnJpbmctPnJlcXVlc3RfbGlzdCkK
LQkJcmV0dXJuIE5VTEw7IC8qIHdlaXJkLCB3ZSB3aWxsIGNoZWNrIGFnYWluIGxhdGVyIGZvciBy
ZWFsICovCi0KLQlyZXR1cm4gaTkxNV9yZXF1ZXN0X2dldChycSk7Ci19Ci0KLXN0YXRpYyBpbnQg
ZWJfd2FpdF9mb3JfcmluZyhjb25zdCBzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYikKLXsKLQlz
dHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycTsKLQlpbnQgcmV0ID0gMDsKLQotCS8qCi0JICogQXBwbHkg
YSBsaWdodCBhbW91bnQgb2YgYmFja3ByZXNzdXJlIHRvIHByZXZlbnQgZXhjZXNzaXZlIGhvZ3MK
LQkgKiBmcm9tIGJsb2NraW5nIHdhaXRpbmcgZm9yIHNwYWNlIHdoaWxzdCBob2xkaW5nIHN0cnVj
dF9tdXRleCBhbmQKLQkgKiBrZWVwaW5nIGFsbCBvZiB0aGVpciByZXNvdXJjZXMgcGlubmVkLgot
CSAqLwotCi0JcnEgPSBfX2ViX3dhaXRfZm9yX3JpbmcoZWItPmNvbnRleHQtPnJpbmcpOwotCWlm
IChycSkgewotCQltdXRleF91bmxvY2soJmViLT5pOTE1LT5kcm0uc3RydWN0X211dGV4KTsKLQot
CQlpZiAoaTkxNV9yZXF1ZXN0X3dhaXQocnEsCi0JCQkJICAgICAgSTkxNV9XQUlUX0lOVEVSUlVQ
VElCTEUsCi0JCQkJICAgICAgTUFYX1NDSEVEVUxFX1RJTUVPVVQpIDwgMCkKLQkJCXJldCA9IC1F
SU5UUjsKLQotCQlpOTE1X3JlcXVlc3RfcHV0KHJxKTsKLQotCQltdXRleF9sb2NrKCZlYi0+aTkx
NS0+ZHJtLnN0cnVjdF9tdXRleCk7Ci0JfQotCi0JcmV0dXJuIHJldDsKLX0KLQogc3RhdGljIGlu
dCBlYl9sb29rdXBfdm1hcyhzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYikKIHsKIAlzdHJ1Y3Qg
cmFkaXhfdHJlZV9yb290ICpoYW5kbGVzX3ZtYSA9ICZlYi0+Z2VtX2NvbnRleHQtPmhhbmRsZXNf
dm1hOwpAQCAtMjExOCw4ICsyMDYxLDczIEBAIHN0YXRpYyBjb25zdCBlbnVtIGludGVsX2VuZ2lu
ZV9pZCB1c2VyX3JpbmdfbWFwW10gPSB7CiAJW0k5MTVfRVhFQ19WRUJPWF0JPSBWRUNTMAogfTsK
IAotc3RhdGljIGludCBlYl9waW5fY29udGV4dChzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYiwg
c3RydWN0IGludGVsX2NvbnRleHQgKmNlKQorc3RhdGljIHN0cnVjdCBpOTE1X3JlcXVlc3QgKmVi
X3Rocm90dGxlKHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSkKIHsKKwlzdHJ1Y3QgaW50ZWxfcmlu
ZyAqcmluZyA9IGNlLT5yaW5nOworCXN0cnVjdCBpbnRlbF90aW1lbGluZSAqdGwgPSByaW5nLT50
aW1lbGluZTsKKwlzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycTsKKworCS8qCisJICogQ29tcGxldGVs
eSB1bnNjaWVudGlmaWMgZmluZ2VyLWluLXRoZS1haXIgZXN0aW1hdGVzIGZvciBzdWl0YWJsZQor
CSAqIG1heGltdW0gdXNlciByZXF1ZXN0IHNpemUgKHRvIGF2b2lkIGJsb2NraW5nKSBhbmQgdGhl
biBiYWNrb2ZmLgorCSAqLworCWlmIChpbnRlbF9yaW5nX3VwZGF0ZV9zcGFjZShyaW5nKSA+PSBQ
QUdFX1NJWkUpCisJCXJldHVybiBOVUxMOworCisJLyoKKwkgKiBGaW5kIGEgcmVxdWVzdCB0aGF0
IGFmdGVyIHdhaXRpbmcgdXBvbiwgdGhlcmUgd2lsbCBiZSBhdCBsZWFzdCBoYWxmCisJICogdGhl
IHJpbmcgYXZhaWxhYmxlLiBUaGUgaHlzdGVyZXNpcyBhbGxvd3MgdXMgdG8gY29tcGV0ZSBmb3Ig
dGhlCisJICogc2hhcmVkIHJpbmcgYW5kIHNob3VsZCBtZWFuIHRoYXQgd2Ugc2xlZXAgbGVzcyBv
ZnRlbiBwcmlvciB0bworCSAqIGNsYWltaW5nIG91ciByZXNvdXJjZXMsIGJ1dCBub3Qgc28gbG9u
ZyB0aGF0IHRoZSByaW5nIGNvbXBsZXRlbHkKKwkgKiBkcmFpbnMgYmVmb3JlIHdlIGNhbiBzdWJt
aXQgb3VyIG5leHQgcmVxdWVzdC4KKwkgKi8KKwlsaXN0X2Zvcl9lYWNoX2VudHJ5KHJxLCAmdGwt
PnJlcXVlc3RzLCBsaW5rKSB7CisJCWlmIChycS0+cmluZyAhPSByaW5nKQorCQkJY29udGludWU7
CisKKwkJaWYgKF9faW50ZWxfcmluZ19zcGFjZShycS0+cG9zdGZpeCwKKwkJCQkgICAgICAgcmlu
Zy0+ZW1pdCwgcmluZy0+c2l6ZSkgPiByaW5nLT5zaXplIC8gMikKKwkJCWJyZWFrOworCX0KKwlp
ZiAoJnJxLT5saW5rID09ICZ0bC0+cmVxdWVzdHMpCisJCXJldHVybiBOVUxMOyAvKiB3ZWlyZCwg
d2Ugd2lsbCBjaGVjayBhZ2FpbiBsYXRlciBmb3IgcmVhbCAqLworCisJcmV0dXJuIGk5MTVfcmVx
dWVzdF9nZXQocnEpOworfQorCitzdGF0aWMgaW50CitfX2ViX3Bpbl9jb250ZXh0KHN0cnVjdCBp
OTE1X2V4ZWNidWZmZXIgKmViLCBzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UpCit7CisJaW50IGVy
cjsKKworCWlmIChsaWtlbHkoYXRvbWljX2luY19ub3RfemVybygmY2UtPnBpbl9jb3VudCkpKQor
CQlyZXR1cm4gMDsKKworCWVyciA9IG11dGV4X2xvY2tfaW50ZXJydXB0aWJsZSgmZWItPmk5MTUt
PmRybS5zdHJ1Y3RfbXV0ZXgpOworCWlmIChlcnIpCisJCXJldHVybiBlcnI7CisKKwllcnIgPSBf
X2ludGVsX2NvbnRleHRfZG9fcGluKGNlKTsKKwltdXRleF91bmxvY2soJmViLT5pOTE1LT5kcm0u
c3RydWN0X211dGV4KTsKKworCXJldHVybiBlcnI7Cit9CisKK3N0YXRpYyB2b2lkCitfX2ViX3Vu
cGluX2NvbnRleHQoc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIsIHN0cnVjdCBpbnRlbF9jb250
ZXh0ICpjZSkKK3sKKwlpZiAobGlrZWx5KGF0b21pY19hZGRfdW5sZXNzKCZjZS0+cGluX2NvdW50
LCAtMSwgMSkpKQorCQlyZXR1cm47CisKKwltdXRleF9sb2NrKCZlYi0+aTkxNS0+ZHJtLnN0cnVj
dF9tdXRleCk7CisJaW50ZWxfY29udGV4dF91bnBpbihjZSk7CisJbXV0ZXhfdW5sb2NrKCZlYi0+
aTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7Cit9CisKK3N0YXRpYyBpbnQgX19lYl9waW5fZW5naW5l
KHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViLCBzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UpCit7
CisJc3RydWN0IGludGVsX3RpbWVsaW5lICp0bDsKKwlzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycTsK
IAlpbnQgZXJyOwogCiAJLyoKQEAgLTIxMzUsNyArMjE0Myw3IEBAIHN0YXRpYyBpbnQgZWJfcGlu
X2NvbnRleHQoc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIsIHN0cnVjdCBpbnRlbF9jb250ZXh0
ICpjZSkKIAkgKiBHR1RUIHNwYWNlLCBzbyBkbyB0aGlzIGZpcnN0IGJlZm9yZSB3ZSByZXNlcnZl
IGEgc2Vxbm8gZm9yCiAJICogb3Vyc2VsdmVzLgogCSAqLwotCWVyciA9IGludGVsX2NvbnRleHRf
cGluKGNlKTsKKwllcnIgPSBfX2ViX3Bpbl9jb250ZXh0KGViLCBjZSk7CiAJaWYgKGVycikKIAkJ
cmV0dXJuIGVycjsKIApAQCAtMjE0NywyMyArMjE1NSw0MyBAQCBzdGF0aWMgaW50IGViX3Bpbl9j
b250ZXh0KHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViLCBzdHJ1Y3QgaW50ZWxfY29udGV4dCAq
Y2UpCiAJICogdW50aWwgdGhlIHRpbWVsaW5lIGlzIGlkbGUsIHdoaWNoIGluIHR1cm4gcmVsZWFz
ZXMgdGhlIHdha2VyZWYKIAkgKiB0YWtlbiBvbiB0aGUgZW5naW5lLCBhbmQgdGhlIHBhcmVudCBk
ZXZpY2UuCiAJICovCi0JZXJyID0gaW50ZWxfY29udGV4dF90aW1lbGluZV9sb2NrKGNlKTsKLQlp
ZiAoZXJyKQorCXRsID0gaW50ZWxfY29udGV4dF90aW1lbGluZV9sb2NrKGNlKTsKKwlpZiAoSVNf
RVJSKHRsKSkgeworCQllcnIgPSBQVFJfRVJSKHRsKTsKIAkJZ290byBlcnJfdW5waW47CisJfQog
CiAJaW50ZWxfY29udGV4dF9lbnRlcihjZSk7Ci0JaW50ZWxfY29udGV4dF90aW1lbGluZV91bmxv
Y2soY2UpOworCXJxID0gZWJfdGhyb3R0bGUoY2UpOworCisJaW50ZWxfY29udGV4dF90aW1lbGlu
ZV91bmxvY2sodGwpOworCisJaWYgKHJxKSB7CisJCWlmIChpOTE1X3JlcXVlc3Rfd2FpdChycSwK
KwkJCQkgICAgICBJOTE1X1dBSVRfSU5URVJSVVBUSUJMRSwKKwkJCQkgICAgICBNQVhfU0NIRURV
TEVfVElNRU9VVCkgPCAwKSB7CisJCQlpOTE1X3JlcXVlc3RfcHV0KHJxKTsKKwkJCWVyciA9IC1F
SU5UUjsKKwkJCWdvdG8gZXJyX2V4aXQ7CisJCX0KKworCQlpOTE1X3JlcXVlc3RfcHV0KHJxKTsK
Kwl9CiAKIAllYi0+ZW5naW5lID0gY2UtPmVuZ2luZTsKIAllYi0+Y29udGV4dCA9IGNlOwogCXJl
dHVybiAwOwogCitlcnJfZXhpdDoKKwltdXRleF9sb2NrKCZ0bC0+bXV0ZXgpOworCWludGVsX2Nv
bnRleHRfZXhpdChjZSk7CisJaW50ZWxfY29udGV4dF90aW1lbGluZV91bmxvY2sodGwpOwogZXJy
X3VucGluOgotCWludGVsX2NvbnRleHRfdW5waW4oY2UpOworCV9fZWJfdW5waW5fY29udGV4dChl
YiwgY2UpOwogCXJldHVybiBlcnI7CiB9CiAKLXN0YXRpYyB2b2lkIGViX3VucGluX2NvbnRleHQo
c3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIpCitzdGF0aWMgdm9pZCBlYl91bnBpbl9lbmdpbmUo
c3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIpCiB7CiAJc3RydWN0IGludGVsX2NvbnRleHQgKmNl
ID0gZWItPmNvbnRleHQ7CiAJc3RydWN0IGludGVsX3RpbWVsaW5lICp0bCA9IGNlLT5yaW5nLT50
aW1lbGluZTsKQEAgLTIxNzIsNyArMjIwMCw3IEBAIHN0YXRpYyB2b2lkIGViX3VucGluX2NvbnRl
eHQoc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIpCiAJaW50ZWxfY29udGV4dF9leGl0KGNlKTsK
IAltdXRleF91bmxvY2soJnRsLT5tdXRleCk7CiAKLQlpbnRlbF9jb250ZXh0X3VucGluKGNlKTsK
KwlfX2ViX3VucGluX2NvbnRleHQoZWIsIGNlKTsKIH0KIAogc3RhdGljIHVuc2lnbmVkIGludApA
QCAtMjIxNyw5ICsyMjQ1LDkgQEAgZWJfc2VsZWN0X2xlZ2FjeV9yaW5nKHN0cnVjdCBpOTE1X2V4
ZWNidWZmZXIgKmViLAogfQogCiBzdGF0aWMgaW50Ci1lYl9zZWxlY3RfZW5naW5lKHN0cnVjdCBp
OTE1X2V4ZWNidWZmZXIgKmViLAotCQkgc3RydWN0IGRybV9maWxlICpmaWxlLAotCQkgc3RydWN0
IGRybV9pOTE1X2dlbV9leGVjYnVmZmVyMiAqYXJncykKK2ViX3Bpbl9lbmdpbmUoc3RydWN0IGk5
MTVfZXhlY2J1ZmZlciAqZWIsCisJICAgICAgc3RydWN0IGRybV9maWxlICpmaWxlLAorCSAgICAg
IHN0cnVjdCBkcm1faTkxNV9nZW1fZXhlY2J1ZmZlcjIgKmFyZ3MpCiB7CiAJc3RydWN0IGludGVs
X2NvbnRleHQgKmNlOwogCXVuc2lnbmVkIGludCBpZHg7CkBAIC0yMjM0LDcgKzIyNjIsNyBAQCBl
Yl9zZWxlY3RfZW5naW5lKHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViLAogCWlmIChJU19FUlIo
Y2UpKQogCQlyZXR1cm4gUFRSX0VSUihjZSk7CiAKLQllcnIgPSBlYl9waW5fY29udGV4dChlYiwg
Y2UpOworCWVyciA9IF9fZWJfcGluX2VuZ2luZShlYiwgY2UpOwogCWludGVsX2NvbnRleHRfcHV0
KGNlKTsKIAogCXJldHVybiBlcnI7CkBAIC0yNDUyLDE2ICsyNDgwLDEyIEBAIGk5MTVfZ2VtX2Rv
X2V4ZWNidWZmZXIoc3RydWN0IGRybV9kZXZpY2UgKmRldiwKIAlpZiAodW5saWtlbHkoZXJyKSkK
IAkJZ290byBlcnJfZGVzdHJveTsKIAotCWVyciA9IGk5MTVfbXV0ZXhfbG9ja19pbnRlcnJ1cHRp
YmxlKGRldik7Ci0JaWYgKGVycikKLQkJZ290byBlcnJfY29udGV4dDsKLQotCWVyciA9IGViX3Nl
bGVjdF9lbmdpbmUoJmViLCBmaWxlLCBhcmdzKTsKKwllcnIgPSBlYl9waW5fZW5naW5lKCZlYiwg
ZmlsZSwgYXJncyk7CiAJaWYgKHVubGlrZWx5KGVycikpCi0JCWdvdG8gZXJyX3VubG9jazsKKwkJ
Z290byBlcnJfY29udGV4dDsKIAotCWVyciA9IGViX3dhaXRfZm9yX3JpbmcoJmViKTsgLyogbWF5
IHRlbXBvcmFyaWx5IGRyb3Agc3RydWN0X211dGV4ICovCi0JaWYgKHVubGlrZWx5KGVycikpCisJ
ZXJyID0gaTkxNV9tdXRleF9sb2NrX2ludGVycnVwdGlibGUoZGV2KTsKKwlpZiAoZXJyKQogCQln
b3RvIGVycl9lbmdpbmU7CiAKIAllcnIgPSBlYl9yZWxvY2F0ZSgmZWIpOwpAQCAtMjYxNSwxMCAr
MjYzOSw5IEBAIGk5MTVfZ2VtX2RvX2V4ZWNidWZmZXIoc3RydWN0IGRybV9kZXZpY2UgKmRldiwK
IGVycl92bWE6CiAJaWYgKGViLmV4ZWMpCiAJCWViX3JlbGVhc2Vfdm1hcygmZWIpOwotZXJyX2Vu
Z2luZToKLQllYl91bnBpbl9jb250ZXh0KCZlYik7Ci1lcnJfdW5sb2NrOgogCW11dGV4X3VubG9j
aygmZGV2LT5zdHJ1Y3RfbXV0ZXgpOworZXJyX2VuZ2luZToKKwllYl91bnBpbl9lbmdpbmUoJmVi
KTsKIGVycl9jb250ZXh0OgogCWk5MTVfZ2VtX2NvbnRleHRfcHV0KGViLmdlbV9jb250ZXh0KTsK
IGVycl9kZXN0cm95OgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxf
Y29udGV4dC5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfY29udGV4dC5oCmluZGV4
IDEzZjI4ZGQzMTZiYy4uY2I2M2ZjN2IxYjE4IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9ndC9pbnRlbF9jb250ZXh0LmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50
ZWxfY29udGV4dC5oCkBAIC0xMiw2ICsxMiw3IEBACiAjaW5jbHVkZSAiaTkxNV9hY3RpdmUuaCIK
ICNpbmNsdWRlICJpbnRlbF9jb250ZXh0X3R5cGVzLmgiCiAjaW5jbHVkZSAiaW50ZWxfZW5naW5l
X3R5cGVzLmgiCisjaW5jbHVkZSAiaW50ZWxfdGltZWxpbmVfdHlwZXMuaCIKIAogdm9pZCBpbnRl
bF9jb250ZXh0X2luaXQoc3RydWN0IGludGVsX2NvbnRleHQgKmNlLAogCQkJc3RydWN0IGk5MTVf
Z2VtX2NvbnRleHQgKmN0eCwKQEAgLTExOCwxNyArMTE5LDI0IEBAIHN0YXRpYyBpbmxpbmUgdm9p
ZCBpbnRlbF9jb250ZXh0X3B1dChzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UpCiAJa3JlZl9wdXQo
JmNlLT5yZWYsIGNlLT5vcHMtPmRlc3Ryb3kpOwogfQogCi1zdGF0aWMgaW5saW5lIGludCBfX211
c3RfY2hlY2sKK3N0YXRpYyBpbmxpbmUgc3RydWN0IGludGVsX3RpbWVsaW5lICpfX211c3RfY2hl
Y2sKIGludGVsX2NvbnRleHRfdGltZWxpbmVfbG9jayhzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2Up
CiAJX19hY3F1aXJlcygmY2UtPnJpbmctPnRpbWVsaW5lLT5tdXRleCkKIHsKLQlyZXR1cm4gbXV0
ZXhfbG9ja19pbnRlcnJ1cHRpYmxlKCZjZS0+cmluZy0+dGltZWxpbmUtPm11dGV4KTsKKwlzdHJ1
Y3QgaW50ZWxfdGltZWxpbmUgKnRsID0gY2UtPnJpbmctPnRpbWVsaW5lOworCWludCBlcnI7CisK
KwllcnIgPSBtdXRleF9sb2NrX2ludGVycnVwdGlibGUoJnRsLT5tdXRleCk7CisJaWYgKGVycikK
KwkJcmV0dXJuIEVSUl9QVFIoZXJyKTsKKworCXJldHVybiB0bDsKIH0KIAotc3RhdGljIGlubGlu
ZSB2b2lkIGludGVsX2NvbnRleHRfdGltZWxpbmVfdW5sb2NrKHN0cnVjdCBpbnRlbF9jb250ZXh0
ICpjZSkKLQlfX3JlbGVhc2VzKCZjZS0+cmluZy0+dGltZWxpbmUtPm11dGV4KQorc3RhdGljIGlu
bGluZSB2b2lkIGludGVsX2NvbnRleHRfdGltZWxpbmVfdW5sb2NrKHN0cnVjdCBpbnRlbF90aW1l
bGluZSAqdGwpCisJX19yZWxlYXNlcygmdGwtPm11dGV4KQogewotCW11dGV4X3VubG9jaygmY2Ut
PnJpbmctPnRpbWVsaW5lLT5tdXRleCk7CisJbXV0ZXhfdW5sb2NrKCZ0bC0+bXV0ZXgpOwogfQog
CiBpbnQgaW50ZWxfY29udGV4dF9wcmVwYXJlX3JlbW90ZV9yZXF1ZXN0KHN0cnVjdCBpbnRlbF9j
b250ZXh0ICpjZSwKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2Vu
Z2luZV9jcy5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZW5naW5lX2NzLmMKaW5k
ZXggMDk1ZGRjYmQ3NWJmLi43YTdlMzg1YmI5NzkgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2d0L2ludGVsX2VuZ2luZV9jcy5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0
L2ludGVsX2VuZ2luZV9jcy5jCkBAIC03NDQsNyArNzQ0LDYgQEAgc3RhdGljIGludCBtZWFzdXJl
X2JyZWFkY3J1bWJfZHcoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lKQogCQkJCWVuZ2lu
ZS0+c3RhdHVzX3BhZ2Uudm1hKSkKIAkJZ290byBvdXRfZnJhbWU7CiAKLQlJTklUX0xJU1RfSEVB
RCgmZnJhbWUtPnJpbmcucmVxdWVzdF9saXN0KTsKIAlmcmFtZS0+cmluZy50aW1lbGluZSA9ICZm
cmFtZS0+dGltZWxpbmU7CiAJZnJhbWUtPnJpbmcudmFkZHIgPSBmcmFtZS0+Y3M7CiAJZnJhbWUt
PnJpbmcuc2l6ZSA9IHNpemVvZihmcmFtZS0+Y3MpOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvZ3QvaW50ZWxfZW5naW5lX2hlYXJ0YmVhdC5jIGIvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ3QvaW50ZWxfZW5naW5lX2hlYXJ0YmVhdC5jCmluZGV4IDQyMzMwYjEwNzRlNi4uMjgxYTcy
YWY4NDA2IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVf
aGVhcnRiZWF0LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZW5naW5lX2hl
YXJ0YmVhdC5jCkBAIC0yNCw2ICsyNCw3IEBAIHN0YXRpYyB2b2lkIGhlYXJ0YmVhdChzdHJ1Y3Qg
d29ya19zdHJ1Y3QgKndyaykKIAlzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUgPQogCQlj
b250YWluZXJfb2Yod3JrLCB0eXBlb2YoKmVuZ2luZSksIGhlYXJ0YmVhdC53b3JrKTsKIAlzdHJ1
Y3QgaW50ZWxfY29udGV4dCAqY2UgPSBlbmdpbmUtPmtlcm5lbF9jb250ZXh0OworCXN0cnVjdCBp
bnRlbF90aW1lbGluZSAqdGw7CiAJc3RydWN0IGk5MTVfcmVxdWVzdCAqcnE7CiAKIAlpZiAoIWlu
dGVsX2VuZ2luZV9wbV9nZXRfaWZfYXdha2UoZW5naW5lKSkKQEAgLTU3LDcgKzU4LDggQEAgc3Rh
dGljIHZvaWQgaGVhcnRiZWF0KHN0cnVjdCB3b3JrX3N0cnVjdCAqd3JrKQogCWlmIChlbmdpbmUt
Pndha2VyZWZfc2VyaWFsID09IGVuZ2luZS0+c2VyaWFsKQogCQlnb3RvIG91dDsKIAotCWlmIChp
bnRlbF9jb250ZXh0X3RpbWVsaW5lX2xvY2soY2UpKQorCXRsID0gaW50ZWxfY29udGV4dF90aW1l
bGluZV9sb2NrKGNlKTsKKwlpZiAoSVNfRVJSKHRsKSkKIAkJZ290byBvdXQ7CiAKIAlpbnRlbF9j
b250ZXh0X2VudGVyKGNlKTsKQEAgLTczLDcgKzc1LDcgQEAgc3RhdGljIHZvaWQgaGVhcnRiZWF0
KHN0cnVjdCB3b3JrX3N0cnVjdCAqd3JrKQogCV9faTkxNV9yZXF1ZXN0X2NvbW1pdChycSk7CiAK
IHVubG9jazoKLQlpbnRlbF9jb250ZXh0X3RpbWVsaW5lX3VubG9jayhjZSk7CisJaW50ZWxfY29u
dGV4dF90aW1lbGluZV91bmxvY2sodGwpOwogb3V0OgogCXNjaGVkdWxlX2RlbGF5ZWRfd29yaygm
ZW5naW5lLT5oZWFydGJlYXQsIGRlbGF5KCkpOwogCWludGVsX2VuZ2luZV9wbV9wdXQoZW5naW5l
KTsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZV90eXBl
cy5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZW5naW5lX3R5cGVzLmgKaW5kZXgg
MGVmMDdhZGEwYWU3Li5kOGI4MmI2ZjdkYjkgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2d0L2ludGVsX2VuZ2luZV90eXBlcy5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0
L2ludGVsX2VuZ2luZV90eXBlcy5oCkBAIC02Myw4ICs2Myw2IEBAIHN0cnVjdCBpbnRlbF9yaW5n
IHsKIAl2b2lkICp2YWRkcjsKIAogCXN0cnVjdCBpbnRlbF90aW1lbGluZSAqdGltZWxpbmU7Ci0J
c3RydWN0IGxpc3RfaGVhZCByZXF1ZXN0X2xpc3Q7Ci0Jc3RydWN0IGxpc3RfaGVhZCBhY3RpdmVf
bGluazsKIAogCS8qCiAJICogQXMgd2UgaGF2ZSB0d28gdHlwZXMgb2YgcmluZ3MsIG9uZSBnbG9i
YWwgdG8gdGhlIGVuZ2luZSB1c2VkCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9n
dC9pbnRlbF9ndC5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZ3QuYwppbmRleCAx
MTdjYTY0MTQ5ZTEuLmMyYTI1YzdhZGI0NiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ3QvaW50ZWxfZ3QuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9ndC5j
CkBAIC0xNCw3ICsxNCw2IEBAIHZvaWQgaW50ZWxfZ3RfaW5pdF9lYXJseShzdHJ1Y3QgaW50ZWxf
Z3QgKmd0LCBzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKIAlndC0+aTkxNSA9IGk5MTU7
CiAJZ3QtPnVuY29yZSA9ICZpOTE1LT51bmNvcmU7CiAKLQlJTklUX0xJU1RfSEVBRCgmZ3QtPmFj
dGl2ZV9yaW5ncyk7CiAJSU5JVF9MSVNUX0hFQUQoJmd0LT5jbG9zZWRfdm1hKTsKIAogCXNwaW5f
bG9ja19pbml0KCZndC0+Y2xvc2VkX2xvY2spOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJt
L2k5MTUvZ3QvaW50ZWxfZ3RfdHlwZXMuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVs
X2d0X3R5cGVzLmgKaW5kZXggYjA5N2Q4M2ZlMTEyLi43MGI4ZjAyNWU0ZGEgMTAwNjQ0Ci0tLSBh
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2d0X3R5cGVzLmgKKysrIGIvZHJpdmVycy9n
cHUvZHJtL2k5MTUvZ3QvaW50ZWxfZ3RfdHlwZXMuaApAQCAtNDAsOCArNDAsNiBAQCBzdHJ1Y3Qg
aW50ZWxfZ3QgewogCQlzdHJ1Y3QgbGlzdF9oZWFkIGh3c3BfZnJlZV9saXN0OwogCX0gdGltZWxp
bmVzOwogCi0Jc3RydWN0IGxpc3RfaGVhZCBhY3RpdmVfcmluZ3M7Ci0KIAlzdHJ1Y3QgaW50ZWxf
d2FrZXJlZiB3YWtlcmVmOwogCiAJc3RydWN0IGxpc3RfaGVhZCBjbG9zZWRfdm1hOwpkaWZmIC0t
Z2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjLmMgYi9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9ndC9pbnRlbF9scmMuYwppbmRleCA4OGUwYWQ5M2I5YTkuLjJiZTk3ZDY4YTEwMyAx
MDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjLmMKKysrIGIvZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjLmMKQEAgLTE2MzQsNiArMTYzNCw3IEBAIHN0
YXRpYyB2b2lkIGV4ZWNsaXN0c19jb250ZXh0X3VucGluKHN0cnVjdCBpbnRlbF9jb250ZXh0ICpj
ZSkKIHsKIAlpOTE1X2dlbV9jb250ZXh0X3VucGluX2h3X2lkKGNlLT5nZW1fY29udGV4dCk7CiAJ
aTkxNV9nZW1fb2JqZWN0X3VucGluX21hcChjZS0+c3RhdGUtPm9iaik7CisJaW50ZWxfcmluZ19y
ZXNldChjZS0+cmluZywgY2UtPnJpbmctPnRhaWwpOwogfQogCiBzdGF0aWMgdm9pZApkaWZmIC0t
Z2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfcmluZ2J1ZmZlci5jIGIvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfcmluZ2J1ZmZlci5jCmluZGV4IGQ4ZWZiODhmMzNmMy4u
OWQ5YmU1ZmVkOWZjIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9y
aW5nYnVmZmVyLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfcmluZ2J1ZmZl
ci5jCkBAIC0xMjc1LDcgKzEyNzUsNyBAQCB2b2lkIGludGVsX3JpbmdfdW5waW4oc3RydWN0IGlu
dGVsX3JpbmcgKnJpbmcpCiAJR0VNX1RSQUNFKCJyaW5nOiVsbHggdW5waW5cbiIsIHJpbmctPnRp
bWVsaW5lLT5mZW5jZV9jb250ZXh0KTsKIAogCS8qIERpc2NhcmQgYW55IHVudXNlZCBieXRlcyBi
ZXlvbmQgdGhhdCBzdWJtaXR0ZWQgdG8gaHcuICovCi0JaW50ZWxfcmluZ19yZXNldChyaW5nLCBy
aW5nLT50YWlsKTsKKwlpbnRlbF9yaW5nX3Jlc2V0KHJpbmcsIHJpbmctPmVtaXQpOwogCiAJaTkx
NV92bWFfdW5zZXRfZ2d0dF93cml0ZSh2bWEpOwogCWlmIChpOTE1X3ZtYV9pc19tYXBfYW5kX2Zl
bmNlYWJsZSh2bWEpKQpAQCAtMTM0MCw3ICsxMzQwLDYgQEAgaW50ZWxfZW5naW5lX2NyZWF0ZV9y
aW5nKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSwKIAkJcmV0dXJuIEVSUl9QVFIoLUVO
T01FTSk7CiAKIAlrcmVmX2luaXQoJnJpbmctPnJlZik7Ci0JSU5JVF9MSVNUX0hFQUQoJnJpbmct
PnJlcXVlc3RfbGlzdCk7CiAJcmluZy0+dGltZWxpbmUgPSBpbnRlbF90aW1lbGluZV9nZXQodGlt
ZWxpbmUpOwogCiAJcmluZy0+c2l6ZSA9IHNpemU7CkBAIC0xODg4LDIxICsxODg3LDI1IEBAIHN0
YXRpYyBpbnQgcmluZ19yZXF1ZXN0X2FsbG9jKHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJlcXVlc3Qp
CiAKIHN0YXRpYyBub2lubGluZSBpbnQgd2FpdF9mb3Jfc3BhY2Uoc3RydWN0IGludGVsX3Jpbmcg
KnJpbmcsIHVuc2lnbmVkIGludCBieXRlcykKIHsKKwlzdHJ1Y3QgaW50ZWxfdGltZWxpbmUgKnRs
ID0gcmluZy0+dGltZWxpbmU7CiAJc3RydWN0IGk5MTVfcmVxdWVzdCAqdGFyZ2V0OwogCWxvbmcg
dGltZW91dDsKIAogCWlmIChpbnRlbF9yaW5nX3VwZGF0ZV9zcGFjZShyaW5nKSA+PSBieXRlcykK
IAkJcmV0dXJuIDA7CiAKLQlHRU1fQlVHX09OKGxpc3RfZW1wdHkoJnJpbmctPnJlcXVlc3RfbGlz
dCkpOwotCWxpc3RfZm9yX2VhY2hfZW50cnkodGFyZ2V0LCAmcmluZy0+cmVxdWVzdF9saXN0LCBy
aW5nX2xpbmspIHsKKwlHRU1fQlVHX09OKGxpc3RfZW1wdHkoJnRsLT5yZXF1ZXN0cykpOworCWxp
c3RfZm9yX2VhY2hfZW50cnkodGFyZ2V0LCAmdGwtPnJlcXVlc3RzLCBsaW5rKSB7CisJCWlmICh0
YXJnZXQtPnJpbmcgIT0gcmluZykKKwkJCWNvbnRpbnVlOworCiAJCS8qIFdvdWxkIGNvbXBsZXRp
b24gb2YgdGhpcyByZXF1ZXN0IGZyZWUgZW5vdWdoIHNwYWNlPyAqLwogCQlpZiAoYnl0ZXMgPD0g
X19pbnRlbF9yaW5nX3NwYWNlKHRhcmdldC0+cG9zdGZpeCwKIAkJCQkJCXJpbmctPmVtaXQsIHJp
bmctPnNpemUpKQogCQkJYnJlYWs7CiAJfQogCi0JaWYgKFdBUk5fT04oJnRhcmdldC0+cmluZ19s
aW5rID09ICZyaW5nLT5yZXF1ZXN0X2xpc3QpKQorCWlmIChHRU1fV0FSTl9PTigmdGFyZ2V0LT5s
aW5rID09ICZ0bC0+cmVxdWVzdHMpKQogCQlyZXR1cm4gLUVOT1NQQzsKIAogCXRpbWVvdXQgPSBp
OTE1X3JlcXVlc3Rfd2FpdCh0YXJnZXQsCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9ndC9tb2NrX2VuZ2luZS5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvbW9ja19lbmdpbmUu
YwppbmRleCAyODRmMmU1YWQyY2YuLjNlZDUxMWU4ZTA5OCAxMDA2NDQKLS0tIGEvZHJpdmVycy9n
cHUvZHJtL2k5MTUvZ3QvbW9ja19lbmdpbmUuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9n
dC9tb2NrX2VuZ2luZS5jCkBAIC02OCw3ICs2OCw2IEBAIHN0YXRpYyBzdHJ1Y3QgaW50ZWxfcmlu
ZyAqbW9ja19yaW5nKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKIAlyaW5nLT5iYXNl
LnRpbWVsaW5lID0gJnJpbmctPnRpbWVsaW5lOwogCWF0b21pY19zZXQoJnJpbmctPmJhc2UucGlu
X2NvdW50LCAxKTsKIAotCUlOSVRfTElTVF9IRUFEKCZyaW5nLT5iYXNlLnJlcXVlc3RfbGlzdCk7
CiAJaW50ZWxfcmluZ191cGRhdGVfc3BhY2UoJnJpbmctPmJhc2UpOwogCiAJcmV0dXJuICZyaW5n
LT5iYXNlOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Qvc2VsZnRlc3RfY29u
dGV4dC5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Qvc2VsZnRlc3RfY29udGV4dC5jCmluZGV4
IGUzYjQ1ZmU3NDdhZS4uNmRkMWRmZGEzYzVhIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9ndC9zZWxmdGVzdF9jb250ZXh0LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Qv
c2VsZnRlc3RfY29udGV4dC5jCkBAIC0yMCwxMCArMjAsMTMgQEAgc3RhdGljIGludCByZXF1ZXN0
X3N5bmMoc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEpCiAKIAlpOTE1X3JlcXVlc3RfYWRkKHJxKTsK
IAl0aW1lb3V0ID0gaTkxNV9yZXF1ZXN0X3dhaXQocnEsIDAsIEhaIC8gMTApOwotCWlmICh0aW1l
b3V0IDwgMCkKKwlpZiAodGltZW91dCA8IDApIHsKIAkJZXJyID0gdGltZW91dDsKLQllbHNlCisJ
fSBlbHNlIHsKKwkJbXV0ZXhfbG9jaygmcnEtPnRpbWVsaW5lLT5tdXRleCk7CiAJCWk5MTVfcmVx
dWVzdF9yZXRpcmVfdXB0byhycSk7CisJCW11dGV4X3VubG9jaygmcnEtPnRpbWVsaW5lLT5tdXRl
eCk7CisJfQogCiAJaTkxNV9yZXF1ZXN0X3B1dChycSk7CiAKQEAgLTM1LDYgKzM4LDcgQEAgc3Rh
dGljIGludCBjb250ZXh0X3N5bmMoc3RydWN0IGludGVsX2NvbnRleHQgKmNlKQogCXN0cnVjdCBp
bnRlbF90aW1lbGluZSAqdGwgPSBjZS0+cmluZy0+dGltZWxpbmU7CiAJaW50IGVyciA9IDA7CiAK
KwltdXRleF9sb2NrKCZ0bC0+bXV0ZXgpOwogCWRvIHsKIAkJc3RydWN0IGk5MTVfcmVxdWVzdCAq
cnE7CiAJCWxvbmcgdGltZW91dDsKQEAgLTU1LDYgKzU5LDcgQEAgc3RhdGljIGludCBjb250ZXh0
X3N5bmMoc3RydWN0IGludGVsX2NvbnRleHQgKmNlKQogCiAJCWk5MTVfcmVxdWVzdF9wdXQocnEp
OwogCX0gd2hpbGUgKCFlcnIpOworCW11dGV4X3VubG9jaygmdGwtPm11dGV4KTsKIAogCXJldHVy
biBlcnI7CiB9CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3JlcXVlc3Qu
YyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcmVxdWVzdC5jCmluZGV4IDgxMDk0ZjI1MGJk
Yi4uZDIwMzc2M2I3ZDg2IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3Jl
cXVlc3QuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3JlcXVlc3QuYwpAQCAtMTgw
LDQwICsxODAsNiBAQCBpOTE1X3JlcXVlc3RfcmVtb3ZlX2Zyb21fY2xpZW50KHN0cnVjdCBpOTE1
X3JlcXVlc3QgKnJlcXVlc3QpCiAJc3Bpbl91bmxvY2soJmZpbGVfcHJpdi0+bW0ubG9jayk7CiB9
CiAKLXN0YXRpYyB2b2lkIGFkdmFuY2VfcmluZyhzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpyZXF1ZXN0
KQotewotCXN0cnVjdCBpbnRlbF9yaW5nICpyaW5nID0gcmVxdWVzdC0+cmluZzsKLQl1bnNpZ25l
ZCBpbnQgdGFpbDsKLQotCS8qCi0JICogV2Uga25vdyB0aGUgR1BVIG11c3QgaGF2ZSByZWFkIHRo
ZSByZXF1ZXN0IHRvIGhhdmUKLQkgKiBzZW50IHVzIHRoZSBzZXFubyArIGludGVycnVwdCwgc28g
dXNlIHRoZSBwb3NpdGlvbgotCSAqIG9mIHRhaWwgb2YgdGhlIHJlcXVlc3QgdG8gdXBkYXRlIHRo
ZSBsYXN0IGtub3duIHBvc2l0aW9uCi0JICogb2YgdGhlIEdQVSBoZWFkLgotCSAqCi0JICogTm90
ZSB0aGlzIHJlcXVpcmVzIHRoYXQgd2UgYXJlIGFsd2F5cyBjYWxsZWQgaW4gcmVxdWVzdAotCSAq
IGNvbXBsZXRpb24gb3JkZXIuCi0JICovCi0JR0VNX0JVR19PTighbGlzdF9pc19maXJzdCgmcmVx
dWVzdC0+cmluZ19saW5rLCAmcmluZy0+cmVxdWVzdF9saXN0KSk7Ci0JaWYgKGxpc3RfaXNfbGFz
dCgmcmVxdWVzdC0+cmluZ19saW5rLCAmcmluZy0+cmVxdWVzdF9saXN0KSkgewotCQkvKgotCQkg
KiBXZSBtYXkgcmFjZSBoZXJlIHdpdGggZXhlY2xpc3RzIHJlc3VibWl0dGluZyB0aGlzIHJlcXVl
c3QKLQkJICogYXMgd2UgcmV0aXJlIGl0LiBUaGUgcmVzdWJtaXNzaW9uIHdpbGwgbW92ZSB0aGUg
cmluZy0+dGFpbAotCQkgKiBmb3J3YXJkcyAodG8gcmVxdWVzdC0+d2FfdGFpbCkuIFdlIGVpdGhl
ciByZWFkIHRoZQotCQkgKiBjdXJyZW50IHZhbHVlIHRoYXQgd2FzIHdyaXR0ZW4gdG8gaHcsIG9y
IHRoZSB2YWx1ZSB0aGF0Ci0JCSAqIGlzIGp1c3QgYWJvdXQgdG8gYmUuIEVpdGhlciB3b3Jrcywg
aWYgd2UgbWlzcyB0aGUgbGFzdCB0d28KLQkJICogbm9vcHMgLSB0aGV5IGFyZSBzYWZlIHRvIGJl
IHJlcGxheWVkIG9uIGEgcmVzZXQuCi0JCSAqLwotCQl0YWlsID0gUkVBRF9PTkNFKHJlcXVlc3Qt
PnRhaWwpOwotCQlsaXN0X2RlbCgmcmluZy0+YWN0aXZlX2xpbmspOwotCX0gZWxzZSB7Ci0JCXRh
aWwgPSByZXF1ZXN0LT5wb3N0Zml4OwotCX0KLQlsaXN0X2RlbF9pbml0KCZyZXF1ZXN0LT5yaW5n
X2xpbmspOwotCi0JcmluZy0+aGVhZCA9IHRhaWw7Ci19Ci0KIHN0YXRpYyB2b2lkIGZyZWVfY2Fw
dHVyZV9saXN0KHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJlcXVlc3QpCiB7CiAJc3RydWN0IGk5MTVf
Y2FwdHVyZV9saXN0ICpjYXB0dXJlOwpAQCAtMjMxLDcgKzE5Nyw3IEBAIHN0YXRpYyBib29sIGk5
MTVfcmVxdWVzdF9yZXRpcmUoc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEpCiB7CiAJc3RydWN0IGk5
MTVfYWN0aXZlX3JlcXVlc3QgKmFjdGl2ZSwgKm5leHQ7CiAKLQlsb2NrZGVwX2Fzc2VydF9oZWxk
KCZycS0+aTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CisJbG9ja2RlcF9hc3NlcnRfaGVsZCgmcnEt
PnRpbWVsaW5lLT5tdXRleCk7CiAJaWYgKCFpOTE1X3JlcXVlc3RfY29tcGxldGVkKHJxKSkKIAkJ
cmV0dXJuIGZhbHNlOwogCkBAIC0yNDMsNyArMjA5LDE3IEBAIHN0YXRpYyBib29sIGk5MTVfcmVx
dWVzdF9yZXRpcmUoc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEpCiAJR0VNX0JVR19PTighaTkxNV9z
d19mZW5jZV9zaWduYWxlZCgmcnEtPnN1Ym1pdCkpOwogCXRyYWNlX2k5MTVfcmVxdWVzdF9yZXRp
cmUocnEpOwogCi0JYWR2YW5jZV9yaW5nKHJxKTsKKwkvKgorCSAqIFdlIGtub3cgdGhlIEdQVSBt
dXN0IGhhdmUgcmVhZCB0aGUgcmVxdWVzdCB0byBoYXZlCisJICogc2VudCB1cyB0aGUgc2Vxbm8g
KyBpbnRlcnJ1cHQsIHNvIHVzZSB0aGUgcG9zaXRpb24KKwkgKiBvZiB0YWlsIG9mIHRoZSByZXF1
ZXN0IHRvIHVwZGF0ZSB0aGUgbGFzdCBrbm93biBwb3NpdGlvbgorCSAqIG9mIHRoZSBHUFUgaGVh
ZC4KKwkgKgorCSAqIE5vdGUgdGhpcyByZXF1aXJlcyB0aGF0IHdlIGFyZSBhbHdheXMgY2FsbGVk
IGluIHJlcXVlc3QKKwkgKiBjb21wbGV0aW9uIG9yZGVyLgorCSAqLworCUdFTV9CVUdfT04oIWxp
c3RfaXNfZmlyc3QoJnJxLT5saW5rLCAmcnEtPnRpbWVsaW5lLT5yZXF1ZXN0cykpOworCXJxLT5y
aW5nLT5oZWFkID0gcnEtPnBvc3RmaXg7CiAKIAkvKgogCSAqIFdhbGsgdGhyb3VnaCB0aGUgYWN0
aXZlIGxpc3QsIGNhbGxpbmcgcmV0aXJlIG9uIGVhY2guIFRoaXMgYWxsb3dzCkBAIC0zMjAsNyAr
Mjk2LDcgQEAgc3RhdGljIGJvb2wgaTkxNV9yZXF1ZXN0X3JldGlyZShzdHJ1Y3QgaTkxNV9yZXF1
ZXN0ICpycSkKIAogdm9pZCBpOTE1X3JlcXVlc3RfcmV0aXJlX3VwdG8oc3RydWN0IGk5MTVfcmVx
dWVzdCAqcnEpCiB7Ci0Jc3RydWN0IGludGVsX3JpbmcgKnJpbmcgPSBycS0+cmluZzsKKwlzdHJ1
Y3QgaW50ZWxfdGltZWxpbmUgKiBjb25zdCB0bCA9IHJxLT50aW1lbGluZTsKIAlzdHJ1Y3QgaTkx
NV9yZXF1ZXN0ICp0bXA7CiAKIAlHRU1fVFJBQ0UoIiVzIGZlbmNlICVsbHg6JWxsZCwgY3VycmVu
dCAlZFxuIiwKQEAgLTMyOCwxNSArMzA0LDExIEBAIHZvaWQgaTkxNV9yZXF1ZXN0X3JldGlyZV91
cHRvKHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxKQogCQkgIHJxLT5mZW5jZS5jb250ZXh0LCBycS0+
ZmVuY2Uuc2Vxbm8sCiAJCSAgaHdzcF9zZXFubyhycSkpOwogCi0JbG9ja2RlcF9hc3NlcnRfaGVs
ZCgmcnEtPmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOworCWxvY2tkZXBfYXNzZXJ0X2hlbGQoJnRs
LT5tdXRleCk7CiAJR0VNX0JVR19PTighaTkxNV9yZXF1ZXN0X2NvbXBsZXRlZChycSkpOwogCi0J
aWYgKGxpc3RfZW1wdHkoJnJxLT5yaW5nX2xpbmspKQotCQlyZXR1cm47Ci0KIAlkbyB7Ci0JCXRt
cCA9IGxpc3RfZmlyc3RfZW50cnkoJnJpbmctPnJlcXVlc3RfbGlzdCwKLQkJCQkgICAgICAgdHlw
ZW9mKCp0bXApLCByaW5nX2xpbmspOworCQl0bXAgPSBsaXN0X2ZpcnN0X2VudHJ5KCZ0bC0+cmVx
dWVzdHMsIHR5cGVvZigqdG1wKSwgbGluayk7CiAJfSB3aGlsZSAoaTkxNV9yZXF1ZXN0X3JldGly
ZSh0bXApICYmIHRtcCAhPSBycSk7CiB9CiAKQEAgLTU2MywyOSArNTM1LDI4IEBAIHNlbWFwaG9y
ZV9ub3RpZnkoc3RydWN0IGk5MTVfc3dfZmVuY2UgKmZlbmNlLCBlbnVtIGk5MTVfc3dfZmVuY2Vf
bm90aWZ5IHN0YXRlKQogCXJldHVybiBOT1RJRllfRE9ORTsKIH0KIAotc3RhdGljIHZvaWQgcmlu
Z19yZXRpcmVfcmVxdWVzdHMoc3RydWN0IGludGVsX3JpbmcgKnJpbmcpCitzdGF0aWMgdm9pZCBy
ZXRpcmVfcmVxdWVzdHMoc3RydWN0IGludGVsX3RpbWVsaW5lICp0bCkKIHsKIAlzdHJ1Y3QgaTkx
NV9yZXF1ZXN0ICpycSwgKnJuOwogCi0JbGlzdF9mb3JfZWFjaF9lbnRyeV9zYWZlKHJxLCBybiwg
JnJpbmctPnJlcXVlc3RfbGlzdCwgcmluZ19saW5rKQorCWxpc3RfZm9yX2VhY2hfZW50cnlfc2Fm
ZShycSwgcm4sICZ0bC0+cmVxdWVzdHMsIGxpbmspCiAJCWlmICghaTkxNV9yZXF1ZXN0X3JldGly
ZShycSkpCiAJCQlicmVhazsKIH0KIAogc3RhdGljIG5vaW5saW5lIHN0cnVjdCBpOTE1X3JlcXVl
c3QgKgotcmVxdWVzdF9hbGxvY19zbG93KHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSwgZ2ZwX3Qg
Z2ZwKQorcmVxdWVzdF9hbGxvY19zbG93KHN0cnVjdCBpbnRlbF90aW1lbGluZSAqdGwsIGdmcF90
IGdmcCkKIHsKLQlzdHJ1Y3QgaW50ZWxfcmluZyAqcmluZyA9IGNlLT5yaW5nOwogCXN0cnVjdCBp
OTE1X3JlcXVlc3QgKnJxOwogCi0JaWYgKGxpc3RfZW1wdHkoJnJpbmctPnJlcXVlc3RfbGlzdCkp
CisJaWYgKGxpc3RfZW1wdHkoJnRsLT5yZXF1ZXN0cykpCiAJCWdvdG8gb3V0OwogCiAJaWYgKCFn
ZnBmbGFnc19hbGxvd19ibG9ja2luZyhnZnApKQogCQlnb3RvIG91dDsKIAogCS8qIE1vdmUgb3Vy
IG9sZGVzdCByZXF1ZXN0IHRvIHRoZSBzbGFiLWNhY2hlIChpZiBub3QgaW4gdXNlISkgKi8KLQly
cSA9IGxpc3RfZmlyc3RfZW50cnkoJnJpbmctPnJlcXVlc3RfbGlzdCwgdHlwZW9mKCpycSksIHJp
bmdfbGluayk7CisJcnEgPSBsaXN0X2ZpcnN0X2VudHJ5KCZ0bC0+cmVxdWVzdHMsIHR5cGVvZigq
cnEpLCBsaW5rKTsKIAlpOTE1X3JlcXVlc3RfcmV0aXJlKHJxKTsKIAogCXJxID0ga21lbV9jYWNo
ZV9hbGxvYyhnbG9iYWwuc2xhYl9yZXF1ZXN0cywKQEAgLTU5NCwxMSArNTY1LDExIEBAIHJlcXVl
c3RfYWxsb2Nfc2xvdyhzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UsIGdmcF90IGdmcCkKIAkJcmV0
dXJuIHJxOwogCiAJLyogUmF0ZWxpbWl0IG91cnNlbHZlcyB0byBwcmV2ZW50IG9vbSBmcm9tIG1h
bGljaW91cyBjbGllbnRzICovCi0JcnEgPSBsaXN0X2xhc3RfZW50cnkoJnJpbmctPnJlcXVlc3Rf
bGlzdCwgdHlwZW9mKCpycSksIHJpbmdfbGluayk7CisJcnEgPSBsaXN0X2xhc3RfZW50cnkoJnRs
LT5yZXF1ZXN0cywgdHlwZW9mKCpycSksIGxpbmspOwogCWNvbmRfc3luY2hyb25pemVfcmN1KHJx
LT5yY3VzdGF0ZSk7CiAKIAkvKiBSZXRpcmUgb3VyIG9sZCByZXF1ZXN0cyBpbiB0aGUgaG9wZSB0
aGF0IHdlIGZyZWUgc29tZSAqLwotCXJpbmdfcmV0aXJlX3JlcXVlc3RzKHJpbmcpOworCXJldGly
ZV9yZXF1ZXN0cyh0bCk7CiAKIG91dDoKIAlyZXR1cm4ga21lbV9jYWNoZV9hbGxvYyhnbG9iYWwu
c2xhYl9yZXF1ZXN0cywgZ2ZwKTsKQEAgLTY0OSw3ICs2MjAsNyBAQCBfX2k5MTVfcmVxdWVzdF9j
cmVhdGUoc3RydWN0IGludGVsX2NvbnRleHQgKmNlLCBnZnBfdCBnZnApCiAJcnEgPSBrbWVtX2Nh
Y2hlX2FsbG9jKGdsb2JhbC5zbGFiX3JlcXVlc3RzLAogCQkJICAgICAgZ2ZwIHwgX19HRlBfUkVU
UllfTUFZRkFJTCB8IF9fR0ZQX05PV0FSTik7CiAJaWYgKHVubGlrZWx5KCFycSkpIHsKLQkJcnEg
PSByZXF1ZXN0X2FsbG9jX3Nsb3coY2UsIGdmcCk7CisJCXJxID0gcmVxdWVzdF9hbGxvY19zbG93
KHRsLCBnZnApOwogCQlpZiAoIXJxKSB7CiAJCQlyZXQgPSAtRU5PTUVNOwogCQkJZ290byBlcnJf
dW5yZXNlcnZlOwpAQCAtNzQxLDE1ICs3MTIsMTUgQEAgc3RydWN0IGk5MTVfcmVxdWVzdCAqCiBp
OTE1X3JlcXVlc3RfY3JlYXRlKHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSkKIHsKIAlzdHJ1Y3Qg
aTkxNV9yZXF1ZXN0ICpycTsKLQlpbnQgZXJyOworCXN0cnVjdCBpbnRlbF90aW1lbGluZSAqdGw7
CiAKLQllcnIgPSBpbnRlbF9jb250ZXh0X3RpbWVsaW5lX2xvY2soY2UpOwotCWlmIChlcnIpCi0J
CXJldHVybiBFUlJfUFRSKGVycik7CisJdGwgPSBpbnRlbF9jb250ZXh0X3RpbWVsaW5lX2xvY2so
Y2UpOworCWlmIChJU19FUlIodGwpKQorCQlyZXR1cm4gRVJSX0NBU1QodGwpOwogCiAJLyogTW92
ZSBvdXIgb2xkZXN0IHJlcXVlc3QgdG8gdGhlIHNsYWItY2FjaGUgKGlmIG5vdCBpbiB1c2UhKSAq
LwotCXJxID0gbGlzdF9maXJzdF9lbnRyeSgmY2UtPnJpbmctPnJlcXVlc3RfbGlzdCwgdHlwZW9m
KCpycSksIHJpbmdfbGluayk7Ci0JaWYgKCFsaXN0X2lzX2xhc3QoJnJxLT5yaW5nX2xpbmssICZj
ZS0+cmluZy0+cmVxdWVzdF9saXN0KSkKKwlycSA9IGxpc3RfZmlyc3RfZW50cnkoJnRsLT5yZXF1
ZXN0cywgdHlwZW9mKCpycSksIGxpbmspOworCWlmICghbGlzdF9pc19sYXN0KCZycS0+bGluaywg
JnRsLT5yZXF1ZXN0cykpCiAJCWk5MTVfcmVxdWVzdF9yZXRpcmUocnEpOwogCiAJaW50ZWxfY29u
dGV4dF9lbnRlcihjZSk7CkBAIC03NTksMjIgKzczMCwyMiBAQCBpOTE1X3JlcXVlc3RfY3JlYXRl
KHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSkKIAkJZ290byBlcnJfdW5sb2NrOwogCiAJLyogQ2hl
Y2sgdGhhdCB3ZSBkbyBub3QgaW50ZXJydXB0IG91cnNlbHZlcyB3aXRoIGEgbmV3IHJlcXVlc3Qg
Ki8KLQlycS0+Y29va2llID0gbG9ja2RlcF9waW5fbG9jaygmY2UtPnJpbmctPnRpbWVsaW5lLT5t
dXRleCk7CisJcnEtPmNvb2tpZSA9IGxvY2tkZXBfcGluX2xvY2soJnRsLT5tdXRleCk7CiAKIAly
ZXR1cm4gcnE7CiAKIGVycl91bmxvY2s6Ci0JaW50ZWxfY29udGV4dF90aW1lbGluZV91bmxvY2so
Y2UpOworCWludGVsX2NvbnRleHRfdGltZWxpbmVfdW5sb2NrKHRsKTsKIAlyZXR1cm4gcnE7CiB9
CiAKIHN0YXRpYyBpbnQKIGk5MTVfcmVxdWVzdF9hd2FpdF9zdGFydChzdHJ1Y3QgaTkxNV9yZXF1
ZXN0ICpycSwgc3RydWN0IGk5MTVfcmVxdWVzdCAqc2lnbmFsKQogewotCWlmIChsaXN0X2lzX2Zp
cnN0KCZzaWduYWwtPnJpbmdfbGluaywgJnNpZ25hbC0+cmluZy0+cmVxdWVzdF9saXN0KSkKKwlp
ZiAobGlzdF9pc19maXJzdCgmc2lnbmFsLT5saW5rLCAmc2lnbmFsLT5yaW5nLT50aW1lbGluZS0+
cmVxdWVzdHMpKQogCQlyZXR1cm4gMDsKIAotCXNpZ25hbCA9IGxpc3RfcHJldl9lbnRyeShzaWdu
YWwsIHJpbmdfbGluayk7CisJc2lnbmFsID0gbGlzdF9wcmV2X2VudHJ5KHNpZ25hbCwgbGluayk7
CiAJaWYgKGludGVsX3RpbWVsaW5lX3N5bmNfaXNfbGF0ZXIocnEtPnRpbWVsaW5lLCAmc2lnbmFs
LT5mZW5jZSkpCiAJCXJldHVybiAwOwogCkBAIC0xMTY3LDYgKzExMzgsNyBAQCBzdHJ1Y3QgaTkx
NV9yZXF1ZXN0ICpfX2k5MTVfcmVxdWVzdF9jb21taXQoc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEp
CiAJICovCiAJR0VNX0JVR19PTihycS0+cmVzZXJ2ZWRfc3BhY2UgPiByaW5nLT5zcGFjZSk7CiAJ
cnEtPnJlc2VydmVkX3NwYWNlID0gMDsKKwlycS0+ZW1pdHRlZF9qaWZmaWVzID0gamlmZmllczsK
IAogCS8qCiAJICogUmVjb3JkIHRoZSBwb3NpdGlvbiBvZiB0aGUgc3RhcnQgb2YgdGhlIGJyZWFk
Y3J1bWIgc28gdGhhdApAQCAtMTE4MCwxMSArMTE1Miw2IEBAIHN0cnVjdCBpOTE1X3JlcXVlc3Qg
Kl9faTkxNV9yZXF1ZXN0X2NvbW1pdChzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSkKIAogCXByZXYg
PSBfX2k5MTVfcmVxdWVzdF9hZGRfdG9fdGltZWxpbmUocnEpOwogCi0JbGlzdF9hZGRfdGFpbCgm
cnEtPnJpbmdfbGluaywgJnJpbmctPnJlcXVlc3RfbGlzdCk7Ci0JaWYgKGxpc3RfaXNfZmlyc3Qo
JnJxLT5yaW5nX2xpbmssICZyaW5nLT5yZXF1ZXN0X2xpc3QpKQotCQlsaXN0X2FkZCgmcmluZy0+
YWN0aXZlX2xpbmssICZycS0+aTkxNS0+Z3QuYWN0aXZlX3JpbmdzKTsKLQlycS0+ZW1pdHRlZF9q
aWZmaWVzID0gamlmZmllczsKLQogCS8qCiAJICogTGV0IHRoZSBiYWNrZW5kIGtub3cgYSBuZXcg
cmVxdWVzdCBoYXMgYXJyaXZlZCB0aGF0IG1heSBuZWVkCiAJICogdG8gYWRqdXN0IHRoZSBleGlz
dGluZyBleGVjdXRpb24gc2NoZWR1bGUgZHVlIHRvIGEgaGlnaCBwcmlvcml0eQpAQCAtMTIzNSwx
MCArMTIwMiwxMSBAQCBzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpfX2k5MTVfcmVxdWVzdF9jb21taXQo
c3RydWN0IGk5MTVfcmVxdWVzdCAqcnEpCiAKIHZvaWQgaTkxNV9yZXF1ZXN0X2FkZChzdHJ1Y3Qg
aTkxNV9yZXF1ZXN0ICpycSkKIHsKKwlzdHJ1Y3QgaW50ZWxfdGltZWxpbmUgKiBjb25zdCB0bCA9
IHJxLT50aW1lbGluZTsKIAlzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpwcmV2OwogCi0JbG9ja2RlcF9h
c3NlcnRfaGVsZCgmcnEtPnRpbWVsaW5lLT5tdXRleCk7Ci0JbG9ja2RlcF91bnBpbl9sb2NrKCZy
cS0+dGltZWxpbmUtPm11dGV4LCBycS0+Y29va2llKTsKKwlsb2NrZGVwX2Fzc2VydF9oZWxkKCZ0
bC0+bXV0ZXgpOworCWxvY2tkZXBfdW5waW5fbG9jaygmdGwtPm11dGV4LCBycS0+Y29va2llKTsK
IAogCXRyYWNlX2k5MTVfcmVxdWVzdF9hZGQocnEpOwogCkBAIC0xMjYxLDEwICsxMjI5LDEwIEBA
IHZvaWQgaTkxNV9yZXF1ZXN0X2FkZChzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSkKIAkgKiB3b3Jr
IG9uIGJlaGFsZiBvZiBvdGhlcnMgLS0gYnV0IGluc3RlYWQgd2Ugc2hvdWxkIGJlbmVmaXQgZnJv
bQogCSAqIGltcHJvdmVkIHJlc291cmNlIG1hbmFnZW1lbnQuIChXZWxsLCB0aGF0J3MgdGhlIHRo
ZW9yeSBhdCBsZWFzdC4pCiAJICovCi0JaWYgKHByZXYgJiYgaTkxNV9yZXF1ZXN0X2NvbXBsZXRl
ZChwcmV2KSkKKwlpZiAocHJldiAmJiBpOTE1X3JlcXVlc3RfY29tcGxldGVkKHByZXYpICYmIHBy
ZXYtPnRpbWVsaW5lID09IHRsKQogCQlpOTE1X3JlcXVlc3RfcmV0aXJlX3VwdG8ocHJldik7CiAK
LQltdXRleF91bmxvY2soJnJxLT50aW1lbGluZS0+bXV0ZXgpOworCW11dGV4X3VubG9jaygmdGwt
Pm11dGV4KTsKIH0KIAogc3RhdGljIHVuc2lnbmVkIGxvbmcgbG9jYWxfY2xvY2tfdXModW5zaWdu
ZWQgaW50ICpjcHUpCkBAIC0xNDg0LDE4ICsxNDUyLDQzIEBAIGxvbmcgaTkxNV9yZXF1ZXN0X3dh
aXQoc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEsCiAKIGJvb2wgaTkxNV9yZXRpcmVfcmVxdWVzdHMo
c3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCiB7Ci0Jc3RydWN0IGludGVsX3JpbmcgKnJp
bmcsICp0bXA7CisJc3RydWN0IGludGVsX2d0X3RpbWVsaW5lcyAqdGltZWxpbmVzID0gJmk5MTUt
Pmd0LnRpbWVsaW5lczsKKwlzdHJ1Y3QgaW50ZWxfdGltZWxpbmUgKnRsLCAqdG47CisJTElTVF9I
RUFEKGZyZWUpOworCisJc3Bpbl9sb2NrKCZ0aW1lbGluZXMtPmxvY2spOworCWxpc3RfZm9yX2Vh
Y2hfZW50cnlfc2FmZSh0bCwgdG4sICZ0aW1lbGluZXMtPmFjdGl2ZV9saXN0LCBsaW5rKSB7CisJ
CWlmICghbXV0ZXhfdHJ5bG9jaygmdGwtPm11dGV4KSkKKwkJCWNvbnRpbnVlOworCisJCWludGVs
X3RpbWVsaW5lX2dldCh0bCk7CisJCUdFTV9CVUdfT04oIXRsLT5hY3RpdmVfY291bnQpOworCQl0
bC0+YWN0aXZlX2NvdW50Kys7IC8qIHBpbiB0aGUgbGlzdCBlbGVtZW50ICovCisJCXNwaW5fdW5s
b2NrKCZ0aW1lbGluZXMtPmxvY2spOwogCi0JbG9ja2RlcF9hc3NlcnRfaGVsZCgmaTkxNS0+ZHJt
LnN0cnVjdF9tdXRleCk7CisJCXJldGlyZV9yZXF1ZXN0cyh0bCk7CiAKLQlsaXN0X2Zvcl9lYWNo
X2VudHJ5X3NhZmUocmluZywgdG1wLAotCQkJCSAmaTkxNS0+Z3QuYWN0aXZlX3JpbmdzLCBhY3Rp
dmVfbGluaykgewotCQlpbnRlbF9yaW5nX2dldChyaW5nKTsgLyogbGFzdCBycSBob2xkcyByZWZl
cmVuY2UhICovCi0JCXJpbmdfcmV0aXJlX3JlcXVlc3RzKHJpbmcpOwotCQlpbnRlbF9yaW5nX3B1
dChyaW5nKTsKKwkJc3Bpbl9sb2NrKCZ0aW1lbGluZXMtPmxvY2spOworCisJCS8qIFJlc3RhcnQg
aXRlcmF0aW9uIGFmdGVyIGRyb3BwaW5nIGxvY2sgKi8KKwkJbGlzdF9zYWZlX3Jlc2V0X25leHQo
dGwsIHRuLCBsaW5rKTsKKwkJaWYgKCEtLXRsLT5hY3RpdmVfY291bnQpCisJCQlsaXN0X2RlbCgm
dGwtPmxpbmspOworCisJCW11dGV4X3VubG9jaygmdGwtPm11dGV4KTsKKworCQkvKiBEZWZlciB0
aGUgZmluYWwgcmVsZWFzZSB0byBhZnRlciB0aGUgc3BpbmxvY2sgKi8KKwkJaWYgKHJlZmNvdW50
X2RlY19hbmRfdGVzdCgmdGwtPmtyZWYucmVmY291bnQpKSB7CisJCQlHRU1fQlVHX09OKHRsLT5h
Y3RpdmVfY291bnQpOworCQkJbGlzdF9hZGQoJnRsLT5saW5rLCAmZnJlZSk7CisJCX0KIAl9CisJ
c3Bpbl91bmxvY2soJnRpbWVsaW5lcy0+bG9jayk7CisKKwlsaXN0X2Zvcl9lYWNoX2VudHJ5X3Nh
ZmUodGwsIHRuLCAmZnJlZSwgbGluaykKKwkJX19pbnRlbF90aW1lbGluZV9mcmVlKCZ0bC0+a3Jl
Zik7CiAKLQlyZXR1cm4gIWxpc3RfZW1wdHkoJmk5MTUtPmd0LmFjdGl2ZV9yaW5ncyk7CisJcmV0
dXJuICFsaXN0X2VtcHR5KCZ0aW1lbGluZXMtPmFjdGl2ZV9saXN0KTsKIH0KIAogI2lmIElTX0VO
QUJMRUQoQ09ORklHX0RSTV9JOTE1X1NFTEZURVNUKQpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvaTkxNV9yZXF1ZXN0LmggYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3JlcXVl
c3QuaAppbmRleCAzMTNkZjNjMzcxNTguLjIyZTUwNmU5NjBlMCAxMDA2NDQKLS0tIGEvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvaTkxNV9yZXF1ZXN0LmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUv
aTkxNV9yZXF1ZXN0LmgKQEAgLTIyMyw5ICsyMjMsNiBAQCBzdHJ1Y3QgaTkxNV9yZXF1ZXN0IHsK
IAkvKiogdGltZWxpbmUtPnJlcXVlc3QgZW50cnkgZm9yIHRoaXMgcmVxdWVzdCAqLwogCXN0cnVj
dCBsaXN0X2hlYWQgbGluazsKIAotCS8qKiByaW5nLT5yZXF1ZXN0X2xpc3QgZW50cnkgZm9yIHRo
aXMgcmVxdWVzdCAqLwotCXN0cnVjdCBsaXN0X2hlYWQgcmluZ19saW5rOwotCiAJc3RydWN0IGRy
bV9pOTE1X2ZpbGVfcHJpdmF0ZSAqZmlsZV9wcml2OwogCS8qKiBmaWxlX3ByaXYgbGlzdCBlbnRy
eSBmb3IgdGhpcyByZXF1ZXN0ICovCiAJc3RydWN0IGxpc3RfaGVhZCBjbGllbnRfbGluazsKLS0g
CjIuMjIuMAoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18K
SW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0
dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

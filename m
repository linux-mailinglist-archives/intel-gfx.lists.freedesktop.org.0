Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 7720C64193
	for <lists+intel-gfx@lfdr.de>; Wed, 10 Jul 2019 08:46:51 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 2C4B88999C;
	Wed, 10 Jul 2019 06:46:49 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id BF46B8999C
 for <intel-gfx@lists.freedesktop.org>; Wed, 10 Jul 2019 06:46:47 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17193817-1500050 
 for multiple; Wed, 10 Jul 2019 07:45:04 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Wed, 10 Jul 2019 07:44:44 +0100
Message-Id: <20190710064454.682-4-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.22.0
In-Reply-To: <20190710064454.682-1-chris@chris-wilson.co.uk>
References: <20190710064454.682-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 04/14] drm/i915: Rely on spinlock protection for
 GPU error capture
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

VHJ1c3QgdGhhdCB3ZSBub3cgaGF2ZSBhZGVxdWF0ZSBwcm90ZWN0aW9uIG92ZXIgdGhlIGxvdyBs
ZXZlbCBzdHJ1Y3R1cmVzCnZpYSB0aGUgZW5naW5lLT5hY3RpdmUubG9jayB0byBhbGxvdyBvdXJz
ZWx2ZXMgdG8gY2FwdHVyZSB0aGUgR1BVIGVycm9yCnN0YXRlIHdpdGhvdXQgdGhlIGhlYXZ5IGhh
bW1lciBvZiBzdG9wX21hY2hpbmUoKS4gU2FkbHkgdGhpcyBkb2VzIG1lYW4KdGhhdCB3ZSBoYXZl
IHRvIGZvcmdvIHNvbWUgb2YgdGhlIGxlc3NlciB1c2VkIGluZm9ybWF0aW9uIChub3QgZGVyaXZl
ZApmcm9tIHRoZSBhY3RpdmUgc3RhdGUpIHRoYXQgaXMgbm90IGNvbnRyb2xsZWQgYnkgdGhlIGFj
dGl2ZSBsb2Nrcy4KCkEgdXNlZnVsIHNpZGUtZWZmZWN0IGlzIHRoYXQgdGhpcyBhbGxvd3MgdXMg
dG8gcmVzdG9yZSBlcnJvciBjYXB0dXJpbmcKZm9yIEJyYXN3ZWxsIGFuZCBCcm94dG9uLgoKU2ln
bmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28udWs+Ci0tLQog
ZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW1fZ3R0LmMgICB8ICAgNSAtCiBkcml2ZXJzL2dw
dS9kcm0vaTkxNS9pOTE1X2dwdV9lcnJvci5jIHwgNDAxICsrKysrKysrLS0tLS0tLS0tLS0tLS0t
LS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dwdV9lcnJvci5oIHwgIDE2IC0KIDMgZmls
ZXMgY2hhbmdlZCwgMTE3IGluc2VydGlvbnMoKyksIDMwNSBkZWxldGlvbnMoLSkKCmRpZmYgLS1n
aXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuYyBiL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2k5MTVfZ2VtX2d0dC5jCmluZGV4IDIzNmM5NjRkZDc2MS4uZTA2NDVjZTRmYjg0IDEw
MDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuYworKysgYi9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuYwpAQCAtMzEzNSwxMSArMzEzNSw2IEBAIHN0
YXRpYyBpbnQgZ2VuOF9nbWNoX3Byb2JlKHN0cnVjdCBpOTE1X2dndHQgKmdndHQpCiAJCWdndHQt
PnZtLmluc2VydF9wYWdlICAgID0gYnh0X3Z0ZF9nZ3R0X2luc2VydF9wYWdlX19CS0w7CiAJCWlm
IChnZ3R0LT52bS5jbGVhcl9yYW5nZSAhPSBub3BfY2xlYXJfcmFuZ2UpCiAJCQlnZ3R0LT52bS5j
bGVhcl9yYW5nZSA9IGJ4dF92dGRfZ2d0dF9jbGVhcl9yYW5nZV9fQktMOwotCi0JCS8qIFByZXZl
bnQgcmVjdXJzaXZlbHkgY2FsbGluZyBzdG9wX21hY2hpbmUoKSBhbmQgZGVhZGxvY2tzLiAqLwot
CQlkZXZfaW5mbyhkZXZfcHJpdi0+ZHJtLmRldiwKLQkJCSAiRGlzYWJsaW5nIGVycm9yIGNhcHR1
cmUgZm9yIFZULWQgd29ya2Fyb3VuZFxuIik7Ci0JCWk5MTVfZGlzYWJsZV9lcnJvcl9zdGF0ZShk
ZXZfcHJpdiwgLUVOT0RFVik7CiAJfQogCiAJZ2d0dC0+aW52YWxpZGF0ZSA9IGdlbjZfZ2d0dF9p
bnZhbGlkYXRlOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9ncHVfZXJy
b3IuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ3B1X2Vycm9yLmMKaW5kZXggZjI5N2E0
M2RmMWU5Li4yYWY4ODNkY2NmYzcgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5
MTVfZ3B1X2Vycm9yLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9ncHVfZXJyb3Iu
YwpAQCAtMzAsNyArMzAsNiBAQAogI2luY2x1ZGUgPGxpbnV4L2FzY2lpODUuaD4KICNpbmNsdWRl
IDxsaW51eC9ubWkuaD4KICNpbmNsdWRlIDxsaW51eC9zY2F0dGVybGlzdC5oPgotI2luY2x1ZGUg
PGxpbnV4L3N0b3BfbWFjaGluZS5oPgogI2luY2x1ZGUgPGxpbnV4L3V0c25hbWUuaD4KICNpbmNs
dWRlIDxsaW51eC96bGliLmg+CiAKQEAgLTQ2LDYgKzQ1LDkgQEAKICNpbmNsdWRlICJpOTE1X3Nj
YXR0ZXJsaXN0LmgiCiAjaW5jbHVkZSAiaW50ZWxfY3NyLmgiCiAKKyNkZWZpbmUgQUxMT1dfRkFJ
TCAoR0ZQX0tFUk5FTCB8IF9fR0ZQX1JFVFJZX01BWUZBSUwgfCBfX0dGUF9OT1dBUk4pCisjZGVm
aW5lIEFUT01JQ19NQVlGQUlMIChHRlBfQVRPTUlDIHwgX19HRlBfTk9XQVJOKQorCiBzdGF0aWMg
aW5saW5lIGNvbnN0IHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKgogZW5naW5lX2xvb2t1cChjb25z
dCBzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSwgdW5zaWduZWQgaW50IGlkKQogewpAQCAt
NjcsMjYgKzY5LDYgQEAgZW5naW5lX25hbWUoY29uc3Qgc3RydWN0IGRybV9pOTE1X3ByaXZhdGUg
Kmk5MTUsIHVuc2lnbmVkIGludCBpZCkKIAlyZXR1cm4gX19lbmdpbmVfbmFtZShlbmdpbmVfbG9v
a3VwKGk5MTUsIGlkKSk7CiB9CiAKLXN0YXRpYyBjb25zdCBjaGFyICp0aWxpbmdfZmxhZyhpbnQg
dGlsaW5nKQotewotCXN3aXRjaCAodGlsaW5nKSB7Ci0JZGVmYXVsdDoKLQljYXNlIEk5MTVfVElM
SU5HX05PTkU6IHJldHVybiAiIjsKLQljYXNlIEk5MTVfVElMSU5HX1g6IHJldHVybiAiIFgiOwot
CWNhc2UgSTkxNV9USUxJTkdfWTogcmV0dXJuICIgWSI7Ci0JfQotfQotCi1zdGF0aWMgY29uc3Qg
Y2hhciAqZGlydHlfZmxhZyhpbnQgZGlydHkpCi17Ci0JcmV0dXJuIGRpcnR5ID8gIiBkaXJ0eSIg
OiAiIjsKLX0KLQotc3RhdGljIGNvbnN0IGNoYXIgKnB1cmdlYWJsZV9mbGFnKGludCBwdXJnZWFi
bGUpCi17Ci0JcmV0dXJuIHB1cmdlYWJsZSA/ICIgcHVyZ2VhYmxlIiA6ICIiOwotfQotCiBzdGF0
aWMgdm9pZCBfX3NnX3NldF9idWYoc3RydWN0IHNjYXR0ZXJsaXN0ICpzZywKIAkJCSB2b2lkICph
ZGRyLCB1bnNpZ25lZCBpbnQgbGVuLCBsb2ZmX3QgaXQpCiB7CkBAIC0xMTQsNyArOTYsNyBAQCBz
dGF0aWMgYm9vbCBfX2k5MTVfZXJyb3JfZ3JvdyhzdHJ1Y3QgZHJtX2k5MTVfZXJyb3Jfc3RhdGVf
YnVmICplLCBzaXplX3QgbGVuKQogCWlmIChlLT5jdXIgPT0gZS0+ZW5kKSB7CiAJCXN0cnVjdCBz
Y2F0dGVybGlzdCAqc2dsOwogCi0JCXNnbCA9ICh0eXBlb2Yoc2dsKSlfX2dldF9mcmVlX3BhZ2Uo
R0ZQX0tFUk5FTCk7CisJCXNnbCA9ICh0eXBlb2Yoc2dsKSlfX2dldF9mcmVlX3BhZ2UoQUxMT1df
RkFJTCk7CiAJCWlmICghc2dsKSB7CiAJCQllLT5lcnIgPSAtRU5PTUVNOwogCQkJcmV0dXJuIGZh
bHNlOwpAQCAtMTM0LDcgKzExNiw3IEBAIHN0YXRpYyBib29sIF9faTkxNV9lcnJvcl9ncm93KHN0
cnVjdCBkcm1faTkxNV9lcnJvcl9zdGF0ZV9idWYgKmUsIHNpemVfdCBsZW4pCiAJfQogCiAJZS0+
c2l6ZSA9IEFMSUdOKGxlbiArIDEsIFNaXzY0Syk7Ci0JZS0+YnVmID0ga21hbGxvYyhlLT5zaXpl
LCBHRlBfS0VSTkVMIHwgX19HRlBfTk9XQVJOIHwgX19HRlBfTk9SRVRSWSk7CisJZS0+YnVmID0g
a21hbGxvYyhlLT5zaXplLCBBTExPV19GQUlMKTsKIAlpZiAoIWUtPmJ1ZikgewogCQllLT5zaXpl
ID0gUEFHRV9BTElHTihsZW4gKyAxKTsKIAkJZS0+YnVmID0ga21hbGxvYyhlLT5zaXplLCBHRlBf
S0VSTkVMKTsKQEAgLTIyMCwyNiArMjAyLDMyIEBAIHN0cnVjdCBjb21wcmVzcyB7CiAKIHN0YXRp
YyBib29sIGNvbXByZXNzX2luaXQoc3RydWN0IGNvbXByZXNzICpjKQogewotCXN0cnVjdCB6X3N0
cmVhbV9zICp6c3RyZWFtID0gbWVtc2V0KCZjLT56c3RyZWFtLCAwLCBzaXplb2YoYy0+enN0cmVh
bSkpOworCXN0cnVjdCB6X3N0cmVhbV9zICp6c3RyZWFtID0gJmMtPnpzdHJlYW07CiAKIAl6c3Ry
ZWFtLT53b3Jrc3BhY2UgPQogCQlrbWFsbG9jKHpsaWJfZGVmbGF0ZV93b3Jrc3BhY2VzaXplKE1B
WF9XQklUUywgTUFYX01FTV9MRVZFTCksCi0JCQlHRlBfQVRPTUlDIHwgX19HRlBfTk9XQVJOKTsK
KwkJCUFMTE9XX0ZBSUwpOwogCWlmICghenN0cmVhbS0+d29ya3NwYWNlKQogCQlyZXR1cm4gZmFs
c2U7CiAKLQlpZiAoemxpYl9kZWZsYXRlSW5pdCh6c3RyZWFtLCBaX0RFRkFVTFRfQ09NUFJFU1NJ
T04pICE9IFpfT0spIHsKLQkJa2ZyZWUoenN0cmVhbS0+d29ya3NwYWNlKTsKLQkJcmV0dXJuIGZh
bHNlOwotCX0KLQogCWMtPnRtcCA9IE5VTEw7CiAJaWYgKGk5MTVfaGFzX21lbWNweV9mcm9tX3dj
KCkpCi0JCWMtPnRtcCA9ICh2b2lkICopX19nZXRfZnJlZV9wYWdlKEdGUF9BVE9NSUMgfCBfX0dG
UF9OT1dBUk4pOworCQljLT50bXAgPSAodm9pZCAqKV9fZ2V0X2ZyZWVfcGFnZShBTExPV19GQUlM
KTsKIAogCXJldHVybiB0cnVlOwogfQogCitzdGF0aWMgYm9vbCBjb21wcmVzc19zdGFydChzdHJ1
Y3QgY29tcHJlc3MgKmMpCit7CisJc3RydWN0IHpfc3RyZWFtX3MgKnpzdHJlYW0gPSAmYy0+enN0
cmVhbTsKKwl2b2lkICp3b3Jrc3BhY2UgPSB6c3RyZWFtLT53b3Jrc3BhY2U7CisKKwltZW1zZXQo
enN0cmVhbSwgMCwgc2l6ZW9mKCp6c3RyZWFtKSk7CisJenN0cmVhbS0+d29ya3NwYWNlID0gd29y
a3NwYWNlOworCisJcmV0dXJuIHpsaWJfZGVmbGF0ZUluaXQoenN0cmVhbSwgWl9ERUZBVUxUX0NP
TVBSRVNTSU9OKSA9PSBaX09LOworfQorCiBzdGF0aWMgdm9pZCAqY29tcHJlc3NfbmV4dF9wYWdl
KHN0cnVjdCBkcm1faTkxNV9lcnJvcl9vYmplY3QgKmRzdCkKIHsKIAl1bnNpZ25lZCBsb25nIHBh
Z2U7CkBAIC0yNDcsNyArMjM1LDcgQEAgc3RhdGljIHZvaWQgKmNvbXByZXNzX25leHRfcGFnZShz
dHJ1Y3QgZHJtX2k5MTVfZXJyb3Jfb2JqZWN0ICpkc3QpCiAJaWYgKGRzdC0+cGFnZV9jb3VudCA+
PSBkc3QtPm51bV9wYWdlcykKIAkJcmV0dXJuIEVSUl9QVFIoLUVOT1NQQyk7CiAKLQlwYWdlID0g
X19nZXRfZnJlZV9wYWdlKEdGUF9BVE9NSUMgfCBfX0dGUF9OT1dBUk4pOworCXBhZ2UgPSBfX2dl
dF9mcmVlX3BhZ2UoQVRPTUlDX01BWUZBSUwpOwogCWlmICghcGFnZSkKIAkJcmV0dXJuIEVSUl9Q
VFIoLUVOT01FTSk7CiAKQEAgLTMxNiwxMyArMzA0LDE0IEBAIHN0YXRpYyBpbnQgY29tcHJlc3Nf
Zmx1c2goc3RydWN0IGNvbXByZXNzICpjLAogCXJldHVybiAwOwogfQogCi1zdGF0aWMgdm9pZCBj
b21wcmVzc19maW5pKHN0cnVjdCBjb21wcmVzcyAqYywKLQkJCSAgc3RydWN0IGRybV9pOTE1X2Vy
cm9yX29iamVjdCAqZHN0KQorc3RhdGljIHZvaWQgY29tcHJlc3NfZmluaXNoKHN0cnVjdCBjb21w
cmVzcyAqYykKIHsKLQlzdHJ1Y3Qgel9zdHJlYW1fcyAqenN0cmVhbSA9ICZjLT56c3RyZWFtOwor
CXpsaWJfZGVmbGF0ZUVuZCgmYy0+enN0cmVhbSk7Cit9CiAKLQl6bGliX2RlZmxhdGVFbmQoenN0
cmVhbSk7Ci0Ja2ZyZWUoenN0cmVhbS0+d29ya3NwYWNlKTsKK3N0YXRpYyB2b2lkIGNvbXByZXNz
X2Zpbmkoc3RydWN0IGNvbXByZXNzICpjKQoreworCWtmcmVlKGMtPnpzdHJlYW0ud29ya3NwYWNl
KTsKIAlpZiAoYy0+dG1wKQogCQlmcmVlX3BhZ2UoKHVuc2lnbmVkIGxvbmcpYy0+dG1wKTsKIH0K
QEAgLTM0Miw2ICszMzEsMTEgQEAgc3RhdGljIGJvb2wgY29tcHJlc3NfaW5pdChzdHJ1Y3QgY29t
cHJlc3MgKmMpCiAJcmV0dXJuIHRydWU7CiB9CiAKK3N0YXRpYyBib29sIGNvbXByZXNzX3N0YXJ0
KHN0cnVjdCBjb21wcmVzcyAqYykKK3sKKwlyZXR1cm4gdHJ1ZTsKK30KKwogc3RhdGljIGludCBj
b21wcmVzc19wYWdlKHN0cnVjdCBjb21wcmVzcyAqYywKIAkJCSB2b2lkICpzcmMsCiAJCQkgc3Ry
dWN0IGRybV9pOTE1X2Vycm9yX29iamVjdCAqZHN0KQpAQCAtMzQ5LDcgKzM0Myw3IEBAIHN0YXRp
YyBpbnQgY29tcHJlc3NfcGFnZShzdHJ1Y3QgY29tcHJlc3MgKmMsCiAJdW5zaWduZWQgbG9uZyBw
YWdlOwogCXZvaWQgKnB0cjsKIAotCXBhZ2UgPSBfX2dldF9mcmVlX3BhZ2UoR0ZQX0FUT01JQyB8
IF9fR0ZQX05PV0FSTik7CisJcGFnZSA9IF9fZ2V0X2ZyZWVfcGFnZShBVE9NSUNfTUFZRkFJTCk7
CiAJaWYgKCFwYWdlKQogCQlyZXR1cm4gLUVOT01FTTsKIApAQCAtMzY3LDggKzM2MSwxMSBAQCBz
dGF0aWMgaW50IGNvbXByZXNzX2ZsdXNoKHN0cnVjdCBjb21wcmVzcyAqYywKIAlyZXR1cm4gMDsK
IH0KIAotc3RhdGljIHZvaWQgY29tcHJlc3NfZmluaShzdHJ1Y3QgY29tcHJlc3MgKmMsCi0JCQkg
IHN0cnVjdCBkcm1faTkxNV9lcnJvcl9vYmplY3QgKmRzdCkKK3N0YXRpYyB2b2lkIGNvbXByZXNz
X2ZpbmlzaChzdHJ1Y3QgY29tcHJlc3MgKmMpCit7Cit9CisKK3N0YXRpYyB2b2lkIGNvbXByZXNz
X2Zpbmkoc3RydWN0IGNvbXByZXNzICpjKQogewogfQogCkBAIC0zNzksMzYgKzM3Niw2IEBAIHN0
YXRpYyB2b2lkIGVycl9jb21wcmVzc2lvbl9tYXJrZXIoc3RydWN0IGRybV9pOTE1X2Vycm9yX3N0
YXRlX2J1ZiAqbSkKIAogI2VuZGlmCiAKLXN0YXRpYyB2b2lkIHByaW50X2Vycm9yX2J1ZmZlcnMo
c3RydWN0IGRybV9pOTE1X2Vycm9yX3N0YXRlX2J1ZiAqbSwKLQkJCQljb25zdCBjaGFyICpuYW1l
LAotCQkJCXN0cnVjdCBkcm1faTkxNV9lcnJvcl9idWZmZXIgKmVyciwKLQkJCQlpbnQgY291bnQp
Ci17Ci0JZXJyX3ByaW50ZihtLCAiJXMgWyVkXTpcbiIsIG5hbWUsIGNvdW50KTsKLQotCXdoaWxl
IChjb3VudC0tKSB7Ci0JCWVycl9wcmludGYobSwgIiAgICAlMDh4XyUwOHggJTh1ICUwMnggJTAy
eCIsCi0JCQkgICB1cHBlcl8zMl9iaXRzKGVyci0+Z3R0X29mZnNldCksCi0JCQkgICBsb3dlcl8z
Ml9iaXRzKGVyci0+Z3R0X29mZnNldCksCi0JCQkgICBlcnItPnNpemUsCi0JCQkgICBlcnItPnJl
YWRfZG9tYWlucywKLQkJCSAgIGVyci0+d3JpdGVfZG9tYWluKTsKLQkJZXJyX3B1dHMobSwgdGls
aW5nX2ZsYWcoZXJyLT50aWxpbmcpKTsKLQkJZXJyX3B1dHMobSwgZGlydHlfZmxhZyhlcnItPmRp
cnR5KSk7Ci0JCWVycl9wdXRzKG0sIHB1cmdlYWJsZV9mbGFnKGVyci0+cHVyZ2VhYmxlKSk7Ci0J
CWVycl9wdXRzKG0sIGVyci0+dXNlcnB0ciA/ICIgdXNlcnB0ciIgOiAiIik7Ci0JCWVycl9wdXRz
KG0sIGk5MTVfY2FjaGVfbGV2ZWxfc3RyKG0tPmk5MTUsIGVyci0+Y2FjaGVfbGV2ZWwpKTsKLQot
CQlpZiAoZXJyLT5uYW1lKQotCQkJZXJyX3ByaW50ZihtLCAiIChuYW1lOiAlZCkiLCBlcnItPm5h
bWUpOwotCQlpZiAoZXJyLT5mZW5jZV9yZWcgIT0gSTkxNV9GRU5DRV9SRUdfTk9ORSkKLQkJCWVy
cl9wcmludGYobSwgIiAoZmVuY2U6ICVkKSIsIGVyci0+ZmVuY2VfcmVnKTsKLQotCQllcnJfcHV0
cyhtLCAiXG4iKTsKLQkJZXJyKys7Ci0JfQotfQotCiBzdGF0aWMgdm9pZCBlcnJvcl9wcmludF9p
bnN0ZG9uZShzdHJ1Y3QgZHJtX2k5MTVfZXJyb3Jfc3RhdGVfYnVmICptLAogCQkJCSBjb25zdCBz
dHJ1Y3QgZHJtX2k5MTVfZXJyb3JfZW5naW5lICplZSkKIHsKQEAgLTczNCwzMyArNzAxLDYgQEAg
c3RhdGljIHZvaWQgX19lcnJfcHJpbnRfdG9fc2dsKHN0cnVjdCBkcm1faTkxNV9lcnJvcl9zdGF0
ZV9idWYgKm0sCiAJCQllcnJvcl9wcmludF9lbmdpbmUobSwgJmVycm9yLT5lbmdpbmVbaV0sIGVy
cm9yLT5lcG9jaCk7CiAJfQogCi0JZm9yIChpID0gMDsgaSA8IEFSUkFZX1NJWkUoZXJyb3ItPmFj
dGl2ZV92bSk7IGkrKykgewotCQljaGFyIGJ1ZlsxMjhdOwotCQlpbnQgbGVuLCBmaXJzdCA9IDE7
Ci0KLQkJaWYgKCFlcnJvci0+YWN0aXZlX3ZtW2ldKQotCQkJYnJlYWs7Ci0KLQkJbGVuID0gc2Nu
cHJpbnRmKGJ1Ziwgc2l6ZW9mKGJ1ZiksICJBY3RpdmUgKCIpOwotCQlmb3IgKGogPSAwOyBqIDwg
QVJSQVlfU0laRShlcnJvci0+ZW5naW5lKTsgaisrKSB7Ci0JCQlpZiAoZXJyb3ItPmVuZ2luZVtq
XS52bSAhPSBlcnJvci0+YWN0aXZlX3ZtW2ldKQotCQkJCWNvbnRpbnVlOwotCi0JCQlsZW4gKz0g
c2NucHJpbnRmKGJ1ZiArIGxlbiwgc2l6ZW9mKGJ1ZiksICIlcyVzIiwKLQkJCQkJIGZpcnN0ID8g
IiIgOiAiLCAiLAotCQkJCQkgbS0+aTkxNS0+ZW5naW5lW2pdLT5uYW1lKTsKLQkJCWZpcnN0ID0g
MDsKLQkJfQotCQlzY25wcmludGYoYnVmICsgbGVuLCBzaXplb2YoYnVmKSwgIikiKTsKLQkJcHJp
bnRfZXJyb3JfYnVmZmVycyhtLCBidWYsCi0JCQkJICAgIGVycm9yLT5hY3RpdmVfYm9baV0sCi0J
CQkJICAgIGVycm9yLT5hY3RpdmVfYm9fY291bnRbaV0pOwotCX0KLQotCXByaW50X2Vycm9yX2J1
ZmZlcnMobSwgIlBpbm5lZCAoZ2xvYmFsKSIsCi0JCQkgICAgZXJyb3ItPnBpbm5lZF9ibywKLQkJ
CSAgICBlcnJvci0+cGlubmVkX2JvX2NvdW50KTsKLQogCWZvciAoaSA9IDA7IGkgPCBBUlJBWV9T
SVpFKGVycm9yLT5lbmdpbmUpOyBpKyspIHsKIAkJY29uc3Qgc3RydWN0IGRybV9pOTE1X2Vycm9y
X2VuZ2luZSAqZWUgPSAmZXJyb3ItPmVuZ2luZVtpXTsKIApAQCAtOTc0LDEwICs5MTQsNiBAQCB2
b2lkIF9faTkxNV9ncHVfc3RhdGVfZnJlZShzdHJ1Y3Qga3JlZiAqZXJyb3JfcmVmKQogCQlrZnJl
ZShlZS0+cmVxdWVzdHMpOwogCX0KIAotCWZvciAoaSA9IDA7IGkgPCBBUlJBWV9TSVpFKGVycm9y
LT5hY3RpdmVfYm8pOyBpKyspCi0JCWtmcmVlKGVycm9yLT5hY3RpdmVfYm9baV0pOwotCWtmcmVl
KGVycm9yLT5waW5uZWRfYm8pOwotCiAJa2ZyZWUoZXJyb3ItPm92ZXJsYXkpOwogCWtmcmVlKGVy
cm9yLT5kaXNwbGF5KTsKIApAQCAtOTkwLDEyICs5MjYsMTIgQEAgdm9pZCBfX2k5MTVfZ3B1X3N0
YXRlX2ZyZWUoc3RydWN0IGtyZWYgKmVycm9yX3JlZikKIAogc3RhdGljIHN0cnVjdCBkcm1faTkx
NV9lcnJvcl9vYmplY3QgKgogaTkxNV9lcnJvcl9vYmplY3RfY3JlYXRlKHN0cnVjdCBkcm1faTkx
NV9wcml2YXRlICppOTE1LAotCQkJIHN0cnVjdCBpOTE1X3ZtYSAqdm1hKQorCQkJIHN0cnVjdCBp
OTE1X3ZtYSAqdm1hLAorCQkJIHN0cnVjdCBjb21wcmVzcyAqY29tcHJlc3MpCiB7CiAJc3RydWN0
IGk5MTVfZ2d0dCAqZ2d0dCA9ICZpOTE1LT5nZ3R0OwogCWNvbnN0IHU2NCBzbG90ID0gZ2d0dC0+
ZXJyb3JfY2FwdHVyZS5zdGFydDsKIAlzdHJ1Y3QgZHJtX2k5MTVfZXJyb3Jfb2JqZWN0ICpkc3Q7
Ci0Jc3RydWN0IGNvbXByZXNzIGNvbXByZXNzOwogCXVuc2lnbmVkIGxvbmcgbnVtX3BhZ2VzOwog
CXN0cnVjdCBzZ3RfaXRlciBpdGVyOwogCWRtYV9hZGRyX3QgZG1hOwpAQCAtMTAwNiwyMiArOTQy
LDIxIEBAIGk5MTVfZXJyb3Jfb2JqZWN0X2NyZWF0ZShzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAq
aTkxNSwKIAogCW51bV9wYWdlcyA9IG1pbl90KHU2NCwgdm1hLT5zaXplLCB2bWEtPm9iai0+YmFz
ZS5zaXplKSA+PiBQQUdFX1NISUZUOwogCW51bV9wYWdlcyA9IERJVl9ST1VORF9VUCgxMCAqIG51
bV9wYWdlcywgOCk7IC8qIHdvcnN0Y2FzZSB6bGliIGdyb3d0aCAqLwotCWRzdCA9IGttYWxsb2Mo
c2l6ZW9mKCpkc3QpICsgbnVtX3BhZ2VzICogc2l6ZW9mKHUzMiAqKSwKLQkJICAgICAgR0ZQX0FU
T01JQyB8IF9fR0ZQX05PV0FSTik7CisJZHN0ID0ga21hbGxvYyhzaXplb2YoKmRzdCkgKyBudW1f
cGFnZXMgKiBzaXplb2YodTMyICopLCBBVE9NSUNfTUFZRkFJTCk7CiAJaWYgKCFkc3QpCiAJCXJl
dHVybiBOVUxMOwogCisJaWYgKCFjb21wcmVzc19zdGFydChjb21wcmVzcykpIHsKKwkJa2ZyZWUo
ZHN0KTsKKwkJcmV0dXJuIE5VTEw7CisJfQorCiAJZHN0LT5ndHRfb2Zmc2V0ID0gdm1hLT5ub2Rl
LnN0YXJ0OwogCWRzdC0+Z3R0X3NpemUgPSB2bWEtPm5vZGUuc2l6ZTsKIAlkc3QtPm51bV9wYWdl
cyA9IG51bV9wYWdlczsKIAlkc3QtPnBhZ2VfY291bnQgPSAwOwogCWRzdC0+dW51c2VkID0gMDsK
IAotCWlmICghY29tcHJlc3NfaW5pdCgmY29tcHJlc3MpKSB7Ci0JCWtmcmVlKGRzdCk7Ci0JCXJl
dHVybiBOVUxMOwotCX0KLQogCXJldCA9IC1FSU5WQUw7CiAJZm9yX2VhY2hfc2d0X2RtYShkbWEs
IGl0ZXIsIHZtYS0+cGFnZXMpIHsKIAkJdm9pZCBfX2lvbWVtICpzOwpAQCAtMTAyOSw2OSArOTY0
LDIzIEBAIGk5MTVfZXJyb3Jfb2JqZWN0X2NyZWF0ZShzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAq
aTkxNSwKIAkJZ2d0dC0+dm0uaW5zZXJ0X3BhZ2UoJmdndHQtPnZtLCBkbWEsIHNsb3QsIEk5MTVf
Q0FDSEVfTk9ORSwgMCk7CiAKIAkJcyA9IGlvX21hcHBpbmdfbWFwX2F0b21pY193YygmZ2d0dC0+
aW9tYXAsIHNsb3QpOwotCQlyZXQgPSBjb21wcmVzc19wYWdlKCZjb21wcmVzcywgKHZvaWQgIF9f
Zm9yY2UgKilzLCBkc3QpOworCQlyZXQgPSBjb21wcmVzc19wYWdlKGNvbXByZXNzLCAodm9pZCAg
X19mb3JjZSAqKXMsIGRzdCk7CiAJCWlvX21hcHBpbmdfdW5tYXBfYXRvbWljKHMpOwogCQlpZiAo
cmV0KQogCQkJYnJlYWs7CiAJfQogCi0JaWYgKHJldCB8fCBjb21wcmVzc19mbHVzaCgmY29tcHJl
c3MsIGRzdCkpIHsKKwlpZiAocmV0IHx8IGNvbXByZXNzX2ZsdXNoKGNvbXByZXNzLCBkc3QpKSB7
CiAJCXdoaWxlIChkc3QtPnBhZ2VfY291bnQtLSkKIAkJCWZyZWVfcGFnZSgodW5zaWduZWQgbG9u
Zylkc3QtPnBhZ2VzW2RzdC0+cGFnZV9jb3VudF0pOwogCQlrZnJlZShkc3QpOwogCQlkc3QgPSBO
VUxMOwogCX0KKwljb21wcmVzc19maW5pc2goY29tcHJlc3MpOwogCi0JY29tcHJlc3NfZmluaSgm
Y29tcHJlc3MsIGRzdCk7CiAJcmV0dXJuIGRzdDsKIH0KIAotc3RhdGljIHZvaWQgY2FwdHVyZV9i
byhzdHJ1Y3QgZHJtX2k5MTVfZXJyb3JfYnVmZmVyICplcnIsCi0JCSAgICAgICBzdHJ1Y3QgaTkx
NV92bWEgKnZtYSkKLXsKLQlzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqID0gdm1hLT5v
Ymo7Ci0KLQllcnItPnNpemUgPSBvYmotPmJhc2Uuc2l6ZTsKLQllcnItPm5hbWUgPSBvYmotPmJh
c2UubmFtZTsKLQotCWVyci0+Z3R0X29mZnNldCA9IHZtYS0+bm9kZS5zdGFydDsKLQllcnItPnJl
YWRfZG9tYWlucyA9IG9iai0+cmVhZF9kb21haW5zOwotCWVyci0+d3JpdGVfZG9tYWluID0gb2Jq
LT53cml0ZV9kb21haW47Ci0JZXJyLT5mZW5jZV9yZWcgPSB2bWEtPmZlbmNlID8gdm1hLT5mZW5j
ZS0+aWQgOiAtMTsKLQllcnItPnRpbGluZyA9IGk5MTVfZ2VtX29iamVjdF9nZXRfdGlsaW5nKG9i
aik7Ci0JZXJyLT5kaXJ0eSA9IG9iai0+bW0uZGlydHk7Ci0JZXJyLT5wdXJnZWFibGUgPSBvYmot
Pm1tLm1hZHYgIT0gSTkxNV9NQURWX1dJTExORUVEOwotCWVyci0+dXNlcnB0ciA9IG9iai0+dXNl
cnB0ci5tbSAhPSBOVUxMOwotCWVyci0+Y2FjaGVfbGV2ZWwgPSBvYmotPmNhY2hlX2xldmVsOwot
fQotCi1zdGF0aWMgdTMyIGNhcHR1cmVfZXJyb3JfYm8oc3RydWN0IGRybV9pOTE1X2Vycm9yX2J1
ZmZlciAqZXJyLAotCQkJICAgIGludCBjb3VudCwgc3RydWN0IGxpc3RfaGVhZCAqaGVhZCwKLQkJ
CSAgICB1bnNpZ25lZCBpbnQgZmxhZ3MpCi0jZGVmaW5lIEFDVElWRV9PTkxZIEJJVCgwKQotI2Rl
ZmluZSBQSU5ORURfT05MWSBCSVQoMSkKLXsKLQlzdHJ1Y3QgaTkxNV92bWEgKnZtYTsKLQlpbnQg
aSA9IDA7Ci0KLQlsaXN0X2Zvcl9lYWNoX2VudHJ5KHZtYSwgaGVhZCwgdm1fbGluaykgewotCQlp
ZiAoIXZtYS0+b2JqKQotCQkJY29udGludWU7Ci0KLQkJaWYgKGZsYWdzICYgQUNUSVZFX09OTFkg
JiYgIWk5MTVfdm1hX2lzX2FjdGl2ZSh2bWEpKQotCQkJY29udGludWU7Ci0KLQkJaWYgKGZsYWdz
ICYgUElOTkVEX09OTFkgJiYgIWk5MTVfdm1hX2lzX3Bpbm5lZCh2bWEpKQotCQkJY29udGludWU7
Ci0KLQkJY2FwdHVyZV9ibyhlcnIrKywgdm1hKTsKLQkJaWYgKCsraSA9PSBjb3VudCkKLQkJCWJy
ZWFrOwotCX0KLQotCXJldHVybiBpOwotfQotCiAvKgogICogR2VuZXJhdGUgYSBzZW1pLXVuaXF1
ZSBlcnJvciBjb2RlLiBUaGUgY29kZSBpcyBub3QgbWVhbnQgdG8gaGF2ZSBtZWFuaW5nLCBUaGUK
ICAqIGNvZGUncyBvbmx5IHB1cnBvc2UgaXMgdG8gdHJ5IHRvIHByZXZlbnQgZmFsc2UgZHVwbGlj
YXRlZCBidWcgcmVwb3J0cyBieQpAQCAtMTI4MSw3ICsxMTcwLDcgQEAgc3RhdGljIHZvaWQgZW5n
aW5lX3JlY29yZF9yZXF1ZXN0cyhzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUsCiAJaWYg
KCFjb3VudCkKIAkJcmV0dXJuOwogCi0JZWUtPnJlcXVlc3RzID0ga2NhbGxvYyhjb3VudCwgc2l6
ZW9mKCplZS0+cmVxdWVzdHMpLCBHRlBfQVRPTUlDKTsKKwllZS0+cmVxdWVzdHMgPSBrY2FsbG9j
KGNvdW50LCBzaXplb2YoKmVlLT5yZXF1ZXN0cyksIEFUT01JQ19NQVlGQUlMKTsKIAlpZiAoIWVl
LT5yZXF1ZXN0cykKIAkJcmV0dXJuOwogCkBAIC0xMzQ5LDggKzEyMzgsMTAgQEAgc3RhdGljIHZv
aWQgcmVjb3JkX2NvbnRleHQoc3RydWN0IGRybV9pOTE1X2Vycm9yX2NvbnRleHQgKmUsCiAJZS0+
YWN0aXZlID0gYXRvbWljX3JlYWQoJmN0eC0+YWN0aXZlX2NvdW50KTsKIH0KIAotc3RhdGljIHZv
aWQgcmVxdWVzdF9yZWNvcmRfdXNlcl9ibyhzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpyZXF1ZXN0LAot
CQkJCSAgIHN0cnVjdCBkcm1faTkxNV9lcnJvcl9lbmdpbmUgKmVlKQorc3RhdGljIHZvaWQKK3Jl
cXVlc3RfcmVjb3JkX3VzZXJfYm8oc3RydWN0IGk5MTVfcmVxdWVzdCAqcmVxdWVzdCwKKwkJICAg
ICAgIHN0cnVjdCBkcm1faTkxNV9lcnJvcl9lbmdpbmUgKmVlLAorCQkgICAgICAgc3RydWN0IGNv
bXByZXNzICpjb21wcmVzcykKIHsKIAlzdHJ1Y3QgaTkxNV9jYXB0dXJlX2xpc3QgKmM7CiAJc3Ry
dWN0IGRybV9pOTE1X2Vycm9yX29iamVjdCAqKmJvOwpAQCAtMTM2MiwxOCArMTI1MywyMCBAQCBz
dGF0aWMgdm9pZCByZXF1ZXN0X3JlY29yZF91c2VyX2JvKHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJl
cXVlc3QsCiAJaWYgKCFtYXgpCiAJCXJldHVybjsKIAotCWJvID0ga21hbGxvY19hcnJheShtYXgs
IHNpemVvZigqYm8pLCBHRlBfQVRPTUlDKTsKKwlibyA9IGttYWxsb2NfYXJyYXkobWF4LCBzaXpl
b2YoKmJvKSwgQVRPTUlDX01BWUZBSUwpOwogCWlmICghYm8pIHsKIAkJLyogSWYgd2UgY2FuJ3Qg
Y2FwdHVyZSBldmVyeXRoaW5nLCB0cnkgdG8gY2FwdHVyZSBzb21ldGhpbmcuICovCiAJCW1heCA9
IG1pbl90KGxvbmcsIG1heCwgUEFHRV9TSVpFIC8gc2l6ZW9mKCpibykpOwotCQlibyA9IGttYWxs
b2NfYXJyYXkobWF4LCBzaXplb2YoKmJvKSwgR0ZQX0FUT01JQyk7CisJCWJvID0ga21hbGxvY19h
cnJheShtYXgsIHNpemVvZigqYm8pLCBBVE9NSUNfTUFZRkFJTCk7CiAJfQogCWlmICghYm8pCiAJ
CXJldHVybjsKIAogCWNvdW50ID0gMDsKIAlmb3IgKGMgPSByZXF1ZXN0LT5jYXB0dXJlX2xpc3Q7
IGM7IGMgPSBjLT5uZXh0KSB7Ci0JCWJvW2NvdW50XSA9IGk5MTVfZXJyb3Jfb2JqZWN0X2NyZWF0
ZShyZXF1ZXN0LT5pOTE1LCBjLT52bWEpOworCQlib1tjb3VudF0gPSBpOTE1X2Vycm9yX29iamVj
dF9jcmVhdGUocmVxdWVzdC0+aTkxNSwKKwkJCQkJCSAgICAgYy0+dm1hLAorCQkJCQkJICAgICBj
b21wcmVzcyk7CiAJCWlmICghYm9bY291bnRdKQogCQkJYnJlYWs7CiAJCWlmICgrK2NvdW50ID09
IG1heCkKQEAgLTEzODYsNyArMTI3OSw4IEBAIHN0YXRpYyB2b2lkIHJlcXVlc3RfcmVjb3JkX3Vz
ZXJfYm8oc3RydWN0IGk5MTVfcmVxdWVzdCAqcmVxdWVzdCwKIAogc3RhdGljIHN0cnVjdCBkcm1f
aTkxNV9lcnJvcl9vYmplY3QgKgogY2FwdHVyZV9vYmplY3Qoc3RydWN0IGRybV9pOTE1X3ByaXZh
dGUgKmRldl9wcml2LAotCSAgICAgICBzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqKQor
CSAgICAgICBzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqLAorCSAgICAgICBzdHJ1Y3Qg
Y29tcHJlc3MgKmNvbXByZXNzKQogewogCWlmIChvYmogJiYgaTkxNV9nZW1fb2JqZWN0X2hhc19w
YWdlcyhvYmopKSB7CiAJCXN0cnVjdCBpOTE1X3ZtYSBmYWtlID0gewpAQCAtMTM5NiwxMyArMTI5
MCwxNCBAQCBjYXB0dXJlX29iamVjdChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYs
CiAJCQkub2JqID0gb2JqLAogCQl9OwogCi0JCXJldHVybiBpOTE1X2Vycm9yX29iamVjdF9jcmVh
dGUoZGV2X3ByaXYsICZmYWtlKTsKKwkJcmV0dXJuIGk5MTVfZXJyb3Jfb2JqZWN0X2NyZWF0ZShk
ZXZfcHJpdiwgJmZha2UsIGNvbXByZXNzKTsKIAl9IGVsc2UgewogCQlyZXR1cm4gTlVMTDsKIAl9
CiB9CiAKLXN0YXRpYyB2b2lkIGdlbV9yZWNvcmRfcmluZ3Moc3RydWN0IGk5MTVfZ3B1X3N0YXRl
ICplcnJvcikKK3N0YXRpYyB2b2lkCitnZW1fcmVjb3JkX3JpbmdzKHN0cnVjdCBpOTE1X2dwdV9z
dGF0ZSAqZXJyb3IsIHN0cnVjdCBjb21wcmVzcyAqY29tcHJlc3MpCiB7CiAJc3RydWN0IGRybV9p
OTE1X3ByaXZhdGUgKmk5MTUgPSBlcnJvci0+aTkxNTsKIAlpbnQgaTsKQEAgLTE0MzgsMTcgKzEz
MzMsMjEgQEAgc3RhdGljIHZvaWQgZ2VtX3JlY29yZF9yaW5ncyhzdHJ1Y3QgaTkxNV9ncHVfc3Rh
dGUgKmVycm9yKQogCQkJICogYnkgdXNlcnNwYWNlLgogCQkJICovCiAJCQllZS0+YmF0Y2hidWZm
ZXIgPQotCQkJCWk5MTVfZXJyb3Jfb2JqZWN0X2NyZWF0ZShpOTE1LCByZXF1ZXN0LT5iYXRjaCk7
CisJCQkJaTkxNV9lcnJvcl9vYmplY3RfY3JlYXRlKGk5MTUsCisJCQkJCQkJIHJlcXVlc3QtPmJh
dGNoLAorCQkJCQkJCSBjb21wcmVzcyk7CiAKIAkJCWlmIChIQVNfQlJPS0VOX0NTX1RMQihpOTE1
KSkKIAkJCQllZS0+d2FfYmF0Y2hidWZmZXIgPQogCQkJCSAgaTkxNV9lcnJvcl9vYmplY3RfY3Jl
YXRlKGk5MTUsCi0JCQkJCQkJICAgZW5naW5lLT5ndC0+c2NyYXRjaCk7Ci0JCQlyZXF1ZXN0X3Jl
Y29yZF91c2VyX2JvKHJlcXVlc3QsIGVlKTsKKwkJCQkJCQkgICBlbmdpbmUtPmd0LT5zY3JhdGNo
LAorCQkJCQkJCSAgIGNvbXByZXNzKTsKKwkJCXJlcXVlc3RfcmVjb3JkX3VzZXJfYm8ocmVxdWVz
dCwgZWUsIGNvbXByZXNzKTsKIAogCQkJZWUtPmN0eCA9CiAJCQkJaTkxNV9lcnJvcl9vYmplY3Rf
Y3JlYXRlKGk5MTUsCi0JCQkJCQkJIHJlcXVlc3QtPmh3X2NvbnRleHQtPnN0YXRlKTsKKwkJCQkJ
CQkgcmVxdWVzdC0+aHdfY29udGV4dC0+c3RhdGUsCisJCQkJCQkJIGNvbXByZXNzKTsKIAogCQkJ
ZXJyb3ItPnNpbXVsYXRlZCB8PQogCQkJCWk5MTVfZ2VtX2NvbnRleHRfbm9fZXJyb3JfY2FwdHVy
ZShjdHgpOwpAQCAtMTQ2MCw3ICsxMzU5LDkgQEAgc3RhdGljIHZvaWQgZ2VtX3JlY29yZF9yaW5n
cyhzdHJ1Y3QgaTkxNV9ncHVfc3RhdGUgKmVycm9yKQogCQkJZWUtPmNwdV9yaW5nX2hlYWQgPSBy
aW5nLT5oZWFkOwogCQkJZWUtPmNwdV9yaW5nX3RhaWwgPSByaW5nLT50YWlsOwogCQkJZWUtPnJp
bmdidWZmZXIgPQotCQkJCWk5MTVfZXJyb3Jfb2JqZWN0X2NyZWF0ZShpOTE1LCByaW5nLT52bWEp
OworCQkJCWk5MTVfZXJyb3Jfb2JqZWN0X2NyZWF0ZShpOTE1LAorCQkJCQkJCSByaW5nLT52bWEs
CisJCQkJCQkJIGNvbXByZXNzKTsKIAogCQkJZW5naW5lX3JlY29yZF9yZXF1ZXN0cyhlbmdpbmUs
IHJlcXVlc3QsIGVlKTsKIAkJfQpAQCAtMTQ2OCw4OSArMTM2OSwyMSBAQCBzdGF0aWMgdm9pZCBn
ZW1fcmVjb3JkX3JpbmdzKHN0cnVjdCBpOTE1X2dwdV9zdGF0ZSAqZXJyb3IpCiAKIAkJZWUtPmh3
c19wYWdlID0KIAkJCWk5MTVfZXJyb3Jfb2JqZWN0X2NyZWF0ZShpOTE1LAotCQkJCQkJIGVuZ2lu
ZS0+c3RhdHVzX3BhZ2Uudm1hKTsKKwkJCQkJCSBlbmdpbmUtPnN0YXR1c19wYWdlLnZtYSwKKwkJ
CQkJCSBjb21wcmVzcyk7CiAKLQkJZWUtPndhX2N0eCA9IGk5MTVfZXJyb3Jfb2JqZWN0X2NyZWF0
ZShpOTE1LCBlbmdpbmUtPndhX2N0eC52bWEpOwotCi0JCWVlLT5kZWZhdWx0X3N0YXRlID0gY2Fw
dHVyZV9vYmplY3QoaTkxNSwgZW5naW5lLT5kZWZhdWx0X3N0YXRlKTsKLQl9Ci19Ci0KLXN0YXRp
YyB2b2lkIGdlbV9jYXB0dXJlX3ZtKHN0cnVjdCBpOTE1X2dwdV9zdGF0ZSAqZXJyb3IsCi0JCQkg
ICBzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKLQkJCSAgIGludCBpZHgpCi17Ci0Jc3Ry
dWN0IGRybV9pOTE1X2Vycm9yX2J1ZmZlciAqYWN0aXZlX2JvOwotCXN0cnVjdCBpOTE1X3ZtYSAq
dm1hOwotCWludCBjb3VudDsKLQotCWNvdW50ID0gMDsKLQlsaXN0X2Zvcl9lYWNoX2VudHJ5KHZt
YSwgJnZtLT5ib3VuZF9saXN0LCB2bV9saW5rKQotCQlpZiAoaTkxNV92bWFfaXNfYWN0aXZlKHZt
YSkpCi0JCQljb3VudCsrOwotCi0JYWN0aXZlX2JvID0gTlVMTDsKLQlpZiAoY291bnQpCi0JCWFj
dGl2ZV9ibyA9IGtjYWxsb2MoY291bnQsIHNpemVvZigqYWN0aXZlX2JvKSwgR0ZQX0FUT01JQyk7
Ci0JaWYgKGFjdGl2ZV9ibykKLQkJY291bnQgPSBjYXB0dXJlX2Vycm9yX2JvKGFjdGl2ZV9ibywK
LQkJCQkJIGNvdW50LCAmdm0tPmJvdW5kX2xpc3QsCi0JCQkJCSBBQ1RJVkVfT05MWSk7Ci0JZWxz
ZQotCQljb3VudCA9IDA7Ci0KLQllcnJvci0+YWN0aXZlX3ZtW2lkeF0gPSB2bTsKLQllcnJvci0+
YWN0aXZlX2JvW2lkeF0gPSBhY3RpdmVfYm87Ci0JZXJyb3ItPmFjdGl2ZV9ib19jb3VudFtpZHhd
ID0gY291bnQ7Ci19Ci0KLXN0YXRpYyB2b2lkIGNhcHR1cmVfYWN0aXZlX2J1ZmZlcnMoc3RydWN0
IGk5MTVfZ3B1X3N0YXRlICplcnJvcikKLXsKLQlpbnQgY250ID0gMCwgaSwgajsKLQotCUJVSUxE
X0JVR19PTihBUlJBWV9TSVpFKGVycm9yLT5lbmdpbmUpID4gQVJSQVlfU0laRShlcnJvci0+YWN0
aXZlX2JvKSk7Ci0JQlVJTERfQlVHX09OKEFSUkFZX1NJWkUoZXJyb3ItPmFjdGl2ZV9ibykgIT0g
QVJSQVlfU0laRShlcnJvci0+YWN0aXZlX3ZtKSk7Ci0JQlVJTERfQlVHX09OKEFSUkFZX1NJWkUo
ZXJyb3ItPmFjdGl2ZV9ibykgIT0gQVJSQVlfU0laRShlcnJvci0+YWN0aXZlX2JvX2NvdW50KSk7
Ci0KLQkvKiBTY2FuIGVhY2ggZW5naW5lIGxvb2tpbmcgZm9yIHVuaXF1ZSBhY3RpdmUgY29udGV4
dHMvdm0gKi8KLQlmb3IgKGkgPSAwOyBpIDwgQVJSQVlfU0laRShlcnJvci0+ZW5naW5lKTsgaSsr
KSB7Ci0JCXN0cnVjdCBkcm1faTkxNV9lcnJvcl9lbmdpbmUgKmVlID0gJmVycm9yLT5lbmdpbmVb
aV07Ci0JCWJvb2wgZm91bmQ7Ci0KLQkJaWYgKCFlZS0+dm0pCi0JCQljb250aW51ZTsKKwkJZWUt
PndhX2N0eCA9CisJCQlpOTE1X2Vycm9yX29iamVjdF9jcmVhdGUoaTkxNSwKKwkJCQkJCSBlbmdp
bmUtPndhX2N0eC52bWEsCisJCQkJCQkgY29tcHJlc3MpOwogCi0JCWZvdW5kID0gZmFsc2U7Ci0J
CWZvciAoaiA9IDA7IGogPCBpICYmICFmb3VuZDsgaisrKQotCQkJZm91bmQgPSBlcnJvci0+ZW5n
aW5lW2pdLnZtID09IGVlLT52bTsKLQkJaWYgKCFmb3VuZCkKLQkJCWdlbV9jYXB0dXJlX3ZtKGVy
cm9yLCBlZS0+dm0sIGNudCsrKTsKKwkJZWUtPmRlZmF1bHRfc3RhdGUgPQorCQkJY2FwdHVyZV9v
YmplY3QoaTkxNSwgZW5naW5lLT5kZWZhdWx0X3N0YXRlLCBjb21wcmVzcyk7CiAJfQogfQogCi1z
dGF0aWMgdm9pZCBjYXB0dXJlX3Bpbm5lZF9idWZmZXJzKHN0cnVjdCBpOTE1X2dwdV9zdGF0ZSAq
ZXJyb3IpCi17Ci0Jc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0gPSAmZXJyb3ItPmk5MTUt
PmdndHQudm07Ci0Jc3RydWN0IGRybV9pOTE1X2Vycm9yX2J1ZmZlciAqYm87Ci0Jc3RydWN0IGk5
MTVfdm1hICp2bWE7Ci0JaW50IGNvdW50OwotCi0JY291bnQgPSAwOwotCWxpc3RfZm9yX2VhY2hf
ZW50cnkodm1hLCAmdm0tPmJvdW5kX2xpc3QsIHZtX2xpbmspCi0JCWNvdW50Kys7Ci0KLQlibyA9
IE5VTEw7Ci0JaWYgKGNvdW50KQotCQlibyA9IGtjYWxsb2MoY291bnQsIHNpemVvZigqYm8pLCBH
RlBfQVRPTUlDKTsKLQlpZiAoIWJvKQotCQlyZXR1cm47Ci0KLQllcnJvci0+cGlubmVkX2JvX2Nv
dW50ID0KLQkJY2FwdHVyZV9lcnJvcl9ibyhibywgY291bnQsICZ2bS0+Ym91bmRfbGlzdCwgUElO
TkVEX09OTFkpOwotCWVycm9yLT5waW5uZWRfYm8gPSBibzsKLX0KLQotc3RhdGljIHZvaWQgY2Fw
dHVyZV91Y19zdGF0ZShzdHJ1Y3QgaTkxNV9ncHVfc3RhdGUgKmVycm9yKQorc3RhdGljIHZvaWQK
K2NhcHR1cmVfdWNfc3RhdGUoc3RydWN0IGk5MTVfZ3B1X3N0YXRlICplcnJvciwgc3RydWN0IGNv
bXByZXNzICpjb21wcmVzcykKIHsKIAlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSA9IGVy
cm9yLT5pOTE1OwogCXN0cnVjdCBpOTE1X2Vycm9yX3VjICplcnJvcl91YyA9ICZlcnJvci0+dWM7
CkBAIC0xNTY2LDkgKzEzOTksMTEgQEAgc3RhdGljIHZvaWQgY2FwdHVyZV91Y19zdGF0ZShzdHJ1
Y3QgaTkxNV9ncHVfc3RhdGUgKmVycm9yKQogCSAqIEFzIG1vZHBhcmFtcyBhcmUgZ2VuZXJhbGx5
IGFjY2VzaWJsZSBmcm9tIHRoZSB1c2Vyc3BhY2UgbWFrZQogCSAqIGV4cGxpY2l0IGNvcGllcyBv
ZiB0aGUgZmlybXdhcmUgcGF0aHMuCiAJICovCi0JZXJyb3JfdWMtPmd1Y19mdy5wYXRoID0ga3N0
cmR1cChpOTE1LT5ndWMuZncucGF0aCwgR0ZQX0FUT01JQyk7Ci0JZXJyb3JfdWMtPmh1Y19mdy5w
YXRoID0ga3N0cmR1cChpOTE1LT5odWMuZncucGF0aCwgR0ZQX0FUT01JQyk7Ci0JZXJyb3JfdWMt
Pmd1Y19sb2cgPSBpOTE1X2Vycm9yX29iamVjdF9jcmVhdGUoaTkxNSwgaTkxNS0+Z3VjLmxvZy52
bWEpOworCWVycm9yX3VjLT5ndWNfZncucGF0aCA9IGtzdHJkdXAoaTkxNS0+Z3VjLmZ3LnBhdGgs
IEFMTE9XX0ZBSUwpOworCWVycm9yX3VjLT5odWNfZncucGF0aCA9IGtzdHJkdXAoaTkxNS0+aHVj
LmZ3LnBhdGgsIEFMTE9XX0ZBSUwpOworCWVycm9yX3VjLT5ndWNfbG9nID0gaTkxNV9lcnJvcl9v
YmplY3RfY3JlYXRlKGk5MTUsCisJCQkJCQkgICAgIGk5MTUtPmd1Yy5sb2cudm1hLAorCQkJCQkJ
ICAgICBjb21wcmVzcyk7CiB9CiAKIC8qIENhcHR1cmUgYWxsIHJlZ2lzdGVycyB3aGljaCBkb24n
dCBmaXQgaW50byBhbm90aGVyIGNhdGVnb3J5LiAqLwpAQCAtMTc1Miw1NiArMTU4Nyw1NCBAQCBz
dGF0aWMgdm9pZCBjYXB0dXJlX2ZpbmlzaChzdHJ1Y3QgaTkxNV9ncHVfc3RhdGUgKmVycm9yKQog
CWdndHQtPnZtLmNsZWFyX3JhbmdlKCZnZ3R0LT52bSwgc2xvdCwgUEFHRV9TSVpFKTsKIH0KIAot
c3RhdGljIGludCBjYXB0dXJlKHZvaWQgKmRhdGEpCi17Ci0Jc3RydWN0IGk5MTVfZ3B1X3N0YXRl
ICplcnJvciA9IGRhdGE7Ci0KLQllcnJvci0+dGltZSA9IGt0aW1lX2dldF9yZWFsKCk7Ci0JZXJy
b3ItPmJvb3R0aW1lID0ga3RpbWVfZ2V0X2Jvb3R0aW1lKCk7Ci0JZXJyb3ItPnVwdGltZSA9IGt0
aW1lX3N1YihrdGltZV9nZXQoKSwKLQkJCQkgIGVycm9yLT5pOTE1LT5ndC5sYXN0X2luaXRfdGlt
ZSk7Ci0JZXJyb3ItPmNhcHR1cmUgPSBqaWZmaWVzOwotCi0JY2FwdHVyZV9wYXJhbXMoZXJyb3Ip
OwotCWNhcHR1cmVfZ2VuX3N0YXRlKGVycm9yKTsKLQljYXB0dXJlX3VjX3N0YXRlKGVycm9yKTsK
LQljYXB0dXJlX3JlZ19zdGF0ZShlcnJvcik7Ci0JZ2VtX3JlY29yZF9mZW5jZXMoZXJyb3IpOwot
CWdlbV9yZWNvcmRfcmluZ3MoZXJyb3IpOwotCWNhcHR1cmVfYWN0aXZlX2J1ZmZlcnMoZXJyb3Ip
OwotCWNhcHR1cmVfcGlubmVkX2J1ZmZlcnMoZXJyb3IpOwotCi0JZXJyb3ItPm92ZXJsYXkgPSBp
bnRlbF9vdmVybGF5X2NhcHR1cmVfZXJyb3Jfc3RhdGUoZXJyb3ItPmk5MTUpOwotCWVycm9yLT5k
aXNwbGF5ID0gaW50ZWxfZGlzcGxheV9jYXB0dXJlX2Vycm9yX3N0YXRlKGVycm9yLT5pOTE1KTsK
LQotCWVycm9yLT5lcG9jaCA9IGNhcHR1cmVfZmluZF9lcG9jaChlcnJvcik7Ci0KLQljYXB0dXJl
X2ZpbmlzaChlcnJvcik7Ci0JcmV0dXJuIDA7Ci19Ci0KICNkZWZpbmUgREFZX0FTX1NFQ09ORFMo
eCkgKDI0ICogNjAgKiA2MCAqICh4KSkKIAogc3RydWN0IGk5MTVfZ3B1X3N0YXRlICoKIGk5MTVf
Y2FwdHVyZV9ncHVfc3RhdGUoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCiB7CiAJc3Ry
dWN0IGk5MTVfZ3B1X3N0YXRlICplcnJvcjsKKwlzdHJ1Y3QgY29tcHJlc3MgY29tcHJlc3M7CiAK
IAkvKiBDaGVjayBpZiBHUFUgY2FwdHVyZSBoYXMgYmVlbiBkaXNhYmxlZCAqLwogCWVycm9yID0g
UkVBRF9PTkNFKGk5MTUtPmdwdV9lcnJvci5maXJzdF9lcnJvcik7CiAJaWYgKElTX0VSUihlcnJv
cikpCiAJCXJldHVybiBlcnJvcjsKIAotCWVycm9yID0ga3phbGxvYyhzaXplb2YoKmVycm9yKSwg
R0ZQX0FUT01JQyk7CisJZXJyb3IgPSBremFsbG9jKHNpemVvZigqZXJyb3IpLCBHRlBfS0VSTkVM
IHwgX19HRlBfTk9XQVJOKTsKIAlpZiAoIWVycm9yKSB7CiAJCWk5MTVfZGlzYWJsZV9lcnJvcl9z
dGF0ZShpOTE1LCAtRU5PTUVNKTsKIAkJcmV0dXJuIEVSUl9QVFIoLUVOT01FTSk7CiAJfQogCisJ
aWYgKCFjb21wcmVzc19pbml0KCZjb21wcmVzcykpIHsKKwkJa2ZyZWUoZXJyb3IpOworCQlpOTE1
X2Rpc2FibGVfZXJyb3Jfc3RhdGUoaTkxNSwgLUVOT01FTSk7CisJCXJldHVybiBFUlJfUFRSKC1F
Tk9NRU0pOworCX0KKwogCWtyZWZfaW5pdCgmZXJyb3ItPnJlZik7CiAJZXJyb3ItPmk5MTUgPSBp
OTE1OwogCi0Jc3RvcF9tYWNoaW5lKGNhcHR1cmUsIGVycm9yLCBOVUxMKTsKKwllcnJvci0+dGlt
ZSA9IGt0aW1lX2dldF9yZWFsKCk7CisJZXJyb3ItPmJvb3R0aW1lID0ga3RpbWVfZ2V0X2Jvb3R0
aW1lKCk7CisJZXJyb3ItPnVwdGltZSA9IGt0aW1lX3N1YihrdGltZV9nZXQoKSwKKwkJCQkgIGVy
cm9yLT5pOTE1LT5ndC5sYXN0X2luaXRfdGltZSk7CisJZXJyb3ItPmNhcHR1cmUgPSBqaWZmaWVz
OworCisJY2FwdHVyZV9wYXJhbXMoZXJyb3IpOworCWNhcHR1cmVfZ2VuX3N0YXRlKGVycm9yKTsK
KwljYXB0dXJlX3VjX3N0YXRlKGVycm9yLCAmY29tcHJlc3MpOworCWNhcHR1cmVfcmVnX3N0YXRl
KGVycm9yKTsKKwlnZW1fcmVjb3JkX2ZlbmNlcyhlcnJvcik7CisJZ2VtX3JlY29yZF9yaW5ncyhl
cnJvciwgJmNvbXByZXNzKTsKKworCWVycm9yLT5vdmVybGF5ID0gaW50ZWxfb3ZlcmxheV9jYXB0
dXJlX2Vycm9yX3N0YXRlKGVycm9yLT5pOTE1KTsKKwllcnJvci0+ZGlzcGxheSA9IGludGVsX2Rp
c3BsYXlfY2FwdHVyZV9lcnJvcl9zdGF0ZShlcnJvci0+aTkxNSk7CisKKwllcnJvci0+ZXBvY2gg
PSBjYXB0dXJlX2ZpbmRfZXBvY2goZXJyb3IpOworCisJY2FwdHVyZV9maW5pc2goZXJyb3IpOwor
CWNvbXByZXNzX2ZpbmkoJmNvbXByZXNzKTsKIAogCXJldHVybiBlcnJvcjsKIH0KZGlmZiAtLWdp
dCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ3B1X2Vycm9yLmggYi9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9pOTE1X2dwdV9lcnJvci5oCmluZGV4IDJlY2QwYzZhMWM5NC4uYmZmYTZkYjE0M2Uw
IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dwdV9lcnJvci5oCisrKyBi
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ3B1X2Vycm9yLmgKQEAgLTE2MCwyMiArMTYwLDYg
QEAgc3RydWN0IGk5MTVfZ3B1X3N0YXRlIHsKIAkJfSB2bV9pbmZvOwogCX0gZW5naW5lW0k5MTVf
TlVNX0VOR0lORVNdOwogCi0Jc3RydWN0IGRybV9pOTE1X2Vycm9yX2J1ZmZlciB7Ci0JCXUzMiBz
aXplOwotCQl1MzIgbmFtZTsKLQkJdTY0IGd0dF9vZmZzZXQ7Ci0JCXUzMiByZWFkX2RvbWFpbnM7
Ci0JCXUzMiB3cml0ZV9kb21haW47Ci0JCXMzMiBmZW5jZV9yZWc6STkxNV9NQVhfTlVNX0ZFTkNF
X0JJVFM7Ci0JCXUzMiB0aWxpbmc6MjsKLQkJdTMyIGRpcnR5OjE7Ci0JCXUzMiBwdXJnZWFibGU6
MTsKLQkJdTMyIHVzZXJwdHI6MTsKLQkJdTMyIGNhY2hlX2xldmVsOjM7Ci0JfSAqYWN0aXZlX2Jv
W0k5MTVfTlVNX0VOR0lORVNdLCAqcGlubmVkX2JvOwotCXUzMiBhY3RpdmVfYm9fY291bnRbSTkx
NV9OVU1fRU5HSU5FU10sIHBpbm5lZF9ib19jb3VudDsKLQlzdHJ1Y3QgaTkxNV9hZGRyZXNzX3Nw
YWNlICphY3RpdmVfdm1bSTkxNV9OVU1fRU5HSU5FU107Ci0KIAlzdHJ1Y3Qgc2NhdHRlcmxpc3Qg
KnNnbCwgKmZpdDsKIH07CiAKLS0gCjIuMjIuMAoKX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlz
dHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4v
bGlzdGluZm8vaW50ZWwtZ2Z4

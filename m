Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id EED623319B
	for <lists+intel-gfx@lfdr.de>; Mon,  3 Jun 2019 16:01:06 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 5F20188F61;
	Mon,  3 Jun 2019 14:01:05 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 1B5AA88F61
 for <intel-gfx@lists.freedesktop.org>; Mon,  3 Jun 2019 14:01:03 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 16775793-1500050 
 for multiple; Mon, 03 Jun 2019 14:59:16 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon,  3 Jun 2019 14:59:09 +0100
Message-Id: <20190603135910.15979-14-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190603135910.15979-1-chris@chris-wilson.co.uk>
References: <20190603135910.15979-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 14/15] drm/i915/execlists: Force preemption
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SWYgdGhlIHByZWVtcHRlZCBjb250ZXh0IHRha2VzIHRvbyBsb25nIHRvIHJlbGlucXVpc2ggY29u
dHJvbCwgZS5nLiBpdAppcyBzdHVjayBpbnNpZGUgYSBzaGFkZXIgd2l0aCBhcmJpdHJhdGlvbiBk
aXNhYmxlZCwgZXZpY3QgdGhhdCBjb250ZXh0CndpdGggYW4gZW5naW5lIHJlc2V0LiBUaGlzIGVu
c3VyZXMgdGhhdCBwcmVlbXB0aW9ucyBhcmUgcmVhc29uYWJseQpyZXNwb25zaXZlLCBwcm92aWRp
bmcgYSB0aWdodGVyIFFvUyBmb3IgdGhlIG1vcmUgaW1wb3J0YW50IGNvbnRleHQgYXQKdGhlIGNv
c3Qgb2YgZmxhZ2dpbmcgdW5yZXNwb25zaXZlIGNvbnRleHRzIG1vcmUgZnJlcXVlbnRseSAoaS5l
LiBpbnN0ZWFkCm9mIHVzaW5nIGFuIH4xMHMgaGFuZ2NoZWNrLCB3ZSBub3cgZXZpY3QgYXQgfjEw
bXMpLiAgVGhlIGNoYWxsZW5nZSBvZgpsaWVzIGluIHBpY2tpbmcgYSB0aW1lb3V0IHRoYXQgY2Fu
IGJlIHJlYXNvbmFibHkgc2VydmljZWQgYnkgSFcgZm9yCnR5cGljYWwgd29ya2xvYWRzLCBiYWxh
bmNpbmcgdGhlIGV4aXN0aW5nIGNsaWVudHMgYWdhaW5zdCB0aGUgbmVlZHMgZm9yCnJlc3BvbnNp
dmVuZXNzLgoKU2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24u
Y28udWs+CkNjOiBNaWthIEt1b3BwYWxhIDxtaWthLmt1b3BwYWxhQGxpbnV4LmludGVsLmNvbT4K
Q2M6IFR2cnRrbyBVcnN1bGluIDx0dnJ0a28udXJzdWxpbkBpbnRlbC5jb20+Ci0tLQogZHJpdmVy
cy9ncHUvZHJtL2k5MTUvS2NvbmZpZy5wcm9maWxlIHwgMTIgKysrKysrKwogZHJpdmVycy9ncHUv
ZHJtL2k5MTUvZ3QvaW50ZWxfbHJjLmMgIHwgNDkgKysrKysrKysrKysrKysrKysrKysrKysrKyst
LQogMiBmaWxlcyBjaGFuZ2VkLCA1OCBpbnNlcnRpb25zKCspLCAzIGRlbGV0aW9ucygtKQoKZGlm
ZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L0tjb25maWcucHJvZmlsZSBiL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L0tjb25maWcucHJvZmlsZQppbmRleCA0ZmQxZWE2MzlkMGYuLjYxM2I3NTNj
YjI3YSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvS2NvbmZpZy5wcm9maWxlCisr
KyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L0tjb25maWcucHJvZmlsZQpAQCAtMjUsMyArMjUsMTUg
QEAgY29uZmlnIERSTV9JOTE1X1NQSU5fUkVRVUVTVAogCSAgTWF5IGJlIDAgdG8gZGlzYWJsZSB0
aGUgaW5pdGlhbCBzcGluLiBJbiBwcmFjdGljZSwgd2UgZXN0aW1hdGUKIAkgIHRoZSBjb3N0IG9m
IGVuYWJsaW5nIHRoZSBpbnRlcnJ1cHQgKGlmIGN1cnJlbnRseSBkaXNhYmxlZCkgdG8gYmUKIAkg
IGEgZmV3IG1pY3Jvc2Vjb25kcy4KKworY29uZmlnIERSTV9JOTE1X1BSRUVNUFRfVElNRU9VVAor
CWludCAiUHJlZW1wdCB0aW1lb3V0IChtcykiCisJZGVmYXVsdCAxMCAjIG1pbGxpc2Vjb25kcwor
CWhlbHAKKwkgIEhvdyBsb25nIHRvIHdhaXQgKGluIG1pbGxpc2Vjb25kcykgZm9yIGEgcHJlZW1w
dGlvbiBldmVudCB0byBvY2N1cgorCSAgd2hlbiBzdWJtaXR0aW5nIGEgbmV3IGNvbnRleHQgdmlh
IGV4ZWNsaXN0cy4gSWYgdGhlIGN1cnJlbnQgY29udGV4dAorCSAgZG9lcyBub3QgaGl0IGFuIGFy
Yml0cmF0aW9uIHBvaW50IGFuZCB5aWVsZCB0byBIVyBiZWZvcmUgdGhlIHRpbWVyCisJICBleHBp
cmVzLCB0aGUgSFcgd2lsbCBiZSByZXNldCB0byBhbGxvdyB0aGUgbW9yZSBpbXBvcnRhbnQgY29u
dGV4dAorCSAgdG8gZXhlY3V0ZS4KKworCSAgTWF5IGJlIDAgdG8gZGlzYWJsZSB0aGUgdGltZW91
dC4KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2xyYy5jIGIvZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjLmMKaW5kZXggNjNhM2Q5NTgzODc4Li41OGZk
MzJkZDMwMmUgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2xyYy5j
CisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2xyYy5jCkBAIC0xMjE4LDYgKzEy
MTgsMTEgQEAgc3RhdGljIHZvaWQgZXhlY2xpc3RzX2RlcXVldWUoc3RydWN0IGludGVsX2VuZ2lu
ZV9jcyAqZW5naW5lKQogCQkqcG9ydCA9IGV4ZWNsaXN0c19zY2hlZHVsZV9pbihsYXN0LCBwb3J0
IC0gZXhlY2xpc3RzLT5wZW5kaW5nKTsKIAkJbWVtc2V0KHBvcnQgKyAxLCAwLCAobGFzdF9wb3J0
IC0gcG9ydCkgKiBzaXplb2YoKnBvcnQpKTsKIAkJZXhlY2xpc3RzX3N1Ym1pdF9wb3J0cyhlbmdp
bmUpOworCisJCWlmIChDT05GSUdfRFJNX0k5MTVfUFJFRU1QVF9USU1FT1VUKSB7CisJCQltb2Rf
dGltZXIoJmV4ZWNsaXN0cy0+dGltZXIsCisJCQkJICBqaWZmaWVzICsgbXNlY3NfdG9famlmZmll
c190aW1lb3V0KENPTkZJR19EUk1fSTkxNV9QUkVFTVBUX1RJTUVPVVQpKTsKKwkJfQogCX0KIH0K
IApAQCAtMTM3MywxMyArMTM3OCw0OCBAQCBzdGF0aWMgdm9pZCBwcm9jZXNzX2NzYihzdHJ1Y3Qg
aW50ZWxfZW5naW5lX2NzICplbmdpbmUpCiAJaW52YWxpZGF0ZV9jc2JfZW50cmllcygmYnVmWzBd
LCAmYnVmW251bV9lbnRyaWVzIC0gMV0pOwogfQogCi1zdGF0aWMgdm9pZCBfX2V4ZWNsaXN0c19z
dWJtaXNzaW9uX3Rhc2tsZXQoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqY29uc3QgZW5naW5lKQor
c3RhdGljIGJvb2wgX19leGVjbGlzdHNfc3VibWlzc2lvbl90YXNrbGV0KHN0cnVjdCBpbnRlbF9l
bmdpbmVfY3MgKmNvbnN0IGVuZ2luZSkKIHsKIAlsb2NrZGVwX2Fzc2VydF9oZWxkKCZlbmdpbmUt
PmFjdGl2ZS5sb2NrKTsKIAogCXByb2Nlc3NfY3NiKGVuZ2luZSk7Ci0JaWYgKCFlbmdpbmUtPmV4
ZWNsaXN0cy5wZW5kaW5nWzBdKQorCWlmICghZW5naW5lLT5leGVjbGlzdHMucGVuZGluZ1swXSkg
ewogCQlleGVjbGlzdHNfZGVxdWV1ZShlbmdpbmUpOworCQlyZXR1cm4gdHJ1ZTsKKwl9CisKKwly
ZXR1cm4gZmFsc2U7Cit9CisKK3N0YXRpYyB2b2lkIHByZWVtcHRfcmVzZXQoc3RydWN0IGludGVs
X2VuZ2luZV9jcyAqZW5naW5lKQoreworCWNvbnN0IHVuc2lnbmVkIGludCBiaXQgPSBJOTE1X1JF
U0VUX0VOR0lORSArIGVuZ2luZS0+aWQ7CisJdW5zaWduZWQgbG9uZyAqbG9jayA9ICZlbmdpbmUt
Pmk5MTUtPmdwdV9lcnJvci5mbGFnczsKKworCWlmICh0ZXN0X2FuZF9zZXRfYml0KGJpdCwgbG9j
aykpCisJCXJldHVybjsKKworCXRhc2tsZXRfZGlzYWJsZV9ub3N5bmMoJmVuZ2luZS0+ZXhlY2xp
c3RzLnRhc2tsZXQpOworCXNwaW5fdW5sb2NrKCZlbmdpbmUtPmFjdGl2ZS5sb2NrKTsKKworCWk5
MTVfcmVzZXRfZW5naW5lKGVuZ2luZSwgInByZWVtcHRpb24gdGltZSBvdXQiKTsKKworCXNwaW5f
bG9jaygmZW5naW5lLT5hY3RpdmUubG9jayk7CisJdGFza2xldF9lbmFibGUoJmVuZ2luZS0+ZXhl
Y2xpc3RzLnRhc2tsZXQpOworCisJY2xlYXJfYml0KGJpdCwgbG9jayk7CisJd2FrZV91cF9iaXQo
bG9jaywgYml0KTsKK30KKworc3RhdGljIGJvb2wgcHJlZW1wdF90aW1lb3V0KHN0cnVjdCBpbnRl
bF9lbmdpbmVfY3MgKmNvbnN0IGVuZ2luZSkKK3sKKwlpZiAoIUNPTkZJR19EUk1fSTkxNV9QUkVF
TVBUX1RJTUVPVVQpCisJCXJldHVybiBmYWxzZTsKKworCWlmICghaW50ZWxfZW5naW5lX2hhc19w
cmVlbXB0aW9uKGVuZ2luZSkpCisJCXJldHVybiBmYWxzZTsKKworCXJldHVybiAhdGltZXJfcGVu
ZGluZygmZW5naW5lLT5leGVjbGlzdHMudGltZXIpOwogfQogCiAvKgpAQCAtMTM5Miw3ICsxNDMy
LDEwIEBAIHN0YXRpYyB2b2lkIGV4ZWNsaXN0c19zdWJtaXNzaW9uX3Rhc2tsZXQodW5zaWduZWQg
bG9uZyBkYXRhKQogCXVuc2lnbmVkIGxvbmcgZmxhZ3M7CiAKIAlzcGluX2xvY2tfaXJxc2F2ZSgm
ZW5naW5lLT5hY3RpdmUubG9jaywgZmxhZ3MpOwotCV9fZXhlY2xpc3RzX3N1Ym1pc3Npb25fdGFz
a2xldChlbmdpbmUpOworCisJaWYgKCFfX2V4ZWNsaXN0c19zdWJtaXNzaW9uX3Rhc2tsZXQoZW5n
aW5lKSAmJiBwcmVlbXB0X3RpbWVvdXQoZW5naW5lKSkKKwkJcHJlZW1wdF9yZXNldChlbmdpbmUp
OworCiAJc3Bpbl91bmxvY2tfaXJxcmVzdG9yZSgmZW5naW5lLT5hY3RpdmUubG9jaywgZmxhZ3Mp
OwogfQogCi0tIAoyLjIwLjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNr
dG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2lu
dGVsLWdmeA==

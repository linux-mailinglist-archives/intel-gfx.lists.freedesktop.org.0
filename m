Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 50BCE61792
	for <lists+intel-gfx@lfdr.de>; Sun,  7 Jul 2019 23:02:24 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 9442C89AB7;
	Sun,  7 Jul 2019 21:02:22 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 32BE189AB7
 for <intel-gfx@lists.freedesktop.org>; Sun,  7 Jul 2019 21:02:20 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17163714-1500050 
 for multiple; Sun, 07 Jul 2019 22:00:28 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Sun,  7 Jul 2019 22:00:23 +0100
Message-Id: <20190707210024.26192-11-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190707210024.26192-1-chris@chris-wilson.co.uk>
References: <20190707210024.26192-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 10/11] drm/i915/gtt: Recursive ppgtt alloc for
 gen8
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

UmVmYWN0b3IgdGhlIHNlcGFyYXRlIGFsbG9jYXRpb24gcm91dGluZXMgaW50byBhIHNpbmdsZSBy
ZWN1cnNpdmUKZnVuY3Rpb24uCgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNocmlzQGNo
cmlzLXdpbHNvbi5jby51az4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQu
YyB8IDI3MiArKysrKysrKysrLS0tLS0tLS0tLS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgOTcg
aW5zZXJ0aW9ucygrKSwgMTc1IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L2k5MTVfZ2VtX2d0dC5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW1f
Z3R0LmMKaW5kZXggZTJkNjE2OWE4YTY2Li44M2YwM2Y4ZjRkMmMgMTAwNjQ0Ci0tLSBhL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtX2d0dC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2k5MTVfZ2VtX2d0dC5jCkBAIC0xMDA0LDE5OSArMTAwNCwxMTkgQEAgc3RhdGljIHZvaWQgZ2Vu
OF9wcGd0dF9jbGVhcihzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKIAkJCSAgIHN0YXJ0
LCBzdGFydCArIGxlbmd0aCwgdm0tPnRvcCk7CiB9CiAKLXN0YXRpYyB2b2lkIGdlbjhfcHBndHRf
Y2xlYXJfcGQoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCi0JCQkJc3RydWN0IGk5MTVf
cGFnZV9kaXJlY3RvcnkgKnBkLAotCQkJCXU2NCBzdGFydCwgdTY0IGxlbmd0aCkKLXsKLQlHRU1f
QlVHX09OKCFJU19BTElHTkVEKHN0YXJ0LCBCSVRfVUxMKEdFTjhfUFRFX1NISUZUKSkpOwotCUdF
TV9CVUdfT04oIUlTX0FMSUdORUQobGVuZ3RoLCBCSVRfVUxMKEdFTjhfUFRFX1NISUZUKSkpOwot
Ci0Jc3RhcnQgPj49IEdFTjhfUFRFX1NISUZUOwotCWxlbmd0aCA+Pj0gR0VOOF9QVEVfU0hJRlQ7
Ci0KLQlfX2dlbjhfcHBndHRfY2xlYXIodm0sIHBkLCBzdGFydCwgc3RhcnQgKyBsZW5ndGgsIDEp
OwotfQotCi1zdGF0aWMgdm9pZCBnZW44X3BwZ3R0X2NsZWFyX3BkcChzdHJ1Y3QgaTkxNV9hZGRy
ZXNzX3NwYWNlICp2bSwKLQkJCQkgc3RydWN0IGk5MTVfcGFnZV9kaXJlY3RvcnkgKiBjb25zdCBw
ZHAsCi0JCQkJIHU2NCBzdGFydCwgdTY0IGxlbmd0aCkKLXsKLQlHRU1fQlVHX09OKCFJU19BTElH
TkVEKHN0YXJ0LCBCSVRfVUxMKEdFTjhfUFRFX1NISUZUKSkpOwotCUdFTV9CVUdfT04oIUlTX0FM
SUdORUQobGVuZ3RoLCBCSVRfVUxMKEdFTjhfUFRFX1NISUZUKSkpOwotCi0Jc3RhcnQgPj49IEdF
TjhfUFRFX1NISUZUOwotCWxlbmd0aCA+Pj0gR0VOOF9QVEVfU0hJRlQ7Ci0KLQlfX2dlbjhfcHBn
dHRfY2xlYXIodm0sIHBkcCwgc3RhcnQsIHN0YXJ0ICsgbGVuZ3RoLCAyKTsKLX0KLQotc3RhdGlj
IGludCBnZW44X3BwZ3R0X2FsbG9jX3BkKHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAot
CQkJICAgICAgIHN0cnVjdCBpOTE1X3BhZ2VfZGlyZWN0b3J5ICpwZCwKLQkJCSAgICAgICB1NjQg
c3RhcnQsIHU2NCBsZW5ndGgpCitzdGF0aWMgaW50IF9fZ2VuOF9wcGd0dF9hbGxvYyhzdHJ1Y3Qg
aTkxNV9hZGRyZXNzX3NwYWNlICogY29uc3Qgdm0sCisJCQkgICAgICBzdHJ1Y3QgaTkxNV9wYWdl
X2RpcmVjdG9yeSAqIGNvbnN0IHBkLAorCQkJICAgICAgdTY0ICogY29uc3Qgc3RhcnQsIHU2NCBl
bmQsIGludCBsdmwpCiB7Ci0Jc3RydWN0IGk5MTVfcGFnZV90YWJsZSAqcHQsICphbGxvYyA9IE5V
TEw7Ci0JdTY0IGZyb20gPSBzdGFydDsKLQl1bnNpZ25lZCBpbnQgcGRlOworCWNvbnN0IHN0cnVj
dCBpOTE1X3BhZ2Vfc2NyYXRjaCAqIGNvbnN0IHNjcmF0Y2ggPSAmdm0tPnNjcmF0Y2hbbHZsXTsK
KwlzdHJ1Y3QgaTkxNV9wYWdlX3RhYmxlICphbGxvYyA9IE5VTEw7CisJdW5zaWduZWQgaW50IGlk
eCwgbGVuOwogCWludCByZXQgPSAwOwogCisJbGVuID0gZ2VuOF9wZF9yYW5nZSgqc3RhcnQsIGVu
ZCwgbHZsLS0sICZpZHgpOworCURCRygiJXMoJXApOntsdmw6JWQsIHN0YXJ0OiVsbHgsIGVuZDol
bGx4LCBpZHg6JWQsIGxlbjolZCwgdXNlZDolZH1cbiIsCisJICAgIF9fZnVuY19fLCB2bSwgbHZs
ICsgMSwgKnN0YXJ0LCBlbmQsCisJICAgIGlkeCwgbGVuLCBhdG9taWNfcmVhZChweF91c2VkKHBk
KSkpOworCUdFTV9CVUdfT04oIWxlbiB8fCAoaWR4ICsgbGVuIC0gMSkgPj4gZ2VuOF9wZF9zaGlm
dCgxKSk7CisKIAlzcGluX2xvY2soJnBkLT5sb2NrKTsKLQlnZW44X2Zvcl9lYWNoX3BkZShwdCwg
cGQsIHN0YXJ0LCBsZW5ndGgsIHBkZSkgewotCQljb25zdCBpbnQgY291bnQgPSBnZW44X3B0ZV9j
b3VudChzdGFydCwgbGVuZ3RoKTsKKwlHRU1fQlVHX09OKCFhdG9taWNfcmVhZChweF91c2VkKHBk
KSkpOyAvKiBNdXN0IGJlIHBpbm5lZCEgKi8KKwlkbyB7CisJCXN0cnVjdCBpOTE1X3BhZ2VfdGFi
bGUgKnB0ID0gcGQtPmVudHJ5W2lkeF07CiAKIAkJaWYgKCFwdCkgewogCQkJc3Bpbl91bmxvY2so
JnBkLT5sb2NrKTsKIAotCQkJcHQgPSBmZXRjaF9hbmRfemVybygmYWxsb2MpOwotCQkJaWYgKCFw
dCkKLQkJCQlwdCA9IGFsbG9jX3B0KHZtKTsKLQkJCWlmIChJU19FUlIocHQpKSB7Ci0JCQkJcmV0
ID0gUFRSX0VSUihwdCk7Ci0JCQkJZ290byB1bndpbmQ7Ci0JCQl9CisJCQlEQkcoIiVzKCVwKTp7
IGx2bDolZCwgaWR4OiVkIH0gYWxsb2NhdGluZyBuZXcgdHJlZVxuIiwKKwkJCSAgICBfX2Z1bmNf
Xywgdm0sIGx2bCArIDEsIGlkeCk7CiAKLQkJCWlmIChjb3VudCA8IEdFTjhfUFRFUyB8fCBpbnRl
bF92Z3B1X2FjdGl2ZSh2bS0+aTkxNSkpCi0JCQkJZmlsbF9weChwdCwgdm0tPnNjcmF0Y2hbMF0u
ZW5jb2RlKTsKKwkJCXB0ID0gZmV0Y2hfYW5kX3plcm8oJmFsbG9jKTsKKwkJCWlmIChsdmwpIHsK
KwkJCQlpZiAoIXB0KSB7CisJCQkJCXB0ID0gJmFsbG9jX3BkKHZtKS0+cHQ7CisJCQkJCWlmIChJ
U19FUlIocHQpKSB7CisJCQkJCQlyZXQgPSBQVFJfRVJSKHB0KTsKKwkJCQkJCWJyZWFrOworCQkJ
CQl9CisJCQkJfQogCi0JCQlzcGluX2xvY2soJnBkLT5sb2NrKTsKLQkJCWlmICghcGQtPmVudHJ5
W3BkZV0pIHsKLQkJCQlzZXRfcGRfZW50cnkocGQsIHBkZSwgcHQpOworCQkJCWZpbGxfcHgocHQs
IHZtLT5zY3JhdGNoW2x2bF0uZW5jb2RlKTsKIAkJCX0gZWxzZSB7Ci0JCQkJYWxsb2MgPSBwdDsK
LQkJCQlwdCA9IHBkLT5lbnRyeVtwZGVdOwotCQkJfQotCQl9Ci0KLQkJYXRvbWljX2FkZChjb3Vu
dCwgJnB0LT51c2VkKTsKLQl9Ci0Jc3Bpbl91bmxvY2soJnBkLT5sb2NrKTsKLQlnb3RvIG91dDsK
LQotdW53aW5kOgotCWdlbjhfcHBndHRfY2xlYXJfcGQodm0sIHBkLCBmcm9tLCBzdGFydCAtIGZy
b20pOwotb3V0OgotCWlmIChhbGxvYykKLQkJZnJlZV9weCh2bSwgYWxsb2MpOwotCXJldHVybiBy
ZXQ7Ci19Ci0KLXN0YXRpYyBpbnQgZ2VuOF9wcGd0dF9hbGxvY19wZHAoc3RydWN0IGk5MTVfYWRk
cmVzc19zcGFjZSAqdm0sCi0JCQkJc3RydWN0IGk5MTVfcGFnZV9kaXJlY3RvcnkgKnBkcCwKLQkJ
CQl1NjQgc3RhcnQsIHU2NCBsZW5ndGgpCi17Ci0Jc3RydWN0IGk5MTVfcGFnZV9kaXJlY3Rvcnkg
KnBkLCAqYWxsb2MgPSBOVUxMOwotCXU2NCBmcm9tID0gc3RhcnQ7Ci0JdW5zaWduZWQgaW50IHBk
cGU7Ci0JaW50IHJldCA9IDA7CisJCQkJaWYgKCFwdCkgeworCQkJCQlwdCA9IGFsbG9jX3B0KHZt
KTsKKwkJCQkJaWYgKElTX0VSUihwdCkpIHsKKwkJCQkJCXJldCA9IFBUUl9FUlIocHQpOworCQkJ
CQkJYnJlYWs7CisJCQkJCX0KKwkJCQl9CiAKLQlzcGluX2xvY2soJnBkcC0+bG9jayk7Ci0JZ2Vu
OF9mb3JfZWFjaF9wZHBlKHBkLCBwZHAsIHN0YXJ0LCBsZW5ndGgsIHBkcGUpIHsKLQkJaWYgKCFw
ZCkgewotCQkJc3Bpbl91bmxvY2soJnBkcC0+bG9jayk7Ci0KLQkJCXBkID0gZmV0Y2hfYW5kX3pl
cm8oJmFsbG9jKTsKLQkJCWlmICghcGQpCi0JCQkJcGQgPSBhbGxvY19wZCh2bSk7Ci0JCQlpZiAo
SVNfRVJSKHBkKSkgewotCQkJCXJldCA9IFBUUl9FUlIocGQpOwotCQkJCWdvdG8gdW53aW5kOwor
CQkJCWlmIChpbnRlbF92Z3B1X2FjdGl2ZSh2bS0+aTkxNSkgfHwKKwkJCQkgICAgZ2VuOF9wdF9j
b3VudCgqc3RhcnQsIGVuZCkgPCBJOTE1X1BERVMpCisJCQkJCWZpbGxfcHgocHQsIHZtLT5zY3Jh
dGNoW2x2bF0uZW5jb2RlKTsKIAkJCX0KIAotCQkJZmlsbF9weChwZCwgdm0tPnNjcmF0Y2hbMV0u
ZW5jb2RlKTsKKwkJCXNwaW5fbG9jaygmcGQtPmxvY2spOworCQkJaWYgKGxpa2VseSghcGQtPmVu
dHJ5W2lkeF0pKQorCQkJCXNldF9wZF9lbnRyeShwZCwgaWR4LCBwdCk7CisJCQllbHNlCisJCQkJ
YWxsb2MgPSBwdCwgcHQgPSBwZC0+ZW50cnlbaWR4XTsKKwkJfQogCi0JCQlzcGluX2xvY2soJnBk
cC0+bG9jayk7Ci0JCQlpZiAoIXBkcC0+ZW50cnlbcGRwZV0pIHsKLQkJCQlzZXRfcGRfZW50cnko
cGRwLCBwZHBlLCBwZCk7Ci0JCQl9IGVsc2UgewotCQkJCWFsbG9jID0gcGQ7Ci0JCQkJcGQgPSBw
ZHAtPmVudHJ5W3BkcGVdOworCQlpZiAobHZsKSB7CisJCQlhdG9taWNfaW5jKCZwdC0+dXNlZCk7
CisJCQlzcGluX3VubG9jaygmcGQtPmxvY2spOworCisJCQlyZXQgPSBfX2dlbjhfcHBndHRfYWxs
b2Modm0sIGFzX3BkKHB0KSwKKwkJCQkJCSBzdGFydCwgZW5kLCBsdmwpOworCQkJaWYgKHVubGlr
ZWx5KHJldCkpIHsKKwkJCQlpZiAocmVsZWFzZV9wZF9lbnRyeShwZCwgaWR4LCBwdCwgc2NyYXRj
aCkpCisJCQkJCWZyZWVfcHgodm0sIHB0KTsKKwkJCQlnb3RvIG91dDsKIAkJCX0KLQkJfQotCQlh
dG9taWNfaW5jKHB4X3VzZWQocGQpKTsKLQkJc3Bpbl91bmxvY2soJnBkcC0+bG9jayk7CiAKLQkJ
cmV0ID0gZ2VuOF9wcGd0dF9hbGxvY19wZCh2bSwgcGQsIHN0YXJ0LCBsZW5ndGgpOwotCQlpZiAo
dW5saWtlbHkocmV0KSkKLQkJCWdvdG8gdW53aW5kX3BkOworCQkJc3Bpbl9sb2NrKCZwZC0+bG9j
ayk7CisJCQlhdG9taWNfZGVjKCZwdC0+dXNlZCk7CisJCQlHRU1fQlVHX09OKCFhdG9taWNfcmVh
ZCgmcHQtPnVzZWQpKTsKKwkJfSBlbHNlIHsKKwkJCXVuc2lnbmVkIGludCBjb3VudCA9IGdlbjhf
cHRfY291bnQoKnN0YXJ0LCBlbmQpOwogCi0JCXNwaW5fbG9jaygmcGRwLT5sb2NrKTsKLQkJYXRv
bWljX2RlYyhweF91c2VkKHBkKSk7Ci0JfQotCXNwaW5fdW5sb2NrKCZwZHAtPmxvY2spOwotCWdv
dG8gb3V0OworCQkJREJHKCIlcyglcCk6e2x2bDolZCwgc3RhcnQ6JWxseCwgZW5kOiVsbHgsIGlk
eDolZCwgbGVuOiVkLCB1c2VkOiVkfSBpbnNlcnRpbmcgcHRlXG4iLAorCQkJICAgIF9fZnVuY19f
LCB2bSwgbHZsLCAqc3RhcnQsIGVuZCwKKwkJCSAgICBnZW44X3BkX2luZGV4KCpzdGFydCwgMCks
IGNvdW50LAorCQkJICAgIGF0b21pY19yZWFkKCZwdC0+dXNlZCkpOwogCi11bndpbmRfcGQ6Ci0J
aWYgKHJlbGVhc2VfcGRfZW50cnkocGRwLCBwZHBlLCAmcGQtPnB0LCAmdm0tPnNjcmF0Y2hbMl0p
KQotCQlmcmVlX3B4KHZtLCBwZCk7Ci11bndpbmQ6Ci0JZ2VuOF9wcGd0dF9jbGVhcl9wZHAodm0s
IHBkcCwgZnJvbSwgc3RhcnQgLSBmcm9tKTsKKwkJCWF0b21pY19hZGQoY291bnQsICZwdC0+dXNl
ZCk7CisJCQlHRU1fQlVHX09OKGF0b21pY19yZWFkKCZwdC0+dXNlZCkgPiBJOTE1X1BERVMpOwor
CQkJKnN0YXJ0ICs9IGNvdW50OworCQl9CisJfSB3aGlsZSAoaWR4KyssIC0tbGVuKTsKKwlzcGlu
X3VubG9jaygmcGQtPmxvY2spOwogb3V0OgogCWlmIChhbGxvYykKIAkJZnJlZV9weCh2bSwgYWxs
b2MpOwogCXJldHVybiByZXQ7CiB9CiAKLXN0YXRpYyBpbnQgZ2VuOF9wcGd0dF9hbGxvY18zbHZs
KHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAotCQkJCSB1NjQgc3RhcnQsIHU2NCBsZW5n
dGgpCi17Ci0JcmV0dXJuIGdlbjhfcHBndHRfYWxsb2NfcGRwKHZtLAotCQkJCSAgICBpOTE1X3Zt
X3RvX3BwZ3R0KHZtKS0+cGQsIHN0YXJ0LCBsZW5ndGgpOwotfQotCi1zdGF0aWMgaW50IGdlbjhf
cHBndHRfYWxsb2NfNGx2bChzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKLQkJCQkgdTY0
IHN0YXJ0LCB1NjQgbGVuZ3RoKQorc3RhdGljIGludCBnZW44X3BwZ3R0X2FsbG9jKHN0cnVjdCBp
OTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAorCQkJICAgIHU2NCBzdGFydCwgdTY0IGxlbmd0aCkKIHsK
LQlzdHJ1Y3QgaTkxNV9wcGd0dCAqcHBndHQgPSBpOTE1X3ZtX3RvX3BwZ3R0KHZtKTsKLQlzdHJ1
Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeSAqIGNvbnN0IHBtbDQgPSBwcGd0dC0+cGQ7Ci0Jc3RydWN0
IGk5MTVfcGFnZV9kaXJlY3RvcnkgKnBkcCwgKmFsbG9jID0gTlVMTDsKIAl1NjQgZnJvbSA9IHN0
YXJ0OwotCWludCByZXQgPSAwOwotCXUzMiBwbWw0ZTsKLQotCXNwaW5fbG9jaygmcG1sNC0+bG9j
ayk7Ci0JZ2VuOF9mb3JfZWFjaF9wbWw0ZShwZHAsIHBtbDQsIHN0YXJ0LCBsZW5ndGgsIHBtbDRl
KSB7Ci0JCWlmICghcGRwKSB7Ci0JCQlzcGluX3VubG9jaygmcG1sNC0+bG9jayk7Ci0KLQkJCXBk
cCA9IGZldGNoX2FuZF96ZXJvKCZhbGxvYyk7Ci0JCQlpZiAoIXBkcCkKLQkJCQlwZHAgPSBhbGxv
Y19wZCh2bSk7Ci0JCQlpZiAoSVNfRVJSKHBkcCkpIHsKLQkJCQlyZXQgPSBQVFJfRVJSKHBkcCk7
Ci0JCQkJZ290byB1bndpbmQ7Ci0JCQl9Ci0KLQkJCWZpbGxfcHgocGRwLCB2bS0+c2NyYXRjaFsy
XS5lbmNvZGUpOworCWludCBlcnI7CiAKLQkJCXNwaW5fbG9jaygmcG1sNC0+bG9jayk7Ci0JCQlp
ZiAoIXBtbDQtPmVudHJ5W3BtbDRlXSkgewotCQkJCXNldF9wZF9lbnRyeShwbWw0LCBwbWw0ZSwg
cGRwKTsKLQkJCX0gZWxzZSB7Ci0JCQkJYWxsb2MgPSBwZHA7Ci0JCQkJcGRwID0gcG1sNC0+ZW50
cnlbcG1sNGVdOwotCQkJfQotCQl9Ci0JCWF0b21pY19pbmMocHhfdXNlZChwZHApKTsKLQkJc3Bp
bl91bmxvY2soJnBtbDQtPmxvY2spOworCUdFTV9CVUdfT04oIUlTX0FMSUdORUQoc3RhcnQsIEJJ
VF9VTEwoR0VOOF9QVEVfU0hJRlQpKSk7CisJR0VNX0JVR19PTighSVNfQUxJR05FRChsZW5ndGgs
IEJJVF9VTEwoR0VOOF9QVEVfU0hJRlQpKSk7CiAKLQkJcmV0ID0gZ2VuOF9wcGd0dF9hbGxvY19w
ZHAodm0sIHBkcCwgc3RhcnQsIGxlbmd0aCk7Ci0JCWlmICh1bmxpa2VseShyZXQpKQotCQkJZ290
byB1bndpbmRfcGRwOworCXN0YXJ0ID4+PSBHRU44X1BURV9TSElGVDsKKwlsZW5ndGggPj49IEdF
TjhfUFRFX1NISUZUOworCUdFTV9CVUdfT04obGVuZ3RoID09IDApOwogCi0JCXNwaW5fbG9jaygm
cG1sNC0+bG9jayk7Ci0JCWF0b21pY19kZWMocHhfdXNlZChwZHApKTsKLQl9Ci0Jc3Bpbl91bmxv
Y2soJnBtbDQtPmxvY2spOwotCWdvdG8gb3V0OworCWVyciA9IF9fZ2VuOF9wcGd0dF9hbGxvYyh2
bSwgaTkxNV92bV90b19wcGd0dCh2bSktPnBkLAorCQkJCSAmc3RhcnQsIHN0YXJ0ICsgbGVuZ3Ro
LCB2bS0+dG9wKTsKKwlpZiAodW5saWtlbHkoZXJyKSkKKwkJX19nZW44X3BwZ3R0X2NsZWFyKHZt
LCBpOTE1X3ZtX3RvX3BwZ3R0KHZtKS0+cGQsCisJCQkJICAgZnJvbSwgc3RhcnQsIHZtLT50b3Ap
OwogCi11bndpbmRfcGRwOgotCWlmIChyZWxlYXNlX3BkX2VudHJ5KHBtbDQsIHBtbDRlLCAmcGRw
LT5wdCwgJnZtLT5zY3JhdGNoWzNdKSkKLQkJZnJlZV9weCh2bSwgcGRwKTsKLXVud2luZDoKLQln
ZW44X3BwZ3R0X2NsZWFyKHZtLCBmcm9tLCBzdGFydCAtIGZyb20pOwotb3V0OgotCWlmIChhbGxv
YykKLQkJZnJlZV9weCh2bSwgYWxsb2MpOwotCXJldHVybiByZXQ7CisJcmV0dXJuIGVycjsKIH0K
IAogc3RhdGljIGlubGluZSBzdHJ1Y3Qgc2d0X2RtYSB7CkBAIC0xNDkzLDE5ICsxNDEzLDIyIEBA
IHN0YXRpYyBpbnQgZ2VuOF9pbml0X3NjcmF0Y2goc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAq
dm0pCiBzdGF0aWMgaW50IGdlbjhfcHJlYWxsb2NhdGVfdG9wX2xldmVsX3BkcChzdHJ1Y3QgaTkx
NV9wcGd0dCAqcHBndHQpCiB7CiAJc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0gPSAmcHBn
dHQtPnZtOwotCXN0cnVjdCBpOTE1X3BhZ2VfZGlyZWN0b3J5ICpwZHAgPSBwcGd0dC0+cGQ7Ci0J
c3RydWN0IGk5MTVfcGFnZV9kaXJlY3RvcnkgKnBkOwotCXU2NCBzdGFydCA9IDAsIGxlbmd0aCA9
IHBwZ3R0LT52bS50b3RhbDsKLQl1bnNpZ25lZCBpbnQgcGRwZTsKKwlzdHJ1Y3QgaTkxNV9wYWdl
X2RpcmVjdG9yeSAqcGQgPSBwcGd0dC0+cGQ7CisJdW5zaWduZWQgaW50IGlkeDsKKworCUdFTV9C
VUdfT04odm0tPnRvcCAhPSAyKTsKKwlHRU1fQlVHX09OKCh2bS0+dG90YWwgPj4gX19nZW44X3B0
ZV9zaGlmdCgyKSkgIT0gR0VOOF8zTFZMX1BEUEVTKTsKKworCWZvciAoaWR4ID0gMDsgaWR4IDwg
R0VOOF8zTFZMX1BEUEVTOyBpZHgrKykgeworCQlzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeSAq
cGRlOwogCi0JZ2VuOF9mb3JfZWFjaF9wZHBlKHBkLCBwZHAsIHN0YXJ0LCBsZW5ndGgsIHBkcGUp
IHsKLQkJcGQgPSBhbGxvY19wZCh2bSk7Ci0JCWlmIChJU19FUlIocGQpKQotCQkJcmV0dXJuIFBU
Ul9FUlIocGQpOworCQlwZGUgPSBhbGxvY19wZCh2bSk7CisJCWlmIChJU19FUlIocGRlKSkKKwkJ
CXJldHVybiBQVFJfRVJSKHBkZSk7CiAKLQkJZmlsbF9weChwZCwgdm0tPnNjcmF0Y2hbMV0uZW5j
b2RlKTsKLQkJc2V0X3BkX2VudHJ5KHBkcCwgcGRwZSwgcGQpOwotCQlhdG9taWNfaW5jKHB4X3Vz
ZWQocGQpKTsgLyoga2VlcCBwaW5uZWQgKi8KKwkJZmlsbF9weChwZGUsIHZtLT5zY3JhdGNoWzFd
LmVuY29kZSk7CisJCXNldF9wZF9lbnRyeShwZCwgaWR4LCBwZGUpOworCQlhdG9taWNfaW5jKHB4
X3VzZWQocGRlKSk7IC8qIGtlZXAgcGlubmVkICovCiAJfQogCiAJcmV0dXJuIDA7CkBAIC0xNTk1
LDcgKzE1MTgsNiBAQCBzdGF0aWMgc3RydWN0IGk5MTVfcHBndHQgKmdlbjhfcHBndHRfY3JlYXRl
KHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQogCX0KIAogCWlmIChpOTE1X3ZtX2lzXzRs
dmwoJnBwZ3R0LT52bSkpIHsKLQkJcHBndHQtPnZtLmFsbG9jYXRlX3ZhX3JhbmdlID0gZ2VuOF9w
cGd0dF9hbGxvY180bHZsOwogCQlwcGd0dC0+dm0uaW5zZXJ0X2VudHJpZXMgPSBnZW44X3BwZ3R0
X2luc2VydF80bHZsOwogCX0gZWxzZSB7CiAJCWlmIChpbnRlbF92Z3B1X2FjdGl2ZShpOTE1KSkg
ewpAQCAtMTYwNCwxMCArMTUyNiwxMCBAQCBzdGF0aWMgc3RydWN0IGk5MTVfcHBndHQgKmdlbjhf
cHBndHRfY3JlYXRlKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQogCQkJCWdvdG8gZXJy
X2ZyZWVfcGQ7CiAJCX0KIAotCQlwcGd0dC0+dm0uYWxsb2NhdGVfdmFfcmFuZ2UgPSBnZW44X3Bw
Z3R0X2FsbG9jXzNsdmw7CiAJCXBwZ3R0LT52bS5pbnNlcnRfZW50cmllcyA9IGdlbjhfcHBndHRf
aW5zZXJ0XzNsdmw7CiAJfQogCisJcHBndHQtPnZtLmFsbG9jYXRlX3ZhX3JhbmdlID0gZ2VuOF9w
cGd0dF9hbGxvYzsKIAlwcGd0dC0+dm0uY2xlYXJfcmFuZ2UgPSBnZW44X3BwZ3R0X2NsZWFyOwog
CiAJaWYgKGludGVsX3ZncHVfYWN0aXZlKGk5MTUpKQotLSAKMi4yMC4xCgpfX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpJbnRlbC1nZnggbWFpbGluZyBsaXN0
CkludGVsLWdmeEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3Rv
cC5vcmcvbWFpbG1hbi9saXN0aW5mby9pbnRlbC1nZng=

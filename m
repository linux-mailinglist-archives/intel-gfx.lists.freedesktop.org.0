Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 8168524A15F
	for <lists+intel-gfx@lfdr.de>; Wed, 19 Aug 2020 16:09:38 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 56A8C6E415;
	Wed, 19 Aug 2020 14:09:18 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mblankhorst.nl (mblankhorst.nl [141.105.120.124])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 1BB976E3B5
 for <intel-gfx@lists.freedesktop.org>; Wed, 19 Aug 2020 14:09:12 +0000 (UTC)
From: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
To: intel-gfx@lists.freedesktop.org
Date: Wed, 19 Aug 2020 16:08:48 +0200
Message-Id: <20200819140904.1708856-9-maarten.lankhorst@linux.intel.com>
X-Mailer: git-send-email 2.28.0
In-Reply-To: <20200819140904.1708856-1-maarten.lankhorst@linux.intel.com>
References: <20200819140904.1708856-1-maarten.lankhorst@linux.intel.com>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v2 08/24] drm/i915: Use per object locking in
 execbuf, v12.
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: =?UTF-8?q?Thomas=20Hellstr=C3=B6m?= <thomas.hellstrom@intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

Tm93IHRoYXQgd2UgY2hhbmdlZCBleGVjYnVmIHN1Ym1pc3Npb24gc2xpZ2h0bHkgdG8gYWxsb3cg
dXMgdG8gZG8gYWxsCnBpbm5pbmcgaW4gb25lIHBsYWNlLCB3ZSBjYW4gbm93IHNpbXBseSBhZGQg
d3cgdmVyc2lvbnMgb24gdG9wIG9mCnN0cnVjdF9tdXRleC4gQWxsIHdlIGhhdmUgdG8gZG8gaXMg
YSBzZXBhcmF0ZSBwYXRoIGZvciAtRURFQURMSwpoYW5kbGluZywgd2hpY2ggbmVlZHMgdG8gdW5w
aW4gYWxsIGdlbSBibydzIGJlZm9yZSBkcm9wcGluZyB0aGUgbG9jaywKdGhlbiBzdGFydGluZyBv
dmVyLgoKVGhpcyBmaW5hbGx5IGFsbG93cyB1cyB0byBkbyBwYXJhbGxlbCBzdWJtaXNzaW9uLCBi
dXQgYmVjYXVzZSBub3QKYWxsIG9mIHRoZSBwaW5uaW5nIGNvZGUgdXNlcyB0aGUgd3cgY3R4IHll
dCwgd2UgY2Fubm90IGNvbXBsZXRlbHkKZHJvcCBzdHJ1Y3RfbXV0ZXggeWV0LgoKQ2hhbmdlcyBz
aW5jZSB2MToKLSBLZWVwIHN0cnVjdF9tdXRleCBmb3Igbm93LiA6KApDaGFuZ2VzIHNpbmNlIHYy
OgotIE1ha2Ugc3VyZSB3ZSBhbHdheXMgbG9jayB0aGUgd3cgY29udGV4dCBpbiBzbG93cGF0aC4K
Q2hhbmdlcyBzaW5jZSB2MzoKLSBEb24ndCBjYWxsIF9fZWJfdW5yZXNlcnZlX3ZtYSBpbiBlYl9t
b3ZlX3RvX2dwdSBub3c7IHRoaXMgY2FuIGJlCiAgZG9uZSBvbiBub3JtYWwgdW5sb2NrIHBhdGgu
Ci0gVW5jb25kaXRpb25hbGx5IHJlbGVhc2Ugdm1hcyBhbmQgY29udGV4dC4KQ2hhbmdlcyBzaW5j
ZSB2NDoKLSBSZWJhc2VkIG9uIHRvcCBvZiBzdHJ1Y3RfbXV0ZXggcmVkdWN0aW9uLgpDaGFuZ2Vz
IHNpbmNlIHY1OgotIFJlbW92ZSB0cmFpbmluZyB3aGVlbHMuCkNoYW5nZXMgc2luY2UgdjY6Ci0g
Rml4IGFjY2lkZW50YWxseSBicm9rZW4gLUVOT1NQQyBoYW5kbGluZy4KQ2hhbmdlcyBzaW5jZSB2
NzoKLSBIYW5kbGUgZ3QgYnVmZmVyIHBvb2wgYmV0dGVyLgpDaGFuZ2VzIHNpbmNlIHY4OgotIFBy
b3Blcmx5IGNsZWFyIHZhcmlhYmxlcywgdG8gbWFrZSAtRURFQURMSyBoYW5kbGluZyBub3QgQlVH
LgpDaGFuZ2Ugc2luY2Ugdjk6Ci0gRml4IHVucGlubmluZyBmZW5jZSBvbiBwbnYgYW5kIGJlbG93
LgpDaGFuZ2VzIHNpbmNlIHYxMDoKLSBNYWtlIHJlbG9jYXRpb24gZ3B1IGNoYWluaW5nIHdvcmtp
bmcgYWdhaW4uCkNoYW5nZXMgc2luY2UgdjExOgotIFJlbW92ZSByZWxvY2F0aW9uIGNoYWluaW5n
LCBwYWluIHRvIG1ha2UgaXQgd29yay4KClNpZ25lZC1vZmYtYnk6IE1hYXJ0ZW4gTGFua2hvcnN0
IDxtYWFydGVuLmxhbmtob3JzdEBsaW51eC5pbnRlbC5jb20+ClJldmlld2VkLWJ5OiBUaG9tYXMg
SGVsbHN0csO2bSA8dGhvbWFzLmhlbGxzdHJvbUBpbnRlbC5jb20+Ci0tLQogLi4uL2dwdS9kcm0v
aTkxNS9nZW0vaTkxNV9nZW1fZXhlY2J1ZmZlci5jICAgIHwgMzYzICsrKysrKysrKysrLS0tLS0t
LQogLi4uL2k5MTUvZ2VtL3NlbGZ0ZXN0cy9pOTE1X2dlbV9leGVjYnVmZmVyLmMgIHwgIDYyICst
LQogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW0uYyAgICAgICAgICAgICAgIHwgICA2ICsK
IGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtLmggICAgICAgICAgICAgICB8ICAgMSArCiA0
IGZpbGVzIGNoYW5nZWQsIDI2MiBpbnNlcnRpb25zKCspLCAxNzAgZGVsZXRpb25zKC0pCgpkaWZm
IC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2V4ZWNidWZmZXIuYyBi
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9leGVjYnVmZmVyLmMKaW5kZXggYzM0
ZTU1Y2ZmNzNkLi4xM2I5OTY4MzBlMjUgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2dlbS9pOTE1X2dlbV9leGVjYnVmZmVyLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2Vt
L2k5MTVfZ2VtX2V4ZWNidWZmZXIuYwpAQCAtMjU3LDYgKzI1Nyw4IEBAIHN0cnVjdCBpOTE1X2V4
ZWNidWZmZXIgewogCS8qKiBsaXN0IG9mIHZtYSB0aGF0IGhhdmUgZXhlY29iai5yZWxvY2F0aW9u
X2NvdW50ICovCiAJc3RydWN0IGxpc3RfaGVhZCByZWxvY3M7CiAKKwlzdHJ1Y3QgaTkxNV9nZW1f
d3dfY3R4IHd3OworCiAJLyoqCiAJICogVHJhY2sgdGhlIG1vc3QgcmVjZW50bHkgdXNlZCBvYmpl
Y3QgZm9yIHJlbG9jYXRpb25zLCBhcyB3ZQogCSAqIGZyZXF1ZW50bHkgaGF2ZSB0byBwZXJmb3Jt
IG11bHRpcGxlIHJlbG9jYXRpb25zIHdpdGhpbiB0aGUgc2FtZQpAQCAtMjc1LDE0ICsyNzcsMTgg
QEAgc3RydWN0IGk5MTVfZXhlY2J1ZmZlciB7CiAJCXN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxOwog
CQl1MzIgKnJxX2NtZDsKIAkJdW5zaWduZWQgaW50IHJxX3NpemU7CisJCXN0cnVjdCBpbnRlbF9n
dF9idWZmZXJfcG9vbF9ub2RlICpwb29sOwogCX0gcmVsb2NfY2FjaGU7CiAKKwlzdHJ1Y3QgaW50
ZWxfZ3RfYnVmZmVyX3Bvb2xfbm9kZSAqcmVsb2NfcG9vbDsgLyoqIHJlbG9jYXRpb24gcG9vbCBm
b3IgLUVERUFETEsgaGFuZGxpbmcgKi8KKwogCXU2NCBpbnZhbGlkX2ZsYWdzOyAvKiogU2V0IG9m
IGV4ZWNvYmouZmxhZ3MgdGhhdCBhcmUgaW52YWxpZCAqLwogCXUzMiBjb250ZXh0X2ZsYWdzOyAv
KiogU2V0IG9mIGV4ZWNvYmouZmxhZ3MgdG8gaW5zZXJ0IGZyb20gdGhlIGN0eCAqLwogCiAJdTMy
IGJhdGNoX3N0YXJ0X29mZnNldDsgLyoqIExvY2F0aW9uIHdpdGhpbiBvYmplY3Qgb2YgYmF0Y2gg
Ki8KIAl1MzIgYmF0Y2hfbGVuOyAvKiogTGVuZ3RoIG9mIGJhdGNoIHdpdGhpbiBvYmplY3QgKi8K
IAl1MzIgYmF0Y2hfZmxhZ3M7IC8qKiBGbGFncyBjb21wb3NlZCBmb3IgZW1pdF9iYl9zdGFydCgp
ICovCisJc3RydWN0IGludGVsX2d0X2J1ZmZlcl9wb29sX25vZGUgKmJhdGNoX3Bvb2w7IC8qKiBw
b29sIG5vZGUgZm9yIGJhdGNoIGJ1ZmZlciAqLwogCiAJLyoqCiAJICogSW5kaWNhdGUgZWl0aGVy
IHRoZSBzaXplIG9mIHRoZSBoYXN0YWJsZSB1c2VkIHRvIHJlc29sdmUKQEAgLTQ1MiwyMyArNDU4
LDE2IEBAIGViX3Bpbl92bWEoc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIsCiAJcmV0dXJuICFl
Yl92bWFfbWlzcGxhY2VkKGVudHJ5LCB2bWEsIGV2LT5mbGFncyk7CiB9CiAKLXN0YXRpYyBpbmxp
bmUgdm9pZCBfX2ViX3VucmVzZXJ2ZV92bWEoc3RydWN0IGk5MTVfdm1hICp2bWEsIHVuc2lnbmVk
IGludCBmbGFncykKLXsKLQlHRU1fQlVHX09OKCEoZmxhZ3MgJiBfX0VYRUNfT0JKRUNUX0hBU19Q
SU4pKTsKLQotCWlmICh1bmxpa2VseShmbGFncyAmIF9fRVhFQ19PQkpFQ1RfSEFTX0ZFTkNFKSkK
LQkJX19pOTE1X3ZtYV91bnBpbl9mZW5jZSh2bWEpOwotCi0JX19pOTE1X3ZtYV91bnBpbih2bWEp
OwotfQotCiBzdGF0aWMgaW5saW5lIHZvaWQKIGViX3VucmVzZXJ2ZV92bWEoc3RydWN0IGViX3Zt
YSAqZXYpCiB7CiAJaWYgKCEoZXYtPmZsYWdzICYgX19FWEVDX09CSkVDVF9IQVNfUElOKSkKIAkJ
cmV0dXJuOwogCi0JX19lYl91bnJlc2VydmVfdm1hKGV2LT52bWEsIGV2LT5mbGFncyk7CisJaWYg
KHVubGlrZWx5KGV2LT5mbGFncyAmIF9fRVhFQ19PQkpFQ1RfSEFTX0ZFTkNFKSkKKwkJX19pOTE1
X3ZtYV91bnBpbl9mZW5jZShldi0+dm1hKTsKKworCV9faTkxNV92bWFfdW5waW4oZXYtPnZtYSk7
CiAJZXYtPmZsYWdzICY9IH5fX0VYRUNfT0JKRUNUX1JFU0VSVkVEOwogfQogCkBAIC01NjMsMTYg
KzU2Miw2IEBAIGViX2FkZF92bWEoc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIsCiAKIAkJZWIt
PmJhdGNoID0gZXY7CiAJfQotCi0JaWYgKGViX3Bpbl92bWEoZWIsIGVudHJ5LCBldikpIHsKLQkJ
aWYgKGVudHJ5LT5vZmZzZXQgIT0gdm1hLT5ub2RlLnN0YXJ0KSB7Ci0JCQllbnRyeS0+b2Zmc2V0
ID0gdm1hLT5ub2RlLnN0YXJ0IHwgVVBEQVRFOwotCQkJZWItPmFyZ3MtPmZsYWdzIHw9IF9fRVhF
Q19IQVNfUkVMT0M7Ci0JCX0KLQl9IGVsc2UgewotCQllYl91bnJlc2VydmVfdm1hKGV2KTsKLQkJ
bGlzdF9hZGRfdGFpbCgmZXYtPmJpbmRfbGluaywgJmViLT51bmJvdW5kKTsKLQl9CiB9CiAKIHN0
YXRpYyBpbmxpbmUgaW50IHVzZV9jcHVfcmVsb2MoY29uc3Qgc3RydWN0IHJlbG9jX2NhY2hlICpj
YWNoZSwKQEAgLTY1NywxMCArNjQ2LDYgQEAgc3RhdGljIGludCBlYl9yZXNlcnZlKHN0cnVjdCBp
OTE1X2V4ZWNidWZmZXIgKmViKQogCSAqIFRoaXMgYXZvaWQgdW5uZWNlc3NhcnkgdW5iaW5kaW5n
IG9mIGxhdGVyIG9iamVjdHMgaW4gb3JkZXIgdG8gbWFrZQogCSAqIHJvb20gZm9yIHRoZSBlYXJs
aWVyIG9iamVjdHMgKnVubGVzcyogd2UgbmVlZCB0byBkZWZyYWdtZW50LgogCSAqLwotCi0JaWYg
KG11dGV4X2xvY2tfaW50ZXJydXB0aWJsZSgmZWItPmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpKQot
CQlyZXR1cm4gLUVJTlRSOwotCiAJcGFzcyA9IDA7CiAJZG8gewogCQlsaXN0X2Zvcl9lYWNoX2Vu
dHJ5KGV2LCAmZWItPnVuYm91bmQsIGJpbmRfbGluaykgewpAQCAtNjY5LDcgKzY1NCw3IEBAIHN0
YXRpYyBpbnQgZWJfcmVzZXJ2ZShzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYikKIAkJCQlicmVh
azsKIAkJfQogCQlpZiAoZXJyICE9IC1FTk9TUEMpCi0JCQlicmVhazsKKwkJCXJldHVybiBlcnI7
CiAKIAkJLyogUmVzb3J0ICphbGwqIHRoZSBvYmplY3RzIGludG8gcHJpb3JpdHkgb3JkZXIgKi8K
IAkJSU5JVF9MSVNUX0hFQUQoJmViLT51bmJvdW5kKTsKQEAgLTcwOSwyMCArNjk0LDE1IEBAIHN0
YXRpYyBpbnQgZWJfcmVzZXJ2ZShzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYikKIAkJCWVyciA9
IGk5MTVfZ2VtX2V2aWN0X3ZtKGViLT5jb250ZXh0LT52bSk7CiAJCQltdXRleF91bmxvY2soJmVi
LT5jb250ZXh0LT52bS0+bXV0ZXgpOwogCQkJaWYgKGVycikKLQkJCQlnb3RvIHVubG9jazsKKwkJ
CQlyZXR1cm4gZXJyOwogCQkJYnJlYWs7CiAKIAkJZGVmYXVsdDoKLQkJCWVyciA9IC1FTk9TUEM7
Ci0JCQlnb3RvIHVubG9jazsKKwkJCXJldHVybiAtRU5PU1BDOwogCQl9CiAKIAkJcGluX2ZsYWdz
ID0gUElOX1VTRVI7CiAJfSB3aGlsZSAoMSk7Ci0KLXVubG9jazoKLQltdXRleF91bmxvY2soJmVi
LT5pOTE1LT5kcm0uc3RydWN0X211dGV4KTsKLQlyZXR1cm4gZXJyOwogfQogCiBzdGF0aWMgdW5z
aWduZWQgaW50IGViX2JhdGNoX2luZGV4KGNvbnN0IHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmVi
KQpAQCAtODUxLDcgKzgzMSw2IEBAIHN0YXRpYyBpbnQgZWJfbG9va3VwX3ZtYXMoc3RydWN0IGk5
MTVfZXhlY2J1ZmZlciAqZWIpCiAJaW50IGVyciA9IDA7CiAKIAlJTklUX0xJU1RfSEVBRCgmZWIt
PnJlbG9jcyk7Ci0JSU5JVF9MSVNUX0hFQUQoJmViLT51bmJvdW5kKTsKIAogCWZvciAoaSA9IDA7
IGkgPCBlYi0+YnVmZmVyX2NvdW50OyBpKyspIHsKIAkJc3RydWN0IGk5MTVfdm1hICp2bWE7CkBA
IC04OTQsNiArODczLDQ4IEBAIHN0YXRpYyBpbnQgZWJfbG9va3VwX3ZtYXMoc3RydWN0IGk5MTVf
ZXhlY2J1ZmZlciAqZWIpCiAJcmV0dXJuIGVycjsKIH0KIAorc3RhdGljIGludCBlYl92YWxpZGF0
ZV92bWFzKHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViKQoreworCXVuc2lnbmVkIGludCBpOwor
CWludCBlcnI7CisKKwlJTklUX0xJU1RfSEVBRCgmZWItPnVuYm91bmQpOworCisJZm9yIChpID0g
MDsgaSA8IGViLT5idWZmZXJfY291bnQ7IGkrKykgeworCQlzdHJ1Y3QgZHJtX2k5MTVfZ2VtX2V4
ZWNfb2JqZWN0MiAqZW50cnkgPSAmZWItPmV4ZWNbaV07CisJCXN0cnVjdCBlYl92bWEgKmV2ID0g
JmViLT52bWFbaV07CisJCXN0cnVjdCBpOTE1X3ZtYSAqdm1hID0gZXYtPnZtYTsKKworCQllcnIg
PSBpOTE1X2dlbV9vYmplY3RfbG9jayh2bWEtPm9iaiwgJmViLT53dyk7CisJCWlmIChlcnIpCisJ
CQlyZXR1cm4gZXJyOworCisJCWlmIChlYl9waW5fdm1hKGViLCBlbnRyeSwgZXYpKSB7CisJCQlp
ZiAoZW50cnktPm9mZnNldCAhPSB2bWEtPm5vZGUuc3RhcnQpIHsKKwkJCQllbnRyeS0+b2Zmc2V0
ID0gdm1hLT5ub2RlLnN0YXJ0IHwgVVBEQVRFOworCQkJCWViLT5hcmdzLT5mbGFncyB8PSBfX0VY
RUNfSEFTX1JFTE9DOworCQkJfQorCQl9IGVsc2UgeworCQkJZWJfdW5yZXNlcnZlX3ZtYShldik7
CisKKwkJCWxpc3RfYWRkX3RhaWwoJmV2LT5iaW5kX2xpbmssICZlYi0+dW5ib3VuZCk7CisJCQlp
ZiAoZHJtX21tX25vZGVfYWxsb2NhdGVkKCZ2bWEtPm5vZGUpKSB7CisJCQkJZXJyID0gaTkxNV92
bWFfdW5iaW5kKHZtYSk7CisJCQkJaWYgKGVycikKKwkJCQkJcmV0dXJuIGVycjsKKwkJCX0KKwkJ
fQorCisJCUdFTV9CVUdfT04oZHJtX21tX25vZGVfYWxsb2NhdGVkKCZ2bWEtPm5vZGUpICYmCisJ
CQkgICBlYl92bWFfbWlzcGxhY2VkKCZlYi0+ZXhlY1tpXSwgdm1hLCBldi0+ZmxhZ3MpKTsKKwl9
CisKKwlpZiAoIWxpc3RfZW1wdHkoJmViLT51bmJvdW5kKSkKKwkJcmV0dXJuIGViX3Jlc2VydmUo
ZWIpOworCisJcmV0dXJuIDA7Cit9CisKIHN0YXRpYyBzdHJ1Y3QgZWJfdm1hICoKIGViX2dldF92
bWEoY29uc3Qgc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIsIHVuc2lnbmVkIGxvbmcgaGFuZGxl
KQogewpAQCAtOTE0LDcgKzkzNSw3IEBAIGViX2dldF92bWEoY29uc3Qgc3RydWN0IGk5MTVfZXhl
Y2J1ZmZlciAqZWIsIHVuc2lnbmVkIGxvbmcgaGFuZGxlKQogCX0KIH0KIAotc3RhdGljIHZvaWQg
ZWJfcmVsZWFzZV92bWFzKGNvbnN0IHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViKQorc3RhdGlj
IHZvaWQgZWJfcmVsZWFzZV92bWFzKGNvbnN0IHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViLCBi
b29sIGZpbmFsKQogewogCWNvbnN0IHVuc2lnbmVkIGludCBjb3VudCA9IGViLT5idWZmZXJfY291
bnQ7CiAJdW5zaWduZWQgaW50IGk7CkBAIC05MjYsMTIgKzk0NywxMCBAQCBzdGF0aWMgdm9pZCBl
Yl9yZWxlYXNlX3ZtYXMoY29uc3Qgc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIpCiAJCWlmICgh
dm1hKQogCQkJYnJlYWs7CiAKLQkJZWItPnZtYVtpXS52bWEgPSBOVUxMOwotCi0JCWlmIChldi0+
ZmxhZ3MgJiBfX0VYRUNfT0JKRUNUX0hBU19QSU4pCi0JCQlfX2ViX3VucmVzZXJ2ZV92bWEodm1h
LCBldi0+ZmxhZ3MpOworCQllYl91bnJlc2VydmVfdm1hKGV2KTsKIAotCQlpOTE1X3ZtYV9wdXQo
dm1hKTsKKwkJaWYgKGZpbmFsKQorCQkJaTkxNV92bWFfcHV0KHZtYSk7CiAJfQogfQogCkBAIC05
NTAsNiArOTY5LDE0IEBAIHJlbG9jYXRpb25fdGFyZ2V0KGNvbnN0IHN0cnVjdCBkcm1faTkxNV9n
ZW1fcmVsb2NhdGlvbl9lbnRyeSAqcmVsb2MsCiAJcmV0dXJuIGdlbjhfY2Fub25pY2FsX2FkZHIo
KGludClyZWxvYy0+ZGVsdGEgKyB0YXJnZXQtPm5vZGUuc3RhcnQpOwogfQogCitzdGF0aWMgdm9p
ZCByZWxvY19jYWNoZV9jbGVhcihzdHJ1Y3QgcmVsb2NfY2FjaGUgKmNhY2hlKQoreworCWNhY2hl
LT5ycSA9IE5VTEw7CisJY2FjaGUtPnJxX2NtZCA9IE5VTEw7CisJY2FjaGUtPnBvb2wgPSBOVUxM
OworCWNhY2hlLT5ycV9zaXplID0gMDsKK30KKwogc3RhdGljIHZvaWQgcmVsb2NfY2FjaGVfaW5p
dChzdHJ1Y3QgcmVsb2NfY2FjaGUgKmNhY2hlLAogCQkJICAgICBzdHJ1Y3QgZHJtX2k5MTVfcHJp
dmF0ZSAqaTkxNSkKIHsKQEAgLTk2Miw4ICs5ODksNyBAQCBzdGF0aWMgdm9pZCByZWxvY19jYWNo
ZV9pbml0KHN0cnVjdCByZWxvY19jYWNoZSAqY2FjaGUsCiAJY2FjaGUtPmhhc19mZW5jZSA9IGNh
Y2hlLT5nZW4gPCA0OwogCWNhY2hlLT5uZWVkc191bmZlbmNlZCA9IElOVEVMX0lORk8oaTkxNSkt
PnVuZmVuY2VkX25lZWRzX2FsaWdubWVudDsKIAljYWNoZS0+bm9kZS5mbGFncyA9IDA7Ci0JY2Fj
aGUtPnJxID0gTlVMTDsKLQljYWNoZS0+cnFfc2l6ZSA9IDA7CisJcmVsb2NfY2FjaGVfY2xlYXIo
Y2FjaGUpOwogfQogCiBzdGF0aWMgaW5saW5lIHZvaWQgKnVubWFza19wYWdlKHVuc2lnbmVkIGxv
bmcgcCkKQEAgLTk4NSw3ICsxMDExLDIzIEBAIHN0YXRpYyBpbmxpbmUgc3RydWN0IGk5MTVfZ2d0
dCAqY2FjaGVfdG9fZ2d0dChzdHJ1Y3QgcmVsb2NfY2FjaGUgKmNhY2hlKQogCXJldHVybiAmaTkx
NS0+Z2d0dDsKIH0KIAotc3RhdGljIHZvaWQgcmVsb2NfZ3B1X2ZsdXNoKHN0cnVjdCByZWxvY19j
YWNoZSAqY2FjaGUpCitzdGF0aWMgdm9pZCByZWxvY19jYWNoZV9wdXRfcG9vbChzdHJ1Y3QgaTkx
NV9leGVjYnVmZmVyICplYiwgc3RydWN0IHJlbG9jX2NhY2hlICpjYWNoZSkKK3sKKwlpZiAoIWNh
Y2hlLT5wb29sKQorCQlyZXR1cm47CisKKwkvKgorCSAqIFRoaXMgaXMgYSBiaXQgbmFzdHksIG5v
cm1hbGx5IHdlIGtlZXAgb2JqZWN0cyBsb2NrZWQgdW50aWwgdGhlIGVuZAorCSAqIG9mIGV4ZWNi
dWZmZXIsIGJ1dCB3ZSBhbHJlYWR5IHN1Ym1pdCB0aGlzLCBhbmQgaGF2ZSB0byB1bmxvY2sgYmVm
b3JlCisJICogZHJvcHBpbmcgdGhlIHJlZmVyZW5jZS4gRm9ydHVuYXRlbHkgd2UgY2FuIG9ubHkg
aG9sZCAxIHBvb2wgbm9kZSBhdAorCSAqIGEgdGltZSwgc28gdGhpcyBzaG91bGQgYmUgaGFybWxl
c3MuCisJICovCisJaTkxNV9nZW1fd3dfdW5sb2NrX3NpbmdsZShjYWNoZS0+cG9vbC0+b2JqKTsK
KwlpbnRlbF9ndF9idWZmZXJfcG9vbF9wdXQoY2FjaGUtPnBvb2wpOworCWNhY2hlLT5wb29sID0g
TlVMTDsKK30KKworc3RhdGljIHZvaWQgcmVsb2NfZ3B1X2ZsdXNoKHN0cnVjdCBpOTE1X2V4ZWNi
dWZmZXIgKmViLCBzdHJ1Y3QgcmVsb2NfY2FjaGUgKmNhY2hlKQogewogCXN0cnVjdCBkcm1faTkx
NV9nZW1fb2JqZWN0ICpvYmogPSBjYWNoZS0+cnEtPmJhdGNoLT5vYmo7CiAKQEAgLTk5OCwxNSAr
MTA0MCwxOCBAQCBzdGF0aWMgdm9pZCByZWxvY19ncHVfZmx1c2goc3RydWN0IHJlbG9jX2NhY2hl
ICpjYWNoZSkKIAlpbnRlbF9ndF9jaGlwc2V0X2ZsdXNoKGNhY2hlLT5ycS0+ZW5naW5lLT5ndCk7
CiAKIAlpOTE1X3JlcXVlc3RfYWRkKGNhY2hlLT5ycSk7Ci0JY2FjaGUtPnJxID0gTlVMTDsKKwly
ZWxvY19jYWNoZV9wdXRfcG9vbChlYiwgY2FjaGUpOworCXJlbG9jX2NhY2hlX2NsZWFyKGNhY2hl
KTsKKworCWViLT5yZWxvY19wb29sID0gTlVMTDsKIH0KIAotc3RhdGljIHZvaWQgcmVsb2NfY2Fj
aGVfcmVzZXQoc3RydWN0IHJlbG9jX2NhY2hlICpjYWNoZSkKK3N0YXRpYyB2b2lkIHJlbG9jX2Nh
Y2hlX3Jlc2V0KHN0cnVjdCByZWxvY19jYWNoZSAqY2FjaGUsIHN0cnVjdCBpOTE1X2V4ZWNidWZm
ZXIgKmViKQogewogCXZvaWQgKnZhZGRyOwogCiAJaWYgKGNhY2hlLT5ycSkKLQkJcmVsb2NfZ3B1
X2ZsdXNoKGNhY2hlKTsKKwkJcmVsb2NfZ3B1X2ZsdXNoKGViLCBjYWNoZSk7CiAKIAlpZiAoIWNh
Y2hlLT52YWRkcikKIAkJcmV0dXJuOwpAQCAtMTAyMCw3ICsxMDY1LDYgQEAgc3RhdGljIHZvaWQg
cmVsb2NfY2FjaGVfcmVzZXQoc3RydWN0IHJlbG9jX2NhY2hlICpjYWNoZSkKIAogCQlrdW5tYXBf
YXRvbWljKHZhZGRyKTsKIAkJaTkxNV9nZW1fb2JqZWN0X2ZpbmlzaF9hY2Nlc3Mob2JqKTsKLQkJ
aTkxNV9nZW1fb2JqZWN0X3VubG9jayhvYmopOwogCX0gZWxzZSB7CiAJCXN0cnVjdCBpOTE1X2dn
dHQgKmdndHQgPSBjYWNoZV90b19nZ3R0KGNhY2hlKTsKIApAQCAtMTA1NiwxNiArMTEwMCwxMCBA
QCBzdGF0aWMgdm9pZCAqcmVsb2Nfa21hcChzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2Jq
LAogCQl1bnNpZ25lZCBpbnQgZmx1c2hlczsKIAkJaW50IGVycjsKIAotCQllcnIgPSBpOTE1X2dl
bV9vYmplY3RfbG9ja19pbnRlcnJ1cHRpYmxlKG9iaiwgTlVMTCk7CisJCWVyciA9IGk5MTVfZ2Vt
X29iamVjdF9wcmVwYXJlX3dyaXRlKG9iaiwgJmZsdXNoZXMpOwogCQlpZiAoZXJyKQogCQkJcmV0
dXJuIEVSUl9QVFIoZXJyKTsKIAotCQllcnIgPSBpOTE1X2dlbV9vYmplY3RfcHJlcGFyZV93cml0
ZShvYmosICZmbHVzaGVzKTsKLQkJaWYgKGVycikgewotCQkJaTkxNV9nZW1fb2JqZWN0X3VubG9j
ayhvYmopOwotCQkJcmV0dXJuIEVSUl9QVFIoZXJyKTsKLQkJfQotCiAJCUJVSUxEX0JVR19PTihL
TUFQICYgQ0xGTFVTSF9GTEFHUyk7CiAJCUJVSUxEX0JVR19PTigoS01BUCB8IENMRkxVU0hfRkxB
R1MpICYgUEFHRV9NQVNLKTsKIApAQCAtMTEwNyw5ICsxMTQ1LDcgQEAgc3RhdGljIHZvaWQgKnJl
bG9jX2lvbWFwKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmosCiAJCWlmICh1c2VfY3B1
X3JlbG9jKGNhY2hlLCBvYmopKQogCQkJcmV0dXJuIE5VTEw7CiAKLQkJaTkxNV9nZW1fb2JqZWN0
X2xvY2sob2JqLCBOVUxMKTsKIAkJZXJyID0gaTkxNV9nZW1fb2JqZWN0X3NldF90b19ndHRfZG9t
YWluKG9iaiwgdHJ1ZSk7Ci0JCWk5MTVfZ2VtX29iamVjdF91bmxvY2sob2JqKTsKIAkJaWYgKGVy
cikKIAkJCXJldHVybiBFUlJfUFRSKGVycik7CiAKQEAgLTExOTgsNyArMTIzNCw3IEBAIHN0YXRp
YyBpbnQgcmVsb2NfbW92ZV90b19ncHUoc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEsIHN0cnVjdCBp
OTE1X3ZtYSAqdm1hKQogCXN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmogPSB2bWEtPm9i
ajsKIAlpbnQgZXJyOwogCi0JaTkxNV92bWFfbG9jayh2bWEpOworCWFzc2VydF92bWFfaGVsZCh2
bWEpOwogCiAJaWYgKG9iai0+Y2FjaGVfZGlydHkgJiB+b2JqLT5jYWNoZV9jb2hlcmVudCkKIAkJ
aTkxNV9nZW1fY2xmbHVzaF9vYmplY3Qob2JqLCAwKTsKQEAgLTEyMDgsOCArMTI0NCw2IEBAIHN0
YXRpYyBpbnQgcmVsb2NfbW92ZV90b19ncHUoc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEsIHN0cnVj
dCBpOTE1X3ZtYSAqdm1hKQogCWlmIChlcnIgPT0gMCkKIAkJZXJyID0gaTkxNV92bWFfbW92ZV90
b19hY3RpdmUodm1hLCBycSwgRVhFQ19PQkpFQ1RfV1JJVEUpOwogCi0JaTkxNV92bWFfdW5sb2Nr
KHZtYSk7Ci0KIAlyZXR1cm4gZXJyOwogfQogCkBAIC0xMjE5LDE1ICsxMjUzLDIyIEBAIHN0YXRp
YyBpbnQgX19yZWxvY19ncHVfYWxsb2Moc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIsCiAJCQkg
ICAgIHVuc2lnbmVkIGludCBsZW4pCiB7CiAJc3RydWN0IHJlbG9jX2NhY2hlICpjYWNoZSA9ICZl
Yi0+cmVsb2NfY2FjaGU7Ci0Jc3RydWN0IGludGVsX2d0X2J1ZmZlcl9wb29sX25vZGUgKnBvb2w7
CisJc3RydWN0IGludGVsX2d0X2J1ZmZlcl9wb29sX25vZGUgKnBvb2wgPSBlYi0+cmVsb2NfcG9v
bDsKIAlzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycTsKIAlzdHJ1Y3QgaTkxNV92bWEgKmJhdGNoOwog
CXUzMiAqY21kOwogCWludCBlcnI7CiAKLQlwb29sID0gaW50ZWxfZ3RfZ2V0X2J1ZmZlcl9wb29s
KGVuZ2luZS0+Z3QsIFBBR0VfU0laRSk7Ci0JaWYgKElTX0VSUihwb29sKSkKLQkJcmV0dXJuIFBU
Ul9FUlIocG9vbCk7CisJaWYgKCFwb29sKSB7CisJCXBvb2wgPSBpbnRlbF9ndF9nZXRfYnVmZmVy
X3Bvb2woZW5naW5lLT5ndCwgUEFHRV9TSVpFKTsKKwkJaWYgKElTX0VSUihwb29sKSkKKwkJCXJl
dHVybiBQVFJfRVJSKHBvb2wpOworCX0KKwllYi0+cmVsb2NfcG9vbCA9IE5VTEw7CisKKwllcnIg
PSBpOTE1X2dlbV9vYmplY3RfbG9jayhwb29sLT5vYmosICZlYi0+d3cpOworCWlmIChlcnIpCisJ
CWdvdG8gZXJyX3Bvb2w7CiAKIAljbWQgPSBpOTE1X2dlbV9vYmplY3RfcGluX21hcChwb29sLT5v
YmosCiAJCQkJICAgICAgY2FjaGUtPmhhc19sbGMgPwpAQCAtMTIzNSw3ICsxMjc2LDcgQEAgc3Rh
dGljIGludCBfX3JlbG9jX2dwdV9hbGxvYyhzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYiwKIAkJ
CQkgICAgICBJOTE1X01BUF9GT1JDRV9XQyk7CiAJaWYgKElTX0VSUihjbWQpKSB7CiAJCWVyciA9
IFBUUl9FUlIoY21kKTsKLQkJZ290byBvdXRfcG9vbDsKKwkJZ290byBlcnJfcG9vbDsKIAl9CiAK
IAliYXRjaCA9IGk5MTVfdm1hX2luc3RhbmNlKHBvb2wtPm9iaiwgdm1hLT52bSwgTlVMTCk7CkBA
IC0xMjg0LDExICsxMzI1LDEwIEBAIHN0YXRpYyBpbnQgX19yZWxvY19ncHVfYWxsb2Moc3RydWN0
IGk5MTVfZXhlY2J1ZmZlciAqZWIsCiAJaWYgKGVycikKIAkJZ290byBza2lwX3JlcXVlc3Q7CiAK
LQlpOTE1X3ZtYV9sb2NrKGJhdGNoKTsKKwlhc3NlcnRfdm1hX2hlbGQoYmF0Y2gpOwogCWVyciA9
IGk5MTVfcmVxdWVzdF9hd2FpdF9vYmplY3QocnEsIGJhdGNoLT5vYmosIGZhbHNlKTsKIAlpZiAo
ZXJyID09IDApCiAJCWVyciA9IGk5MTVfdm1hX21vdmVfdG9fYWN0aXZlKGJhdGNoLCBycSwgMCk7
Ci0JaTkxNV92bWFfdW5sb2NrKGJhdGNoKTsKIAlpZiAoZXJyKQogCQlnb3RvIHNraXBfcmVxdWVz
dDsKIApAQCAtMTI5OCw5ICsxMzM4LDEwIEBAIHN0YXRpYyBpbnQgX19yZWxvY19ncHVfYWxsb2Mo
c3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIsCiAJY2FjaGUtPnJxID0gcnE7CiAJY2FjaGUtPnJx
X2NtZCA9IGNtZDsKIAljYWNoZS0+cnFfc2l6ZSA9IDA7CisJY2FjaGUtPnBvb2wgPSBwb29sOwog
CiAJLyogUmV0dXJuIHdpdGggYmF0Y2ggbWFwcGluZyAoY21kKSBzdGlsbCBwaW5uZWQgKi8KLQln
b3RvIG91dF9wb29sOworCXJldHVybiAwOwogCiBza2lwX3JlcXVlc3Q6CiAJaTkxNV9yZXF1ZXN0
X3NldF9lcnJvcl9vbmNlKHJxLCBlcnIpOwpAQCAtMTMxMCw4ICsxMzUxLDggQEAgc3RhdGljIGlu
dCBfX3JlbG9jX2dwdV9hbGxvYyhzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYiwKIAlpOTE1X3Zt
YV91bnBpbihiYXRjaCk7CiBlcnJfdW5tYXA6CiAJaTkxNV9nZW1fb2JqZWN0X3VucGluX21hcChw
b29sLT5vYmopOwotb3V0X3Bvb2w6Ci0JaW50ZWxfZ3RfYnVmZmVyX3Bvb2xfcHV0KHBvb2wpOwor
ZXJyX3Bvb2w6CisJZWItPnJlbG9jX3Bvb2wgPSBwb29sOwogCXJldHVybiBlcnI7CiB9CiAKQEAg
LTEzMjgsNyArMTM2OSw3IEBAIHN0YXRpYyB1MzIgKnJlbG9jX2dwdShzdHJ1Y3QgaTkxNV9leGVj
YnVmZmVyICplYiwKIAl1MzIgKmNtZDsKIAogCWlmIChjYWNoZS0+cnFfc2l6ZSA+IFBBR0VfU0la
RS9zaXplb2YodTMyKSAtIChsZW4gKyAxKSkKLQkJcmVsb2NfZ3B1X2ZsdXNoKGNhY2hlKTsKKwkJ
cmVsb2NfZ3B1X2ZsdXNoKGViLCBjYWNoZSk7CiAKIAlpZiAodW5saWtlbHkoIWNhY2hlLT5ycSkp
IHsKIAkJaW50IGVycjsKQEAgLTEzNzYsNyArMTQxNyw3IEBAIHN0YXRpYyB1bnNpZ25lZCBsb25n
IHZtYV9waHlzX2FkZHIoc3RydWN0IGk5MTVfdm1hICp2bWEsIHUzMiBvZmZzZXQpCiAJcmV0dXJu
IGFkZHIgKyBvZmZzZXRfaW5fcGFnZShvZmZzZXQpOwogfQogCi1zdGF0aWMgYm9vbCBfX3JlbG9j
X2VudHJ5X2dwdShzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYiwKK3N0YXRpYyBpbnQgX19yZWxv
Y19lbnRyeV9ncHUoc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIsCiAJCQkgICAgICBzdHJ1Y3Qg
aTkxNV92bWEgKnZtYSwKIAkJCSAgICAgIHU2NCBvZmZzZXQsCiAJCQkgICAgICB1NjQgdGFyZ2V0
X2FkZHIpCkBAIC0xMzk0LDcgKzE0MzUsOSBAQCBzdGF0aWMgYm9vbCBfX3JlbG9jX2VudHJ5X2dw
dShzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYiwKIAkJbGVuID0gMzsKIAogCWJhdGNoID0gcmVs
b2NfZ3B1KGViLCB2bWEsIGxlbik7Ci0JaWYgKElTX0VSUihiYXRjaCkpCisJaWYgKGJhdGNoID09
IEVSUl9QVFIoLUVERUFETEspKQorCQlyZXR1cm4gKHM2NCktRURFQURMSzsKKwllbHNlIGlmIChJ
U19FUlIoYmF0Y2gpKQogCQlyZXR1cm4gZmFsc2U7CiAKIAlhZGRyID0gZ2VuOF9jYW5vbmljYWxf
YWRkcih2bWEtPm5vZGUuc3RhcnQgKyBvZmZzZXQpOwpAQCAtMTQ0Nyw3ICsxNDkwLDcgQEAgc3Rh
dGljIGJvb2wgX19yZWxvY19lbnRyeV9ncHUoc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIsCiAJ
cmV0dXJuIHRydWU7CiB9CiAKLXN0YXRpYyBib29sIHJlbG9jX2VudHJ5X2dwdShzdHJ1Y3QgaTkx
NV9leGVjYnVmZmVyICplYiwKK3N0YXRpYyBpbnQgcmVsb2NfZW50cnlfZ3B1KHN0cnVjdCBpOTE1
X2V4ZWNidWZmZXIgKmViLAogCQkJICAgIHN0cnVjdCBpOTE1X3ZtYSAqdm1hLAogCQkJICAgIHU2
NCBvZmZzZXQsCiAJCQkgICAgdTY0IHRhcmdldF9hZGRyKQpAQCAtMTQ2OSw4ICsxNTEyLDEyIEBA
IHJlbG9jYXRlX2VudHJ5KHN0cnVjdCBpOTE1X3ZtYSAqdm1hLAogewogCXU2NCB0YXJnZXRfYWRk
ciA9IHJlbG9jYXRpb25fdGFyZ2V0KHJlbG9jLCB0YXJnZXQpOwogCXU2NCBvZmZzZXQgPSByZWxv
Yy0+b2Zmc2V0OworCWludCByZWxvY19ncHUgPSByZWxvY19lbnRyeV9ncHUoZWIsIHZtYSwgb2Zm
c2V0LCB0YXJnZXRfYWRkcik7CisKKwlpZiAocmVsb2NfZ3B1IDwgMCkKKwkJcmV0dXJuIHJlbG9j
X2dwdTsKIAotCWlmICghcmVsb2NfZW50cnlfZ3B1KGViLCB2bWEsIG9mZnNldCwgdGFyZ2V0X2Fk
ZHIpKSB7CisJaWYgKCFyZWxvY19ncHUpIHsKIAkJYm9vbCB3aWRlID0gZWItPnJlbG9jX2NhY2hl
LnVzZV82NGJpdF9yZWxvYzsKIAkJdm9pZCAqdmFkZHI7CiAKQEAgLTE2NzMsNyArMTcyMCw3IEBA
IHN0YXRpYyBpbnQgZWJfcmVsb2NhdGVfdm1hKHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViLCBz
dHJ1Y3QgZWJfdm1hICpldikKIAkJdXJlbG9jcyArPSBBUlJBWV9TSVpFKHN0YWNrKTsKIAl9IHdo
aWxlIChyZW1haW4pOwogb3V0OgotCXJlbG9jX2NhY2hlX3Jlc2V0KCZlYi0+cmVsb2NfY2FjaGUp
OworCXJlbG9jX2NhY2hlX3Jlc2V0KCZlYi0+cmVsb2NfY2FjaGUsIGViKTsKIAlyZXR1cm4gcmVt
YWluOwogfQogCkBAIC0xNjk2LDcgKzE3NDMsNyBAQCBlYl9yZWxvY2F0ZV92bWFfc2xvdyhzdHJ1
Y3QgaTkxNV9leGVjYnVmZmVyICplYiwgc3RydWN0IGViX3ZtYSAqZXYpCiAJfQogCWVyciA9IDA7
CiBlcnI6Ci0JcmVsb2NfY2FjaGVfcmVzZXQoJmViLT5yZWxvY19jYWNoZSk7CisJcmVsb2NfY2Fj
aGVfcmVzZXQoJmViLT5yZWxvY19jYWNoZSwgZWIpOwogCXJldHVybiBlcnI7CiB9CiAKQEAgLTE4
MzYsNiArMTg4MywxMCBAQCBzdGF0aWMgbm9pbmxpbmUgaW50IGViX3JlbG9jYXRlX3BhcnNlX3Ns
b3coc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIpCiAJCWdvdG8gb3V0OwogCX0KIAorCS8qIFdl
IG1heSBwcm9jZXNzIGFub3RoZXIgZXhlY2J1ZmZlciBkdXJpbmcgdGhlIHVubG9jay4uLiAqLwor
CWViX3JlbGVhc2Vfdm1hcyhlYiwgZmFsc2UpOworCWk5MTVfZ2VtX3d3X2N0eF9maW5pKCZlYi0+
d3cpOworCiAJLyoKIAkgKiBXZSB0YWtlIDMgcGFzc2VzIHRocm91Z2ggdGhlIHNsb3dwYXRjaC4K
IAkgKgpAQCAtMTg2MSwxMiArMTkxMiwxNyBAQCBzdGF0aWMgbm9pbmxpbmUgaW50IGViX3JlbG9j
YXRlX3BhcnNlX3Nsb3coc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIpCiAKIAlmbHVzaF93b3Jr
cXVldWUoZWItPmk5MTUtPm1tLnVzZXJwdHJfd3EpOwogCisJaTkxNV9nZW1fd3dfY3R4X2luaXQo
JmViLT53dywgdHJ1ZSk7CiAJaWYgKGVycikKIAkJZ290byBvdXQ7CiAKLQllcnIgPSBtdXRleF9s
b2NrX2ludGVycnVwdGlibGUoJmViLT5pOTE1LT5kcm0uc3RydWN0X211dGV4KTsKKwkvKiByZWFj
cXVpcmUgdGhlIG9iamVjdHMgKi8KK3JlcGVhdF92YWxpZGF0ZToKKwllcnIgPSBlYl92YWxpZGF0
ZV92bWFzKGViKTsKIAlpZiAoZXJyKQotCQlnb3RvIG91dDsKKwkJZ290byBlcnI7CisKKwlHRU1f
QlVHX09OKCFlYi0+YmF0Y2gpOwogCiAJbGlzdF9mb3JfZWFjaF9lbnRyeShldiwgJmViLT5yZWxv
Y3MsIHJlbG9jX2xpbmspIHsKIAkJaWYgKCFoYXZlX2NvcHkpIHsKQEAgLTE4ODIsNyArMTkzOCw5
IEBAIHN0YXRpYyBub2lubGluZSBpbnQgZWJfcmVsb2NhdGVfcGFyc2Vfc2xvdyhzdHJ1Y3QgaTkx
NV9leGVjYnVmZmVyICplYikKIAkJfQogCX0KIAotCW11dGV4X3VubG9jaygmZWItPmk5MTUtPmRy
bS5zdHJ1Y3RfbXV0ZXgpOworCWlmIChlcnIgPT0gLUVERUFETEspCisJCWdvdG8gZXJyOworCiAJ
aWYgKGVyciAmJiAhaGF2ZV9jb3B5KQogCQlnb3RvIHJlcGVhdDsKIApAQCAtMTkwMiw2ICsxOTYw
LDEzIEBAIHN0YXRpYyBub2lubGluZSBpbnQgZWJfcmVsb2NhdGVfcGFyc2Vfc2xvdyhzdHJ1Y3Qg
aTkxNV9leGVjYnVmZmVyICplYikKIAkgKi8KIAogZXJyOgorCWlmIChlcnIgPT0gLUVERUFETEsp
IHsKKwkJZWJfcmVsZWFzZV92bWFzKGViLCBmYWxzZSk7CisJCWVyciA9IGk5MTVfZ2VtX3d3X2N0
eF9iYWNrb2ZmKCZlYi0+d3cpOworCQlpZiAoIWVycikKKwkJCWdvdG8gcmVwZWF0X3ZhbGlkYXRl
OworCX0KKwogCWlmIChlcnIgPT0gLUVBR0FJTikKIAkJZ290byByZXBlYXQ7CiAKQEAgLTE5MzAs
MTUgKzE5OTUsMTIgQEAgc3RhdGljIGludCBlYl9yZWxvY2F0ZV9wYXJzZShzdHJ1Y3QgaTkxNV9l
eGVjYnVmZmVyICplYikKIHsKIAlpbnQgZXJyOwogCi0JZXJyID0gZWJfbG9va3VwX3ZtYXMoZWIp
OwotCWlmIChlcnIpCi0JCXJldHVybiBlcnI7Ci0KLQlpZiAoIWxpc3RfZW1wdHkoJmViLT51bmJv
dW5kKSkgewotCQllcnIgPSBlYl9yZXNlcnZlKGViKTsKLQkJaWYgKGVycikKLQkJCXJldHVybiBl
cnI7Ci0JfQorcmV0cnk6CisJZXJyID0gZWJfdmFsaWRhdGVfdm1hcyhlYik7CisJaWYgKGVyciA9
PSAtRUFHQUlOKQorCQlnb3RvIHNsb3c7CisJZWxzZSBpZiAoZXJyKQorCQlnb3RvIGVycjsKIAog
CS8qIFRoZSBvYmplY3RzIGFyZSBpbiB0aGVpciBmaW5hbCBsb2NhdGlvbnMsIGFwcGx5IHRoZSBy
ZWxvY2F0aW9ucy4gKi8KIAlpZiAoZWItPmFyZ3MtPmZsYWdzICYgX19FWEVDX0hBU19SRUxPQykg
ewpAQCAtMTk1MCw0NSArMjAxMiw0NiBAQCBzdGF0aWMgaW50IGViX3JlbG9jYXRlX3BhcnNlKHN0
cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViKQogCQkJCWJyZWFrOwogCQl9CiAKLQkJaWYgKGVycikK
LQkJCXJldHVybiBlYl9yZWxvY2F0ZV9wYXJzZV9zbG93KGViKTsKKwkJaWYgKGVyciA9PSAtRURF
QURMSykKKwkJCWdvdG8gZXJyOworCQllbHNlIGlmIChlcnIpCisJCQlnb3RvIHNsb3c7CisJfQor
CisJaWYgKCFlcnIpCisJCWVyciA9IGViX3BhcnNlKGViKTsKKworZXJyOgorCWlmIChlcnIgPT0g
LUVERUFETEspIHsKKwkJZWJfcmVsZWFzZV92bWFzKGViLCBmYWxzZSk7CisJCWVyciA9IGk5MTVf
Z2VtX3d3X2N0eF9iYWNrb2ZmKCZlYi0+d3cpOworCQlpZiAoIWVycikKKwkJCWdvdG8gcmV0cnk7
CiAJfQogCi0JcmV0dXJuIGViX3BhcnNlKGViKTsKKwlyZXR1cm4gZXJyOworCitzbG93OgorCWVy
ciA9IGViX3JlbG9jYXRlX3BhcnNlX3Nsb3coZWIpOworCWlmIChlcnIpCisJCS8qCisJCSAqIElm
IHRoZSB1c2VyIGV4cGVjdHMgdGhlIGV4ZWNvYmplY3Qub2Zmc2V0IGFuZAorCQkgKiByZWxvYy5w
cmVzdW1lZF9vZmZzZXQgdG8gYmUgYW4gZXhhY3QgbWF0Y2gsCisJCSAqIGFzIGZvciB1c2luZyBO
T19SRUxPQywgdGhlbiB3ZSBjYW5ub3QgdXBkYXRlCisJCSAqIHRoZSBleGVjb2JqZWN0Lm9mZnNl
dCB1bnRpbCB3ZSBoYXZlIGNvbXBsZXRlZAorCQkgKiByZWxvY2F0aW9uLgorCQkgKi8KKwkJZWIt
PmFyZ3MtPmZsYWdzICY9IH5fX0VYRUNfSEFTX1JFTE9DOworCisJcmV0dXJuIGVycjsKIH0KIAog
c3RhdGljIGludCBlYl9tb3ZlX3RvX2dwdShzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYikKIHsK
IAljb25zdCB1bnNpZ25lZCBpbnQgY291bnQgPSBlYi0+YnVmZmVyX2NvdW50OwotCXN0cnVjdCB3
d19hY3F1aXJlX2N0eCBhY3F1aXJlOwotCXVuc2lnbmVkIGludCBpOworCXVuc2lnbmVkIGludCBp
ID0gY291bnQ7CiAJaW50IGVyciA9IDA7CiAKLQl3d19hY3F1aXJlX2luaXQoJmFjcXVpcmUsICZy
ZXNlcnZhdGlvbl93d19jbGFzcyk7Ci0KLQlmb3IgKGkgPSAwOyBpIDwgY291bnQ7IGkrKykgewot
CQlzdHJ1Y3QgZWJfdm1hICpldiA9ICZlYi0+dm1hW2ldOwotCQlzdHJ1Y3QgaTkxNV92bWEgKnZt
YSA9IGV2LT52bWE7Ci0KLQkJZXJyID0gd3dfbXV0ZXhfbG9ja19pbnRlcnJ1cHRpYmxlKCZ2bWEt
PnJlc3YtPmxvY2ssICZhY3F1aXJlKTsKLQkJaWYgKGVyciA9PSAtRURFQURMSykgewotCQkJR0VN
X0JVR19PTihpID09IDApOwotCQkJZG8gewotCQkJCWludCBqID0gaSAtIDE7Ci0KLQkJCQl3d19t
dXRleF91bmxvY2soJmViLT52bWFbal0udm1hLT5yZXN2LT5sb2NrKTsKLQotCQkJCXN3YXAoZWIt
PnZtYVtpXSwgIGViLT52bWFbal0pOwotCQkJfSB3aGlsZSAoLS1pKTsKLQotCQkJZXJyID0gd3df
bXV0ZXhfbG9ja19zbG93X2ludGVycnVwdGlibGUoJnZtYS0+cmVzdi0+bG9jaywKLQkJCQkJCQkg
ICAgICAgJmFjcXVpcmUpOwotCQl9Ci0JCWlmIChlcnIpCi0JCQlicmVhazsKLQl9Ci0Jd3dfYWNx
dWlyZV9kb25lKCZhY3F1aXJlKTsKLQogCXdoaWxlIChpLS0pIHsKIAkJc3RydWN0IGViX3ZtYSAq
ZXYgPSAmZWItPnZtYVtpXTsKIAkJc3RydWN0IGk5MTVfdm1hICp2bWEgPSBldi0+dm1hOwpAQCAt
MjAzMiwxMCArMjA5NSw3IEBAIHN0YXRpYyBpbnQgZWJfbW92ZV90b19ncHUoc3RydWN0IGk5MTVf
ZXhlY2J1ZmZlciAqZWIpCiAKIAkJaWYgKGVyciA9PSAwKQogCQkJZXJyID0gaTkxNV92bWFfbW92
ZV90b19hY3RpdmUodm1hLCBlYi0+cmVxdWVzdCwgZmxhZ3MpOwotCi0JCWk5MTVfdm1hX3VubG9j
ayh2bWEpOwogCX0KLQl3d19hY3F1aXJlX2ZpbmkoJmFjcXVpcmUpOwogCiAJaWYgKHVubGlrZWx5
KGVycikpCiAJCWdvdG8gZXJyX3NraXA7CkBAIC0yMjI3LDM2ICsyMjg3LDI2IEBAIHN0YXRpYyBp
bnQgZWJfcGFyc2VfcGlwZWxpbmUoc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIsCiAJaWYgKGVy
cikKIAkJZ290byBlcnJfY29tbWl0OwogCi0JZXJyID0gZG1hX3Jlc3ZfbG9ja19pbnRlcnJ1cHRp
YmxlKHB3LT5iYXRjaC0+cmVzdiwgTlVMTCk7Ci0JaWYgKGVycikKLQkJZ290byBlcnJfY29tbWl0
OwotCiAJZXJyID0gZG1hX3Jlc3ZfcmVzZXJ2ZV9zaGFyZWQocHctPmJhdGNoLT5yZXN2LCAxKTsK
IAlpZiAoZXJyKQotCQlnb3RvIGVycl9jb21taXRfdW5sb2NrOworCQlnb3RvIGVycl9jb21taXQ7
CiAKIAkvKiBXYWl0IGZvciBhbGwgd3JpdGVzIChhbmQgcmVsb2NzKSBpbnRvIHRoZSBiYXRjaCB0
byBjb21wbGV0ZSAqLwogCWVyciA9IGk5MTVfc3dfZmVuY2VfYXdhaXRfcmVzZXJ2YXRpb24oJnB3
LT5iYXNlLmNoYWluLAogCQkJCQkgICAgICBwdy0+YmF0Y2gtPnJlc3YsIE5VTEwsIGZhbHNlLAog
CQkJCQkgICAgICAwLCBJOTE1X0ZFTkNFX0dGUCk7CiAJaWYgKGVyciA8IDApCi0JCWdvdG8gZXJy
X2NvbW1pdF91bmxvY2s7CisJCWdvdG8gZXJyX2NvbW1pdDsKIAogCS8qIEtlZXAgdGhlIGJhdGNo
IGFsaXZlIGFuZCB1bndyaXR0ZW4gYXMgd2UgcGFyc2UgKi8KIAlkbWFfcmVzdl9hZGRfc2hhcmVk
X2ZlbmNlKHB3LT5iYXRjaC0+cmVzdiwgJnB3LT5iYXNlLmRtYSk7CiAKLQlkbWFfcmVzdl91bmxv
Y2socHctPmJhdGNoLT5yZXN2KTsKLQogCS8qIEZvcmNlIGV4ZWN1dGlvbiB0byB3YWl0IGZvciBj
b21wbGV0aW9uIG9mIHRoZSBwYXJzZXIgKi8KLQlkbWFfcmVzdl9sb2NrKHNoYWRvdy0+cmVzdiwg
TlVMTCk7CiAJZG1hX3Jlc3ZfYWRkX2V4Y2xfZmVuY2Uoc2hhZG93LT5yZXN2LCAmcHctPmJhc2Uu
ZG1hKTsKLQlkbWFfcmVzdl91bmxvY2soc2hhZG93LT5yZXN2KTsKIAogCWRtYV9mZW5jZV93b3Jr
X2NvbW1pdF9pbW0oJnB3LT5iYXNlKTsKIAlyZXR1cm4gMDsKIAotZXJyX2NvbW1pdF91bmxvY2s6
Ci0JZG1hX3Jlc3ZfdW5sb2NrKHB3LT5iYXRjaC0+cmVzdik7CiBlcnJfY29tbWl0OgogCWk5MTVf
c3dfZmVuY2Vfc2V0X2Vycm9yX29uY2UoJnB3LT5iYXNlLmNoYWluLCBlcnIpOwogCWRtYV9mZW5j
ZV93b3JrX2NvbW1pdF9pbW0oJnB3LT5iYXNlKTsKQEAgLTIyNzQsNyArMjMyNCw3IEBAIHN0YXRp
YyBpbnQgZWJfcGFyc2VfcGlwZWxpbmUoc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIsCiBzdGF0
aWMgaW50IGViX3BhcnNlKHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViKQogewogCXN0cnVjdCBk
cm1faTkxNV9wcml2YXRlICppOTE1ID0gZWItPmk5MTU7Ci0Jc3RydWN0IGludGVsX2d0X2J1ZmZl
cl9wb29sX25vZGUgKnBvb2w7CisJc3RydWN0IGludGVsX2d0X2J1ZmZlcl9wb29sX25vZGUgKnBv
b2wgPSBlYi0+YmF0Y2hfcG9vbDsKIAlzdHJ1Y3QgaTkxNV92bWEgKnNoYWRvdywgKnRyYW1wb2xp
bmU7CiAJdW5zaWduZWQgaW50IGxlbjsKIAlpbnQgZXJyOwpAQCAtMjI5Nyw5ICsyMzQ3LDE2IEBA
IHN0YXRpYyBpbnQgZWJfcGFyc2Uoc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIpCiAJCWxlbiAr
PSBJOTE1X0NNRF9QQVJTRVJfVFJBTVBPTElORV9TSVpFOwogCX0KIAotCXBvb2wgPSBpbnRlbF9n
dF9nZXRfYnVmZmVyX3Bvb2woZWItPmVuZ2luZS0+Z3QsIGxlbik7Ci0JaWYgKElTX0VSUihwb29s
KSkKLQkJcmV0dXJuIFBUUl9FUlIocG9vbCk7CisJaWYgKCFwb29sKSB7CisJCXBvb2wgPSBpbnRl
bF9ndF9nZXRfYnVmZmVyX3Bvb2woZWItPmVuZ2luZS0+Z3QsIGxlbik7CisJCWlmIChJU19FUlIo
cG9vbCkpCisJCQlyZXR1cm4gUFRSX0VSUihwb29sKTsKKwkJZWItPmJhdGNoX3Bvb2wgPSBwb29s
OworCX0KKworCWVyciA9IGk5MTVfZ2VtX29iamVjdF9sb2NrKHBvb2wtPm9iaiwgJmViLT53dyk7
CisJaWYgKGVycikKKwkJZ290byBlcnI7CiAKIAlzaGFkb3cgPSBzaGFkb3dfYmF0Y2hfcGluKHBv
b2wtPm9iaiwgZWItPmNvbnRleHQtPnZtLCBQSU5fVVNFUik7CiAJaWYgKElTX0VSUihzaGFkb3cp
KSB7CkBAIC0yMzQ1LDcgKzI0MDIsNiBAQCBzdGF0aWMgaW50IGViX3BhcnNlKHN0cnVjdCBpOTE1
X2V4ZWNidWZmZXIgKmViKQogZXJyX3NoYWRvdzoKIAlpOTE1X3ZtYV91bnBpbihzaGFkb3cpOwog
ZXJyOgotCWludGVsX2d0X2J1ZmZlcl9wb29sX3B1dChwb29sKTsKIAlyZXR1cm4gZXJyOwogfQog
CkBAIC0zMDAwLDYgKzMwNTYsNyBAQCBpOTE1X2dlbV9kb19leGVjYnVmZmVyKHN0cnVjdCBkcm1f
ZGV2aWNlICpkZXYsCiAJZWIuZXhlYyA9IGV4ZWM7CiAJZWIudm1hID0gKHN0cnVjdCBlYl92bWEg
KikoZXhlYyArIGFyZ3MtPmJ1ZmZlcl9jb3VudCArIDEpOwogCWViLnZtYVswXS52bWEgPSBOVUxM
OworCWViLnJlbG9jX3Bvb2wgPSBlYi5iYXRjaF9wb29sID0gTlVMTDsKIAogCWViLmludmFsaWRf
ZmxhZ3MgPSBfX0VYRUNfT0JKRUNUX1VOS05PV05fRkxBR1M7CiAJcmVsb2NfY2FjaGVfaW5pdCgm
ZWIucmVsb2NfY2FjaGUsIGViLmk5MTUpOwpAQCAtMzA3Miw2ICszMTI5LDE0IEBAIGk5MTVfZ2Vt
X2RvX2V4ZWNidWZmZXIoc3RydWN0IGRybV9kZXZpY2UgKmRldiwKIAlpZiAodW5saWtlbHkoZXJy
KSkKIAkJZ290byBlcnJfY29udGV4dDsKIAorCWVyciA9IGViX2xvb2t1cF92bWFzKCZlYik7CisJ
aWYgKGVycikgeworCQllYl9yZWxlYXNlX3ZtYXMoJmViLCB0cnVlKTsKKwkJZ290byBlcnJfZW5n
aW5lOworCX0KKworCWk5MTVfZ2VtX3d3X2N0eF9pbml0KCZlYi53dywgdHJ1ZSk7CisKIAllcnIg
PSBlYl9yZWxvY2F0ZV9wYXJzZSgmZWIpOwogCWlmIChlcnIpIHsKIAkJLyoKQEAgLTMwODUsNiAr
MzE1MCw4IEBAIGk5MTVfZ2VtX2RvX2V4ZWNidWZmZXIoc3RydWN0IGRybV9kZXZpY2UgKmRldiwK
IAkJZ290byBlcnJfdm1hOwogCX0KIAorCXd3X2FjcXVpcmVfZG9uZSgmZWIud3cuY3R4KTsKKwog
CS8qCiAJICogc25iL2l2Yi92bHYgY29uZmxhdGUgdGhlICJiYXRjaCBpbiBwcGd0dCIgYml0IHdp
dGggdGhlICJub24tc2VjdXJlCiAJICogYmF0Y2giIGJpdC4gSGVuY2Ugd2UgbmVlZCB0byBwaW4g
c2VjdXJlIGJhdGNoZXMgaW50byB0aGUgZ2xvYmFsIGd0dC4KQEAgLTMxMDUsNyArMzE3Miw3IEBA
IGk5MTVfZ2VtX2RvX2V4ZWNidWZmZXIoc3RydWN0IGRybV9kZXZpY2UgKmRldiwKIAkJdm1hID0g
aTkxNV9nZW1fb2JqZWN0X2dndHRfcGluKGViLmJhdGNoLT52bWEtPm9iaiwgTlVMTCwgMCwgMCwg
MCk7CiAJCWlmIChJU19FUlIodm1hKSkgewogCQkJZXJyID0gUFRSX0VSUih2bWEpOwotCQkJZ290
byBlcnJfcGFyc2U7CisJCQlnb3RvIGVycl92bWE7CiAJCX0KIAogCQliYXRjaCA9IHZtYTsKQEAg
LTMxNTcsOCArMzIyNCw4IEBAIGk5MTVfZ2VtX2RvX2V4ZWNidWZmZXIoc3RydWN0IGRybV9kZXZp
Y2UgKmRldiwKIAkgKiB0byBleHBsaWNpdGx5IGhvbGQgYW5vdGhlciByZWZlcmVuY2UgaGVyZS4K
IAkgKi8KIAllYi5yZXF1ZXN0LT5iYXRjaCA9IGJhdGNoOwotCWlmIChiYXRjaC0+cHJpdmF0ZSkK
LQkJaW50ZWxfZ3RfYnVmZmVyX3Bvb2xfbWFya19hY3RpdmUoYmF0Y2gtPnByaXZhdGUsIGViLnJl
cXVlc3QpOworCWlmIChlYi5iYXRjaF9wb29sKQorCQlpbnRlbF9ndF9idWZmZXJfcG9vbF9tYXJr
X2FjdGl2ZShlYi5iYXRjaF9wb29sLCBlYi5yZXF1ZXN0KTsKIAogCXRyYWNlX2k5MTVfcmVxdWVz
dF9xdWV1ZShlYi5yZXF1ZXN0LCBlYi5iYXRjaF9mbGFncyk7CiAJZXJyID0gZWJfc3VibWl0KCZl
YiwgYmF0Y2gpOwpAQCAtMzE4NCwxNCArMzI1MSwxOCBAQCBpOTE1X2dlbV9kb19leGVjYnVmZmVy
KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsCiBlcnJfYmF0Y2hfdW5waW46CiAJaWYgKGViLmJhdGNo
X2ZsYWdzICYgSTkxNV9ESVNQQVRDSF9TRUNVUkUpCiAJCWk5MTVfdm1hX3VucGluKGJhdGNoKTsK
LWVycl9wYXJzZToKLQlpZiAoYmF0Y2gtPnByaXZhdGUpCi0JCWludGVsX2d0X2J1ZmZlcl9wb29s
X3B1dChiYXRjaC0+cHJpdmF0ZSk7CiBlcnJfdm1hOgotCWlmIChlYi5leGVjKQotCQllYl9yZWxl
YXNlX3ZtYXMoJmViKTsKKwllYl9yZWxlYXNlX3ZtYXMoJmViLCB0cnVlKTsKIAlpZiAoZWIudHJh
bXBvbGluZSkKIAkJaTkxNV92bWFfdW5waW4oZWIudHJhbXBvbGluZSk7CisJV0FSTl9PTihlcnIg
PT0gLUVERUFETEspOworCWk5MTVfZ2VtX3d3X2N0eF9maW5pKCZlYi53dyk7CisKKwlpZiAoZWIu
YmF0Y2hfcG9vbCkKKwkJaW50ZWxfZ3RfYnVmZmVyX3Bvb2xfcHV0KGViLmJhdGNoX3Bvb2wpOwor
CWlmIChlYi5yZWxvY19wb29sKQorCQlpbnRlbF9ndF9idWZmZXJfcG9vbF9wdXQoZWIucmVsb2Nf
cG9vbCk7CitlcnJfZW5naW5lOgogCWViX3VucGluX2VuZ2luZSgmZWIpOwogZXJyX2NvbnRleHQ6
CiAJaTkxNV9nZW1fY29udGV4dF9wdXQoZWIuZ2VtX2NvbnRleHQpOwpkaWZmIC0tZ2l0IGEvZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ2VtL3NlbGZ0ZXN0cy9pOTE1X2dlbV9leGVjYnVmZmVyLmMgYi9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vc2VsZnRlc3RzL2k5MTVfZ2VtX2V4ZWNidWZmZXIuYwpp
bmRleCA1ODA4ODRjZmZlYzMuLmJjMDhjMDJiNTc2NyAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvZ2VtL3NlbGZ0ZXN0cy9pOTE1X2dlbV9leGVjYnVmZmVyLmMKKysrIGIvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ2VtL3NlbGZ0ZXN0cy9pOTE1X2dlbV9leGVjYnVmZmVyLmMKQEAgLTMy
LDI1ICszMiwyMyBAQCBzdGF0aWMgaW50IF9faWd0X2dwdV9yZWxvYyhzdHJ1Y3QgaTkxNV9leGVj
YnVmZmVyICplYiwKIAlpZiAoSVNfRVJSKHZtYSkpCiAJCXJldHVybiBQVFJfRVJSKHZtYSk7CiAK
KwllcnIgPSBpOTE1X2dlbV9vYmplY3RfbG9jayhvYmosICZlYi0+d3cpOworCWlmIChlcnIpCisJ
CXJldHVybiBlcnI7CisKIAllcnIgPSBpOTE1X3ZtYV9waW4odm1hLCAwLCAwLCBQSU5fVVNFUiB8
IFBJTl9ISUdIKTsKIAlpZiAoZXJyKQogCQlyZXR1cm4gZXJyOwogCiAJLyogOC1CeXRlIGFsaWdu
ZWQgKi8KLQlpZiAoIV9fcmVsb2NfZW50cnlfZ3B1KGViLCB2bWEsCi0JCQkgICAgICAgb2Zmc2V0
c1swXSAqIHNpemVvZih1MzIpLAotCQkJICAgICAgIDApKSB7Ci0JCWVyciA9IC1FSU87Ci0JCWdv
dG8gdW5waW5fdm1hOwotCX0KKwllcnIgPSBfX3JlbG9jX2VudHJ5X2dwdShlYiwgdm1hLCBvZmZz
ZXRzWzBdICogc2l6ZW9mKHUzMiksIDApOworCWlmIChlcnIgPD0gMCkKKwkJZ290byByZWxvY19l
cnI7CiAKIAkvKiAhOC1CeXRlIGFsaWduZWQgKi8KLQlpZiAoIV9fcmVsb2NfZW50cnlfZ3B1KGVi
LCB2bWEsCi0JCQkgICAgICAgb2Zmc2V0c1sxXSAqIHNpemVvZih1MzIpLAotCQkJICAgICAgIDEp
KSB7Ci0JCWVyciA9IC1FSU87Ci0JCWdvdG8gdW5waW5fdm1hOwotCX0KKwllcnIgPSBfX3JlbG9j
X2VudHJ5X2dwdShlYiwgdm1hLCBvZmZzZXRzWzFdICogc2l6ZW9mKHUzMiksIDEpOworCWlmIChl
cnIgPD0gMCkKKwkJZ290byByZWxvY19lcnI7CiAKIAkvKiBTa2lwIHRvIHRoZSBlbmQgb2YgdGhl
IGNtZCBwYWdlICovCiAJaSA9IFBBR0VfU0laRSAvIHNpemVvZih1MzIpIC0gMTsKQEAgLTYwLDE2
ICs1OCwxMyBAQCBzdGF0aWMgaW50IF9faWd0X2dwdV9yZWxvYyhzdHJ1Y3QgaTkxNV9leGVjYnVm
ZmVyICplYiwKIAllYi0+cmVsb2NfY2FjaGUucnFfc2l6ZSArPSBpOwogCiAJLyogRm9yY2UgbmV4
dCBiYXRjaCAqLwotCWlmICghX19yZWxvY19lbnRyeV9ncHUoZWIsIHZtYSwKLQkJCSAgICAgICBv
ZmZzZXRzWzJdICogc2l6ZW9mKHUzMiksCi0JCQkgICAgICAgMikpIHsKLQkJZXJyID0gLUVJTzsK
LQkJZ290byB1bnBpbl92bWE7Ci0JfQorCWVyciA9IF9fcmVsb2NfZW50cnlfZ3B1KGViLCB2bWEs
IG9mZnNldHNbMl0gKiBzaXplb2YodTMyKSwgMik7CisJaWYgKGVyciA8PSAwKQorCQlnb3RvIHJl
bG9jX2VycjsKIAogCUdFTV9CVUdfT04oIWViLT5yZWxvY19jYWNoZS5ycSk7CiAJcnEgPSBpOTE1
X3JlcXVlc3RfZ2V0KGViLT5yZWxvY19jYWNoZS5ycSk7Ci0JcmVsb2NfZ3B1X2ZsdXNoKCZlYi0+
cmVsb2NfY2FjaGUpOworCXJlbG9jX2dwdV9mbHVzaChlYiwgJmViLT5yZWxvY19jYWNoZSk7CiAJ
R0VNX0JVR19PTihlYi0+cmVsb2NfY2FjaGUucnEpOwogCiAJZXJyID0gaTkxNV9nZW1fb2JqZWN0
X3dhaXQob2JqLCBJOTE1X1dBSVRfSU5URVJSVVBUSUJMRSwgSFogLyAyKTsKQEAgLTEwMSw2ICs5
NiwxMSBAQCBzdGF0aWMgaW50IF9faWd0X2dwdV9yZWxvYyhzdHJ1Y3QgaTkxNV9leGVjYnVmZmVy
ICplYiwKIHVucGluX3ZtYToKIAlpOTE1X3ZtYV91bnBpbih2bWEpOwogCXJldHVybiBlcnI7CisK
K3JlbG9jX2VycjoKKwlpZiAoIWVycikKKwkJZXJyID0gLUVJTzsKKwlnb3RvIHVucGluX3ZtYTsK
IH0KIAogc3RhdGljIGludCBpZ3RfZ3B1X3JlbG9jKHZvaWQgKmFyZykKQEAgLTEyMiw2ICsxMjIs
OCBAQCBzdGF0aWMgaW50IGlndF9ncHVfcmVsb2Modm9pZCAqYXJnKQogCQlnb3RvIGVycl9zY3Jh
dGNoOwogCX0KIAorCWludGVsX2d0X3BtX2dldCgmZWIuaTkxNS0+Z3QpOworCiAJZm9yX2VhY2hf
dWFiaV9lbmdpbmUoZWIuZW5naW5lLCBlYi5pOTE1KSB7CiAJCXJlbG9jX2NhY2hlX2luaXQoJmVi
LnJlbG9jX2NhY2hlLCBlYi5pOTE1KTsKIAkJbWVtc2V0KG1hcCwgUE9JU09OX0lOVVNFLCA0MDk2
KTsKQEAgLTEzMiwxNSArMTM0LDI2IEBAIHN0YXRpYyBpbnQgaWd0X2dwdV9yZWxvYyh2b2lkICph
cmcpCiAJCQllcnIgPSBQVFJfRVJSKGViLmNvbnRleHQpOwogCQkJZ290byBlcnJfcG07CiAJCX0K
KwkJZWIucmVsb2NfcG9vbCA9IE5VTEw7CiAKKwkJaTkxNV9nZW1fd3dfY3R4X2luaXQoJmViLnd3
LCBmYWxzZSk7CityZXRyeToKIAkJZXJyID0gaW50ZWxfY29udGV4dF9waW4oZWIuY29udGV4dCk7
Ci0JCWlmIChlcnIpCi0JCQlnb3RvIGVycl9wdXQ7CisJCWlmICghZXJyKSB7CisJCQllcnIgPSBf
X2lndF9ncHVfcmVsb2MoJmViLCBzY3JhdGNoKTsKKworCQkJaW50ZWxfY29udGV4dF91bnBpbihl
Yi5jb250ZXh0KTsKKwkJfQorCQlpZiAoZXJyID09IC1FREVBRExLKSB7CisJCQllcnIgPSBpOTE1
X2dlbV93d19jdHhfYmFja29mZigmZWIud3cpOworCQkJaWYgKCFlcnIpCisJCQkJZ290byByZXRy
eTsKKwkJfQorCQlpOTE1X2dlbV93d19jdHhfZmluaSgmZWIud3cpOwogCi0JCWVyciA9IF9faWd0
X2dwdV9yZWxvYygmZWIsIHNjcmF0Y2gpOworCQlpZiAoZWIucmVsb2NfcG9vbCkKKwkJCWludGVs
X2d0X2J1ZmZlcl9wb29sX3B1dChlYi5yZWxvY19wb29sKTsKIAotCQlpbnRlbF9jb250ZXh0X3Vu
cGluKGViLmNvbnRleHQpOwotZXJyX3B1dDoKIAkJaW50ZWxfY29udGV4dF9wdXQoZWIuY29udGV4
dCk7CiBlcnJfcG06CiAJCWludGVsX2VuZ2luZV9wbV9wdXQoZWIuZW5naW5lKTsKQEAgLTE1MSw2
ICsxNjQsNyBAQCBzdGF0aWMgaW50IGlndF9ncHVfcmVsb2Modm9pZCAqYXJnKQogCWlmIChpZ3Rf
Zmx1c2hfdGVzdChlYi5pOTE1KSkKIAkJZXJyID0gLUVJTzsKIAorCWludGVsX2d0X3BtX3B1dCgm
ZWIuaTkxNS0+Z3QpOwogZXJyX3NjcmF0Y2g6CiAJaTkxNV9nZW1fb2JqZWN0X3B1dChzY3JhdGNo
KTsKIAlyZXR1cm4gZXJyOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9n
ZW0uYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtLmMKaW5kZXggNTUxNThlNDg3YTdm
Li5mNjYxNWQ5NDJiNjAgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2Vt
LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW0uYwpAQCAtMTM2MCw2ICsxMzYw
LDEyIEBAIHN0YXRpYyB2b2lkIGk5MTVfZ2VtX3d3X2N0eF91bmxvY2tfYWxsKHN0cnVjdCBpOTE1
X2dlbV93d19jdHggKnd3KQogCX0KIH0KIAordm9pZCBpOTE1X2dlbV93d191bmxvY2tfc2luZ2xl
KHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmopCit7CisJbGlzdF9kZWwoJm9iai0+b2Jq
X2xpbmspOworCWk5MTVfZ2VtX29iamVjdF91bmxvY2sob2JqKTsKK30KKwogdm9pZCBpOTE1X2dl
bV93d19jdHhfZmluaShzdHJ1Y3QgaTkxNV9nZW1fd3dfY3R4ICp3dykKIHsKIAlpOTE1X2dlbV93
d19jdHhfdW5sb2NrX2FsbCh3dyk7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9p
OTE1X2dlbS5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW0uaAppbmRleCA0MjdlYmQw
MmZjZWIuLmE0Y2FkM2YxNTRjYSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkx
NV9nZW0uaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbS5oCkBAIC0xMjYsNSAr
MTI2LDYgQEAgc3RydWN0IGk5MTVfZ2VtX3d3X2N0eCB7CiB2b2lkIGk5MTVfZ2VtX3d3X2N0eF9p
bml0KHN0cnVjdCBpOTE1X2dlbV93d19jdHggKmN0eCwgYm9vbCBpbnRyKTsKIHZvaWQgaTkxNV9n
ZW1fd3dfY3R4X2Zpbmkoc3RydWN0IGk5MTVfZ2VtX3d3X2N0eCAqY3R4KTsKIGludCBfX211c3Rf
Y2hlY2sgaTkxNV9nZW1fd3dfY3R4X2JhY2tvZmYoc3RydWN0IGk5MTVfZ2VtX3d3X2N0eCAqY3R4
KTsKK3ZvaWQgaTkxNV9nZW1fd3dfdW5sb2NrX3NpbmdsZShzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29i
amVjdCAqb2JqKTsKIAogI2VuZGlmIC8qIF9fSTkxNV9HRU1fSF9fICovCi0tIAoyLjI4LjAKCl9f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCkludGVsLWdmeCBt
YWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3Rz
LmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWdmeAo=

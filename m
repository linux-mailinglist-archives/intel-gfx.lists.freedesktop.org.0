Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id E02834555D
	for <lists+intel-gfx@lfdr.de>; Fri, 14 Jun 2019 09:11:06 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 9EEA9893C9;
	Fri, 14 Jun 2019 07:10:58 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 0299A89341
 for <intel-gfx@lists.freedesktop.org>; Fri, 14 Jun 2019 07:10:44 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 16897543-1500050 
 for multiple; Fri, 14 Jun 2019 08:10:41 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Fri, 14 Jun 2019 08:10:16 +0100
Message-Id: <20190614071023.17929-33-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190614071023.17929-1-chris@chris-wilson.co.uk>
References: <20190614071023.17929-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 32/39] drm/i915: Allow vma binding to occur
 asynchronously
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SWYgd2UgbGV0IHBhZ2VzIGJlIGFsbG9jYXRlZCBhc3luY2hyb25vdXNseSwgd2UgYWxzbyB0aGVu
IHdhbnQgdG8gcHVzaAp0aGUgYmluZGluZyBwcm9jZXNzIGludG8gYW4gYXN5bmNocm9ub3VzIHRh
c2suIE1ha2UgaXQgc28sIHV0aWxpc2luZyB0aGUKcmVjZW50IGltcHJvdmVtZW50cyB0byBmZW5j
ZSBlcnJvciB0cmFja2luZyBhbmQgc3RydWN0X211dGV4IHJlZHVjdGlvbi4KClNpZ25lZC1vZmYt
Ynk6IENocmlzIFdpbHNvbiA8Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPgotLS0KIC4uLi9ncHUv
ZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2V4ZWNidWZmZXIuYyAgICB8ICAxNCArLQogLi4uL2RybS9p
OTE1L2dlbS9zZWxmdGVzdHMvaTkxNV9nZW1fY29udGV4dC5jIHwgICA0ICsKIGRyaXZlcnMvZ3B1
L2RybS9pOTE1L2k5MTVfZ2VtX2d0dC5jICAgICAgICAgICB8ICAyOCArKystCiBkcml2ZXJzL2dw
dS9kcm0vaTkxNS9pOTE1X3ZtYS5jICAgICAgICAgICAgICAgfCAxNTggKysrKysrKysrKysrKysr
LS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3ZtYS5oICAgICAgICAgICAgICAgfCAgMTQg
KysKIGRyaXZlcnMvZ3B1L2RybS9pOTE1L3NlbGZ0ZXN0cy9pOTE1X3ZtYS5jICAgICB8ICAgNCAr
LQogNiBmaWxlcyBjaGFuZ2VkLCAxODcgaW5zZXJ0aW9ucygrKSwgMzUgZGVsZXRpb25zKC0pCgpk
aWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2V4ZWNidWZmZXIu
YyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9leGVjYnVmZmVyLmMKaW5kZXgg
NDM1NGY0ZTg1ZDQxLi42OTA1ZmQxNDM2MWIgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2dlbS9pOTE1X2dlbV9leGVjYnVmZmVyLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUv
Z2VtL2k5MTVfZ2VtX2V4ZWNidWZmZXIuYwpAQCAtNTgwLDYgKzU4MCwxNSBAQCBzdGF0aWMgaW50
IGViX3Jlc2VydmVfdm1hKGNvbnN0IHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViLAogCXU2NCBw
aW5fZmxhZ3M7CiAJaW50IGVycjsKIAorCS8qCisJICogSWYgd2UgbG9hZCB0aGUgcGFnZXMgYXN5
bmNocm9ub3VzbHksIHRoZW4gdGhlIHVzZXIgKm11c3QqCisJICogb2JleSB0aGUgcmVzZXJ2YXRp
b25fb2JqZWN0IGFuZCBub3QgYnlwYXNzIHdhaXRpbmcgb24gaXQuCisJICogT24gdGhlIHBvc2l0
aXZlIHNpZGUsIGlmIHRoZSB2bWEgaXMgbm90IHlldCBib3VuZCAobm8gcGFnZXMhKSwKKwkgKiB0
aGVuIGl0IHNob3VsZCBub3QgaGF2ZSBhbnkgYW5ub3lpbmcgaW1wbGljaXQgZmVuY2VzLgorCSAq
LworCWlmIChleGVjX2ZsYWdzICYgRVhFQ19PQkpFQ1RfQVNZTkMgJiYgIXZtYS0+cGFnZXMpCisJ
CSp2bWEtPmV4ZWNfZmxhZ3MgJj0gfkVYRUNfT0JKRUNUX0FTWU5DOworCiAJcGluX2ZsYWdzID0g
UElOX1VTRVIgfCBQSU5fTk9OQkxPQ0s7CiAJaWYgKGV4ZWNfZmxhZ3MgJiBFWEVDX09CSkVDVF9O
RUVEU19HVFQpCiAJCXBpbl9mbGFncyB8PSBQSU5fR0xPQkFMOwpAQCAtMTI0Niw4ICsxMjU1LDkg
QEAgc3RhdGljIGludCBfX3JlbG9jX2dwdV9hbGxvYyhzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICpl
YiwKIAkJZ290byBza2lwX3JlcXVlc3Q7CiAKIAlpOTE1X3ZtYV9sb2NrKGJhdGNoKTsKLQlHRU1f
QlVHX09OKCFyZXNlcnZhdGlvbl9vYmplY3RfdGVzdF9zaWduYWxlZF9yY3UoYmF0Y2gtPnJlc3Ys
IHRydWUpKTsKLQllcnIgPSBpOTE1X3ZtYV9tb3ZlX3RvX2FjdGl2ZShiYXRjaCwgcnEsIDApOwor
CWVyciA9IGk5MTVfcmVxdWVzdF9hd2FpdF9vYmplY3QocnEsIGJhdGNoLT5vYmosIGZhbHNlKTsK
KwlpZiAoZXJyID09IDApCisJCWVyciA9IGk5MTVfdm1hX21vdmVfdG9fYWN0aXZlKGJhdGNoLCBy
cSwgMCk7CiAJaTkxNV92bWFfdW5sb2NrKGJhdGNoKTsKIAlpZiAoZXJyKQogCQlnb3RvIHNraXBf
cmVxdWVzdDsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMv
aTkxNV9nZW1fY29udGV4dC5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL3NlbGZ0ZXN0cy9p
OTE1X2dlbV9jb250ZXh0LmMKaW5kZXggYjI4NzBkMmJkNDU4Li42MjQ3ZDI4ODA0NjQgMTAwNjQ0
Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMvaTkxNV9nZW1fY29udGV4
dC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMvaTkxNV9nZW1fY29u
dGV4dC5jCkBAIC0yOTAsNiArMjkwLDEwIEBAIHN0YXRpYyBpbnQgZ3B1X2ZpbGwoc3RydWN0IGRy
bV9pOTE1X2dlbV9vYmplY3QgKm9iaiwKIAkJZ290byBlcnJfYmF0Y2g7CiAJfQogCisJZXJyID0g
aTkxNV9yZXF1ZXN0X2F3YWl0X29iamVjdChycSwgYmF0Y2gtPm9iaiwgZmFsc2UpOworCWlmIChl
cnIpCisJCWdvdG8gZXJyX3JlcXVlc3Q7CisKIAlmbGFncyA9IDA7CiAJaWYgKElOVEVMX0dFTih2
bS0+aTkxNSkgPD0gNSkKIAkJZmxhZ3MgfD0gSTkxNV9ESVNQQVRDSF9TRUNVUkU7CmRpZmYgLS1n
aXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuYyBiL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2k5MTVfZ2VtX2d0dC5jCmluZGV4IDU5ZDIxZmNiZjE4YS4uZmI0ODQ2ODVmZjFiIDEw
MDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuYworKysgYi9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuYwpAQCAtMzAsNiArMzAsNyBAQAogI2luY2x1
ZGUgPGxpbnV4L3JhbmRvbS5oPgogI2luY2x1ZGUgPGxpbnV4L3NlcV9maWxlLmg+CiAjaW5jbHVk
ZSA8bGludXgvc3RvcF9tYWNoaW5lLmg+CisjaW5jbHVkZSA8bGludXgvd29ya3F1ZXVlLmg+CiAK
ICNpbmNsdWRlIDxhc20vc2V0X21lbW9yeS5oPgogCkBAIC0xMzksMTQgKzE0MCwxNCBAQCBzdGF0
aWMgaW5saW5lIHZvaWQgaTkxNV9nZ3R0X2ludmFsaWRhdGUoc3RydWN0IGRybV9pOTE1X3ByaXZh
dGUgKmk5MTUpCiAKIHN0YXRpYyBpbnQgcHBndHRfYmluZF92bWEoc3RydWN0IGk5MTVfdm1hICp2
bWEsCiAJCQkgIGVudW0gaTkxNV9jYWNoZV9sZXZlbCBjYWNoZV9sZXZlbCwKLQkJCSAgdTMyIHVu
dXNlZCkKKwkJCSAgdTMyIGZsYWdzKQogeworCXN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZt
ID0gdm1hLT52bTsKIAl1MzIgcHRlX2ZsYWdzOwogCWludCBlcnI7CiAKLQlpZiAoISh2bWEtPmZs
YWdzICYgSTkxNV9WTUFfTE9DQUxfQklORCkpIHsKLQkJZXJyID0gdm1hLT52bS0+YWxsb2NhdGVf
dmFfcmFuZ2Uodm1hLT52bSwKLQkJCQkJCSB2bWEtPm5vZGUuc3RhcnQsIHZtYS0+c2l6ZSk7CisJ
aWYgKGZsYWdzICYgSTkxNV9WTUFfQUxMT0NfQklORCkgeworCQllcnIgPSB2bS0+YWxsb2NhdGVf
dmFfcmFuZ2Uodm0sIHZtYS0+bm9kZS5zdGFydCwgdm1hLT5zaXplKTsKIAkJaWYgKGVycikKIAkJ
CXJldHVybiBlcnI7CiAJfQpAQCAtMTU2LDIwICsxNTcsMjYgQEAgc3RhdGljIGludCBwcGd0dF9i
aW5kX3ZtYShzdHJ1Y3QgaTkxNV92bWEgKnZtYSwKIAlpZiAoaTkxNV9nZW1fb2JqZWN0X2lzX3Jl
YWRvbmx5KHZtYS0+b2JqKSkKIAkJcHRlX2ZsYWdzIHw9IFBURV9SRUFEX09OTFk7CiAKLQl2bWEt
PnZtLT5pbnNlcnRfZW50cmllcyh2bWEtPnZtLCB2bWEsIGNhY2hlX2xldmVsLCBwdGVfZmxhZ3Mp
OworCXZtLT5pbnNlcnRfZW50cmllcyh2bSwgdm1hLCBjYWNoZV9sZXZlbCwgcHRlX2ZsYWdzKTsK
IAogCXJldHVybiAwOwogfQogCiBzdGF0aWMgdm9pZCBwcGd0dF91bmJpbmRfdm1hKHN0cnVjdCBp
OTE1X3ZtYSAqdm1hKQogewotCXZtYS0+dm0tPmNsZWFyX3JhbmdlKHZtYS0+dm0sIHZtYS0+bm9k
ZS5zdGFydCwgdm1hLT5zaXplKTsKKwlzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSA9IHZt
YS0+dm07CisKKwl2bS0+Y2xlYXJfcmFuZ2Uodm0sIHZtYS0+bm9kZS5zdGFydCwgdm1hLT5zaXpl
KTsKIH0KIAogc3RhdGljIGludCBwcGd0dF9zZXRfcGFnZXMoc3RydWN0IGk5MTVfdm1hICp2bWEp
CiB7CiAJR0VNX0JVR19PTih2bWEtPnBhZ2VzKTsKIAorCXdhaXRfZm9yX2NvbXBsZXRpb24oJnZt
YS0+b2JqLT5tbS5jb21wbGV0aW9uKTsKKwlpZiAoSVNfRVJSKHZtYS0+b2JqLT5tbS5wYWdlcykp
CisJCXJldHVybiBQVFJfRVJSKHZtYS0+b2JqLT5tbS5wYWdlcyk7CisKIAl2bWEtPnBhZ2VzID0g
dm1hLT5vYmotPm1tLnBhZ2VzOwogCiAJdm1hLT5wYWdlX3NpemVzID0gdm1hLT5vYmotPm1tLnBh
Z2Vfc2l6ZXM7CkBAIC0yNjI5LDcgKzI2MzYsNyBAQCBzdGF0aWMgaW50IGFsaWFzaW5nX2d0dF9i
aW5kX3ZtYShzdHJ1Y3QgaTkxNV92bWEgKnZtYSwKIAlpZiAoZmxhZ3MgJiBJOTE1X1ZNQV9MT0NB
TF9CSU5EKSB7CiAJCXN0cnVjdCBpOTE1X3BwZ3R0ICphcHBndHQgPSBpOTE1LT5tbS5hbGlhc2lu
Z19wcGd0dDsKIAotCQlpZiAoISh2bWEtPmZsYWdzICYgSTkxNV9WTUFfTE9DQUxfQklORCkpIHsK
KwkJaWYgKGZsYWdzICYgSTkxNV9WTUFfQUxMT0NfQklORCkgewogCQkJcmV0ID0gYXBwZ3R0LT52
bS5hbGxvY2F0ZV92YV9yYW5nZSgmYXBwZ3R0LT52bSwKIAkJCQkJCQkgICB2bWEtPm5vZGUuc3Rh
cnQsCiAJCQkJCQkJICAgdm1hLT5zaXplKTsKQEAgLTM4NDcsMTMgKzM4NTQsMTggQEAgaTkxNV9n
ZXRfZ2d0dF92bWFfcGFnZXMoc3RydWN0IGk5MTVfdm1hICp2bWEpCiB7CiAJaW50IHJldDsKIAot
CS8qIFRoZSB2bWEtPnBhZ2VzIGFyZSBvbmx5IHZhbGlkIHdpdGhpbiB0aGUgbGlmZXNwYW4gb2Yg
dGhlIGJvcnJvd2VkCisJLyoKKwkgKiBUaGUgdm1hLT5wYWdlcyBhcmUgb25seSB2YWxpZCB3aXRo
aW4gdGhlIGxpZmVzcGFuIG9mIHRoZSBib3Jyb3dlZAogCSAqIG9iai0+bW0ucGFnZXMuIFdoZW4g
dGhlIG9iai0+bW0ucGFnZXMgc2dfdGFibGUgaXMgcmVnZW5lcmF0ZWQsIHNvCiAJICogbXVzdCBi
ZSB0aGUgdm1hLT5wYWdlcy4gQSBzaW1wbGUgcnVsZSBpcyB0aGF0IHZtYS0+cGFnZXMgbXVzdCBv
bmx5CiAJICogYmUgYWNjZXNzZWQgd2hlbiB0aGUgb2JqLT5tbS5wYWdlcyBhcmUgcGlubmVkLgog
CSAqLwogCUdFTV9CVUdfT04oIWk5MTVfZ2VtX29iamVjdF9oYXNfcGlubmVkX3BhZ2VzKHZtYS0+
b2JqKSk7CiAKKwl3YWl0X2Zvcl9jb21wbGV0aW9uKCZ2bWEtPm9iai0+bW0uY29tcGxldGlvbik7
CisJaWYgKElTX0VSUih2bWEtPm9iai0+bW0ucGFnZXMpKQorCQlyZXR1cm4gUFRSX0VSUih2bWEt
Pm9iai0+bW0ucGFnZXMpOworCiAJc3dpdGNoICh2bWEtPmdndHRfdmlldy50eXBlKSB7CiAJZGVm
YXVsdDoKIAkJR0VNX0JVR19PTih2bWEtPmdndHRfdmlldy50eXBlKTsKZGlmZiAtLWdpdCBhL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfdm1hLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1
X3ZtYS5jCmluZGV4IGI4MGQ5ZTAwNzI5My4uMzNjNjQ2MGVhZThhIDEwMDY0NAotLS0gYS9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3ZtYS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5
MTVfdm1hLmMKQEAgLTkzLDYgKzkzLDcwIEBAIHN0YXRpYyB2b2lkIF9faTkxNV92bWFfcmV0aXJl
KHN0cnVjdCBpOTE1X2FjdGl2ZSAqcmVmKQogCWk5MTVfdm1hX3B1dChhY3RpdmVfdG9fdm1hKHJl
ZikpOwogfQogCitzdGF0aWMgaW50IF9fdm1hX2JpbmQoc3RydWN0IGk5MTVfdm1hICp2bWEsCisJ
CSAgICAgIHVuc2lnbmVkIGludCBjYWNoZV9sZXZlbCwKKwkJICAgICAgdW5zaWduZWQgaW50IGZs
YWdzKQoreworCWludCBlcnI7CisKKwlpZiAoIXZtYS0+cGFnZXMpIHsKKwkJZXJyID0gdm1hLT5v
cHMtPnNldF9wYWdlcyh2bWEpOworCQlpZiAoZXJyKQorCQkJcmV0dXJuIGVycjsKKwl9CisKKwly
ZXR1cm4gdm1hLT5vcHMtPmJpbmRfdm1hKHZtYSwgY2FjaGVfbGV2ZWwsIGZsYWdzKTsKK30KKwor
c3RhdGljIHZvaWQgZG9fYXN5bmNfYmluZChzdHJ1Y3Qgd29ya19zdHJ1Y3QgKndvcmspCit7CisJ
c3RydWN0IGk5MTVfdm1hICp2bWEgPSBjb250YWluZXJfb2Yod29yaywgdHlwZW9mKCp2bWEpLCBh
c3luYy53b3JrKTsKKwlzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSA9IHZtYS0+dm07CisJ
aW50IGVycjsKKworCWlmICh2bWEtPmFzeW5jLmRtYS0+ZXJyb3IpCisJCWdvdG8gb3V0OworCisJ
ZXJyID0gX192bWFfYmluZCh2bWEsIHZtYS0+YXN5bmMuY2FjaGVfbGV2ZWwsIHZtYS0+YXN5bmMu
ZmxhZ3MpOworCWlmIChlcnIpCisJCWRtYV9mZW5jZV9zZXRfZXJyb3Iodm1hLT5hc3luYy5kbWEs
IGVycik7CisKK291dDoKKwlkbWFfZmVuY2Vfc2lnbmFsKHZtYS0+YXN5bmMuZG1hKTsKKworCWk5
MTVfdm1hX3VucGluKHZtYSk7CisJaTkxNV92bWFfcHV0KHZtYSk7CisJaTkxNV92bV9wdXQodm0p
OworfQorCitzdGF0aWMgdm9pZCBfX3F1ZXVlX2FzeW5jX2JpbmQoc3RydWN0IGRtYV9mZW5jZSAq
Ziwgc3RydWN0IGRtYV9mZW5jZV9jYiAqY2IpCit7CisJc3RydWN0IGk5MTVfdm1hICp2bWEgPSBj
b250YWluZXJfb2YoY2IsIHR5cGVvZigqdm1hKSwgYXN5bmMuY2IpOworCisJaWYgKGYtPmVycm9y
KQorCQlkbWFfZmVuY2Vfc2V0X2Vycm9yKHZtYS0+YXN5bmMuZG1hLCBmLT5lcnJvcik7CisKKwlJ
TklUX1dPUksoJnZtYS0+YXN5bmMud29yaywgZG9fYXN5bmNfYmluZCk7CisJcXVldWVfd29yayhz
eXN0ZW1fdW5ib3VuZF93cSwgJnZtYS0+YXN5bmMud29yayk7Cit9CisKK3N0YXRpYyBjb25zdCBj
aGFyICphc3luY19iaW5kX2RyaXZlcl9uYW1lKHN0cnVjdCBkbWFfZmVuY2UgKmZlbmNlKQorewor
CXJldHVybiBEUklWRVJfTkFNRTsKK30KKworc3RhdGljIGNvbnN0IGNoYXIgKmFzeW5jX2JpbmRf
dGltZWxpbmVfbmFtZShzdHJ1Y3QgZG1hX2ZlbmNlICpmZW5jZSkKK3sKKwlyZXR1cm4gImJpbmQi
OworfQorCitzdGF0aWMgY29uc3Qgc3RydWN0IGRtYV9mZW5jZV9vcHMgYXN5bmNfYmluZF9vcHMg
PSB7CisJLmdldF9kcml2ZXJfbmFtZSA9IGFzeW5jX2JpbmRfZHJpdmVyX25hbWUsCisJLmdldF90
aW1lbGluZV9uYW1lID0gYXN5bmNfYmluZF90aW1lbGluZV9uYW1lLAorfTsKKworc3RhdGljIERF
RklORV9TUElOTE9DSyhhc3luY19sb2NrKTsKKwogc3RhdGljIHN0cnVjdCBpOTE1X3ZtYSAqCiB2
bWFfY3JlYXRlKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmosCiAJICAgc3RydWN0IGk5
MTVfYWRkcmVzc19zcGFjZSAqdm0sCkBAIC0yODMsNiArMzQ3LDU0IEBAIGk5MTVfdm1hX2luc3Rh
bmNlKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmosCiAJcmV0dXJuIHZtYTsKIH0KIAor
c3RhdGljIGludCBxdWV1ZV9hc3luY19iaW5kKHN0cnVjdCBpOTE1X3ZtYSAqdm1hLAorCQkJICAg
IGVudW0gaTkxNV9jYWNoZV9sZXZlbCBjYWNoZV9sZXZlbCwKKwkJCSAgICB1MzIgZmxhZ3MpCit7
CisJYm9vbCByZWFkeSA9IHRydWU7CisKKwkvKiBXZSBhcmUgbm90IGFsbG93ZWQgdG8gc2hyaW5r
IGluc2lkZSB2bS0+bXV0ZXghICovCisJdm1hLT5hc3luYy5kbWEgPSBrbWFsbG9jKHNpemVvZigq
dm1hLT5hc3luYy5kbWEpLAorCQkJCSBHRlBfTk9XQUlUIHwgX19HRlBfTk9XQVJOKTsKKwlpZiAo
IXZtYS0+YXN5bmMuZG1hKQorCQlyZXR1cm4gLUVOT01FTTsKKworCWRtYV9mZW5jZV9pbml0KHZt
YS0+YXN5bmMuZG1hLAorCQkgICAgICAgJmFzeW5jX2JpbmRfb3BzLAorCQkgICAgICAgJmFzeW5j
X2xvY2ssCisJCSAgICAgICB2bWEtPnZtLT5pOTE1LT5tbS51bm9yZGVyZWRfdGltZWxpbmUsCisJ
CSAgICAgICAwKTsKKworCS8qIFhYWCBmaW5kIGFuZCBhdm9pZCBhbGxvY2F0aW9ucyB1bmRlciBy
ZXNlcnZhdGlvbl9vYmplY3QgbG9ja3MgKi8KKwlpZiAoIWk5MTVfdm1hX3RyeWxvY2sodm1hKSkg
eworCQlrZnJlZShmZXRjaF9hbmRfemVybygmdm1hLT5hc3luYy5kbWEpKTsKKwkJcmV0dXJuIC1F
QUdBSU47CisJfQorCisJaTkxNV92bV9nZXQodm1hLT52bSk7CisJaTkxNV92bWFfZ2V0KHZtYSk7
CisJX19pOTE1X3ZtYV9waW4odm1hKTsgLyogYXZvaWQgYmVpbmcgc2hydW5rICovCisKKwl2bWEt
PmFzeW5jLmNhY2hlX2xldmVsID0gY2FjaGVfbGV2ZWw7CisJdm1hLT5hc3luYy5mbGFncyA9IGZs
YWdzOworCisJaWYgKHJjdV9hY2Nlc3NfcG9pbnRlcih2bWEtPnJlc3YtPmZlbmNlX2V4Y2wpKSB7
IC8qIGFzeW5jIHBhZ2VzICovCisJCXN0cnVjdCBkbWFfZmVuY2UgKmYgPSByZXNlcnZhdGlvbl9v
YmplY3RfZ2V0X2V4Y2wodm1hLT5yZXN2KTsKKworCQlpZiAoIWRtYV9mZW5jZV9hZGRfY2FsbGJh
Y2soZiwKKwkJCQkJICAgICZ2bWEtPmFzeW5jLmNiLAorCQkJCQkgICAgX19xdWV1ZV9hc3luY19i
aW5kKSkKKwkJCXJlYWR5ID0gZmFsc2U7CisJfQorCXJlc2VydmF0aW9uX29iamVjdF9hZGRfZXhj
bF9mZW5jZSh2bWEtPnJlc3YsIHZtYS0+YXN5bmMuZG1hKTsKKwlpOTE1X3ZtYV91bmxvY2sodm1h
KTsKKworCWlmIChyZWFkeSkKKwkJX19xdWV1ZV9hc3luY19iaW5kKHZtYS0+YXN5bmMuZG1hLCAm
dm1hLT5hc3luYy5jYik7CisKKwlyZXR1cm4gMDsKK30KKwogLyoqCiAgKiBpOTE1X3ZtYV9iaW5k
IC0gU2V0cyB1cCBQVEVzIGZvciBhbiBWTUEgaW4gaXQncyBjb3JyZXNwb25kaW5nIGFkZHJlc3Mg
c3BhY2UuCiAgKiBAdm1hOiBWTUEgdG8gbWFwCkBAIC0zMDAsMTcgKzQxMiwxMiBAQCBpbnQgaTkx
NV92bWFfYmluZChzdHJ1Y3QgaTkxNV92bWEgKnZtYSwgZW51bSBpOTE1X2NhY2hlX2xldmVsIGNh
Y2hlX2xldmVsLAogCXUzMiB2bWFfZmxhZ3M7CiAJaW50IHJldDsKIAorCUdFTV9CVUdfT04oIWZs
YWdzKTsKIAlHRU1fQlVHX09OKCFkcm1fbW1fbm9kZV9hbGxvY2F0ZWQoJnZtYS0+bm9kZSkpOwog
CUdFTV9CVUdfT04odm1hLT5zaXplID4gdm1hLT5ub2RlLnNpemUpOwotCi0JaWYgKEdFTV9ERUJV
R19XQVJOX09OKHJhbmdlX292ZXJmbG93cyh2bWEtPm5vZGUuc3RhcnQsCi0JCQkJCSAgICAgIHZt
YS0+bm9kZS5zaXplLAotCQkJCQkgICAgICB2bWEtPnZtLT50b3RhbCkpKQotCQlyZXR1cm4gLUVO
T0RFVjsKLQotCWlmIChHRU1fREVCVUdfV0FSTl9PTighZmxhZ3MpKQotCQlyZXR1cm4gLUVJTlZB
TDsKLQorCUdFTV9CVUdfT04ocmFuZ2Vfb3ZlcmZsb3dzKHZtYS0+bm9kZS5zdGFydCwKKwkJCQkg
ICB2bWEtPm5vZGUuc2l6ZSwKKwkJCQkgICB2bWEtPnZtLT50b3RhbCkpOwogCWJpbmRfZmxhZ3Mg
PSAwOwogCWlmIChmbGFncyAmIFBJTl9HTE9CQUwpCiAJCWJpbmRfZmxhZ3MgfD0gSTkxNV9WTUFf
R0xPQkFMX0JJTkQ7CkBAIC0zMjUsMTYgKzQzMiwyMCBAQCBpbnQgaTkxNV92bWFfYmluZChzdHJ1
Y3QgaTkxNV92bWEgKnZtYSwgZW51bSBpOTE1X2NhY2hlX2xldmVsIGNhY2hlX2xldmVsLAogCWlm
IChiaW5kX2ZsYWdzID09IDApCiAJCXJldHVybiAwOwogCi0JR0VNX0JVR19PTighdm1hLT5wYWdl
cyk7CisJaWYgKChiaW5kX2ZsYWdzICYgfnZtYV9mbGFncykgJiBJOTE1X1ZNQV9MT0NBTF9CSU5E
KQorCQliaW5kX2ZsYWdzIHw9IEk5MTVfVk1BX0FMTE9DX0JJTkQ7CiAKIAl0cmFjZV9pOTE1X3Zt
YV9iaW5kKHZtYSwgYmluZF9mbGFncyk7Ci0JcmV0ID0gdm1hLT5vcHMtPmJpbmRfdm1hKHZtYSwg
Y2FjaGVfbGV2ZWwsIGJpbmRfZmxhZ3MpOworCWlmIChiaW5kX2ZsYWdzICYgSTkxNV9WTUFfQUxM
T0NfQklORCkKKwkJcmV0ID0gcXVldWVfYXN5bmNfYmluZCh2bWEsIGNhY2hlX2xldmVsLCBiaW5k
X2ZsYWdzKTsKKwllbHNlCisJCXJldCA9IF9fdm1hX2JpbmQodm1hLCBjYWNoZV9sZXZlbCwgYmlu
ZF9mbGFncyk7CiAJaWYgKHJldCkKIAkJcmV0dXJuIHJldDsKIAogCWlmICghdm1hX2ZsYWdzKQog
CQlpOTE1X3ZtYV9nZXQodm1hKTsKLQl2bWEtPmZsYWdzIHw9IGJpbmRfZmxhZ3M7CisJdm1hLT5m
bGFncyB8PSBiaW5kX2ZsYWdzICYgfkk5MTVfVk1BX0FMTE9DX0JJTkQ7CiAKIAlyZXR1cm4gMDsK
IH0KQEAgLTU3Myw3ICs2ODQsNyBAQCBpOTE1X3ZtYV9pbnNlcnQoc3RydWN0IGk5MTVfdm1hICp2
bWEsIHU2NCBzaXplLCB1NjQgYWxpZ25tZW50LCB1NjQgZmxhZ3MpCiAJfQogCiAJaWYgKHZtYS0+
b2JqKSB7Ci0JCXJldCA9IGk5MTVfZ2VtX29iamVjdF9waW5fcGFnZXModm1hLT5vYmopOworCQly
ZXQgPSBpOTE1X2dlbV9vYmplY3RfcGluX3BhZ2VzX2FzeW5jKHZtYS0+b2JqKTsKIAkJaWYgKHJl
dCkKIAkJCXJldHVybiByZXQ7CiAKQEAgLTU4MiwyNSArNjkzLDE5IEBAIGk5MTVfdm1hX2luc2Vy
dChzdHJ1Y3QgaTkxNV92bWEgKnZtYSwgdTY0IHNpemUsIHU2NCBhbGlnbm1lbnQsIHU2NCBmbGFn
cykKIAkJY2FjaGVfbGV2ZWwgPSAwOwogCX0KIAotCUdFTV9CVUdfT04odm1hLT5wYWdlcyk7Ci0K
LQlyZXQgPSB2bWEtPm9wcy0+c2V0X3BhZ2VzKHZtYSk7Ci0JaWYgKHJldCkKLQkJZ290byBlcnJf
dW5waW47Ci0KIAlpZiAoZmxhZ3MgJiBQSU5fT0ZGU0VUX0ZJWEVEKSB7CiAJCXU2NCBvZmZzZXQg
PSBmbGFncyAmIFBJTl9PRkZTRVRfTUFTSzsKIAkJaWYgKCFJU19BTElHTkVEKG9mZnNldCwgYWxp
Z25tZW50KSB8fAogCQkgICAgcmFuZ2Vfb3ZlcmZsb3dzKG9mZnNldCwgc2l6ZSwgZW5kKSkgewog
CQkJcmV0ID0gLUVJTlZBTDsKLQkJCWdvdG8gZXJyX2NsZWFyOworCQkJZ290byBlcnJfdW5waW47
CiAJCX0KIAogCQlyZXQgPSBpOTE1X2dlbV9ndHRfcmVzZXJ2ZSh2bWEtPnZtLCAmdm1hLT5ub2Rl
LAogCQkJCQkgICBzaXplLCBvZmZzZXQsIGNhY2hlX2xldmVsLAogCQkJCQkgICBmbGFncyk7CiAJ
CWlmIChyZXQpCi0JCQlnb3RvIGVycl9jbGVhcjsKKwkJCWdvdG8gZXJyX3VucGluOwogCX0gZWxz
ZSB7CiAJCS8qCiAJCSAqIFdlIG9ubHkgc3VwcG9ydCBodWdlIGd0dCBwYWdlcyB0aHJvdWdoIHRo
ZSA0OGIgUFBHVFQsCkBAIC02MzksNyArNzQ0LDcgQEAgaTkxNV92bWFfaW5zZXJ0KHN0cnVjdCBp
OTE1X3ZtYSAqdm1hLCB1NjQgc2l6ZSwgdTY0IGFsaWdubWVudCwgdTY0IGZsYWdzKQogCQkJCQkg
IHNpemUsIGFsaWdubWVudCwgY2FjaGVfbGV2ZWwsCiAJCQkJCSAgc3RhcnQsIGVuZCwgZmxhZ3Mp
OwogCQlpZiAocmV0KQotCQkJZ290byBlcnJfY2xlYXI7CisJCQlnb3RvIGVycl91bnBpbjsKIAog
CQlHRU1fQlVHX09OKHZtYS0+bm9kZS5zdGFydCA8IHN0YXJ0KTsKIAkJR0VNX0JVR19PTih2bWEt
Pm5vZGUuc3RhcnQgKyB2bWEtPm5vZGUuc2l6ZSA+IGVuZCk7CkBAIC02NTgsOCArNzYzLDYgQEAg
aTkxNV92bWFfaW5zZXJ0KHN0cnVjdCBpOTE1X3ZtYSAqdm1hLCB1NjQgc2l6ZSwgdTY0IGFsaWdu
bWVudCwgdTY0IGZsYWdzKQogCiAJcmV0dXJuIDA7CiAKLWVycl9jbGVhcjoKLQl2bWEtPm9wcy0+
Y2xlYXJfcGFnZXModm1hKTsKIGVycl91bnBpbjoKIAlpZiAodm1hLT5vYmopCiAJCWk5MTVfZ2Vt
X29iamVjdF91bnBpbl9wYWdlcyh2bWEtPm9iaik7CkBAIC05MzMsNiArMTAzNiwxMSBAQCBpbnQg
aTkxNV92bWFfdW5iaW5kKHN0cnVjdCBpOTE1X3ZtYSAqdm1hKQogCiAJbG9ja2RlcF9hc3NlcnRf
aGVsZCgmdm1hLT52bS0+aTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CiAKKwlpZiAodm1hLT5hc3lu
Yy5kbWEgJiYKKwkgICAgZG1hX2ZlbmNlX3dhaXRfdGltZW91dCh2bWEtPmFzeW5jLmRtYSwgdHJ1
ZSwKKwkJCQkgICBNQVhfU0NIRURVTEVfVElNRU9VVCkgPCAwKQorCQlyZXR1cm4gLUVJTlRSOwor
CiAJcmV0ID0gaTkxNV9hY3RpdmVfd2FpdCgmdm1hLT5hY3RpdmUpOwogCWlmIChyZXQpCiAJCXJl
dHVybiByZXQ7CkBAIC05NzYsNiArMTA4NCw4IEBAIGludCBpOTE1X3ZtYV91bmJpbmQoc3RydWN0
IGk5MTVfdm1hICp2bWEpCiAJfQogCXZtYS0+ZmxhZ3MgJj0gfihJOTE1X1ZNQV9HTE9CQUxfQklO
RCB8IEk5MTVfVk1BX0xPQ0FMX0JJTkQpOwogCisJZG1hX2ZlbmNlX3B1dChmZXRjaF9hbmRfemVy
bygmdm1hLT5hc3luYy5kbWEpKTsKKwogCWk5MTVfdm1hX3JlbW92ZSh2bWEpOwogCWk5MTVfdm1h
X3B1dCh2bWEpOwogCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3ZtYS5o
IGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV92bWEuaAppbmRleCAyN2E1OTkzOTY2YTQuLmU1
NGVkMGIzODBhMyAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV92bWEuaAor
KysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3ZtYS5oCkBAIC0xMDMsNiArMTAzLDcgQEAg
c3RydWN0IGk5MTVfdm1hIHsKICNkZWZpbmUgSTkxNV9WTUFfR0xPQkFMX0JJTkQJQklUKDkpCiAj
ZGVmaW5lIEk5MTVfVk1BX0xPQ0FMX0JJTkQJQklUKDEwKQogI2RlZmluZSBJOTE1X1ZNQV9CSU5E
X01BU0sgKEk5MTVfVk1BX0dMT0JBTF9CSU5EIHwgSTkxNV9WTUFfTE9DQUxfQklORCB8IEk5MTVf
Vk1BX1BJTl9PVkVSRkxPVykKKyNkZWZpbmUgSTkxNV9WTUFfQUxMT0NfQklORAlJOTE1X1ZNQV9Q
SU5fT1ZFUkZMT1cgLyogbm90IHN0b3JlZCAqLwogCiAjZGVmaW5lIEk5MTVfVk1BX0dHVFQJCUJJ
VCgxMSkKICNkZWZpbmUgSTkxNV9WTUFfQ0FOX0ZFTkNFCUJJVCgxMikKQEAgLTE0Myw2ICsxNDQs
MTQgQEAgc3RydWN0IGk5MTVfdm1hIHsKIAl1bnNpZ25lZCBpbnQgKmV4ZWNfZmxhZ3M7CiAJc3Ry
dWN0IGhsaXN0X25vZGUgZXhlY19ub2RlOwogCXUzMiBleGVjX2hhbmRsZTsKKworCXN0cnVjdCBp
OTE1X3ZtYV9hc3luY19iaW5kIHsKKwkJc3RydWN0IGRtYV9mZW5jZSAqZG1hOworCQlzdHJ1Y3Qg
ZG1hX2ZlbmNlX2NiIGNiOworCQlzdHJ1Y3Qgd29ya19zdHJ1Y3Qgd29yazsKKwkJdW5zaWduZWQg
aW50IGNhY2hlX2xldmVsOworCQl1bnNpZ25lZCBpbnQgZmxhZ3M7CisJfSBhc3luYzsKIH07CiAK
IHN0cnVjdCBpOTE1X3ZtYSAqCkBAIC0zMDksNiArMzE4LDExIEBAIHN0YXRpYyBpbmxpbmUgdm9p
ZCBpOTE1X3ZtYV9sb2NrKHN0cnVjdCBpOTE1X3ZtYSAqdm1hKQogCXJlc2VydmF0aW9uX29iamVj
dF9sb2NrKHZtYS0+cmVzdiwgTlVMTCk7CiB9CiAKK3N0YXRpYyBpbmxpbmUgYm9vbCBpOTE1X3Zt
YV90cnlsb2NrKHN0cnVjdCBpOTE1X3ZtYSAqdm1hKQoreworCXJldHVybiByZXNlcnZhdGlvbl9v
YmplY3RfdHJ5bG9jayh2bWEtPnJlc3YpOworfQorCiBzdGF0aWMgaW5saW5lIHZvaWQgaTkxNV92
bWFfdW5sb2NrKHN0cnVjdCBpOTE1X3ZtYSAqdm1hKQogewogCXJlc2VydmF0aW9uX29iamVjdF91
bmxvY2sodm1hLT5yZXN2KTsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L3NlbGZ0
ZXN0cy9pOTE1X3ZtYS5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvc2VsZnRlc3RzL2k5MTVfdm1h
LmMKaW5kZXggNTZjMWNhYzM2OGNjLi4zMGI4MzE0MDhiN2IgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L3NlbGZ0ZXN0cy9pOTE1X3ZtYS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L3NlbGZ0ZXN0cy9pOTE1X3ZtYS5jCkBAIC0yMDQsOCArMjA0LDEwIEBAIHN0YXRpYyBpbnQg
aWd0X3ZtYV9jcmVhdGUodm9pZCAqYXJnKQogCQltb2NrX2NvbnRleHRfY2xvc2UoY3R4KTsKIAl9
CiAKLQlsaXN0X2Zvcl9lYWNoX2VudHJ5X3NhZmUob2JqLCBvbiwgJm9iamVjdHMsIHN0X2xpbmsp
CisJbGlzdF9mb3JfZWFjaF9lbnRyeV9zYWZlKG9iaiwgb24sICZvYmplY3RzLCBzdF9saW5rKSB7
CisJCWk5MTVfZ2VtX29iamVjdF93YWl0KG9iaiwgSTkxNV9XQUlUX0FMTCwgTUFYX1NDSEVEVUxF
X1RJTUVPVVQpOwogCQlpOTE1X2dlbV9vYmplY3RfcHV0KG9iaik7CisJfQogCXJldHVybiBlcnI7
CiB9CiAKLS0gCjIuMjAuMQoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0
b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50
ZWwtZ2Z4

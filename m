Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 9404F7E670
	for <lists+intel-gfx@lfdr.de>; Fri,  2 Aug 2019 01:36:25 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 3CB1E6E83B;
	Thu,  1 Aug 2019 23:36:23 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 504136E83B
 for <intel-gfx@lists.freedesktop.org>; Thu,  1 Aug 2019 23:36:21 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17801463-1500050 
 for <intel-gfx@lists.freedesktop.org>; Fri, 02 Aug 2019 00:36:17 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Fri,  2 Aug 2019 00:36:16 +0100
Message-Id: <20190801233616.23007-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0.rc0
MIME-Version: 1.0
Subject: [Intel-gfx] [CI] drm/i915/pmu: Atomically acquire the gt_pm wakeref
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

Q3VycmVudGx5LCB3ZSBvbmx5IHNhbXBsZSBpZiB0aGUgaW50ZWxfZ3QgaXMgYXdha2UsIGJ1dCB3
ZSBhY3F1aXJlIG91cgpvd24gcnVudGltZV9wbSB3YWtlcmVmLiBTaW5jZSBpbnRlbF9ndCBoYXMg
dHJhbnNpdGlvbmVkIHRvIHRyYWNraW5nIGl0cwpvd24gd2FrZXJlZiwgd2UgY2FuIGF0b21pY2Fs
bHkgdGVzdCBhbmQgYWNxdWlyZSB0aGF0IHdha2VyZWYgaW5zdGVhZC4KCnYyOiBUYWtlIGVuZ2lu
ZS0+d2FrZXJlZiBmb3IgZW5naW5lIHNhbXBsaW5nCgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxz
b24gPGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KQ2M6IFR2cnRrbyBVcnN1bGluIDx0dnJ0a28u
dXJzdWxpbkBpbnRlbC5jb20+ClJldmlld2VkLWJ5OiBUdnJ0a28gVXJzdWxpbiA8dHZydGtvLnVy
c3VsaW5AaW50ZWwuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2d0X3Bt
LmggfCAgOCArKysrKy0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcG11LmMgICAgICAgfCA0
MCArKysrKysrKysrKystLS0tLS0tLS0tLS0tLS0KIDIgZmlsZXMgY2hhbmdlZCwgMjQgaW5zZXJ0
aW9ucygrKSwgMjQgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ3QvaW50ZWxfZ3RfcG0uaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2d0X3Bt
LmgKaW5kZXggNTI3ODk0ZmUxMzQ1Li5lOGExOGQ0YjI3YzkgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2d0L2ludGVsX2d0X3BtLmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUv
Z3QvaW50ZWxfZ3RfcG0uaApAQCAtOSw3ICs5LDggQEAKIAogI2luY2x1ZGUgPGxpbnV4L3R5cGVz
Lmg+CiAKLXN0cnVjdCBpbnRlbF9ndDsKKyNpbmNsdWRlICJpbnRlbF9ndF90eXBlcy5oIgorI2lu
Y2x1ZGUgImludGVsX3dha2VyZWYuaCIKIAogZW51bSB7CiAJSU5URUxfR1RfVU5QQVJLLApAQCAt
MTksNiArMjAsMTEgQEAgZW51bSB7CiB2b2lkIGludGVsX2d0X3BtX2dldChzdHJ1Y3QgaW50ZWxf
Z3QgKmd0KTsKIHZvaWQgaW50ZWxfZ3RfcG1fcHV0KHN0cnVjdCBpbnRlbF9ndCAqZ3QpOwogCitz
dGF0aWMgaW5saW5lIGJvb2wgaW50ZWxfZ3RfcG1fZ2V0X2lmX2F3YWtlKHN0cnVjdCBpbnRlbF9n
dCAqZ3QpCit7CisJcmV0dXJuIGludGVsX3dha2VyZWZfZ2V0X2lmX2FjdGl2ZSgmZ3QtPndha2Vy
ZWYpOworfQorCiB2b2lkIGludGVsX2d0X3BtX2luaXRfZWFybHkoc3RydWN0IGludGVsX2d0ICpn
dCk7CiAKIHZvaWQgaW50ZWxfZ3Rfc2FuaXRpemUoc3RydWN0IGludGVsX2d0ICpndCwgYm9vbCBm
b3JjZSk7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3BtdS5jIGIvZHJp
dmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wbXUuYwppbmRleCBlMGUwMTgwYmNhN2MuLmMyZTVmNmQ1
YzFlMCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wbXUuYworKysgYi9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3BtdS5jCkBAIC04LDYgKzgsOCBAQAogI2luY2x1ZGUg
PGxpbnV4L3BtX3J1bnRpbWUuaD4KIAogI2luY2x1ZGUgImd0L2ludGVsX2VuZ2luZS5oIgorI2lu
Y2x1ZGUgImd0L2ludGVsX2VuZ2luZV9wbS5oIgorI2luY2x1ZGUgImd0L2ludGVsX2d0X3BtLmgi
CiAKICNpbmNsdWRlICJpOTE1X2Rydi5oIgogI2luY2x1ZGUgImk5MTVfcG11LmgiCkBAIC0xNjUs
MzAgKzE2NywyNiBAQCBzdGF0aWMgdm9pZAogZW5naW5lc19zYW1wbGUoc3RydWN0IGludGVsX2d0
ICpndCwgdW5zaWduZWQgaW50IHBlcmlvZF9ucykKIHsKIAlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0
ZSAqaTkxNSA9IGd0LT5pOTE1OwotCXN0cnVjdCBpbnRlbF91bmNvcmUgKnVuY29yZSA9IGd0LT51
bmNvcmU7CiAJc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lOwogCWVudW0gaW50ZWxfZW5n
aW5lX2lkIGlkOwotCWludGVsX3dha2VyZWZfdCB3YWtlcmVmOwotCXVuc2lnbmVkIGxvbmcgZmxh
Z3M7CiAKIAlpZiAoKGk5MTUtPnBtdS5lbmFibGUgJiBFTkdJTkVfU0FNUExFX01BU0spID09IDAp
CiAJCXJldHVybjsKIAotCXdha2VyZWYgPSAwOwotCWlmIChSRUFEX09OQ0UoZ3QtPmF3YWtlKSkK
LQkJd2FrZXJlZiA9IGludGVsX3J1bnRpbWVfcG1fZ2V0X2lmX2luX3VzZSgmaTkxNS0+cnVudGlt
ZV9wbSk7Ci0JaWYgKCF3YWtlcmVmKQotCQlyZXR1cm47Ci0KLQlzcGluX2xvY2tfaXJxc2F2ZSgm
dW5jb3JlLT5sb2NrLCBmbGFncyk7CiAJZm9yX2VhY2hfZW5naW5lKGVuZ2luZSwgaTkxNSwgaWQp
IHsKIAkJc3RydWN0IGludGVsX2VuZ2luZV9wbXUgKnBtdSA9ICZlbmdpbmUtPnBtdTsKKwkJdW5z
aWduZWQgbG9uZyBmbGFnczsKIAkJYm9vbCBidXN5OwogCQl1MzIgdmFsOwogCisJCWlmICghaW50
ZWxfZW5naW5lX3BtX2dldF9pZl9hd2FrZShlbmdpbmUpKQorCQkJY29udGludWU7CisKKwkJc3Bp
bl9sb2NrX2lycXNhdmUoJmVuZ2luZS0+dW5jb3JlLT5sb2NrLCBmbGFncyk7CisKIAkJdmFsID0g
RU5HSU5FX1JFQURfRlcoZW5naW5lLCBSSU5HX0NUTCk7CiAJCWlmICh2YWwgPT0gMCkgLyogcG93
ZXJ3ZWxsIG9mZiA9PiBlbmdpbmUgaWRsZSAqLwotCQkJY29udGludWU7CisJCQlnb3RvIHNraXA7
CiAKIAkJaWYgKHZhbCAmIFJJTkdfV0FJVCkKIAkJCWFkZF9zYW1wbGUoJnBtdS0+c2FtcGxlW0k5
MTVfU0FNUExFX1dBSVRdLCBwZXJpb2RfbnMpOwpAQCAtMjA5LDEwICsyMDcsMTEgQEAgZW5naW5l
c19zYW1wbGUoc3RydWN0IGludGVsX2d0ICpndCwgdW5zaWduZWQgaW50IHBlcmlvZF9ucykKIAkJ
fQogCQlpZiAoYnVzeSkKIAkJCWFkZF9zYW1wbGUoJnBtdS0+c2FtcGxlW0k5MTVfU0FNUExFX0JV
U1ldLCBwZXJpb2RfbnMpOwotCX0KLQlzcGluX3VubG9ja19pcnFyZXN0b3JlKCZ1bmNvcmUtPmxv
Y2ssIGZsYWdzKTsKIAotCWludGVsX3J1bnRpbWVfcG1fcHV0KCZpOTE1LT5ydW50aW1lX3BtLCB3
YWtlcmVmKTsKK3NraXA6CisJCXNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJmVuZ2luZS0+dW5jb3Jl
LT5sb2NrLCBmbGFncyk7CisJCWludGVsX2VuZ2luZV9wbV9wdXQoZW5naW5lKTsKKwl9CiB9CiAK
IHN0YXRpYyB2b2lkCkBAIC0yMzIsMTUgKzIzMSwxMCBAQCBmcmVxdWVuY3lfc2FtcGxlKHN0cnVj
dCBpbnRlbF9ndCAqZ3QsIHVuc2lnbmVkIGludCBwZXJpb2RfbnMpCiAJCXUzMiB2YWw7CiAKIAkJ
dmFsID0gaTkxNS0+Z3RfcG0ucnBzLmN1cl9mcmVxOwotCQlpZiAoZ3QtPmF3YWtlKSB7Ci0JCQlp
bnRlbF93YWtlcmVmX3Qgd2FrZXJlZjsKLQotCQkJd2l0aF9pbnRlbF9ydW50aW1lX3BtX2lmX2lu
X3VzZSgmaTkxNS0+cnVudGltZV9wbSwKLQkJCQkJCQl3YWtlcmVmKSB7Ci0JCQkJdmFsID0gaW50
ZWxfdW5jb3JlX3JlYWRfbm90cmFjZSh1bmNvcmUsCi0JCQkJCQkJCUdFTjZfUlBTVEFUMSk7Ci0J
CQkJdmFsID0gaW50ZWxfZ2V0X2NhZ2YoaTkxNSwgdmFsKTsKLQkJCX0KKwkJaWYgKGludGVsX2d0
X3BtX2dldF9pZl9hd2FrZShndCkpIHsKKwkJCXZhbCA9IGludGVsX3VuY29yZV9yZWFkX25vdHJh
Y2UodW5jb3JlLCBHRU42X1JQU1RBVDEpOworCQkJdmFsID0gaW50ZWxfZ2V0X2NhZ2YoaTkxNSwg
dmFsKTsKKwkJCWludGVsX2d0X3BtX3B1dChndCk7CiAJCX0KIAogCQlhZGRfc2FtcGxlX211bHQo
JnBtdS0+c2FtcGxlW19fSTkxNV9TQU1QTEVfRlJFUV9BQ1RdLAotLSAKMi4yMy4wLnJjMAoKX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1h
aWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMu
ZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id F129950123
	for <lists+intel-gfx@lfdr.de>; Mon, 24 Jun 2019 07:43:42 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 13AEC89911;
	Mon, 24 Jun 2019 05:43:38 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id A5862898F5
 for <intel-gfx@lists.freedesktop.org>; Mon, 24 Jun 2019 05:43:35 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17000412-1500050 
 for multiple; Mon, 24 Jun 2019 06:43:21 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 24 Jun 2019 06:43:05 +0100
Message-Id: <20190624054315.18910-9-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190624054315.18910-1-chris@chris-wilson.co.uk>
References: <20190624054315.18910-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 09/19] drm/i915: Only recover active engines
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SWYgd2UgaXNzdWUgYSByZXNldCB0byBhIGN1cnJlbnRseSBpZGxlIGVuZ2luZSwgbGVhdmUgaXQg
aWRsZQphZnRlcndhcmRzLiBUaGlzIGlzIHVzZWZ1bCB0byBleGNpc2UgYSBsaW5rYWdlIGJldHdl
ZW4gcmVzZXQgYW5kIHRoZQpzaHJpbmtlci4gV2hlbiB3YWtpbmcgdGhlIGVuZ2luZSwgd2UgbmVl
ZCB0byBwaW4gdGhlIGRlZmF1bHQgY29udGV4dAppbWFnZSB3aGljaCB3ZSB1c2UgZm9yIG92ZXJ3
cml0aW5nIGEgZ3VpbHR5IGNvbnRleHQgLS0gaWYgdGhlIGVuZ2luZSBpcwppZGxlIHdlIGRvIG5v
dCBuZWVkIHRoaXMgcGlubmVkIGltYWdlISBIb3dldmVyLCB0aGlzIHBpbm5pbmcgbWVhbnMgdGhh
dAp3YWtpbmcgdGhlIGVuZ2luZSBhY3F1aXJlcyB0aGUgRlNfUkVDTEFJTSwgYW5kIHNvIG1heSB0
cmlnZ2VyIHRoZQpzaHJpbmtlci4gVGhlIHNocmlua2VyIGl0c2VsZiBtYXkgbmVlZCB0byB3YWl0
IHVwb24gdGhlIEdQVSB0byB1bmJpbmQKYW5kIG9iamVjdCBhbmQgc28gbWF5IHJlcXVpcmUgc2Vy
dmljZXMgb2YgcmVzZXQ7IGVyZ28gd2Ugc2hvdWxkIGF2b2lkCnRoZSBlbmdpbmUgd2FrZSB1cCBw
YXRoLgoKVGhlIGRhbmdlciBpbiBza2lwcGluZyB0aGUgcmVjb3ZlcnkgZm9yIGlkbGUgZW5naW5l
cyBpcyB0aGF0IHdlIGxlYXZlIHRoZQplbmdpbmUgd2l0aCBubyBjb250ZXh0IGRlZmluZWQsIHdo
aWNoIG1heSBpbnRlcmZlcmUgd2l0aCB0aGUgb3BlcmF0aW9uIG9mCnRoZSBwb3dlciBjb250ZXh0
IG9uIHNvbWUgb2xkZXIgcGxhdGZvcm1zLiBJbiBwcmFjdGljZSwgd2Ugc2hvdWxkIG9ubHkKYmUg
cmVzZXR0aW5nIGFuIGFjdGl2ZSBHUFUgYnV0IGl0IHNvbWV0aGluZyB0byBsb29rIG91dCBmb3Ig
b24gSXJvbmxha2UKKGlmIG1lbW9yeSBzZXJ2ZXMpLgoKU2lnbmVkLW9mZi1ieTogQ2hyaXMgV2ls
c29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28udWs+Ci0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUv
Z3QvaW50ZWxfcmVzZXQuYyAgICB8IDM3ICsrKysrKysrKysrKysrLS0tLS0tLS0tLQogZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ3Qvc2VsZnRlc3RfcmVzZXQuYyB8ICA2ICsrLS0KIDIgZmlsZXMgY2hh
bmdlZCwgMjYgaW5zZXJ0aW9ucygrKSwgMTcgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfcmVzZXQuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2d0L2ludGVsX3Jlc2V0LmMKaW5kZXggOGNlOTJjNTE1NjRlLi5lN2NiZDljZjg1YzEgMTAwNjQ0
Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX3Jlc2V0LmMKKysrIGIvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfcmVzZXQuYwpAQCAtNjc4LDcgKzY3OCw2IEBAIHN0YXRp
YyB2b2lkIHJlc2V0X3ByZXBhcmVfZW5naW5lKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2lu
ZSkKIAkgKiB3cml0dGVuIHRvIHRoZSBwb3dlcmNvbnRleHQgaXMgdW5kZWZpbmVkIGFuZCBzbyB3
ZSBtYXkgbG9zZQogCSAqIEdQVSBzdGF0ZSB1cG9uIHJlc3VtZSwgaS5lLiBmYWlsIHRvIHJlc3Rh
cnQgYWZ0ZXIgYSByZXNldC4KIAkgKi8KLQlpbnRlbF9lbmdpbmVfcG1fZ2V0KGVuZ2luZSk7CiAJ
aW50ZWxfdW5jb3JlX2ZvcmNld2FrZV9nZXQoZW5naW5lLT51bmNvcmUsIEZPUkNFV0FLRV9BTEwp
OwogCWVuZ2luZS0+cmVzZXQucHJlcGFyZShlbmdpbmUpOwogfQpAQCAtNzA5LDE2ICs3MDgsMjEg
QEAgc3RhdGljIHZvaWQgcmV2b2tlX21tYXBzKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1
KQogCX0KIH0KIAotc3RhdGljIHZvaWQgcmVzZXRfcHJlcGFyZShzdHJ1Y3QgZHJtX2k5MTVfcHJp
dmF0ZSAqaTkxNSkKK3N0YXRpYyBpbnRlbF9lbmdpbmVfbWFza190IHJlc2V0X3ByZXBhcmUoc3Ry
dWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCiB7CiAJc3RydWN0IGludGVsX2VuZ2luZV9jcyAq
ZW5naW5lOworCWludGVsX2VuZ2luZV9tYXNrX3QgYXdha2UgPSAwOwogCWVudW0gaW50ZWxfZW5n
aW5lX2lkIGlkOwogCi0JaW50ZWxfZ3RfcG1fZ2V0KCZpOTE1LT5ndCk7Ci0JZm9yX2VhY2hfZW5n
aW5lKGVuZ2luZSwgaTkxNSwgaWQpCisJZm9yX2VhY2hfZW5naW5lKGVuZ2luZSwgaTkxNSwgaWQp
IHsKKwkJaWYgKGludGVsX2VuZ2luZV9wbV9nZXRfaWZfYXdha2UoZW5naW5lKSkKKwkJCWF3YWtl
IHw9IGVuZ2luZS0+bWFzazsKIAkJcmVzZXRfcHJlcGFyZV9lbmdpbmUoZW5naW5lKTsKKwl9CiAK
IAlpbnRlbF91Y19yZXNldF9wcmVwYXJlKGk5MTUpOworCisJcmV0dXJuIGF3YWtlOwogfQogCiBz
dGF0aWMgdm9pZCBndF9yZXZva2Uoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCkBAIC03
NTIsMjAgKzc1NiwyMiBAQCBzdGF0aWMgaW50IGd0X3Jlc2V0KHN0cnVjdCBkcm1faTkxNV9wcml2
YXRlICppOTE1LAogc3RhdGljIHZvaWQgcmVzZXRfZmluaXNoX2VuZ2luZShzdHJ1Y3QgaW50ZWxf
ZW5naW5lX2NzICplbmdpbmUpCiB7CiAJZW5naW5lLT5yZXNldC5maW5pc2goZW5naW5lKTsKLQlp
bnRlbF9lbmdpbmVfcG1fcHV0KGVuZ2luZSk7CiAJaW50ZWxfdW5jb3JlX2ZvcmNld2FrZV9wdXQo
ZW5naW5lLT51bmNvcmUsIEZPUkNFV0FLRV9BTEwpOworCisJaW50ZWxfZW5naW5lX3NpZ25hbF9i
cmVhZGNydW1icyhlbmdpbmUpOwogfQogCi1zdGF0aWMgdm9pZCByZXNldF9maW5pc2goc3RydWN0
IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCitzdGF0aWMgdm9pZCByZXNldF9maW5pc2goc3RydWN0
IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUsCisJCQkgaW50ZWxfZW5naW5lX21hc2tfdCBhd2FrZSkK
IHsKIAlzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmU7CiAJZW51bSBpbnRlbF9lbmdpbmVf
aWQgaWQ7CiAKIAlmb3JfZWFjaF9lbmdpbmUoZW5naW5lLCBpOTE1LCBpZCkgewogCQlyZXNldF9m
aW5pc2hfZW5naW5lKGVuZ2luZSk7Ci0JCWludGVsX2VuZ2luZV9zaWduYWxfYnJlYWRjcnVtYnMo
ZW5naW5lKTsKKwkJaWYgKGF3YWtlICYgZW5naW5lLT5tYXNrKQorCQkJaW50ZWxfZW5naW5lX3Bt
X3B1dChlbmdpbmUpOwogCX0KLQlpbnRlbF9ndF9wbV9wdXQoJmk5MTUtPmd0KTsKIH0KIAogc3Rh
dGljIHZvaWQgbm9wX3N1Ym1pdF9yZXF1ZXN0KHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJlcXVlc3Qp
CkBAIC03ODksNiArNzk1LDcgQEAgc3RhdGljIHZvaWQgX19pOTE1X2dlbV9zZXRfd2VkZ2VkKHN0
cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQogewogCXN0cnVjdCBpOTE1X2dwdV9lcnJvciAq
ZXJyb3IgPSAmaTkxNS0+Z3B1X2Vycm9yOwogCXN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2lu
ZTsKKwlpbnRlbF9lbmdpbmVfbWFza190IGF3YWtlOwogCWVudW0gaW50ZWxfZW5naW5lX2lkIGlk
OwogCiAJaWYgKHRlc3RfYml0KEk5MTVfV0VER0VELCAmZXJyb3ItPmZsYWdzKSkKQEAgLTgwOCw3
ICs4MTUsNyBAQCBzdGF0aWMgdm9pZCBfX2k5MTVfZ2VtX3NldF93ZWRnZWQoc3RydWN0IGRybV9p
OTE1X3ByaXZhdGUgKmk5MTUpCiAJICogcm9sbGluZyB0aGUgZ2xvYmFsIHNlcW5vIGZvcndhcmQg
KHNpbmNlIHRoaXMgd291bGQgY29tcGxldGUgcmVxdWVzdHMKIAkgKiBmb3Igd2hpY2ggd2UgaGF2
ZW4ndCBzZXQgdGhlIGZlbmNlIGVycm9yIHRvIEVJTyB5ZXQpLgogCSAqLwotCXJlc2V0X3ByZXBh
cmUoaTkxNSk7CisJYXdha2UgPSByZXNldF9wcmVwYXJlKGk5MTUpOwogCiAJLyogRXZlbiBpZiB0
aGUgR1BVIHJlc2V0IGZhaWxzLCBpdCBzaG91bGQgc3RpbGwgc3RvcCB0aGUgZW5naW5lcyAqLwog
CWlmICghSU5URUxfSU5GTyhpOTE1KS0+Z3B1X3Jlc2V0X2Nsb2JiZXJzX2Rpc3BsYXkpCkBAIC04
MzIsNyArODM5LDcgQEAgc3RhdGljIHZvaWQgX19pOTE1X2dlbV9zZXRfd2VkZ2VkKHN0cnVjdCBk
cm1faTkxNV9wcml2YXRlICppOTE1KQogCWZvcl9lYWNoX2VuZ2luZShlbmdpbmUsIGk5MTUsIGlk
KQogCQllbmdpbmUtPmNhbmNlbF9yZXF1ZXN0cyhlbmdpbmUpOwogCi0JcmVzZXRfZmluaXNoKGk5
MTUpOworCXJlc2V0X2ZpbmlzaChpOTE1LCBhd2FrZSk7CiAKIAlHRU1fVFJBQ0UoImVuZFxuIik7
CiB9CkBAIC05NjQsNiArOTcxLDcgQEAgdm9pZCBpOTE1X3Jlc2V0KHN0cnVjdCBkcm1faTkxNV9w
cml2YXRlICppOTE1LAogCQljb25zdCBjaGFyICpyZWFzb24pCiB7CiAJc3RydWN0IGk5MTVfZ3B1
X2Vycm9yICplcnJvciA9ICZpOTE1LT5ncHVfZXJyb3I7CisJaW50ZWxfZW5naW5lX21hc2tfdCBh
d2FrZTsKIAlpbnQgcmV0OwogCiAJR0VNX1RSQUNFKCJmbGFncz0lbHhcbiIsIGVycm9yLT5mbGFn
cyk7CkBAIC05ODAsNyArOTg4LDcgQEAgdm9pZCBpOTE1X3Jlc2V0KHN0cnVjdCBkcm1faTkxNV9w
cml2YXRlICppOTE1LAogCQlkZXZfbm90aWNlKGk5MTUtPmRybS5kZXYsICJSZXNldHRpbmcgY2hp
cCBmb3IgJXNcbiIsIHJlYXNvbik7CiAJZXJyb3ItPnJlc2V0X2NvdW50Kys7CiAKLQlyZXNldF9w
cmVwYXJlKGk5MTUpOworCWF3YWtlID0gcmVzZXRfcHJlcGFyZShpOTE1KTsKIAogCWlmICghaW50
ZWxfaGFzX2dwdV9yZXNldChpOTE1KSkgewogCQlpZiAoaTkxNV9tb2RwYXJhbXMucmVzZXQpCkBA
IC0xMDIxLDcgKzEwMjksNyBAQCB2b2lkIGk5MTVfcmVzZXQoc3RydWN0IGRybV9pOTE1X3ByaXZh
dGUgKmk5MTUsCiAJaTkxNV9xdWV1ZV9oYW5nY2hlY2soaTkxNSk7CiAKIGZpbmlzaDoKLQlyZXNl
dF9maW5pc2goaTkxNSk7CisJcmVzZXRfZmluaXNoKGk5MTUsIGF3YWtlKTsKIHVubG9jazoKIAlt
dXRleF91bmxvY2soJmVycm9yLT53ZWRnZV9tdXRleCk7CiAJcmV0dXJuOwpAQCAtMTA3Miw3ICsx
MDgwLDcgQEAgaW50IGk5MTVfcmVzZXRfZW5naW5lKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVu
Z2luZSwgY29uc3QgY2hhciAqbXNnKQogCUdFTV9UUkFDRSgiJXMgZmxhZ3M9JWx4XG4iLCBlbmdp
bmUtPm5hbWUsIGVycm9yLT5mbGFncyk7CiAJR0VNX0JVR19PTighdGVzdF9iaXQoSTkxNV9SRVNF
VF9FTkdJTkUgKyBlbmdpbmUtPmlkLCAmZXJyb3ItPmZsYWdzKSk7CiAKLQlpZiAoIWludGVsX2Vu
Z2luZV9wbV9pc19hd2FrZShlbmdpbmUpKQorCWlmICghaW50ZWxfZW5naW5lX3BtX2dldF9pZl9h
d2FrZShlbmdpbmUpKQogCQlyZXR1cm4gMDsKIAogCXJlc2V0X3ByZXBhcmVfZW5naW5lKGVuZ2lu
ZSk7CkBAIC0xMTA3LDEyICsxMTE1LDExIEBAIGludCBpOTE1X3Jlc2V0X2VuZ2luZShzdHJ1Y3Qg
aW50ZWxfZW5naW5lX2NzICplbmdpbmUsIGNvbnN0IGNoYXIgKm1zZykKIAkgKiBwcm9jZXNzIHRv
IHByb2dyYW0gUklOR19NT0RFLCBIV1NQIGFuZCByZS1lbmFibGUgc3VibWlzc2lvbi4KIAkgKi8K
IAlyZXQgPSBlbmdpbmUtPnJlc3VtZShlbmdpbmUpOwotCWlmIChyZXQpCi0JCWdvdG8gb3V0Owog
CiBvdXQ6CiAJaW50ZWxfZW5naW5lX2NhbmNlbF9zdG9wX2NzKGVuZ2luZSk7CiAJcmVzZXRfZmlu
aXNoX2VuZ2luZShlbmdpbmUpOworCWludGVsX2VuZ2luZV9wbV9wdXQoZW5naW5lKTsKIAlyZXR1
cm4gcmV0OwogfQogCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVz
dF9yZXNldC5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Qvc2VsZnRlc3RfcmVzZXQuYwppbmRl
eCA2NDFjZjNhZWU4ZDUuLjY3MmUzMmUxZWY5NSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJt
L2k5MTUvZ3Qvc2VsZnRlc3RfcmVzZXQuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9z
ZWxmdGVzdF9yZXNldC5jCkBAIC03MSwxNSArNzEsMTcgQEAgc3RhdGljIGludCBpZ3RfYXRvbWlj
X3Jlc2V0KHZvaWQgKmFyZykKIAkJZ290byB1bmxvY2s7CiAKIAlmb3IgKHAgPSBpZ3RfYXRvbWlj
X3BoYXNlczsgcC0+bmFtZTsgcCsrKSB7CisJCWludGVsX2VuZ2luZV9tYXNrX3QgYXdha2U7CisK
IAkJR0VNX1RSQUNFKCJpbnRlbF9ncHVfcmVzZXQgdW5kZXIgJXNcbiIsIHAtPm5hbWUpOwogCi0J
CXJlc2V0X3ByZXBhcmUoaTkxNSk7CisJCWF3YWtlID0gcmVzZXRfcHJlcGFyZShpOTE1KTsKIAkJ
cC0+Y3JpdGljYWxfc2VjdGlvbl9iZWdpbigpOwogCiAJCWVyciA9IGludGVsX2dwdV9yZXNldChp
OTE1LCBBTExfRU5HSU5FUyk7CiAKIAkJcC0+Y3JpdGljYWxfc2VjdGlvbl9lbmQoKTsKLQkJcmVz
ZXRfZmluaXNoKGk5MTUpOworCQlyZXNldF9maW5pc2goaTkxNSwgYXdha2UpOwogCiAJCWlmIChl
cnIpIHsKIAkJCXByX2VycigiaW50ZWxfZ3B1X3Jlc2V0IGZhaWxlZCB1bmRlciAlc1xuIiwgcC0+
bmFtZSk7Ci0tIAoyLjIwLjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNr
dG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2lu
dGVsLWdmeA==

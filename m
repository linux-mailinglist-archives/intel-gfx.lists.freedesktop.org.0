Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id EFDB672F32
	for <lists+intel-gfx@lfdr.de>; Wed, 24 Jul 2019 14:50:50 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 438506E4AE;
	Wed, 24 Jul 2019 12:50:49 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 2243F6E4B6
 for <intel-gfx@lists.freedesktop.org>; Wed, 24 Jul 2019 12:50:46 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17565502-1500050 
 for multiple; Wed, 24 Jul 2019 13:50:35 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Wed, 24 Jul 2019 13:50:34 +0100
Message-Id: <20190724125034.1747-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.22.0
In-Reply-To: <20190724124342.27796-1-chris@chris-wilson.co.uk>
References: <20190724124342.27796-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH] drm/i915: Unshare the idle-barrier from other
 kernel requests
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

VW5kZXIgc29tZSBjaXJjdW1zdGFuY2VzIChzZWUgaW50ZWxfY29udGV4dF9wcmVwYXJlX3JlbW90
ZV9yZXF1ZXN0KSwgd2UKbWF5IHVzZSBhIHJlcXVlc3QgYWxvbmcgYSBrZXJuZWwgY29udGV4dCB0
byBtb2RpZnkgdGhlIGxvZ2ljYWwgc3RhdGUgb2YKYW5vdGhlci4gVG8ga2VlcCB0aGUgdGFyZ2V0
IGNvbnRleHQgaW4gcGxhY2Ugd2hpbGUgdGhlIHJlcXVlc3QgZXhlY3V0ZXMsCndlIHRha2UgYW4g
YWN0aXZlIHJlZmVyZW5jZSBvbiBpdCB1c2luZyB0aGUga2VybmVsIHRpbWVsaW5lLiBUaGlzIGlz
IHRoZQpzYW1lIHRpbWVsaW5lIGFzIHdlIHVzZSBmb3IgdGhlIGlkbGUtYmFycmllciwgYW5kIHNv
IHdlIGVuZCB1cCByZXVzaW5nCnRoZSBzYW1lIGFjdGl2ZSBub2RlLiBFeGNlcHQgdGhhdCB0aGUg
aWRsZSBiYXJyaWVyIGlzIHNwZWNpYWwgYW5kIGNhbm5vdApiZSByZXVzZWQgaW4gdGhpcyBtYW5u
ZXIhIEdpdmUgdGhlIGlkbGUtYmFycmllciBhIHJlc2VydmVkIHRpbWVsaW5lCmluZGV4ICgwKSBz
byB0aGF0IGl0IHdpbGwgYWx3YXlzIGJlIHVuaXF1ZSAoZ2l2ZSBvciB0YWtlIHdlIG1heSBpc3N1
ZQptdWx0aXBsZSBpZGxlIGJhcnJpZXJzIGFjcm9zcyBtdWx0aXBsZSBlbmdpbmVzKS4KClJlcG9y
dGVkLWJ5OiBMaW9uZWwgTGFuZHdlcmxpbiA8bGlvbmVsLmcubGFuZHdlcmxpbkBpbnRlbC5jb20+
CkZpeGVzOiBjZTQ3NmM4MGI4YmYgKCJkcm0vaTkxNTogS2VlcCBjb250ZXh0cyBwaW5uZWQgdW50
aWwgYWZ0ZXIgdGhlIG5leHQga2VybmVsIGNvbnRleHQgc3dpdGNoIikKRml4ZXM6IGE5ODc3ZGEy
ZDYyOSAoImRybS9pOTE1L29hOiBSZWNvbmZpZ3VyZSBjb250ZXh0cyBvbiB0aGUgZmx5IikKU2ln
bmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28udWs+CkNjOiBM
aW9uZWwgTGFuZHdlcmxpbiA8bGlvbmVsLmcubGFuZHdlcmxpbkBpbnRlbC5jb20+CkNjOiBUdnJ0
a28gVXJzdWxpbiA8dHZydGtvLnVyc3VsaW5AaW50ZWwuY29tPgotLS0KUmVwbGFjZSByZWN1cnNp
dmUgYXR0ZW1wdCB0byBhY3F1aXJlIHRoZSBpOTE1X2FjdGl2ZS5tdXRleCB3aXRoIGEKbG9ja2Rl
cCBhbm5vdGF0aW9uLgotLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfYWN0aXZlLmMgfCA1
OCArKysrKysrKysrKysrKysrKysrKystLS0tLS0tLS0KIDEgZmlsZSBjaGFuZ2VkLCA0MiBpbnNl
cnRpb25zKCspLCAxNiBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9pOTE1X2FjdGl2ZS5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9hY3RpdmUuYwpp
bmRleCAxM2YzMDRhMjlmYzguLjk5YmViZDc3ZjM2NCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvaTkxNV9hY3RpdmUuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2Fj
dGl2ZS5jCkBAIC0xODQsNiArMTg0LDcgQEAgYWN0aXZlX2luc3RhbmNlKHN0cnVjdCBpOTE1X2Fj
dGl2ZSAqcmVmLCB1NjQgaWR4KQogCXJlZi0+Y2FjaGUgPSBub2RlOwogCW11dGV4X3VubG9jaygm
cmVmLT5tdXRleCk7CiAKKwlCVUlMRF9CVUdfT04ob2Zmc2V0b2YodHlwZW9mKCpub2RlKSwgYmFz
ZSkpOwogCXJldHVybiAmbm9kZS0+YmFzZTsKIH0KIApAQCAtMjEyLDYgKzIxMyw4IEBAIGludCBp
OTE1X2FjdGl2ZV9yZWYoc3RydWN0IGk5MTVfYWN0aXZlICpyZWYsCiAJc3RydWN0IGk5MTVfYWN0
aXZlX3JlcXVlc3QgKmFjdGl2ZTsKIAlpbnQgZXJyOwogCisJR0VNX0JVR19PTighdGltZWxpbmUp
OyAvKiByZXNlcnZlZCBmb3IgaWRsZS1iYXJyaWVyICovCisKIAkvKiBQcmV2ZW50IHJlYXBpbmcg
aW4gY2FzZSB3ZSBtYWxsb2Mvd2FpdCB3aGlsZSBidWlsZGluZyB0aGUgdHJlZSAqLwogCWVyciA9
IGk5MTVfYWN0aXZlX2FjcXVpcmUocmVmKTsKIAlpZiAoZXJyKQpAQCAtMzQyLDYgKzM0NSwyNiBA
QCB2b2lkIGk5MTVfYWN0aXZlX2Zpbmkoc3RydWN0IGk5MTVfYWN0aXZlICpyZWYpCiB9CiAjZW5k
aWYKIAorc3RhdGljIHN0cnVjdCBhY3RpdmVfbm9kZSAqaWRsZV9iYXJyaWVyKHN0cnVjdCBpOTE1
X2FjdGl2ZSAqcmVmKQoreworCXN0cnVjdCBhY3RpdmVfbm9kZSAqbm9kZTsKKwlzdHJ1Y3QgcmJf
bm9kZSAqcmI7CisKKwlsb2NrZGVwX2Fzc2VydF9oZWxkKCZyZWYtPm11dGV4KTsKKwlyYiA9IHJi
X2ZpcnN0KCZyZWYtPnRyZWUpOworCWlmICghcmIpCisJCXJldHVybiBOVUxMOworCisJbm9kZSA9
IHJiX2VudHJ5KHJiLCB0eXBlb2YoKm5vZGUpLCBub2RlKTsKKwlpZiAobm9kZS0+dGltZWxpbmUg
fHwgaTkxNV9hY3RpdmVfcmVxdWVzdF9pc3NldCgmbm9kZS0+YmFzZSkpCisJCXJldHVybiBOVUxM
OworCisJR0VNX0JVR19PTighbGlzdF9lbXB0eSgmbm9kZS0+YmFzZS5saW5rKSk7CisJcmJfZXJh
c2UocmIsICZyZWYtPnRyZWUpOworCisJcmV0dXJuIG5vZGU7Cit9CisKIGludCBpOTE1X2FjdGl2
ZV9hY3F1aXJlX3ByZWFsbG9jYXRlX2JhcnJpZXIoc3RydWN0IGk5MTVfYWN0aXZlICpyZWYsCiAJ
CQkJCSAgICBzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUpCiB7CkBAIC0zNTIsMjIgKzM3
NSwyOSBAQCBpbnQgaTkxNV9hY3RpdmVfYWNxdWlyZV9wcmVhbGxvY2F0ZV9iYXJyaWVyKHN0cnVj
dCBpOTE1X2FjdGl2ZSAqcmVmLAogCiAJR0VNX0JVR19PTighZW5naW5lLT5tYXNrKTsKIAlmb3Jf
ZWFjaF9lbmdpbmVfbWFza2VkKGVuZ2luZSwgaTkxNSwgZW5naW5lLT5tYXNrLCB0bXApIHsKLQkJ
c3RydWN0IGludGVsX2NvbnRleHQgKmtjdHggPSBlbmdpbmUtPmtlcm5lbF9jb250ZXh0OwogCQlz
dHJ1Y3QgYWN0aXZlX25vZGUgKm5vZGU7CiAKLQkJbm9kZSA9IGttZW1fY2FjaGVfYWxsb2MoZ2xv
YmFsLnNsYWJfY2FjaGUsIEdGUF9LRVJORUwpOwotCQlpZiAodW5saWtlbHkoIW5vZGUpKSB7Ci0J
CQllcnIgPSAtRU5PTUVNOwotCQkJZ290byB1bndpbmQ7CisJCW5vZGUgPSBpZGxlX2JhcnJpZXIo
cmVmKTsKKwkJaWYgKCFub2RlKSB7CisJCQlub2RlID0ga21lbV9jYWNoZV9hbGxvYyhnbG9iYWwu
c2xhYl9jYWNoZSwKKwkJCQkJCUdGUF9LRVJORUwgfAorCQkJCQkJX19HRlBfUkVUUllfTUFZRkFJ
TCB8CisJCQkJCQlfX0dGUF9OT1dBUk4pOworCQkJaWYgKHVubGlrZWx5KCFub2RlKSkgeworCQkJ
CWVyciA9IC1FTk9NRU07CisJCQkJZ290byB1bndpbmQ7CisJCQl9CisKKwkJCW5vZGUtPnJlZiA9
IHJlZjsKKwkJCW5vZGUtPnRpbWVsaW5lID0gMDsKKwkJCW5vZGUtPmJhc2UucmV0aXJlID0gbm9k
ZV9yZXRpcmU7CiAJCX0KIAotCQlpOTE1X2FjdGl2ZV9yZXF1ZXN0X2luaXQoJm5vZGUtPmJhc2Us
Ci0JCQkJCSAodm9pZCAqKWVuZ2luZSwgbm9kZV9yZXRpcmUpOwotCQlub2RlLT50aW1lbGluZSA9
IGtjdHgtPnJpbmctPnRpbWVsaW5lLT5mZW5jZV9jb250ZXh0OwotCQlub2RlLT5yZWYgPSByZWY7
CisJCWludGVsX2VuZ2luZV9wbV9nZXQoZW5naW5lKTsKKworCQlSQ1VfSU5JVF9QT0lOVEVSKG5v
ZGUtPmJhc2UucmVxdWVzdCwgKHZvaWQgKillbmdpbmUpOwogCQlhdG9taWNfaW5jKCZyZWYtPmNv
dW50KTsKIAotCQlpbnRlbF9lbmdpbmVfcG1fZ2V0KGVuZ2luZSk7CiAJCWxsaXN0X2FkZCgoc3Ry
dWN0IGxsaXN0X25vZGUgKikmbm9kZS0+YmFzZS5saW5rLAogCQkJICAmcmVmLT5iYXJyaWVycyk7
CiAJfQpAQCAtNDAyLDYgKzQzMiw3IEBAIHZvaWQgaTkxNV9hY3RpdmVfYWNxdWlyZV9iYXJyaWVy
KHN0cnVjdCBpOTE1X2FjdGl2ZSAqcmVmKQogCiAJCW5vZGUgPSBjb250YWluZXJfb2YoKHN0cnVj
dCBsaXN0X2hlYWQgKilwb3MsCiAJCQkJICAgIHR5cGVvZigqbm9kZSksIGJhc2UubGluayk7CisJ
CUdFTV9CVUdfT04obm9kZS0+dGltZWxpbmUpOwogCiAJCWVuZ2luZSA9ICh2b2lkICopcmN1X2Fj
Y2Vzc19wb2ludGVyKG5vZGUtPmJhc2UucmVxdWVzdCk7CiAJCVJDVV9JTklUX1BPSU5URVIobm9k
ZS0+YmFzZS5yZXF1ZXN0LCBFUlJfUFRSKC1FQUdBSU4pKTsKQEAgLTQxMCwxMiArNDQxLDcgQEAg
dm9pZCBpOTE1X2FjdGl2ZV9hY3F1aXJlX2JhcnJpZXIoc3RydWN0IGk5MTVfYWN0aXZlICpyZWYp
CiAJCXAgPSAmcmVmLT50cmVlLnJiX25vZGU7CiAJCXdoaWxlICgqcCkgewogCQkJcGFyZW50ID0g
KnA7Ci0JCQlpZiAocmJfZW50cnkocGFyZW50LAotCQkJCSAgICAgc3RydWN0IGFjdGl2ZV9ub2Rl
LAotCQkJCSAgICAgbm9kZSktPnRpbWVsaW5lIDwgbm9kZS0+dGltZWxpbmUpCi0JCQkJcCA9ICZw
YXJlbnQtPnJiX3JpZ2h0OwotCQkJZWxzZQotCQkJCXAgPSAmcGFyZW50LT5yYl9sZWZ0OworCQkJ
cCA9ICZwYXJlbnQtPnJiX2xlZnQ7CiAJCX0KIAkJcmJfbGlua19ub2RlKCZub2RlLT5ub2RlLCBw
YXJlbnQsIHApOwogCQlyYl9pbnNlcnRfY29sb3IoJm5vZGUtPm5vZGUsICZyZWYtPnRyZWUpOwot
LSAKMi4yMi4wCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
XwpJbnRlbC1nZnggbWFpbGluZyBsaXN0CkludGVsLWdmeEBsaXN0cy5mcmVlZGVza3RvcC5vcmcK
aHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9pbnRlbC1nZng=

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 4BF391EB917
	for <lists+intel-gfx@lfdr.de>; Tue,  2 Jun 2020 12:06:49 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 9A50A6E1A2;
	Tue,  2 Jun 2020 10:06:47 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id E0A976E1A2;
 Tue,  2 Jun 2020 10:06:45 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 21370425-1500050 
 for multiple; Tue, 02 Jun 2020 11:05:56 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Tue,  2 Jun 2020 11:05:50 +0100
Message-Id: <20200602100551.1413463-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.27.0.rc2
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH i-g-t 1/2] i915/gem_exec_schedule: Try to spot
 unfairness
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: igt-dev@lists.freedesktop.org, Chris Wilson <chris@chris-wilson.co.uk>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

QW4gaW1wb3J0YW50IHByb3BlcnR5IGZvciBtdWx0aS1jbGllbnQgc3lzdGVtcyBpcyB0aGF0IGVh
Y2ggY2xpZW50IGdldHMKYSAnZmFpcicgYWxsb3RtZW50IG9mIHN5c3RlbSB0aW1lLiAoV2hlcmUg
ZmFpcm5lc3MgaXMgYXQgdGhlIHdoaW0gb2YgdGhlCmNvbnRleHQgcHJvcGVydGllcywgc3VjaCBh
cyBwcmlvcml0aWVzLikgVGhpcyB0ZXN0IGZvcmtzIE4gaW5kZXBlbmRlbnQKY2xpZW50cyAoYWxi
ZWl0IHRoZXkgaGFwcGVuIHRvIHNoYXJlIGEgc2luZ2xlIHZtKSwgYW5kIGRvZXMgYW4gZXF1YWwK
YW1vdW50IG9mIHdvcmsgaW4gY2xpZW50IGFuZCBhc3NlcnRzIHRoYXQgdGhleSB0YWtlIGFuIGVx
dWFsIGFtb3VudCBvZgp0aW1lLgoKVGhvdWdoIHdlIGhhdmUgbmV2ZXIgY2xhaW1lZCB0byBoYXZl
IGEgY29tcGxldGVseSBmYWlyIHNjaGVkdWxlciwgdGhhdAppcyB3aGF0IGlzIGV4cGVjdGVkLgoK
U2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28udWs+CkNj
OiBUdnJ0a28gVXJzdWxpbiA8dHZydGtvLnVyc3VsaW5AaW50ZWwuY29tPgpDYzogUmFtYWxpbmdh
bSBDIDxyYW1hbGluZ2FtLmNAaW50ZWwuY29tPgotLS0KIHRlc3RzL2k5MTUvZ2VtX2V4ZWNfc2No
ZWR1bGUuYyB8IDQ0OCArKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysKIDEgZmlsZSBj
aGFuZ2VkLCA0NDggaW5zZXJ0aW9ucygrKQoKZGlmZiAtLWdpdCBhL3Rlc3RzL2k5MTUvZ2VtX2V4
ZWNfc2NoZWR1bGUuYyBiL3Rlc3RzL2k5MTUvZ2VtX2V4ZWNfc2NoZWR1bGUuYwppbmRleCA1NmM2
Mzg4MzMuLjUyNzRlMmM4MyAxMDA2NDQKLS0tIGEvdGVzdHMvaTkxNS9nZW1fZXhlY19zY2hlZHVs
ZS5jCisrKyBiL3Rlc3RzL2k5MTUvZ2VtX2V4ZWNfc2NoZWR1bGUuYwpAQCAtMjQ5NSw2ICsyNDk1
LDQzOSBAQCBzdGF0aWMgdm9pZCBtZWFzdXJlX3NlbWFwaG9yZV9wb3dlcihpbnQgaTkxNSkKIAly
YXBsX2Nsb3NlKCZwa2cpOwogfQogCitzdGF0aWMgaW50IHJlYWRfdGltZXN0YW1wX2ZyZXF1ZW5j
eShpbnQgaTkxNSkKK3sKKwlpbnQgdmFsdWUgPSAwOworCWRybV9pOTE1X2dldHBhcmFtX3QgZ3Ag
PSB7CisJCS52YWx1ZSA9ICZ2YWx1ZSwKKwkJLnBhcmFtID0gSTkxNV9QQVJBTV9DU19USU1FU1RB
TVBfRlJFUVVFTkNZLAorCX07CisJaW9jdGwoaTkxNSwgRFJNX0lPQ1RMX0k5MTVfR0VUUEFSQU0s
ICZncCk7CisJcmV0dXJuIHZhbHVlOworfQorCitzdGF0aWMgdWludDY0X3QgZGl2NjRfdTY0X3Jv
dW5kX3VwKHVpbnQ2NF90IHgsIHVpbnQ2NF90IHkpCit7CisJcmV0dXJuICh4ICsgeSAtIDEpIC8g
eTsKK30KKworc3RhdGljIHVpbnQ2NF90IG5zX3RvX3RpY2tzKGludCBpOTE1LCB1aW50NjRfdCBu
cykKK3sKKwlyZXR1cm4gZGl2NjRfdTY0X3JvdW5kX3VwKG5zICogcmVhZF90aW1lc3RhbXBfZnJl
cXVlbmN5KGk5MTUpLAorCQkJCSAgTlNFQ19QRVJfU0VDKTsKK30KKworc3RhdGljIHVpbnQ2NF90
IHRpY2tzX3RvX25zKGludCBpOTE1LCB1aW50NjRfdCB0aWNrcykKK3sKKwlyZXR1cm4gZGl2NjRf
dTY0X3JvdW5kX3VwKHRpY2tzICogTlNFQ19QRVJfU0VDLAorCQkJCSAgcmVhZF90aW1lc3RhbXBf
ZnJlcXVlbmN5KGk5MTUpKTsKK30KKworI2RlZmluZSBNSV9JTlNUUihvcGNvZGUsIGZsYWdzKSAo
KChvcGNvZGUpIDw8IDIzKSB8IChmbGFncykpCisKKyNkZWZpbmUgTUlfTUFUSCh4KSAgICAgICAg
ICAgICAgICAgICAgICBNSV9JTlNUUigweDFhLCAoeCkgLSAxKQorI2RlZmluZSBNSV9NQVRIX0lO
U1RSKG9wY29kZSwgb3AxLCBvcDIpICgob3Bjb2RlKSA8PCAyMCB8IChvcDEpIDw8IDEwIHwgKG9w
MikpCisvKiBPcGNvZGVzIGZvciBNSV9NQVRIX0lOU1RSICovCisjZGVmaW5lICAgTUlfTUFUSF9O
T09QICAgICAgICAgICAgICAgICAgTUlfTUFUSF9JTlNUUigweDAwMCwgMHgwLCAweDApCisjZGVm
aW5lICAgTUlfTUFUSF9MT0FEKG9wMSwgb3AyKSAgICAgICAgTUlfTUFUSF9JTlNUUigweDA4MCwg
b3AxLCBvcDIpCisjZGVmaW5lICAgTUlfTUFUSF9MT0FESU5WKG9wMSwgb3AyKSAgICAgTUlfTUFU
SF9JTlNUUigweDQ4MCwgb3AxLCBvcDIpCisjZGVmaW5lICAgTUlfTUFUSF9MT0FEMChvcDEpICAg
ICAgICAgICAgTUlfTUFUSF9JTlNUUigweDA4MSwgb3AxKQorI2RlZmluZSAgIE1JX01BVEhfTE9B
RDEob3AxKSAgICAgICAgICAgIE1JX01BVEhfSU5TVFIoMHg0ODEsIG9wMSkKKyNkZWZpbmUgICBN
SV9NQVRIX0FERCAgICAgICAgICAgICAgICAgICBNSV9NQVRIX0lOU1RSKDB4MTAwLCAweDAsIDB4
MCkKKyNkZWZpbmUgICBNSV9NQVRIX1NVQiAgICAgICAgICAgICAgICAgICBNSV9NQVRIX0lOU1RS
KDB4MTAxLCAweDAsIDB4MCkKKyNkZWZpbmUgICBNSV9NQVRIX0FORCAgICAgICAgICAgICAgICAg
ICBNSV9NQVRIX0lOU1RSKDB4MTAyLCAweDAsIDB4MCkKKyNkZWZpbmUgICBNSV9NQVRIX09SICAg
ICAgICAgICAgICAgICAgICBNSV9NQVRIX0lOU1RSKDB4MTAzLCAweDAsIDB4MCkKKyNkZWZpbmUg
ICBNSV9NQVRIX1hPUiAgICAgICAgICAgICAgICAgICBNSV9NQVRIX0lOU1RSKDB4MTA0LCAweDAs
IDB4MCkKKyNkZWZpbmUgICBNSV9NQVRIX1NUT1JFKG9wMSwgb3AyKSAgICAgICBNSV9NQVRIX0lO
U1RSKDB4MTgwLCBvcDEsIG9wMikKKyNkZWZpbmUgICBNSV9NQVRIX1NUT1JFSU5WKG9wMSwgb3Ay
KSAgICBNSV9NQVRIX0lOU1RSKDB4NTgwLCBvcDEsIG9wMikKKy8qIFJlZ2lzdGVycyB1c2VkIGFz
IG9wZXJhbmRzIGluIE1JX01BVEhfSU5TVFIgKi8KKyNkZWZpbmUgICBNSV9NQVRIX1JFRyh4KSAg
ICAgICAgICAgICAgICAoeCkKKyNkZWZpbmUgICBNSV9NQVRIX1JFR19TUkNBICAgICAgICAgICAg
ICAweDIwCisjZGVmaW5lICAgTUlfTUFUSF9SRUdfU1JDQiAgICAgICAgICAgICAgMHgyMQorI2Rl
ZmluZSAgIE1JX01BVEhfUkVHX0FDQ1UgICAgICAgICAgICAgIDB4MzEKKyNkZWZpbmUgICBNSV9N
QVRIX1JFR19aRiAgICAgICAgICAgICAgICAweDMyCisjZGVmaW5lICAgTUlfTUFUSF9SRUdfQ0Yg
ICAgICAgICAgICAgICAgMHgzMworCisjZGVmaW5lIE1JX0xPQURfUkVHSVNURVJfUkVHICAgIE1J
X0lOU1RSKDB4MkEsIDEpCisKK3N0YXRpYyB2b2lkIGRlbGF5KGludCBpOTE1LAorCQkgIGNvbnN0
IHN0cnVjdCBpbnRlbF9leGVjdXRpb25fZW5naW5lMiAqZSwKKwkJICB1aW50MzJfdCBoYW5kbGUs
CisJCSAgdWludDY0X3QgYWRkciwKKwkJICB1aW50NjRfdCBucykKK3sKKwljb25zdCBpbnQgdXNl
XzY0YiA9IGludGVsX2dlbihpbnRlbF9nZXRfZHJtX2RldmlkKGk5MTUpKSA+PSA4OworCWNvbnN0
IHVpbnQzMl90IGJhc2UgPSBnZW1fZW5naW5lX21taW9fYmFzZShpOTE1LCBlLT5uYW1lKTsKKyNk
ZWZpbmUgQ1NfR1BSKHgpIChiYXNlICsgMHg2MDAgKyA4ICogKHgpKQorI2RlZmluZSBUSU1FU1RB
TVAgKGJhc2UgKyAweDNhOCkKKwllbnVtIHsgU1RBUlRfVFMsIE5PV19UUyB9OworCXVpbnQzMl90
ICptYXAsICpjcywgKmptcDsKKworCWlndF9yZXF1aXJlKGJhc2UpOworCisJY3MgPSBtYXAgPSBn
ZW1fbW1hcF9fZGV2aWNlX2NvaGVyZW50KGk5MTUsIGhhbmRsZSwgMCwgNDA5NiwgUFJPVF9XUklU
RSk7CisKKwkqY3MrKyA9IE1JX0xPQURfUkVHSVNURVJfSU1NOworCSpjcysrID0gQ1NfR1BSKFNU
QVJUX1RTKSArIDQ7CisJKmNzKysgPSAwOworCSpjcysrID0gTUlfTE9BRF9SRUdJU1RFUl9SRUc7
CisJKmNzKysgPSBUSU1FU1RBTVA7CisJKmNzKysgPSBDU19HUFIoU1RBUlRfVFMpOworCisJd2hp
bGUgKG9mZnNldF9pbl9wYWdlKGNzKSAmIDYzKQorCQkqY3MrKyA9IDA7CisJam1wID0gY3M7CisK
KwkqY3MrKyA9IDB4NSA8PCAyMzsgLyogTUlfQVJCX0NIRUNLICovCisKKwkqY3MrKyA9IE1JX0xP
QURfUkVHSVNURVJfSU1NOworCSpjcysrID0gQ1NfR1BSKE5PV19UUykgKyA0OworCSpjcysrID0g
MDsKKwkqY3MrKyA9IE1JX0xPQURfUkVHSVNURVJfUkVHOworCSpjcysrID0gVElNRVNUQU1QOwor
CSpjcysrID0gQ1NfR1BSKE5PV19UUyk7CisKKwkqY3MrKyA9IE1JX01BVEgoNCk7CisJKmNzKysg
PSBNSV9NQVRIX0xPQUQoTUlfTUFUSF9SRUdfU1JDQSwgTUlfTUFUSF9SRUcoTk9XX1RTKSk7CisJ
KmNzKysgPSBNSV9NQVRIX0xPQUQoTUlfTUFUSF9SRUdfU1JDQiwgTUlfTUFUSF9SRUcoU1RBUlRf
VFMpKTsKKwkqY3MrKyA9IE1JX01BVEhfU1VCOworCSpjcysrID0gTUlfTUFUSF9TVE9SRUlOVihN
SV9NQVRIX1JFRyhOT1dfVFMpLCBNSV9NQVRIX1JFR19BQ0NVKTsKKworCSpjcysrID0gMHgyNCA8
PCAyMyB8ICgxICsgdXNlXzY0Yik7IC8qIFNSTSAqLworCSpjcysrID0gQ1NfR1BSKE5PV19UUyk7
CisJKmNzKysgPSBhZGRyICsgNDAwMDsKKwkqY3MrKyA9IGFkZHIgPj4gMzI7CisKKwkvKiBEZWxh
eSBiZXR3ZWVuIFNSTSBhbmQgQ09ORF9CQkUgdG8gcG9zdCB0aGUgd3JpdGVzICovCisJZm9yIChp
bnQgbiA9IDA7IG4gPCA4OyBuKyspIHsKKwkJKmNzKysgPSBNSV9TVE9SRV9EV09SRF9JTU07CisJ
CSpjcysrID0gYWRkciArIDQwNjQ7CisJCSpjcysrID0gYWRkciA+PiAzMjsKKwkJKmNzKysgPSAw
OworCX0KKworCSpjcysrID0gTUlfQ09ORF9CQVRDSF9CVUZGRVJfRU5EIHwgTUlfRE9fQ09NUEFS
RSB8ICgxICsgdXNlXzY0Yik7CisJKmNzKysgPSB+bnNfdG9fdGlja3MoaTkxNSwgbnMpOworCSpj
cysrID0gYWRkciArIDQwMDA7CisJKmNzKysgPSBhZGRyID4+IDMyOworCisJKmNzKysgPSBNSV9C
QVRDSF9CVUZGRVJfU1RBUlQgfCAxIDw8IDggfCB1c2VfNjRiOworCSpjcysrID0gYWRkciArIG9m
ZnNldF9pbl9wYWdlKGptcCk7CisJKmNzKysgPSBhZGRyID4+IDMyOworCisJbXVubWFwKG1hcCwg
NDA5Nik7Cit9CisKK3N0YXRpYyBzdHJ1Y3QgZHJtX2k5MTVfZ2VtX2V4ZWNfb2JqZWN0MgorZGVs
YXlfY3JlYXRlKGludCBpOTE1LCB1aW50MzJfdCBjdHgsCisJICAgICBjb25zdCBzdHJ1Y3QgaW50
ZWxfZXhlY3V0aW9uX2VuZ2luZTIgKmUsCisJICAgICB1aW50NjRfdCB0YXJnZXRfbnMpCit7CisJ
c3RydWN0IGRybV9pOTE1X2dlbV9leGVjX29iamVjdDIgb2JqID0geworCQkuaGFuZGxlID0gYmF0
Y2hfY3JlYXRlKGk5MTUpLAorCQkuZmxhZ3MgPSBFWEVDX09CSkVDVF9TVVBQT1JUU180OEJfQURE
UkVTUywKKwl9OworCXN0cnVjdCBkcm1faTkxNV9nZW1fZXhlY2J1ZmZlcjIgZXhlY2J1ZiA9IHsK
KwkJLmJ1ZmZlcnNfcHRyID0gdG9fdXNlcl9wb2ludGVyKCZvYmopLAorCQkuYnVmZmVyX2NvdW50
ID0gMSwKKwkJLnJzdmQxID0gY3R4LAorCQkuZmxhZ3MgPSBlLT5mbGFncywKKwl9OworCisJZ2Vt
X2V4ZWNidWYoaTkxNSwgJmV4ZWNidWYpOworCWdlbV9zeW5jKGk5MTUsIG9iai5oYW5kbGUpOwor
CisJZGVsYXkoaTkxNSwgZSwgb2JqLmhhbmRsZSwgb2JqLm9mZnNldCwgdGFyZ2V0X25zKTsKKwor
CW9iai5mbGFncyB8PSBFWEVDX09CSkVDVF9QSU5ORUQ7CisJcmV0dXJuIG9iajsKK30KKworc3Rh
dGljIHZvaWQgdHNsb2coaW50IGk5MTUsCisJCSAgY29uc3Qgc3RydWN0IGludGVsX2V4ZWN1dGlv
bl9lbmdpbmUyICplLAorCQkgIHVpbnQzMl90IGhhbmRsZSwKKwkJICB1aW50NjRfdCBhZGRyKQor
eworCWNvbnN0IGludCB1c2VfNjRiID0gaW50ZWxfZ2VuKGludGVsX2dldF9kcm1fZGV2aWQoaTkx
NSkpID49IDg7CisJY29uc3QgdWludDMyX3QgYmFzZSA9IGdlbV9lbmdpbmVfbW1pb19iYXNlKGk5
MTUsIGUtPm5hbWUpOworI2RlZmluZSBDU19HUFIoeCkgKGJhc2UgKyAweDYwMCArIDggKiAoeCkp
CisjZGVmaW5lIENTX1RJTUVTVEFNUCAoYmFzZSArIDB4MzU4KQorCWVudW0geyBPTkUsIE1BU0ss
IEFERFIgfTsKKwl1aW50MzJfdCAqdGltZXN0YW1wX2xvLCAqYWRkcl9sbzsKKwl1aW50MzJfdCAq
bWFwLCAqY3M7CisKKwlpZ3RfcmVxdWlyZShiYXNlKTsKKworCW1hcCA9IGdlbV9tbWFwX19kZXZp
Y2VfY29oZXJlbnQoaTkxNSwgaGFuZGxlLCAwLCA0MDk2LCBQUk9UX1dSSVRFKTsKKwljcyA9IG1h
cCArIDUxMjsKKworCSpjcysrID0gMHgyNCA8PCAyMyB8ICgxICsgdXNlXzY0Yik7IC8qIFNSTSAq
LworCSpjcysrID0gQ1NfVElNRVNUQU1QOworCXRpbWVzdGFtcF9sbyA9IGNzOworCSpjcysrID0g
YWRkcjsKKwkqY3MrKyA9IGFkZHIgPj4gMzI7CisKKwkqY3MrKyA9IE1JX0xPQURfUkVHSVNURVJf
SU1NOworCSpjcysrID0gQ1NfR1BSKEFERFIpOworCWFkZHJfbG8gPSBjczsKKwkqY3MrKyA9IGFk
ZHI7CisJKmNzKysgPSBNSV9MT0FEX1JFR0lTVEVSX0lNTTsKKwkqY3MrKyA9IENTX0dQUihBRERS
KSArIDQ7CisJKmNzKysgPSBhZGRyID4+IDMyOworCisJKmNzKysgPSBNSV9MT0FEX1JFR0lTVEVS
X0lNTTsKKwkqY3MrKyA9IENTX0dQUihPTkUpOworCSpjcysrID0gNDsKKwkqY3MrKyA9IE1JX0xP
QURfUkVHSVNURVJfSU1NOworCSpjcysrID0gQ1NfR1BSKE9ORSkgKyA0OworCSpjcysrID0gMDsK
KworCSpjcysrID0gTUlfTE9BRF9SRUdJU1RFUl9JTU07CisJKmNzKysgPSBDU19HUFIoTUFTSyk7
CisJKmNzKysgPSAweGZmZmZmN2ZmOworCSpjcysrID0gTUlfTE9BRF9SRUdJU1RFUl9JTU07CisJ
KmNzKysgPSBDU19HUFIoTUFTSykgKyA0OworCSpjcysrID0gMHhmZmZmZmZmZjsKKworCSpjcysr
ID0gTUlfTUFUSCg4KTsKKwkqY3MrKyA9IE1JX01BVEhfTE9BRChNSV9NQVRIX1JFR19TUkNBLCBN
SV9NQVRIX1JFRyhPTkUpKTsKKwkqY3MrKyA9IE1JX01BVEhfTE9BRChNSV9NQVRIX1JFR19TUkNC
LCBNSV9NQVRIX1JFRyhBRERSKSk7CisJKmNzKysgPSBNSV9NQVRIX0FERDsKKwkqY3MrKyA9IE1J
X01BVEhfU1RPUkUoTUlfTUFUSF9SRUcoQUREUiksIE1JX01BVEhfUkVHX0FDQ1UpOworCSpjcysr
ID0gTUlfTUFUSF9MT0FEKE1JX01BVEhfUkVHX1NSQ0EsIE1JX01BVEhfUkVHKEFERFIpKTsKKwkq
Y3MrKyA9IE1JX01BVEhfTE9BRChNSV9NQVRIX1JFR19TUkNCLCBNSV9NQVRIX1JFRyhNQVNLKSk7
CisJKmNzKysgPSBNSV9NQVRIX0FORDsKKwkqY3MrKyA9IE1JX01BVEhfU1RPUkUoTUlfTUFUSF9S
RUcoQUREUiksIE1JX01BVEhfUkVHX0FDQ1UpOworCisJKmNzKysgPSAweDI0IDw8IDIzIHwgKDEg
KyB1c2VfNjRiKTsgLyogU1JNICovCisJKmNzKysgPSBDU19HUFIoQUREUik7CisJKmNzKysgPSBh
ZGRyICsgb2Zmc2V0X2luX3BhZ2UodGltZXN0YW1wX2xvKTsKKwkqY3MrKyA9IGFkZHIgPj4gMzI7
CisJKmNzKysgPSAweDI0IDw8IDIzIHwgKDEgKyB1c2VfNjRiKTsgLyogU1JNICovCisJKmNzKysg
PSBDU19HUFIoQUREUik7CisJKmNzKysgPSBhZGRyICsgb2Zmc2V0X2luX3BhZ2UoYWRkcl9sbyk7
CisJKmNzKysgPSBhZGRyID4+IDMyOworCisJKmNzKysgPSBNSV9CQVRDSF9CVUZGRVJfRU5EOwor
CisJbXVubWFwKG1hcCwgNDA5Nik7Cit9CisKK3N0YXRpYyBzdHJ1Y3QgZHJtX2k5MTVfZ2VtX2V4
ZWNfb2JqZWN0MgordHNsb2dfY3JlYXRlKGludCBpOTE1LCB1aW50MzJfdCBjdHgsIGNvbnN0IHN0
cnVjdCBpbnRlbF9leGVjdXRpb25fZW5naW5lMiAqZSkKK3sKKwlzdHJ1Y3QgZHJtX2k5MTVfZ2Vt
X2V4ZWNfb2JqZWN0MiBvYmogPSB7CisJCS5oYW5kbGUgPSBiYXRjaF9jcmVhdGUoaTkxNSksCisJ
CS5mbGFncyA9IEVYRUNfT0JKRUNUX1NVUFBPUlRTXzQ4Ql9BRERSRVNTLAorCX07CisJc3RydWN0
IGRybV9pOTE1X2dlbV9leGVjYnVmZmVyMiBleGVjYnVmID0geworCQkuYnVmZmVyc19wdHIgPSB0
b191c2VyX3BvaW50ZXIoJm9iaiksCisJCS5idWZmZXJfY291bnQgPSAxLAorCQkucnN2ZDEgPSBj
dHgsCisJCS5mbGFncyA9IGUtPmZsYWdzLAorCX07CisKKwlnZW1fZXhlY2J1ZihpOTE1LCAmZXhl
Y2J1Zik7CisJZ2VtX3N5bmMoaTkxNSwgb2JqLmhhbmRsZSk7CisKKwl0c2xvZyhpOTE1LCBlLCBv
YmouaGFuZGxlLCBvYmoub2Zmc2V0KTsKKworCW9iai5mbGFncyB8PSBFWEVDX09CSkVDVF9QSU5O
RUQ7CisJcmV0dXJuIG9iajsKK30KKworc3RhdGljIGludCBjbXBfdTMyKGNvbnN0IHZvaWQgKkEs
IGNvbnN0IHZvaWQgKkIpCit7CisJY29uc3QgdW5zaWduZWQgbG9uZyAqYSA9IEEsICpiID0gQjsK
KworCWlmICgqYSA8ICpiKQorCQlyZXR1cm4gLTE7CisJZWxzZSBpZiAoKmEgPiAqYikKKwkJcmV0
dXJuIDE7CisJZWxzZQorCQlyZXR1cm4gMDsKK30KKworc3RhdGljIHZvaWQgZmFpcl9jaGlsZChp
bnQgaTkxNSwgdWludDMyX3QgY3R4LAorCQkgICAgICAgY29uc3Qgc3RydWN0IGludGVsX2V4ZWN1
dGlvbl9lbmdpbmUyICplLAorCQkgICAgICAgdWludDY0X3QgZnJhbWVfbnMsCisJCSAgICAgICBp
bnQgdGltZW91dCwKKwkJICAgICAgIGludCB0aW1lbGluZSwKKwkJICAgICAgIHVuc2lnbmVkIGlu
dCBmbGFncywKKwkJICAgICAgIHVuc2lnbmVkIGxvbmcgKmN0bCwKKwkJICAgICAgIHVuc2lnbmVk
IGxvbmcgKm91dCkKKyNkZWZpbmUgRl9TWU5DICAoMSA8PCAwKQorI2RlZmluZSBGX1BBQ0UgICgx
IDw8IDEpCisjZGVmaW5lIEZfRkxPVyAgKDEgPDwgMikKKyNkZWZpbmUgRl9IQUxGICAoMSA8PCAz
KQorI2RlZmluZSBGX1NPTE8gICgxIDw8IDQpCisjZGVmaW5lIEZfU1BBUkUgKDEgPDwgOCkKK3sK
Kwljb25zdCBpbnQgYmF0Y2hlc19wZXJfZnJhbWUgPSBmbGFncyAmIEZfU09MTyA/IDEgOiAzOwor
CXN0cnVjdCBkcm1faTkxNV9nZW1fZXhlY19vYmplY3QyIHByZXYgPQorCQlkZWxheV9jcmVhdGUo
aTkxNSwgY3R4LCBlLCBmcmFtZV9ucyAvIGJhdGNoZXNfcGVyX2ZyYW1lKTsKKwlzdHJ1Y3QgZHJt
X2k5MTVfZ2VtX2V4ZWNfb2JqZWN0MiBuZXh0ID0KKwkJZGVsYXlfY3JlYXRlKGk5MTUsIGN0eCwg
ZSwgZnJhbWVfbnMgLyBiYXRjaGVzX3Blcl9mcmFtZSk7CisJc3RydWN0IGRybV9pOTE1X2dlbV9l
eGVjX29iamVjdDIgdHMgPSB0c2xvZ19jcmVhdGUoaTkxNSwgY3R4LCBlKTsKKwlpbnQgcF9mZW5j
ZSA9IC0xLCBuX2ZlbmNlID0gLTE7CisJdW5zaWduZWQgbG9uZyBjb3VudCA9IDA7CisJdWludDMy
X3QgKm1hcDsKKwlpbnQgbjsKKworCXdoaWxlICghUkVBRF9PTkNFKCpjdGwpKSB7CisJCXN0cnVj
dCBkcm1faTkxNV9nZW1fZXhlY2J1ZmZlcjIgZXhlY2J1ZiA9IHsKKwkJCS5idWZmZXJzX3B0ciA9
IHRvX3VzZXJfcG9pbnRlcigmbmV4dCksCisJCQkuYnVmZmVyX2NvdW50ID0gMSwKKwkJCS5yc3Zk
MSA9IGN0eCwKKwkJCS5yc3ZkMiA9IC0xLAorCQkJLmZsYWdzID0gZS0+ZmxhZ3MsCisJCX07CisK
KwkJaWYgKGZsYWdzICYgRl9GTE9XKSB7CisJCQlleGVjYnVmLnJzdmQyID0KKwkJCQlzd19zeW5j
X3RpbWVsaW5lX2NyZWF0ZV9mZW5jZSh0aW1lbGluZSwgY291bnQpOworCQkJZXhlY2J1Zi5mbGFn
cyB8PSBJOTE1X0VYRUNfRkVOQ0VfSU47CisJCX0KKworCQlleGVjYnVmLmZsYWdzIHw9IEk5MTVf
RVhFQ19GRU5DRV9PVVQ7CisJCWdlbV9leGVjYnVmX3dyKGk5MTUsICZleGVjYnVmKTsKKwkJbl9m
ZW5jZSA9IGV4ZWNidWYucnN2ZDIgPj4gMzI7CisJCWV4ZWNidWYuZmxhZ3MgJj0gfihJOTE1X0VY
RUNfRkVOQ0VfT1VUIHwgSTkxNV9FWEVDX0ZFTkNFX0lOKTsKKwkJZm9yIChuID0gMTsgbiA8IGJh
dGNoZXNfcGVyX2ZyYW1lOyBuKyspCisJCQlnZW1fZXhlY2J1ZihpOTE1LCAmZXhlY2J1Zik7CisK
KwkJZXhlY2J1Zi5idWZmZXJzX3B0ciA9IHRvX3VzZXJfcG9pbnRlcigmdHMpOworCQlleGVjYnVm
LmJhdGNoX3N0YXJ0X29mZnNldCA9IDIwNDg7CisJCWdlbV9leGVjYnVmKGk5MTUsICZleGVjYnVm
KTsKKworCQlpZiAoZmxhZ3MgJiBGX1BBQ0UgJiYgcF9mZW5jZSAhPSAtMSkgeworCQkJc3RydWN0
IHBvbGxmZCBwZmQgPSB7CisJCQkJLmZkID0gcF9mZW5jZSwKKwkJCQkuZXZlbnRzID0gUE9MTElO
LAorCQkJfTsKKwkJCXBvbGwoJnBmZCwgMSwgLTEpOworCQl9CisJCWNsb3NlKHBfZmVuY2UpOwor
CQljbG9zZShleGVjYnVmLnJzdmQyKTsKKworCQlpZiAoZmxhZ3MgJiBGX1NZTkMpIHsKKwkJCXN0
cnVjdCBwb2xsZmQgcGZkID0geworCQkJCS5mZCA9IG5fZmVuY2UsCisJCQkJLmV2ZW50cyA9IFBP
TExJTiwKKwkJCX07CisJCQlwb2xsKCZwZmQsIDEsIC0xKTsKKwkJfQorCisJCWlndF9zd2FwKHBy
ZXYsIG5leHQpOworCQlpZ3Rfc3dhcChwX2ZlbmNlLCBuX2ZlbmNlKTsKKwkJY291bnQrKzsKKwl9
CisJY2xvc2UocF9mZW5jZSk7CisKKwlnZW1fY2xvc2UoaTkxNSwgbmV4dC5oYW5kbGUpOworCWdl
bV9jbG9zZShpOTE1LCBwcmV2LmhhbmRsZSk7CisKKwlnZW1fc3luYyhpOTE1LCB0cy5oYW5kbGUp
OworCW1hcCA9IGdlbV9tbWFwX19kZXZpY2VfY29oZXJlbnQoaTkxNSwgdHMuaGFuZGxlLCAwLCA0
MDk2LCBQUk9UX1dSSVRFKTsKKwlmb3IgKG4gPSAxOyBuIDwgbWluKGNvdW50LCA1MTIpOyBuKysp
IHsKKwkJaWd0X2Fzc2VydChtYXBbbl0pOworCQltYXBbbiAtIDFdID0gbWFwW25dIC0gbWFwW24g
LSAxXTsKKwl9CisJcXNvcnQobWFwLCAtLW4sIHNpemVvZigqbWFwKSwgY21wX3UzMik7CisJKm91
dCA9IHRpY2tzX3RvX25zKGk5MTUsIG1hcFtuIC8gMl0pOworCW11bm1hcChtYXAsIDQwOTYpOwor
CisJZ2VtX2Nsb3NlKGk5MTUsIHRzLmhhbmRsZSk7Cit9CisKK3N0YXRpYyBpbnQgY21wX3VsKGNv
bnN0IHZvaWQgKkEsIGNvbnN0IHZvaWQgKkIpCit7CisJY29uc3QgdW5zaWduZWQgbG9uZyAqYSA9
IEEsICpiID0gQjsKKworCWlmICgqYSA8ICpiKQorCQlyZXR1cm4gLTE7CisJZWxzZSBpZiAoKmEg
PiAqYikKKwkJcmV0dXJuIDE7CisJZWxzZQorCQlyZXR1cm4gMDsKK30KKworc3RhdGljIHZvaWQg
ZmFpcm5lc3MoaW50IGk5MTUsCisJCSAgICAgY29uc3Qgc3RydWN0IGludGVsX2V4ZWN1dGlvbl9l
bmdpbmUyICplLAorCQkgICAgIGludCB0aW1lb3V0LCB1bnNpZ25lZCBpbnQgZmxhZ3MpCit7CisJ
Y29uc3QgaW50IGZyYW1lX25zID0gMTY2NjYgKiAxMDAwOworCWNvbnN0IGludCBmZW5jZV9ucyA9
IGZsYWdzICYgRl9IQUxGID8gMiAqIGZyYW1lX25zIDogZnJhbWVfbnM7CisJdW5zaWduZWQgbG9u
ZyAqcmVzdWx0OworCisJaWd0X3JlcXVpcmUoaW50ZWxfZ2VuKGludGVsX2dldF9kcm1fZGV2aWQo
aTkxNSkpID49IDgpOworCWlndF9yZXF1aXJlKGdlbV9jbGFzc19oYXNfbXV0YWJsZV9zdWJtaXNz
aW9uKGk5MTUsIGUtPmNsYXNzKSk7CisKKwlyZXN1bHQgPSBtbWFwKE5VTEwsIDQwOTYsIFBST1Rf
V1JJVEUsIE1BUF9TSEFSRUQgfCBNQVBfQU5PTiwgLTEsIDApOworCisJZm9yIChpbnQgbiA9IDI7
IG4gPD0gMTY7IG4gPDw9IDEpIHsKKwkJaW50IHRpbWVsaW5lID0gc3dfc3luY190aW1lbGluZV9j
cmVhdGUoKTsKKwkJaW50IG5mZW5jZXMgPSB0aW1lb3V0ICogTlNFQ19QRVJfU0VDIC8gZmVuY2Vf
bnMgKyAxOworCQljb25zdCBpbnQgbmNoaWxkID0gbiAtIDE7IC8qIG9kZCBmb3IgZWFzeSBtZWRp
YW5zICovCisJCWNvbnN0IGludCBjaGlsZF9ucyA9IGZyYW1lX25zIC8gKG5jaGlsZCArICEhKGZs
YWdzICYgRl9TUEFSRSkpOworCQljb25zdCBpbnQgbG8gPSBuY2hpbGQgLyA0OworCQljb25zdCBp
bnQgaGkgPSAoMyAqIG5jaGlsZCArIDMpIC8gNCAtIDE7CisJCXN0cnVjdCBpZ3RfbWVhbiBtOwor
CisJCW1lbXNldChyZXN1bHQsIDAsIChuY2hpbGQgKyAxKSAqIHNpemVvZihyZXN1bHRbMF0pKTsK
KwkJaWd0X2ZvcmsoY2hpbGQsIG5jaGlsZCkgeworCQkJdWludDMyX3QgY3R4ID0gZ2VtX2NvbnRl
eHRfY2xvbmVfd2l0aF9lbmdpbmVzKGk5MTUsIDApOworCisJCQlmYWlyX2NoaWxkKGk5MTUsIGN0
eCwgZSwgY2hpbGRfbnMsCisJCQkJICAgdGltZW91dCwgdGltZWxpbmUsIGZsYWdzLAorCQkJCSAg
ICZyZXN1bHRbbmNoaWxkXSwKKwkJCQkgICAmcmVzdWx0W2NoaWxkXSk7CisKKwkJCWdlbV9jb250
ZXh0X2Rlc3Ryb3koaTkxNSwgY3R4KTsKKwkJfQorCisJCXdoaWxlIChuZmVuY2VzLS0pIHsKKwkJ
CXN0cnVjdCB0aW1lc3BlYyB0diA9IHsgLnR2X25zZWMgPSBmZW5jZV9ucyB9OworCQkJbmFub3Ns
ZWVwKCZ0diwgTlVMTCk7CisJCQlzd19zeW5jX3RpbWVsaW5lX2luYyh0aW1lbGluZSwgMSk7CisJ
CX0KKwkJcmVzdWx0W25jaGlsZF0gPSAxOworCQlmb3IgKGludCBjaGlsZCA9IDA7IGNoaWxkIDwg
bmNoaWxkOyBjaGlsZCsrKSB7CisJCQl3aGlsZSAoIVJFQURfT05DRShyZXN1bHRbY2hpbGRdKSkg
eworCQkJCXN0cnVjdCB0aW1lc3BlYyB0diA9IHsgLnR2X25zZWMgPSBmZW5jZV9ucyB9OworCQkJ
CW5hbm9zbGVlcCgmdHYsIE5VTEwpOworCQkJCXN3X3N5bmNfdGltZWxpbmVfaW5jKHRpbWVsaW5l
LCAxKTsKKwkJCX0KKwkJfQorCQlpZ3Rfd2FpdGNoaWxkcmVuKCk7CisJCWNsb3NlKHRpbWVsaW5l
KTsKKworCQlpZ3RfbWVhbl9pbml0KCZtKTsKKwkJZm9yIChpbnQgY2hpbGQgPSAwOyBjaGlsZCA8
IG5jaGlsZDsgY2hpbGQrKykKKwkJCWlndF9tZWFuX2FkZCgmbSwgcmVzdWx0W2NoaWxkXSk7CisK
KwkJcXNvcnQocmVzdWx0LCBuY2hpbGQsIHNpemVvZigqcmVzdWx0KSwgY21wX3VsKTsKKwkJaWd0
X2luZm8oIiVkIGNsaWVudHMsIHJhbmdlOiBbJS4xZiwgJS4xZl0sIGlxcjogWyUuMWYsICUuMWZd
LCBtZWRpYW46ICUuMWYsIG1lYW46ICUuMWYgwrEgJS4yZiBtc1xuIiwKKwkJCSBuY2hpbGQsCisJ
CQkgMWUtNiAqIHJlc3VsdFswXSwgIDFlLTYgKiByZXN1bHRbbmNoaWxkIC0gMV0sCisJCQkgMWUt
NiAqIHJlc3VsdFtsb10sIDFlLTYgKiByZXN1bHRbaGldLAorCQkJIDFlLTYgKiByZXN1bHRbbmNo
aWxkIC8gMl0sCisJCQkgMWUtNiAqIGlndF9tZWFuX2dldCgmbSksCisJCQkgMWUtNiAqIHNxcnQo
aWd0X21lYW5fZ2V0X3ZhcmlhbmNlKCZtKSkpOworCisjaWYgMAorCQkvKiBNZWFuIHdpdGhpbiAx
MCUgb2YgdGFyZ2V0ICovCisJCWlndF9hc3NlcnQoIDkgKiBpZ3RfbWVhbl9nZXQoJm0pID4gMTAg
KiBmcmFtZV9ucyAmJgorCQkJICAgMTAgKiBpZ3RfbWVhbl9nZXQoJm0pIDwgIDkgKiBmcmFtZV9u
cyk7CisKKwkJLyogVmFyaWFuY2UgW2ludGVyLXF1YXJ0aWxlIHJhbmdlXSBpcyBsZXNzIHRoYW4g
MzMlIG9mIG1lZGlhbiAqLworCQlpZ3RfYXNzZXJ0KDMgKiByZXN1bHRbaGldIC0gcmVzdWx0W2xv
XSA8IHJlc3VsdFtuY2hpbGQgLyAyXSk7CisjZW5kaWYKKwl9CisKKwltdW5tYXAocmVzdWx0LCA0
MDk2KTsKK30KKwogI2RlZmluZSB0ZXN0X2VhY2hfZW5naW5lKFQsIGk5MTUsIGUpIFwKIAlpZ3Rf
c3VidGVzdF93aXRoX2R5bmFtaWMoVCkgX19mb3JfZWFjaF9waHlzaWNhbF9lbmdpbmUoaTkxNSwg
ZSkgXAogCQlpZ3RfZHluYW1pY19mKCIlcyIsIGUtPm5hbWUpCkBAIC0yNTg5LDYgKzMwMjIsMjEg
QEAgaWd0X21haW4KIAkJdGVzdF9lYWNoX2VuZ2luZV9zdG9yZSgicHJvbW90aW9uIiwgZmQsIGUp
CiAJCQlwcm9tb3Rpb24oZmQsIGUtPmZsYWdzKTsKIAorCQl0ZXN0X2VhY2hfZW5naW5lX3N0b3Jl
KCJmYWlyLW5vbmUiLCBmZCwgZSkKKwkJCWZhaXJuZXNzKGZkLCBlLCAyLCAwKTsKKwkJdGVzdF9l
YWNoX2VuZ2luZV9zdG9yZSgiZmFpci1wYWNlIiwgZmQsIGUpCisJCQlmYWlybmVzcyhmZCwgZSwg
MiwgRl9QQUNFKTsKKwkJdGVzdF9lYWNoX2VuZ2luZV9zdG9yZSgiZmFpci1zeW5jIiwgZmQsIGUp
CisJCQlmYWlybmVzcyhmZCwgZSwgMiwgRl9TWU5DKTsKKwkJdGVzdF9lYWNoX2VuZ2luZV9zdG9y
ZSgiZmFpci1zb2xvIiwgZmQsIGUpCisJCQlmYWlybmVzcyhmZCwgZSwgMiwgRl9TWU5DIHwgRl9T
T0xPKTsKKwkJdGVzdF9lYWNoX2VuZ2luZV9zdG9yZSgiZmFpci1mbG93IiwgZmQsIGUpCisJCQlm
YWlybmVzcyhmZCwgZSwgMiwgRl9QQUNFIHwgRl9GTE9XKTsKKwkJdGVzdF9lYWNoX2VuZ2luZV9z
dG9yZSgiZmFpci1zcGFyZSIsIGZkLCBlKQorCQkJZmFpcm5lc3MoZmQsIGUsIDIsIEZfUEFDRSB8
IEZfRkxPVyB8IEZfU1BBUkUpOworCQl0ZXN0X2VhY2hfZW5naW5lX3N0b3JlKCJmYWlyLWhhbGYi
LCBmZCwgZSkKKwkJCWZhaXJuZXNzKGZkLCBlLCAyLCBGX1BBQ0UgfCBGX0ZMT1cgfCBGX0hBTEYp
OworCiAJCWlndF9zdWJ0ZXN0X2dyb3VwIHsKIAkJCWlndF9maXh0dXJlIHsKIAkJCQlpZ3RfcmVx
dWlyZShnZW1fc2NoZWR1bGVyX2hhc19wcmVlbXB0aW9uKGZkKSk7Ci0tIAoyLjI3LjAucmMyCgpf
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpJbnRlbC1nZngg
bWFpbGluZyBsaXN0CkludGVsLWdmeEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0
cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9pbnRlbC1nZngK

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 58D77D2749
	for <lists+intel-gfx@lfdr.de>; Thu, 10 Oct 2019 12:37:12 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 8C03D6EAEB;
	Thu, 10 Oct 2019 10:37:10 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id A670E6EAEB
 for <intel-gfx@lists.freedesktop.org>; Thu, 10 Oct 2019 10:37:09 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18789012-1500050 
 for multiple; Thu, 10 Oct 2019 11:36:58 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Thu, 10 Oct 2019 11:36:57 +0100
Message-Id: <20191010103657.6961-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH] drm/i915/selftests: Check that registers are
 preserved between virtual engines
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

TWFrZSBzdXJlIHRoYXQgd2UgY29weSBhY3Jvc3MgdGhlIHJlZ2lzdGVycyBmcm9tIG9uZSBlbmdp
bmUgdG8gdGhlIG5leHQsCmFzIHdlIGhvcCBhcm91bmQgYSB2aXJ0dWFsIGVuZ2luZS4KClNpZ25l
ZC1vZmYtYnk6IENocmlzIFdpbHNvbiA8Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPgpDYzogVHZy
dGtvIFVyc3VsaW4gPHR2cnRrby51cnN1bGluQGludGVsLmNvbT4KLS0tCiBkcml2ZXJzL2dwdS9k
cm0vaTkxNS9ndC9zZWxmdGVzdF9scmMuYyB8IDE3NiArKysrKysrKysrKysrKysrKysrKysrKysr
CiAxIGZpbGUgY2hhbmdlZCwgMTc2IGluc2VydGlvbnMoKykKCmRpZmYgLS1naXQgYS9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVzdF9scmMuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0
L3NlbGZ0ZXN0X2xyYy5jCmluZGV4IDE5OGNmMmY3NTRmNC4uZWJiMWU5YjRlNzFkIDEwMDY0NAot
LS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVzdF9scmMuYworKysgYi9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVzdF9scmMuYwpAQCAtMTk1Miw2ICsxOTUyLDE4MSBAQCBz
dGF0aWMgaW50IGxpdmVfdmlydHVhbF9lbmdpbmUodm9pZCAqYXJnKQogCXJldHVybiAwOwogfQog
CitzdGF0aWMgc3RydWN0IGk5MTVfdm1hICpjcmVhdGVfc2NyYXRjaChzdHJ1Y3QgaW50ZWxfZ3Qg
Kmd0KQoreworCXN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmo7CisJc3RydWN0IGk5MTVf
dm1hICp2bWE7CisJaW50IGVycjsKKworCW9iaiA9IGk5MTVfZ2VtX29iamVjdF9jcmVhdGVfaW50
ZXJuYWwoZ3QtPmk5MTUsIFBBR0VfU0laRSk7CisJaWYgKElTX0VSUihvYmopKQorCQlyZXR1cm4g
RVJSX0NBU1Qob2JqKTsKKworCWk5MTVfZ2VtX29iamVjdF9zZXRfY2FjaGVfY29oZXJlbmN5KG9i
aiwgSTkxNV9DQUNISU5HX0NBQ0hFRCk7CisKKwl2bWEgPSBpOTE1X3ZtYV9pbnN0YW5jZShvYmos
ICZndC0+Z2d0dC0+dm0sIE5VTEwpOworCWlmIChJU19FUlIodm1hKSkgeworCQlpOTE1X2dlbV9v
YmplY3RfcHV0KG9iaik7CisJCXJldHVybiB2bWE7CisJfQorCisJZXJyID0gaTkxNV92bWFfcGlu
KHZtYSwgMCwgMCwgUElOX0dMT0JBTCk7CisJaWYgKGVycikgeworCQlpOTE1X2dlbV9vYmplY3Rf
cHV0KG9iaik7CisJCXJldHVybiBFUlJfUFRSKGVycik7CisJfQorCisJcmV0dXJuIHZtYTsKK30K
Kworc3RhdGljIGludCBwcmVzZXJ2ZWRfdmlydHVhbF9lbmdpbmUoc3RydWN0IGRybV9pOTE1X3By
aXZhdGUgKmk5MTUsCisJCQkJICAgIHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKipzaWJsaW5ncywK
KwkJCQkgICAgdW5zaWduZWQgaW50IG5zaWJsaW5nKQoreworI2RlZmluZSBDU19HUFIoZW5naW5l
LCBuKSAoKGVuZ2luZSktPm1taW9fYmFzZSArIDB4NjAwICsgKG4pICogNCkKKworCXN0cnVjdCBp
OTE1X3JlcXVlc3QgKmxhc3QgPSBOVUxMOworCXN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICpjdHg7
CisJc3RydWN0IGludGVsX2NvbnRleHQgKnZlOworCXN0cnVjdCBpOTE1X3ZtYSAqc2NyYXRjaDsK
KwlzdHJ1Y3QgaWd0X2xpdmVfdGVzdCB0OworCWNvbnN0IGludCBudW1fZ3ByID0gMTYgKiAyOyAv
KiBlYWNoIEdQUiBpcyAyIGR3b3JkcyAqLworCXVuc2lnbmVkIGludCBuOworCWludCBlcnIgPSAw
OworCisJY3R4ID0ga2VybmVsX2NvbnRleHQoaTkxNSk7CisJaWYgKCFjdHgpCisJCXJldHVybiAt
RU5PTUVNOworCisJc2NyYXRjaCA9IGNyZWF0ZV9zY3JhdGNoKHNpYmxpbmdzWzBdLT5ndCk7CisJ
aWYgKElTX0VSUihzY3JhdGNoKSkgeworCQllcnIgPSBQVFJfRVJSKHNjcmF0Y2gpOworCQlnb3Rv
IG91dF9jbG9zZTsKKwl9CisKKwl2ZSA9IGludGVsX2V4ZWNsaXN0c19jcmVhdGVfdmlydHVhbChj
dHgsIHNpYmxpbmdzLCBuc2libGluZyk7CisJaWYgKElTX0VSUih2ZSkpIHsKKwkJZXJyID0gUFRS
X0VSUih2ZSk7CisJCWdvdG8gb3V0X3NjcmF0Y2g7CisJfQorCisJZXJyID0gaW50ZWxfY29udGV4
dF9waW4odmUpOworCWlmIChlcnIpCisJCWdvdG8gb3V0X3B1dDsKKworCWVyciA9IGlndF9saXZl
X3Rlc3RfYmVnaW4oJnQsIGk5MTUsIF9fZnVuY19fLCB2ZS0+ZW5naW5lLT5uYW1lKTsKKwlpZiAo
ZXJyKQorCQlnb3RvIG91dF91bnBpbjsKKworCWZvciAobiA9IDA7IG4gPCBudW1fZ3ByOyBuKysp
IHsKKwkJc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lID0gc2libGluZ3NbbiAlIG5zaWJs
aW5nXTsKKwkJc3RydWN0IGk5MTVfcmVxdWVzdCAqcnE7CisJCXUzMiAqY3M7CisKKwkJcnEgPSBp
OTE1X3JlcXVlc3RfY3JlYXRlKHZlKTsKKwkJaWYgKElTX0VSUihycSkpIHsKKwkJCWVyciA9IFBU
Ul9FUlIocnEpOworCQkJZ290byBvdXRfZW5kOworCQl9CisKKwkJaTkxNV9yZXF1ZXN0X3B1dChs
YXN0KTsKKwkJbGFzdCA9IGk5MTVfcmVxdWVzdF9nZXQocnEpOworCisJCWNzID0gaW50ZWxfcmlu
Z19iZWdpbihycSwgOCk7CisJCWlmIChJU19FUlIoY3MpKSB7CisJCQlpOTE1X3JlcXVlc3RfYWRk
KHJxKTsKKwkJCWVyciA9IFBUUl9FUlIoY3MpOworCQkJZ290byBvdXRfZW5kOworCQl9CisKKwkJ
KmNzKysgPSBNSV9TVE9SRV9SRUdJU1RFUl9NRU1fR0VOOCB8IE1JX1VTRV9HR1RUOworCQkqY3Mr
KyA9IENTX0dQUihlbmdpbmUsIG4pOworCQkqY3MrKyA9IGk5MTVfZ2d0dF9vZmZzZXQoc2NyYXRj
aCkgKyBuICogc2l6ZW9mKHUzMik7CisJCSpjcysrID0gMDsKKworCQkqY3MrKyA9IE1JX0xPQURf
UkVHSVNURVJfSU1NKDEpOworCQkqY3MrKyA9IENTX0dQUihlbmdpbmUsIChuICsgMSkgJSBudW1f
Z3ByKTsKKwkJKmNzKysgPSBuICsgMTsKKworCQkqY3MrKyA9IE1JX05PT1A7CisJCWludGVsX3Jp
bmdfYWR2YW5jZShycSwgY3MpOworCisJCS8qIFJlc3RyaWN0IHRoaXMgcmVxdWVzdCB0byBydW4g
b24gYSBwYXJ0aWN1bGFyIGVuZ2luZSAqLworCQlycS0+ZXhlY3V0aW9uX21hc2sgPSBlbmdpbmUt
Pm1hc2s7CisJCWk5MTVfcmVxdWVzdF9hZGQocnEpOworCX0KKworCWlmIChpOTE1X3JlcXVlc3Rf
d2FpdChsYXN0LCAwLCBIWiAvIDUpIDwgMCkgeworCQllcnIgPSAtRVRJTUU7CisJfSBlbHNlIHsK
KwkJdTMyICptYXAgPSBpOTE1X2dlbV9vYmplY3RfcGluX21hcChzY3JhdGNoLT5vYmosIEk5MTVf
TUFQX1dCKTsKKworCQlmb3IgKG4gPSAwOyBuIDwgbnVtX2dwcjsgbisrKSB7CisJCQlpZiAobWFw
W25dICE9IG4pIHsKKwkJCQlwcl9lcnIoIkluY29ycmVjdCB2YWx1ZVslZF0gZm91bmQgZm9yIEdQ
UlslZF1cbiIsCisJCQkJICAgICAgIG1hcFtuXSwgbik7CisJCQkJZXJyID0gLUVJTlZBTDsKKwkJ
CQlicmVhazsKKwkJCX0KKwkJfQorCisJCWk5MTVfZ2VtX29iamVjdF91bnBpbl9tYXAoc2NyYXRj
aC0+b2JqKTsKKwl9CisKK291dF9lbmQ6CisJaWYgKGlndF9saXZlX3Rlc3RfZW5kKCZ0KSkKKwkJ
ZXJyID0gLUVJTzsKKwlpOTE1X3JlcXVlc3RfcHV0KGxhc3QpOworb3V0X3VucGluOgorCWludGVs
X2NvbnRleHRfdW5waW4odmUpOworb3V0X3B1dDoKKwlpbnRlbF9jb250ZXh0X3B1dCh2ZSk7Citv
dXRfc2NyYXRjaDoKKwlpOTE1X3ZtYV91bnBpbl9hbmRfcmVsZWFzZSgmc2NyYXRjaCwgMCk7Citv
dXRfY2xvc2U6CisJa2VybmVsX2NvbnRleHRfY2xvc2UoY3R4KTsKKwlyZXR1cm4gZXJyOworCisj
dW5kZWYgQ1NfR1BSCit9CisKK3N0YXRpYyBpbnQgbGl2ZV92aXJ0dWFsX3ByZXNlcnZlZCh2b2lk
ICphcmcpCit7CisJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUgPSBhcmc7CisJc3RydWN0
IGludGVsX2VuZ2luZV9jcyAqc2libGluZ3NbTUFYX0VOR0lORV9JTlNUQU5DRSArIDFdOworCXN0
cnVjdCBpbnRlbF9ndCAqZ3QgPSAmaTkxNS0+Z3Q7CisJdW5zaWduZWQgaW50IGNsYXNzLCBpbnN0
OworCisJLyoKKwkgKiBDaGVjayB0aGF0IHRoZSBjb250ZXh0IGltYWdlIHJldGFpbnMgbm9uLXBy
aXZpbGVnZWQgKHVzZXIpIHJlZ2lzdGVycworCSAqIGZyb20gb25lIGVuZ2luZSB0byB0aGUgbmV4
dC4gRm9yIHRoaXMgd2UgY2hlY2sgdGhhdCB0aGUgQ1NfR1BSCisJICogYXJlIHByZXNlcnZlZC4K
KwkgKi8KKworCWlmIChVU0VTX0dVQ19TVUJNSVNTSU9OKGk5MTUpKQorCQlyZXR1cm4gMDsKKwor
CWZvciAoY2xhc3MgPSAwOyBjbGFzcyA8PSBNQVhfRU5HSU5FX0NMQVNTOyBjbGFzcysrKSB7CisJ
CWludCBuc2libGluZywgZXJyOworCisJCW5zaWJsaW5nID0gMDsKKwkJZm9yIChpbnN0ID0gMDsg
aW5zdCA8PSBNQVhfRU5HSU5FX0lOU1RBTkNFOyBpbnN0KyspIHsKKwkJCWlmICghZ3QtPmVuZ2lu
ZV9jbGFzc1tjbGFzc11baW5zdF0pCisJCQkJY29udGludWU7CisKKwkJCXNpYmxpbmdzW25zaWJs
aW5nKytdID0gZ3QtPmVuZ2luZV9jbGFzc1tjbGFzc11baW5zdF07CisJCX0KKwkJaWYgKG5zaWJs
aW5nIDwgMikKKwkJCWNvbnRpbnVlOworCisJCWVyciA9IHByZXNlcnZlZF92aXJ0dWFsX2VuZ2lu
ZShpOTE1LCBzaWJsaW5ncywgbnNpYmxpbmcpOworCQlpZiAoZXJyKQorCQkJcmV0dXJuIGVycjsK
Kwl9CisKKwlyZXR1cm4gMDsKK30KKwogc3RhdGljIGludCBtYXNrX3ZpcnR1YWxfZW5naW5lKHN0
cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1LAogCQkJICAgICAgIHN0cnVjdCBpbnRlbF9lbmdp
bmVfY3MgKipzaWJsaW5ncywKIAkJCSAgICAgICB1bnNpZ25lZCBpbnQgbnNpYmxpbmcpCkBAIC0y
Mjc2LDYgKzI0NTEsNyBAQCBpbnQgaW50ZWxfZXhlY2xpc3RzX2xpdmVfc2VsZnRlc3RzKHN0cnVj
dCBkcm1faTkxNV9wcml2YXRlICppOTE1KQogCQlTVUJURVNUKGxpdmVfcHJlZW1wdF9oYW5nKSwK
IAkJU1VCVEVTVChsaXZlX3ByZWVtcHRfc21va2UpLAogCQlTVUJURVNUKGxpdmVfdmlydHVhbF9l
bmdpbmUpLAorCQlTVUJURVNUKGxpdmVfdmlydHVhbF9wcmVzZXJ2ZWQpLAogCQlTVUJURVNUKGxp
dmVfdmlydHVhbF9tYXNrKSwKIAkJU1VCVEVTVChsaXZlX3ZpcnR1YWxfYm9uZCksCiAJfTsKLS0g
CjIuMjMuMAoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18K
SW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0
dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

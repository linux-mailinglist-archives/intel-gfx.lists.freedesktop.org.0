Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id C5B60390B2B
	for <lists+intel-gfx@lfdr.de>; Tue, 25 May 2021 23:18:23 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 14D396EB4F;
	Tue, 25 May 2021 21:18:11 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mail-pf1-x42e.google.com (mail-pf1-x42e.google.com
 [IPv6:2607:f8b0:4864:20::42e])
 by gabe.freedesktop.org (Postfix) with ESMTPS id BB04A6EB4D
 for <intel-gfx@lists.freedesktop.org>; Tue, 25 May 2021 21:18:06 +0000 (UTC)
Received: by mail-pf1-x42e.google.com with SMTP id q25so6558340pfn.1
 for <intel-gfx@lists.freedesktop.org>; Tue, 25 May 2021 14:18:06 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=jlekstrand-net.20150623.gappssmtp.com; s=20150623;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=AL5uNnVtUk1C+mH/6NWLJWmNdaxYP0PjQJbDEuxpySk=;
 b=Ips17hc7MmLO98L0dy/V0AU1V8nE0dVv+kG0bCGj7sw+lKob4YKDVH3SnE7SlXOTs9
 ovBF76lHY2xIt1dJkpVr/BWyLolgE+D7zCwDUqwy2vw8JLDFdLPPA9lDn0bfxGEuXL02
 nUmgX6P+xwUuB+IcNpuVEJEx1diCAnveB/E1Ia3cNUpc6RB9aW3O2REA+fNv5VaKuFHy
 4N/TCoLUGpT4ZRhEnMzE4uWBzdWpBKKbZc4dMZ9OC/2OvaGk49J5V/1+yTxw7bgM3/vk
 Tgi6MM46bN06NQfz4DZ2wUm642M/jr+MSWg+vDLcrgsx8s+0ch4FqmHKLL+09hHU26qc
 QWjA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=AL5uNnVtUk1C+mH/6NWLJWmNdaxYP0PjQJbDEuxpySk=;
 b=TZmuH0j38bSO1DoscOVsfT/rRuqzUal7CuHiyDn4A+ab5CtXARqaNcfjkMmh50q+IX
 chXttfJXq2cs+fUQpFjBzsDW3dqudtGxMzmWvJgmnezATkNcKybBIhHozBW1sB57W3w+
 h5XHSwgRcZ5PGv4sq07mBvQvYvHtmauel/C/usfw61B4qn+Osj9yMoayqK0Zm+cGjyQV
 Z12wP9HwcuvX7i5uv+5Rt04SawL4LDduEDXrjtChUULUQ3iuXXabFzvlIVlqOaUd8318
 fDRMsucEO3L4qlurN5szot3c56pxmAKBsieWu1i2sqpavBtujV/GUm4tV4MoY7+s/ZLU
 GVhg==
X-Gm-Message-State: AOAM530zb4qjlQ/ZK8n7QdDVQl3BjCjNzbpl0DHg9kS8zCefwETc+Svl
 U/qtFFGyZBCgO7My4Q9K6ndzYA==
X-Google-Smtp-Source: ABdhPJxncSd9JR6bFaeenqN0OOWlRPCuzBhpn4lfcwfCHKIL+Cg/qQq3nO4vOihovDpDz6VCpwh94Q==
X-Received: by 2002:a63:224d:: with SMTP id t13mr21209550pgm.283.1621977486263; 
 Tue, 25 May 2021 14:18:06 -0700 (PDT)
Received: from omlet.lan ([134.134.139.83])
 by smtp.gmail.com with ESMTPSA id e186sm14342278pfa.145.2021.05.25.14.18.04
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Tue, 25 May 2021 14:18:05 -0700 (PDT)
From: Jason Ekstrand <jason@jlekstrand.net>
To: dri-devel@lists.freedesktop.org,
	intel-gfx@lists.freedesktop.org
Date: Tue, 25 May 2021 16:17:49 -0500
Message-Id: <20210525211753.1086069-4-jason@jlekstrand.net>
X-Mailer: git-send-email 2.31.1
In-Reply-To: <20210525211753.1086069-1-jason@jlekstrand.net>
References: <20210525211753.1086069-1-jason@jlekstrand.net>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 3/7] dma-buf: Add
 dma_resv_get_singleton_unlocked (v5)
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Daniel Vetter <daniel.vetter@ffwll.ch>,
 =?UTF-8?q?Christian=20K=C3=B6nig?= <christian.koenig@amd.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

QWRkIGEgaGVscGVyIGZ1bmN0aW9uIHRvIGdldCBhIHNpbmdsZSBmZW5jZSByZXByZXNlbnRpbmcK
YWxsIGZlbmNlcyBpbiBhIGRtYV9yZXN2IG9iamVjdC4KClRoaXMgZmVuY2UgaXMgZWl0aGVyIHRo
ZSBvbmx5IG9uZSBpbiB0aGUgb2JqZWN0IG9yIGFsbCBub3QKc2lnbmFsZWQgZmVuY2VzIG9mIHRo
ZSBvYmplY3QgaW4gYSBmbGF0dGVkIG91dCBkbWFfZmVuY2VfYXJyYXkuCgp2MiAoSmFzb24gRWtz
dHJhbmQpOgogLSBUYWtlIHJlZmVyZW5jZSBvZiBmZW5jZXMgYm90aCBmb3IgY3JlYXRpbmcgdGhl
IGRtYV9mZW5jZV9hcnJheSBhbmQgaW4KICAgdGhlIGNhc2Ugd2hlcmUgd2UgcmV0dXJuIG9uZSBm
ZW5jZS4KIC0gSGFuZGxlIHRoZSBjYXNlIHdoZXJlIGRtYV9yZXN2X2dldF9saXN0KCkgcmV0dXJu
cyBOVUxMCgp2MyAoSmFzb24gRWtzdHJhbmQpOgogLSBBZGQgYW4gX3JjdSBzdWZmaXggYmVjYXVz
ZSBpdCBpcyByZWFkLW9ubHkKIC0gUmV3cml0ZSB0byB1c2UgZG1hX3Jlc3ZfZ2V0X2ZlbmNlc19y
Y3Ugc28gaXQncyBSQ1Utc2FmZQogLSBBZGQgYW4gRVhQT1JUX1NZTUJPTF9HUEwgZGVjbGFyYXRp
b24KIC0gUmUtYXV0aG9yIHRoZSBwYXRjaCB0byBKYXNvbiBzaW5jZSB2ZXJ5IGxpdHRsZSBpcyBs
ZWZ0IG9mIENocmlzdGlhbgogICBLw7ZuaWcncyBvcmlnaW5hbCBwYXRjaAogLSBSZW1vdmUgdGhl
IGV4dHJhIGZlbmNlIGFyZ3VtZW50Cgp2NCAoSmFzb24gRWtzdHJhbmQpOgogLSBSZXN0b3JlIHRo
ZSBleHRyYSBmZW5jZSBhcmd1bWVudAoKdjUgKERhbmllbCBWZXR0ZXIpOgogLSBSZW5hbWUgZnJv
bSBfcmN1IHRvIF91bmxvY2tlZCBzaW5jZSBpdCBkb2Vzbid0IGxlYWsgUkNVIGRldGFpbHMgdG8K
ICAgdGhlIGNhbGxlcgogLSBGaXggZG9jcwogLSBVc2UgRVJSX1BUUiBmb3IgZXJyb3IgaGFuZGxp
bmcgcmF0aGVyIHRoYW4gYW4gb3V0cHV0IGRtYV9mZW5jZSoqCgp2NSAoSmFzb24gRWtzdHJhbmQp
OgogLSBEcm9wIHRoZSBleHRyYSBmZW5jZSBwYXJhbSBhbmQgbGVhdmUgdGhhdCB0byBhIHNlcGFy
YXRlIHBhdGNoCgpTaWduZWQtb2ZmLWJ5OiBKYXNvbiBFa3N0cmFuZCA8amFzb25Aamxla3N0cmFu
ZC5uZXQ+ClJldmlld2VkLWJ5OiBEYW5pZWwgVmV0dGVyIDxkYW5pZWwudmV0dGVyQGZmd2xsLmNo
PgpDYzogQ2hyaXN0aWFuIEvDtm5pZyA8Y2hyaXN0aWFuLmtvZW5pZ0BhbWQuY29tPgpDYzogTWFh
cnRlbiBMYW5raG9yc3QgPG1hYXJ0ZW4ubGFua2hvcnN0QGxpbnV4LmludGVsLmNvbT4KLS0tCiBk
cml2ZXJzL2RtYS1idWYvZG1hLXJlc3YuYyB8IDkyICsrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKysrKysrKysrCiBpbmNsdWRlL2xpbnV4L2RtYS1yZXN2LmggICB8ICAyICsKIDIgZmlsZXMg
Y2hhbmdlZCwgOTQgaW5zZXJ0aW9ucygrKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZG1hLWJ1Zi9k
bWEtcmVzdi5jIGIvZHJpdmVycy9kbWEtYnVmL2RtYS1yZXN2LmMKaW5kZXggZDZmMWVkNGNkNGQ1
NS4uMjNkYjIxODFjOGFkOCAxMDA2NDQKLS0tIGEvZHJpdmVycy9kbWEtYnVmL2RtYS1yZXN2LmMK
KysrIGIvZHJpdmVycy9kbWEtYnVmL2RtYS1yZXN2LmMKQEAgLTMzLDYgKzMzLDggQEAKICAqLwog
CiAjaW5jbHVkZSA8bGludXgvZG1hLXJlc3YuaD4KKyNpbmNsdWRlIDxsaW51eC9kbWEtZmVuY2Ut
Y2hhaW4uaD4KKyNpbmNsdWRlIDxsaW51eC9kbWEtZmVuY2UtYXJyYXkuaD4KICNpbmNsdWRlIDxs
aW51eC9leHBvcnQuaD4KICNpbmNsdWRlIDxsaW51eC9tbS5oPgogI2luY2x1ZGUgPGxpbnV4L3Nj
aGVkL21tLmg+CkBAIC00OSw2ICs1MSwxMSBAQAogICogd3JpdGUtc2lkZSB1cGRhdGVzLgogICov
CiAKKy8qIGRlZXAgZGl2ZSBpbnRvIHRoZSBmZW5jZSBjb250YWluZXJzICovCisjZGVmaW5lIGRt
YV9mZW5jZV9kZWVwX2RpdmVfZm9yX2VhY2goZmVuY2UsIGNoYWluLCBpbmRleCwgaGVhZCkJXAor
CWRtYV9mZW5jZV9jaGFpbl9mb3JfZWFjaChjaGFpbiwgaGVhZCkJCQlcCisJCWRtYV9mZW5jZV9h
cnJheV9mb3JfZWFjaChmZW5jZSwgaW5kZXgsIGNoYWluKQorCiBERUZJTkVfV0RfQ0xBU1MocmVz
ZXJ2YXRpb25fd3dfY2xhc3MpOwogRVhQT1JUX1NZTUJPTChyZXNlcnZhdGlvbl93d19jbGFzcyk7
CiAKQEAgLTUxNyw2ICs1MjQsOTEgQEAgaW50IGRtYV9yZXN2X2dldF9mZW5jZXNfdW5sb2NrZWQo
c3RydWN0IGRtYV9yZXN2ICpvYmosCiB9CiBFWFBPUlRfU1lNQk9MX0dQTChkbWFfcmVzdl9nZXRf
ZmVuY2VzX3VubG9ja2VkKTsKIAorLyoqCisgKiBkbWFfcmVzdl9nZXRfc2luZ2xldG9uX3VubG9j
a2VkIC0gZ2V0IGEgc2luZ2xlIGZlbmNlIGZvciB0aGUgZG1hX3Jlc3Ygb2JqZWN0CisgKiBAb2Jq
OiB0aGUgcmVzZXJ2YXRpb24gb2JqZWN0CisgKgorICogR2V0IGEgc2luZ2xlIGZlbmNlIHJlcHJl
c2VudGluZyBhbGwgdW5zaWduYWxlZCBmZW5jZXMgaW4gdGhlIGRtYV9yZXN2IG9iamVjdAorICog
cGx1cyB0aGUgZ2l2ZW4gZXh0cmEgZmVuY2UuIElmIHdlIGdvdCBvbmx5IG9uZSBmZW5jZSByZXR1
cm4gYSBuZXcKKyAqIHJlZmVyZW5jZSB0byB0aGF0LCBvdGhlcndpc2UgcmV0dXJuIGEgZG1hX2Zl
bmNlX2FycmF5IG9iamVjdC4KKyAqCisgKiBSRVRVUk5TCisgKiBUaGUgc2luZ2xldG9uIGRtYV9m
ZW5jZSBvbiBzdWNjZXNzIG9yIGFuIEVSUl9QVFIgb24gZmFpbHVyZQorICovCitzdHJ1Y3QgZG1h
X2ZlbmNlICpkbWFfcmVzdl9nZXRfc2luZ2xldG9uX3VubG9ja2VkKHN0cnVjdCBkbWFfcmVzdiAq
b2JqKQoreworCXN0cnVjdCBkbWFfZmVuY2UgKnJlc3VsdCwgKipyZXN2X2ZlbmNlcywgKmZlbmNl
LCAqY2hhaW4sICoqZmVuY2VzOworCXN0cnVjdCBkbWFfZmVuY2VfYXJyYXkgKmFycmF5OworCXVu
c2lnbmVkIGludCBudW1fcmVzdl9mZW5jZXMsIG51bV9mZW5jZXM7CisJdW5zaWduZWQgaW50IGVy
ciwgaSwgajsKKworCWVyciA9IGRtYV9yZXN2X2dldF9mZW5jZXNfdW5sb2NrZWQob2JqLCBOVUxM
LCAmbnVtX3Jlc3ZfZmVuY2VzLCAmcmVzdl9mZW5jZXMpOworCWlmIChlcnIpCisJCXJldHVybiBF
UlJfUFRSKGVycik7CisKKwlpZiAobnVtX3Jlc3ZfZmVuY2VzID09IDApCisJCXJldHVybiBOVUxM
OworCisJbnVtX2ZlbmNlcyA9IDA7CisJcmVzdWx0ID0gTlVMTDsKKworCWZvciAoaSA9IDA7IGkg
PCBudW1fcmVzdl9mZW5jZXM7ICsraSkgeworCQlkbWFfZmVuY2VfZGVlcF9kaXZlX2Zvcl9lYWNo
KGZlbmNlLCBjaGFpbiwgaiwgcmVzdl9mZW5jZXNbaV0pIHsKKwkJCWlmIChkbWFfZmVuY2VfaXNf
c2lnbmFsZWQoZmVuY2UpKQorCQkJCWNvbnRpbnVlOworCisJCQlyZXN1bHQgPSBmZW5jZTsKKwkJ
CSsrbnVtX2ZlbmNlczsKKwkJfQorCX0KKworCWlmIChudW1fZmVuY2VzIDw9IDEpIHsKKwkJcmVz
dWx0ID0gZG1hX2ZlbmNlX2dldChyZXN1bHQpOworCQlnb3RvIHB1dF9yZXN2X2ZlbmNlczsKKwl9
CisKKwlmZW5jZXMgPSBrbWFsbG9jX2FycmF5KG51bV9mZW5jZXMsIHNpemVvZihzdHJ1Y3QgZG1h
X2ZlbmNlKiksCisJCQkgICAgICAgR0ZQX0tFUk5FTCk7CisJaWYgKCFmZW5jZXMpIHsKKwkJcmVz
dWx0ID0gRVJSX1BUUigtRU5PTUVNKTsKKwkJZ290byBwdXRfcmVzdl9mZW5jZXM7CisJfQorCisJ
bnVtX2ZlbmNlcyA9IDA7CisJZm9yIChpID0gMDsgaSA8IG51bV9yZXN2X2ZlbmNlczsgKytpKSB7
CisJCWRtYV9mZW5jZV9kZWVwX2RpdmVfZm9yX2VhY2goZmVuY2UsIGNoYWluLCBqLCByZXN2X2Zl
bmNlc1tpXSkgeworCQkJaWYgKCFkbWFfZmVuY2VfaXNfc2lnbmFsZWQoZmVuY2UpKQorCQkJCWZl
bmNlc1tudW1fZmVuY2VzKytdID0gZG1hX2ZlbmNlX2dldChmZW5jZSk7CisJCX0KKwl9CisKKwlp
ZiAobnVtX2ZlbmNlcyA8PSAxKSB7CisJCXJlc3VsdCA9IG51bV9mZW5jZXMgPyBmZW5jZXNbMF0g
OiBOVUxMOworCQlrZnJlZShmZW5jZXMpOworCQlnb3RvIHB1dF9yZXN2X2ZlbmNlczsKKwl9CisK
KwlhcnJheSA9IGRtYV9mZW5jZV9hcnJheV9jcmVhdGUobnVtX2ZlbmNlcywgZmVuY2VzLAorCQkJ
CSAgICAgICBkbWFfZmVuY2VfY29udGV4dF9hbGxvYygxKSwKKwkJCQkgICAgICAgMSwgZmFsc2Up
OworCWlmIChhcnJheSkgeworCQlyZXN1bHQgPSAmYXJyYXktPmJhc2U7CisJfSBlbHNlIHsKKwkJ
cmVzdWx0ID0gRVJSX1BUUigtRU5PTUVNKTsKKwkJd2hpbGUgKG51bV9mZW5jZXMtLSkKKwkJCWRt
YV9mZW5jZV9wdXQoZmVuY2VzW251bV9mZW5jZXNdKTsKKwkJa2ZyZWUoZmVuY2VzKTsKKwl9CisK
K3B1dF9yZXN2X2ZlbmNlczoKKwl3aGlsZSAobnVtX3Jlc3ZfZmVuY2VzLS0pCisJCWRtYV9mZW5j
ZV9wdXQocmVzdl9mZW5jZXNbbnVtX3Jlc3ZfZmVuY2VzXSk7CisJa2ZyZWUocmVzdl9mZW5jZXMp
OworCisJcmV0dXJuIHJlc3VsdDsKK30KK0VYUE9SVF9TWU1CT0xfR1BMKGRtYV9yZXN2X2dldF9z
aW5nbGV0b25fdW5sb2NrZWQpOworCiAvKioKICAqIGRtYV9yZXN2X3dhaXRfdGltZW91dF91bmxv
Y2tlZCAtIFdhaXQgb24gcmVzZXJ2YXRpb24ncyBvYmplY3RzCiAgKiBzaGFyZWQgYW5kL29yIGV4
Y2x1c2l2ZSBmZW5jZXMuCmRpZmYgLS1naXQgYS9pbmNsdWRlL2xpbnV4L2RtYS1yZXN2LmggYi9p
bmNsdWRlL2xpbnV4L2RtYS1yZXN2LmgKaW5kZXggOTljZmI3YWY5NjZiOC4uYzVmYTA5NTU1ZWNh
NSAxMDA2NDQKLS0tIGEvaW5jbHVkZS9saW51eC9kbWEtcmVzdi5oCisrKyBiL2luY2x1ZGUvbGlu
dXgvZG1hLXJlc3YuaApAQCAtMjg1LDYgKzI4NSw4IEBAIGludCBkbWFfcmVzdl9nZXRfZmVuY2Vz
X3VubG9ja2VkKHN0cnVjdCBkbWFfcmVzdiAqb2JqLAogCiBpbnQgZG1hX3Jlc3ZfY29weV9mZW5j
ZXMoc3RydWN0IGRtYV9yZXN2ICpkc3QsIHN0cnVjdCBkbWFfcmVzdiAqc3JjKTsKIAorc3RydWN0
IGRtYV9mZW5jZSAqZG1hX3Jlc3ZfZ2V0X3NpbmdsZXRvbl91bmxvY2tlZChzdHJ1Y3QgZG1hX3Jl
c3YgKm9iaik7CisKIGxvbmcgZG1hX3Jlc3Zfd2FpdF90aW1lb3V0X3VubG9ja2VkKHN0cnVjdCBk
bWFfcmVzdiAqb2JqLCBib29sIHdhaXRfYWxsLCBib29sIGludHIsCiAJCQkJICAgIHVuc2lnbmVk
IGxvbmcgdGltZW91dCk7CiAKLS0gCjIuMzEuMQoKX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlz
dHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4v
bGlzdGluZm8vaW50ZWwtZ2Z4Cg==

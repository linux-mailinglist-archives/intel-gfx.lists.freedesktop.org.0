Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 544254F84B
	for <lists+intel-gfx@lfdr.de>; Sat, 22 Jun 2019 23:21:16 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 84C7689DBD;
	Sat, 22 Jun 2019 21:21:10 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 89BD489DB4
 for <intel-gfx@lists.freedesktop.org>; Sat, 22 Jun 2019 21:21:06 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 16991528-1500050 
 for multiple; Sat, 22 Jun 2019 22:20:58 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Sat, 22 Jun 2019 22:20:54 +0100
Message-Id: <20190622212055.25782-9-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190622212055.25782-1-chris@chris-wilson.co.uk>
References: <20190622212055.25782-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 09/10] drm/i915: Only recover active engines
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SWYgd2UgaXNzdWUgYSByZXNldCB0byBhIGN1cnJlbnRseSBpZGxlIGVuZ2luZSwgbGVhdmUgaXQg
aWRsZQphZnRlcndhcmRzLiBUaGlzIGlzIHVzZWZ1bCB0byBleGNpc2UgYSBsaW5rYWdlIGJldHdl
ZW4gcmVzZXQgYW5kIHRoZQpzaHJpbmtlci4gV2hlbiB3YWtpbmcgdGhlIGVuZ2luZSwgd2UgbmVl
ZCB0byBwaW4gdGhlIGRlZmF1bHQgY29udGV4dAppbWFnZSB3aGljaCB3ZSB1c2UgZm9yIG92ZXJ3
cml0aW5nIGEgZ3VpbHR5IGNvbnRleHQgLS0gaWYgdGhlIGVuZ2luZSBpcwppZGxlIHdlIGRvIG5v
dCBuZWVkIHRoaXMgcGlubmVkIGltYWdlISBIb3dldmVyLCB0aGlzIHBpbm5pbmcgbWVhbnMgdGhh
dAp3YWtpbmcgdGhlIGVuZ2luZSBhY3F1aXJlcyB0aGUgRlNfUkVDTEFJTSwgYW5kIHNvIG1heSB0
cmlnZ2VyIHRoZQpzaHJpbmtlci4gVGhlIHNocmlua2VyIGl0c2VsZiBtYXkgbmVlZCB0byB3YWl0
IHVwb24gdGhlIEdQVSB0byB1bmJpbmQKYW5kIG9iamVjdCBhbmQgc28gbWF5IHJlcXVpcmUgc2Vy
dmljZXMgb2YgcmVzZXQ7IGVyZ28gd2Ugc2hvdWxkIGF2b2lkCnRoZSBlbmdpbmUgd2FrZSB1cCBw
YXRoLgoKVGhlIGRhbmdlciBpbiBza2lwcGluZyB0aGUgcmVjb3ZlcnkgZm9yIGlkbGUgZW5naW5l
cyBpcyB0aGF0IHdlIGxlYXZlIHRoZQplbmdpbmUgd2l0aCBubyBjb250ZXh0IGRlZmluZWQsIHdo
aWNoIG1heSBpbnRlcmZlcmUgd2l0aCB0aGUgb3BlcmF0aW9uIG9mCnRoZSBwb3dlciBjb250ZXh0
IG9uIHNvbWUgb2xkZXIgcGxhdGZvcm1zLiBJbiBwcmFjdGljZSwgd2Ugc2hvdWxkIG9ubHkKYmUg
cmVzZXR0aW5nIGFuIGFjdGl2ZSBHUFUgYnV0IGl0IHNvbWV0aGluZyB0byBsb29rIG91dCBmb3Ig
b24gSXJvbmxha2UKKGlmIG1lbW9yeSBzZXJ2ZXMpLgoKU2lnbmVkLW9mZi1ieTogQ2hyaXMgV2ls
c29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28udWs+Ci0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUv
Z3QvaW50ZWxfcmVzZXQuYyAgICB8IDM1ICsrKysrKysrKysrKysrKy0tLS0tLS0tLQogZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ3Qvc2VsZnRlc3RfcmVzZXQuYyB8ICA2ICsrLS0KIDIgZmlsZXMgY2hh
bmdlZCwgMjYgaW5zZXJ0aW9ucygrKSwgMTUgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfcmVzZXQuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2d0L2ludGVsX3Jlc2V0LmMKaW5kZXggOGNlOTJjNTE1NjRlLi5kZTI4YzIzNzNjMmYgMTAwNjQ0
Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX3Jlc2V0LmMKKysrIGIvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfcmVzZXQuYwpAQCAtNjc4LDcgKzY3OCw2IEBAIHN0YXRp
YyB2b2lkIHJlc2V0X3ByZXBhcmVfZW5naW5lKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2lu
ZSkKIAkgKiB3cml0dGVuIHRvIHRoZSBwb3dlcmNvbnRleHQgaXMgdW5kZWZpbmVkIGFuZCBzbyB3
ZSBtYXkgbG9zZQogCSAqIEdQVSBzdGF0ZSB1cG9uIHJlc3VtZSwgaS5lLiBmYWlsIHRvIHJlc3Rh
cnQgYWZ0ZXIgYSByZXNldC4KIAkgKi8KLQlpbnRlbF9lbmdpbmVfcG1fZ2V0KGVuZ2luZSk7CiAJ
aW50ZWxfdW5jb3JlX2ZvcmNld2FrZV9nZXQoZW5naW5lLT51bmNvcmUsIEZPUkNFV0FLRV9BTEwp
OwogCWVuZ2luZS0+cmVzZXQucHJlcGFyZShlbmdpbmUpOwogfQpAQCAtNzA5LDE2ICs3MDgsMjIg
QEAgc3RhdGljIHZvaWQgcmV2b2tlX21tYXBzKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1
KQogCX0KIH0KIAotc3RhdGljIHZvaWQgcmVzZXRfcHJlcGFyZShzdHJ1Y3QgZHJtX2k5MTVfcHJp
dmF0ZSAqaTkxNSkKK3N0YXRpYyBpbnRlbF9lbmdpbmVfbWFza190IHJlc2V0X3ByZXBhcmUoc3Ry
dWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCiB7CiAJc3RydWN0IGludGVsX2VuZ2luZV9jcyAq
ZW5naW5lOworCWludGVsX2VuZ2luZV9tYXNrX3QgYXdha2UgPSAwOwogCWVudW0gaW50ZWxfZW5n
aW5lX2lkIGlkOwogCiAJaW50ZWxfZ3RfcG1fZ2V0KCZpOTE1LT5ndCk7Ci0JZm9yX2VhY2hfZW5n
aW5lKGVuZ2luZSwgaTkxNSwgaWQpCisJZm9yX2VhY2hfZW5naW5lKGVuZ2luZSwgaTkxNSwgaWQp
IHsKKwkJaWYgKGludGVsX2VuZ2luZV9wbV9nZXRfaWZfYXdha2UoZW5naW5lKSkKKwkJCWF3YWtl
IHw9IGVuZ2luZS0+bWFzazsKIAkJcmVzZXRfcHJlcGFyZV9lbmdpbmUoZW5naW5lKTsKKwl9CiAK
IAlpbnRlbF91Y19yZXNldF9wcmVwYXJlKGk5MTUpOworCisJcmV0dXJuIGF3YWtlOwogfQogCiBz
dGF0aWMgdm9pZCBndF9yZXZva2Uoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCkBAIC03
NTIsMTggKzc1NywyMSBAQCBzdGF0aWMgaW50IGd0X3Jlc2V0KHN0cnVjdCBkcm1faTkxNV9wcml2
YXRlICppOTE1LAogc3RhdGljIHZvaWQgcmVzZXRfZmluaXNoX2VuZ2luZShzdHJ1Y3QgaW50ZWxf
ZW5naW5lX2NzICplbmdpbmUpCiB7CiAJZW5naW5lLT5yZXNldC5maW5pc2goZW5naW5lKTsKLQlp
bnRlbF9lbmdpbmVfcG1fcHV0KGVuZ2luZSk7CiAJaW50ZWxfdW5jb3JlX2ZvcmNld2FrZV9wdXQo
ZW5naW5lLT51bmNvcmUsIEZPUkNFV0FLRV9BTEwpOworCisJaW50ZWxfZW5naW5lX3NpZ25hbF9i
cmVhZGNydW1icyhlbmdpbmUpOwogfQogCi1zdGF0aWMgdm9pZCByZXNldF9maW5pc2goc3RydWN0
IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCitzdGF0aWMgdm9pZCByZXNldF9maW5pc2goc3RydWN0
IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUsCisJCQkgaW50ZWxfZW5naW5lX21hc2tfdCBhd2FrZSkK
IHsKIAlzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmU7CiAJZW51bSBpbnRlbF9lbmdpbmVf
aWQgaWQ7CiAKIAlmb3JfZWFjaF9lbmdpbmUoZW5naW5lLCBpOTE1LCBpZCkgewogCQlyZXNldF9m
aW5pc2hfZW5naW5lKGVuZ2luZSk7Ci0JCWludGVsX2VuZ2luZV9zaWduYWxfYnJlYWRjcnVtYnMo
ZW5naW5lKTsKKwkJaWYgKGF3YWtlICYgZW5naW5lLT5tYXNrKQorCQkJaW50ZWxfZW5naW5lX3Bt
X3B1dChlbmdpbmUpOwogCX0KIAlpbnRlbF9ndF9wbV9wdXQoJmk5MTUtPmd0KTsKIH0KQEAgLTc4
OSw2ICs3OTcsNyBAQCBzdGF0aWMgdm9pZCBfX2k5MTVfZ2VtX3NldF93ZWRnZWQoc3RydWN0IGRy
bV9pOTE1X3ByaXZhdGUgKmk5MTUpCiB7CiAJc3RydWN0IGk5MTVfZ3B1X2Vycm9yICplcnJvciA9
ICZpOTE1LT5ncHVfZXJyb3I7CiAJc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lOworCWlu
dGVsX2VuZ2luZV9tYXNrX3QgYXdha2U7CiAJZW51bSBpbnRlbF9lbmdpbmVfaWQgaWQ7CiAKIAlp
ZiAodGVzdF9iaXQoSTkxNV9XRURHRUQsICZlcnJvci0+ZmxhZ3MpKQpAQCAtODA4LDcgKzgxNyw3
IEBAIHN0YXRpYyB2b2lkIF9faTkxNV9nZW1fc2V0X3dlZGdlZChzdHJ1Y3QgZHJtX2k5MTVfcHJp
dmF0ZSAqaTkxNSkKIAkgKiByb2xsaW5nIHRoZSBnbG9iYWwgc2Vxbm8gZm9yd2FyZCAoc2luY2Ug
dGhpcyB3b3VsZCBjb21wbGV0ZSByZXF1ZXN0cwogCSAqIGZvciB3aGljaCB3ZSBoYXZlbid0IHNl
dCB0aGUgZmVuY2UgZXJyb3IgdG8gRUlPIHlldCkuCiAJICovCi0JcmVzZXRfcHJlcGFyZShpOTE1
KTsKKwlhd2FrZSA9IHJlc2V0X3ByZXBhcmUoaTkxNSk7CiAKIAkvKiBFdmVuIGlmIHRoZSBHUFUg
cmVzZXQgZmFpbHMsIGl0IHNob3VsZCBzdGlsbCBzdG9wIHRoZSBlbmdpbmVzICovCiAJaWYgKCFJ
TlRFTF9JTkZPKGk5MTUpLT5ncHVfcmVzZXRfY2xvYmJlcnNfZGlzcGxheSkKQEAgLTgzMiw3ICs4
NDEsNyBAQCBzdGF0aWMgdm9pZCBfX2k5MTVfZ2VtX3NldF93ZWRnZWQoc3RydWN0IGRybV9pOTE1
X3ByaXZhdGUgKmk5MTUpCiAJZm9yX2VhY2hfZW5naW5lKGVuZ2luZSwgaTkxNSwgaWQpCiAJCWVu
Z2luZS0+Y2FuY2VsX3JlcXVlc3RzKGVuZ2luZSk7CiAKLQlyZXNldF9maW5pc2goaTkxNSk7CisJ
cmVzZXRfZmluaXNoKGk5MTUsIGF3YWtlKTsKIAogCUdFTV9UUkFDRSgiZW5kXG4iKTsKIH0KQEAg
LTk2NCw2ICs5NzMsNyBAQCB2b2lkIGk5MTVfcmVzZXQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUg
Kmk5MTUsCiAJCWNvbnN0IGNoYXIgKnJlYXNvbikKIHsKIAlzdHJ1Y3QgaTkxNV9ncHVfZXJyb3Ig
KmVycm9yID0gJmk5MTUtPmdwdV9lcnJvcjsKKwlpbnRlbF9lbmdpbmVfbWFza190IGF3YWtlOwog
CWludCByZXQ7CiAKIAlHRU1fVFJBQ0UoImZsYWdzPSVseFxuIiwgZXJyb3ItPmZsYWdzKTsKQEAg
LTk4MCw3ICs5OTAsNyBAQCB2b2lkIGk5MTVfcmVzZXQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUg
Kmk5MTUsCiAJCWRldl9ub3RpY2UoaTkxNS0+ZHJtLmRldiwgIlJlc2V0dGluZyBjaGlwIGZvciAl
c1xuIiwgcmVhc29uKTsKIAllcnJvci0+cmVzZXRfY291bnQrKzsKIAotCXJlc2V0X3ByZXBhcmUo
aTkxNSk7CisJYXdha2UgPSByZXNldF9wcmVwYXJlKGk5MTUpOwogCiAJaWYgKCFpbnRlbF9oYXNf
Z3B1X3Jlc2V0KGk5MTUpKSB7CiAJCWlmIChpOTE1X21vZHBhcmFtcy5yZXNldCkKQEAgLTEwMjEs
NyArMTAzMSw3IEBAIHZvaWQgaTkxNV9yZXNldChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkx
NSwKIAlpOTE1X3F1ZXVlX2hhbmdjaGVjayhpOTE1KTsKIAogZmluaXNoOgotCXJlc2V0X2Zpbmlz
aChpOTE1KTsKKwlyZXNldF9maW5pc2goaTkxNSwgYXdha2UpOwogdW5sb2NrOgogCW11dGV4X3Vu
bG9jaygmZXJyb3ItPndlZGdlX211dGV4KTsKIAlyZXR1cm47CkBAIC0xMDcyLDcgKzEwODIsNyBA
QCBpbnQgaTkxNV9yZXNldF9lbmdpbmUoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lLCBj
b25zdCBjaGFyICptc2cpCiAJR0VNX1RSQUNFKCIlcyBmbGFncz0lbHhcbiIsIGVuZ2luZS0+bmFt
ZSwgZXJyb3ItPmZsYWdzKTsKIAlHRU1fQlVHX09OKCF0ZXN0X2JpdChJOTE1X1JFU0VUX0VOR0lO
RSArIGVuZ2luZS0+aWQsICZlcnJvci0+ZmxhZ3MpKTsKIAotCWlmICghaW50ZWxfZW5naW5lX3Bt
X2lzX2F3YWtlKGVuZ2luZSkpCisJaWYgKCFpbnRlbF9lbmdpbmVfcG1fZ2V0X2lmX2F3YWtlKGVu
Z2luZSkpCiAJCXJldHVybiAwOwogCiAJcmVzZXRfcHJlcGFyZV9lbmdpbmUoZW5naW5lKTsKQEAg
LTExMDcsMTIgKzExMTcsMTEgQEAgaW50IGk5MTVfcmVzZXRfZW5naW5lKHN0cnVjdCBpbnRlbF9l
bmdpbmVfY3MgKmVuZ2luZSwgY29uc3QgY2hhciAqbXNnKQogCSAqIHByb2Nlc3MgdG8gcHJvZ3Jh
bSBSSU5HX01PREUsIEhXU1AgYW5kIHJlLWVuYWJsZSBzdWJtaXNzaW9uLgogCSAqLwogCXJldCA9
IGVuZ2luZS0+cmVzdW1lKGVuZ2luZSk7Ci0JaWYgKHJldCkKLQkJZ290byBvdXQ7CiAKIG91dDoK
IAlpbnRlbF9lbmdpbmVfY2FuY2VsX3N0b3BfY3MoZW5naW5lKTsKIAlyZXNldF9maW5pc2hfZW5n
aW5lKGVuZ2luZSk7CisJaW50ZWxfZW5naW5lX3BtX3B1dChlbmdpbmUpOwogCXJldHVybiByZXQ7
CiB9CiAKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L3NlbGZ0ZXN0X3Jlc2V0
LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVzdF9yZXNldC5jCmluZGV4IGRjYzIy
ZjAzY2JkNC4uNDM0ZGUzMzRiNDExIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9n
dC9zZWxmdGVzdF9yZXNldC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L3NlbGZ0ZXN0
X3Jlc2V0LmMKQEAgLTcxLDE1ICs3MSwxNyBAQCBzdGF0aWMgaW50IGlndF9hdG9taWNfcmVzZXQo
dm9pZCAqYXJnKQogCQlnb3RvIHVubG9jazsKIAogCWZvciAocCA9IGlndF9hdG9taWNfcGhhc2Vz
OyBwLT5uYW1lOyBwKyspIHsKKwkJaW50ZWxfZW5naW5lX21hc2tfdCBhd2FrZTsKKwogCQlHRU1f
VFJBQ0UoImludGVsX2dwdV9yZXNldCB1bmRlciAlc1xuIiwgcC0+bmFtZSk7CiAKLQkJcmVzZXRf
cHJlcGFyZShpOTE1KTsKKwkJYXdha2UgPSByZXNldF9wcmVwYXJlKGk5MTUpOwogCQlwLT5jcml0
aWNhbF9zZWN0aW9uX2JlZ2luKCk7CiAKIAkJZXJyID0gaW50ZWxfZ3B1X3Jlc2V0KGk5MTUsIEFM
TF9FTkdJTkVTKTsKIAogCQlwLT5jcml0aWNhbF9zZWN0aW9uX2VuZCgpOwotCQlyZXNldF9maW5p
c2goaTkxNSk7CisJCXJlc2V0X2ZpbmlzaChpOTE1LCBhd2FrZSk7CiAKIAkJaWYgKGVycikgewog
CQkJcHJfZXJyKCJpbnRlbF9ncHVfcmVzZXQgZmFpbGVkIHVuZGVyICVzXG4iLCBwLT5uYW1lKTsK
LS0gCjIuMjAuMQoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3Jn
Cmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

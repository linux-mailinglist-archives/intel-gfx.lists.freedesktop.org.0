Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id E97B98F613
	for <lists+intel-gfx@lfdr.de>; Thu, 15 Aug 2019 22:57:19 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id D9F9C6EA82;
	Thu, 15 Aug 2019 20:57:16 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id A1B716EA80
 for <intel-gfx@lists.freedesktop.org>; Thu, 15 Aug 2019 20:57:13 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18155951-1500050 
 for <intel-gfx@lists.freedesktop.org>; Thu, 15 Aug 2019 21:57:10 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Thu, 15 Aug 2019 21:57:08 +0100
Message-Id: <20190815205709.24285-3-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0.rc1
In-Reply-To: <20190815205709.24285-1-chris@chris-wilson.co.uk>
References: <20190815205709.24285-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [CI 3/4] drm/i915/gt: Guard timeline pinning without
 relying on struct_mutex
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SW4gcHJlcGFyYXRpb24gZm9yIHJlbW92aW5nIHN0cnVjdF9tdXRleCBmcm9tIGFyb3VuZCBjb250
ZXh0IHJldGlyZW1lbnQsCndlIG5lZWQgdG8gbWFrZSB0aW1lbGluZSBwaW5uaW5nIGFuZCB1bnBp
bm5pbmcgc2FmZS4gU2luY2UgbXVsdGlwbGUKZW5naW5lcy9jb250ZXh0cyBjYW4gc2hhcmUgYSBz
aW5nbGUgdGltZWxpbmUsIHdlIGNhbm5vdCByZWx5IG9uCmJvcnJvd2luZyB0aGUgY29udGV4dCBt
dXRleCAob3RoZXJ3aXNlIHdlIGNvdWxkIHN0YXRlIHRoYXQgdGhlIHRpbWVsaW5lCmlzIG9ubHkg
cGlubmVkL3VucGlubmVkIGluc2lkZSB0aGUgY29udGV4dCBwaW4vdW5waW4gYW5kIHNvIGd1YXJk
ZWQgYnkKaXQpLiBIb3dldmVyLCB3ZSBvbmx5IHBlcmZvcm0gYSBzZXF1ZW5jZSBvZiBhdG9taWMg
b3BlcmF0aW9ucyBpbnNpZGUgdGhlCnRpbWVsaW5lIHBpbi91bnBpbiBhbmQgdGhlIHNlcXVlbmNl
IG9mIHRob3NlIG9wZXJhdGlvbnMgaXMgc2FmZSBmb3IgYQpjb25jdXJyZW50IHVucGluIC8gcGlu
LCBzbyB3ZSBjYW4gcmVsYXggdGhlIHN0cnVjdF9tdXRleCByZXF1aXJlbWVudC4KClNpZ25lZC1v
ZmYtYnk6IENocmlzIFdpbHNvbiA8Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPgpSZXZpZXdlZC1i
eTogTWF0dGhldyBBdWxkIDxtYXR0aGV3LmF1bGRAaW50ZWwuY29tPgotLS0KIGRyaXZlcnMvZ3B1
L2RybS9pOTE1L2d0L2ludGVsX3RpbWVsaW5lLmMgICAgICB8IDI3ICsrKysrKysrKy0tLS0tLS0t
LS0KIC4uLi9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfdGltZWxpbmVfdHlwZXMuaCAgICB8ICAyICst
CiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9tb2NrX2VuZ2luZS5jICAgICAgICAgfCAgNiArKy0t
LQogMyBmaWxlcyBjaGFuZ2VkLCAxNiBpbnNlcnRpb25zKCspLCAxOSBkZWxldGlvbnMoLSkKCmRp
ZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF90aW1lbGluZS5jIGIvZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfdGltZWxpbmUuYwppbmRleCAzNTVkZmM1MmM4MDQu
LjdiNDc2Y2Q1NWRhYyAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxf
dGltZWxpbmUuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF90aW1lbGluZS5j
CkBAIC0yMTEsOSArMjExLDkgQEAgaW50IGludGVsX3RpbWVsaW5lX2luaXQoc3RydWN0IGludGVs
X3RpbWVsaW5lICp0aW1lbGluZSwKIAl2b2lkICp2YWRkcjsKIAogCWtyZWZfaW5pdCgmdGltZWxp
bmUtPmtyZWYpOworCWF0b21pY19zZXQoJnRpbWVsaW5lLT5waW5fY291bnQsIDApOwogCiAJdGlt
ZWxpbmUtPmd0ID0gZ3Q7Ci0JdGltZWxpbmUtPnBpbl9jb3VudCA9IDA7CiAKIAl0aW1lbGluZS0+
aGFzX2luaXRpYWxfYnJlYWRjcnVtYiA9ICFod3NwOwogCXRpbWVsaW5lLT5od3NwX2NhY2hlbGlu
ZSA9IE5VTEw7CkBAIC0yODAsNyArMjgwLDcgQEAgdm9pZCBpbnRlbF90aW1lbGluZXNfaW5pdChz
dHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKIAogdm9pZCBpbnRlbF90aW1lbGluZV9maW5p
KHN0cnVjdCBpbnRlbF90aW1lbGluZSAqdGltZWxpbmUpCiB7Ci0JR0VNX0JVR19PTih0aW1lbGlu
ZS0+cGluX2NvdW50KTsKKwlHRU1fQlVHX09OKGF0b21pY19yZWFkKCZ0aW1lbGluZS0+cGluX2Nv
dW50KSk7CiAJR0VNX0JVR19PTighbGlzdF9lbXB0eSgmdGltZWxpbmUtPnJlcXVlc3RzKSk7CiAK
IAlpZiAodGltZWxpbmUtPmh3c3BfY2FjaGVsaW5lKQpAQCAtMzE0LDMzICszMTQsMzEgQEAgaW50
IGludGVsX3RpbWVsaW5lX3BpbihzdHJ1Y3QgaW50ZWxfdGltZWxpbmUgKnRsKQogewogCWludCBl
cnI7CiAKLQlpZiAodGwtPnBpbl9jb3VudCsrKQorCWlmIChhdG9taWNfYWRkX3VubGVzcygmdGwt
PnBpbl9jb3VudCwgMSwgMCkpCiAJCXJldHVybiAwOwotCUdFTV9CVUdfT04oIXRsLT5waW5fY291
bnQpOwotCUdFTV9CVUdfT04odGwtPmFjdGl2ZV9jb3VudCk7CiAKIAllcnIgPSBpOTE1X3ZtYV9w
aW4odGwtPmh3c3BfZ2d0dCwgMCwgMCwgUElOX0dMT0JBTCB8IFBJTl9ISUdIKTsKIAlpZiAoZXJy
KQotCQlnb3RvIHVucGluOworCQlyZXR1cm4gZXJyOwogCiAJdGwtPmh3c3Bfb2Zmc2V0ID0KIAkJ
aTkxNV9nZ3R0X29mZnNldCh0bC0+aHdzcF9nZ3R0KSArCiAJCW9mZnNldF9pbl9wYWdlKHRsLT5o
d3NwX29mZnNldCk7CiAKIAljYWNoZWxpbmVfYWNxdWlyZSh0bC0+aHdzcF9jYWNoZWxpbmUpOwor
CWlmIChhdG9taWNfZmV0Y2hfaW5jKCZ0bC0+cGluX2NvdW50KSkgeworCQljYWNoZWxpbmVfcmVs
ZWFzZSh0bC0+aHdzcF9jYWNoZWxpbmUpOworCQlfX2k5MTVfdm1hX3VucGluKHRsLT5od3NwX2dn
dHQpOworCX0KIAogCXJldHVybiAwOwotCi11bnBpbjoKLQl0bC0+cGluX2NvdW50ID0gMDsKLQly
ZXR1cm4gZXJyOwogfQogCiB2b2lkIGludGVsX3RpbWVsaW5lX2VudGVyKHN0cnVjdCBpbnRlbF90
aW1lbGluZSAqdGwpCiB7CiAJc3RydWN0IGludGVsX2d0X3RpbWVsaW5lcyAqdGltZWxpbmVzID0g
JnRsLT5ndC0+dGltZWxpbmVzOwogCi0JR0VNX0JVR19PTighdGwtPnBpbl9jb3VudCk7CisJR0VN
X0JVR19PTighYXRvbWljX3JlYWQoJnRsLT5waW5fY291bnQpKTsKIAlpZiAodGwtPmFjdGl2ZV9j
b3VudCsrKQogCQlyZXR1cm47CiAJR0VNX0JVR19PTighdGwtPmFjdGl2ZV9jb3VudCk7IC8qIG92
ZXJmbG93PyAqLwpAQCAtMzcyLDcgKzM3MCw3IEBAIHZvaWQgaW50ZWxfdGltZWxpbmVfZXhpdChz
dHJ1Y3QgaW50ZWxfdGltZWxpbmUgKnRsKQogCiBzdGF0aWMgdTMyIHRpbWVsaW5lX2FkdmFuY2Uo
c3RydWN0IGludGVsX3RpbWVsaW5lICp0bCkKIHsKLQlHRU1fQlVHX09OKCF0bC0+cGluX2NvdW50
KTsKKwlHRU1fQlVHX09OKCFhdG9taWNfcmVhZCgmdGwtPnBpbl9jb3VudCkpOwogCUdFTV9CVUdf
T04odGwtPnNlcW5vICYgdGwtPmhhc19pbml0aWFsX2JyZWFkY3J1bWIpOwogCiAJcmV0dXJuIHRs
LT5zZXFubyArPSAxICsgdGwtPmhhc19pbml0aWFsX2JyZWFkY3J1bWI7CkBAIC01MjMsMTEgKzUy
MSwxMCBAQCBpbnQgaW50ZWxfdGltZWxpbmVfcmVhZF9od3NwKHN0cnVjdCBpOTE1X3JlcXVlc3Qg
KmZyb20sCiAKIHZvaWQgaW50ZWxfdGltZWxpbmVfdW5waW4oc3RydWN0IGludGVsX3RpbWVsaW5l
ICp0bCkKIHsKLQlHRU1fQlVHX09OKCF0bC0+cGluX2NvdW50KTsKLQlpZiAoLS10bC0+cGluX2Nv
dW50KQorCUdFTV9CVUdfT04oIWF0b21pY19yZWFkKCZ0bC0+cGluX2NvdW50KSk7CisJaWYgKCFh
dG9taWNfZGVjX2FuZF90ZXN0KCZ0bC0+cGluX2NvdW50KSkKIAkJcmV0dXJuOwogCi0JR0VNX0JV
R19PTih0bC0+YWN0aXZlX2NvdW50KTsKIAljYWNoZWxpbmVfcmVsZWFzZSh0bC0+aHdzcF9jYWNo
ZWxpbmUpOwogCiAJX19pOTE1X3ZtYV91bnBpbih0bC0+aHdzcF9nZ3R0KTsKZGlmZiAtLWdpdCBh
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX3RpbWVsaW5lX3R5cGVzLmggYi9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9ndC9pbnRlbF90aW1lbGluZV90eXBlcy5oCmluZGV4IGIxYTlmMGM1NGJm
MC4uMmIxYmFmMmZjYzhlIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRl
bF90aW1lbGluZV90eXBlcy5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX3Rp
bWVsaW5lX3R5cGVzLmgKQEAgLTQxLDcgKzQxLDcgQEAgc3RydWN0IGludGVsX3RpbWVsaW5lIHsK
IAkgKiBidXQgdGhlIHBpbl9jb3VudCBpcyBwcm90ZWN0ZWQgYnkgYSBjb21iaW5hdGlvbiBvZiBz
ZXJpYWxpc2F0aW9uCiAJICogZnJvbSB0aGUgaW50ZWxfY29udGV4dCBjYWxsZXIgcGx1cyBpbnRl
cm5hbCBhdG9taWNpdHkuCiAJICovCi0JdW5zaWduZWQgaW50IHBpbl9jb3VudDsKKwlhdG9taWNf
dCBwaW5fY291bnQ7CiAJdW5zaWduZWQgaW50IGFjdGl2ZV9jb3VudDsKIAogCWNvbnN0IHUzMiAq
aHdzcF9zZXFubzsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L21vY2tfZW5n
aW5lLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9tb2NrX2VuZ2luZS5jCmluZGV4IGE2M2Rk
OGE0MmNkNC4uNTRhMTFkZGUzMDc2IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9n
dC9tb2NrX2VuZ2luZS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L21vY2tfZW5naW5l
LmMKQEAgLTM0LDEzICszNCwxMyBAQAogCiBzdGF0aWMgdm9pZCBtb2NrX3RpbWVsaW5lX3Bpbihz
dHJ1Y3QgaW50ZWxfdGltZWxpbmUgKnRsKQogewotCXRsLT5waW5fY291bnQrKzsKKwlhdG9taWNf
aW5jKCZ0bC0+cGluX2NvdW50KTsKIH0KIAogc3RhdGljIHZvaWQgbW9ja190aW1lbGluZV91bnBp
bihzdHJ1Y3QgaW50ZWxfdGltZWxpbmUgKnRsKQogewotCUdFTV9CVUdfT04oIXRsLT5waW5fY291
bnQpOwotCXRsLT5waW5fY291bnQtLTsKKwlHRU1fQlVHX09OKCFhdG9taWNfcmVhZCgmdGwtPnBp
bl9jb3VudCkpOworCWF0b21pY19kZWMoJnRsLT5waW5fY291bnQpOwogfQogCiBzdGF0aWMgc3Ry
dWN0IGludGVsX3JpbmcgKm1vY2tfcmluZyhzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUp
Ci0tIAoyLjIzLjAucmMxCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fXwpJbnRlbC1nZnggbWFpbGluZyBsaXN0CkludGVsLWdmeEBsaXN0cy5mcmVlZGVza3Rv
cC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9pbnRl
bC1nZng=

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 77C67D217A
	for <lists+intel-gfx@lfdr.de>; Thu, 10 Oct 2019 09:14:58 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 86C136EAAA;
	Thu, 10 Oct 2019 07:14:55 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 246756EAAA
 for <intel-gfx@lists.freedesktop.org>; Thu, 10 Oct 2019 07:14:49 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18785782-1500050 
 for multiple; Thu, 10 Oct 2019 08:14:36 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Thu, 10 Oct 2019 08:14:28 +0100
Message-Id: <20191010071434.31195-4-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20191010071434.31195-1-chris@chris-wilson.co.uk>
References: <20191010071434.31195-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 04/10] drm/i915/execlists: Force preemption
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SWYgdGhlIHByZWVtcHRlZCBjb250ZXh0IHRha2VzIHRvbyBsb25nIHRvIHJlbGlucXVpc2ggY29u
dHJvbCwgZS5nLiBpdAppcyBzdHVjayBpbnNpZGUgYSBzaGFkZXIgd2l0aCBhcmJpdHJhdGlvbiBk
aXNhYmxlZCwgZXZpY3QgdGhhdCBjb250ZXh0CndpdGggYW4gZW5naW5lIHJlc2V0LiBUaGlzIGVu
c3VyZXMgdGhhdCBwcmVlbXB0aW9ucyBhcmUgcmVhc29uYWJseQpyZXNwb25zaXZlLCBwcm92aWRp
bmcgYSB0aWdodGVyIFFvUyBmb3IgdGhlIG1vcmUgaW1wb3J0YW50IGNvbnRleHQgYXQKdGhlIGNv
c3Qgb2YgZmxhZ2dpbmcgdW5yZXNwb25zaXZlIGNvbnRleHRzIG1vcmUgZnJlcXVlbnRseSAoaS5l
LiBpbnN0ZWFkCm9mIHVzaW5nIGFuIH4xMHMgaGFuZ2NoZWNrLCB3ZSBub3cgZXZpY3QgYXQgfjEw
MG1zKS4gIFRoZSBjaGFsbGVuZ2Ugb2YKbGllcyBpbiBwaWNraW5nIGEgdGltZW91dCB0aGF0IGNh
biBiZSByZWFzb25hYmx5IHNlcnZpY2VkIGJ5IEhXIGZvcgp0eXBpY2FsIHdvcmtsb2FkcywgYmFs
YW5jaW5nIHRoZSBleGlzdGluZyBjbGllbnRzIGFnYWluc3QgdGhlIG5lZWRzIGZvcgpyZXNwb25z
aXZlbmVzcy4KCk5vdGUgdGhhdCBjb3VwbGVkIHdpdGggdGltZXNsaWNpbmcsIHRoaXMgd2lsbCBs
ZWFkIHRvIHJhcGlkIEdQVSAiaGFuZyIKZGV0ZWN0aW9uIHdpdGggbXVsdGlwbGUgYWN0aXZlIGNv
bnRleHRzIHZ5aW5nIGZvciBHUFUgdGltZS4KClRoZSBwcmVlbXB0IHRpbWVvdXQgY2FuIGJlIGFk
anVzdGVkIHBlci1lbmdpbmUgdXNpbmcsCgoJL3N5cy9jbGFzcy9kcm0vY2FyZD8vZW5naW5lLyov
cHJlZW1wdF90aW1lb3V0X21zCgp2MjogQ291cGxlIGluIHN5c2ZzIGNvbnRyb2wgb2YgcHJlZW1w
dGlvbiB0aW1lb3V0CgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNocmlzQGNocmlzLXdp
bHNvbi5jby51az4KQ2M6IE1pa2EgS3VvcHBhbGEgPG1pa2Eua3VvcHBhbGFAbGludXguaW50ZWwu
Y29tPgpDYzogVHZydGtvIFVyc3VsaW4gPHR2cnRrby51cnN1bGluQGludGVsLmNvbT4KUmV2aWV3
ZWQtYnk6IE1pa2EgS3VvcHBhbGEgPG1pa2Eua3VvcHBhbGFAbGludXguaW50ZWwuY29tPgotLS0K
IGRyaXZlcnMvZ3B1L2RybS9pOTE1L0tjb25maWcucHJvZmlsZSAgICAgICAgIHwgMTUgKysrKwog
ZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZW5naW5lX2NzLmMgICAgfCAgMiArCiBkcml2
ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfc3lzZnMuYyB8IDMyICsrKysrKysKIGRy
aXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZV90eXBlcy5oIHwgIDkgKysKIGRyaXZl
cnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2xyYy5jICAgICAgICAgIHwgOTUgKysrKysrKysrKysr
KysrKysrLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcGFyYW1zLmggICAgICAgICAgIHwg
IDIgKy0KIDYgZmlsZXMgY2hhbmdlZCwgMTQ2IGluc2VydGlvbnMoKyksIDkgZGVsZXRpb25zKC0p
CgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvS2NvbmZpZy5wcm9maWxlIGIvZHJp
dmVycy9ncHUvZHJtL2k5MTUvS2NvbmZpZy5wcm9maWxlCmluZGV4IDQ4ZGY4ODg5YTg4YS4uOGZj
ZWVhODU5MzdiIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9LY29uZmlnLnByb2Zp
bGUKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvS2NvbmZpZy5wcm9maWxlCkBAIC0yNSwzICsy
NSwxOCBAQCBjb25maWcgRFJNX0k5MTVfU1BJTl9SRVFVRVNUCiAJICBNYXkgYmUgMCB0byBkaXNh
YmxlIHRoZSBpbml0aWFsIHNwaW4uIEluIHByYWN0aWNlLCB3ZSBlc3RpbWF0ZQogCSAgdGhlIGNv
c3Qgb2YgZW5hYmxpbmcgdGhlIGludGVycnVwdCAoaWYgY3VycmVudGx5IGRpc2FibGVkKSB0byBi
ZQogCSAgYSBmZXcgbWljcm9zZWNvbmRzLgorCitjb25maWcgRFJNX0k5MTVfUFJFRU1QVF9USU1F
T1VUCisJaW50ICJQcmVlbXB0IHRpbWVvdXQgKG1zKSIKKwlkZWZhdWx0IDEwMCAjIG1pbGxpc2Vj
b25kcworCWhlbHAKKwkgIEhvdyBsb25nIHRvIHdhaXQgKGluIG1pbGxpc2Vjb25kcykgZm9yIGEg
cHJlZW1wdGlvbiBldmVudCB0byBvY2N1cgorCSAgd2hlbiBzdWJtaXR0aW5nIGEgbmV3IGNvbnRl
eHQgdmlhIGV4ZWNsaXN0cy4gSWYgdGhlIGN1cnJlbnQgY29udGV4dAorCSAgZG9lcyBub3QgaGl0
IGFuIGFyYml0cmF0aW9uIHBvaW50IGFuZCB5aWVsZCB0byBIVyBiZWZvcmUgdGhlIHRpbWVyCisJ
ICBleHBpcmVzLCB0aGUgSFcgd2lsbCBiZSByZXNldCB0byBhbGxvdyB0aGUgbW9yZSBpbXBvcnRh
bnQgY29udGV4dAorCSAgdG8gZXhlY3V0ZS4KKworCSAgVGhpcyBpcyBhZGp1c3RhYmxlIHZpYQor
CSAgL3N5cy9jbGFzcy9kcm0vY2FyZD8vZW5naW5lLyovcHJlZW1wdF90aW1lb3V0X21zCisKKwkg
IE1heSBiZSAwIHRvIGRpc2FibGUgdGhlIHRpbWVvdXQuCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfY3MuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0
L2ludGVsX2VuZ2luZV9jcy5jCmluZGV4IGM5ZDYzOWM2YmVjYi4uMWViNTExNDc4MzlhIDEwMDY0
NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfY3MuYworKysgYi9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfY3MuYwpAQCAtMzA0LDYgKzMwNCw4
IEBAIHN0YXRpYyBpbnQgaW50ZWxfZW5naW5lX3NldHVwKHN0cnVjdCBpbnRlbF9ndCAqZ3QsIGVu
dW0gaW50ZWxfZW5naW5lX2lkIGlkKQogCWVuZ2luZS0+aW5zdGFuY2UgPSBpbmZvLT5pbnN0YW5j
ZTsKIAlfX3NwcmludF9lbmdpbmVfbmFtZShlbmdpbmUpOwogCisJZW5naW5lLT5wcm9wcy5wcmVl
bXB0X3RpbWVvdXQgPSBDT05GSUdfRFJNX0k5MTVfUFJFRU1QVF9USU1FT1VUOworCiAJLyoKIAkg
KiBUbyBiZSBvdmVycmlkZGVuIGJ5IHRoZSBiYWNrZW5kIG9uIHNldHVwLiBIb3dldmVyIHRvIGZh
Y2lsaXRhdGUKIAkgKiBjbGVhbnVwIG9uIGVycm9yIGR1cmluZyBzZXR1cCwgd2UgYWx3YXlzIHBy
b3ZpZGUgdGhlIGRlc3Ryb3kgdmZ1bmMuCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9ndC9pbnRlbF9lbmdpbmVfc3lzZnMuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVs
X2VuZ2luZV9zeXNmcy5jCmluZGV4IGNiZTllYzU5YmVlYi4uYWFjMjYwOTdjOTE2IDEwMDY0NAot
LS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfc3lzZnMuYworKysgYi9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfc3lzZnMuYwpAQCAtNDUsMTAgKzQ1
LDM3IEBAIG1taW9fc2hvdyhzdHJ1Y3Qga29iamVjdCAqa29iaiwgc3RydWN0IGtvYmpfYXR0cmli
dXRlICphdHRyLCBjaGFyICpidWYpCiAJcmV0dXJuIHNwcmludGYoYnVmLCAiMHgleFxuIiwga29i
al90b19lbmdpbmUoa29iaiktPm1taW9fYmFzZSk7CiB9CiAKK3N0YXRpYyBzc2l6ZV90CitwcmVl
bXB0X3RpbWVvdXRfc2hvdyhzdHJ1Y3Qga29iamVjdCAqa29iaiwgc3RydWN0IGtvYmpfYXR0cmli
dXRlICphdHRyLAorCQkgICAgIGNoYXIgKmJ1ZikKK3sKKwlzdHJ1Y3QgaW50ZWxfZW5naW5lX2Nz
ICplbmdpbmUgPSBrb2JqX3RvX2VuZ2luZShrb2JqKTsKKworCXJldHVybiBzcHJpbnRmKGJ1Ziwg
IiVsdVxuIiwgZW5naW5lLT5wcm9wcy5wcmVlbXB0X3RpbWVvdXQpOworfQorCitzdGF0aWMgc3Np
emVfdAorcHJlZW1wdF90aW1lb3V0X3N0b3JlKHN0cnVjdCBrb2JqZWN0ICprb2JqLCBzdHJ1Y3Qg
a29ial9hdHRyaWJ1dGUgKmF0dHIsCisJCSAgICAgIGNvbnN0IGNoYXIgKmJ1Ziwgc2l6ZV90IGNv
dW50KQoreworCXN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSA9IGtvYmpfdG9fZW5naW5l
KGtvYmopOworCXVuc2lnbmVkIGxvbmcgdGltZW91dDsKKwlpbnQgZXJyOworCisJZXJyID0ga3N0
cnRvdWwoYnVmLCAwLCAmdGltZW91dCk7CisJaWYgKGVycikKKwkJcmV0dXJuIGVycjsKKworCWVu
Z2luZS0+cHJvcHMucHJlZW1wdF90aW1lb3V0ID0gdGltZW91dDsKKwlyZXR1cm4gY291bnQ7Cit9
CisKIHN0YXRpYyBzdHJ1Y3Qga29ial9hdHRyaWJ1dGUgbmFtZV9hdHRyID0gX19BVFRSKG5hbWUs
IDA0NDQsIG5hbWVfc2hvdywgTlVMTCk7CiBzdGF0aWMgc3RydWN0IGtvYmpfYXR0cmlidXRlIGNs
YXNzX2F0dHIgPSBfX0FUVFIoY2xhc3MsIDA0NDQsIGNsYXNzX3Nob3csIE5VTEwpOwogc3RhdGlj
IHN0cnVjdCBrb2JqX2F0dHJpYnV0ZSBpbnN0X2F0dHIgPSBfX0FUVFIoaW5zdGFuY2UsIDA0NDQs
IGluc3Rfc2hvdywgTlVMTCk7CiBzdGF0aWMgc3RydWN0IGtvYmpfYXR0cmlidXRlIG1taW9fYXR0
ciA9IF9fQVRUUihtbWlvX2Jhc2UsIDA0NDQsIG1taW9fc2hvdywgTlVMTCk7CitzdGF0aWMgc3Ry
dWN0IGtvYmpfYXR0cmlidXRlIHByZWVtcHRfdGltZW91dF9hdHRyID0KK19fQVRUUihwcmVlbXB0
X3RpbWVvdXRfbXMsIDA2MDAsIHByZWVtcHRfdGltZW91dF9zaG93LCBwcmVlbXB0X3RpbWVvdXRf
c3RvcmUpOwogCiBzdGF0aWMgdm9pZCBrb2JqX2VuZ2luZV9yZWxlYXNlKHN0cnVjdCBrb2JqZWN0
ICprb2JqKQogewpAQCAtMTA5LDYgKzEzNiwxMSBAQCB2b2lkIGludGVsX2VuZ2luZXNfYWRkX3N5
c2ZzKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQogCQlpZiAoc3lzZnNfY3JlYXRlX2Zp
bGVzKGtvYmosIGZpbGVzKSkKIAkJCWdvdG8gZXJyX2VuZ2luZTsKIAorCQlpZiAoQ09ORklHX0RS
TV9JOTE1X1BSRUVNUFRfVElNRU9VVCAmJgorCQkgICAgaW50ZWxfZW5naW5lX2hhc19wcmVlbXB0
aW9uKGVuZ2luZSkgJiYKKwkJICAgIHN5c2ZzX2NyZWF0ZV9maWxlKGtvYmosICZwcmVlbXB0X3Rp
bWVvdXRfYXR0ci5hdHRyKSkKKwkJCWdvdG8gZXJyX2VuZ2luZTsKKwogCQlpZiAoMCkgewogZXJy
X2VuZ2luZToKIAkJCWRldl9lcnIoa2RldiwgIkZhaWxlZCB0byBhZGQgc3lzZnMgZW5naW5lICcl
cydcbiIsCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVf
dHlwZXMuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZV90eXBlcy5oCmlu
ZGV4IDYxOTkwNjRmMzMyYi4uNmFmOWIwMDk2OTc1IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfdHlwZXMuaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9ndC9pbnRlbF9lbmdpbmVfdHlwZXMuaApAQCAtMTczLDYgKzE3MywxMSBAQCBzdHJ1Y3QgaW50
ZWxfZW5naW5lX2V4ZWNsaXN0cyB7CiAJICovCiAJc3RydWN0IHRpbWVyX2xpc3QgdGltZXI7CiAK
KwkvKioKKwkgKiBAcHJlZW1wdDogcmVzZXQgdGhlIGN1cnJlbnQgY29udGV4dCBpZiBpdCBmYWls
cyB0byBnaXZlIHdheQorCSAqLworCXN0cnVjdCB0aW1lcl9saXN0IHByZWVtcHQ7CisKIAkvKioK
IAkgKiBAZGVmYXVsdF9wcmlvbGlzdDogcHJpb3JpdHkgbGlzdCBmb3IgSTkxNV9QUklPUklUWV9O
T1JNQUwKIAkgKi8KQEAgLTU0MSw2ICs1NDYsMTAgQEAgc3RydWN0IGludGVsX2VuZ2luZV9jcyB7
CiAJCSAqLwogCQlrdGltZV90IHRvdGFsOwogCX0gc3RhdHM7CisKKwlzdHJ1Y3QgeworCQl1bnNp
Z25lZCBsb25nIHByZWVtcHRfdGltZW91dDsKKwl9IHByb3BzOwogfTsKIAogc3RhdGljIGlubGlu
ZSBib29sCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9scmMuYyBi
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2xyYy5jCmluZGV4IDUwNDBmYmRkODFhZi4u
YWE1MmU1ZjM0ZGFiIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9s
cmMuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9scmMuYwpAQCAtMTQxNCw2
ICsxNDE0LDI5IEBAIHN0YXRpYyB2b2lkIHJlY29yZF9wcmVlbXB0aW9uKHN0cnVjdCBpbnRlbF9l
bmdpbmVfZXhlY2xpc3RzICpleGVjbGlzdHMpCiAJKHZvaWQpSTkxNV9TRUxGVEVTVF9PTkxZKGV4
ZWNsaXN0cy0+cHJlZW1wdF9oYW5nLmNvdW50KyspOwogfQogCitzdGF0aWMgdm9pZCBzZXRfcHJl
ZW1wdF90aW1lb3V0KHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKK3sKKwl1bnNpZ25l
ZCBsb25nIHRpbWVvdXQ7CisKKwlpZiAoIUNPTkZJR19EUk1fSTkxNV9QUkVFTVBUX1RJTUVPVVQp
CisJCXJldHVybjsKKworCXRpbWVvdXQgPSBSRUFEX09OQ0UoZW5naW5lLT5wcm9wcy5wcmVlbXB0
X3RpbWVvdXQpOworCWlmICghdGltZW91dCkKKwkJcmV0dXJuOworCisJdGltZW91dCA9IG1zZWNz
X3RvX2ppZmZpZXNfdGltZW91dCh0aW1lb3V0KTsKKwkvKgorCSAqIFBhcmFub2lhIHRvIG1ha2Ug
c3VyZSB0aGUgY29tcGlsZXIgY29tcHV0ZXMgdGhlIHRpbWVvdXQgYmVmb3JlCisJICogbG9hZGlu
ZyAnamlmZmllcycgYXMgamlmZmllcyBpcyB2b2xhdGlsZSBhbmQgbWF5IGJlIHVwZGF0ZWQgaW4K
KwkgKiB0aGUgYmFja2dyb3VuZCBieSBhIHRpbWVyIHRpY2suIEFsbCB0byByZWR1Y2UgdGhlIGNv
bXBsZXhpdHkKKwkgKiBvZiB0aGUgYWRkaXRpb24gYW5kIHJlZHVjZSB0aGUgcmlzayBvZiBsb3Np
bmcgYSBqaWZmaWUuCisJICovCisJYmFycmllcigpOworCisJbW9kX3RpbWVyKCZlbmdpbmUtPmV4
ZWNsaXN0cy5wcmVlbXB0LCBqaWZmaWVzICsgdGltZW91dCk7Cit9CisKIHN0YXRpYyB2b2lkIGV4
ZWNsaXN0c19kZXF1ZXVlKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKIHsKIAlzdHJ1
Y3QgaW50ZWxfZW5naW5lX2V4ZWNsaXN0cyAqIGNvbnN0IGV4ZWNsaXN0cyA9ICZlbmdpbmUtPmV4
ZWNsaXN0czsKQEAgLTE3NzcsNiArMTgwMCw4IEBAIHN0YXRpYyB2b2lkIGV4ZWNsaXN0c19kZXF1
ZXVlKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKIAogCQltZW1zZXQocG9ydCArIDEs
IDAsIChsYXN0X3BvcnQgLSBwb3J0KSAqIHNpemVvZigqcG9ydCkpOwogCQlleGVjbGlzdHNfc3Vi
bWl0X3BvcnRzKGVuZ2luZSk7CisKKwkJc2V0X3ByZWVtcHRfdGltZW91dChlbmdpbmUpOwogCX0g
ZWxzZSB7CiBza2lwX3N1Ym1pdDoKIAkJcmluZ19zZXRfcGF1c2VkKGVuZ2luZSwgMCk7CkBAIC0y
MDA4LDYgKzIwMzMsNDIgQEAgc3RhdGljIHZvaWQgX19leGVjbGlzdHNfc3VibWlzc2lvbl90YXNr
bGV0KHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmNvbnN0IGVuZ2luZSkKIAl9CiB9CiAKK3N0YXRp
YyBub2lubGluZSB2b2lkIHByZWVtcHRfcmVzZXQoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5n
aW5lKQoreworCWNvbnN0IHVuc2lnbmVkIGludCBiaXQgPSBJOTE1X1JFU0VUX0VOR0lORSArIGVu
Z2luZS0+aWQ7CisJdW5zaWduZWQgbG9uZyAqbG9jayA9ICZlbmdpbmUtPmd0LT5yZXNldC5mbGFn
czsKKworCWlmIChpOTE1X21vZHBhcmFtcy5yZXNldCA8IDMpCisJCXJldHVybjsKKworCWlmICh0
ZXN0X2FuZF9zZXRfYml0KGJpdCwgbG9jaykpCisJCXJldHVybjsKKworCS8qIE1hcmsgdGhpcyB0
YXNrbGV0IGFzIGRpc2FibGVkIHRvIGF2b2lkIHdhaXRpbmcgZm9yIGl0IHRvIGNvbXBsZXRlICov
CisJdGFza2xldF9kaXNhYmxlX25vc3luYygmZW5naW5lLT5leGVjbGlzdHMudGFza2xldCk7CisK
KwlHRU1fVFJBQ0UoIiVzOiBwcmVlbXB0IHRpbWVvdXQgJWx1KyV1bXNcbiIsCisJCSAgZW5naW5l
LT5uYW1lLAorCQkgIGVuZ2luZS0+cHJvcHMucHJlZW1wdF90aW1lb3V0LAorCQkgIGppZmZpZXNf
dG9fbXNlY3MoamlmZmllcyAtIGVuZ2luZS0+ZXhlY2xpc3RzLnByZWVtcHQuZXhwaXJlcykpOwor
CWludGVsX2VuZ2luZV9yZXNldChlbmdpbmUsICJwcmVlbXB0aW9uIHRpbWUgb3V0Iik7CisKKwl0
YXNrbGV0X2VuYWJsZSgmZW5naW5lLT5leGVjbGlzdHMudGFza2xldCk7CisJY2xlYXJfYW5kX3dh
a2VfdXBfYml0KGJpdCwgbG9jayk7Cit9CisKK3N0YXRpYyBib29sIHByZWVtcHRfdGltZW91dChz
dHJ1Y3QgaW50ZWxfZW5naW5lX2NzICpjb25zdCBlbmdpbmUpCit7CisJaWYgKCFDT05GSUdfRFJN
X0k5MTVfUFJFRU1QVF9USU1FT1VUKQorCQlyZXR1cm4gZmFsc2U7CisKKwlpZiAoIWludGVsX2Vu
Z2luZV9oYXNfcHJlZW1wdGlvbihlbmdpbmUpKQorCQlyZXR1cm4gZmFsc2U7CisKKwlyZXR1cm4g
IXRpbWVyX3BlbmRpbmcoJmVuZ2luZS0+ZXhlY2xpc3RzLnByZWVtcHQpICYmCisJCVJFQURfT05D
RShlbmdpbmUtPmV4ZWNsaXN0cy5wZW5kaW5nWzBdKTsKK30KKwogLyoKICAqIENoZWNrIHRoZSB1
bnJlYWQgQ29udGV4dCBTdGF0dXMgQnVmZmVycyBhbmQgbWFuYWdlIHRoZSBzdWJtaXNzaW9uIG9m
IG5ldwogICogY29udGV4dHMgdG8gdGhlIEVMU1AgYWNjb3JkaW5nbHkuCkBAIC0yMDE1LDIzICsy
MDc2LDM5IEBAIHN0YXRpYyB2b2lkIF9fZXhlY2xpc3RzX3N1Ym1pc3Npb25fdGFza2xldChzdHJ1
Y3QgaW50ZWxfZW5naW5lX2NzICpjb25zdCBlbmdpbmUpCiBzdGF0aWMgdm9pZCBleGVjbGlzdHNf
c3VibWlzc2lvbl90YXNrbGV0KHVuc2lnbmVkIGxvbmcgZGF0YSkKIHsKIAlzdHJ1Y3QgaW50ZWxf
ZW5naW5lX2NzICogY29uc3QgZW5naW5lID0gKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKilkYXRh
OwotCXVuc2lnbmVkIGxvbmcgZmxhZ3M7CisJYm9vbCB0aW1lb3V0ID0gcHJlZW1wdF90aW1lb3V0
KGVuZ2luZSk7CiAKIAlwcm9jZXNzX2NzYihlbmdpbmUpOwotCWlmICghUkVBRF9PTkNFKGVuZ2lu
ZS0+ZXhlY2xpc3RzLnBlbmRpbmdbMF0pKSB7CisJaWYgKCFSRUFEX09OQ0UoZW5naW5lLT5leGVj
bGlzdHMucGVuZGluZ1swXSkgfHwgdGltZW91dCkgeworCQl1bnNpZ25lZCBsb25nIGZsYWdzOwor
CiAJCXNwaW5fbG9ja19pcnFzYXZlKCZlbmdpbmUtPmFjdGl2ZS5sb2NrLCBmbGFncyk7CiAJCV9f
ZXhlY2xpc3RzX3N1Ym1pc3Npb25fdGFza2xldChlbmdpbmUpOwogCQlzcGluX3VubG9ja19pcnFy
ZXN0b3JlKCZlbmdpbmUtPmFjdGl2ZS5sb2NrLCBmbGFncyk7CisKKwkJLyogUmVjaGVjayBhZnRl
ciBzZXJpYWxpc2luZyB3aXRoIGRpcmVjdC1zdWJtaXNzaW9uICovCisJCWlmICh0aW1lb3V0ICYm
IHByZWVtcHRfdGltZW91dChlbmdpbmUpKQorCQkJcHJlZW1wdF9yZXNldChlbmdpbmUpOwogCX0K
IH0KIAotc3RhdGljIHZvaWQgZXhlY2xpc3RzX3N1Ym1pc3Npb25fdGltZXIoc3RydWN0IHRpbWVy
X2xpc3QgKnRpbWVyKQorc3RhdGljIHZvaWQgX19leGVjbGlzdHNfa2ljayhzdHJ1Y3QgaW50ZWxf
ZW5naW5lX2V4ZWNsaXN0cyAqZXhlY2xpc3RzKQogewotCXN0cnVjdCBpbnRlbF9lbmdpbmVfY3Mg
KmVuZ2luZSA9Ci0JCWZyb21fdGltZXIoZW5naW5lLCB0aW1lciwgZXhlY2xpc3RzLnRpbWVyKTsK
LQogCS8qIEtpY2sgdGhlIHRhc2tsZXQgZm9yIHNvbWUgaW50ZXJydXB0IGNvYWxlc2NpbmcgYW5k
IHJlc2V0IGhhbmRsaW5nICovCi0JdGFza2xldF9oaV9zY2hlZHVsZSgmZW5naW5lLT5leGVjbGlz
dHMudGFza2xldCk7CisJdGFza2xldF9oaV9zY2hlZHVsZSgmZXhlY2xpc3RzLT50YXNrbGV0KTsK
K30KKworI2RlZmluZSBleGVjbGlzdHNfa2ljayh0LCBtZW1iZXIpIFwKKwlfX2V4ZWNsaXN0c19r
aWNrKGNvbnRhaW5lcl9vZih0LCBzdHJ1Y3QgaW50ZWxfZW5naW5lX2V4ZWNsaXN0cywgbWVtYmVy
KSkKKworc3RhdGljIHZvaWQgZXhlY2xpc3RzX3RpbWVzbGljZShzdHJ1Y3QgdGltZXJfbGlzdCAq
dGltZXIpCit7CisJZXhlY2xpc3RzX2tpY2sodGltZXIsIHRpbWVyKTsKK30KKworc3RhdGljIHZv
aWQgZXhlY2xpc3RzX3ByZWVtcHQoc3RydWN0IHRpbWVyX2xpc3QgKnRpbWVyKQoreworCWV4ZWNs
aXN0c19raWNrKHRpbWVyLCBwcmVlbXB0KTsKIH0KIAogc3RhdGljIHZvaWQgcXVldWVfcmVxdWVz
dChzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUsCkBAIC0zNDQ5LDYgKzM1MjYsNyBAQCBn
ZW4xMl9lbWl0X2ZpbmlfYnJlYWRjcnVtYl9yY3Moc3RydWN0IGk5MTVfcmVxdWVzdCAqcmVxdWVz
dCwgdTMyICpjcykKIHN0YXRpYyB2b2lkIGV4ZWNsaXN0c19wYXJrKHN0cnVjdCBpbnRlbF9lbmdp
bmVfY3MgKmVuZ2luZSkKIHsKIAlkZWxfdGltZXIoJmVuZ2luZS0+ZXhlY2xpc3RzLnRpbWVyKTsK
KwlkZWxfdGltZXIoJmVuZ2luZS0+ZXhlY2xpc3RzLnByZWVtcHQpOwogfQogCiB2b2lkIGludGVs
X2V4ZWNsaXN0c19zZXRfZGVmYXVsdF9zdWJtaXNzaW9uKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3Mg
KmVuZ2luZSkKQEAgLTM1NjYsNyArMzY0NCw4IEBAIGludCBpbnRlbF9leGVjbGlzdHNfc3VibWlz
c2lvbl9zZXR1cChzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUpCiB7CiAJdGFza2xldF9p
bml0KCZlbmdpbmUtPmV4ZWNsaXN0cy50YXNrbGV0LAogCQkgICAgIGV4ZWNsaXN0c19zdWJtaXNz
aW9uX3Rhc2tsZXQsICh1bnNpZ25lZCBsb25nKWVuZ2luZSk7Ci0JdGltZXJfc2V0dXAoJmVuZ2lu
ZS0+ZXhlY2xpc3RzLnRpbWVyLCBleGVjbGlzdHNfc3VibWlzc2lvbl90aW1lciwgMCk7CisJdGlt
ZXJfc2V0dXAoJmVuZ2luZS0+ZXhlY2xpc3RzLnRpbWVyLCBleGVjbGlzdHNfdGltZXNsaWNlLCAw
KTsKKwl0aW1lcl9zZXR1cCgmZW5naW5lLT5leGVjbGlzdHMucHJlZW1wdCwgZXhlY2xpc3RzX3By
ZWVtcHQsIDApOwogCiAJbG9naWNhbF9yaW5nX2RlZmF1bHRfdmZ1bmNzKGVuZ2luZSk7CiAJbG9n
aWNhbF9yaW5nX2RlZmF1bHRfaXJxcyhlbmdpbmUpOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvaTkxNV9wYXJhbXMuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcGFyYW1z
LmgKaW5kZXggZDI5YWRlM2I3ZGU2Li41NjA1ODk3OGJiMjcgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2k5MTVfcGFyYW1zLmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkx
NV9wYXJhbXMuaApAQCAtNjEsNyArNjEsNyBAQCBzdHJ1Y3QgZHJtX3ByaW50ZXI7CiAJcGFyYW0o
Y2hhciAqLCBkbWNfZmlybXdhcmVfcGF0aCwgTlVMTCkgXAogCXBhcmFtKGludCwgbW1pb19kZWJ1
ZywgLUlTX0VOQUJMRUQoQ09ORklHX0RSTV9JOTE1X0RFQlVHX01NSU8pKSBcCiAJcGFyYW0oaW50
LCBlZHBfdnN3aW5nLCAwKSBcCi0JcGFyYW0oaW50LCByZXNldCwgMikgXAorCXBhcmFtKGludCwg
cmVzZXQsIDMpIFwKIAlwYXJhbSh1bnNpZ25lZCBpbnQsIGluamVjdF9sb2FkX2ZhaWx1cmUsIDAp
IFwKIAlwYXJhbShpbnQsIGZhc3Rib290LCAtMSkgXAogCXBhcmFtKGludCwgZW5hYmxlX2RwY2Rf
YmFja2xpZ2h0LCAwKSBcCi0tIAoyLjIzLjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3Rz
LmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xp
c3RpbmZvL2ludGVsLWdmeA==

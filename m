Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 0DAD55BF2D
	for <lists+intel-gfx@lfdr.de>; Mon,  1 Jul 2019 17:12:28 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 5FEE389C17;
	Mon,  1 Jul 2019 15:12:26 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 6D7D889C17
 for <intel-gfx@lists.freedesktop.org>; Mon,  1 Jul 2019 15:12:25 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17086874-1500050 
 for multiple; Mon, 01 Jul 2019 16:12:16 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon,  1 Jul 2019 16:12:13 +0100
Message-Id: <20190701151213.14856-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH] drm/i915/gem: Free pages before rcu-freeing the
 object
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Matthew Auld <matthew.auld@intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

QXMgd2UgaGF2ZSBkcm9wcGVkIHRoZSBmaW5hbCByZWZlcmVuY2UgdG8gdGhlIG9iamVjdCwgd2Ug
ZG8gbm90IG5lZWQgdG8Kd2FpdCB1bnRpbCBhZnRlciB0aGUgcmN1IGdyYWNlIHBlcmlvZCB0byBk
cm9wIGl0cyBwYWdlcy4gV2Ugc3RpbGwgcmVxdWlyZQpzdHJ1Y3RfbXV0ZXggdG8gY29tcGxldGVs
eSB1bmJpbmQgdGhlIG9iamVjdCB0byByZWxlYXNlIHRoZSBwYWdlcywgc28gd2UKc3RpbGwgbmVl
ZCBhIGZyZWUtd29ya2VyIHRvIG1hbmFnZSB0aGF0IGZyb20gcHJvY2VzcyBjb250ZXh0LiBCeQpz
Y2hlZHVsaW5nIHRoZSByZWxlYXNlIG9mIHBhZ2VzIGJlZm9yZSB3YWl0aW5nIGZvciB0aGUgcmN1
IHNob3VsZCBtZWFuCnRoYXQgd2UgYXJlIG5vdCB0cmFwcGluZyB0aG9zZSBwYWdlcyBmcm9tIGJl
eW9uZCB0aGUgcmVhY2ggb2YgdGhlCnNocmlua2VyLgoKQnVnemlsbGE6IGh0dHBzOi8vYnVncy5m
cmVlZGVza3RvcC5vcmcvc2hvd19idWcuY2dpP2lkPTExMTAzNQpGaXhlczogYTkzNjE1ZjkwMGJk
ICgiZHJtL2k5MTU6IFRocm93IGF3YXkgdGhlIGFjdGl2ZSBvYmplY3QgcmV0aXJlbWVudCBjb21w
bGV4aXR5IikKU2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24u
Y28udWs+CkNjOiBNYXR0aGV3IEF1bGQgPG1hdHRoZXcuYXVsZEBpbnRlbC5jb20+Ci0tLQogZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX29iamVjdC5jIHwgODIgKysrKysrKysrKy0t
LS0tLS0tLS0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYuaCAgICAgICAgICAgIHwg
MTEgKystCiAyIGZpbGVzIGNoYW5nZWQsIDQzIGluc2VydGlvbnMoKyksIDUwIGRlbGV0aW9ucygt
KQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9vYmplY3Qu
YyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9vYmplY3QuYwppbmRleCA0MzE5
NGZiY2JjMmUuLmQzZTk2ZjA5YzZiNyAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUv
Z2VtL2k5MTVfZ2VtX29iamVjdC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1
X2dlbV9vYmplY3QuYwpAQCAtMTQ2LDYgKzE0NiwxOCBAQCB2b2lkIGk5MTVfZ2VtX2Nsb3NlX29i
amVjdChzdHJ1Y3QgZHJtX2dlbV9vYmplY3QgKmdlbSwgc3RydWN0IGRybV9maWxlICpmaWxlKQog
CX0KIH0KIAorc3RhdGljIHZvaWQgX19pOTE1X2dlbV9mcmVlX29iamVjdF9yY3Uoc3RydWN0IHJj
dV9oZWFkICpoZWFkKQoreworCXN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmogPQorCQlj
b250YWluZXJfb2YoaGVhZCwgdHlwZW9mKCpvYmopLCByY3UpOworCXN0cnVjdCBkcm1faTkxNV9w
cml2YXRlICppOTE1ID0gdG9faTkxNShvYmotPmJhc2UuZGV2KTsKKworCWk5MTVfZ2VtX29iamVj
dF9mcmVlKG9iaik7CisKKwlHRU1fQlVHX09OKCFhdG9taWNfcmVhZCgmaTkxNS0+bW0uZnJlZV9j
b3VudCkpOworCWF0b21pY19kZWMoJmk5MTUtPm1tLmZyZWVfY291bnQpOworfQorCiBzdGF0aWMg
dm9pZCBfX2k5MTVfZ2VtX2ZyZWVfb2JqZWN0cyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkx
NSwKIAkJCQkgICAgc3RydWN0IGxsaXN0X25vZGUgKmZyZWVkKQogewpAQCAtMTY4LDIyICsxODAs
NiBAQCBzdGF0aWMgdm9pZCBfX2k5MTVfZ2VtX2ZyZWVfb2JqZWN0cyhzdHJ1Y3QgZHJtX2k5MTVf
cHJpdmF0ZSAqaTkxNSwKIAkJR0VNX0JVR19PTighbGlzdF9lbXB0eSgmb2JqLT52bWEubGlzdCkp
OwogCQlHRU1fQlVHX09OKCFSQl9FTVBUWV9ST09UKCZvYmotPnZtYS50cmVlKSk7CiAKLQkJLyoK
LQkJICogVGhpcyBzZXJpYWxpemVzIGZyZWVpbmcgd2l0aCB0aGUgc2hyaW5rZXIuIFNpbmNlIHRo
ZSBmcmVlCi0JCSAqIGlzIGRlbGF5ZWQsIGZpcnN0IGJ5IFJDVSB0aGVuIGJ5IHRoZSB3b3JrcXVl
dWUsIHdlIHdhbnQgdGhlCi0JCSAqIHNocmlua2VyIHRvIGJlIGFibGUgdG8gZnJlZSBwYWdlcyBv
ZiB1bnJlZmVyZW5jZWQgb2JqZWN0cywKLQkJICogb3IgZWxzZSB3ZSBtYXkgb29tIHdoaWxzdCB0
aGVyZSBhcmUgcGxlbnR5IG9mIGRlZmVycmVkCi0JCSAqIGZyZWVkIG9iamVjdHMuCi0JCSAqLwot
CQlpZiAoaTkxNV9nZW1fb2JqZWN0X2hhc19wYWdlcyhvYmopICYmCi0JCSAgICBpOTE1X2dlbV9v
YmplY3RfaXNfc2hyaW5rYWJsZShvYmopKSB7Ci0JCQl1bnNpZ25lZCBsb25nIGZsYWdzOwotCi0J
CQlzcGluX2xvY2tfaXJxc2F2ZSgmaTkxNS0+bW0ub2JqX2xvY2ssIGZsYWdzKTsKLQkJCWxpc3Rf
ZGVsX2luaXQoJm9iai0+bW0ubGluayk7Ci0JCQlzcGluX3VubG9ja19pcnFyZXN0b3JlKCZpOTE1
LT5tbS5vYmpfbG9jaywgZmxhZ3MpOwotCQl9Ci0KIAkJbXV0ZXhfdW5sb2NrKCZpOTE1LT5kcm0u
c3RydWN0X211dGV4KTsKIAogCQlHRU1fQlVHX09OKGF0b21pY19yZWFkKCZvYmotPmJpbmRfY291
bnQpKTsKQEAgLTE5NywxOSArMTkzLDE1IEBAIHN0YXRpYyB2b2lkIF9faTkxNV9nZW1fZnJlZV9v
YmplY3RzKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1LAogCQlhdG9taWNfc2V0KCZvYmot
Pm1tLnBhZ2VzX3Bpbl9jb3VudCwgMCk7CiAJCV9faTkxNV9nZW1fb2JqZWN0X3B1dF9wYWdlcyhv
YmosIEk5MTVfTU1fTk9STUFMKTsKIAkJR0VNX0JVR19PTihpOTE1X2dlbV9vYmplY3RfaGFzX3Bh
Z2VzKG9iaikpOworCQliaXRtYXBfZnJlZShvYmotPmJpdF8xNyk7CiAKIAkJaWYgKG9iai0+YmFz
ZS5pbXBvcnRfYXR0YWNoKQogCQkJZHJtX3ByaW1lX2dlbV9kZXN0cm95KCZvYmotPmJhc2UsIE5V
TEwpOwogCiAJCWRybV9nZW1fb2JqZWN0X3JlbGVhc2UoJm9iai0+YmFzZSk7CiAKLQkJYml0bWFw
X2ZyZWUob2JqLT5iaXRfMTcpOwotCQlpOTE1X2dlbV9vYmplY3RfZnJlZShvYmopOwotCi0JCUdF
TV9CVUdfT04oIWF0b21pY19yZWFkKCZpOTE1LT5tbS5mcmVlX2NvdW50KSk7Ci0JCWF0b21pY19k
ZWMoJmk5MTUtPm1tLmZyZWVfY291bnQpOwotCi0JCWNvbmRfcmVzY2hlZCgpOworCQkvKiBCdXQg
a2VlcCB0aGUgcG9pbnRlciBhbGl2ZSBmb3IgUkNVLXByb3RlY3RlZCBsb29rdXBzICovCisJCWNh
bGxfcmN1KCZvYmotPnJjdSwgX19pOTE1X2dlbV9mcmVlX29iamVjdF9yY3UpOwogCX0KIAlpbnRl
bF9ydW50aW1lX3BtX3B1dCgmaTkxNS0+cnVudGltZV9wbSwgd2FrZXJlZik7CiB9CkBAIC0yNjAs
MTggKzI1MiwzNCBAQCBzdGF0aWMgdm9pZCBfX2k5MTVfZ2VtX2ZyZWVfd29yayhzdHJ1Y3Qgd29y
a19zdHJ1Y3QgKndvcmspCiAJc3Bpbl91bmxvY2soJmk5MTUtPm1tLmZyZWVfbG9jayk7CiB9CiAK
LXN0YXRpYyB2b2lkIF9faTkxNV9nZW1fZnJlZV9vYmplY3RfcmN1KHN0cnVjdCByY3VfaGVhZCAq
aGVhZCkKK3ZvaWQgaTkxNV9nZW1fZnJlZV9vYmplY3Qoc3RydWN0IGRybV9nZW1fb2JqZWN0ICpn
ZW1fb2JqKQogewotCXN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmogPQotCQljb250YWlu
ZXJfb2YoaGVhZCwgdHlwZW9mKCpvYmopLCByY3UpOworCXN0cnVjdCBkcm1faTkxNV9nZW1fb2Jq
ZWN0ICpvYmogPSB0b19pbnRlbF9ibyhnZW1fb2JqKTsKIAlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0
ZSAqaTkxNSA9IHRvX2k5MTUob2JqLT5iYXNlLmRldik7CiAKIAkvKgotCSAqIFdlIHJldXNlIG9i
ai0+cmN1IGZvciB0aGUgZnJlZWQgbGlzdCwgc28gd2UgaGFkIGJldHRlciBub3QgdHJlYXQKLQkg
KiBpdCBsaWtlIGEgcmN1X2hlYWQgZnJvbSB0aGlzIHBvaW50IGZvcndhcmRzLiBBbmQgd2UgZXhw
ZWN0IGFsbAotCSAqIG9iamVjdHMgdG8gYmUgZnJlZWQgdmlhIHRoaXMgcGF0aC4KKwkgKiBCZWZv
cmUgd2UgZnJlZSB0aGUgb2JqZWN0LCBtYWtlIHN1cmUgYW55IHB1cmUgUkNVLW9ubHkKKwkgKiBy
ZWFkLXNpZGUgY3JpdGljYWwgc2VjdGlvbnMgYXJlIGNvbXBsZXRlLCBlLmcuCisJICogaTkxNV9n
ZW1fYnVzeV9pb2N0bCgpLiBGb3IgdGhlIGNvcnJlc3BvbmRpbmcgc3luY2hyb25pemVkCisJICog
bG9va3VwIHNlZSBpOTE1X2dlbV9vYmplY3RfbG9va3VwX3JjdSgpLgogCSAqLwotCWRlc3Ryb3lf
cmN1X2hlYWQoJm9iai0+cmN1KTsKKwlhdG9taWNfaW5jKCZpOTE1LT5tbS5mcmVlX2NvdW50KTsK
KworCS8qCisJICogVGhpcyBzZXJpYWxpemVzIGZyZWVpbmcgd2l0aCB0aGUgc2hyaW5rZXIuIFNp
bmNlIHRoZSBmcmVlCisJICogaXMgZGVsYXllZCwgZmlyc3QgYnkgUkNVIHRoZW4gYnkgdGhlIHdv
cmtxdWV1ZSwgd2Ugd2FudCB0aGUKKwkgKiBzaHJpbmtlciB0byBiZSBhYmxlIHRvIGZyZWUgcGFn
ZXMgb2YgdW5yZWZlcmVuY2VkIG9iamVjdHMsCisJICogb3IgZWxzZSB3ZSBtYXkgb29tIHdoaWxz
dCB0aGVyZSBhcmUgcGxlbnR5IG9mIGRlZmVycmVkCisJICogZnJlZWQgb2JqZWN0cy4KKwkgKi8K
KwlpZiAoaTkxNV9nZW1fb2JqZWN0X2hhc19wYWdlcyhvYmopICYmCisJICAgIGk5MTVfZ2VtX29i
amVjdF9pc19zaHJpbmthYmxlKG9iaikpIHsKKwkJdW5zaWduZWQgbG9uZyBmbGFnczsKKworCQlz
cGluX2xvY2tfaXJxc2F2ZSgmaTkxNS0+bW0ub2JqX2xvY2ssIGZsYWdzKTsKKwkJbGlzdF9kZWxf
aW5pdCgmb2JqLT5tbS5saW5rKTsKKwkJc3Bpbl91bmxvY2tfaXJxcmVzdG9yZSgmaTkxNS0+bW0u
b2JqX2xvY2ssIGZsYWdzKTsKKwl9CiAKIAkvKgogCSAqIFNpbmNlIHdlIHJlcXVpcmUgYmxvY2tp
bmcgb24gc3RydWN0X211dGV4IHRvIHVuYmluZCB0aGUgZnJlZWQKQEAgLTI4NywyMCArMjk1LDYg
QEAgc3RhdGljIHZvaWQgX19pOTE1X2dlbV9mcmVlX29iamVjdF9yY3Uoc3RydWN0IHJjdV9oZWFk
ICpoZWFkKQogCQlxdWV1ZV93b3JrKGk5MTUtPndxLCAmaTkxNS0+bW0uZnJlZV93b3JrKTsKIH0K
IAotdm9pZCBpOTE1X2dlbV9mcmVlX29iamVjdChzdHJ1Y3QgZHJtX2dlbV9vYmplY3QgKmdlbV9v
YmopCi17Ci0Jc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiA9IHRvX2ludGVsX2JvKGdl
bV9vYmopOwotCi0JLyoKLQkgKiBCZWZvcmUgd2UgZnJlZSB0aGUgb2JqZWN0LCBtYWtlIHN1cmUg
YW55IHB1cmUgUkNVLW9ubHkKLQkgKiByZWFkLXNpZGUgY3JpdGljYWwgc2VjdGlvbnMgYXJlIGNv
bXBsZXRlLCBlLmcuCi0JICogaTkxNV9nZW1fYnVzeV9pb2N0bCgpLiBGb3IgdGhlIGNvcnJlc3Bv
bmRpbmcgc3luY2hyb25pemVkCi0JICogbG9va3VwIHNlZSBpOTE1X2dlbV9vYmplY3RfbG9va3Vw
X3JjdSgpLgotCSAqLwotCWF0b21pY19pbmMoJnRvX2k5MTUob2JqLT5iYXNlLmRldiktPm1tLmZy
ZWVfY291bnQpOwotCWNhbGxfcmN1KCZvYmotPnJjdSwgX19pOTE1X2dlbV9mcmVlX29iamVjdF9y
Y3UpOwotfQotCiBzdGF0aWMgaW5saW5lIGVudW0gZmJfb3Bfb3JpZ2luCiBmYl93cml0ZV9vcmln
aW4oc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiwgdW5zaWduZWQgaW50IGRvbWFpbikK
IHsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZHJ2LmggYi9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9pOTE1X2Rydi5oCmluZGV4IDAyZGQ5ZjlmM2E4OS4uYWFlNTQ3YzNhMGYz
IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2Rydi5oCisrKyBiL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L2k5MTVfZHJ2LmgKQEAgLTI0NDYsMTggKzI0NDYsMTcgQEAgaW50IGk5
MTVfZ2VtX2ZyZWV6ZV9sYXRlKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdik7CiAK
IHN0YXRpYyBpbmxpbmUgdm9pZCBpOTE1X2dlbV9kcmFpbl9mcmVlZF9vYmplY3RzKHN0cnVjdCBk
cm1faTkxNV9wcml2YXRlICppOTE1KQogewotCWlmICghYXRvbWljX3JlYWQoJmk5MTUtPm1tLmZy
ZWVfY291bnQpKQotCQlyZXR1cm47Ci0KLQkvKiBBIHNpbmdsZSBwYXNzIHNob3VsZCBzdWZmaWNl
IHRvIHJlbGVhc2UgYWxsIHRoZSBmcmVlZCBvYmplY3RzIChhbG9uZworCS8qCisJICogQSBzaW5n
bGUgcGFzcyBzaG91bGQgc3VmZmljZSB0byByZWxlYXNlIGFsbCB0aGUgZnJlZWQgb2JqZWN0cyAo
YWxvbmcKIAkgKiBtb3N0IGNhbGwgcGF0aHMpICwgYnV0IGJlIGEgbGl0dGxlIG1vcmUgcGFyYW5v
aWQgaW4gdGhhdCBmcmVlaW5nCiAJICogdGhlIG9iamVjdHMgZG9lcyB0YWtlIGEgbGl0dGxlIGFt
b3VudCBvZiB0aW1lLCBkdXJpbmcgd2hpY2ggdGhlIHJjdQogCSAqIGNhbGxiYWNrcyBjb3VsZCBo
YXZlIGFkZGVkIG5ldyBvYmplY3RzIGludG8gdGhlIGZyZWVkIGxpc3QsIGFuZAogCSAqIGFybWVk
IHRoZSB3b3JrIGFnYWluLgogCSAqLwotCWRvIHsKKwl3aGlsZSAoYXRvbWljX3JlYWQoJmk5MTUt
Pm1tLmZyZWVfY291bnQpKSB7CisJCWZsdXNoX3dvcmsoJmk5MTUtPm1tLmZyZWVfd29yayk7CiAJ
CXJjdV9iYXJyaWVyKCk7Ci0JfSB3aGlsZSAoZmx1c2hfd29yaygmaTkxNS0+bW0uZnJlZV93b3Jr
KSk7CisJfQogfQogCiBzdGF0aWMgaW5saW5lIHZvaWQgaTkxNV9nZW1fZHJhaW5fd29ya3F1ZXVl
KHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQotLSAKMi4yMC4xCgpfX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpJbnRlbC1nZnggbWFpbGluZyBsaXN0
CkludGVsLWdmeEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3Rv
cC5vcmcvbWFpbG1hbi9saXN0aW5mby9pbnRlbC1nZng=

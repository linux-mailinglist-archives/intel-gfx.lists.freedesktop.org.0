Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 9813EB0CF0
	for <lists+intel-gfx@lfdr.de>; Thu, 12 Sep 2019 12:31:46 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 15ABD6ECB9;
	Thu, 12 Sep 2019 10:31:45 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id C7B2E6ECB8
 for <intel-gfx@lists.freedesktop.org>; Thu, 12 Sep 2019 10:31:42 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18462273-1500050 
 for multiple; Thu, 12 Sep 2019 11:31:31 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Thu, 12 Sep 2019 11:31:28 +0100
Message-Id: <20190912103128.21583-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20190911163815.11430-1-chris@chris-wilson.co.uk>
References: <20190911163815.11430-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v5] drm/i915/pmu: Use GT parked for estimating
 RC6 while asleep
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

QXMgd2UgdHJhY2sgd2hlbiB3ZSBwdXQgdGhlIEdUIGRldmljZSB0byBzbGVlcCB1cG9uIGlkbGlu
Zywgd2UgY2FuIHVzZQp0aGF0IGNhbGxiYWNrIHRvIHNhbXBsZSB0aGUgY3VycmVudCByYzYgY291
bnRlcnMgYW5kIHJlY29yZCB0aGUKdGltZXN0YW1wIGZvciBlc3RpbWF0aW5nIHNhbXBsZXMgYWZ0
ZXIgdGhhdCBwb2ludCB3aGlsZSBhc2xlZXAuCgp2MjogU3RpY2sgdG8gdXNpbmcga3RpbWVfdAp2
MzogVHJhY2sgdXNlcl93YWtlcmVmcyB0aGF0IGludGVyZmVyZSB3aXRoIHRoZSBuZXcKaW50ZWxf
Z3RfcG1fd2FpdF9mb3JfaWRsZQp2NDogTm8gbmVlZCBmb3IgcGFya2VkL3VucGFya2VkIGVzdGlt
YXRpb24gaWYgIUNPTkZJR19QTQp2NTogS2VlcCB0aW1lciBwYXJrL3VucGFyayBsb2dpYyBhcyB3
YXMKCkJ1Z3ppbGxhOiBodHRwczovL2J1Z3MuZnJlZWRlc2t0b3Aub3JnL3Nob3dfYnVnLmNnaT9p
ZD0xMDUwMTAKU2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24u
Y28udWs+CkNjOiBUdnJ0a28gVXJzdWxpbiA8dHZydGtvLnVyc3VsaW5AaW50ZWwuY29tPgotLS0K
IGRyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9wbS5jICAgfCAgMjIgKysrCiBkcml2
ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9ndF90eXBlcy5oIHwgICAxICsKIGRyaXZlcnMvZ3B1
L2RybS9pOTE1L2k5MTVfZGVidWdmcy5jICAgICAgfCAgMjIgKy0tCiBkcml2ZXJzL2dwdS9kcm0v
aTkxNS9pOTE1X3BtdS5jICAgICAgICAgIHwgMjM4ICsrKysrKysrKysrKystLS0tLS0tLS0tCiBk
cml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3BtdS5oICAgICAgICAgIHwgICA0ICstCiA1IGZpbGVz
IGNoYW5nZWQsIDE2NiBpbnNlcnRpb25zKCspLCAxMjEgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0
IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3BtLmMgYi9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9nZW0vaTkxNV9nZW1fcG0uYwppbmRleCAzYmQ3NjQxMDRkNDEuLmExMWFkNGQ5MTRj
YSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3BtLmMKKysr
IGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3BtLmMKQEAgLTE0MSw2ICsxNDEs
MjQgQEAgYm9vbCBpOTE1X2dlbV9sb2FkX3Bvd2VyX2NvbnRleHQoc3RydWN0IGRybV9pOTE1X3By
aXZhdGUgKmk5MTUpCiAJcmV0dXJuIHN3aXRjaF90b19rZXJuZWxfY29udGV4dF9zeW5jKCZpOTE1
LT5ndCk7CiB9CiAKK3N0YXRpYyB2b2lkIHVzZXJfZm9yY2V3YWtlKHN0cnVjdCBpbnRlbF9ndCAq
Z3QsIGJvb2wgc3VzcGVuZCkKK3sKKwlpbnQgY291bnQgPSBhdG9taWNfcmVhZCgmZ3QtPnVzZXJf
d2FrZXJlZik7CisKKwkvKiBJbnNpZGUgc3VzcGVuZC9yZXN1bWUgc28gc2luZ2xlIHRocmVhZGVk
LCBubyByYWNlcyB0byB3b3JyeSBhYm91dC4gKi8KKwlpZiAobGlrZWx5KCFjb3VudCkpCisJCXJl
dHVybjsKKworCWludGVsX2d0X3BtX2dldChndCk7CisJaWYgKHN1c3BlbmQpIHsKKwkJR0VNX0JV
R19PTihjb3VudCA+IGF0b21pY19yZWFkKCZndC0+d2FrZXJlZi5jb3VudCkpOworCQlhdG9taWNf
c3ViKGNvdW50LCAmZ3QtPndha2VyZWYuY291bnQpOworCX0gZWxzZSB7CisJCWF0b21pY19hZGQo
Y291bnQsICZndC0+d2FrZXJlZi5jb3VudCk7CisJfQorCWludGVsX2d0X3BtX3B1dChndCk7Cit9
CisKIHZvaWQgaTkxNV9nZW1fc3VzcGVuZChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkK
IHsKIAlHRU1fVFJBQ0UoIlxuIik7CkBAIC0xNDgsNiArMTY2LDggQEAgdm9pZCBpOTE1X2dlbV9z
dXNwZW5kKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQogCWludGVsX3dha2VyZWZfYXV0
bygmaTkxNS0+Z2d0dC51c2VyZmF1bHRfd2FrZXJlZiwgMCk7CiAJZmx1c2hfd29ya3F1ZXVlKGk5
MTUtPndxKTsKIAorCXVzZXJfZm9yY2V3YWtlKCZpOTE1LT5ndCwgdHJ1ZSk7CisKIAltdXRleF9s
b2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKIAogCS8qCkBAIC0yNTksNiArMjc5LDggQEAg
dm9pZCBpOTE1X2dlbV9yZXN1bWUoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCiAJaWYg
KCFpOTE1X2dlbV9sb2FkX3Bvd2VyX2NvbnRleHQoaTkxNSkpCiAJCWdvdG8gZXJyX3dlZGdlZDsK
IAorCXVzZXJfZm9yY2V3YWtlKCZpOTE1LT5ndCwgZmFsc2UpOworCiBvdXRfdW5sb2NrOgogCWlu
dGVsX3VuY29yZV9mb3JjZXdha2VfcHV0KCZpOTE1LT51bmNvcmUsIEZPUkNFV0FLRV9BTEwpOwog
CW11dGV4X3VubG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CmRpZmYgLS1naXQgYS9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9ndF90eXBlcy5oIGIvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ3QvaW50ZWxfZ3RfdHlwZXMuaAppbmRleCBkYzI5NWMxOTZkMTEuLjMwMzljZWY2NGIxMSAx
MDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZ3RfdHlwZXMuaAorKysg
Yi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9ndF90eXBlcy5oCkBAIC01MCw2ICs1MCw3
IEBAIHN0cnVjdCBpbnRlbF9ndCB7CiAJfSB0aW1lbGluZXM7CiAKIAlzdHJ1Y3QgaW50ZWxfd2Fr
ZXJlZiB3YWtlcmVmOworCWF0b21pY190IHVzZXJfd2FrZXJlZjsKIAogCXN0cnVjdCBsaXN0X2hl
YWQgY2xvc2VkX3ZtYTsKIAlzcGlubG9ja190IGNsb3NlZF9sb2NrOyAvKiBndWFyZHMgdGhlIGxp
c3Qgb2YgY2xvc2VkX3ZtYSAqLwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkx
NV9kZWJ1Z2ZzLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2RlYnVnZnMuYwppbmRleCBl
NTgzNTMzN2YwMjIuLmYzYWU1MjViNzdjMCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvaTkxNV9kZWJ1Z2ZzLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kZWJ1Z2Zz
LmMKQEAgLTM5OTUsMTMgKzM5OTUsMTIgQEAgc3RhdGljIGludCBpOTE1X3NzZXVfc3RhdHVzKHN0
cnVjdCBzZXFfZmlsZSAqbSwgdm9pZCAqdW51c2VkKQogc3RhdGljIGludCBpOTE1X2ZvcmNld2Fr
ZV9vcGVuKHN0cnVjdCBpbm9kZSAqaW5vZGUsIHN0cnVjdCBmaWxlICpmaWxlKQogewogCXN0cnVj
dCBkcm1faTkxNV9wcml2YXRlICppOTE1ID0gaW5vZGUtPmlfcHJpdmF0ZTsKKwlzdHJ1Y3QgaW50
ZWxfZ3QgKmd0ID0gJmk5MTUtPmd0OwogCi0JaWYgKElOVEVMX0dFTihpOTE1KSA8IDYpCi0JCXJl
dHVybiAwOwotCi0JZmlsZS0+cHJpdmF0ZV9kYXRhID0KLQkJKHZvaWQgKikodWludHB0cl90KWlu
dGVsX3J1bnRpbWVfcG1fZ2V0KCZpOTE1LT5ydW50aW1lX3BtKTsKLQlpbnRlbF91bmNvcmVfZm9y
Y2V3YWtlX3VzZXJfZ2V0KCZpOTE1LT51bmNvcmUpOworCWF0b21pY19pbmMoJmd0LT51c2VyX3dh
a2VyZWYpOworCWludGVsX2d0X3BtX2dldChndCk7CisJaWYgKElOVEVMX0dFTihpOTE1KSA+PSA2
KQorCQlpbnRlbF91bmNvcmVfZm9yY2V3YWtlX3VzZXJfZ2V0KGd0LT51bmNvcmUpOwogCiAJcmV0
dXJuIDA7CiB9CkBAIC00MDA5LDEzICs0MDA4LDEyIEBAIHN0YXRpYyBpbnQgaTkxNV9mb3JjZXdh
a2Vfb3BlbihzdHJ1Y3QgaW5vZGUgKmlub2RlLCBzdHJ1Y3QgZmlsZSAqZmlsZSkKIHN0YXRpYyBp
bnQgaTkxNV9mb3JjZXdha2VfcmVsZWFzZShzdHJ1Y3QgaW5vZGUgKmlub2RlLCBzdHJ1Y3QgZmls
ZSAqZmlsZSkKIHsKIAlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSA9IGlub2RlLT5pX3By
aXZhdGU7CisJc3RydWN0IGludGVsX2d0ICpndCA9ICZpOTE1LT5ndDsKIAotCWlmIChJTlRFTF9H
RU4oaTkxNSkgPCA2KQotCQlyZXR1cm4gMDsKLQotCWludGVsX3VuY29yZV9mb3JjZXdha2VfdXNl
cl9wdXQoJmk5MTUtPnVuY29yZSk7Ci0JaW50ZWxfcnVudGltZV9wbV9wdXQoJmk5MTUtPnJ1bnRp
bWVfcG0sCi0JCQkgICAgIChpbnRlbF93YWtlcmVmX3QpKHVpbnRwdHJfdClmaWxlLT5wcml2YXRl
X2RhdGEpOworCWlmIChJTlRFTF9HRU4oaTkxNSkgPj0gNikKKwkJaW50ZWxfdW5jb3JlX2ZvcmNl
d2FrZV91c2VyX3B1dCgmaTkxNS0+dW5jb3JlKTsKKwlpbnRlbF9ndF9wbV9wdXQoZ3QpOworCWF0
b21pY19kZWMoJmd0LT51c2VyX3dha2VyZWYpOwogCiAJcmV0dXJuIDA7CiB9CmRpZmYgLS1naXQg
YS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3BtdS5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUv
aTkxNV9wbXUuYwppbmRleCA4ZTI1MWU3MTkzOTAuLmQxNzJiYzlmMTdiMSAxMDA2NDQKLS0tIGEv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wbXUuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9pOTE1X3BtdS5jCkBAIC0xMTYsMjIgKzExNiwxMjAgQEAgc3RhdGljIGJvb2wgcG11X25lZWRz
X3RpbWVyKHN0cnVjdCBpOTE1X3BtdSAqcG11LCBib29sIGdwdV9hY3RpdmUpCiAJcmV0dXJuIGVu
YWJsZTsKIH0KIAotdm9pZCBpOTE1X3BtdV9ndF9wYXJrZWQoc3RydWN0IGRybV9pOTE1X3ByaXZh
dGUgKmk5MTUpCitzdGF0aWMgdTY0IF9fZ2V0X3JjNihjb25zdCBzdHJ1Y3QgaW50ZWxfZ3QgKmd0
KQoreworCXN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1ID0gZ3QtPmk5MTU7CisJdTY0IHZh
bDsKKworCXZhbCA9IGludGVsX3JjNl9yZXNpZGVuY3lfbnMoaTkxNSwKKwkJCQkgICAgIElTX1ZB
TExFWVZJRVcoaTkxNSkgPworCQkJCSAgICAgVkxWX0dUX1JFTkRFUl9SQzYgOgorCQkJCSAgICAg
R0VONl9HVF9HRlhfUkM2KTsKKworCWlmIChIQVNfUkM2cChpOTE1KSkKKwkJdmFsICs9IGludGVs
X3JjNl9yZXNpZGVuY3lfbnMoaTkxNSwgR0VONl9HVF9HRlhfUkM2cCk7CisKKwlpZiAoSEFTX1JD
NnBwKGk5MTUpKQorCQl2YWwgKz0gaW50ZWxfcmM2X3Jlc2lkZW5jeV9ucyhpOTE1LCBHRU42X0dU
X0dGWF9SQzZwcCk7CisKKwlyZXR1cm4gdmFsOworfQorCisjaWYgSVNfRU5BQkxFRChDT05GSUdf
UE0pCisKK3N0YXRpYyBpbmxpbmUgczY0IGt0aW1lX3NpbmNlKGNvbnN0IGt0aW1lX3Qga3QpCit7
CisJcmV0dXJuIGt0aW1lX3RvX25zKGt0aW1lX3N1YihrdGltZV9nZXQoKSwga3QpKTsKK30KKwor
c3RhdGljIHU2NCBnZXRfcmM2KHN0cnVjdCBpbnRlbF9ndCAqZ3QpCiB7CisJc3RydWN0IGRybV9p
OTE1X3ByaXZhdGUgKmk5MTUgPSBndC0+aTkxNTsKIAlzdHJ1Y3QgaTkxNV9wbXUgKnBtdSA9ICZp
OTE1LT5wbXU7CisJdW5zaWduZWQgbG9uZyBmbGFnczsKKwl1NjQgdmFsOwogCi0JaWYgKCFwbXUt
PmJhc2UuZXZlbnRfaW5pdCkKKwlzcGluX2xvY2tfaXJxc2F2ZSgmcG11LT5sb2NrLCBmbGFncyk7
CisKKwlpZiAoaW50ZWxfZ3RfcG1fZ2V0X2lmX2F3YWtlKGd0KSkgeworCQl2YWwgPSBfX2dldF9y
YzYoZ3QpOworCQlpbnRlbF9ndF9wbV9wdXQoZ3QpOworCisJCS8qCisJCSAqIElmIHdlIGFyZSBj
b21pbmcgYmFjayBmcm9tIGJlaW5nIHJ1bnRpbWUgc3VzcGVuZGVkIHdlIG11c3QKKwkJICogYmUg
Y2FyZWZ1bCBub3QgdG8gcmVwb3J0IGEgbGFyZ2VyIHZhbHVlIHRoYW4gcmV0dXJuZWQKKwkJICog
cHJldmlvdXNseS4KKwkJICovCisKKwkJaWYgKHZhbCA+PSBwbXUtPnNhbXBsZVtfX0k5MTVfU0FN
UExFX1JDNl9FU1RJTUFURURdLmN1cikgeworCQkJcG11LT5zYW1wbGVbX19JOTE1X1NBTVBMRV9S
QzZfRVNUSU1BVEVEXS5jdXIgPSAwOworCQkJcG11LT5zYW1wbGVbX19JOTE1X1NBTVBMRV9SQzZd
LmN1ciA9IHZhbDsKKwkJfSBlbHNlIHsKKwkJCXZhbCA9IHBtdS0+c2FtcGxlW19fSTkxNV9TQU1Q
TEVfUkM2X0VTVElNQVRFRF0uY3VyOworCQl9CisJfSBlbHNlIHsKKwkJLyoKKwkJICogV2UgYXJl
IHJ1bnRpbWUgc3VzcGVuZGVkLgorCQkgKgorCQkgKiBSZXBvcnQgdGhlIGRlbHRhIGZyb20gd2hl
biB0aGUgZGV2aWNlIHdhcyBzdXNwZW5kZWQgdG8gbm93LAorCQkgKiBvbiB0b3Agb2YgdGhlIGxh
c3Qga25vd24gcmVhbCB2YWx1ZSwgYXMgdGhlIGFwcHJveGltYXRlZCBSQzYKKwkJICogY291bnRl
ciB2YWx1ZS4KKwkJICovCisKKwkJdmFsID0ga3RpbWVfc2luY2UocG11LT5zbGVlcF9sYXN0KTsK
KwkJdmFsICs9IHBtdS0+c2FtcGxlW19fSTkxNV9TQU1QTEVfUkM2XS5jdXI7CisKKwkJcG11LT5z
YW1wbGVbX19JOTE1X1NBTVBMRV9SQzZfRVNUSU1BVEVEXS5jdXIgPSB2YWw7CisJfQorCisJc3Bp
bl91bmxvY2tfaXJxcmVzdG9yZSgmcG11LT5sb2NrLCBmbGFncyk7CisKKwlyZXR1cm4gdmFsOwor
fQorCitzdGF0aWMgdm9pZCBwYXJrX3JjNihzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkK
K3sKKwlzdHJ1Y3QgaTkxNV9wbXUgKnBtdSA9ICZpOTE1LT5wbXU7CisJdTY0IHZhbDsKKworCXZh
bCA9IDA7CisJaWYgKHBtdS0+c2FtcGxlW19fSTkxNV9TQU1QTEVfUkM2XS5jdXIpCisJCXZhbCA9
IF9fZ2V0X3JjNigmaTkxNS0+Z3QpOworCisJaWYgKHZhbCA+PSBwbXUtPnNhbXBsZVtfX0k5MTVf
U0FNUExFX1JDNl9FU1RJTUFURURdLmN1cikgeworCQlwbXUtPnNhbXBsZVtfX0k5MTVfU0FNUExF
X1JDNl9FU1RJTUFURURdLmN1ciA9IDA7CisJCXBtdS0+c2FtcGxlW19fSTkxNV9TQU1QTEVfUkM2
XS5jdXIgPSB2YWw7CisJfQorCXBtdS0+c2xlZXBfbGFzdCA9IGt0aW1lX2dldCgpOworfQorCitz
dGF0aWMgdm9pZCB1bnBhcmtfcmM2KHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQorewor
CXN0cnVjdCBpOTE1X3BtdSAqcG11ID0gJmk5MTUtPnBtdTsKKwl1NjQgdmFsOworCisJLyogRXN0
aW1hdGUgaG93IGxvbmcgd2Ugc2xlcHQgYW5kIGFjY3VtdWxhdGUgdGhhdCBpbnRvIHJjNiBjb3Vu
dGVycyAqLworCWlmICghcG11LT5zYW1wbGVbX19JOTE1X1NBTVBMRV9SQzZdLmN1cikKIAkJcmV0
dXJuOwogCi0Jc3Bpbl9sb2NrX2lycSgmcG11LT5sb2NrKTsKLQkvKgotCSAqIFNpZ25hbCBzYW1w
bGluZyB0aW1lciB0byBzdG9wIGlmIG9ubHkgZW5naW5lIGV2ZW50cyBhcmUgZW5hYmxlZCBhbmQK
LQkgKiBHUFUgd2VudCBpZGxlLgotCSAqLwotCXBtdS0+dGltZXJfZW5hYmxlZCA9IHBtdV9uZWVk
c190aW1lcihwbXUsIGZhbHNlKTsKLQlzcGluX3VubG9ja19pcnEoJnBtdS0+bG9jayk7CisJdmFs
ID0ga3RpbWVfc2luY2UocG11LT5zbGVlcF9sYXN0KTsKKwl2YWwgKz0gcG11LT5zYW1wbGVbX19J
OTE1X1NBTVBMRV9SQzZdLmN1cjsKKworCXBtdS0+c2FtcGxlW19fSTkxNV9TQU1QTEVfUkM2X0VT
VElNQVRFRF0uY3VyID0gdmFsOwogfQogCisjZWxzZQorCitzdGF0aWMgdTY0IGdldF9yYzYoc3Ry
dWN0IGludGVsX2d0ICpndCkKK3sKKwlyZXR1cm4gX19nZXRfcmM2KGd0KTsKK30KKworc3RhdGlj
IHZvaWQgcGFya19yYzYoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpIHt9Oworc3RhdGlj
IHZvaWQgdW5wYXJrX3JjNihzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkge307CisKKyNl
bmRpZgorCiBzdGF0aWMgdm9pZCBfX2k5MTVfcG11X21heWJlX3N0YXJ0X3RpbWVyKHN0cnVjdCBp
OTE1X3BtdSAqcG11KQogewogCWlmICghcG11LT50aW1lcl9lbmFibGVkICYmIHBtdV9uZWVkc190
aW1lcihwbXUsIHRydWUpKSB7CkBAIC0xNDMsNiArMjQxLDI2IEBAIHN0YXRpYyB2b2lkIF9faTkx
NV9wbXVfbWF5YmVfc3RhcnRfdGltZXIoc3RydWN0IGk5MTVfcG11ICpwbXUpCiAJfQogfQogCit2
b2lkIGk5MTVfcG11X2d0X3BhcmtlZChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKK3sK
KwlzdHJ1Y3QgaTkxNV9wbXUgKnBtdSA9ICZpOTE1LT5wbXU7CisKKwlpZiAoIXBtdS0+YmFzZS5l
dmVudF9pbml0KQorCQlyZXR1cm47CisKKwlzcGluX2xvY2tfaXJxKCZwbXUtPmxvY2spOworCisJ
cGFya19yYzYoaTkxNSk7CisKKwkvKgorCSAqIFNpZ25hbCBzYW1wbGluZyB0aW1lciB0byBzdG9w
IGlmIG9ubHkgZW5naW5lIGV2ZW50cyBhcmUgZW5hYmxlZCBhbmQKKwkgKiBHUFUgd2VudCBpZGxl
LgorCSAqLworCXBtdS0+dGltZXJfZW5hYmxlZCA9IHBtdV9uZWVkc190aW1lcihwbXUsIGZhbHNl
KTsKKworCXNwaW5fdW5sb2NrX2lycSgmcG11LT5sb2NrKTsKK30KKwogdm9pZCBpOTE1X3BtdV9n
dF91bnBhcmtlZChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKIHsKIAlzdHJ1Y3QgaTkx
NV9wbXUgKnBtdSA9ICZpOTE1LT5wbXU7CkBAIC0xNTEsMTAgKzI2OSwxNCBAQCB2b2lkIGk5MTVf
cG11X2d0X3VucGFya2VkKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQogCQlyZXR1cm47
CiAKIAlzcGluX2xvY2tfaXJxKCZwbXUtPmxvY2spOworCiAJLyoKIAkgKiBSZS1lbmFibGUgc2Ft
cGxpbmcgdGltZXIgd2hlbiBHUFUgZ29lcyBhY3RpdmUuCiAJICovCiAJX19pOTE1X3BtdV9tYXli
ZV9zdGFydF90aW1lcihwbXUpOworCisJdW5wYXJrX3JjNihpOTE1KTsKKwogCXNwaW5fdW5sb2Nr
X2lycSgmcG11LT5sb2NrKTsKIH0KIApAQCAtNDI2LDEwNCArNTQ4LDYgQEAgc3RhdGljIGludCBp
OTE1X3BtdV9ldmVudF9pbml0KHN0cnVjdCBwZXJmX2V2ZW50ICpldmVudCkKIAlyZXR1cm4gMDsK
IH0KIAotc3RhdGljIHU2NCBfX2dldF9yYzYoc3RydWN0IGludGVsX2d0ICpndCkKLXsKLQlzdHJ1
Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSA9IGd0LT5pOTE1OwotCXU2NCB2YWw7Ci0KLQl2YWwg
PSBpbnRlbF9yYzZfcmVzaWRlbmN5X25zKGk5MTUsCi0JCQkJICAgICBJU19WQUxMRVlWSUVXKGk5
MTUpID8KLQkJCQkgICAgIFZMVl9HVF9SRU5ERVJfUkM2IDoKLQkJCQkgICAgIEdFTjZfR1RfR0ZY
X1JDNik7Ci0KLQlpZiAoSEFTX1JDNnAoaTkxNSkpCi0JCXZhbCArPSBpbnRlbF9yYzZfcmVzaWRl
bmN5X25zKGk5MTUsIEdFTjZfR1RfR0ZYX1JDNnApOwotCi0JaWYgKEhBU19SQzZwcChpOTE1KSkK
LQkJdmFsICs9IGludGVsX3JjNl9yZXNpZGVuY3lfbnMoaTkxNSwgR0VONl9HVF9HRlhfUkM2cHAp
OwotCi0JcmV0dXJuIHZhbDsKLX0KLQotc3RhdGljIHU2NCBnZXRfcmM2KHN0cnVjdCBpbnRlbF9n
dCAqZ3QpCi17Ci0jaWYgSVNfRU5BQkxFRChDT05GSUdfUE0pCi0Jc3RydWN0IGRybV9pOTE1X3By
aXZhdGUgKmk5MTUgPSBndC0+aTkxNTsKLQlzdHJ1Y3QgaW50ZWxfcnVudGltZV9wbSAqcnBtID0g
Jmk5MTUtPnJ1bnRpbWVfcG07Ci0Jc3RydWN0IGk5MTVfcG11ICpwbXUgPSAmaTkxNS0+cG11Owot
CWludGVsX3dha2VyZWZfdCB3YWtlcmVmOwotCXVuc2lnbmVkIGxvbmcgZmxhZ3M7Ci0JdTY0IHZh
bDsKLQotCXdha2VyZWYgPSBpbnRlbF9ydW50aW1lX3BtX2dldF9pZl9pbl91c2UocnBtKTsKLQlp
ZiAod2FrZXJlZikgewotCQl2YWwgPSBfX2dldF9yYzYoZ3QpOwotCQlpbnRlbF9ydW50aW1lX3Bt
X3B1dChycG0sIHdha2VyZWYpOwotCi0JCS8qCi0JCSAqIElmIHdlIGFyZSBjb21pbmcgYmFjayBm
cm9tIGJlaW5nIHJ1bnRpbWUgc3VzcGVuZGVkIHdlIG11c3QKLQkJICogYmUgY2FyZWZ1bCBub3Qg
dG8gcmVwb3J0IGEgbGFyZ2VyIHZhbHVlIHRoYW4gcmV0dXJuZWQKLQkJICogcHJldmlvdXNseS4K
LQkJICovCi0KLQkJc3Bpbl9sb2NrX2lycXNhdmUoJnBtdS0+bG9jaywgZmxhZ3MpOwotCi0JCWlm
ICh2YWwgPj0gcG11LT5zYW1wbGVbX19JOTE1X1NBTVBMRV9SQzZfRVNUSU1BVEVEXS5jdXIpIHsK
LQkJCXBtdS0+c2FtcGxlW19fSTkxNV9TQU1QTEVfUkM2X0VTVElNQVRFRF0uY3VyID0gMDsKLQkJ
CXBtdS0+c2FtcGxlW19fSTkxNV9TQU1QTEVfUkM2XS5jdXIgPSB2YWw7Ci0JCX0gZWxzZSB7Ci0J
CQl2YWwgPSBwbXUtPnNhbXBsZVtfX0k5MTVfU0FNUExFX1JDNl9FU1RJTUFURURdLmN1cjsKLQkJ
fQotCi0JCXNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJnBtdS0+bG9jaywgZmxhZ3MpOwotCX0gZWxz
ZSB7Ci0JCXN0cnVjdCBkZXZpY2UgKmtkZXYgPSBycG0tPmtkZXY7Ci0KLQkJLyoKLQkJICogV2Ug
YXJlIHJ1bnRpbWUgc3VzcGVuZGVkLgotCQkgKgotCQkgKiBSZXBvcnQgdGhlIGRlbHRhIGZyb20g
d2hlbiB0aGUgZGV2aWNlIHdhcyBzdXNwZW5kZWQgdG8gbm93LAotCQkgKiBvbiB0b3Agb2YgdGhl
IGxhc3Qga25vd24gcmVhbCB2YWx1ZSwgYXMgdGhlIGFwcHJveGltYXRlZCBSQzYKLQkJICogY291
bnRlciB2YWx1ZS4KLQkJICovCi0JCXNwaW5fbG9ja19pcnFzYXZlKCZwbXUtPmxvY2ssIGZsYWdz
KTsKLQotCQkvKgotCQkgKiBBZnRlciB0aGUgYWJvdmUgYnJhbmNoIGludGVsX3J1bnRpbWVfcG1f
Z2V0X2lmX2luX3VzZSBmYWlsZWQKLQkJICogdG8gZ2V0IHRoZSBydW50aW1lIFBNIHJlZmVyZW5j
ZSB3ZSBjYW5ub3QgYXNzdW1lIHdlIGFyZSBpbgotCQkgKiBydW50aW1lIHN1c3BlbmQgc2luY2Ug
d2UgY2FuIGVpdGhlcjogYSkgcmFjZSB3aXRoIGNvbWluZyBvdXQKLQkJICogb2YgaXQgYmVmb3Jl
IHdlIHRvb2sgdGhlIHBvd2VyLmxvY2ssIG9yIGIpIHRoZXJlIGFyZSBvdGhlcgotCQkgKiBzdGF0
ZXMgdGhhbiBzdXNwZW5kZWQgd2hpY2ggY2FuIGJyaW5nIHVzIGhlcmUuCi0JCSAqCi0JCSAqIFdl
IG5lZWQgdG8gZG91YmxlLWNoZWNrIHRoYXQgd2UgYXJlIGluZGVlZCBjdXJyZW50bHkgcnVudGlt
ZQotCQkgKiBzdXNwZW5kZWQgYW5kIGlmIG5vdCB3ZSBjYW5ub3QgZG8gYmV0dGVyIHRoYW4gcmVw
b3J0IHRoZSBsYXN0Ci0JCSAqIGtub3duIFJDNiB2YWx1ZS4KLQkJICovCi0JCWlmIChwbV9ydW50
aW1lX3N0YXR1c19zdXNwZW5kZWQoa2RldikpIHsKLQkJCXZhbCA9IHBtX3J1bnRpbWVfc3VzcGVu
ZGVkX3RpbWUoa2Rldik7Ci0KLQkJCWlmICghcG11LT5zYW1wbGVbX19JOTE1X1NBTVBMRV9SQzZf
RVNUSU1BVEVEXS5jdXIpCi0JCQkJcG11LT5zdXNwZW5kZWRfdGltZV9sYXN0ID0gdmFsOwotCi0J
CQl2YWwgLT0gcG11LT5zdXNwZW5kZWRfdGltZV9sYXN0OwotCQkJdmFsICs9IHBtdS0+c2FtcGxl
W19fSTkxNV9TQU1QTEVfUkM2XS5jdXI7Ci0KLQkJCXBtdS0+c2FtcGxlW19fSTkxNV9TQU1QTEVf
UkM2X0VTVElNQVRFRF0uY3VyID0gdmFsOwotCQl9IGVsc2UgaWYgKHBtdS0+c2FtcGxlW19fSTkx
NV9TQU1QTEVfUkM2X0VTVElNQVRFRF0uY3VyKSB7Ci0JCQl2YWwgPSBwbXUtPnNhbXBsZVtfX0k5
MTVfU0FNUExFX1JDNl9FU1RJTUFURURdLmN1cjsKLQkJfSBlbHNlIHsKLQkJCXZhbCA9IHBtdS0+
c2FtcGxlW19fSTkxNV9TQU1QTEVfUkM2XS5jdXI7Ci0JCX0KLQotCQlzcGluX3VubG9ja19pcnFy
ZXN0b3JlKCZwbXUtPmxvY2ssIGZsYWdzKTsKLQl9Ci0KLQlyZXR1cm4gdmFsOwotI2Vsc2UKLQly
ZXR1cm4gX19nZXRfcmM2KGd0KTsKLSNlbmRpZgotfQotCiBzdGF0aWMgdTY0IF9faTkxNV9wbXVf
ZXZlbnRfcmVhZChzdHJ1Y3QgcGVyZl9ldmVudCAqZXZlbnQpCiB7CiAJc3RydWN0IGRybV9pOTE1
X3ByaXZhdGUgKmk5MTUgPQpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9w
bXUuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcG11LmgKaW5kZXggNGZjNGYyNDc4MzAx
Li4wNjdkYmJmM2JkZmYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcG11
LmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wbXUuaApAQCAtOTcsOSArOTcsOSBA
QCBzdHJ1Y3QgaTkxNV9wbXUgewogCSAqLwogCXN0cnVjdCBpOTE1X3BtdV9zYW1wbGUgc2FtcGxl
W19fSTkxNV9OVU1fUE1VX1NBTVBMRVJTXTsKIAkvKioKLQkgKiBAc3VzcGVuZGVkX3RpbWVfbGFz
dDogQ2FjaGVkIHN1c3BlbmQgdGltZSBmcm9tIFBNIGNvcmUuCisJICogQHNsZWVwX2xhc3Q6IExh
c3QgdGltZSBHVCBwYXJrZWQgZm9yIFJDNiBlc3RpbWF0aW9uLgogCSAqLwotCXU2NCBzdXNwZW5k
ZWRfdGltZV9sYXN0OworCWt0aW1lX3Qgc2xlZXBfbGFzdDsKIAkvKioKIAkgKiBAaTkxNV9hdHRy
OiBNZW1vcnkgYmxvY2sgaG9sZGluZyBkZXZpY2UgYXR0cmlidXRlcy4KIAkgKi8KLS0gCjIuMjMu
MAoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwt
Z2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8v
bGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

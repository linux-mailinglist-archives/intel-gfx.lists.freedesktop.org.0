Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id E3E0F1F3AD7
	for <lists+intel-gfx@lfdr.de>; Tue,  9 Jun 2020 14:46:09 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 73EF16E29A;
	Tue,  9 Jun 2020 12:46:07 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 9DA356E29A
 for <intel-gfx@lists.freedesktop.org>; Tue,  9 Jun 2020 12:46:05 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 21442447-1500050 
 for multiple; Tue, 09 Jun 2020 13:45:34 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Tue,  9 Jun 2020 13:45:34 +0100
Message-Id: <20200609124534.2322481-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.27.0
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH i-g-t] i915/gem_exec_schedule: Try to spot
 unfairness
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Chris Wilson <chris@chris-wilson.co.uk>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

QW4gaW1wb3J0YW50IHByb3BlcnR5IGZvciBtdWx0aS1jbGllbnQgc3lzdGVtcyBpcyB0aGF0IGVh
Y2ggY2xpZW50IGdldHMKYSAnZmFpcicgYWxsb3RtZW50IG9mIHN5c3RlbSB0aW1lLiAoV2hlcmUg
ZmFpcm5lc3MgaXMgYXQgdGhlIHdoaW0gb2YgdGhlCmNvbnRleHQgcHJvcGVydGllcywgc3VjaCBh
cyBwcmlvcml0aWVzLikgVGhpcyB0ZXN0IGZvcmtzIE4gaW5kZXBlbmRlbnQKY2xpZW50cyAoYWxi
ZWl0IHRoZXkgaGFwcGVuIHRvIHNoYXJlIGEgc2luZ2xlIHZtKSwgYW5kIGRvZXMgYW4gZXF1YWwK
YW1vdW50IG9mIHdvcmsgaW4gY2xpZW50IGFuZCBhc3NlcnRzIHRoYXQgdGhleSB0YWtlIGFuIGVx
dWFsIGFtb3VudCBvZgp0aW1lLgoKVGhvdWdoIHdlIGhhdmUgbmV2ZXIgY2xhaW1lZCB0byBoYXZl
IGEgY29tcGxldGVseSBmYWlyIHNjaGVkdWxlciwgdGhhdAppcyB3aGF0IGlzIGV4cGVjdGVkLgoK
U2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28udWs+CkNj
OiBUdnJ0a28gVXJzdWxpbiA8dHZydGtvLnVyc3VsaW5AaW50ZWwuY29tPgpDYzogUmFtYWxpbmdh
bSBDIDxyYW1hbGluZ2FtLmNAaW50ZWwuY29tPgotLS0KIHRlc3RzL2k5MTUvZ2VtX2V4ZWNfc2No
ZWR1bGUuYyB8IDY5OSArKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysKIDEgZmlsZSBj
aGFuZ2VkLCA2OTkgaW5zZXJ0aW9ucygrKQoKZGlmZiAtLWdpdCBhL3Rlc3RzL2k5MTUvZ2VtX2V4
ZWNfc2NoZWR1bGUuYyBiL3Rlc3RzL2k5MTUvZ2VtX2V4ZWNfc2NoZWR1bGUuYwppbmRleCA1NmM2
Mzg4MzMuLmIzYTFmZWRhYSAxMDA2NDQKLS0tIGEvdGVzdHMvaTkxNS9nZW1fZXhlY19zY2hlZHVs
ZS5jCisrKyBiL3Rlc3RzL2k5MTUvZ2VtX2V4ZWNfc2NoZWR1bGUuYwpAQCAtMjksNiArMjksNyBA
QAogI2luY2x1ZGUgPHN5cy9wb2xsLmg+CiAjaW5jbHVkZSA8c3lzL2lvY3RsLmg+CiAjaW5jbHVk
ZSA8c3lzL21tYW4uaD4KKyNpbmNsdWRlIDxzeXMvcmVzb3VyY2UuaD4KICNpbmNsdWRlIDxzeXMv
c3lzY2FsbC5oPgogI2luY2x1ZGUgPHNjaGVkLmg+CiAjaW5jbHVkZSA8c2lnbmFsLmg+CkBAIC0y
NDk1LDYgKzI0OTYsNjY2IEBAIHN0YXRpYyB2b2lkIG1lYXN1cmVfc2VtYXBob3JlX3Bvd2VyKGlu
dCBpOTE1KQogCXJhcGxfY2xvc2UoJnBrZyk7CiB9CiAKK3N0YXRpYyBpbnQgcmVhZF90aW1lc3Rh
bXBfZnJlcXVlbmN5KGludCBpOTE1KQoreworCWludCB2YWx1ZSA9IDA7CisJZHJtX2k5MTVfZ2V0
cGFyYW1fdCBncCA9IHsKKwkJLnZhbHVlID0gJnZhbHVlLAorCQkucGFyYW0gPSBJOTE1X1BBUkFN
X0NTX1RJTUVTVEFNUF9GUkVRVUVOQ1ksCisJfTsKKwlpb2N0bChpOTE1LCBEUk1fSU9DVExfSTkx
NV9HRVRQQVJBTSwgJmdwKTsKKwlyZXR1cm4gdmFsdWU7Cit9CisKK3N0YXRpYyB1aW50NjRfdCBk
aXY2NF91NjRfcm91bmRfdXAodWludDY0X3QgeCwgdWludDY0X3QgeSkKK3sKKwlyZXR1cm4gKHgg
KyB5IC0gMSkgLyB5OworfQorCitzdGF0aWMgdWludDY0X3QgbnNfdG9fdGlja3MoaW50IGk5MTUs
IHVpbnQ2NF90IG5zKQoreworCXJldHVybiBkaXY2NF91NjRfcm91bmRfdXAobnMgKiByZWFkX3Rp
bWVzdGFtcF9mcmVxdWVuY3koaTkxNSksCisJCQkJICBOU0VDX1BFUl9TRUMpOworfQorCitzdGF0
aWMgdWludDY0X3QgdGlja3NfdG9fbnMoaW50IGk5MTUsIHVpbnQ2NF90IHRpY2tzKQoreworCXJl
dHVybiBkaXY2NF91NjRfcm91bmRfdXAodGlja3MgKiBOU0VDX1BFUl9TRUMsCisJCQkJICByZWFk
X3RpbWVzdGFtcF9mcmVxdWVuY3koaTkxNSkpOworfQorCisjZGVmaW5lIE1JX0lOU1RSKG9wY29k
ZSwgZmxhZ3MpICgoKG9wY29kZSkgPDwgMjMpIHwgKGZsYWdzKSkKKworI2RlZmluZSBNSV9NQVRI
KHgpICAgICAgICAgICAgICAgICAgICAgIE1JX0lOU1RSKDB4MWEsICh4KSAtIDEpCisjZGVmaW5l
IE1JX01BVEhfSU5TVFIob3Bjb2RlLCBvcDEsIG9wMikgKChvcGNvZGUpIDw8IDIwIHwgKG9wMSkg
PDwgMTAgfCAob3AyKSkKKy8qIE9wY29kZXMgZm9yIE1JX01BVEhfSU5TVFIgKi8KKyNkZWZpbmUg
ICBNSV9NQVRIX05PT1AgICAgICAgICAgICAgICAgICBNSV9NQVRIX0lOU1RSKDB4MDAwLCAweDAs
IDB4MCkKKyNkZWZpbmUgICBNSV9NQVRIX0xPQUQob3AxLCBvcDIpICAgICAgICBNSV9NQVRIX0lO
U1RSKDB4MDgwLCBvcDEsIG9wMikKKyNkZWZpbmUgICBNSV9NQVRIX0xPQURJTlYob3AxLCBvcDIp
ICAgICBNSV9NQVRIX0lOU1RSKDB4NDgwLCBvcDEsIG9wMikKKyNkZWZpbmUgICBNSV9NQVRIX0xP
QUQwKG9wMSkgICAgICAgICAgICBNSV9NQVRIX0lOU1RSKDB4MDgxLCBvcDEpCisjZGVmaW5lICAg
TUlfTUFUSF9MT0FEMShvcDEpICAgICAgICAgICAgTUlfTUFUSF9JTlNUUigweDQ4MSwgb3AxKQor
I2RlZmluZSAgIE1JX01BVEhfQUREICAgICAgICAgICAgICAgICAgIE1JX01BVEhfSU5TVFIoMHgx
MDAsIDB4MCwgMHgwKQorI2RlZmluZSAgIE1JX01BVEhfU1VCICAgICAgICAgICAgICAgICAgIE1J
X01BVEhfSU5TVFIoMHgxMDEsIDB4MCwgMHgwKQorI2RlZmluZSAgIE1JX01BVEhfQU5EICAgICAg
ICAgICAgICAgICAgIE1JX01BVEhfSU5TVFIoMHgxMDIsIDB4MCwgMHgwKQorI2RlZmluZSAgIE1J
X01BVEhfT1IgICAgICAgICAgICAgICAgICAgIE1JX01BVEhfSU5TVFIoMHgxMDMsIDB4MCwgMHgw
KQorI2RlZmluZSAgIE1JX01BVEhfWE9SICAgICAgICAgICAgICAgICAgIE1JX01BVEhfSU5TVFIo
MHgxMDQsIDB4MCwgMHgwKQorI2RlZmluZSAgIE1JX01BVEhfU1RPUkUob3AxLCBvcDIpICAgICAg
IE1JX01BVEhfSU5TVFIoMHgxODAsIG9wMSwgb3AyKQorI2RlZmluZSAgIE1JX01BVEhfU1RPUkVJ
TlYob3AxLCBvcDIpICAgIE1JX01BVEhfSU5TVFIoMHg1ODAsIG9wMSwgb3AyKQorLyogUmVnaXN0
ZXJzIHVzZWQgYXMgb3BlcmFuZHMgaW4gTUlfTUFUSF9JTlNUUiAqLworI2RlZmluZSAgIE1JX01B
VEhfUkVHKHgpICAgICAgICAgICAgICAgICh4KQorI2RlZmluZSAgIE1JX01BVEhfUkVHX1NSQ0Eg
ICAgICAgICAgICAgIDB4MjAKKyNkZWZpbmUgICBNSV9NQVRIX1JFR19TUkNCICAgICAgICAgICAg
ICAweDIxCisjZGVmaW5lICAgTUlfTUFUSF9SRUdfQUNDVSAgICAgICAgICAgICAgMHgzMQorI2Rl
ZmluZSAgIE1JX01BVEhfUkVHX1pGICAgICAgICAgICAgICAgIDB4MzIKKyNkZWZpbmUgICBNSV9N
QVRIX1JFR19DRiAgICAgICAgICAgICAgICAweDMzCisKKyNkZWZpbmUgTUlfTE9BRF9SRUdJU1RF
Ul9SRUcgICAgTUlfSU5TVFIoMHgyQSwgMSkKKworc3RhdGljIHZvaWQgZGVsYXkoaW50IGk5MTUs
CisJCSAgY29uc3Qgc3RydWN0IGludGVsX2V4ZWN1dGlvbl9lbmdpbmUyICplLAorCQkgIHVpbnQz
Ml90IGhhbmRsZSwKKwkJICB1aW50NjRfdCBhZGRyLAorCQkgIHVpbnQ2NF90IG5zKQoreworCWNv
bnN0IGludCB1c2VfNjRiID0gaW50ZWxfZ2VuKGludGVsX2dldF9kcm1fZGV2aWQoaTkxNSkpID49
IDg7CisJY29uc3QgdWludDMyX3QgYmFzZSA9IGdlbV9lbmdpbmVfbW1pb19iYXNlKGk5MTUsIGUt
Pm5hbWUpOworI2RlZmluZSBDU19HUFIoeCkgKGJhc2UgKyAweDYwMCArIDggKiAoeCkpCisjZGVm
aW5lIFJVTlRJTUUgKGJhc2UgKyAweDNhOCkKKwllbnVtIHsgU1RBUlRfVFMsIE5PV19UUyB9Owor
CXVpbnQzMl90ICptYXAsICpjcywgKmptcDsKKworCWlndF9yZXF1aXJlKGJhc2UpOworCisJY3Mg
PSBtYXAgPSBnZW1fbW1hcF9fZGV2aWNlX2NvaGVyZW50KGk5MTUsIGhhbmRsZSwgMCwgNDA5Niwg
UFJPVF9XUklURSk7CisKKwkqY3MrKyA9IE1JX0xPQURfUkVHSVNURVJfSU1NOworCSpjcysrID0g
Q1NfR1BSKFNUQVJUX1RTKSArIDQ7CisJKmNzKysgPSAwOworCSpjcysrID0gTUlfTE9BRF9SRUdJ
U1RFUl9SRUc7CisJKmNzKysgPSBSVU5USU1FOworCSpjcysrID0gQ1NfR1BSKFNUQVJUX1RTKTsK
KworCXdoaWxlIChvZmZzZXRfaW5fcGFnZShjcykgJiA2MykKKwkJKmNzKysgPSAwOworCWptcCA9
IGNzOworCisJKmNzKysgPSAweDUgPDwgMjM7IC8qIE1JX0FSQl9DSEVDSyAqLworCisJKmNzKysg
PSBNSV9MT0FEX1JFR0lTVEVSX0lNTTsKKwkqY3MrKyA9IENTX0dQUihOT1dfVFMpICsgNDsKKwkq
Y3MrKyA9IDA7CisJKmNzKysgPSBNSV9MT0FEX1JFR0lTVEVSX1JFRzsKKwkqY3MrKyA9IFJVTlRJ
TUU7CisJKmNzKysgPSBDU19HUFIoTk9XX1RTKTsKKworCSpjcysrID0gTUlfTUFUSCg0KTsKKwkq
Y3MrKyA9IE1JX01BVEhfTE9BRChNSV9NQVRIX1JFR19TUkNBLCBNSV9NQVRIX1JFRyhOT1dfVFMp
KTsKKwkqY3MrKyA9IE1JX01BVEhfTE9BRChNSV9NQVRIX1JFR19TUkNCLCBNSV9NQVRIX1JFRyhT
VEFSVF9UUykpOworCSpjcysrID0gTUlfTUFUSF9TVUI7CisJKmNzKysgPSBNSV9NQVRIX1NUT1JF
SU5WKE1JX01BVEhfUkVHKE5PV19UUyksIE1JX01BVEhfUkVHX0FDQ1UpOworCisJKmNzKysgPSAw
eDI0IDw8IDIzIHwgKDEgKyB1c2VfNjRiKTsgLyogU1JNICovCisJKmNzKysgPSBDU19HUFIoTk9X
X1RTKTsKKwkqY3MrKyA9IGFkZHIgKyA0MDAwOworCSpjcysrID0gYWRkciA+PiAzMjsKKworCS8q
IERlbGF5IGJldHdlZW4gU1JNIGFuZCBDT05EX0JCRSB0byBwb3N0IHRoZSB3cml0ZXMgKi8KKwlm
b3IgKGludCBuID0gMDsgbiA8IDg7IG4rKykgeworCQkqY3MrKyA9IE1JX1NUT1JFX0RXT1JEX0lN
TTsKKwkJaWYgKHVzZV82NGIpIHsKKwkJCSpjcysrID0gYWRkciArIDQwNjQ7CisJCQkqY3MrKyA9
IGFkZHIgPj4gMzI7CisJCX0gZWxzZSB7CisJCQkqY3MrKyA9IDA7CisJCQkqY3MrKyA9IGFkZHIg
KyA0MDY0OworCQl9CisJCSpjcysrID0gMDsKKwl9CisKKwkqY3MrKyA9IE1JX0NPTkRfQkFUQ0hf
QlVGRkVSX0VORCB8IE1JX0RPX0NPTVBBUkUgfCAoMSArIHVzZV82NGIpOworCSpjcysrID0gfm5z
X3RvX3RpY2tzKGk5MTUsIG5zKTsKKwkqY3MrKyA9IGFkZHIgKyA0MDAwOworCSpjcysrID0gYWRk
ciA+PiAzMjsKKworCSpjcysrID0gTUlfQkFUQ0hfQlVGRkVSX1NUQVJUIHwgMSA8PCA4IHwgdXNl
XzY0YjsKKwkqY3MrKyA9IGFkZHIgKyBvZmZzZXRfaW5fcGFnZShqbXApOworCSpjcysrID0gYWRk
ciA+PiAzMjsKKworCW11bm1hcChtYXAsIDQwOTYpOworfQorCitzdGF0aWMgc3RydWN0IGRybV9p
OTE1X2dlbV9leGVjX29iamVjdDIKK2RlbGF5X2NyZWF0ZShpbnQgaTkxNSwgdWludDMyX3QgY3R4
LAorCSAgICAgY29uc3Qgc3RydWN0IGludGVsX2V4ZWN1dGlvbl9lbmdpbmUyICplLAorCSAgICAg
dWludDY0X3QgdGFyZ2V0X25zKQoreworCXN0cnVjdCBkcm1faTkxNV9nZW1fZXhlY19vYmplY3Qy
IG9iaiA9IHsKKwkJLmhhbmRsZSA9IGJhdGNoX2NyZWF0ZShpOTE1KSwKKwkJLmZsYWdzID0gRVhF
Q19PQkpFQ1RfU1VQUE9SVFNfNDhCX0FERFJFU1MsCisJfTsKKwlzdHJ1Y3QgZHJtX2k5MTVfZ2Vt
X2V4ZWNidWZmZXIyIGV4ZWNidWYgPSB7CisJCS5idWZmZXJzX3B0ciA9IHRvX3VzZXJfcG9pbnRl
cigmb2JqKSwKKwkJLmJ1ZmZlcl9jb3VudCA9IDEsCisJCS5yc3ZkMSA9IGN0eCwKKwkJLmZsYWdz
ID0gZS0+ZmxhZ3MsCisJfTsKKworCWdlbV9leGVjYnVmKGk5MTUsICZleGVjYnVmKTsKKwlnZW1f
c3luYyhpOTE1LCBvYmouaGFuZGxlKTsKKworCWRlbGF5KGk5MTUsIGUsIG9iai5oYW5kbGUsIG9i
ai5vZmZzZXQsIHRhcmdldF9ucyk7CisKKwlvYmouZmxhZ3MgfD0gRVhFQ19PQkpFQ1RfUElOTkVE
OworCXJldHVybiBvYmo7Cit9CisKK3N0YXRpYyB2b2lkIHRzbG9nKGludCBpOTE1LAorCQkgIGNv
bnN0IHN0cnVjdCBpbnRlbF9leGVjdXRpb25fZW5naW5lMiAqZSwKKwkJICB1aW50MzJfdCBoYW5k
bGUsCisJCSAgdWludDY0X3QgYWRkcikKK3sKKwljb25zdCBpbnQgdXNlXzY0YiA9IGludGVsX2dl
bihpbnRlbF9nZXRfZHJtX2RldmlkKGk5MTUpKSA+PSA4OworCWNvbnN0IHVpbnQzMl90IGJhc2Ug
PSBnZW1fZW5naW5lX21taW9fYmFzZShpOTE1LCBlLT5uYW1lKTsKKyNkZWZpbmUgQ1NfR1BSKHgp
IChiYXNlICsgMHg2MDAgKyA4ICogKHgpKQorI2RlZmluZSBDU19USU1FU1RBTVAgKGJhc2UgKyAw
eDM1OCkKKwllbnVtIHsgT05FLCBNQVNLLCBBRERSIH07CisJdWludDMyX3QgKnRpbWVzdGFtcF9s
bywgKmFkZHJfbG87CisJdWludDMyX3QgKm1hcCwgKmNzOworCisJaWd0X3JlcXVpcmUoYmFzZSk7
CisKKwltYXAgPSBnZW1fbW1hcF9fZGV2aWNlX2NvaGVyZW50KGk5MTUsIGhhbmRsZSwgMCwgNDA5
NiwgUFJPVF9XUklURSk7CisJY3MgPSBtYXAgKyA1MTI7CisKKwkqY3MrKyA9IDB4MjQgPDwgMjMg
fCAoMSArIHVzZV82NGIpOyAvKiBTUk0gKi8KKwkqY3MrKyA9IENTX1RJTUVTVEFNUDsKKwl0aW1l
c3RhbXBfbG8gPSBjczsKKwkqY3MrKyA9IGFkZHI7CisJKmNzKysgPSBhZGRyID4+IDMyOworCisJ
KmNzKysgPSBNSV9MT0FEX1JFR0lTVEVSX0lNTTsKKwkqY3MrKyA9IENTX0dQUihBRERSKTsKKwlh
ZGRyX2xvID0gY3M7CisJKmNzKysgPSBhZGRyOworCSpjcysrID0gTUlfTE9BRF9SRUdJU1RFUl9J
TU07CisJKmNzKysgPSBDU19HUFIoQUREUikgKyA0OworCSpjcysrID0gYWRkciA+PiAzMjsKKwor
CSpjcysrID0gTUlfTE9BRF9SRUdJU1RFUl9JTU07CisJKmNzKysgPSBDU19HUFIoT05FKTsKKwkq
Y3MrKyA9IDQ7CisJKmNzKysgPSBNSV9MT0FEX1JFR0lTVEVSX0lNTTsKKwkqY3MrKyA9IENTX0dQ
UihPTkUpICsgNDsKKwkqY3MrKyA9IDA7CisKKwkqY3MrKyA9IE1JX0xPQURfUkVHSVNURVJfSU1N
OworCSpjcysrID0gQ1NfR1BSKE1BU0spOworCSpjcysrID0gMHhmZmZmZjdmZjsKKwkqY3MrKyA9
IE1JX0xPQURfUkVHSVNURVJfSU1NOworCSpjcysrID0gQ1NfR1BSKE1BU0spICsgNDsKKwkqY3Mr
KyA9IDB4ZmZmZmZmZmY7CisKKwkqY3MrKyA9IE1JX01BVEgoOCk7CisJKmNzKysgPSBNSV9NQVRI
X0xPQUQoTUlfTUFUSF9SRUdfU1JDQSwgTUlfTUFUSF9SRUcoT05FKSk7CisJKmNzKysgPSBNSV9N
QVRIX0xPQUQoTUlfTUFUSF9SRUdfU1JDQiwgTUlfTUFUSF9SRUcoQUREUikpOworCSpjcysrID0g
TUlfTUFUSF9BREQ7CisJKmNzKysgPSBNSV9NQVRIX1NUT1JFKE1JX01BVEhfUkVHKEFERFIpLCBN
SV9NQVRIX1JFR19BQ0NVKTsKKwkqY3MrKyA9IE1JX01BVEhfTE9BRChNSV9NQVRIX1JFR19TUkNB
LCBNSV9NQVRIX1JFRyhBRERSKSk7CisJKmNzKysgPSBNSV9NQVRIX0xPQUQoTUlfTUFUSF9SRUdf
U1JDQiwgTUlfTUFUSF9SRUcoTUFTSykpOworCSpjcysrID0gTUlfTUFUSF9BTkQ7CisJKmNzKysg
PSBNSV9NQVRIX1NUT1JFKE1JX01BVEhfUkVHKEFERFIpLCBNSV9NQVRIX1JFR19BQ0NVKTsKKwor
CSpjcysrID0gMHgyNCA8PCAyMyB8ICgxICsgdXNlXzY0Yik7IC8qIFNSTSAqLworCSpjcysrID0g
Q1NfR1BSKEFERFIpOworCSpjcysrID0gYWRkciArIG9mZnNldF9pbl9wYWdlKHRpbWVzdGFtcF9s
byk7CisJKmNzKysgPSBhZGRyID4+IDMyOworCSpjcysrID0gMHgyNCA8PCAyMyB8ICgxICsgdXNl
XzY0Yik7IC8qIFNSTSAqLworCSpjcysrID0gQ1NfR1BSKEFERFIpOworCSpjcysrID0gYWRkciAr
IG9mZnNldF9pbl9wYWdlKGFkZHJfbG8pOworCSpjcysrID0gYWRkciA+PiAzMjsKKworCSpjcysr
ID0gTUlfQkFUQ0hfQlVGRkVSX0VORDsKKworCW11bm1hcChtYXAsIDQwOTYpOworfQorCitzdGF0
aWMgc3RydWN0IGRybV9pOTE1X2dlbV9leGVjX29iamVjdDIKK3RzbG9nX2NyZWF0ZShpbnQgaTkx
NSwgdWludDMyX3QgY3R4LCBjb25zdCBzdHJ1Y3QgaW50ZWxfZXhlY3V0aW9uX2VuZ2luZTIgKmUp
Cit7CisJc3RydWN0IGRybV9pOTE1X2dlbV9leGVjX29iamVjdDIgb2JqID0geworCQkuaGFuZGxl
ID0gYmF0Y2hfY3JlYXRlKGk5MTUpLAorCQkuZmxhZ3MgPSBFWEVDX09CSkVDVF9TVVBQT1JUU180
OEJfQUREUkVTUywKKwl9OworCXN0cnVjdCBkcm1faTkxNV9nZW1fZXhlY2J1ZmZlcjIgZXhlY2J1
ZiA9IHsKKwkJLmJ1ZmZlcnNfcHRyID0gdG9fdXNlcl9wb2ludGVyKCZvYmopLAorCQkuYnVmZmVy
X2NvdW50ID0gMSwKKwkJLnJzdmQxID0gY3R4LAorCQkuZmxhZ3MgPSBlLT5mbGFncywKKwl9Owor
CisJZ2VtX2V4ZWNidWYoaTkxNSwgJmV4ZWNidWYpOworCWdlbV9zeW5jKGk5MTUsIG9iai5oYW5k
bGUpOworCisJdHNsb2coaTkxNSwgZSwgb2JqLmhhbmRsZSwgb2JqLm9mZnNldCk7CisKKwlvYmou
ZmxhZ3MgfD0gRVhFQ19PQkpFQ1RfUElOTkVEOworCXJldHVybiBvYmo7Cit9CisKK3N0YXRpYyBp
bnQgY21wX3UzMihjb25zdCB2b2lkICpBLCBjb25zdCB2b2lkICpCKQoreworCWNvbnN0IHVpbnQz
Ml90ICphID0gQSwgKmIgPSBCOworCisJaWYgKCphIDwgKmIpCisJCXJldHVybiAtMTsKKwllbHNl
IGlmICgqYSA+ICpiKQorCQlyZXR1cm4gMTsKKwllbHNlCisJCXJldHVybiAwOworfQorCitzdGF0
aWMgc3RydWN0IGludGVsX2V4ZWN1dGlvbl9lbmdpbmUyCitwaWNrX3JhbmRvbV9lbmdpbmUoaW50
IGk5MTUsIGNvbnN0IHN0cnVjdCBpbnRlbF9leGVjdXRpb25fZW5naW5lMiAqbm90KQoreworCWNv
bnN0IHN0cnVjdCBpbnRlbF9leGVjdXRpb25fZW5naW5lMiAqZTsKKwl1bnNpZ25lZCBpbnQgY291
bnQgPSAwOworCisJX19mb3JfZWFjaF9waHlzaWNhbF9lbmdpbmUoaTkxNSwgZSkgeworCQlpZiAo
ZS0+ZmxhZ3MgPT0gbm90LT5mbGFncykKKwkJCWNvbnRpbnVlOworCQlpZiAoIWdlbV9jbGFzc19o
YXNfbXV0YWJsZV9zdWJtaXNzaW9uKGk5MTUsIGUtPmNsYXNzKSkKKwkJCWNvbnRpbnVlOworCQlj
b3VudCsrOworCX0KKwlpZiAoIWNvdW50KQorCQlyZXR1cm4gKm5vdDsKKworCWNvdW50ID0gcmFu
ZCgpICUgY291bnQ7CisJX19mb3JfZWFjaF9waHlzaWNhbF9lbmdpbmUoaTkxNSwgZSkgeworCQlp
ZiAoZS0+ZmxhZ3MgPT0gbm90LT5mbGFncykKKwkJCWNvbnRpbnVlOworCQlpZiAoIWdlbV9jbGFz
c19oYXNfbXV0YWJsZV9zdWJtaXNzaW9uKGk5MTUsIGUtPmNsYXNzKSkKKwkJCWNvbnRpbnVlOwor
CQlpZiAoIWNvdW50LS0pCisJCQlicmVhazsKKwl9CisKKwlyZXR1cm4gKmU7Cit9CisKK3N0YXRp
YyB2b2lkIGZhaXJfY2hpbGQoaW50IGk5MTUsIHVpbnQzMl90IGN0eCwKKwkJICAgICAgIGNvbnN0
IHN0cnVjdCBpbnRlbF9leGVjdXRpb25fZW5naW5lMiAqZSwKKwkJICAgICAgIHVpbnQ2NF90IGZy
YW1lX25zLAorCQkgICAgICAgaW50IHRpbWVsaW5lLAorCQkgICAgICAgdWludDMyX3QgY29tbW9u
LAorCQkgICAgICAgdW5zaWduZWQgaW50IGZsYWdzLAorCQkgICAgICAgdW5zaWduZWQgbG9uZyAq
Y3RsLAorCQkgICAgICAgdW5zaWduZWQgbG9uZyAqb3V0KQorI2RlZmluZSBGX1NZTkMgICgxIDw8
IDApCisjZGVmaW5lIEZfUEFDRSAgKDEgPDwgMSkKKyNkZWZpbmUgRl9GTE9XICAoMSA8PCAyKQor
I2RlZmluZSBGX0hBTEYgICgxIDw8IDMpCisjZGVmaW5lIEZfU09MTyAgKDEgPDwgNCkKKyNkZWZp
bmUgRl9TUEFSRSAoMSA8PCA1KQorI2RlZmluZSBGX05FWFQgICgxIDw8IDYpCisjZGVmaW5lIEZf
VklQICAgKDEgPDwgNykKKyNkZWZpbmUgRl9SUlVMICAoMSA8PCA4KQorI2RlZmluZSBGX1NIQVJF
ICgxIDw8IDkpCisjZGVmaW5lIEZfUElORyAgKDEgPDwgMTApCit7CisJY29uc3QgaW50IGJhdGNo
ZXNfcGVyX2ZyYW1lID0gZmxhZ3MgJiBGX1NPTE8gPyAxIDogMzsKKwlzdHJ1Y3QgZHJtX2k5MTVf
Z2VtX2V4ZWNfb2JqZWN0MiBvYmpbNF0gPSB7CisJCXt9LAorCQl7CisJCQkuaGFuZGxlID0gY29t
bW9uID86IGdlbV9jcmVhdGUoaTkxNSwgNDA5NiksCisJCX0sCisJCWRlbGF5X2NyZWF0ZShpOTE1
LCBjdHgsIGUsIGZyYW1lX25zIC8gYmF0Y2hlc19wZXJfZnJhbWUpLAorCQlkZWxheV9jcmVhdGUo
aTkxNSwgY3R4LCBlLCBmcmFtZV9ucyAvIGJhdGNoZXNfcGVyX2ZyYW1lKSwKKwl9OworCXN0cnVj
dCBpbnRlbF9leGVjdXRpb25fZW5naW5lMiBwaW5nID0gKmU7CisJaW50IHBfZmVuY2UgPSAtMSwg
bl9mZW5jZSA9IC0xOworCXVuc2lnbmVkIGxvbmcgY291bnQgPSAwOworCWludCBuOworCisJc3Jh
bmRvbShnZXRwaWQoKSk7CisJaWYgKGZsYWdzICYgRl9QSU5HKQorCQlwaW5nID0gcGlja19yYW5k
b21fZW5naW5lKGk5MTUsIGUpOworCW9ialswXSA9IHRzbG9nX2NyZWF0ZShpOTE1LCBjdHgsICZw
aW5nKTsKKworCXdoaWxlICghUkVBRF9PTkNFKCpjdGwpKSB7CisJCXN0cnVjdCBkcm1faTkxNV9n
ZW1fZXhlY2J1ZmZlcjIgZXhlY2J1ZiA9IHsKKwkJCS5idWZmZXJzX3B0ciA9IHRvX3VzZXJfcG9p
bnRlcihvYmopLAorCQkJLmJ1ZmZlcl9jb3VudCA9IDQsCisJCQkucnN2ZDEgPSBjdHgsCisJCQku
cnN2ZDIgPSAtMSwKKwkJCS5mbGFncyA9IGUtPmZsYWdzLAorCQl9OworCisJCWlmIChmbGFncyAm
IEZfRkxPVykgeworCQkJdW5zaWduZWQgaW50IHNlcTsKKworCQkJc2VxID0gY291bnQ7CisJCQlp
ZiAoZmxhZ3MgJiBGX05FWFQpCisJCQkJc2VxKys7CisKKwkJCWV4ZWNidWYucnN2ZDIgPQorCQkJ
CXN3X3N5bmNfdGltZWxpbmVfY3JlYXRlX2ZlbmNlKHRpbWVsaW5lLCBzZXEpOworCQkJZXhlY2J1
Zi5mbGFncyB8PSBJOTE1X0VYRUNfRkVOQ0VfSU47CisJCX0KKworCQlleGVjYnVmLmZsYWdzIHw9
IEk5MTVfRVhFQ19GRU5DRV9PVVQ7CisJCWdlbV9leGVjYnVmX3dyKGk5MTUsICZleGVjYnVmKTsK
KwkJbl9mZW5jZSA9IGV4ZWNidWYucnN2ZDIgPj4gMzI7CisJCWV4ZWNidWYuZmxhZ3MgJj0gfihJ
OTE1X0VYRUNfRkVOQ0VfT1VUIHwgSTkxNV9FWEVDX0ZFTkNFX0lOKTsKKwkJZm9yIChuID0gMTsg
biA8IGJhdGNoZXNfcGVyX2ZyYW1lOyBuKyspCisJCQlnZW1fZXhlY2J1ZihpOTE1LCAmZXhlY2J1
Zik7CisJCWNsb3NlKGV4ZWNidWYucnN2ZDIpOworCisJCWV4ZWNidWYuYnVmZmVyX2NvdW50ID0g
MTsKKwkJZXhlY2J1Zi5iYXRjaF9zdGFydF9vZmZzZXQgPSAyMDQ4OworCQlleGVjYnVmLmZsYWdz
ID0gcGluZy5mbGFncyB8IEk5MTVfRVhFQ19GRU5DRV9JTjsKKwkJZXhlY2J1Zi5yc3ZkMiA9IG5f
ZmVuY2U7CisJCWdlbV9leGVjYnVmKGk5MTUsICZleGVjYnVmKTsKKworCQlpZiAoZmxhZ3MgJiBG
X1BBQ0UgJiYgcF9mZW5jZSAhPSAtMSkgeworCQkJc3RydWN0IHBvbGxmZCBwZmQgPSB7CisJCQkJ
LmZkID0gcF9mZW5jZSwKKwkJCQkuZXZlbnRzID0gUE9MTElOLAorCQkJfTsKKwkJCXBvbGwoJnBm
ZCwgMSwgLTEpOworCQl9CisJCWNsb3NlKHBfZmVuY2UpOworCisJCWlmIChmbGFncyAmIEZfU1lO
QykgeworCQkJc3RydWN0IHBvbGxmZCBwZmQgPSB7CisJCQkJLmZkID0gbl9mZW5jZSwKKwkJCQku
ZXZlbnRzID0gUE9MTElOLAorCQkJfTsKKwkJCXBvbGwoJnBmZCwgMSwgLTEpOworCQl9CisKKwkJ
aWd0X3N3YXAob2JqWzJdLCBvYmpbM10pOworCQlpZ3Rfc3dhcChwX2ZlbmNlLCBuX2ZlbmNlKTsK
KwkJY291bnQrKzsKKwl9CisJY2xvc2UocF9mZW5jZSk7CisKKwlnZW1fY2xvc2UoaTkxNSwgb2Jq
WzNdLmhhbmRsZSk7CisJZ2VtX2Nsb3NlKGk5MTUsIG9ialsyXS5oYW5kbGUpOworCWlmIChvYmpb
MV0uaGFuZGxlICE9IGNvbW1vbikKKwkJZ2VtX2Nsb3NlKGk5MTUsIG9ialsxXS5oYW5kbGUpOwor
CisJZ2VtX3N5bmMoaTkxNSwgb2JqWzBdLmhhbmRsZSk7CisJaWYgKG91dCkgeworCQl1aW50MzJf
dCAqbWFwOworCisJCW1hcCA9IGdlbV9tbWFwX19kZXZpY2VfY29oZXJlbnQoaTkxNSwgb2JqWzBd
LmhhbmRsZSwKKwkJCQkJCTAsIDQwOTYsIFBST1RfV1JJVEUpOworCQlmb3IgKG4gPSAxOyBuIDwg
bWluKGNvdW50LCA1MTIpOyBuKyspIHsKKwkJCWlndF9hc3NlcnQobWFwW25dKTsKKwkJCW1hcFtu
IC0gMV0gPSBtYXBbbl0gLSBtYXBbbiAtIDFdOworCQl9CisJCXFzb3J0KG1hcCwgLS1uLCBzaXpl
b2YoKm1hcCksIGNtcF91MzIpOworCQkqb3V0ID0gdGlja3NfdG9fbnMoaTkxNSwgbWFwW24gLyAy
XSk7CisJCW11bm1hcChtYXAsIDQwOTYpOworCX0KKwlnZW1fY2xvc2UoaTkxNSwgb2JqWzBdLmhh
bmRsZSk7Cit9CisKK3N0YXRpYyBpbnQgY21wX3VsKGNvbnN0IHZvaWQgKkEsIGNvbnN0IHZvaWQg
KkIpCit7CisJY29uc3QgdW5zaWduZWQgbG9uZyAqYSA9IEEsICpiID0gQjsKKworCWlmICgqYSA8
ICpiKQorCQlyZXR1cm4gLTE7CisJZWxzZSBpZiAoKmEgPiAqYikKKwkJcmV0dXJuIDE7CisJZWxz
ZQorCQlyZXR1cm4gMDsKK30KKworc3RhdGljIHVpbnQ2NF90IGRfY3B1X3RpbWUoY29uc3Qgc3Ry
dWN0IHJ1c2FnZSAqYSwgY29uc3Qgc3RydWN0IHJ1c2FnZSAqYikKK3sKKwl1aW50NjRfdCBjcHVf
dGltZSA9IDA7CisKKwljcHVfdGltZSArPSAoYS0+cnVfdXRpbWUudHZfc2VjIC0gYi0+cnVfdXRp
bWUudHZfc2VjKSAqIE5TRUNfUEVSX1NFQzsKKwljcHVfdGltZSArPSAoYS0+cnVfdXRpbWUudHZf
dXNlYyAtIGItPnJ1X3V0aW1lLnR2X3VzZWMpICogMTAwMDsKKworCWNwdV90aW1lICs9IChhLT5y
dV9zdGltZS50dl9zZWMgLSBiLT5ydV9zdGltZS50dl9zZWMpICogTlNFQ19QRVJfU0VDOworCWNw
dV90aW1lICs9IChhLT5ydV9zdGltZS50dl91c2VjIC0gYi0+cnVfc3RpbWUudHZfdXNlYykgKiAx
MDAwOworCisJcmV0dXJuIGNwdV90aW1lOworfQorCitzdGF0aWMgdm9pZCB0aW1lbGluZV9hZHZh
bmNlKGludCB0aW1lbGluZSwgaW50IGRlbGF5X25zKQoreworCXN0cnVjdCB0aW1lc3BlYyB0diA9
IHsgLnR2X25zZWMgPSBkZWxheV9ucyB9OworCW5hbm9zbGVlcCgmdHYsIE5VTEwpOworCXN3X3N5
bmNfdGltZWxpbmVfaW5jKHRpbWVsaW5lLCAxKTsKK30KKworc3RhdGljIHZvaWQgZmFpcm5lc3Mo
aW50IGk5MTUsCisJCSAgICAgY29uc3Qgc3RydWN0IGludGVsX2V4ZWN1dGlvbl9lbmdpbmUyICpl
LAorCQkgICAgIGludCB0aW1lb3V0LCB1bnNpZ25lZCBpbnQgZmxhZ3MpCit7CisJY29uc3QgaW50
IGZyYW1lX25zID0gMTY2NjYgKiAxMDAwOworCWNvbnN0IGludCBmZW5jZV9ucyA9IGZsYWdzICYg
Rl9IQUxGID8gMiAqIGZyYW1lX25zIDogZnJhbWVfbnM7CisJdW5zaWduZWQgbG9uZyAqcmVzdWx0
OworCXVpbnQzMl90IGNvbW1vbiA9IDA7CisKKwlpZ3RfcmVxdWlyZShpbnRlbF9nZW4oaW50ZWxf
Z2V0X2RybV9kZXZpZChpOTE1KSkgPj0gOCk7CisJaWd0X3JlcXVpcmUoZ2VtX2NsYXNzX2hhc19t
dXRhYmxlX3N1Ym1pc3Npb24oaTkxNSwgZS0+Y2xhc3MpKTsKKworCWlmIChmbGFncyAmIEZfU0hB
UkUpCisJCWNvbW1vbiA9IGdlbV9jcmVhdGUoaTkxNSwgNDA5NSk7CisKKwlyZXN1bHQgPSBtbWFw
KE5VTEwsIDQwOTYsIFBST1RfV1JJVEUsIE1BUF9TSEFSRUQgfCBNQVBfQU5PTiwgLTEsIDApOwor
CisJZm9yIChpbnQgbiA9IDI7IG4gPD0gNjQ7IG4gPDw9IDEpIHsgLyogMzIgPT0gNTAwdXMgcGVy
IGNsaWVudCAqLworCQlpbnQgdGltZWxpbmUgPSBzd19zeW5jX3RpbWVsaW5lX2NyZWF0ZSgpOwor
CQlpbnQgbmZlbmNlcyA9IHRpbWVvdXQgKiBOU0VDX1BFUl9TRUMgLyBmZW5jZV9ucyArIDE7CisJ
CWNvbnN0IGludCBuY2hpbGQgPSBuIC0gMTsgLyogb2RkIGZvciBlYXN5IG1lZGlhbnMgKi8KKwkJ
Y29uc3QgaW50IGNoaWxkX25zID0gZnJhbWVfbnMgLyAobmNoaWxkICsgISEoZmxhZ3MgJiBGX1NQ
QVJFKSk7CisJCWNvbnN0IGludCBsbyA9IG5jaGlsZCAvIDQ7CisJCWNvbnN0IGludCBoaSA9ICgz
ICogbmNoaWxkICsgMykgLyA0IC0gMTsKKwkJc3RydWN0IHJ1c2FnZSBvbGRfdXNhZ2UsIHVzYWdl
OworCQl1aW50NjRfdCBjcHVfdGltZSwgZF90aW1lOworCQl1bnNpZ25lZCBsb25nIHZpcCA9IC0x
OworCQlzdHJ1Y3QgdGltZXNwZWMgdHY7CisJCXN0cnVjdCBpZ3RfbWVhbiBtOworCisJCWlmIChm
bGFncyAmIEZfUElORykgeworCQkJc3RydWN0IGludGVsX2V4ZWN1dGlvbl9lbmdpbmUyICpwaW5n
OworCisJCQlfX2Zvcl9lYWNoX3BoeXNpY2FsX2VuZ2luZShpOTE1LCBwaW5nKSB7CisJCQkJaWYg
KHBpbmctPmZsYWdzID09IGUtPmZsYWdzKQorCQkJCQljb250aW51ZTsKKworCQkJCWlndF9mb3Jr
KGNoaWxkLCAxKSB7CisJCQkJCXVpbnQzMl90IGN0eCA9IGdlbV9jb250ZXh0X2Nsb25lX3dpdGhf
ZW5naW5lcyhpOTE1LCAwKTsKKworCQkJCQlmYWlyX2NoaWxkKGk5MTUsIGN0eCwgcGluZywKKwkJ
CQkJCSAgIGNoaWxkX25zIC8gOCwKKwkJCQkJCSAgIC0xLCBjb21tb24sCisJCQkJCQkgICBGX1NP
TE8gfCBGX1BBQ0UgfCBGX1NIQVJFLAorCQkJCQkJICAgJnJlc3VsdFtuY2hpbGRdLAorCQkJCQkJ
ICAgTlVMTCk7CisKKwkJCQkJZ2VtX2NvbnRleHRfZGVzdHJveShpOTE1LCBjdHgpOworCQkJCX0K
KwkJCX0KKwkJfQorCisJCW1lbXNldChyZXN1bHQsIDAsIChuY2hpbGQgKyAxKSAqIHNpemVvZihy
ZXN1bHRbMF0pKTsKKwkJZ2V0cnVzYWdlKFJVU0FHRV9DSElMRFJFTiwgJm9sZF91c2FnZSk7CisJ
CWlndF9uc2VjX2VsYXBzZWQobWVtc2V0KCZ0diwgMCwgc2l6ZW9mKHR2KSkpOworCQlpZ3RfZm9y
ayhjaGlsZCwgbmNoaWxkKSB7CisJCQl1aW50MzJfdCBjdHggPSBnZW1fY29udGV4dF9jbG9uZV93
aXRoX2VuZ2luZXMoaTkxNSwgMCk7CisKKwkJCWlmIChmbGFncyAmIEZfVklQICYmIGNoaWxkID09
IDApIHsKKwkJCQlnZW1fY29udGV4dF9zZXRfcHJpb3JpdHkoaTkxNSwgY3R4LCBNQVhfUFJJTyk7
CisJCQkJZmxhZ3MgfD0gRl9GTE9XOworCQkJfQorCQkJaWYgKGZsYWdzICYgRl9SUlVMICYmIGNo
aWxkID09IDApCisJCQkJZmxhZ3MgfD0gRl9TT0xPIHwgRl9GTE9XIHwgRl9TWU5DOworCisJCQlm
YWlyX2NoaWxkKGk5MTUsIGN0eCwgZSwgY2hpbGRfbnMsCisJCQkJICAgdGltZWxpbmUsIGNvbW1v
biwgZmxhZ3MsCisJCQkJICAgJnJlc3VsdFtuY2hpbGRdLAorCQkJCSAgICZyZXN1bHRbY2hpbGRd
KTsKKworCQkJZ2VtX2NvbnRleHRfZGVzdHJveShpOTE1LCBjdHgpOworCQl9CisKKwkJd2hpbGUg
KG5mZW5jZXMtLSkKKwkJCXRpbWVsaW5lX2FkdmFuY2UodGltZWxpbmUsIGZlbmNlX25zKTsKKwor
CQlyZXN1bHRbbmNoaWxkXSA9IDE7CisJCWZvciAoaW50IGNoaWxkID0gMDsgY2hpbGQgPCBuY2hp
bGQ7IGNoaWxkKyspIHsKKwkJCXdoaWxlICghUkVBRF9PTkNFKHJlc3VsdFtjaGlsZF0pKQorCQkJ
CXRpbWVsaW5lX2FkdmFuY2UodGltZWxpbmUsIGZlbmNlX25zKTsKKwkJfQorCisJCWlndF93YWl0
Y2hpbGRyZW4oKTsKKwkJY2xvc2UodGltZWxpbmUpOworCisJCWRfdGltZSA9IGlndF9uc2VjX2Vs
YXBzZWQoJnR2KTsKKwkJZ2V0cnVzYWdlKFJVU0FHRV9DSElMRFJFTiwgJnVzYWdlKTsKKwkJY3B1
X3RpbWUgPSBkX2NwdV90aW1lKCZ1c2FnZSwgJm9sZF91c2FnZSk7CisJCWlmICgxMCAqIGNwdV90
aW1lID4gOSAqIGRfdGltZSkgeworCQkJaWYgKG5jaGlsZCA+IDcpCisJCQkJYnJlYWs7CisKKwkJ
CWlndF9za2lwX29uX2YoMTAgKiBjcHVfdGltZSA+IDkgKiBkX3RpbWUsCisJCQkJICAgICAgIiUu
MGYlJSBDUFUgdXNhZ2UsIHByZXN1bWluZyBjYXBhY2l0eSBleGNlZWRlZFxuIiwKKwkJCQkgICAg
ICAxMDAuKiBjcHVfdGltZSAvIGRfdGltZSk7CisJCX0KKworCQlpZ3RfbWVhbl9pbml0KCZtKTsK
KwkJZm9yIChpbnQgY2hpbGQgPSAwOyBjaGlsZCA8IG5jaGlsZDsgY2hpbGQrKykKKwkJCWlndF9t
ZWFuX2FkZCgmbSwgcmVzdWx0W2NoaWxkXSk7CisKKwkJaWYgKGZsYWdzICYgKEZfVklQIHwgRl9S
UlVMKSkKKwkJCXZpcCA9IHJlc3VsdFswXTsKKworCQlxc29ydChyZXN1bHQsIG5jaGlsZCwgc2l6
ZW9mKCpyZXN1bHQpLCBjbXBfdWwpOworCQlpZ3RfaW5mbygiJWQgY2xpZW50cywgcmFuZ2U6IFsl
LjFmLCAlLjFmXSwgaXFyOiBbJS4xZiwgJS4xZl0sIG1lZGlhbjogJS4xZiwgbWVhbjogJS4xZiDC
sSAlLjJmIG1zXG4iLAorCQkJIG5jaGlsZCwKKwkJCSAxZS02ICogcmVzdWx0WzBdLCAgMWUtNiAq
IHJlc3VsdFtuY2hpbGQgLSAxXSwKKwkJCSAxZS02ICogcmVzdWx0W2xvXSwgMWUtNiAqIHJlc3Vs
dFtoaV0sCisJCQkgMWUtNiAqIHJlc3VsdFtuY2hpbGQgLyAyXSwKKwkJCSAxZS02ICogaWd0X21l
YW5fZ2V0KCZtKSwKKwkJCSAxZS02ICogc3FydChpZ3RfbWVhbl9nZXRfdmFyaWFuY2UoJm0pKSk7
CisKKwkJaWYgKHZpcCAhPSAtMSkgeworCQkJaWd0X2luZm8oIlZJUCBpbnRlcnZhbCAlLjJmIG1z
XG4iLCAxZS02ICogdmlwKTsKKwkJCWlndF9hc3NlcnQoNCAqIHZpcCA+IDMgKiBmZW5jZV9ucyAm
JgorCQkJCSAgIDMgKiB2aXAgPCA0ICogZmVuY2VfbnMpOworCQl9CisKKwkJLyogTWF5IGJlIHNs
b3dlZCBkdWUgdG8gc2hlZXIgdm9sdW1lIG9mIGNvbnRleHQgc3dpdGNoZXMgKi8KKwkJaWd0X2Fz
c2VydCg0ICogaWd0X21lYW5fZ2V0KCZtKSA+IDMgKiBmZW5jZV9ucyAmJgorCQkJICAgICAgIGln
dF9tZWFuX2dldCgmbSkgPCAzICogZmVuY2VfbnMpOworCisJCWlndF9hc3NlcnQoNCAqIGlndF9t
ZWFuX2dldCgmbSkgPiAzICogcmVzdWx0W25jaGlsZCAvIDJdICYmCisJCQkgICAzICogaWd0X21l
YW5fZ2V0KCZtKSA8IDQgKiByZXN1bHRbbmNoaWxkIC8gMl0pOworCisJCWlndF9hc3NlcnQoMiAq
IChyZXN1bHRbaGldIC0gcmVzdWx0W2xvXSkgPCByZXN1bHRbbmNoaWxkIC8gMl0pOworCX0KKwor
CW11bm1hcChyZXN1bHQsIDQwOTYpOworCWlmIChjb21tb24pCisJCWdlbV9jbG9zZShpOTE1LCBj
b21tb24pOworfQorCitzdGF0aWMgdWludDMyX3QgcmVhZF9jdHhfdGltZXN0YW1wKGludCBpOTE1
LAorCQkJCSAgIHVpbnQzMl90IGN0eCwKKwkJCQkgICBjb25zdCBzdHJ1Y3QgaW50ZWxfZXhlY3V0
aW9uX2VuZ2luZTIgKmUpCit7CisJY29uc3QgaW50IHVzZV82NGIgPSBpbnRlbF9nZW4oaW50ZWxf
Z2V0X2RybV9kZXZpZChpOTE1KSkgPj0gODsKKwljb25zdCB1aW50MzJfdCBiYXNlID0gZ2VtX2Vu
Z2luZV9tbWlvX2Jhc2UoaTkxNSwgZS0+bmFtZSk7CisJc3RydWN0IGRybV9pOTE1X2dlbV9yZWxv
Y2F0aW9uX2VudHJ5IHJlbG9jOworCXN0cnVjdCBkcm1faTkxNV9nZW1fZXhlY19vYmplY3QyIG9i
aiA9IHsKKwkJLmhhbmRsZSA9IGdlbV9jcmVhdGUoaTkxNSwgNDA5NiksCisJCS5vZmZzZXQgPSAz
MiA8PCAyMCwKKwkJLnJlbG9jc19wdHIgPSB0b191c2VyX3BvaW50ZXIoJnJlbG9jKSwKKwkJLnJl
bG9jYXRpb25fY291bnQgPSAxLAorCX07CisJc3RydWN0IGRybV9pOTE1X2dlbV9leGVjYnVmZmVy
MiBleGVjYnVmID0geworCQkuYnVmZmVyc19wdHIgPSB0b191c2VyX3BvaW50ZXIoJm9iaiksCisJ
CS5idWZmZXJfY291bnQgPSAxLAorCQkuZmxhZ3MgPSBlLT5mbGFncywKKwkJLnJzdmQxID0gY3R4
LAorCX07CisjZGVmaW5lIFJVTlRJTUUgKGJhc2UgKyAweDNhOCkKKwl1aW50MzJfdCAqbWFwLCAq
Y3M7CisJdWludDMyX3QgdHM7CisKKwlpZ3RfcmVxdWlyZShiYXNlKTsKKworCWNzID0gbWFwID0g
Z2VtX21tYXBfX2RldmljZV9jb2hlcmVudChpOTE1LCBvYmouaGFuZGxlLAorCQkJCQkgICAgIDAs
IDQwOTYsIFBST1RfV1JJVEUpOworCisJKmNzKysgPSAweDI0IDw8IDIzIHwgKDEgKyB1c2VfNjRi
KTsgLyogU1JNICovCisJKmNzKysgPSBSVU5USU1FOworCW1lbXNldCgmcmVsb2MsIDAsIHNpemVv
ZihyZWxvYykpOworCXJlbG9jLnRhcmdldF9oYW5kbGUgPSBvYmouaGFuZGxlOworCXJlbG9jLnBy
ZXN1bWVkX29mZnNldCA9IG9iai5vZmZzZXQ7CisJcmVsb2Mub2Zmc2V0ID0gb2Zmc2V0X2luX3Bh
Z2UoY3MpOworCXJlbG9jLmRlbHRhID0gNDAwMDsKKwkqY3MrKyA9IG9iai5vZmZzZXQgKyA0MDAw
OworCSpjcysrID0gb2JqLm9mZnNldCA+PiAzMjsKKworCSpjcysrID0gTUlfQkFUQ0hfQlVGRkVS
X0VORDsKKworCWdlbV9leGVjYnVmKGk5MTUsICZleGVjYnVmKTsKKwlnZW1fc3luYyhpOTE1LCBv
YmouaGFuZGxlKTsKKwlnZW1fY2xvc2UoaTkxNSwgb2JqLmhhbmRsZSk7CisKKwl0cyA9IG1hcFsx
MDAwXTsKKwltdW5tYXAobWFwLCA0MDk2KTsKKworCXJldHVybiB0czsKK30KKworc3RhdGljIHZv
aWQgZmFpcnNsaWNlKGludCBpOTE1LCBjb25zdCBzdHJ1Y3QgaW50ZWxfZXhlY3V0aW9uX2VuZ2lu
ZTIgKmUpCit7CisJaWd0X3NwaW5fdCAqc3BpblszXTsKKwl1aW50MzJfdCBjdHhbM107CisJdWlu
dDMyX3QgdHNbM107CisKKwlpZ3RfcmVxdWlyZShnZW1fc2NoZWR1bGVyX2hhc19zZW1hcGhvcmVz
KGk5MTUpKTsKKwlpZ3RfcmVxdWlyZShnZW1fc2NoZWR1bGVyX2hhc19wcmVlbXB0aW9uKGk5MTUp
KTsKKwlpZ3RfcmVxdWlyZShpbnRlbF9nZW4oaW50ZWxfZ2V0X2RybV9kZXZpZChpOTE1KSkgPj0g
OCk7CisKKwlmb3IgKGludCBpID0gMDsgaSA8IEFSUkFZX1NJWkUoY3R4KTsgaSsrKSB7CisJCWN0
eFtpXSA9IGdlbV9jb250ZXh0X2Nsb25lX3dpdGhfZW5naW5lcyhpOTE1LCAwKTsKKwkJc3Bpbltp
XSA9IGlndF9zcGluX25ldyhpOTE1LCAuY3R4ID0gY3R4W2ldLCAuZW5naW5lID0gZS0+ZmxhZ3Mp
OworCX0KKworCXNsZWVwKDIpOyAvKiBvdmVyIHRoZSBjb3Vyc2Ugb2YgbWFueSB0aW1lc2xpY2Vz
ICovCisKKwlmb3IgKGludCBpID0gMDsgaSA8IEFSUkFZX1NJWkUoY3R4KTsgaSsrKSB7CisJCWln
dF9hc3NlcnQoZ2VtX2JvX2J1c3koaTkxNSwgc3BpbltpXS0+aGFuZGxlKSk7CisJCWlndF9zcGlu
X2VuZChzcGluW2ldKTsKKworCQl0c1tpXSA9IHJlYWRfY3R4X3RpbWVzdGFtcChpOTE1LCBjdHhb
aV0sIGUpOworCX0KKworCWZvciAoaW50IGkgPSAwOyBpIDwgQVJSQVlfU0laRShjdHgpOyBpKysp
IHsKKwkJaWd0X3NwaW5fZnJlZShpOTE1LCBzcGluW2ldKTsKKwkJZ2VtX2NvbnRleHRfZGVzdHJv
eShpOTE1LCBjdHhbaV0pOworCX0KKworCXFzb3J0KHRzLCAzLCBzaXplb2YoKnRzKSwgY21wX3Uz
Mik7CisJaWd0X2luZm8oIiVzOiBbJS4xZiwgJS4xZl0gbXNcbiIsIGUtPm5hbWUsCisJCSAxZS02
ICogdGlja3NfdG9fbnMoaTkxNSwgdHNbMF0pLAorCQkgMWUtNiAqIHRpY2tzX3RvX25zKGk5MTUs
IHRzWzJdKSk7CisKKwlpZ3RfYXNzZXJ0KHRzWzBdICYmIHRzWzJdID4gdHNbMF0pOworCWlndF9h
c3NlcnQoNCAqIHRzWzBdID4gMyAqIHRzWzJdKTsKK30KKwogI2RlZmluZSB0ZXN0X2VhY2hfZW5n
aW5lKFQsIGk5MTUsIGUpIFwKIAlpZ3Rfc3VidGVzdF93aXRoX2R5bmFtaWMoVCkgX19mb3JfZWFj
aF9waHlzaWNhbF9lbmdpbmUoaTkxNSwgZSkgXAogCQlpZ3RfZHluYW1pY19mKCIlcyIsIGUtPm5h
bWUpCkBAIC0yNTYxLDYgKzMyMjIsOSBAQCBpZ3RfbWFpbgogCQl0ZXN0X2VhY2hfZW5naW5lKCJs
YXRlc2xpY2UiLCBmZCwgZSkKIAkJCWxhdGVzbGljZShmZCwgZS0+ZmxhZ3MpOwogCisJCXRlc3Rf
ZWFjaF9lbmdpbmUoImZhaXJzbGljZSIsIGZkLCBlKQorCQkJZmFpcnNsaWNlKGZkLCBlKTsKKwog
CQl0ZXN0X2VhY2hfZW5naW5lKCJzdWJtaXQtZWFybHktc2xpY2UiLCBmZCwgZSkKIAkJCXN1Ym1p
dF9zbGljZShmZCwgZSwgRUFSTFlfU1VCTUlUKTsKIAkJdGVzdF9lYWNoX2VuZ2luZSgic3VibWl0
LWdvbGRlbi1zbGljZSIsIGZkLCBlKQpAQCAtMjU4OSw2ICszMjUzLDQxIEBAIGlndF9tYWluCiAJ
CXRlc3RfZWFjaF9lbmdpbmVfc3RvcmUoInByb21vdGlvbiIsIGZkLCBlKQogCQkJcHJvbW90aW9u
KGZkLCBlLT5mbGFncyk7CiAKKwkJdGVzdF9lYWNoX2VuZ2luZV9zdG9yZSgiZmFpci1ub25lIiwg
ZmQsIGUpCisJCQlmYWlybmVzcyhmZCwgZSwgMiwgMCk7CisJCXRlc3RfZWFjaF9lbmdpbmVfc3Rv
cmUoImZhaXItbm9uZS12aXAiLCBmZCwgZSkKKwkJCWZhaXJuZXNzKGZkLCBlLCAyLCBGX1ZJUCk7
CisJCXRlc3RfZWFjaF9lbmdpbmVfc3RvcmUoImZhaXItbm9uZS1zaGFyZSIsIGZkLCBlKQorCQkJ
ZmFpcm5lc3MoZmQsIGUsIDIsIEZfU0hBUkUpOworCQl0ZXN0X2VhY2hfZW5naW5lX3N0b3JlKCJm
YWlyLW5vbmUtcnJ1bCIsIGZkLCBlKQorCQkJZmFpcm5lc3MoZmQsIGUsIDIsIEZfUlJVTCk7CisJ
CXRlc3RfZWFjaF9lbmdpbmVfc3RvcmUoImZhaXItbm9uZS1waW5nIiwgZmQsIGUpCisJCQlmYWly
bmVzcyhmZCwgZSwgMiwgRl9QSU5HKTsKKwkJdGVzdF9lYWNoX2VuZ2luZV9zdG9yZSgiZmFpci1w
YWNlIiwgZmQsIGUpCisJCQlmYWlybmVzcyhmZCwgZSwgMiwgRl9QQUNFKTsKKwkJdGVzdF9lYWNo
X2VuZ2luZV9zdG9yZSgiZmFpci1wYWNlLXNoYXJlIiwgZmQsIGUpCisJCQlmYWlybmVzcyhmZCwg
ZSwgMiwgRl9QQUNFIHwgRl9TSEFSRSk7CisJCXRlc3RfZWFjaF9lbmdpbmVfc3RvcmUoImZhaXIt
cGFjZS1waW5nIiwgZmQsIGUpCisJCQlmYWlybmVzcyhmZCwgZSwgMiwgRl9QQUNFIHwgRl9TSEFS
RSB8IEZfUElORyk7CisJCXRlc3RfZWFjaF9lbmdpbmVfc3RvcmUoImZhaXItc3luYyIsIGZkLCBl
KQorCQkJZmFpcm5lc3MoZmQsIGUsIDIsIEZfU1lOQyk7CisJCXRlc3RfZWFjaF9lbmdpbmVfc3Rv
cmUoImZhaXItc3luYy12aXAiLCBmZCwgZSkKKwkJCWZhaXJuZXNzKGZkLCBlLCAyLCBGX1NZTkMg
fCBGX1ZJUCk7CisJCXRlc3RfZWFjaF9lbmdpbmVfc3RvcmUoImZhaXItc29sbyIsIGZkLCBlKQor
CQkJZmFpcm5lc3MoZmQsIGUsIDIsIEZfU1lOQyB8IEZfU09MTyk7CisJCXRlc3RfZWFjaF9lbmdp
bmVfc3RvcmUoImZhaXItZmxvdyIsIGZkLCBlKQorCQkJZmFpcm5lc3MoZmQsIGUsIDIsIEZfUEFD
RSB8IEZfRkxPVyk7CisJCXRlc3RfZWFjaF9lbmdpbmVfc3RvcmUoImZhaXItZmxvdy1waW5nIiwg
ZmQsIGUpCisJCQlmYWlybmVzcyhmZCwgZSwgMiwgRl9QQUNFIHwgRl9GTE9XIHwgRl9QSU5HKTsK
KwkJdGVzdF9lYWNoX2VuZ2luZV9zdG9yZSgiZmFpci1uZXh0IiwgZmQsIGUpCisJCQlmYWlybmVz
cyhmZCwgZSwgMiwgRl9QQUNFIHwgRl9GTE9XIHwgRl9ORVhUKTsKKwkJdGVzdF9lYWNoX2VuZ2lu
ZV9zdG9yZSgiZmFpci1uZXh0LXNoYXJlIiwgZmQsIGUpCisJCQlmYWlybmVzcyhmZCwgZSwgMiwg
Rl9QQUNFIHwgRl9GTE9XIHwgRl9ORVhUIHwgRl9TSEFSRSk7CisJCXRlc3RfZWFjaF9lbmdpbmVf
c3RvcmUoImZhaXItc3BhcmUiLCBmZCwgZSkKKwkJCWZhaXJuZXNzKGZkLCBlLCAyLCBGX1BBQ0Ug
fCBGX0ZMT1cgfCBGX1NQQVJFKTsKKwkJdGVzdF9lYWNoX2VuZ2luZV9zdG9yZSgiZmFpci1oYWxm
IiwgZmQsIGUpCisJCQlmYWlybmVzcyhmZCwgZSwgMiwgRl9QQUNFIHwgRl9GTE9XIHwgRl9IQUxG
KTsKKwogCQlpZ3Rfc3VidGVzdF9ncm91cCB7CiAJCQlpZ3RfZml4dHVyZSB7CiAJCQkJaWd0X3Jl
cXVpcmUoZ2VtX3NjaGVkdWxlcl9oYXNfcHJlZW1wdGlvbihmZCkpOwotLSAKMi4yNy4wCgpfX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpJbnRlbC1nZnggbWFp
bGluZyBsaXN0CkludGVsLWdmeEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5m
cmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9pbnRlbC1nZngK

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 8B2B2F7AAA
	for <lists+intel-gfx@lfdr.de>; Mon, 11 Nov 2019 19:22:04 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 33FE76E1D2;
	Mon, 11 Nov 2019 18:22:02 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 1D6D76E9BB
 for <intel-gfx@lists.freedesktop.org>; Mon, 11 Nov 2019 18:21:59 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 19163801-1500050 
 for multiple; Mon, 11 Nov 2019 18:21:46 +0000
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 11 Nov 2019 18:21:42 +0000
Message-Id: <20191111182143.23479-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.24.0
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 1/2] drm/i915/gem: Replace implicit
 dev_priv->uncore for stolen init
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Matthew Auld <matthew.auld@intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

UGFzcyBhcm91bmQgdGhlIGludGVuZGVkIGludGVsX3VuY29yZSBmb3IgbW1pbyBhY2Nlc3MgZHVy
aW5nIHN0b2xlbgpzZXR1cCwgYW5kIGF2b2lkIHJlbHlpbmcgb24gdGhlIGltcGxpY2l0IG1hZ2lj
IEk5MTVfUkVBRCgpIG1hY3Jvcy4KClNpZ25lZC1vZmYtYnk6IENocmlzIFdpbHNvbiA8Y2hyaXNA
Y2hyaXMtd2lsc29uLmNvLnVrPgpDYzogTWF0dGhldyBBdWxkIDxtYXR0aGV3LmF1bGRAaW50ZWwu
Y29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9zdG9sZW4uYyB8IDIw
NyArKysrKysrKysrKy0tLS0tLS0tLS0KIDEgZmlsZSBjaGFuZ2VkLCAxMDkgaW5zZXJ0aW9ucygr
KSwgOTggZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2Vt
L2k5MTVfZ2VtX3N0b2xlbi5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3N0
b2xlbi5jCmluZGV4IGEyZDQ5YzA0ZTZhNC4uNTU0MjJmZWM3NDIyIDEwMDY0NAotLS0gYS9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fc3RvbGVuLmMKKysrIGIvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3N0b2xlbi5jCkBAIC0yNiw0OCArMjYsNDkgQEAKICAqIGZv
ciBpcyBhIGJvb24uCiAgKi8KIAotaW50IGk5MTVfZ2VtX3N0b2xlbl9pbnNlcnRfbm9kZV9pbl9y
YW5nZShzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYsCitpbnQgaTkxNV9nZW1fc3Rv
bGVuX2luc2VydF9ub2RlX2luX3JhbmdlKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1LAog
CQkJCQkgc3RydWN0IGRybV9tbV9ub2RlICpub2RlLCB1NjQgc2l6ZSwKIAkJCQkJIHVuc2lnbmVk
IGFsaWdubWVudCwgdTY0IHN0YXJ0LCB1NjQgZW5kKQogewogCWludCByZXQ7CiAKLQlpZiAoIWRy
bV9tbV9pbml0aWFsaXplZCgmZGV2X3ByaXYtPm1tLnN0b2xlbikpCisJaWYgKCFkcm1fbW1faW5p
dGlhbGl6ZWQoJmk5MTUtPm1tLnN0b2xlbikpCiAJCXJldHVybiAtRU5PREVWOwogCiAJLyogV2FT
a2lwU3RvbGVuTWVtb3J5Rmlyc3RQYWdlOmJkdysgKi8KLQlpZiAoSU5URUxfR0VOKGRldl9wcml2
KSA+PSA4ICYmIHN0YXJ0IDwgNDA5NikKKwlpZiAoSU5URUxfR0VOKGk5MTUpID49IDggJiYgc3Rh
cnQgPCA0MDk2KQogCQlzdGFydCA9IDQwOTY7CiAKLQltdXRleF9sb2NrKCZkZXZfcHJpdi0+bW0u
c3RvbGVuX2xvY2spOwotCXJldCA9IGRybV9tbV9pbnNlcnRfbm9kZV9pbl9yYW5nZSgmZGV2X3By
aXYtPm1tLnN0b2xlbiwgbm9kZSwKKwltdXRleF9sb2NrKCZpOTE1LT5tbS5zdG9sZW5fbG9jayk7
CisJcmV0ID0gZHJtX21tX2luc2VydF9ub2RlX2luX3JhbmdlKCZpOTE1LT5tbS5zdG9sZW4sIG5v
ZGUsCiAJCQkJCSAgc2l6ZSwgYWxpZ25tZW50LCAwLAogCQkJCQkgIHN0YXJ0LCBlbmQsIERSTV9N
TV9JTlNFUlRfQkVTVCk7Ci0JbXV0ZXhfdW5sb2NrKCZkZXZfcHJpdi0+bW0uc3RvbGVuX2xvY2sp
OworCW11dGV4X3VubG9jaygmaTkxNS0+bW0uc3RvbGVuX2xvY2spOwogCiAJcmV0dXJuIHJldDsK
IH0KIAotaW50IGk5MTVfZ2VtX3N0b2xlbl9pbnNlcnRfbm9kZShzdHJ1Y3QgZHJtX2k5MTVfcHJp
dmF0ZSAqZGV2X3ByaXYsCitpbnQgaTkxNV9nZW1fc3RvbGVuX2luc2VydF9ub2RlKHN0cnVjdCBk
cm1faTkxNV9wcml2YXRlICppOTE1LAogCQkJCXN0cnVjdCBkcm1fbW1fbm9kZSAqbm9kZSwgdTY0
IHNpemUsCiAJCQkJdW5zaWduZWQgYWxpZ25tZW50KQogewotCXJldHVybiBpOTE1X2dlbV9zdG9s
ZW5faW5zZXJ0X25vZGVfaW5fcmFuZ2UoZGV2X3ByaXYsIG5vZGUsIHNpemUsCisJcmV0dXJuIGk5
MTVfZ2VtX3N0b2xlbl9pbnNlcnRfbm9kZV9pbl9yYW5nZShpOTE1LCBub2RlLCBzaXplLAogCQkJ
CQkJICAgIGFsaWdubWVudCwgMCwgVTY0X01BWCk7CiB9CiAKLXZvaWQgaTkxNV9nZW1fc3RvbGVu
X3JlbW92ZV9ub2RlKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiwKK3ZvaWQgaTkx
NV9nZW1fc3RvbGVuX3JlbW92ZV9ub2RlKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1LAog
CQkJCSBzdHJ1Y3QgZHJtX21tX25vZGUgKm5vZGUpCiB7Ci0JbXV0ZXhfbG9jaygmZGV2X3ByaXYt
Pm1tLnN0b2xlbl9sb2NrKTsKKwltdXRleF9sb2NrKCZpOTE1LT5tbS5zdG9sZW5fbG9jayk7CiAJ
ZHJtX21tX3JlbW92ZV9ub2RlKG5vZGUpOwotCW11dGV4X3VubG9jaygmZGV2X3ByaXYtPm1tLnN0
b2xlbl9sb2NrKTsKKwltdXRleF91bmxvY2soJmk5MTUtPm1tLnN0b2xlbl9sb2NrKTsKIH0KIAot
c3RhdGljIGludCBpOTE1X2FkanVzdF9zdG9sZW4oc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRl
dl9wcml2LAorc3RhdGljIGludCBpOTE1X2FkanVzdF9zdG9sZW4oc3RydWN0IGRybV9pOTE1X3By
aXZhdGUgKmk5MTUsCiAJCQkgICAgICBzdHJ1Y3QgcmVzb3VyY2UgKmRzbSkKIHsKLQlzdHJ1Y3Qg
aTkxNV9nZ3R0ICpnZ3R0ID0gJmRldl9wcml2LT5nZ3R0OworCXN0cnVjdCBpOTE1X2dndHQgKmdn
dHQgPSAmaTkxNS0+Z2d0dDsKKwlzdHJ1Y3QgaW50ZWxfdW5jb3JlICp1bmNvcmUgPSBnZ3R0LT52
bS5ndC0+dW5jb3JlOwogCXN0cnVjdCByZXNvdXJjZSAqcjsKIAogCWlmIChkc20tPnN0YXJ0ID09
IDAgfHwgZHNtLT5lbmQgPD0gZHNtLT5zdGFydCkKQEAgLTc5LDE0ICs4MCwxNCBAQCBzdGF0aWMg
aW50IGk5MTVfYWRqdXN0X3N0b2xlbihzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYs
CiAJICovCiAKIAkvKiBNYWtlIHN1cmUgd2UgZG9uJ3QgY2xvYmJlciB0aGUgR1RUIGlmIGl0J3Mg
d2l0aGluIHN0b2xlbiBtZW1vcnkgKi8KLQlpZiAoSU5URUxfR0VOKGRldl9wcml2KSA8PSA0ICYm
Ci0JICAgICFJU19HMzMoZGV2X3ByaXYpICYmICFJU19QSU5FVklFVyhkZXZfcHJpdikgJiYgIUlT
X0c0WChkZXZfcHJpdikpIHsKKwlpZiAoSU5URUxfR0VOKGk5MTUpIDw9IDQgJiYKKwkgICAgIUlT
X0czMyhpOTE1KSAmJiAhSVNfUElORVZJRVcoaTkxNSkgJiYgIUlTX0c0WChpOTE1KSkgewogCQlz
dHJ1Y3QgcmVzb3VyY2Ugc3RvbGVuWzJdID0geypkc20sICpkc219OwogCQlzdHJ1Y3QgcmVzb3Vy
Y2UgZ2d0dF9yZXM7CiAJCXJlc291cmNlX3NpemVfdCBnZ3R0X3N0YXJ0OwogCi0JCWdndHRfc3Rh
cnQgPSBJOTE1X1JFQUQoUEdUQkxfQ1RMKTsKLQkJaWYgKElTX0dFTihkZXZfcHJpdiwgNCkpCisJ
CWdndHRfc3RhcnQgPSBpbnRlbF91bmNvcmVfcmVhZCh1bmNvcmUsIFBHVEJMX0NUTCk7CisJCWlm
IChJU19HRU4oaTkxNSwgNCkpCiAJCQlnZ3R0X3N0YXJ0ID0gKGdndHRfc3RhcnQgJiBQR1RCTF9B
RERSRVNTX0xPX01BU0spIHwKIAkJCQkgICAgIChnZ3R0X3N0YXJ0ICYgUEdUQkxfQUREUkVTU19I
SV9NQVNLKSA8PCAyODsKIAkJZWxzZQpAQCAtMTIwLDcgKzEyMSw3IEBAIHN0YXRpYyBpbnQgaTkx
NV9hZGp1c3Rfc3RvbGVuKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiwKIAkgKiBr
ZXJuZWwuIFNvIGlmIHRoZSByZWdpb24gaXMgYWxyZWFkeSBtYXJrZWQgYXMgYnVzeSwgc29tZXRo
aW5nCiAJICogaXMgc2VyaW91c2x5IHdyb25nLgogCSAqLwotCXIgPSBkZXZtX3JlcXVlc3RfbWVt
X3JlZ2lvbihkZXZfcHJpdi0+ZHJtLmRldiwgZHNtLT5zdGFydCwKKwlyID0gZGV2bV9yZXF1ZXN0
X21lbV9yZWdpb24oaTkxNS0+ZHJtLmRldiwgZHNtLT5zdGFydCwKIAkJCQkgICAgcmVzb3VyY2Vf
c2l6ZShkc20pLAogCQkJCSAgICAiR3JhcGhpY3MgU3RvbGVuIE1lbW9yeSIpOwogCWlmIChyID09
IE5VTEwpIHsKQEAgLTEzMywxNCArMTM0LDE0IEBAIHN0YXRpYyBpbnQgaTkxNV9hZGp1c3Rfc3Rv
bGVuKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiwKIAkJICogcmVzZXJ2YXRpb24g
c3RhcnRpbmcgZnJvbSAxIGluc3RlYWQgb2YgMC4KIAkJICogVGhlcmUncyBhbHNvIEJJT1Mgd2l0
aCBvZmYtYnktb25lIG9uIHRoZSBvdGhlciBlbmQuCiAJCSAqLwotCQlyID0gZGV2bV9yZXF1ZXN0
X21lbV9yZWdpb24oZGV2X3ByaXYtPmRybS5kZXYsIGRzbS0+c3RhcnQgKyAxLAorCQlyID0gZGV2
bV9yZXF1ZXN0X21lbV9yZWdpb24oaTkxNS0+ZHJtLmRldiwgZHNtLT5zdGFydCArIDEsCiAJCQkJ
CSAgICByZXNvdXJjZV9zaXplKGRzbSkgLSAyLAogCQkJCQkgICAgIkdyYXBoaWNzIFN0b2xlbiBN
ZW1vcnkiKTsKIAkJLyoKIAkJICogR0VOMyBmaXJtd2FyZSBsaWtlcyB0byBzbWFzaCBwY2kgYnJp
ZGdlcyBpbnRvIHRoZSBzdG9sZW4KIAkJICogcmFuZ2UuIEFwcGFyZW50bHkgdGhpcyB3b3Jrcy4K
IAkJICovCi0JCWlmIChyID09IE5VTEwgJiYgIUlTX0dFTihkZXZfcHJpdiwgMykpIHsKKwkJaWYg
KCFyICYmICFJU19HRU4oaTkxNSwgMykpIHsKIAkJCURSTV9FUlJPUigiY29uZmxpY3QgZGV0ZWN0
ZWQgd2l0aCBzdG9sZW4gcmVnaW9uOiAlcFJcbiIsCiAJCQkJICBkc20pOwogCkBAIC0xNTEsMjUg
KzE1MiwyNyBAQCBzdGF0aWMgaW50IGk5MTVfYWRqdXN0X3N0b2xlbihzdHJ1Y3QgZHJtX2k5MTVf
cHJpdmF0ZSAqZGV2X3ByaXYsCiAJcmV0dXJuIDA7CiB9CiAKLXN0YXRpYyB2b2lkIGk5MTVfZ2Vt
X2NsZWFudXBfc3RvbGVuKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdikKK3N0YXRp
YyB2b2lkIGk5MTVfZ2VtX2NsZWFudXBfc3RvbGVuKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpp
OTE1KQogewotCWlmICghZHJtX21tX2luaXRpYWxpemVkKCZkZXZfcHJpdi0+bW0uc3RvbGVuKSkK
KwlpZiAoIWRybV9tbV9pbml0aWFsaXplZCgmaTkxNS0+bW0uc3RvbGVuKSkKIAkJcmV0dXJuOwog
Ci0JZHJtX21tX3Rha2Vkb3duKCZkZXZfcHJpdi0+bW0uc3RvbGVuKTsKKwlkcm1fbW1fdGFrZWRv
d24oJmk5MTUtPm1tLnN0b2xlbik7CiB9CiAKLXN0YXRpYyB2b2lkIGc0eF9nZXRfc3RvbGVuX3Jl
c2VydmVkKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiwKK3N0YXRpYyB2b2lkIGc0
eF9nZXRfc3RvbGVuX3Jlc2VydmVkKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1LAorCQkJ
CSAgICBzdHJ1Y3QgaW50ZWxfdW5jb3JlICp1bmNvcmUsCiAJCQkJICAgIHJlc291cmNlX3NpemVf
dCAqYmFzZSwKIAkJCQkgICAgcmVzb3VyY2Vfc2l6ZV90ICpzaXplKQogewotCXUzMiByZWdfdmFs
ID0gSTkxNV9SRUFEKElTX0dNNDUoZGV2X3ByaXYpID8KLQkJCQlDVEdfU1RPTEVOX1JFU0VSVkVE
IDoKLQkJCQlFTEtfU1RPTEVOX1JFU0VSVkVEKTsKLQlyZXNvdXJjZV9zaXplX3Qgc3RvbGVuX3Rv
cCA9IGRldl9wcml2LT5kc20uZW5kICsgMTsKKwl1MzIgcmVnX3ZhbCA9IGludGVsX3VuY29yZV9y
ZWFkKHVuY29yZSwKKwkJCQkJSVNfR000NShpOTE1KSA/CisJCQkJCUNUR19TVE9MRU5fUkVTRVJW
RUQgOgorCQkJCQlFTEtfU1RPTEVOX1JFU0VSVkVEKTsKKwlyZXNvdXJjZV9zaXplX3Qgc3RvbGVu
X3RvcCA9IGk5MTUtPmRzbS5lbmQgKyAxOwogCiAJRFJNX0RFQlVHX0RSSVZFUigiJXNfU1RPTEVO
X1JFU0VSVkVEID0gJTA4eFxuIiwKLQkJCSBJU19HTTQ1KGRldl9wcml2KSA/ICJDVEciIDogIkVM
SyIsIHJlZ192YWwpOworCQkJIElTX0dNNDUoaTkxNSkgPyAiQ1RHIiA6ICJFTEsiLCByZWdfdmFs
KTsKIAogCWlmICgocmVnX3ZhbCAmIEc0WF9TVE9MRU5fUkVTRVJWRURfRU5BQkxFKSA9PSAwKQog
CQlyZXR1cm47CkBAIC0xNzgsNyArMTgxLDcgQEAgc3RhdGljIHZvaWQgZzR4X2dldF9zdG9sZW5f
cmVzZXJ2ZWQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2LAogCSAqIFdoZXRoZXIg
SUxLIHJlYWxseSByZXVzZXMgdGhlIEVMSyByZWdpc3RlciBmb3IgdGhpcyBpcyB1bmNsZWFyLgog
CSAqIExldCdzIHNlZSBpZiB3ZSBjYXRjaCBhbnlvbmUgd2l0aCB0aGlzIHN1cHBvc2VkbHkgZW5h
YmxlZCBvbiBJTEsuCiAJICovCi0JV0FSTihJU19HRU4oZGV2X3ByaXYsIDUpLCAiSUxLIHN0b2xl
biByZXNlcnZlZCBmb3VuZD8gMHglMDh4XG4iLAorCVdBUk4oSVNfR0VOKGk5MTUsIDUpLCAiSUxL
IHN0b2xlbiByZXNlcnZlZCBmb3VuZD8gMHglMDh4XG4iLAogCSAgICAgcmVnX3ZhbCk7CiAKIAlp
ZiAoIShyZWdfdmFsICYgRzRYX1NUT0xFTl9SRVNFUlZFRF9BRERSMl9NQVNLKSkKQEAgLTE5MCwx
MSArMTkzLDEyIEBAIHN0YXRpYyB2b2lkIGc0eF9nZXRfc3RvbGVuX3Jlc2VydmVkKHN0cnVjdCBk
cm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiwKIAkqc2l6ZSA9IHN0b2xlbl90b3AgLSAqYmFzZTsK
IH0KIAotc3RhdGljIHZvaWQgZ2VuNl9nZXRfc3RvbGVuX3Jlc2VydmVkKHN0cnVjdCBkcm1faTkx
NV9wcml2YXRlICpkZXZfcHJpdiwKK3N0YXRpYyB2b2lkIGdlbjZfZ2V0X3N0b2xlbl9yZXNlcnZl
ZChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSwKKwkJCQkgICAgIHN0cnVjdCBpbnRlbF91
bmNvcmUgKnVuY29yZSwKIAkJCQkgICAgIHJlc291cmNlX3NpemVfdCAqYmFzZSwKIAkJCQkgICAg
IHJlc291cmNlX3NpemVfdCAqc2l6ZSkKIHsKLQl1MzIgcmVnX3ZhbCA9IEk5MTVfUkVBRChHRU42
X1NUT0xFTl9SRVNFUlZFRCk7CisJdTMyIHJlZ192YWwgPSBpbnRlbF91bmNvcmVfcmVhZCh1bmNv
cmUsIEdFTjZfU1RPTEVOX1JFU0VSVkVEKTsKIAogCURSTV9ERUJVR19EUklWRVIoIkdFTjZfU1RP
TEVOX1JFU0VSVkVEID0gJTA4eFxuIiwgcmVnX3ZhbCk7CiAKQEAgLTIyMiwxMiArMjI2LDEzIEBA
IHN0YXRpYyB2b2lkIGdlbjZfZ2V0X3N0b2xlbl9yZXNlcnZlZChzdHJ1Y3QgZHJtX2k5MTVfcHJp
dmF0ZSAqZGV2X3ByaXYsCiAJfQogfQogCi1zdGF0aWMgdm9pZCB2bHZfZ2V0X3N0b2xlbl9yZXNl
cnZlZChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYsCitzdGF0aWMgdm9pZCB2bHZf
Z2V0X3N0b2xlbl9yZXNlcnZlZChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSwKKwkJCQkg
ICAgc3RydWN0IGludGVsX3VuY29yZSAqdW5jb3JlLAogCQkJCSAgICByZXNvdXJjZV9zaXplX3Qg
KmJhc2UsCiAJCQkJICAgIHJlc291cmNlX3NpemVfdCAqc2l6ZSkKIHsKLQl1MzIgcmVnX3ZhbCA9
IEk5MTVfUkVBRChHRU42X1NUT0xFTl9SRVNFUlZFRCk7Ci0JcmVzb3VyY2Vfc2l6ZV90IHN0b2xl
bl90b3AgPSBkZXZfcHJpdi0+ZHNtLmVuZCArIDE7CisJdTMyIHJlZ192YWwgPSBpbnRlbF91bmNv
cmVfcmVhZCh1bmNvcmUsIEdFTjZfU1RPTEVOX1JFU0VSVkVEKTsKKwlyZXNvdXJjZV9zaXplX3Qg
c3RvbGVuX3RvcCA9IGk5MTUtPmRzbS5lbmQgKyAxOwogCiAJRFJNX0RFQlVHX0RSSVZFUigiR0VO
Nl9TVE9MRU5fUkVTRVJWRUQgPSAlMDh4XG4iLCByZWdfdmFsKTsKIApAQCAtMjUwLDExICsyNTUs
MTIgQEAgc3RhdGljIHZvaWQgdmx2X2dldF9zdG9sZW5fcmVzZXJ2ZWQoc3RydWN0IGRybV9pOTE1
X3ByaXZhdGUgKmRldl9wcml2LAogCSpiYXNlID0gc3RvbGVuX3RvcCAtICpzaXplOwogfQogCi1z
dGF0aWMgdm9pZCBnZW43X2dldF9zdG9sZW5fcmVzZXJ2ZWQoc3RydWN0IGRybV9pOTE1X3ByaXZh
dGUgKmRldl9wcml2LAorc3RhdGljIHZvaWQgZ2VuN19nZXRfc3RvbGVuX3Jlc2VydmVkKHN0cnVj
dCBkcm1faTkxNV9wcml2YXRlICppOTE1LAorCQkJCSAgICAgc3RydWN0IGludGVsX3VuY29yZSAq
dW5jb3JlLAogCQkJCSAgICAgcmVzb3VyY2Vfc2l6ZV90ICpiYXNlLAogCQkJCSAgICAgcmVzb3Vy
Y2Vfc2l6ZV90ICpzaXplKQogewotCXUzMiByZWdfdmFsID0gSTkxNV9SRUFEKEdFTjZfU1RPTEVO
X1JFU0VSVkVEKTsKKwl1MzIgcmVnX3ZhbCA9IGludGVsX3VuY29yZV9yZWFkKHVuY29yZSwgR0VO
Nl9TVE9MRU5fUkVTRVJWRUQpOwogCiAJRFJNX0RFQlVHX0RSSVZFUigiR0VONl9TVE9MRU5fUkVT
RVJWRUQgPSAlMDh4XG4iLCByZWdfdmFsKTsKIApAQCAtMjc2LDExICsyODIsMTIgQEAgc3RhdGlj
IHZvaWQgZ2VuN19nZXRfc3RvbGVuX3Jlc2VydmVkKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpk
ZXZfcHJpdiwKIAl9CiB9CiAKLXN0YXRpYyB2b2lkIGNodl9nZXRfc3RvbGVuX3Jlc2VydmVkKHN0
cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiwKK3N0YXRpYyB2b2lkIGNodl9nZXRfc3Rv
bGVuX3Jlc2VydmVkKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1LAorCQkJCSAgICBzdHJ1
Y3QgaW50ZWxfdW5jb3JlICp1bmNvcmUsCiAJCQkJICAgIHJlc291cmNlX3NpemVfdCAqYmFzZSwK
IAkJCQkgICAgcmVzb3VyY2Vfc2l6ZV90ICpzaXplKQogewotCXUzMiByZWdfdmFsID0gSTkxNV9S
RUFEKEdFTjZfU1RPTEVOX1JFU0VSVkVEKTsKKwl1MzIgcmVnX3ZhbCA9IGludGVsX3VuY29yZV9y
ZWFkKHVuY29yZSwgR0VONl9TVE9MRU5fUkVTRVJWRUQpOwogCiAJRFJNX0RFQlVHX0RSSVZFUigi
R0VONl9TVE9MRU5fUkVTRVJWRUQgPSAlMDh4XG4iLCByZWdfdmFsKTsKIApAQCAtMzA4LDEyICsz
MTUsMTMgQEAgc3RhdGljIHZvaWQgY2h2X2dldF9zdG9sZW5fcmVzZXJ2ZWQoc3RydWN0IGRybV9p
OTE1X3ByaXZhdGUgKmRldl9wcml2LAogCX0KIH0KIAotc3RhdGljIHZvaWQgYmR3X2dldF9zdG9s
ZW5fcmVzZXJ2ZWQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2LAorc3RhdGljIHZv
aWQgYmR3X2dldF9zdG9sZW5fcmVzZXJ2ZWQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUs
CisJCQkJICAgIHN0cnVjdCBpbnRlbF91bmNvcmUgKnVuY29yZSwKIAkJCQkgICAgcmVzb3VyY2Vf
c2l6ZV90ICpiYXNlLAogCQkJCSAgICByZXNvdXJjZV9zaXplX3QgKnNpemUpCiB7Ci0JdTMyIHJl
Z192YWwgPSBJOTE1X1JFQUQoR0VONl9TVE9MRU5fUkVTRVJWRUQpOwotCXJlc291cmNlX3NpemVf
dCBzdG9sZW5fdG9wID0gZGV2X3ByaXYtPmRzbS5lbmQgKyAxOworCXUzMiByZWdfdmFsID0gaW50
ZWxfdW5jb3JlX3JlYWQodW5jb3JlLCBHRU42X1NUT0xFTl9SRVNFUlZFRCk7CisJcmVzb3VyY2Vf
c2l6ZV90IHN0b2xlbl90b3AgPSBpOTE1LT5kc20uZW5kICsgMTsKIAogCURSTV9ERUJVR19EUklW
RVIoIkdFTjZfU1RPTEVOX1JFU0VSVkVEID0gJTA4eFxuIiwgcmVnX3ZhbCk7CiAKQEAgLTMyOCwx
MCArMzM2LDExIEBAIHN0YXRpYyB2b2lkIGJkd19nZXRfc3RvbGVuX3Jlc2VydmVkKHN0cnVjdCBk
cm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiwKIH0KIAogc3RhdGljIHZvaWQgaWNsX2dldF9zdG9s
ZW5fcmVzZXJ2ZWQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUsCisJCQkJICAgIHN0cnVj
dCBpbnRlbF91bmNvcmUgKnVuY29yZSwKIAkJCQkgICAgcmVzb3VyY2Vfc2l6ZV90ICpiYXNlLAog
CQkJCSAgICByZXNvdXJjZV9zaXplX3QgKnNpemUpCiB7Ci0JdTY0IHJlZ192YWwgPSBpbnRlbF91
bmNvcmVfcmVhZDY0KCZpOTE1LT51bmNvcmUsIEdFTjZfU1RPTEVOX1JFU0VSVkVEKTsKKwl1NjQg
cmVnX3ZhbCA9IGludGVsX3VuY29yZV9yZWFkNjQodW5jb3JlLCBHRU42X1NUT0xFTl9SRVNFUlZF
RCk7CiAKIAlEUk1fREVCVUdfRFJJVkVSKCJHRU42X1NUT0xFTl9SRVNFUlZFRCA9IDB4JTAxNmxs
eFxuIiwgcmVnX3ZhbCk7CiAKQEAgLTM1NiwyMiArMzY1LDIzIEBAIHN0YXRpYyB2b2lkIGljbF9n
ZXRfc3RvbGVuX3Jlc2VydmVkKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1LAogCX0KIH0K
IAotc3RhdGljIGludCBpOTE1X2dlbV9pbml0X3N0b2xlbihzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0
ZSAqZGV2X3ByaXYpCitzdGF0aWMgaW50IGk5MTVfZ2VtX2luaXRfc3RvbGVuKHN0cnVjdCBkcm1f
aTkxNV9wcml2YXRlICppOTE1KQogeworCXN0cnVjdCBpbnRlbF91bmNvcmUgKnVuY29yZSA9ICZp
OTE1LT51bmNvcmU7CiAJcmVzb3VyY2Vfc2l6ZV90IHJlc2VydmVkX2Jhc2UsIHN0b2xlbl90b3A7
CiAJcmVzb3VyY2Vfc2l6ZV90IHJlc2VydmVkX3RvdGFsLCByZXNlcnZlZF9zaXplOwogCi0JbXV0
ZXhfaW5pdCgmZGV2X3ByaXYtPm1tLnN0b2xlbl9sb2NrKTsKKwltdXRleF9pbml0KCZpOTE1LT5t
bS5zdG9sZW5fbG9jayk7CiAKLQlpZiAoaW50ZWxfdmdwdV9hY3RpdmUoZGV2X3ByaXYpKSB7Ci0J
CWRldl9ub3RpY2UoZGV2X3ByaXYtPmRybS5kZXYsCisJaWYgKGludGVsX3ZncHVfYWN0aXZlKGk5
MTUpKSB7CisJCWRldl9ub3RpY2UoaTkxNS0+ZHJtLmRldiwKIAkJCSAgICIlcywgZGlzYWJsaW5n
IHVzZSBvZiBzdG9sZW4gbWVtb3J5XG4iLAogCQkJICAgImlHVlQtZyBhY3RpdmUiKTsKIAkJcmV0
dXJuIDA7CiAJfQogCi0JaWYgKGludGVsX3Z0ZF9hY3RpdmUoKSAmJiBJTlRFTF9HRU4oZGV2X3By
aXYpIDwgOCkgewotCQlkZXZfbm90aWNlKGRldl9wcml2LT5kcm0uZGV2LAorCWlmIChpbnRlbF92
dGRfYWN0aXZlKCkgJiYgSU5URUxfR0VOKGk5MTUpIDwgOCkgeworCQlkZXZfbm90aWNlKGk5MTUt
PmRybS5kZXYsCiAJCQkgICAiJXMsIGRpc2FibGluZyB1c2Ugb2Ygc3RvbGVuIG1lbW9yeVxuIiwK
IAkJCSAgICJETUFSIGFjdGl2ZSIpOwogCQlyZXR1cm4gMDsKQEAgLTM4MCw1OCArMzkwLDU5IEBA
IHN0YXRpYyBpbnQgaTkxNV9nZW1faW5pdF9zdG9sZW4oc3RydWN0IGRybV9pOTE1X3ByaXZhdGUg
KmRldl9wcml2KQogCWlmIChyZXNvdXJjZV9zaXplKCZpbnRlbF9ncmFwaGljc19zdG9sZW5fcmVz
KSA9PSAwKQogCQlyZXR1cm4gMDsKIAotCWRldl9wcml2LT5kc20gPSBpbnRlbF9ncmFwaGljc19z
dG9sZW5fcmVzOworCWk5MTUtPmRzbSA9IGludGVsX2dyYXBoaWNzX3N0b2xlbl9yZXM7CiAKLQlp
ZiAoaTkxNV9hZGp1c3Rfc3RvbGVuKGRldl9wcml2LCAmZGV2X3ByaXYtPmRzbSkpCisJaWYgKGk5
MTVfYWRqdXN0X3N0b2xlbihpOTE1LCAmaTkxNS0+ZHNtKSkKIAkJcmV0dXJuIDA7CiAKLQlHRU1f
QlVHX09OKGRldl9wcml2LT5kc20uc3RhcnQgPT0gMCk7Ci0JR0VNX0JVR19PTihkZXZfcHJpdi0+
ZHNtLmVuZCA8PSBkZXZfcHJpdi0+ZHNtLnN0YXJ0KTsKKwlHRU1fQlVHX09OKGk5MTUtPmRzbS5z
dGFydCA9PSAwKTsKKwlHRU1fQlVHX09OKGk5MTUtPmRzbS5lbmQgPD0gaTkxNS0+ZHNtLnN0YXJ0
KTsKIAotCXN0b2xlbl90b3AgPSBkZXZfcHJpdi0+ZHNtLmVuZCArIDE7CisJc3RvbGVuX3RvcCA9
IGk5MTUtPmRzbS5lbmQgKyAxOwogCXJlc2VydmVkX2Jhc2UgPSBzdG9sZW5fdG9wOwogCXJlc2Vy
dmVkX3NpemUgPSAwOwogCi0Jc3dpdGNoIChJTlRFTF9HRU4oZGV2X3ByaXYpKSB7CisJc3dpdGNo
IChJTlRFTF9HRU4oaTkxNSkpIHsKIAljYXNlIDI6CiAJY2FzZSAzOgogCQlicmVhazsKIAljYXNl
IDQ6Ci0JCWlmICghSVNfRzRYKGRldl9wcml2KSkKKwkJaWYgKCFJU19HNFgoaTkxNSkpCiAJCQli
cmVhazsKIAkJLyogZmFsbCB0aHJvdWdoICovCiAJY2FzZSA1OgotCQlnNHhfZ2V0X3N0b2xlbl9y
ZXNlcnZlZChkZXZfcHJpdiwKKwkJZzR4X2dldF9zdG9sZW5fcmVzZXJ2ZWQoaTkxNSwgdW5jb3Jl
LAogCQkJCQkmcmVzZXJ2ZWRfYmFzZSwgJnJlc2VydmVkX3NpemUpOwogCQlicmVhazsKIAljYXNl
IDY6Ci0JCWdlbjZfZ2V0X3N0b2xlbl9yZXNlcnZlZChkZXZfcHJpdiwKKwkJZ2VuNl9nZXRfc3Rv
bGVuX3Jlc2VydmVkKGk5MTUsIHVuY29yZSwKIAkJCQkJICZyZXNlcnZlZF9iYXNlLCAmcmVzZXJ2
ZWRfc2l6ZSk7CiAJCWJyZWFrOwogCWNhc2UgNzoKLQkJaWYgKElTX1ZBTExFWVZJRVcoZGV2X3By
aXYpKQotCQkJdmx2X2dldF9zdG9sZW5fcmVzZXJ2ZWQoZGV2X3ByaXYsCisJCWlmIChJU19WQUxM
RVlWSUVXKGk5MTUpKQorCQkJdmx2X2dldF9zdG9sZW5fcmVzZXJ2ZWQoaTkxNSwgdW5jb3JlLAog
CQkJCQkJJnJlc2VydmVkX2Jhc2UsICZyZXNlcnZlZF9zaXplKTsKIAkJZWxzZQotCQkJZ2VuN19n
ZXRfc3RvbGVuX3Jlc2VydmVkKGRldl9wcml2LAorCQkJZ2VuN19nZXRfc3RvbGVuX3Jlc2VydmVk
KGk5MTUsIHVuY29yZSwKIAkJCQkJCSAmcmVzZXJ2ZWRfYmFzZSwgJnJlc2VydmVkX3NpemUpOwog
CQlicmVhazsKIAljYXNlIDg6CiAJY2FzZSA5OgogCWNhc2UgMTA6Ci0JCWlmIChJU19MUChkZXZf
cHJpdikpCi0JCQljaHZfZ2V0X3N0b2xlbl9yZXNlcnZlZChkZXZfcHJpdiwKKwkJaWYgKElTX0xQ
KGk5MTUpKQorCQkJY2h2X2dldF9zdG9sZW5fcmVzZXJ2ZWQoaTkxNSwgdW5jb3JlLAogCQkJCQkJ
JnJlc2VydmVkX2Jhc2UsICZyZXNlcnZlZF9zaXplKTsKIAkJZWxzZQotCQkJYmR3X2dldF9zdG9s
ZW5fcmVzZXJ2ZWQoZGV2X3ByaXYsCisJCQliZHdfZ2V0X3N0b2xlbl9yZXNlcnZlZChpOTE1LCB1
bmNvcmUsCiAJCQkJCQkmcmVzZXJ2ZWRfYmFzZSwgJnJlc2VydmVkX3NpemUpOwogCQlicmVhazsK
IAlkZWZhdWx0OgotCQlNSVNTSU5HX0NBU0UoSU5URUxfR0VOKGRldl9wcml2KSk7CisJCU1JU1NJ
TkdfQ0FTRShJTlRFTF9HRU4oaTkxNSkpOwogCQkvKiBmYWxsLXRocm91Z2ggKi8KIAljYXNlIDEx
OgogCWNhc2UgMTI6Ci0JCWljbF9nZXRfc3RvbGVuX3Jlc2VydmVkKGRldl9wcml2LCAmcmVzZXJ2
ZWRfYmFzZSwKKwkJaWNsX2dldF9zdG9sZW5fcmVzZXJ2ZWQoaTkxNSwgdW5jb3JlLAorCQkJCQkm
cmVzZXJ2ZWRfYmFzZSwKIAkJCQkJJnJlc2VydmVkX3NpemUpOwogCQlicmVhazsKIAl9CkBAIC00
NDgsMTIgKzQ1OSwxMiBAQCBzdGF0aWMgaW50IGk5MTVfZ2VtX2luaXRfc3RvbGVuKHN0cnVjdCBk
cm1faTkxNV9wcml2YXRlICpkZXZfcHJpdikKIAkJcmVzZXJ2ZWRfc2l6ZSA9IDA7CiAJfQogCi0J
ZGV2X3ByaXYtPmRzbV9yZXNlcnZlZCA9Ci0JCShzdHJ1Y3QgcmVzb3VyY2UpIERFRklORV9SRVNf
TUVNKHJlc2VydmVkX2Jhc2UsIHJlc2VydmVkX3NpemUpOworCWk5MTUtPmRzbV9yZXNlcnZlZCA9
CisJCShzdHJ1Y3QgcmVzb3VyY2UpREVGSU5FX1JFU19NRU0ocmVzZXJ2ZWRfYmFzZSwgcmVzZXJ2
ZWRfc2l6ZSk7CiAKLQlpZiAoIXJlc291cmNlX2NvbnRhaW5zKCZkZXZfcHJpdi0+ZHNtLCAmZGV2
X3ByaXYtPmRzbV9yZXNlcnZlZCkpIHsKKwlpZiAoIXJlc291cmNlX2NvbnRhaW5zKCZpOTE1LT5k
c20sICZpOTE1LT5kc21fcmVzZXJ2ZWQpKSB7CiAJCURSTV9FUlJPUigiU3RvbGVuIHJlc2VydmVk
IGFyZWEgJXBSIG91dHNpZGUgc3RvbGVuIG1lbW9yeSAlcFJcbiIsCi0JCQkgICZkZXZfcHJpdi0+
ZHNtX3Jlc2VydmVkLCAmZGV2X3ByaXYtPmRzbSk7CisJCQkgICZpOTE1LT5kc21fcmVzZXJ2ZWQs
ICZpOTE1LT5kc20pOwogCQlyZXR1cm4gMDsKIAl9CiAKQEAgLTQ2MiwxNCArNDczLDE0IEBAIHN0
YXRpYyBpbnQgaTkxNV9nZW1faW5pdF9zdG9sZW4oc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRl
dl9wcml2KQogCXJlc2VydmVkX3RvdGFsID0gc3RvbGVuX3RvcCAtIHJlc2VydmVkX2Jhc2U7CiAK
IAlEUk1fREVCVUdfRFJJVkVSKCJNZW1vcnkgcmVzZXJ2ZWQgZm9yIGdyYXBoaWNzIGRldmljZTog
JWxsdUssIHVzYWJsZTogJWxsdUtcbiIsCi0JCQkgKHU2NClyZXNvdXJjZV9zaXplKCZkZXZfcHJp
di0+ZHNtKSA+PiAxMCwKLQkJCSAoKHU2NClyZXNvdXJjZV9zaXplKCZkZXZfcHJpdi0+ZHNtKSAt
IHJlc2VydmVkX3RvdGFsKSA+PiAxMCk7CisJCQkgKHU2NClyZXNvdXJjZV9zaXplKCZpOTE1LT5k
c20pID4+IDEwLAorCQkJICgodTY0KXJlc291cmNlX3NpemUoJmk5MTUtPmRzbSkgLSByZXNlcnZl
ZF90b3RhbCkgPj4gMTApOwogCi0JZGV2X3ByaXYtPnN0b2xlbl91c2FibGVfc2l6ZSA9Ci0JCXJl
c291cmNlX3NpemUoJmRldl9wcml2LT5kc20pIC0gcmVzZXJ2ZWRfdG90YWw7CisJaTkxNS0+c3Rv
bGVuX3VzYWJsZV9zaXplID0KKwkJcmVzb3VyY2Vfc2l6ZSgmaTkxNS0+ZHNtKSAtIHJlc2VydmVk
X3RvdGFsOwogCiAJLyogQmFzaWMgbWVtcmFuZ2UgYWxsb2NhdG9yIGZvciBzdG9sZW4gc3BhY2Uu
ICovCi0JZHJtX21tX2luaXQoJmRldl9wcml2LT5tbS5zdG9sZW4sIDAsIGRldl9wcml2LT5zdG9s
ZW5fdXNhYmxlX3NpemUpOworCWRybV9tbV9pbml0KCZpOTE1LT5tbS5zdG9sZW4sIDAsIGk5MTUt
PnN0b2xlbl91c2FibGVfc2l6ZSk7CiAKIAlyZXR1cm4gMDsKIH0KQEAgLTQ3OCwxMSArNDg5LDEx
IEBAIHN0YXRpYyBzdHJ1Y3Qgc2dfdGFibGUgKgogaTkxNV9wYWdlc19jcmVhdGVfZm9yX3N0b2xl
bihzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LAogCQkJICAgICByZXNvdXJjZV9zaXplX3Qgb2Zmc2V0
LCByZXNvdXJjZV9zaXplX3Qgc2l6ZSkKIHsKLQlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2
X3ByaXYgPSB0b19pOTE1KGRldik7CisJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUgPSB0
b19pOTE1KGRldik7CiAJc3RydWN0IHNnX3RhYmxlICpzdDsKIAlzdHJ1Y3Qgc2NhdHRlcmxpc3Qg
KnNnOwogCi0JR0VNX0JVR19PTihyYW5nZV9vdmVyZmxvd3Mob2Zmc2V0LCBzaXplLCByZXNvdXJj
ZV9zaXplKCZkZXZfcHJpdi0+ZHNtKSkpOworCUdFTV9CVUdfT04ocmFuZ2Vfb3ZlcmZsb3dzKG9m
ZnNldCwgc2l6ZSwgcmVzb3VyY2Vfc2l6ZSgmaTkxNS0+ZHNtKSkpOwogCiAJLyogV2UgaGlkZSB0
aGF0IHdlIGhhdmUgbm8gc3RydWN0IHBhZ2UgYmFja2luZyBvdXIgc3RvbGVuIG9iamVjdAogCSAq
IGJ5IHdyYXBwaW5nIHRoZSBjb250aWd1b3VzIHBoeXNpY2FsIGFsbG9jYXRpb24gd2l0aCBhIGZh
a2UKQEAgLTUwMiw3ICs1MTMsNyBAQCBpOTE1X3BhZ2VzX2NyZWF0ZV9mb3Jfc3RvbGVuKHN0cnVj
dCBkcm1fZGV2aWNlICpkZXYsCiAJc2ctPm9mZnNldCA9IDA7CiAJc2ctPmxlbmd0aCA9IHNpemU7
CiAKLQlzZ19kbWFfYWRkcmVzcyhzZykgPSAoZG1hX2FkZHJfdClkZXZfcHJpdi0+ZHNtLnN0YXJ0
ICsgb2Zmc2V0OworCXNnX2RtYV9hZGRyZXNzKHNnKSA9IChkbWFfYWRkcl90KWk5MTUtPmRzbS5z
dGFydCArIG9mZnNldDsKIAlzZ19kbWFfbGVuKHNnKSA9IHNpemU7CiAKIAlyZXR1cm4gc3Q7CkBA
IC01MzMsMTIgKzU0NCwxMiBAQCBzdGF0aWMgdm9pZCBpOTE1X2dlbV9vYmplY3RfcHV0X3BhZ2Vz
X3N0b2xlbihzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqLAogc3RhdGljIHZvaWQKIGk5
MTVfZ2VtX29iamVjdF9yZWxlYXNlX3N0b2xlbihzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAq
b2JqKQogewotCXN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiA9IHRvX2k5MTUob2Jq
LT5iYXNlLmRldik7CisJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUgPSB0b19pOTE1KG9i
ai0+YmFzZS5kZXYpOwogCXN0cnVjdCBkcm1fbW1fbm9kZSAqc3RvbGVuID0gZmV0Y2hfYW5kX3pl
cm8oJm9iai0+c3RvbGVuKTsKIAogCUdFTV9CVUdfT04oIXN0b2xlbik7CiAKLQlpOTE1X2dlbV9z
dG9sZW5fcmVtb3ZlX25vZGUoZGV2X3ByaXYsIHN0b2xlbik7CisJaTkxNV9nZW1fc3RvbGVuX3Jl
bW92ZV9ub2RlKGk5MTUsIHN0b2xlbik7CiAJa2ZyZWUoc3RvbGVuKTsKIAogCWlmIChvYmotPm1t
LnJlZ2lvbikKQEAgLTU1Miw3ICs1NjMsNyBAQCBzdGF0aWMgY29uc3Qgc3RydWN0IGRybV9pOTE1
X2dlbV9vYmplY3Rfb3BzIGk5MTVfZ2VtX29iamVjdF9zdG9sZW5fb3BzID0gewogfTsKIAogc3Rh
dGljIHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICoKLV9faTkxNV9nZW1fb2JqZWN0X2NyZWF0
ZV9zdG9sZW4oc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2LAorX19pOTE1X2dlbV9v
YmplY3RfY3JlYXRlX3N0b2xlbihzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSwKIAkJCQlz
dHJ1Y3QgZHJtX21tX25vZGUgKnN0b2xlbiwKIAkJCQlzdHJ1Y3QgaW50ZWxfbWVtb3J5X3JlZ2lv
biAqbWVtKQogewpAQCAtNTY1LDEyICs1NzYsMTIgQEAgX19pOTE1X2dlbV9vYmplY3RfY3JlYXRl
X3N0b2xlbihzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYsCiAJaWYgKCFvYmopCiAJ
CWdvdG8gZXJyOwogCi0JZHJtX2dlbV9wcml2YXRlX29iamVjdF9pbml0KCZkZXZfcHJpdi0+ZHJt
LCAmb2JqLT5iYXNlLCBzdG9sZW4tPnNpemUpOworCWRybV9nZW1fcHJpdmF0ZV9vYmplY3RfaW5p
dCgmaTkxNS0+ZHJtLCAmb2JqLT5iYXNlLCBzdG9sZW4tPnNpemUpOwogCWk5MTVfZ2VtX29iamVj
dF9pbml0KG9iaiwgJmk5MTVfZ2VtX29iamVjdF9zdG9sZW5fb3BzLCAmbG9ja19jbGFzcyk7CiAK
IAlvYmotPnN0b2xlbiA9IHN0b2xlbjsKIAlvYmotPnJlYWRfZG9tYWlucyA9IEk5MTVfR0VNX0RP
TUFJTl9DUFUgfCBJOTE1X0dFTV9ET01BSU5fR1RUOwotCWNhY2hlX2xldmVsID0gSEFTX0xMQyhk
ZXZfcHJpdikgPyBJOTE1X0NBQ0hFX0xMQyA6IEk5MTVfQ0FDSEVfTk9ORTsKKwljYWNoZV9sZXZl
bCA9IEhBU19MTEMoaTkxNSkgPyBJOTE1X0NBQ0hFX0xMQyA6IEk5MTVfQ0FDSEVfTk9ORTsKIAlp
OTE1X2dlbV9vYmplY3Rfc2V0X2NhY2hlX2NvaGVyZW5jeShvYmosIGNhY2hlX2xldmVsKTsKIAog
CWVyciA9IGk5MTVfZ2VtX29iamVjdF9waW5fcGFnZXMob2JqKTsKQEAgLTU5MywxMiArNjA0LDEy
IEBAIF9pOTE1X2dlbV9vYmplY3RfY3JlYXRlX3N0b2xlbihzdHJ1Y3QgaW50ZWxfbWVtb3J5X3Jl
Z2lvbiAqbWVtLAogCQkJICAgICAgIHJlc291cmNlX3NpemVfdCBzaXplLAogCQkJICAgICAgIHVu
c2lnbmVkIGludCBmbGFncykKIHsKLQlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYg
PSBtZW0tPmk5MTU7CisJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUgPSBtZW0tPmk5MTU7
CiAJc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iajsKIAlzdHJ1Y3QgZHJtX21tX25vZGUg
KnN0b2xlbjsKIAlpbnQgcmV0OwogCi0JaWYgKCFkcm1fbW1faW5pdGlhbGl6ZWQoJmRldl9wcml2
LT5tbS5zdG9sZW4pKQorCWlmICghZHJtX21tX2luaXRpYWxpemVkKCZpOTE1LT5tbS5zdG9sZW4p
KQogCQlyZXR1cm4gRVJSX1BUUigtRU5PREVWKTsKIAogCWlmIChzaXplID09IDApCkBAIC02MDgs
MzAgKzYxOSwzMCBAQCBfaTkxNV9nZW1fb2JqZWN0X2NyZWF0ZV9zdG9sZW4oc3RydWN0IGludGVs
X21lbW9yeV9yZWdpb24gKm1lbSwKIAlpZiAoIXN0b2xlbikKIAkJcmV0dXJuIEVSUl9QVFIoLUVO
T01FTSk7CiAKLQlyZXQgPSBpOTE1X2dlbV9zdG9sZW5faW5zZXJ0X25vZGUoZGV2X3ByaXYsIHN0
b2xlbiwgc2l6ZSwgNDA5Nik7CisJcmV0ID0gaTkxNV9nZW1fc3RvbGVuX2luc2VydF9ub2RlKGk5
MTUsIHN0b2xlbiwgc2l6ZSwgNDA5Nik7CiAJaWYgKHJldCkgewogCQlvYmogPSBFUlJfUFRSKHJl
dCk7CiAJCWdvdG8gZXJyX2ZyZWU7CiAJfQogCi0Jb2JqID0gX19pOTE1X2dlbV9vYmplY3RfY3Jl
YXRlX3N0b2xlbihkZXZfcHJpdiwgc3RvbGVuLCBtZW0pOworCW9iaiA9IF9faTkxNV9nZW1fb2Jq
ZWN0X2NyZWF0ZV9zdG9sZW4oaTkxNSwgc3RvbGVuLCBtZW0pOwogCWlmIChJU19FUlIob2JqKSkK
IAkJZ290byBlcnJfcmVtb3ZlOwogCiAJcmV0dXJuIG9iajsKIAogZXJyX3JlbW92ZToKLQlpOTE1
X2dlbV9zdG9sZW5fcmVtb3ZlX25vZGUoZGV2X3ByaXYsIHN0b2xlbik7CisJaTkxNV9nZW1fc3Rv
bGVuX3JlbW92ZV9ub2RlKGk5MTUsIHN0b2xlbik7CiBlcnJfZnJlZToKIAlrZnJlZShzdG9sZW4p
OwogCXJldHVybiBvYmo7CiB9CiAKIHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICoKLWk5MTVf
Z2VtX29iamVjdF9jcmVhdGVfc3RvbGVuKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJp
diwKK2k5MTVfZ2VtX29iamVjdF9jcmVhdGVfc3RvbGVuKHN0cnVjdCBkcm1faTkxNV9wcml2YXRl
ICppOTE1LAogCQkJICAgICAgcmVzb3VyY2Vfc2l6ZV90IHNpemUpCiB7Ci0JcmV0dXJuIGk5MTVf
Z2VtX29iamVjdF9jcmVhdGVfcmVnaW9uKGRldl9wcml2LT5tbS5yZWdpb25zW0lOVEVMX1JFR0lP
Tl9TVE9MRU5dLAorCXJldHVybiBpOTE1X2dlbV9vYmplY3RfY3JlYXRlX3JlZ2lvbihpOTE1LT5t
bS5yZWdpb25zW0lOVEVMX1JFR0lPTl9TVE9MRU5dLAogCQkJCQkgICAgIHNpemUsIEk5MTVfQk9f
QUxMT0NfQ09OVElHVU9VUyk7CiB9CiAKQEAgLTY2NSwxOCArNjc2LDE4IEBAIHN0cnVjdCBpbnRl
bF9tZW1vcnlfcmVnaW9uICppOTE1X2dlbV9zdG9sZW5fc2V0dXAoc3RydWN0IGRybV9pOTE1X3By
aXZhdGUgKmk5MTUpCiB9CiAKIHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICoKLWk5MTVfZ2Vt
X29iamVjdF9jcmVhdGVfc3RvbGVuX2Zvcl9wcmVhbGxvY2F0ZWQoc3RydWN0IGRybV9pOTE1X3By
aXZhdGUgKmRldl9wcml2LAoraTkxNV9nZW1fb2JqZWN0X2NyZWF0ZV9zdG9sZW5fZm9yX3ByZWFs
bG9jYXRlZChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSwKIAkJCQkJICAgICAgIHJlc291
cmNlX3NpemVfdCBzdG9sZW5fb2Zmc2V0LAogCQkJCQkgICAgICAgcmVzb3VyY2Vfc2l6ZV90IGd0
dF9vZmZzZXQsCiAJCQkJCSAgICAgICByZXNvdXJjZV9zaXplX3Qgc2l6ZSkKIHsKLQlzdHJ1Y3Qg
aTkxNV9nZ3R0ICpnZ3R0ID0gJmRldl9wcml2LT5nZ3R0OworCXN0cnVjdCBpOTE1X2dndHQgKmdn
dHQgPSAmaTkxNS0+Z2d0dDsKIAlzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqOwogCXN0
cnVjdCBkcm1fbW1fbm9kZSAqc3RvbGVuOwogCXN0cnVjdCBpOTE1X3ZtYSAqdm1hOwogCWludCBy
ZXQ7CiAKLQlpZiAoIWRybV9tbV9pbml0aWFsaXplZCgmZGV2X3ByaXYtPm1tLnN0b2xlbikpCisJ
aWYgKCFkcm1fbW1faW5pdGlhbGl6ZWQoJmk5MTUtPm1tLnN0b2xlbikpCiAJCXJldHVybiBFUlJf
UFRSKC1FTk9ERVYpOwogCiAJRFJNX0RFQlVHX0RSSVZFUigiY3JlYXRpbmcgcHJlYWxsb2NhdGVk
IHN0b2xlbiBvYmplY3Q6IHN0b2xlbl9vZmZzZXQ9JXBhLCBndHRfb2Zmc2V0PSVwYSwgc2l6ZT0l
cGFcbiIsCkBAIC02OTQsMTkgKzcwNSwxOSBAQCBpOTE1X2dlbV9vYmplY3RfY3JlYXRlX3N0b2xl
bl9mb3JfcHJlYWxsb2NhdGVkKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdgogCiAJ
c3RvbGVuLT5zdGFydCA9IHN0b2xlbl9vZmZzZXQ7CiAJc3RvbGVuLT5zaXplID0gc2l6ZTsKLQlt
dXRleF9sb2NrKCZkZXZfcHJpdi0+bW0uc3RvbGVuX2xvY2spOwotCXJldCA9IGRybV9tbV9yZXNl
cnZlX25vZGUoJmRldl9wcml2LT5tbS5zdG9sZW4sIHN0b2xlbik7Ci0JbXV0ZXhfdW5sb2NrKCZk
ZXZfcHJpdi0+bW0uc3RvbGVuX2xvY2spOworCW11dGV4X2xvY2soJmk5MTUtPm1tLnN0b2xlbl9s
b2NrKTsKKwlyZXQgPSBkcm1fbW1fcmVzZXJ2ZV9ub2RlKCZpOTE1LT5tbS5zdG9sZW4sIHN0b2xl
bik7CisJbXV0ZXhfdW5sb2NrKCZpOTE1LT5tbS5zdG9sZW5fbG9jayk7CiAJaWYgKHJldCkgewog
CQlEUk1fREVCVUdfRFJJVkVSKCJmYWlsZWQgdG8gYWxsb2NhdGUgc3RvbGVuIHNwYWNlXG4iKTsK
IAkJa2ZyZWUoc3RvbGVuKTsKIAkJcmV0dXJuIEVSUl9QVFIocmV0KTsKIAl9CiAKLQlvYmogPSBf
X2k5MTVfZ2VtX29iamVjdF9jcmVhdGVfc3RvbGVuKGRldl9wcml2LCBzdG9sZW4sIE5VTEwpOwor
CW9iaiA9IF9faTkxNV9nZW1fb2JqZWN0X2NyZWF0ZV9zdG9sZW4oaTkxNSwgc3RvbGVuLCBOVUxM
KTsKIAlpZiAoSVNfRVJSKG9iaikpIHsKIAkJRFJNX0RFQlVHX0RSSVZFUigiZmFpbGVkIHRvIGFs
bG9jYXRlIHN0b2xlbiBvYmplY3RcbiIpOwotCQlpOTE1X2dlbV9zdG9sZW5fcmVtb3ZlX25vZGUo
ZGV2X3ByaXYsIHN0b2xlbik7CisJCWk5MTVfZ2VtX3N0b2xlbl9yZW1vdmVfbm9kZShpOTE1LCBz
dG9sZW4pOwogCQlrZnJlZShzdG9sZW4pOwogCQlyZXR1cm4gb2JqOwogCX0KLS0gCjIuMjQuMAoK
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4
IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlz
dHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 66404390B2F
	for <lists+intel-gfx@lfdr.de>; Tue, 25 May 2021 23:18:25 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id B8F816EB53;
	Tue, 25 May 2021 21:18:12 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mail-pj1-x102a.google.com (mail-pj1-x102a.google.com
 [IPv6:2607:f8b0:4864:20::102a])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 1BEE46EB52
 for <intel-gfx@lists.freedesktop.org>; Tue, 25 May 2021 21:18:12 +0000 (UTC)
Received: by mail-pj1-x102a.google.com with SMTP id
 ep16-20020a17090ae650b029015d00f578a8so13920655pjb.2
 for <intel-gfx@lists.freedesktop.org>; Tue, 25 May 2021 14:18:12 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=jlekstrand-net.20150623.gappssmtp.com; s=20150623;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=CbePMyIlBcQSF8R+LXMprWheoIU4n7xx3MVF6E4IC+Y=;
 b=ZIuTqBc1fm8r/v+UNhuaoyRwvkdsZmJ1eny412qRypVYvPFZ/YCsH0OK38v6TTVFkS
 yLOjv6RFfYqJbIFMwgiOwULstCDj8ANE6WS7xeBlh668ZyRZ0heW4cMmal3xnHID6ezB
 Aisw3Mgvx+0H/WmBr9HgtY1kqzjZS+xslpwMGEINc39lY0X/ppMCyHGxRBUEn7zHj9MX
 sxPj8k25y3PqrdfxSMK3mSCMLvGA9ywzMR9/pkv4GICsn1cG5ImdSOMF8liMsSOS4S8K
 aTU/gAq4Blc7GWHXkU51x8ZsF/0EyBFFT8aLj8BbLPm9kKcywTTM+U2zgSYJjIbSn4qt
 gijQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=CbePMyIlBcQSF8R+LXMprWheoIU4n7xx3MVF6E4IC+Y=;
 b=r8EQOT56JTfJzyMVXy7dC4AbyTVkYs9w8kMn+ptmIVnQvce8FJ/0n52FHHVbNzcVlN
 WiFBFplkEARIICllD18n2Jjir2XOUMcDkn6GdqOvyFwTf+Oydd5D+Z220fTE9B7QSsnA
 u9DtUDSOZYVdlrNOCj9GtYbL89M3XqUEPxkHvtKrKi15F5jxE6taUlyNAPuy9/S8jgEq
 9vKBuGAT3AwmQRiJflrWVOjpqvpwSpQkbRrFl6Xojs9jRrGFhsZ3vU6HLTHxKtagggcw
 EQZImcWkVMejUpoeB7BL5bm8zwpTVEFHNIn5POsjV83MS95+YxoF4fl4DNLvQO2Dr11l
 1aRw==
X-Gm-Message-State: AOAM531ulUOZJ4RyMfPidvXfu1yVTCcSTIXfqHIIKiF3sfU1We28paZQ
 L0gp23Pm8v7+Wvd//+at9McHNg==
X-Google-Smtp-Source: ABdhPJwUc8EpMlwJiEyLt62zniksrdoI8IOw579MwiSPzkd612GnTa5JiMDouq0QB3r2n0AiDpjrLA==
X-Received: by 2002:a17:90b:128d:: with SMTP id
 fw13mr305667pjb.211.1621977491633; 
 Tue, 25 May 2021 14:18:11 -0700 (PDT)
Received: from omlet.lan ([134.134.139.83])
 by smtp.gmail.com with ESMTPSA id e186sm14342278pfa.145.2021.05.25.14.18.10
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Tue, 25 May 2021 14:18:11 -0700 (PDT)
From: Jason Ekstrand <jason@jlekstrand.net>
To: dri-devel@lists.freedesktop.org,
	intel-gfx@lists.freedesktop.org
Date: Tue, 25 May 2021 16:17:52 -0500
Message-Id: <20210525211753.1086069-7-jason@jlekstrand.net>
X-Mailer: git-send-email 2.31.1
In-Reply-To: <20210525211753.1086069-1-jason@jlekstrand.net>
References: <20210525211753.1086069-1-jason@jlekstrand.net>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 6/7] RFC: dma-buf: Add an extra fence to
 dma_resv_get_singleton_unlocked
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Daniel Vetter <daniel.vetter@ffwll.ch>,
 =?UTF-8?q?Christian=20K=C3=B6nig?= <christian.koenig@amd.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

Rm9yIGRtYS1idWYgc3luY19maWxlIGltcG9ydCwgd2Ugd2FudCB0byBnZXQgYWxsIHRoZSBmZW5j
ZXMgb24gYQpkbWFfcmVzdiBwbHVzIG9uZSBtb3JlLiAgV2UgY291bGQgd3JhcCB0aGUgZmVuY2Ug
d2UgZ2V0IGJhY2sgaW4gYW4gYXJyYXkKZmVuY2Ugb3Igd2UgY291bGQgbWFrZSBkbWFfcmVzdl9n
ZXRfc2luZ2xldG9uX3VubG9ja2VkIHRha2UgIm9uZSBtb3JlIgp0byBtYWtlIHRoaXMgY2FzZSBl
YXNpZXIuCgpTaWduZWQtb2ZmLWJ5OiBKYXNvbiBFa3N0cmFuZCA8amFzb25Aamxla3N0cmFuZC5u
ZXQ+ClJldmlld2VkLWJ5OiBEYW5pZWwgVmV0dGVyIDxkYW5pZWwudmV0dGVyQGZmd2xsLmNoPgpD
YzogQ2hyaXN0aWFuIEvDtm5pZyA8Y2hyaXN0aWFuLmtvZW5pZ0BhbWQuY29tPgpDYzogTWFhcnRl
biBMYW5raG9yc3QgPG1hYXJ0ZW4ubGFua2hvcnN0QGxpbnV4LmludGVsLmNvbT4KLS0tCiBkcml2
ZXJzL2RtYS1idWYvZG1hLWJ1Zi5jICB8ICAyICstCiBkcml2ZXJzL2RtYS1idWYvZG1hLXJlc3Yu
YyB8IDIzICsrKysrKysrKysrKysrKysrKysrKy0tCiBpbmNsdWRlL2xpbnV4L2RtYS1yZXN2Lmgg
ICB8ICAzICsrLQogMyBmaWxlcyBjaGFuZ2VkLCAyNCBpbnNlcnRpb25zKCspLCA0IGRlbGV0aW9u
cygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZG1hLWJ1Zi9kbWEtYnVmLmMgYi9kcml2ZXJzL2Rt
YS1idWYvZG1hLWJ1Zi5jCmluZGV4IDY1YTk1NzRlZTA0ZWQuLmVhMTE3ZGU5NjI5MDMgMTAwNjQ0
Ci0tLSBhL2RyaXZlcnMvZG1hLWJ1Zi9kbWEtYnVmLmMKKysrIGIvZHJpdmVycy9kbWEtYnVmL2Rt
YS1idWYuYwpAQCAtMzg5LDcgKzM4OSw3IEBAIHN0YXRpYyBsb25nIGRtYV9idWZfZXhwb3J0X3N5
bmNfZmlsZShzdHJ1Y3QgZG1hX2J1ZiAqZG1hYnVmLAogCQlyZXR1cm4gZmQ7CiAKIAlpZiAoYXJn
LmZsYWdzICYgRE1BX0JVRl9TWU5DX1dSSVRFKSB7Ci0JCWZlbmNlID0gZG1hX3Jlc3ZfZ2V0X3Np
bmdsZXRvbl91bmxvY2tlZChkbWFidWYtPnJlc3YpOworCQlmZW5jZSA9IGRtYV9yZXN2X2dldF9z
aW5nbGV0b25fdW5sb2NrZWQoZG1hYnVmLT5yZXN2LCBOVUxMKTsKIAkJaWYgKElTX0VSUihmZW5j
ZSkpIHsKIAkJCXJldCA9IFBUUl9FUlIoZmVuY2UpOwogCQkJZ290byBlcnJfcHV0X2ZkOwpkaWZm
IC0tZ2l0IGEvZHJpdmVycy9kbWEtYnVmL2RtYS1yZXN2LmMgYi9kcml2ZXJzL2RtYS1idWYvZG1h
LXJlc3YuYwppbmRleCAyM2RiMjE4MWM4YWQ4Li41YTVlMTNhMDFlNTE2IDEwMDY0NAotLS0gYS9k
cml2ZXJzL2RtYS1idWYvZG1hLXJlc3YuYworKysgYi9kcml2ZXJzL2RtYS1idWYvZG1hLXJlc3Yu
YwpAQCAtNTI3LDYgKzUyNyw3IEBAIEVYUE9SVF9TWU1CT0xfR1BMKGRtYV9yZXN2X2dldF9mZW5j
ZXNfdW5sb2NrZWQpOwogLyoqCiAgKiBkbWFfcmVzdl9nZXRfc2luZ2xldG9uX3VubG9ja2VkIC0g
Z2V0IGEgc2luZ2xlIGZlbmNlIGZvciB0aGUgZG1hX3Jlc3Ygb2JqZWN0CiAgKiBAb2JqOiB0aGUg
cmVzZXJ2YXRpb24gb2JqZWN0CisgKiBAZXh0cmE6IGV4dHJhIGZlbmNlIHRvIGFkZCB0byB0aGUg
cmVzdWx0aW5nIGFycmF5CiAgKgogICogR2V0IGEgc2luZ2xlIGZlbmNlIHJlcHJlc2VudGluZyBh
bGwgdW5zaWduYWxlZCBmZW5jZXMgaW4gdGhlIGRtYV9yZXN2IG9iamVjdAogICogcGx1cyB0aGUg
Z2l2ZW4gZXh0cmEgZmVuY2UuIElmIHdlIGdvdCBvbmx5IG9uZSBmZW5jZSByZXR1cm4gYSBuZXcK
QEAgLTUzNSw3ICs1MzYsOCBAQCBFWFBPUlRfU1lNQk9MX0dQTChkbWFfcmVzdl9nZXRfZmVuY2Vz
X3VubG9ja2VkKTsKICAqIFJFVFVSTlMKICAqIFRoZSBzaW5nbGV0b24gZG1hX2ZlbmNlIG9uIHN1
Y2Nlc3Mgb3IgYW4gRVJSX1BUUiBvbiBmYWlsdXJlCiAgKi8KLXN0cnVjdCBkbWFfZmVuY2UgKmRt
YV9yZXN2X2dldF9zaW5nbGV0b25fdW5sb2NrZWQoc3RydWN0IGRtYV9yZXN2ICpvYmopCitzdHJ1
Y3QgZG1hX2ZlbmNlICpkbWFfcmVzdl9nZXRfc2luZ2xldG9uX3VubG9ja2VkKHN0cnVjdCBkbWFf
cmVzdiAqb2JqLAorCQkJCQkJICBzdHJ1Y3QgZG1hX2ZlbmNlICpleHRyYSkKIHsKIAlzdHJ1Y3Qg
ZG1hX2ZlbmNlICpyZXN1bHQsICoqcmVzdl9mZW5jZXMsICpmZW5jZSwgKmNoYWluLCAqKmZlbmNl
czsKIAlzdHJ1Y3QgZG1hX2ZlbmNlX2FycmF5ICphcnJheTsKQEAgLTU0Niw3ICs1NDgsNyBAQCBz
dHJ1Y3QgZG1hX2ZlbmNlICpkbWFfcmVzdl9nZXRfc2luZ2xldG9uX3VubG9ja2VkKHN0cnVjdCBk
bWFfcmVzdiAqb2JqKQogCWlmIChlcnIpCiAJCXJldHVybiBFUlJfUFRSKGVycik7CiAKLQlpZiAo
bnVtX3Jlc3ZfZmVuY2VzID09IDApCisJaWYgKG51bV9yZXN2X2ZlbmNlcyA9PSAwICYmICFleHRy
YSkKIAkJcmV0dXJuIE5VTEw7CiAKIAludW1fZmVuY2VzID0gMDsKQEAgLTU2Miw2ICs1NjQsMTYg
QEAgc3RydWN0IGRtYV9mZW5jZSAqZG1hX3Jlc3ZfZ2V0X3NpbmdsZXRvbl91bmxvY2tlZChzdHJ1
Y3QgZG1hX3Jlc3YgKm9iaikKIAkJfQogCX0KIAorCWlmIChleHRyYSkgeworCQlkbWFfZmVuY2Vf
ZGVlcF9kaXZlX2Zvcl9lYWNoKGZlbmNlLCBjaGFpbiwgaiwgZXh0cmEpIHsKKwkJCWlmIChkbWFf
ZmVuY2VfaXNfc2lnbmFsZWQoZmVuY2UpKQorCQkJCWNvbnRpbnVlOworCisJCQlyZXN1bHQgPSBm
ZW5jZTsKKwkJCSsrbnVtX2ZlbmNlczsKKwkJfQorCX0KKwogCWlmIChudW1fZmVuY2VzIDw9IDEp
IHsKIAkJcmVzdWx0ID0gZG1hX2ZlbmNlX2dldChyZXN1bHQpOwogCQlnb3RvIHB1dF9yZXN2X2Zl
bmNlczsKQEAgLTU4Miw2ICs1OTQsMTMgQEAgc3RydWN0IGRtYV9mZW5jZSAqZG1hX3Jlc3ZfZ2V0
X3NpbmdsZXRvbl91bmxvY2tlZChzdHJ1Y3QgZG1hX3Jlc3YgKm9iaikKIAkJfQogCX0KIAorCWlm
IChleHRyYSkgeworCQlkbWFfZmVuY2VfZGVlcF9kaXZlX2Zvcl9lYWNoKGZlbmNlLCBjaGFpbiwg
aiwgZXh0cmEpIHsKKwkJCWlmIChkbWFfZmVuY2VfaXNfc2lnbmFsZWQoZmVuY2UpKQorCQkJCWZl
bmNlc1tudW1fZmVuY2VzKytdID0gZG1hX2ZlbmNlX2dldChmZW5jZSk7CisJCX0KKwl9CisKIAlp
ZiAobnVtX2ZlbmNlcyA8PSAxKSB7CiAJCXJlc3VsdCA9IG51bV9mZW5jZXMgPyBmZW5jZXNbMF0g
OiBOVUxMOwogCQlrZnJlZShmZW5jZXMpOwpkaWZmIC0tZ2l0IGEvaW5jbHVkZS9saW51eC9kbWEt
cmVzdi5oIGIvaW5jbHVkZS9saW51eC9kbWEtcmVzdi5oCmluZGV4IGM1ZmEwOTU1NWVjYTUuLjRi
MWRhYmZhNzAxN2QgMTAwNjQ0Ci0tLSBhL2luY2x1ZGUvbGludXgvZG1hLXJlc3YuaAorKysgYi9p
bmNsdWRlL2xpbnV4L2RtYS1yZXN2LmgKQEAgLTI4NSw3ICsyODUsOCBAQCBpbnQgZG1hX3Jlc3Zf
Z2V0X2ZlbmNlc191bmxvY2tlZChzdHJ1Y3QgZG1hX3Jlc3YgKm9iaiwKIAogaW50IGRtYV9yZXN2
X2NvcHlfZmVuY2VzKHN0cnVjdCBkbWFfcmVzdiAqZHN0LCBzdHJ1Y3QgZG1hX3Jlc3YgKnNyYyk7
CiAKLXN0cnVjdCBkbWFfZmVuY2UgKmRtYV9yZXN2X2dldF9zaW5nbGV0b25fdW5sb2NrZWQoc3Ry
dWN0IGRtYV9yZXN2ICpvYmopOworc3RydWN0IGRtYV9mZW5jZSAqZG1hX3Jlc3ZfZ2V0X3Npbmds
ZXRvbl91bmxvY2tlZChzdHJ1Y3QgZG1hX3Jlc3YgKm9iaiwKKwkJCQkJCSAgc3RydWN0IGRtYV9m
ZW5jZSAqZXh0cmEpOwogCiBsb25nIGRtYV9yZXN2X3dhaXRfdGltZW91dF91bmxvY2tlZChzdHJ1
Y3QgZG1hX3Jlc3YgKm9iaiwgYm9vbCB3YWl0X2FsbCwgYm9vbCBpbnRyLAogCQkJCSAgICB1bnNp
Z25lZCBsb25nIHRpbWVvdXQpOwotLSAKMi4zMS4xCgpfX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fXwpJbnRlbC1nZnggbWFpbGluZyBsaXN0CkludGVsLWdmeEBs
aXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1h
bi9saXN0aW5mby9pbnRlbC1nZngK

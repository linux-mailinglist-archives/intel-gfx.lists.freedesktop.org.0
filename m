Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 742D923CA96
	for <lists+intel-gfx@lfdr.de>; Wed,  5 Aug 2020 14:23:23 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 683BE6E5CE;
	Wed,  5 Aug 2020 12:23:01 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (unknown [77.68.26.236])
 by gabe.freedesktop.org (Postfix) with ESMTPS id ED34E6E578
 for <intel-gfx@lists.freedesktop.org>; Wed,  5 Aug 2020 12:22:49 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from build.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 22039478-1500050 
 for multiple; Wed, 05 Aug 2020 13:22:34 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Wed,  5 Aug 2020 13:22:13 +0100
Message-Id: <20200805122231.23313-20-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20200805122231.23313-1-chris@chris-wilson.co.uk>
References: <20200805122231.23313-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 19/37] drm/i915/gem: Asynchronous GTT unbinding
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: =?UTF-8?q?Thomas=20Hellstr=C3=B6m?= <thomas.hellstrom@intel.com>,
 Matthew Auld <matthew.auld@intel.com>, Chris Wilson <chris@chris-wilson.co.uk>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SXQgaXMgcmVhc29uYWJseSBjb21tb24gZm9yIHVzZXJzcGFjZSAoZXZlbiBtb2Rlcm4gZHJpdmVy
cyBsaWtlIGlyaXMpIHRvCnJldXNlIGFuIGFjdGl2ZSBhZGRyZXNzIGZvciBhIG5ldyBidWZmZXIu
IFRoaXMgd291bGQgY2F1c2UgdGhlCmFwcGxpY2F0aW9uIHRvIHN0YWxsIHVuZGVyIGl0cyBtdXRl
eCAob3JpZ2luYWxseSBzdHJ1Y3RfbXV0ZXgpIHVudGlsIHRoZQpvbGQgYmF0Y2hlcyB3ZXJlIGlk
bGUgYW5kIGl0IGNvdWxkIHN5bmNocm9ub3VzbHkgcmVtb3ZlIHRoZSBzdGFsZSBQVEUuCkhvd2V2
ZXIsIHdlIGNhbiBxdWV1ZSB1cCBhIGpvYiB0aGF0IHdhaXRzIG9uIHRoZSBzaWduYWwgZm9yIHRo
ZSBvbGQKbm9kZXMgdG8gY29tcGxldGUgYW5kIHVwb24gdGhvc2Ugc2lnbmFscywgcmVtb3ZlIHRo
ZSBvbGQgbm9kZXMgcmVwbGFjaW5nCnRoZW0gd2l0aCB0aGUgbmV3IG9uZXMgZm9yIHRoZSBiYXRj
aC4gVGhpcyBpcyBzdGlsbCBDUFUgZHJpdmVuLCBidXQgaW4KdGhlb3J5IHdlIGNhbiBkbyB0aGUg
R1RUIHBhdGNoaW5nIGZyb20gdGhlIEdQVS4gVGhlIGpvYiBpdHNlbGYgaGFzIGEKY29tcGxldGlv
biBzaWduYWwgYWxsb3dpbmcgdGhlIGV4ZWNidWYgdG8gd2FpdCB1cG9uIHRoZSByZWJpbmRpbmcs
IGFuZAphbHNvIG90aGVyIG9ic2VydmVycyB0byBjb29yZGluYXRlIHdpdGggdGhlIGNvbW1vbiBW
TSBhY3Rpdml0eS4KCkxldHRpbmcgdXNlcnNwYWNlIHF1ZXVlIHVwIG1vcmUgd29yaywgYWxsb3dz
IGl0IGRvIG1vcmUgc3R1ZmYgd2l0aG91dApibG9ja2luZyBvdGhlciBjbGllbnRzLiBJbiB0dXJu
LCB3ZSB0YWtlIGNhcmUgbm90IHRvIGxldCBpdCB0b28gbXVjaApjb25jdXJyZW50IHdvcmssIGNy
ZWF0aW5nIGEgc21hbGwgbnVtYmVyIG9mIHF1ZXVlcyBmb3IgZWFjaCBjb250ZXh0IHRvCmxpbWl0
IHRoZSBudW1iZXIgb2YgY29uY3VycmVudCB0YXNrcy4KClRoZSBpbXBsZW1lbnRhdGlvbiByZWxp
ZXMgb24gb25seSBzY2hlZHVsaW5nIG9uZSB1bmJpbmQgb3BlcmF0aW9uIHBlcgp2bWEgYXMgd2Ug
dXNlIHRoZSB1bmJvdW5kIHZtYS0+bm9kZSBsb2NhdGlvbiB0byB0cmFjayB0aGUgc3RhbGUgUFRF
LiBJZgp0aGVyZSBhcmUgbXVsdGlwbGUgcHJvY2Vzc2VzIHRocmFzaGluZyB0aGUgc2FtZSB2bSwg
dGhlIGV2aWN0aW9uCnByb2Nlc3Npbmcgd2lsbCBiZWNvbWUgc3luY2hyb25vdXMsIHdpdGggdGhl
IGNsaWVudHMgaGF2aW5nIHRvIHdhaXQgZm9yCmV4ZWNidWYgdG8gc2NoZWR1bGUgdGhlaXIgd29y
ay4KCkNsb3NlczogaHR0cHM6Ly9naXRsYWIuZnJlZWRlc2t0b3Aub3JnL2RybS9pbnRlbC9pc3N1
ZXMvMTQwMgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNocmlzQGNocmlzLXdpbHNvbi5j
by51az4KQ2M6IE1hdHRoZXcgQXVsZCA8bWF0dGhldy5hdWxkQGludGVsLmNvbT4KQ2M6IEFuZGkg
U2h5dGkgPGFuZGkuc2h5dGlAaW50ZWwuY29tPgpSZXZpZXdlZC1ieTogVGhvbWFzIEhlbGxzdHLD
tm0gPHRob21hcy5oZWxsc3Ryb21AaW50ZWwuY29tPgotLS0KIC4uLi9ncHUvZHJtL2k5MTUvZ2Vt
L2k5MTVfZ2VtX2V4ZWNidWZmZXIuYyAgICB8IDkxOSArKysrKysrKysrKysrKysrLS0KIGRyaXZl
cnMvZ3B1L2RybS9pOTE1L2d0L2dlbjZfcHBndHQuYyAgICAgICAgICB8ICAgMSArCiBkcml2ZXJz
L2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9ndHQuYyAgICAgICAgICAgfCAgIDQgKwogZHJpdmVycy9n
cHUvZHJtL2k5MTUvZ3QvaW50ZWxfZ3R0LmggICAgICAgICAgIHwgICAyICsKIGRyaXZlcnMvZ3B1
L2RybS9pOTE1L2k5MTVfZ2VtLmMgICAgICAgICAgICAgICB8ICAgNyArCiBkcml2ZXJzL2dwdS9k
cm0vaTkxNS9pOTE1X2dlbV9ndHQuYyAgICAgICAgICAgfCAgIDUgKwogZHJpdmVycy9ncHUvZHJt
L2k5MTUvaTkxNV92bWEuYyAgICAgICAgICAgICAgIHwgIDcxICstCiBkcml2ZXJzL2dwdS9kcm0v
aTkxNS9pOTE1X3ZtYS5oICAgICAgICAgICAgICAgfCAgIDQgKwogOCBmaWxlcyBjaGFuZ2VkLCA4
ODMgaW5zZXJ0aW9ucygrKSwgMTMwIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9leGVjYnVmZmVyLmMgYi9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9nZW0vaTkxNV9nZW1fZXhlY2J1ZmZlci5jCmluZGV4IDMyZDIzNzE4ZWUxZS4uMzAxZTY3
ZGNkYmRlIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fZXhl
Y2J1ZmZlci5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9leGVjYnVm
ZmVyLmMKQEAgLTE4LDYgKzE4LDcgQEAKICNpbmNsdWRlICJndC9pbnRlbF9ndC5oIgogI2luY2x1
ZGUgImd0L2ludGVsX2d0X2J1ZmZlcl9wb29sLmgiCiAjaW5jbHVkZSAiZ3QvaW50ZWxfZ3RfcG0u
aCIKKyNpbmNsdWRlICJndC9pbnRlbF9ndF9yZXF1ZXN0cy5oIgogI2luY2x1ZGUgImd0L2ludGVs
X3JpbmcuaCIKIAogI2luY2x1ZGUgImk5MTVfZHJ2LmgiCkBAIC00NCw2ICs0NSwxMiBAQCBzdHJ1
Y3QgZWJfdm1hIHsKIAl1MzIgaGFuZGxlOwogfTsKIAorc3RydWN0IGViX2JpbmRfdm1hIHsKKwlz
dHJ1Y3QgZWJfdm1hICpldjsKKwlzdHJ1Y3QgZHJtX21tX25vZGUgaG9sZTsKKwl1bnNpZ25lZCBp
bnQgYmluZF9mbGFnczsKK307CisKIHN0cnVjdCBlYl92bWFfYXJyYXkgewogCXN0cnVjdCBrcmVm
IGtyZWY7CiAJc3RydWN0IGViX3ZtYSB2bWFbXTsKQEAgLTY3LDExICs3NCwxMiBAQCBzdHJ1Y3Qg
ZWJfdm1hX2FycmF5IHsKIAkgSTkxNV9FWEVDX1JFU09VUkNFX1NUUkVBTUVSKQogCiAvKiBDYXRj
aCBlbWlzc2lvbiBvZiB1bmV4cGVjdGVkIGVycm9ycyBmb3IgQ0khICovCisjZGVmaW5lIF9fRUlO
VkFMX18gMjIKICNpZiBJU19FTkFCTEVEKENPTkZJR19EUk1fSTkxNV9ERUJVR19HRU0pCiAjdW5k
ZWYgRUlOVkFMCiAjZGVmaW5lIEVJTlZBTCAoeyBcCiAJRFJNX0RFQlVHX0RSSVZFUigiRUlOVkFM
IGF0ICVzOiVkXG4iLCBfX2Z1bmNfXywgX19MSU5FX18pOyBcCi0JMjI7IFwKKwlfX0VJTlZBTF9f
OyBcCiB9KQogI2VuZGlmCiAKQEAgLTMyMyw2ICszMzEsMTIgQEAgc3RhdGljIHN0cnVjdCBlYl92
bWFfYXJyYXkgKmViX3ZtYV9hcnJheV9jcmVhdGUodW5zaWduZWQgaW50IGNvdW50KQogCXJldHVy
biBhcnI7CiB9CiAKK3N0YXRpYyBzdHJ1Y3QgZWJfdm1hX2FycmF5ICplYl92bWFfYXJyYXlfZ2V0
KHN0cnVjdCBlYl92bWFfYXJyYXkgKmFycikKK3sKKwlrcmVmX2dldCgmYXJyLT5rcmVmKTsKKwly
ZXR1cm4gYXJyOworfQorCiBzdGF0aWMgaW5saW5lIHZvaWQgZWJfdW5yZXNlcnZlX3ZtYShzdHJ1
Y3QgZWJfdm1hICpldikKIHsKIAlzdHJ1Y3QgaTkxNV92bWEgKnZtYSA9IGV2LT52bWE7CkBAIC00
NTYsNyArNDcwLDEwIEBAIGViX3ZtYV9taXNwbGFjZWQoY29uc3Qgc3RydWN0IGRybV9pOTE1X2dl
bV9leGVjX29iamVjdDIgKmVudHJ5LAogCQkgY29uc3Qgc3RydWN0IGk5MTVfdm1hICp2bWEsCiAJ
CSB1bnNpZ25lZCBpbnQgZmxhZ3MpCiB7Ci0JaWYgKHZtYS0+bm9kZS5zaXplIDwgZW50cnktPnBh
ZF90b19zaXplKQorCWlmICh0ZXN0X2JpdChJOTE1X1ZNQV9FUlJPUl9CSVQsIF9faTkxNV92bWFf
ZmxhZ3Modm1hKSkpCisJCXJldHVybiB0cnVlOworCisJaWYgKHZtYS0+bm9kZS5zaXplIDwgbWF4
KHZtYS0+c2l6ZSwgZW50cnktPnBhZF90b19zaXplKSkKIAkJcmV0dXJuIHRydWU7CiAKIAlpZiAo
ZW50cnktPmFsaWdubWVudCAmJiAhSVNfQUxJR05FRCh2bWEtPm5vZGUuc3RhcnQsIGVudHJ5LT5h
bGlnbm1lbnQpKQpAQCAtNDgxLDMyICs0OTgsNiBAQCBlYl92bWFfbWlzcGxhY2VkKGNvbnN0IHN0
cnVjdCBkcm1faTkxNV9nZW1fZXhlY19vYmplY3QyICplbnRyeSwKIAlyZXR1cm4gZmFsc2U7CiB9
CiAKLXN0YXRpYyB1NjQgZWJfcGluX2ZsYWdzKGNvbnN0IHN0cnVjdCBkcm1faTkxNV9nZW1fZXhl
Y19vYmplY3QyICplbnRyeSwKLQkJCXVuc2lnbmVkIGludCBleGVjX2ZsYWdzKQotewotCXU2NCBw
aW5fZmxhZ3MgPSAwOwotCi0JaWYgKGV4ZWNfZmxhZ3MgJiBFWEVDX09CSkVDVF9ORUVEU19HVFQp
Ci0JCXBpbl9mbGFncyB8PSBQSU5fR0xPQkFMOwotCi0JLyoKLQkgKiBXYTMyYml0R2VuZXJhbFN0
YXRlT2Zmc2V0ICYgV2EzMmJpdEluc3RydWN0aW9uQmFzZU9mZnNldCwKLQkgKiBsaW1pdCBhZGRy
ZXNzIHRvIHRoZSBmaXJzdCA0R0JzIGZvciB1bmZsYWdnZWQgb2JqZWN0cy4KLQkgKi8KLQlpZiAo
IShleGVjX2ZsYWdzICYgRVhFQ19PQkpFQ1RfU1VQUE9SVFNfNDhCX0FERFJFU1MpKQotCQlwaW5f
ZmxhZ3MgfD0gUElOX1pPTkVfNEc7Ci0KLQlpZiAoZXhlY19mbGFncyAmIF9fRVhFQ19PQkpFQ1Rf
TkVFRFNfTUFQKQotCQlwaW5fZmxhZ3MgfD0gUElOX01BUFBBQkxFOwotCi0JaWYgKGV4ZWNfZmxh
Z3MgJiBFWEVDX09CSkVDVF9QSU5ORUQpCi0JCXBpbl9mbGFncyB8PSBlbnRyeS0+b2Zmc2V0IHwg
UElOX09GRlNFVF9GSVhFRDsKLQllbHNlIGlmIChleGVjX2ZsYWdzICYgX19FWEVDX09CSkVDVF9O
RUVEU19CSUFTKQotCQlwaW5fZmxhZ3MgfD0gQkFUQ0hfT0ZGU0VUX0JJQVMgfCBQSU5fT0ZGU0VU
X0JJQVM7Ci0KLQlyZXR1cm4gcGluX2ZsYWdzOwotfQotCiBzdGF0aWMgYm9vbCBlYl9waW5fdm1h
X2ZlbmNlX2lucGxhY2Uoc3RydWN0IGViX3ZtYSAqZXYpCiB7CiAJcmV0dXJuIGZhbHNlOyAvKiBX
ZSBuZWVkIHRvIGFkZCBzb21lIG5ldyBmZW5jZSBzZXJpYWxpc2F0aW9uICovCkBAIC01MjAsNiAr
NTExLDEwIEBAIGViX3Bpbl92bWFfaW5wbGFjZShzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYiwK
IAlzdHJ1Y3QgaTkxNV92bWEgKnZtYSA9IGV2LT52bWE7CiAJdW5zaWduZWQgaW50IHBpbl9mbGFn
czsKIAorCS8qIENvbmN1cnJlbnQgYXN5bmMgYmluZHMgaW4gcHJvZ3Jlc3MsIGdldCBpbiB0aGUg
cXVldWUgKi8KKwlpZiAoIWk5MTVfYWN0aXZlX2lzX2lkbGUoJnZtYS0+dm0tPmJpbmRpbmcpKQor
CQlyZXR1cm4gZmFsc2U7CisKIAlpZiAoZWJfdm1hX21pc3BsYWNlZChlbnRyeSwgdm1hLCBldi0+
ZmxhZ3MpKQogCQlyZXR1cm4gZmFsc2U7CiAKQEAgLTY0MCw0NSArNjM1LDQ2MyBAQCBlYl9hZGRf
dm1hKHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViLAogCX0KIH0KIAotc3RhdGljIGludCBlYl9y
ZXNlcnZlX3ZtYShjb25zdCBzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYiwKLQkJCSAgc3RydWN0
IGViX3ZtYSAqZXYsCi0JCQkgIHU2NCBwaW5fZmxhZ3MpCitzdHJ1Y3QgZWJfdm1fd29yayB7CisJ
c3RydWN0IGRtYV9mZW5jZV93b3JrIGJhc2U7CisJc3RydWN0IGViX3ZtYV9hcnJheSAqYXJyYXk7
CisJc3RydWN0IGViX2JpbmRfdm1hICpiaW5kOworCXN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2Ug
KnZtOworCXN0cnVjdCBpOTE1X3ZtX3B0X3N0YXNoIHN0YXNoOworCXN0cnVjdCBsaXN0X2hlYWQg
ZXZpY3RfbGlzdDsKKwl1NjQgKnBfZmxhZ3M7CisJdTY0IGlkOworCXVuc2lnbmVkIGxvbmcgY291
bnQ7Cit9OworCitzdGF0aWMgaW5saW5lIHU2NCBub2RlX2VuZChjb25zdCBzdHJ1Y3QgZHJtX21t
X25vZGUgKm5vZGUpCit7CisJcmV0dXJuIG5vZGUtPnN0YXJ0ICsgbm9kZS0+c2l6ZTsKK30KKwor
c3RhdGljIGludCBzZXRfYmluZF9mZW5jZShzdHJ1Y3QgaTkxNV92bWEgKnZtYSwgc3RydWN0IGVi
X3ZtX3dvcmsgKndvcmspCit7CisJc3RydWN0IGRtYV9mZW5jZSAqcHJldjsKKwlpbnQgZXJyID0g
MDsKKworCWxvY2tkZXBfYXNzZXJ0X2hlbGQoJnZtYS0+dm0tPm11dGV4KTsKKwlwcmV2ID0gaTkx
NV9hY3RpdmVfc2V0X2V4Y2x1c2l2ZSgmdm1hLT5hY3RpdmUsICZ3b3JrLT5iYXNlLmRtYSk7CisJ
aWYgKHVubGlrZWx5KHByZXYpKSB7CisJCWVyciA9IGk5MTVfc3dfZmVuY2VfYXdhaXRfZG1hX2Zl
bmNlKCZ3b3JrLT5iYXNlLmNoYWluLCBwcmV2LCAwLAorCQkJCQkJICAgIEdGUF9OT1dBSVQgfCBf
X0dGUF9OT1dBUk4pOworCQlkbWFfZmVuY2VfcHV0KHByZXYpOworCX0KKworCXJldHVybiBlcnIg
PCAwID8gZXJyIDogMDsKK30KKworc3RhdGljIGludCBhd2FpdF9ldmljdChzdHJ1Y3QgZWJfdm1f
d29yayAqd29yaywgc3RydWN0IGk5MTVfdm1hICp2bWEpCiB7Ci0Jc3RydWN0IGRybV9pOTE1X2dl
bV9leGVjX29iamVjdDIgKmVudHJ5ID0gZXYtPmV4ZWM7Ci0Jc3RydWN0IGk5MTVfdm1hICp2bWEg
PSBldi0+dm1hOwogCWludCBlcnI7CiAKLQlpZiAoZHJtX21tX25vZGVfYWxsb2NhdGVkKCZ2bWEt
Pm5vZGUpICYmCi0JICAgIGViX3ZtYV9taXNwbGFjZWQoZW50cnksIHZtYSwgZXYtPmZsYWdzKSkg
ewotCQllcnIgPSBpOTE1X3ZtYV91bmJpbmQodm1hKTsKKwlHRU1fQlVHX09OKHJjdV9hY2Nlc3Nf
cG9pbnRlcih2bWEtPmFjdGl2ZS5leGNsLmZlbmNlKSA9PSAmd29yay0+YmFzZS5kbWEpOworCisJ
LyogV2FpdCBmb3IgYWxsIG90aGVyIHByZXZpb3VzIGFjdGl2aXR5ICovCisJZXJyID0gaTkxNV9z
d19mZW5jZV9hd2FpdF9hY3RpdmUoJndvcmstPmJhc2UuY2hhaW4sCisJCQkJCSAmdm1hLT5hY3Rp
dmUsCisJCQkJCSBJOTE1X0FDVElWRV9BV0FJVF9BQ1RJVkUpOworCS8qIFRoZW4gaW5zZXJ0IGFs
b25nIHRoZSBleGNsdXNpdmUgdm0tPm11dGV4IHRpbWVsaW5lICovCisJaWYgKGVyciA9PSAwKQor
CQllcnIgPSBzZXRfYmluZF9mZW5jZSh2bWEsIHdvcmspOworCisJcmV0dXJuIGVycjsKK30KKwor
c3RhdGljIGludAorZXZpY3RfZm9yX25vZGUoc3RydWN0IGViX3ZtX3dvcmsgKndvcmssCisJICAg
ICAgIHN0cnVjdCBlYl9iaW5kX3ZtYSAqY29uc3QgdGFyZ2V0LAorCSAgICAgICB1bnNpZ25lZCBp
bnQgZmxhZ3MpCit7CisJc3RydWN0IGk5MTVfdm1hICp0YXJnZXRfdm1hID0gdGFyZ2V0LT5ldi0+
dm1hOworCXN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtID0gdGFyZ2V0X3ZtYS0+dm07CisJ
Y29uc3QgdW5zaWduZWQgbG9uZyBjb2xvciA9IHRhcmdldF92bWEtPm5vZGUuY29sb3I7CisJY29u
c3QgdTY0IHN0YXJ0ID0gdGFyZ2V0X3ZtYS0+bm9kZS5zdGFydDsKKwljb25zdCB1NjQgZW5kID0g
c3RhcnQgKyB0YXJnZXRfdm1hLT5ub2RlLnNpemU7CisJdTY0IGhvbGVfc3RhcnQgPSBzdGFydCwg
aG9sZV9lbmQgPSBlbmQ7CisJc3RydWN0IGk5MTVfdm1hICp2bWEsICpuZXh0OworCXN0cnVjdCBk
cm1fbW1fbm9kZSAqbm9kZTsKKwlMSVNUX0hFQUQoZXZpY3RfbGlzdCk7CisJTElTVF9IRUFEKHN0
ZWFsX2xpc3QpOworCWludCBlcnIgPSAwOworCisJbG9ja2RlcF9hc3NlcnRfaGVsZCgmdm0tPm11
dGV4KTsKKwlHRU1fQlVHX09OKGRybV9tbV9ub2RlX2FsbG9jYXRlZCgmdGFyZ2V0X3ZtYS0+bm9k
ZSkpOworCUdFTV9CVUdfT04oIUlTX0FMSUdORUQoc3RhcnQsIEk5MTVfR1RUX1BBR0VfU0laRSkp
OworCUdFTV9CVUdfT04oIUlTX0FMSUdORUQoZW5kLCBJOTE1X0dUVF9QQUdFX1NJWkUpKTsKKwor
CWlmIChpOTE1X3ZtX2hhc19jYWNoZV9jb2xvcmluZyh2bSkpIHsKKwkJLyogRXhwYW5kIHNlYXJj
aCB0byBjb3ZlciBuZWlnaGJvdXJpbmcgZ3VhcmQgcGFnZXMgKG9yIGxhY2shKSAqLworCQlpZiAo
aG9sZV9zdGFydCkKKwkJCWhvbGVfc3RhcnQgLT0gSTkxNV9HVFRfUEFHRV9TSVpFOworCisJCS8q
IEFsd2F5cyBsb29rIGF0IHRoZSBwYWdlIGFmdGVyd2FyZHMgdG8gYXZvaWQgdGhlIGVuZC1vZi1H
VFQgKi8KKwkJaG9sZV9lbmQgKz0gSTkxNV9HVFRfUEFHRV9TSVpFOworCX0KKwlHRU1fQlVHX09O
KGhvbGVfc3RhcnQgPj0gaG9sZV9lbmQpOworCisJZHJtX21tX2Zvcl9lYWNoX25vZGVfaW5fcmFu
Z2Uobm9kZSwgJnZtLT5tbSwgaG9sZV9zdGFydCwgaG9sZV9lbmQpIHsKKwkJR0VNX0JVR19PTihu
b2RlID09ICZ0YXJnZXRfdm1hLT5ub2RlKTsKKwkJZXJyID0gLUVOT1NQQzsKKworCQkvKiBJZiB3
ZSBmaW5kIGFueSBub24tb2JqZWN0cyAoIXZtYSksIHdlIGNhbm5vdCBldmljdCB0aGVtICovCisJ
CWlmIChub2RlLT5jb2xvciA9PSBJOTE1X0NPTE9SX1VORVZJQ1RBQkxFKQorCQkJZ290byBlcnI7
CisKKwkJLyoKKwkJICogSWYgd2UgYXJlIHVzaW5nIGNvbG9yaW5nIHRvIGluc2VydCBndWFyZCBw
YWdlcyBiZXR3ZWVuCisJCSAqIGRpZmZlcmVudCBjYWNoZSBkb21haW5zIHdpdGhpbiB0aGUgYWRk
cmVzcyBzcGFjZSwgd2UgaGF2ZQorCQkgKiB0byBjaGVjayB3aGV0aGVyIHRoZSBvYmplY3RzIG9u
IGVpdGhlciBzaWRlIG9mIG91ciByYW5nZQorCQkgKiBhYnV0dCBhbmQgY29uZmxpY3QuIElmIHRo
ZXkgYXJlIGluIGNvbmZsaWN0LCB0aGVuIHdlIGV2aWN0CisJCSAqIHRob3NlIGFzIHdlbGwgdG8g
bWFrZSByb29tIGZvciBvdXIgZ3VhcmQgcGFnZXMuCisJCSAqLworCQlpZiAoaTkxNV92bV9oYXNf
Y2FjaGVfY29sb3Jpbmcodm0pKSB7CisJCQlpZiAobm9kZV9lbmQobm9kZSkgPT0gc3RhcnQgJiYg
bm9kZS0+Y29sb3IgPT0gY29sb3IpCisJCQkJY29udGludWU7CisKKwkJCWlmIChub2RlLT5zdGFy
dCA9PSBlbmQgJiYgbm9kZS0+Y29sb3IgPT0gY29sb3IpCisJCQkJY29udGludWU7CisJCX0KKwor
CQlHRU1fQlVHX09OKCFkcm1fbW1fbm9kZV9hbGxvY2F0ZWQobm9kZSkpOworCQl2bWEgPSBjb250
YWluZXJfb2Yobm9kZSwgdHlwZW9mKCp2bWEpLCBub2RlKTsKKworCQlpZiAoZmxhZ3MgJiBQSU5f
Tk9FVklDVCB8fCBpOTE1X3ZtYV9pc19waW5uZWQodm1hKSkKKwkJCWdvdG8gZXJyOworCisJCS8q
IElmIHRoaXMgVk1BIGlzIGFscmVhZHkgYmVpbmcgZnJlZWQsIG9yIGlkbGUsIHN0ZWFsIGl0ISAq
LworCQlpZiAoIWk5MTVfYWN0aXZlX2FjcXVpcmVfaWZfYnVzeSgmdm1hLT5hY3RpdmUpKSB7CisJ
CQlsaXN0X21vdmUoJnZtYS0+dm1fbGluaywgJnN0ZWFsX2xpc3QpOworCQkJY29udGludWU7CisJ
CX0KKworCQlpZiAoIShmbGFncyAmIFBJTl9OT05CTE9DSykpCisJCQllcnIgPSBhd2FpdF9ldmlj
dCh3b3JrLCB2bWEpOworCQlpOTE1X2FjdGl2ZV9yZWxlYXNlKCZ2bWEtPmFjdGl2ZSk7CiAJCWlm
IChlcnIpCi0JCQlyZXR1cm4gZXJyOworCQkJZ290byBlcnI7CisKKwkJR0VNX0JVR19PTighaTkx
NV92bWFfaXNfYWN0aXZlKHZtYSkpOworCQlsaXN0X21vdmUoJnZtYS0+dm1fbGluaywgJmV2aWN0
X2xpc3QpOwogCX0KIAotCWVyciA9IGk5MTVfdm1hX3Bpbih2bWEsCi0JCQkgICBlbnRyeS0+cGFk
X3RvX3NpemUsIGVudHJ5LT5hbGlnbm1lbnQsCi0JCQkgICBlYl9waW5fZmxhZ3MoZW50cnksIGV2
LT5mbGFncykgfCBwaW5fZmxhZ3MpOwotCWlmIChlcnIpCi0JCXJldHVybiBlcnI7CisJbGlzdF9m
b3JfZWFjaF9lbnRyeV9zYWZlKHZtYSwgbmV4dCwgJnN0ZWFsX2xpc3QsIHZtX2xpbmspIHsKKwkJ
R0VNX0JVR19PTihpOTE1X3ZtYV9pc19waW5uZWQodm1hKSk7CisJCUdFTV9CVUdfT04oaTkxNV92
bWFfaXNfYWN0aXZlKHZtYSkpOworCQlfX2k5MTVfdm1hX2V2aWN0KHZtYSk7CisJCWRybV9tbV9y
ZW1vdmVfbm9kZSgmdm1hLT5ub2RlKTsKKwkJLyogTm8gcmVmIGhlbGQ7IHZtYSBtYXkgbm93IGJl
IGNvbmN1cnJlbnRseSBmcmVlZCAqLworCX0KIAotCWlmIChlbnRyeS0+b2Zmc2V0ICE9IHZtYS0+
bm9kZS5zdGFydCkgewotCQllbnRyeS0+b2Zmc2V0ID0gdm1hLT5ub2RlLnN0YXJ0IHwgVVBEQVRF
OwotCQllYi0+YXJncy0+ZmxhZ3MgfD0gX19FWEVDX0hBU19SRUxPQzsKKwkvKiBObyBvdmVybGFw
cGluZyBub2RlcyB0byBldmljdCwgY2xhaW0gdGhlIHNsb3QgZm9yIG91cnNlbHZlcyEgKi8KKwlp
ZiAobGlzdF9lbXB0eSgmZXZpY3RfbGlzdCkpCisJCXJldHVybiBkcm1fbW1fcmVzZXJ2ZV9ub2Rl
KCZ2bS0+bW0sICZ0YXJnZXRfdm1hLT5ub2RlKTsKKworCS8qCisJICogTWFyayB0aGlzIHJhbmdl
IGFzIHJlc2VydmVkLgorCSAqCisJICogV2UgaGF2ZSBub3QgeWV0IHJlbW92ZWQgdGhlIFBURXMg
Zm9yIHRoZSBvbGQgZXZpY3RlZCBub2Rlcywgc28KKwkgKiBtdXN0IHByZXZlbnQgdGhpcyByYW5n
ZSBmcm9tIGJlaW5nIHJldXNlZCBmb3IgYW55dGhpbmcgZWxzZS4gVGhlCisJICogUFRFIHdpbGwg
YmUgY2xlYXJlZCB3aGVuIHRoZSByYW5nZSBpcyBpZGxlIChkdXJpbmcgdGhlIHJlYmluZAorCSAq
IHBoYXNlIGluIHRoZSB3b3JrZXIpLgorCSAqLworCXRhcmdldC0+aG9sZS5jb2xvciA9IEk5MTVf
Q09MT1JfVU5FVklDVEFCTEU7CisJdGFyZ2V0LT5ob2xlLnN0YXJ0ID0gc3RhcnQ7CisJdGFyZ2V0
LT5ob2xlLnNpemUgPSBlbmQ7CisKKwlsaXN0X2Zvcl9lYWNoX2VudHJ5KHZtYSwgJmV2aWN0X2xp
c3QsIHZtX2xpbmspIHsKKwkJdGFyZ2V0LT5ob2xlLnN0YXJ0ID0KKwkJCW1pbih0YXJnZXQtPmhv
bGUuc3RhcnQsIHZtYS0+bm9kZS5zdGFydCk7CisJCXRhcmdldC0+aG9sZS5zaXplID0KKwkJCW1h
eCh0YXJnZXQtPmhvbGUuc2l6ZSwgbm9kZV9lbmQoJnZtYS0+bm9kZSkpOworCisJCUdFTV9CVUdf
T04oIWk5MTVfdm1hX2lzX2FjdGl2ZSh2bWEpKTsKKwkJR0VNX0JVR19PTih2bWEtPm5vZGUubW0g
IT0gJnZtLT5tbSk7CisJCXNldF9iaXQoSTkxNV9WTUFfRVJST1JfQklULCBfX2k5MTVfdm1hX2Zs
YWdzKHZtYSkpOworCQlkcm1fbW1fcmVtb3ZlX25vZGUoJnZtYS0+bm9kZSk7CisJCUdFTV9CVUdf
T04oaTkxNV92bWFfaXNfcGlubmVkKHZtYSkpOwogCX0KKwlsaXN0X3NwbGljZSgmZXZpY3RfbGlz
dCwgJndvcmstPmV2aWN0X2xpc3QpOwogCi0JaWYgKHVubGlrZWx5KGV2LT5mbGFncyAmIEVYRUNf
T0JKRUNUX05FRURTX0ZFTkNFKSkgewotCQllcnIgPSBpOTE1X3ZtYV9waW5fZmVuY2Uodm1hKTsK
LQkJaWYgKHVubGlrZWx5KGVycikpIHsKLQkJCWk5MTVfdm1hX3VucGluKHZtYSk7Ci0JCQlyZXR1
cm4gZXJyOworCXRhcmdldC0+aG9sZS5zaXplIC09IHRhcmdldC0+aG9sZS5zdGFydDsKKworCXJl
dHVybiBkcm1fbW1fcmVzZXJ2ZV9ub2RlKCZ2bS0+bW0sICZ0YXJnZXQtPmhvbGUpOworCitlcnI6
CisJbGlzdF9zcGxpY2UoJmV2aWN0X2xpc3QsICZ2bS0+Ym91bmRfbGlzdCk7CisJbGlzdF9zcGxp
Y2UoJnN0ZWFsX2xpc3QsICZ2bS0+Ym91bmRfbGlzdCk7CisJcmV0dXJuIGVycjsKK30KKworc3Rh
dGljIGludAorZXZpY3RfaW5fcmFuZ2Uoc3RydWN0IGViX3ZtX3dvcmsgKndvcmssCisJICAgICAg
IHN0cnVjdCBlYl9iaW5kX3ZtYSAqIGNvbnN0IHRhcmdldCwKKwkgICAgICAgdTY0IHN0YXJ0LCB1
NjQgZW5kLCB1NjQgYWxpZ24pCit7CisJc3RydWN0IGk5MTVfdm1hICp0YXJnZXRfdm1hID0gdGFy
Z2V0LT5ldi0+dm1hOworCXN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtID0gdGFyZ2V0X3Zt
YS0+dm07CisJc3RydWN0IGk5MTVfdm1hICphY3RpdmUgPSBOVUxMOworCXN0cnVjdCBpOTE1X3Zt
YSAqdm1hLCAqbmV4dDsKKwlzdHJ1Y3QgZHJtX21tX3NjYW4gc2NhbjsKKwlMSVNUX0hFQUQoZXZp
Y3RfbGlzdCk7CisJYm9vbCBmb3VuZCA9IGZhbHNlOworCisJbG9ja2RlcF9hc3NlcnRfaGVsZCgm
dm0tPm11dGV4KTsKKworCWRybV9tbV9zY2FuX2luaXRfd2l0aF9yYW5nZSgmc2NhbiwgJnZtLT5t
bSwKKwkJCQkgICAgdGFyZ2V0X3ZtYS0+bm9kZS5zaXplLAorCQkJCSAgICBhbGlnbiwKKwkJCQkg
ICAgdGFyZ2V0X3ZtYS0+bm9kZS5jb2xvciwKKwkJCQkgICAgc3RhcnQsIGVuZCwKKwkJCQkgICAg
RFJNX01NX0lOU0VSVF9CRVNUKTsKKworCWxpc3RfZm9yX2VhY2hfZW50cnlfc2FmZSh2bWEsIG5l
eHQsICZ2bS0+Ym91bmRfbGlzdCwgdm1fbGluaykgeworCQlpZiAoaTkxNV92bWFfaXNfcGlubmVk
KHZtYSkpCisJCQljb250aW51ZTsKKworCQlpZiAodm1hID09IGFjdGl2ZSkKKwkJCWFjdGl2ZSA9
IEVSUl9QVFIoLUVBR0FJTik7CisKKwkJLyogUHJlZmVyIHRvIHJldXNlIGlkbGUgbm9kZXM7IHB1
c2ggYWxsIGFjdGl2ZSB2bWEgdG8gdGhlIGVuZCAqLworCQlpZiAoYWN0aXZlICE9IEVSUl9QVFIo
LUVBR0FJTikgJiYgaTkxNV92bWFfaXNfYWN0aXZlKHZtYSkpIHsKKwkJCWlmICghYWN0aXZlKQor
CQkJCWFjdGl2ZSA9IHZtYTsKKworCQkJbGlzdF9tb3ZlX3RhaWwoJnZtYS0+dm1fbGluaywgJnZt
LT5ib3VuZF9saXN0KTsKKwkJCWNvbnRpbnVlOworCQl9CisKKwkJbGlzdF9tb3ZlKCZ2bWEtPnZt
X2xpbmssICZldmljdF9saXN0KTsKKwkJaWYgKGRybV9tbV9zY2FuX2FkZF9ibG9jaygmc2Nhbiwg
JnZtYS0+bm9kZSkpIHsKKwkJCXRhcmdldF92bWEtPm5vZGUuc3RhcnQgPQorCQkJCXJvdW5kX3Vw
KHNjYW4uaGl0X3N0YXJ0LCBhbGlnbik7CisJCQlmb3VuZCA9IHRydWU7CisJCQlicmVhazsKKwkJ
fQorCX0KKworCWxpc3RfZm9yX2VhY2hfZW50cnkodm1hLCAmZXZpY3RfbGlzdCwgdm1fbGluaykK
KwkJZHJtX21tX3NjYW5fcmVtb3ZlX2Jsb2NrKCZzY2FuLCAmdm1hLT5ub2RlKTsKKwlsaXN0X3Nw
bGljZSgmZXZpY3RfbGlzdCwgJnZtLT5ib3VuZF9saXN0KTsKKwlpZiAoIWZvdW5kKQorCQlyZXR1
cm4gLUVOT1NQQzsKKworCXJldHVybiBldmljdF9mb3Jfbm9kZSh3b3JrLCB0YXJnZXQsIDApOwor
fQorCitzdGF0aWMgdTY0IHJhbmRvbV9vZmZzZXQodTY0IHN0YXJ0LCB1NjQgZW5kLCB1NjQgbGVu
LCB1NjQgYWxpZ24pCit7CisJdTY0IHJhbmdlLCBhZGRyOworCisJR0VNX0JVR19PTihyYW5nZV9v
dmVyZmxvd3Moc3RhcnQsIGxlbiwgZW5kKSk7CisJR0VNX0JVR19PTihyb3VuZF91cChzdGFydCwg
YWxpZ24pID4gcm91bmRfZG93bihlbmQgLSBsZW4sIGFsaWduKSk7CisKKwlyYW5nZSA9IHJvdW5k
X2Rvd24oZW5kIC0gbGVuLCBhbGlnbikgLSByb3VuZF91cChzdGFydCwgYWxpZ24pOworCWlmIChy
YW5nZSkgeworCQlpZiAoc2l6ZW9mKHVuc2lnbmVkIGxvbmcpID09IHNpemVvZih1NjQpKSB7CisJ
CQlhZGRyID0gZ2V0X3JhbmRvbV9sb25nKCk7CisJCX0gZWxzZSB7CisJCQlhZGRyID0gZ2V0X3Jh
bmRvbV9pbnQoKTsKKwkJCWlmIChyYW5nZSA+IFUzMl9NQVgpIHsKKwkJCQlhZGRyIDw8PSAzMjsK
KwkJCQlhZGRyIHw9IGdldF9yYW5kb21faW50KCk7CisJCQl9CiAJCX0KKwkJZGl2NjRfdTY0X3Jl
bShhZGRyLCByYW5nZSwgJmFkZHIpOworCQlzdGFydCArPSBhZGRyOworCX0KKworCXJldHVybiBy
b3VuZF91cChzdGFydCwgYWxpZ24pOworfQorCitzdGF0aWMgdTY0IGFsaWduMCh1NjQgYWxpZ24p
Cit7CisJcmV0dXJuIGFsaWduIDw9IEk5MTVfR1RUX01JTl9BTElHTk1FTlQgPyAwIDogYWxpZ247
Cit9CisKK3N0YXRpYyBzdHJ1Y3QgZHJtX21tX25vZGUgKl9fYmVzdF9ob2xlKHN0cnVjdCBkcm1f
bW0gKm1tLCB1NjQgc2l6ZSkKK3sKKwlzdHJ1Y3QgcmJfbm9kZSAqcmIgPSBtbS0+aG9sZXNfc2l6
ZS5yYl9yb290LnJiX25vZGU7CisJc3RydWN0IGRybV9tbV9ub2RlICpiZXN0ID0gTlVMTDsKKwor
CXdoaWxlIChyYikgeworCQlzdHJ1Y3QgZHJtX21tX25vZGUgKm5vZGUgPQorCQkJcmJfZW50cnko
cmIsIHN0cnVjdCBkcm1fbW1fbm9kZSwgcmJfaG9sZV9zaXplKTsKKworCQlpZiAoc2l6ZSA8PSBu
b2RlLT5ob2xlX3NpemUpIHsKKwkJCWJlc3QgPSBub2RlOworCQkJcmIgPSByYi0+cmJfcmlnaHQ7
CisJCX0gZWxzZSB7CisJCQlyYiA9IHJiLT5yYl9sZWZ0OworCQl9CisJfQorCisJcmV0dXJuIGJl
c3Q7Cit9CisKK3N0YXRpYyBpbnQgYmVzdF9ob2xlKHN0cnVjdCBkcm1fbW0gKm1tLCBzdHJ1Y3Qg
ZHJtX21tX25vZGUgKm5vZGUsCisJCSAgICAgdTY0IHN0YXJ0LCB1NjQgZW5kLCB1NjQgYWxpZ24p
Cit7CisJc3RydWN0IGRybV9tbV9ub2RlICpob2xlOworCXU2NCBzaXplID0gbm9kZS0+c2l6ZTsK
KworCWRvIHsKKwkJaG9sZSA9IF9fYmVzdF9ob2xlKG1tLCBzaXplKTsKKwkJaWYgKCFob2xlKQor
CQkJcmV0dXJuIC1FTk9TUEM7CisKKwkJbm9kZS0+c3RhcnQgPSByb3VuZF91cChtYXgoc3RhcnQs
IGRybV9tbV9ob2xlX25vZGVfc3RhcnQoaG9sZSkpLAorCQkJCSAgICAgICBhbGlnbik7CisJCWlm
IChtaW4oZHJtX21tX2hvbGVfbm9kZV9lbmQoaG9sZSksIGVuZCkgPj0KKwkJICAgIG5vZGUtPnN0
YXJ0ICsgbm9kZS0+c2l6ZSkKKwkJCXJldHVybiBkcm1fbW1fcmVzZXJ2ZV9ub2RlKG1tLCBub2Rl
KTsKKworCQkvKgorCQkgKiBUb28gZXhwZW5zaXZlIHRvIHNlYXJjaCBmb3IgZXZlcnkgc2luZ2xl
IGhvbGUgZXZlcnkgdGltZSwKKwkJICogc28ganVzdCBsb29rIGZvciB0aGUgbmV4dCBiaWdnZXIg
aG9sZSwgaW50cm9kdWNpbmcgZW5vdWdoCisJCSAqIHNwYWNlIGZvciBhbGlnbm1lbnRzLiBGaW5k
aW5nIHRoZSBzbWFsbGVzdCBob2xlIHdpdGggaWRlYWwKKwkJICogYWxpZ25tZW50IHNjYWxlcyB2
ZXJ5IHBvb3JseSwgc28gd2UgY2hvb3NlIHRvIHdhc3RlIHNwYWNlCisJCSAqIGlmIGFuIGFsaWdu
bWVudCBpcyBmb3JjZWQuIE9uIHRoZSBvdGhlciBoYW5kLCBzaW1wbHkKKwkJICogcmFuZG9tbHkg
c2VsZWN0aW5nIGFuIG9mZnNldCBpbiA0OGIgc3BhY2Ugd2lsbCBjYXVzZSB1cworCQkgKiB0byB1
c2UgdGhlIG1ham9yaXR5IG9mIHRoYXQgc3BhY2UgYW5kIGV4aGF1c3QgYWxsIG1lbW9yeQorCQkg
KiBpbiBzdG9yaW5nIHRoZSBwYWdlIGRpcmVjdG9yaWVzLiBDb21wcm9taXNlIGlzIHJlcXVpcmVk
LgorCQkgKi8KKwkJc2l6ZSA9IGhvbGUtPmhvbGVfc2l6ZSArIGFsaWduOworCX0gd2hpbGUgKDEp
OworfQorCitzdGF0aWMgaW50IGViX3Jlc2VydmVfdm1hKHN0cnVjdCBlYl92bV93b3JrICp3b3Jr
LCBzdHJ1Y3QgZWJfYmluZF92bWEgKmJpbmQpCit7CisJc3RydWN0IGRybV9pOTE1X2dlbV9leGVj
X29iamVjdDIgKmVudHJ5ID0gYmluZC0+ZXYtPmV4ZWM7CisJY29uc3QgdW5zaWduZWQgaW50IGV4
ZWNfZmxhZ3MgPSBiaW5kLT5ldi0+ZmxhZ3M7CisJc3RydWN0IGk5MTVfdm1hICp2bWEgPSBiaW5k
LT5ldi0+dm1hOworCXN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtID0gdm1hLT52bTsKKwl1
NjQgc3RhcnQgPSAwLCBlbmQgPSB2bS0+dG90YWw7CisJdTY0IGFsaWduID0gZW50cnktPmFsaWdu
bWVudCA/OiBJOTE1X0dUVF9NSU5fQUxJR05NRU5UOworCXVuc2lnbmVkIGludCBiaW5kX2ZsYWdz
OworCWludCBlcnI7CisKKwlsb2NrZGVwX2Fzc2VydF9oZWxkKCZ2bS0+bXV0ZXgpOworCisJYmlu
ZF9mbGFncyA9IFBJTl9VU0VSOworCWlmIChleGVjX2ZsYWdzICYgRVhFQ19PQkpFQ1RfTkVFRFNf
R1RUKQorCQliaW5kX2ZsYWdzIHw9IFBJTl9HTE9CQUw7CisKKwlpZiAoZHJtX21tX25vZGVfYWxs
b2NhdGVkKCZ2bWEtPm5vZGUpKQorCQlnb3RvIHBpbjsKKworCUdFTV9CVUdfT04oaTkxNV92bWFf
aXNfcGlubmVkKHZtYSkpOworCUdFTV9CVUdfT04oaTkxNV92bWFfaXNfYm91bmQodm1hLCBJOTE1
X1ZNQV9CSU5EX01BU0spKTsKKwlHRU1fQlVHX09OKGk5MTVfYWN0aXZlX2ZlbmNlX2lzc2V0KCZ2
bWEtPmFjdGl2ZS5leGNsKSk7CisJR0VNX0JVR19PTighdm1hLT5zaXplKTsKKworCS8qIFJldXNl
IG9sZCBhZGRyZXNzIChpZiBpdCBkb2Vzbid0IGNvbmZsaWN0IHdpdGggbmV3IHJlcXVpcmVtZW50
cykgKi8KKwlpZiAoZWJfdm1hX21pc3BsYWNlZChlbnRyeSwgdm1hLCBleGVjX2ZsYWdzKSkgewor
CQl2bWEtPm5vZGUuc3RhcnQgPSBlbnRyeS0+b2Zmc2V0ICYgUElOX09GRlNFVF9NQVNLOworCQl2
bWEtPm5vZGUuc2l6ZSA9IG1heChlbnRyeS0+cGFkX3RvX3NpemUsIHZtYS0+c2l6ZSk7CisJCXZt
YS0+bm9kZS5jb2xvciA9IDA7CisJCWlmIChpOTE1X3ZtX2hhc19jYWNoZV9jb2xvcmluZyh2bSkp
CisJCQl2bWEtPm5vZGUuY29sb3IgPSB2bWEtPm9iai0+Y2FjaGVfbGV2ZWw7CisJfQorCisJLyoK
KwkgKiBXYTMyYml0R2VuZXJhbFN0YXRlT2Zmc2V0ICYgV2EzMmJpdEluc3RydWN0aW9uQmFzZU9m
ZnNldCwKKwkgKiBsaW1pdCBhZGRyZXNzIHRvIHRoZSBmaXJzdCA0R0JzIGZvciB1bmZsYWdnZWQg
b2JqZWN0cy4KKwkgKi8KKwlpZiAoIShleGVjX2ZsYWdzICYgRVhFQ19PQkpFQ1RfU1VQUE9SVFNf
NDhCX0FERFJFU1MpKQorCQllbmQgPSBtaW5fdCh1NjQsIGVuZCwgKDFVTEwgPDwgMzIpIC0gSTkx
NV9HVFRfUEFHRV9TSVpFKTsKKworCWFsaWduID0gbWF4KGFsaWduLCB2bWEtPmRpc3BsYXlfYWxp
Z25tZW50KTsKKwlpZiAoZXhlY19mbGFncyAmIF9fRVhFQ19PQkpFQ1RfTkVFRFNfTUFQKSB7CisJ
CXZtYS0+bm9kZS5zaXplID0gbWF4X3QodTY0LCB2bWEtPm5vZGUuc2l6ZSwgdm1hLT5mZW5jZV9z
aXplKTsKKwkJZW5kID0gbWluX3QodTY0LCBlbmQsIGk5MTVfdm1fdG9fZ2d0dCh2bSktPm1hcHBh
YmxlX2VuZCk7CisJCWFsaWduID0gbWF4X3QodTY0LCBhbGlnbiwgdm1hLT5mZW5jZV9hbGlnbm1l
bnQpOworCX0KKworCWlmIChleGVjX2ZsYWdzICYgX19FWEVDX09CSkVDVF9ORUVEU19CSUFTKQor
CQlzdGFydCA9IEJBVENIX09GRlNFVF9CSUFTOworCisJR0VNX0JVR19PTighdm1hLT5ub2RlLnNp
emUpOworCWlmICh2bWEtPm5vZGUuc2l6ZSA+IGVuZCAtIHN0YXJ0KQorCQlyZXR1cm4gLUUyQklH
OworCisJLyogVHJ5IHRoZSB1c2VyJ3MgcHJlZmVycmVkIGxvY2F0aW9uIGZpcnN0IChtYW5kYXRv
cnkgaWYgc29mdC1waW5uZWQpICovCisJZXJyID0gLV9fRUlOVkFMX187CisJaWYgKHZtYS0+bm9k
ZS5zdGFydCA+PSBzdGFydCAmJgorCSAgICBJU19BTElHTkVEKHZtYS0+bm9kZS5zdGFydCwgYWxp
Z24pICYmCisJICAgICFyYW5nZV9vdmVyZmxvd3Modm1hLT5ub2RlLnN0YXJ0LCB2bWEtPm5vZGUu
c2l6ZSwgZW5kKSkgeworCQl1bnNpZ25lZCBpbnQgcGluX2ZsYWdzOworCisJCS8qCisJCSAqIFBy
ZWZlciB0byByZWxvY2F0ZSBhbmQgc3ByZWFkIG9iamVjdHMgYXJvdW5kLgorCQkgKgorCQkgKiBJ
ZiB3ZSByZWxvY2F0ZSBhbmQgY29udGludWUgdG8gdXNlIHRoZSBuZXcgbG9jYXRpb24gaW4KKwkJ
ICogZnV0dXJlIGJhdGNoZXMsIHdlIG9ubHkgcGF5IHRoZSByZWxvY2F0aW9uIGNvc3Qgb25jZS4K
KwkJICoKKwkJICogSWYgd2UgaW5zdGVhZCBrZWVwIHJldXNpbmcgdGhlIHNhbWUgYWRkcmVzcyBm
b3IgZGlmZmVyZW50CisJCSAqIG9iamVjdHMsIGVhY2ggYmF0Y2ggbXVzdCByZW1vdmUvaW5zZXJ0
IG9iamVjdHMgaW50byB0aGUgR1RULAorCQkgKiB3aGljaCBpcyBtb3JlIGV4cGVuc2l2ZSB0aGFu
IHBlcmZvcm1pbmcgYSByZWxvY2F0aW9uLgorCQkgKi8KKwkJcGluX2ZsYWdzID0gMDsKKwkJaWYg
KCEoZXhlY19mbGFncyAmIEVYRUNfT0JKRUNUX1BJTk5FRCkpCisJCQlwaW5fZmxhZ3MgPSBQSU5f
Tk9FVklDVDsKKworCQllcnIgPSBldmljdF9mb3Jfbm9kZSh3b3JrLCBiaW5kLCBwaW5fZmxhZ3Mp
OworCQlpZiAoZXJyID09IDApCisJCQlnb3RvIHBpbjsKKwl9CisJaWYgKGV4ZWNfZmxhZ3MgJiBF
WEVDX09CSkVDVF9QSU5ORUQpCisJCXJldHVybiBlcnI7CisKKwkvKiBUcnkgdGhlIGZpcnN0IGF2
YWlsYWJsZSBmcmVlIHNwYWNlICovCisJaWYgKCFiZXN0X2hvbGUoJnZtLT5tbSwgJnZtYS0+bm9k
ZSwgc3RhcnQsIGVuZCwgYWxpZ24pKQorCQlnb3RvIHBpbjsKKworCS8qIFBpY2sgYSByYW5kb20g
c2xvdCBhbmQgc2VlIGlmIGl0J3MgYXZhaWxhYmxlIFtPKE4pIHdvcnN0IGNhc2VdICovCisJdm1h
LT5ub2RlLnN0YXJ0ID0gcmFuZG9tX29mZnNldChzdGFydCwgZW5kLCB2bWEtPm5vZGUuc2l6ZSwg
YWxpZ24pOworCWlmIChldmljdF9mb3Jfbm9kZSh3b3JrLCBiaW5kLCBQSU5fTk9OQkxPQ0spID09
IDApCisJCWdvdG8gcGluOworCisJLyogT3RoZXJ3aXNlIHNlYXJjaCBhbGwgZnJlZSBzcGFjZSBb
ZGVncmFkZXMgdG8gTyhOXjIpXSAqLworCWlmIChkcm1fbW1faW5zZXJ0X25vZGVfaW5fcmFuZ2Uo
JnZtLT5tbSwgJnZtYS0+bm9kZSwKKwkJCQkJdm1hLT5ub2RlLnNpemUsCisJCQkJCWFsaWduMChh
bGlnbiksCisJCQkJCXZtYS0+bm9kZS5jb2xvciwKKwkJCQkJc3RhcnQsIGVuZCwKKwkJCQkJRFJN
X01NX0lOU0VSVF9CRVNUKSA9PSAwKQorCQlnb3RvIHBpbjsKKworCS8qIFByZXR0eSBidXN5ISBM
b29wIG92ZXIgIkxSVSIgYW5kIGV2aWN0IG9sZGVzdCBpbiBvdXIgc2VhcmNoIHJhbmdlICovCisJ
ZXJyID0gZXZpY3RfaW5fcmFuZ2Uod29yaywgYmluZCwgc3RhcnQsIGVuZCwgYWxpZ24pOworCWlm
ICh1bmxpa2VseShlcnIpKQorCQlyZXR1cm4gZXJyOworCitwaW46CisJaWYgKHVubGlrZWx5KGV4
ZWNfZmxhZ3MgJiBFWEVDX09CSkVDVF9ORUVEU19GRU5DRSkpIHsKKwkJZXJyID0gX19pOTE1X3Zt
YV9waW5fZmVuY2Uodm1hKTsgLyogWFhYIG5vIHdhaXRpbmcgKi8KKwkJaWYgKHVubGlrZWx5KGVy
cikpCisJCQlyZXR1cm4gZXJyOwogCiAJCWlmICh2bWEtPmZlbmNlKQotCQkJZXYtPmZsYWdzIHw9
IF9fRVhFQ19PQkpFQ1RfSEFTX0ZFTkNFOworCQkJYmluZC0+ZXYtPmZsYWdzIHw9IF9fRVhFQ19P
QkpFQ1RfSEFTX0ZFTkNFOwogCX0KIAotCWV2LT5mbGFncyB8PSBfX0VYRUNfT0JKRUNUX0hBU19Q
SU47Ci0JR0VNX0JVR19PTihlYl92bWFfbWlzcGxhY2VkKGVudHJ5LCB2bWEsIGV2LT5mbGFncykp
OworCWJpbmRfZmxhZ3MgJj0gfmF0b21pY19yZWFkKCZ2bWEtPmZsYWdzKTsKKwlpZiAoYmluZF9m
bGFncykgeworCQllcnIgPSBzZXRfYmluZF9mZW5jZSh2bWEsIHdvcmspOworCQlpZiAodW5saWtl
bHkoZXJyKSkKKwkJCXJldHVybiBlcnI7CisKKwkJYXRvbWljX2FkZChJOTE1X1ZNQV9QQUdFU19B
Q1RJVkUsICZ2bWEtPnBhZ2VzX2NvdW50KTsKKwkJYXRvbWljX29yKGJpbmRfZmxhZ3MsICZ2bWEt
PmZsYWdzKTsKKworCQlpZiAoaTkxNV92bWFfaXNfZ2d0dCh2bWEpKQorCQkJX19pOTE1X3ZtYV9z
ZXRfbWFwX2FuZF9mZW5jZWFibGUodm1hKTsKKworCQlHRU1fQlVHX09OKCFpOTE1X3ZtYV9pc19h
Y3RpdmUodm1hKSk7CisJCWxpc3RfbW92ZV90YWlsKCZ2bWEtPnZtX2xpbmssICZ2bS0+Ym91bmRf
bGlzdCk7CisJCWJpbmQtPmJpbmRfZmxhZ3MgPSBiaW5kX2ZsYWdzOworCX0KKwlfX2k5MTVfdm1h
X3Bpbih2bWEpOyAvKiBhbmQgcmVsZWFzZSAqLworCisJR0VNX0JVR19PTighYmluZF9mbGFncyAm
JiAhZHJtX21tX25vZGVfYWxsb2NhdGVkKCZ2bWEtPm5vZGUpKTsKKwlHRU1fQlVHX09OKCEoZHJt
X21tX25vZGVfYWxsb2NhdGVkKCZ2bWEtPm5vZGUpIF4KKwkJICAgICBkcm1fbW1fbm9kZV9hbGxv
Y2F0ZWQoJmJpbmQtPmhvbGUpKSk7CisKKwlpZiAoZW50cnktPm9mZnNldCAhPSB2bWEtPm5vZGUu
c3RhcnQpIHsKKwkJZW50cnktPm9mZnNldCA9IHZtYS0+bm9kZS5zdGFydCB8IFVQREFURTsKKwkJ
KndvcmstPnBfZmxhZ3MgfD0gX19FWEVDX0hBU19SRUxPQzsKKwl9CisKKwliaW5kLT5ldi0+Zmxh
Z3MgfD0gX19FWEVDX09CSkVDVF9IQVNfUElOOworCUdFTV9CVUdfT04oZWJfdm1hX21pc3BsYWNl
ZChlbnRyeSwgdm1hLCBiaW5kLT5ldi0+ZmxhZ3MpKTsKIAogCXJldHVybiAwOwogfQpAQCAtNzEy
LDEzICsxMTI1LDI0MSBAQCBzdGF0aWMgaW50IHdhaXRfZm9yX3RpbWVsaW5lKHN0cnVjdCBpbnRl
bF90aW1lbGluZSAqdGwpCiAJfSB3aGlsZSAoMSk7CiB9CiAKK3N0YXRpYyB2b2lkIF9fZWJfYmlu
ZF92bWEoc3RydWN0IGViX3ZtX3dvcmsgKndvcmspCit7CisJc3RydWN0IGk5MTVfYWRkcmVzc19z
cGFjZSAqdm0gPSB3b3JrLT52bTsKKwl1bnNpZ25lZCBsb25nIG47CisKKwlHRU1fQlVHX09OKCFp
bnRlbF9ndF9wbV9pc19hd2FrZSh2bS0+Z3QpKTsKKworCS8qCisJICogV2UgaGF2ZSB0byB3YWl0
IHVudGlsIHRoZSBzdGFsZSBub2RlcyBhcmUgY29tcGxldGVseSBpZGxlIGJlZm9yZQorCSAqIHdl
IGNhbiByZW1vdmUgdGhlaXIgUFRFIGFuZCB1bmJpbmQgdGhlaXIgcGFnZXMuIEhlbmNlLCBhZnRl
cgorCSAqIGNsYWltaW5nIHRoZWlyIHNsb3QgaW4gdGhlIGRybV9tbSwgd2UgZGVmZXIgdGhlaXIg
cmVtb3ZhbCB0bworCSAqIGFmdGVyIHRoZSBmZW5jZXMgYXJlIHNpZ25hbGVkLgorCSAqLworCWlm
ICghbGlzdF9lbXB0eSgmd29yay0+ZXZpY3RfbGlzdCkpIHsKKwkJc3RydWN0IGk5MTVfdm1hICp2
bWEsICp2bjsKKworCQltdXRleF9sb2NrKCZ2bS0+bXV0ZXgpOworCQlsaXN0X2Zvcl9lYWNoX2Vu
dHJ5X3NhZmUodm1hLCB2biwgJndvcmstPmV2aWN0X2xpc3QsIHZtX2xpbmspIHsKKwkJCUdFTV9C
VUdfT04odm1hLT52bSAhPSB2bSk7CisJCQlfX2k5MTVfdm1hX2V2aWN0KHZtYSk7CisJCQlHRU1f
QlVHX09OKCFpOTE1X3ZtYV9pc19hY3RpdmUodm1hKSk7CisJCX0KKwkJbXV0ZXhfdW5sb2NrKCZ2
bS0+bXV0ZXgpOworCX0KKworCS8qCisJICogTm93IHdlIGtub3cgdGhlIG5vZGVzIHdlIHJlcXVp
cmUgaW4gZHJtX21tIGFyZSBpZGxlLCB3ZSBjYW4KKwkgKiByZXBsYWNlIHRoZSBQVEUgaW4gdGhv
c2UgcmFuZ2VzIHdpdGggb3VyIG93bi4KKwkgKi8KKwlmb3IgKG4gPSAwOyBuIDwgd29yay0+Y291
bnQ7IG4rKykgeworCQlzdHJ1Y3QgZWJfYmluZF92bWEgKmJpbmQgPSAmd29yay0+YmluZFtuXTsK
KwkJc3RydWN0IGk5MTVfdm1hICp2bWEgPSBiaW5kLT5ldi0+dm1hOworCisJCWlmICghYmluZC0+
YmluZF9mbGFncykKKwkJCWdvdG8gcHV0OworCisJCUdFTV9CVUdfT04odm1hLT52bSAhPSB2bSk7
CisJCUdFTV9CVUdfT04oIWk5MTVfdm1hX2lzX2FjdGl2ZSh2bWEpKTsKKworCQl2bWEtPm9wcy0+
YmluZF92bWEodm0sICZ3b3JrLT5zdGFzaCwgdm1hLAorCQkJCSAgIHZtYS0+b2JqLT5jYWNoZV9s
ZXZlbCwgYmluZC0+YmluZF9mbGFncyk7CisKKwkJaWYgKGRybV9tbV9ub2RlX2FsbG9jYXRlZCgm
YmluZC0+aG9sZSkpIHsKKwkJCW11dGV4X2xvY2soJnZtLT5tdXRleCk7CisJCQlHRU1fQlVHX09O
KGJpbmQtPmhvbGUubW0gIT0gJnZtLT5tbSk7CisJCQlHRU1fQlVHX09OKGJpbmQtPmhvbGUuY29s
b3IgIT0gSTkxNV9DT0xPUl9VTkVWSUNUQUJMRSk7CisJCQlHRU1fQlVHX09OKGRybV9tbV9ub2Rl
X2FsbG9jYXRlZCgmdm1hLT5ub2RlKSk7CisKKwkJCWRybV9tbV9yZW1vdmVfbm9kZSgmYmluZC0+
aG9sZSk7CisJCQlkcm1fbW1fcmVzZXJ2ZV9ub2RlKCZ2bS0+bW0sICZ2bWEtPm5vZGUpOworCisJ
CQlHRU1fQlVHX09OKCFkcm1fbW1fbm9kZV9hbGxvY2F0ZWQoJnZtYS0+bm9kZSkpOworCQkJbXV0
ZXhfdW5sb2NrKCZ2bS0+bXV0ZXgpOworCQl9CisJCWJpbmQtPmJpbmRfZmxhZ3MgPSAwOworCitw
dXQ6CisJCUdFTV9CVUdfT04oZHJtX21tX25vZGVfYWxsb2NhdGVkKCZiaW5kLT5ob2xlKSk7CisJ
CWk5MTVfdm1hX3B1dF9wYWdlcyh2bWEpOworCX0KKwl3b3JrLT5jb3VudCA9IDA7Cit9CisKK3N0
YXRpYyBpbnQgZWJfYmluZF92bWEoc3RydWN0IGRtYV9mZW5jZV93b3JrICpiYXNlKQoreworCXN0
cnVjdCBlYl92bV93b3JrICp3b3JrID0gY29udGFpbmVyX29mKGJhc2UsIHR5cGVvZigqd29yayks
IGJhc2UpOworCisJX19lYl9iaW5kX3ZtYSh3b3JrKTsKKwlyZXR1cm4gMDsKK30KKworc3RhdGlj
IHZvaWQgZWJfdm1hX3dvcmtfcmVsZWFzZShzdHJ1Y3QgZG1hX2ZlbmNlX3dvcmsgKmJhc2UpCit7
CisJc3RydWN0IGViX3ZtX3dvcmsgKndvcmsgPSBjb250YWluZXJfb2YoYmFzZSwgdHlwZW9mKCp3
b3JrKSwgYmFzZSk7CisKKwlfX2ViX2JpbmRfdm1hKHdvcmspOworCWt2ZnJlZSh3b3JrLT5iaW5k
KTsKKworCWlmICh3b3JrLT5pZCkKKwkJaTkxNV9hY3RpdmVfcmVsZWFzZSgmd29yay0+dm0tPmJp
bmRpbmcpOworCisJZWJfdm1hX2FycmF5X3B1dCh3b3JrLT5hcnJheSk7CisKKwlpOTE1X3ZtX2Zy
ZWVfcHRfc3Rhc2god29yay0+dm0sICZ3b3JrLT5zdGFzaCk7CisJaTkxNV92bV9wdXQod29yay0+
dm0pOworfQorCitzdGF0aWMgY29uc3Qgc3RydWN0IGRtYV9mZW5jZV93b3JrX29wcyBlYl9iaW5k
X29wcyA9IHsKKwkubmFtZSA9ICJlYl9iaW5kIiwKKwkud29yayA9IGViX2JpbmRfdm1hLAorCS5y
ZWxlYXNlID0gZWJfdm1hX3dvcmtfcmVsZWFzZSwKK307CisKK3N0YXRpYyBpbnQgZWJfdm1fd29y
a19jYW5jZWwoc3RydWN0IGViX3ZtX3dvcmsgKndvcmssIGludCBlcnIpCit7CisJd29yay0+YmFz
ZS5kbWEuZXJyb3IgPSBlcnI7CisJZG1hX2ZlbmNlX3dvcmtfY29tbWl0X2ltbSgmd29yay0+YmFz
ZSk7CisKKwlyZXR1cm4gZXJyOworfQorCitzdGF0aWMgc3RydWN0IGViX3ZtX3dvcmsgKmViX3Zt
X3dvcmsoc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIsCisJCQkJICAgICB1bnNpZ25lZCBsb25n
IGNvdW50KQoreworCXN0cnVjdCBlYl92bV93b3JrICp3b3JrOworCisJd29yayA9IGttYWxsb2Mo
c2l6ZW9mKCp3b3JrKSwgR0ZQX0tFUk5FTCk7CisJaWYgKCF3b3JrKQorCQlyZXR1cm4gTlVMTDsK
KworCXdvcmstPmJpbmQgPSBrdm1hbGxvYyhzaXplb2YoKndvcmstPmJpbmQpICogY291bnQsIEdG
UF9LRVJORUwpOworCWlmICghd29yay0+YmluZCkgeworCQlrZnJlZSh3b3JrLT5iaW5kKTsKKwkJ
cmV0dXJuIE5VTEw7CisJfQorCXdvcmstPmNvdW50ID0gY291bnQ7CisKKwlJTklUX0xJU1RfSEVB
RCgmd29yay0+ZXZpY3RfbGlzdCk7CisKKwlkbWFfZmVuY2Vfd29ya19pbml0KCZ3b3JrLT5iYXNl
LCAmZWJfYmluZF9vcHMpOworCXdvcmstPmFycmF5ID0gZWJfdm1hX2FycmF5X2dldChlYi0+YXJy
YXkpOworCXdvcmstPnBfZmxhZ3MgPSAmZWItPmFyZ3MtPmZsYWdzOworCXdvcmstPnZtID0gaTkx
NV92bV9nZXQoZWItPmNvbnRleHQtPnZtKTsKKwltZW1zZXQoJndvcmstPnN0YXNoLCAwLCBzaXpl
b2Yod29yay0+c3Rhc2gpKTsKKworCS8qIFByZWFsbG9jYXRlIG91ciBzbG90IGluIHZtLT5iaW5k
aW5nLCBvdXRzaWRlIG9mIHZtLT5tdXRleCAqLworCXdvcmstPmlkID0gaTkxNV9nZW1fY29udGV4
dF9hc3luY19pZChlYi0+Z2VtX2NvbnRleHQpOworCWlmIChpOTE1X2FjdGl2ZV9hY3F1aXJlX2Zv
cl9jb250ZXh0KCZ3b3JrLT52bS0+YmluZGluZywgd29yay0+aWQpKSB7CisJCXdvcmstPmlkID0g
MDsKKwkJZWJfdm1fd29ya19jYW5jZWwod29yaywgLUVOT01FTSk7CisJCXJldHVybiBOVUxMOwor
CX0KKworCXJldHVybiB3b3JrOworfQorCitzdGF0aWMgaW50IGViX3ZtX3Rocm90dGxlKHN0cnVj
dCBlYl92bV93b3JrICp3b3JrKQoreworCXN0cnVjdCBkbWFfZmVuY2UgKnA7CisJaW50IGVycjsK
KworCS8qIEtlZXAgYXN5bmMgd29yayBxdWV1ZWQgcGVyIGNvbnRleHQgKi8KKwlwID0gX19pOTE1
X2FjdGl2ZV9yZWYoJndvcmstPnZtLT5iaW5kaW5nLCB3b3JrLT5pZCwgJndvcmstPmJhc2UuZG1h
KTsKKwlpZiAoSVNfRVJSX09SX05VTEwocCkpCisJCXJldHVybiBQVFJfRVJSX09SX1pFUk8ocCk7
CisKKwllcnIgPSBpOTE1X3N3X2ZlbmNlX2F3YWl0X2RtYV9mZW5jZSgmd29yay0+YmFzZS5jaGFp
biwgcCwgMCwKKwkJCQkJICAgIEdGUF9OT1dBSVQgfCBfX0dGUF9OT1dBUk4pOworCWRtYV9mZW5j
ZV9wdXQocCk7CisKKwlyZXR1cm4gZXJyIDwgMCA/IGVyciA6IDA7Cit9CisKK3N0YXRpYyBpbnQg
ZWJfcHJlcGFyZV92bWEoc3RydWN0IGViX3ZtX3dvcmsgKndvcmssCisJCQkgIHVuc2lnbmVkIGxv
bmcgaWR4LAorCQkJICBzdHJ1Y3QgZWJfdm1hICpldikKK3sKKwlzdHJ1Y3QgZWJfYmluZF92bWEg
KmJpbmQgPSAmd29yay0+YmluZFtpZHhdOworCXN0cnVjdCBpOTE1X3ZtYSAqdm1hID0gZXYtPnZt
YTsKKwlpbnQgZXJyOworCisJYmluZC0+ZXYgPSBldjsKKwliaW5kLT5ob2xlLmZsYWdzID0gMDsK
KwliaW5kLT5iaW5kX2ZsYWdzID0gMDsKKworCS8qIEFsbG9jYXRlIGVub3VnaCBwYWdlIGRpcmVj
dG9yaWVzIHRvIGNvdmVyIFBURSB1c2VkICovCisJaWYgKHdvcmstPnZtLT5hbGxvY2F0ZV92YV9y
YW5nZSkgeworCQllcnIgPSBpOTE1X3ZtX2FsbG9jX3B0X3N0YXNoKHdvcmstPnZtLCAmd29yay0+
c3Rhc2gsIHZtYS0+c2l6ZSk7CisJCWlmIChlcnIpCisJCQlyZXR1cm4gZXJyOworCX0KKworCXJl
dHVybiBpOTE1X3ZtYV9nZXRfcGFnZXModm1hKTsKK30KKworc3RhdGljIGludCB3YWl0X2Zvcl91
bmJpbmRzKHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViLAorCQkJICAgIHN0cnVjdCBsaXN0X2hl
YWQgKnVuYm91bmQsCisJCQkgICAgaW50IHBhc3MpCit7CisJc3RydWN0IGViX3ZtYSAqZXY7CisJ
aW50IGVycjsKKworCWxpc3RfZm9yX2VhY2hfZW50cnkoZXYsIHVuYm91bmQsIHVuYm91bmRfbGlu
aykgeworCQlzdHJ1Y3QgaTkxNV92bWEgKnZtYSA9IGV2LT52bWE7CisKKwkJR0VNX0JVR19PTihl
di0+ZmxhZ3MgJiBfX0VYRUNfT0JKRUNUX0hBU19QSU4pOworCisJCWlmIChkcm1fbW1fbm9kZV9h
bGxvY2F0ZWQoJnZtYS0+bm9kZSkgJiYKKwkJICAgIGViX3ZtYV9taXNwbGFjZWQoZXYtPmV4ZWMs
IHZtYSwgZXYtPmZsYWdzKSkgeworCQkJZXJyID0gaTkxNV92bWFfdW5iaW5kKHZtYSk7CisJCQlp
ZiAoZXJyKQorCQkJCXJldHVybiBlcnI7CisJCX0KKworCQkvKiBXYWl0IGZvciBwcmV2aW91cyB0
byBhdm9pZCByZXVzaW5nIHZtYS0+bm9kZSAqLworCQllcnIgPSBpOTE1X3ZtYV93YWl0X2Zvcl91
bmJpbmQodm1hKTsKKwkJaWYgKGVycikKKwkJCXJldHVybiBlcnI7CisJfQorCisJc3dpdGNoIChw
YXNzKSB7CisJZGVmYXVsdDoKKwkJcmV0dXJuIC1FTk9TUEM7CisKKwljYXNlIDI6CisJCS8qCisJ
CSAqIFRvbyBmcmFnbWVudGVkLCByZXRpcmUgZXZlcnl0aGluZyBvbiB0aGUgdGltZWxpbmUgYW5k
IHNvCisJCSAqIG1ha2UgaXQgYWxsIFtjb250ZXh0cyBpbmNsdWRlZF0gYXZhaWxhYmxlIHRvIGV2
aWN0LgorCQkgKi8KKwkJZXJyID0gd2FpdF9mb3JfdGltZWxpbmUoZWItPmNvbnRleHQtPnRpbWVs
aW5lKTsKKwkJaWYgKGVycikKKwkJCXJldHVybiBlcnI7CisKKwkJZmFsbHRocm91Z2g7CisJY2Fz
ZSAxOgorCQkvKiBYWFggdGlja2V0IGxvY2sgKi8KKwkJaWYgKGk5MTVfYWN0aXZlX3dhaXQoJmVi
LT5jb250ZXh0LT52bS0+YmluZGluZykpCisJCQlyZXR1cm4gLUVJTlRSOworCisJCWZhbGx0aHJv
dWdoOworCWNhc2UgMDoKKwkJcmV0dXJuIDA7CisJfQorfQorCiBzdGF0aWMgaW50IGViX3Jlc2Vy
dmVfdm0oc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIpCiB7Ci0JdW5zaWduZWQgaW50IHBpbl9m
bGFncyA9IFBJTl9VU0VSIHwgUElOX05PTkJMT0NLOworCXN0cnVjdCBpOTE1X2FkZHJlc3Nfc3Bh
Y2UgKnZtID0gZWItPmNvbnRleHQtPnZtOwogCXN0cnVjdCBsaXN0X2hlYWQgbGFzdCwgdW5ib3Vu
ZDsKKwl1bnNpZ25lZCBsb25nIGNvdW50OwogCXN0cnVjdCBlYl92bWEgKmV2OwogCXVuc2lnbmVk
IGludCBwYXNzOworCWludCBlcnIgPSAwOwogCisJY291bnQgPSAwOwogCUlOSVRfTElTVF9IRUFE
KCZ1bmJvdW5kKTsKIAlsaXN0X2Zvcl9lYWNoX2VudHJ5KGV2LCAmZWItPmJpbmRfbGlzdCwgYmlu
ZF9saW5rKSB7CiAJCXN0cnVjdCBkcm1faTkxNV9nZW1fZXhlY19vYmplY3QyICplbnRyeSA9IGV2
LT5leGVjOwpAQCAtNzM1LDI5ICsxMzc2LDE1IEBAIHN0YXRpYyBpbnQgZWJfcmVzZXJ2ZV92bShz
dHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYikKIAkJCQlsaXN0X2FkZCgmZXYtPnVuYm91bmRfbGlu
aywgJnVuYm91bmQpOwogCQkJZWxzZQogCQkJCWxpc3RfYWRkX3RhaWwoJmV2LT51bmJvdW5kX2xp
bmssICZ1bmJvdW5kKTsKKwkJCWNvdW50Kys7CiAJCX0KIAl9Ci0KLQlpZiAobGlzdF9lbXB0eSgm
dW5ib3VuZCkpCisJaWYgKGNvdW50ID09IDApCiAJCXJldHVybiAwOwogCi0JLyoKLQkgKiBBdHRl
bXB0IHRvIHBpbiBhbGwgb2YgdGhlIGJ1ZmZlcnMgaW50byB0aGUgR1RULgotCSAqIFRoaXMgaXMg
ZG9uZSBpbiAzIHBoYXNlczoKLQkgKgotCSAqIDFhLiBVbmJpbmQgYWxsIG9iamVjdHMgdGhhdCBk
byBub3QgbWF0Y2ggdGhlIEdUVCBjb25zdHJhaW50cyBmb3IKLQkgKiAgICAgdGhlIGV4ZWNidWZm
ZXIgKGZlbmNlYWJsZSwgbWFwcGFibGUsIGFsaWdubWVudCBldGMpLgotCSAqIDFiLiBJbmNyZW1l
bnQgcGluIGNvdW50IGZvciBhbHJlYWR5IGJvdW5kIG9iamVjdHMuCi0JICogMi4gIEJpbmQgbmV3
IG9iamVjdHMuCi0JICogMy4gIERlY3JlbWVudCBwaW4gY291bnQuCi0JICoKLQkgKiBUaGlzIGF2
b2lkIHVubmVjZXNzYXJ5IHVuYmluZGluZyBvZiBsYXRlciBvYmplY3RzIGluIG9yZGVyIHRvIG1h
a2UKLQkgKiByb29tIGZvciB0aGUgZWFybGllciBvYmplY3RzICp1bmxlc3MqIHdlIG5lZWQgdG8g
ZGVmcmFnbWVudC4KLQkgKi8KLQogCXBhc3MgPSAwOwogCWRvIHsKLQkJaW50IGVyciA9IDA7CisJ
CXN0cnVjdCBlYl92bV93b3JrICp3b3JrOwogCiAJCS8qCiAJCSAqIFdlIG5lZWQgdG8gaG9sZCBv
bmUgbG9jayBhcyB3ZSBiaW5kIGFsbCB0aGUgdm1hIHNvIHRoYXQKQEAgLTc3MSwyMyArMTM5OCw4
NyBAQCBzdGF0aWMgaW50IGViX3Jlc2VydmVfdm0oc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIp
CiAJCSAqIGZpbmQgc3BhY2UgZm9yIG5ldyBidWZmZXJzLCB3ZSBrbm93IHRoYXQgZXh0cmEgcHJl
c3N1cmUKIAkJICogZnJvbSBjb250ZW50aW9uIGlzIGxpa2VseS4KIAkJICoKLQkJICogSW4gbGll
dSBvZiBiZWluZyBhYmxlIHRvIGhvbGQgdm0tPm11dGV4IGZvciB0aGUgZW50aXJlCi0JCSAqIHNl
cXVlbmNlIChpdCdzIGNvbXBsaWNhdGVkISksIHdlIG9wdCBmb3Igc3RydWN0X211dGV4LgorCQkg
KiB2bS0+bXV0ZXggaXMgY29tcGxpY2F0ZWQsIGFzIHdlIGFyZSBub3QgYWxsb3dlZCB0byBhbGxv
Y2F0ZQorCQkgKiBiZW5lYXRoIGl0LCBzbyB3ZSBoYXZlIHRvIHN0YWdlIGFuZCBwcmVhbGxvY2F0
ZSBhbGwgdGhlCisJCSAqIHJlc291cmNlcyB3ZSBtYXkgcmVxdWlyZSBiZWZvcmUgdGFraW5nIHRo
ZSBtdXRleC4KIAkJICovCi0JCWlmIChtdXRleF9sb2NrX2ludGVycnVwdGlibGUoJmViLT5pOTE1
LT5kcm0uc3RydWN0X211dGV4KSkKLQkJCXJldHVybiAtRUlOVFI7CisJCXdvcmsgPSBlYl92bV93
b3JrKGViLCBjb3VudCk7CisJCWlmICghd29yaykKKwkJCXJldHVybiAtRU5PTUVNOwogCisJCWNv
dW50ID0gMDsKIAkJbGlzdF9mb3JfZWFjaF9lbnRyeShldiwgJnVuYm91bmQsIHVuYm91bmRfbGlu
aykgewotCQkJZXJyID0gZWJfcmVzZXJ2ZV92bWEoZWIsIGV2LCBwaW5fZmxhZ3MpOworCQkJZXJy
ID0gZWJfcHJlcGFyZV92bWEod29yaywgY291bnQrKywgZXYpOworCQkJaWYgKGVycikgeworCQkJ
CXdvcmstPmNvdW50ID0gY291bnQgLSAxOworCisJCQkJaWYgKGViX3ZtX3dvcmtfY2FuY2VsKHdv
cmssIGVycikgPT0gLUVBR0FJTikKKwkJCQkJZ290byByZXRyeTsKKworCQkJCXJldHVybiBlcnI7
CisJCQl9CisJCX0KKworCQllcnIgPSBpOTE1X3ZtX3Bpbl9wdF9zdGFzaCh3b3JrLT52bSwgJndv
cmstPnN0YXNoKTsKKwkJaWYgKGVycikKKwkJCXJldHVybiBlYl92bV93b3JrX2NhbmNlbCh3b3Jr
LCBlcnIpOworCisJCS8qIE5vIGFsbG9jYXRpb25zIGFsbG93ZWQgYmV5b25kIHRoaXMgcG9pbnQg
Ki8KKwkJaWYgKG11dGV4X2xvY2tfaW50ZXJydXB0aWJsZSgmdm0tPm11dGV4KSkKKwkJCXJldHVy
biBlYl92bV93b3JrX2NhbmNlbCh3b3JrLCAtRUlOVFIpOworCisJCWVyciA9IGViX3ZtX3Rocm90
dGxlKHdvcmspOworCQlpZiAoZXJyKSB7CisJCQltdXRleF91bmxvY2soJnZtLT5tdXRleCk7CisJ
CQlyZXR1cm4gZWJfdm1fd29ya19jYW5jZWwod29yaywgZXJyKTsKKwkJfQorCisJCWZvciAoY291
bnQgPSAwOyBjb3VudCA8IHdvcmstPmNvdW50OyBjb3VudCsrKSB7CisJCQlzdHJ1Y3QgZWJfYmlu
ZF92bWEgKmJpbmQgPSAmd29yay0+YmluZFtjb3VudF07CisJCQlzdHJ1Y3QgaTkxNV92bWEgKnZt
YTsKKworCQkJZXYgPSBiaW5kLT5ldjsKKwkJCXZtYSA9IGV2LT52bWE7CisKKwkJCS8qCisJCQkg
KiBDaGVjayBpZiB0aGlzIG5vZGUgaXMgYmVpbmcgZXZpY3RlZCBvciBtdXN0IGJlLgorCQkJICoK
KwkJCSAqIEFzIHdlIHVzZSB0aGUgc2luZ2xlIG5vZGUgaW5zaWRlIHRoZSB2bWEgdG8gdHJhY2sK
KwkJCSAqIGJvdGggdGhlIGV2aWN0aW9uIGFuZCB3aGVyZSB0byBpbnNlcnQgdGhlIG5ldyBub2Rl
LAorCQkJICogd2UgY2Fubm90IGhhbmRsZSBtaWdyYXRpbmcgdGhlIHZtYSBpbnNpZGUgdGhlIHdv
cmtlci4KKwkJCSAqLworCQkJaWYgKGRybV9tbV9ub2RlX2FsbG9jYXRlZCgmdm1hLT5ub2RlKSkg
eworCQkJCWlmIChlYl92bWFfbWlzcGxhY2VkKGV2LT5leGVjLCB2bWEsIGV2LT5mbGFncykpIHsK
KwkJCQkJZXJyID0gLUVOT1NQQzsKKwkJCQkJYnJlYWs7CisJCQkJfQorCQkJfSBlbHNlIHsKKwkJ
CQlpZiAoaTkxNV92bWFfaXNfYWN0aXZlKHZtYSkpIHsKKwkJCQkJZXJyID0gLUVOT1NQQzsKKwkJ
CQkJYnJlYWs7CisJCQkJfQorCQkJfQorCisJCQllcnIgPSBpOTE1X2FjdGl2ZV9hY3F1aXJlKCZ2
bWEtPmFjdGl2ZSk7CisJCQlpZiAoIWVycikgeworCQkJCWVyciA9IGViX3Jlc2VydmVfdm1hKHdv
cmssIGJpbmQpOworCQkJCWk5MTVfYWN0aXZlX3JlbGVhc2UoJnZtYS0+YWN0aXZlKTsKKwkJCX0K
IAkJCWlmIChlcnIpCiAJCQkJYnJlYWs7CisKKwkJCUdFTV9CVUdfT04oIWk5MTVfdm1hX2lzX3Bp
bm5lZCh2bWEpKTsKIAkJfQotCQlpZiAoIShlcnIgPT0gLUVOT1NQQyB8fCBlcnIgPT0gLUVBR0FJ
TikpIHsKLQkJCW11dGV4X3VubG9jaygmZWItPmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOworCisJ
CW11dGV4X3VubG9jaygmdm0tPm11dGV4KTsKKworCQlkbWFfZmVuY2Vfd29ya19jb21taXRfaW1t
KCZ3b3JrLT5iYXNlKTsKKwkJaWYgKGVyciAhPSAtRU5PU1BDKQogCQkJcmV0dXJuIGVycjsKLQkJ
fQogCityZXRyeToKIAkJLyogUmVzb3J0ICphbGwqIHRoZSBvYmplY3RzIGludG8gcHJpb3JpdHkg
b3JkZXIgKi8KKwkJY291bnQgPSAwOwogCQlJTklUX0xJU1RfSEVBRCgmdW5ib3VuZCk7CiAJCUlO
SVRfTElTVF9IRUFEKCZsYXN0KTsKIAkJbGlzdF9mb3JfZWFjaF9lbnRyeShldiwgJmViLT5iaW5k
X2xpc3QsIGJpbmRfbGluaykgewpAQCAtNzk4LDYgKzE0ODksNyBAQCBzdGF0aWMgaW50IGViX3Jl
c2VydmVfdm0oc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIpCiAJCQkJY29udGludWU7CiAKIAkJ
CWViX3VucmVzZXJ2ZV92bWEoZXYpOworCQkJY291bnQrKzsKIAogCQkJaWYgKGZsYWdzICYgRVhF
Q19PQkpFQ1RfUElOTkVEKQogCQkJCS8qIFBpbm5lZCBtdXN0IGhhdmUgdGhlaXIgc2xvdCAqLwpA
QCAtODEyLDExICsxNTA0LDE2IEBAIHN0YXRpYyBpbnQgZWJfcmVzZXJ2ZV92bShzdHJ1Y3QgaTkx
NV9leGVjYnVmZmVyICplYikKIAkJCQlsaXN0X2FkZF90YWlsKCZldi0+dW5ib3VuZF9saW5rLCAm
bGFzdCk7CiAJCX0KIAkJbGlzdF9zcGxpY2VfdGFpbCgmbGFzdCwgJnVuYm91bmQpOwotCQltdXRl
eF91bmxvY2soJmViLT5pOTE1LT5kcm0uc3RydWN0X211dGV4KTsKKwkJR0VNX0JVR19PTighY291
bnQpOworCisJCWlmIChzaWduYWxfcGVuZGluZyhjdXJyZW50KSkKKwkJCXJldHVybiAtRUlOVFI7
CisKKwkJLyogTm93IHNhZmUgdG8gd2FpdCB3aXRoIG5vIHJlc2VydmF0aW9ucyBoZWxkICovCiAK
IAkJaWYgKGVyciA9PSAtRUFHQUlOKSB7CiAJCQlmbHVzaF93b3JrcXVldWUoZWItPmk5MTUtPm1t
LnVzZXJwdHJfd3EpOwotCQkJY29udGludWU7CisJCQlwYXNzID0gMDsKIAkJfQogCiAJCS8qCkBA
IC04MzQsMjcgKzE1MzEsOSBAQCBzdGF0aWMgaW50IGViX3Jlc2VydmVfdm0oc3RydWN0IGk5MTVf
ZXhlY2J1ZmZlciAqZWIpCiAJCSAqIHRoZXJlIGlzIG5vIGd1YXJhbnRlZSB0aGF0IHdlIHdpbGwg
c3VjY2VlZCBpbiBjbGFpbWluZwogCQkgKiB0b3RhbCBvd25lcnNoaXAgb2YgdGhlIHZtLgogCQkg
Ki8KLQkJc3dpdGNoIChwYXNzKyspIHsKLQkJY2FzZSAwOgotCQkJYnJlYWs7Ci0KLQkJY2FzZSAx
OgotCQkJLyoKLQkJCSAqIFRvbyBmcmFnbWVudGVkLCByZXRpcmUgZXZlcnl0aGluZyBvbiB0aGUg
dGltZWxpbmUKLQkJCSAqIGFuZCBzbyBtYWtlIGl0IGFsbCBbY29udGV4dHMgaW5jbHVkZWRdIGF2
YWlsYWJsZSB0bwotCQkJICogZXZpY3QuCi0JCQkgKi8KLQkJCWVyciA9IHdhaXRfZm9yX3RpbWVs
aW5lKGViLT5jb250ZXh0LT50aW1lbGluZSk7Ci0JCQlpZiAoZXJyKQotCQkJCXJldHVybiBlcnI7
Ci0KLQkJCWJyZWFrOwotCi0JCWRlZmF1bHQ6Ci0JCQlyZXR1cm4gLUVOT1NQQzsKLQkJfQotCi0J
CXBpbl9mbGFncyA9IFBJTl9VU0VSOworCQllcnIgPSB3YWl0X2Zvcl91bmJpbmRzKGViLCAmdW5i
b3VuZCwgcGFzcysrKTsKKwkJaWYgKGVycikKKwkJCXJldHVybiBlcnI7CiAJfSB3aGlsZSAoMSk7
CiB9CiAKQEAgLTE0NTIsNiArMjEzMSwyOSBAQCByZWxvY2F0ZV9lbnRyeShzdHJ1Y3QgaTkxNV9l
eGVjYnVmZmVyICplYiwKIAlyZXR1cm4gdGFyZ2V0LT5ub2RlLnN0YXJ0IHwgVVBEQVRFOwogfQog
CitzdGF0aWMgaW50IGdlbjZfZml4dXBfZ2d0dChzdHJ1Y3QgaTkxNV92bWEgKnZtYSkKK3sKKwlp
bnQgZXJyOworCisJaWYgKGk5MTVfdm1hX2lzX2JvdW5kKHZtYSwgSTkxNV9WTUFfR0xPQkFMX0JJ
TkQpKQorCQlyZXR1cm4gMDsKKworCWVyciA9IGk5MTVfdm1hX3dhaXRfZm9yX2JpbmQodm1hKTsK
KwlpZiAoZXJyKQorCQlyZXR1cm4gZXJyOworCisJbXV0ZXhfbG9jaygmdm1hLT52bS0+bXV0ZXgp
OworCWlmICghKGF0b21pY19mZXRjaF9vcihJOTE1X1ZNQV9HTE9CQUxfQklORCwgJnZtYS0+Zmxh
Z3MpICYgSTkxNV9WTUFfR0xPQkFMX0JJTkQpKSB7CisJCV9faTkxNV9nZW1fb2JqZWN0X3Bpbl9w
YWdlcyh2bWEtPm9iaik7CisJCXZtYS0+b3BzLT5iaW5kX3ZtYSh2bWEtPnZtLCBOVUxMLCB2bWEs
CisJCQkJICAgdm1hLT5vYmotPmNhY2hlX2xldmVsLAorCQkJCSAgIEk5MTVfVk1BX0dMT0JBTF9C
SU5EKTsKKwl9CisJbXV0ZXhfdW5sb2NrKCZ2bWEtPnZtLT5tdXRleCk7CisKKwlyZXR1cm4gMDsK
K30KKwogc3RhdGljIHU2NAogZWJfcmVsb2NhdGVfZW50cnkoc3RydWN0IGk5MTVfZXhlY2J1ZmZl
ciAqZWIsCiAJCSAgc3RydWN0IGViX3ZtYSAqZXYsCkBAIC0xNDY2LDYgKzIxNjgsOCBAQCBlYl9y
ZWxvY2F0ZV9lbnRyeShzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYiwKIAlpZiAodW5saWtlbHko
IXRhcmdldCkpCiAJCXJldHVybiAtRU5PRU5UOwogCisJR0VNX0JVR19PTighaTkxNV92bWFfaXNf
cGlubmVkKHRhcmdldC0+dm1hKSk7CisKIAkvKiBWYWxpZGF0ZSB0aGF0IHRoZSB0YXJnZXQgaXMg
aW4gYSB2YWxpZCByL3cgR1BVIGRvbWFpbiAqLwogCWlmICh1bmxpa2VseShyZWxvYy0+d3JpdGVf
ZG9tYWluICYgKHJlbG9jLT53cml0ZV9kb21haW4gLSAxKSkpIHsKIAkJZHJtX2RiZygmaTkxNS0+
ZHJtLCAicmVsb2Mgd2l0aCBtdWx0aXBsZSB3cml0ZSBkb21haW5zOiAiCkBAIC0xNTAwLDkgKzIy
MDQsNyBAQCBlYl9yZWxvY2F0ZV9lbnRyeShzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYiwKIAkJ
ICovCiAJCWlmIChyZWxvYy0+d3JpdGVfZG9tYWluID09IEk5MTVfR0VNX0RPTUFJTl9JTlNUUlVD
VElPTiAmJgogCQkgICAgSVNfR0VOKGViLT5pOTE1LCA2KSkgewotCQkJZXJyID0gaTkxNV92bWFf
YmluZCh0YXJnZXQtPnZtYSwKLQkJCQkJICAgIHRhcmdldC0+dm1hLT5vYmotPmNhY2hlX2xldmVs
LAotCQkJCQkgICAgUElOX0dMT0JBTCwgTlVMTCk7CisJCQllcnIgPSBnZW42X2ZpeHVwX2dndHQo
dGFyZ2V0LT52bWEpOwogCQkJaWYgKGVycikKIAkJCQlyZXR1cm4gZXJyOwogCQl9CkBAIC0xNjcy
LDYgKzIzNzQsOCBAQCBzdGF0aWMgaW50IGViX21vdmVfdG9fZ3B1KHN0cnVjdCBpOTE1X2V4ZWNi
dWZmZXIgKmViKQogCQlzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqID0gdm1hLT5vYmo7
CiAKIAkJYXNzZXJ0X3ZtYV9oZWxkKHZtYSk7CisJCUdFTV9CVUdfT04oIShmbGFncyAmIF9fRVhF
Q19PQkpFQ1RfSEFTX1BJTikpOworCQlHRU1fQlVHX09OKCFpOTE1X3ZtYV9pc19ib3VuZCh2bWEs
IEk5MTVfVk1BX0xPQ0FMX0JJTkQpKTsKIAogCQlpZiAoZmxhZ3MgJiBFWEVDX09CSkVDVF9DQVBU
VVJFKSB7CiAJCQlzdHJ1Y3QgaTkxNV9jYXB0dXJlX2xpc3QgKmNhcHR1cmU7CkBAIC0xNzEwLDcg
KzI0MTQsNiBAQCBzdGF0aWMgaW50IGViX21vdmVfdG9fZ3B1KHN0cnVjdCBpOTE1X2V4ZWNidWZm
ZXIgKmViKQogCQkJZXJyID0gaTkxNV92bWFfbW92ZV90b19hY3RpdmUodm1hLCBlYi0+cmVxdWVz
dCwgZmxhZ3MpOwogCiAJCWk5MTVfdm1hX3VubG9jayh2bWEpOwotCQllYl91bnJlc2VydmVfdm1h
KGV2KTsKIAl9CiAJd3dfYWNxdWlyZV9maW5pKCZhY3F1aXJlKTsKIApAQCAtMjgyNiw3ICszNTI5
LDcgQEAgaTkxNV9nZW1fZG9fZXhlY2J1ZmZlcihzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LAogCSAq
IHNuYi9pdmIvdmx2IGNvbmZsYXRlIHRoZSAiYmF0Y2ggaW4gcHBndHQiIGJpdCB3aXRoIHRoZSAi
bm9uLXNlY3VyZQogCSAqIGJhdGNoIiBiaXQuIEhlbmNlIHdlIG5lZWQgdG8gcGluIHNlY3VyZSBi
YXRjaGVzIGludG8gdGhlIGdsb2JhbCBndHQuCiAJICogaHN3IHNob3VsZCBoYXZlIHRoaXMgZml4
ZWQsIGJ1dCBiZHcgbXVja3MgaXQgdXAgYWdhaW4uICovCi0JYmF0Y2ggPSBlYi5iYXRjaC0+dm1h
OworCWJhdGNoID0gaTkxNV92bWFfZ2V0KGViLmJhdGNoLT52bWEpOwogCWlmIChlYi5iYXRjaF9m
bGFncyAmIEk5MTVfRElTUEFUQ0hfU0VDVVJFKSB7CiAJCXN0cnVjdCBpOTE1X3ZtYSAqdm1hOwog
CkBAIC0yODQ2LDYgKzM1NDksNyBAQCBpOTE1X2dlbV9kb19leGVjYnVmZmVyKHN0cnVjdCBkcm1f
ZGV2aWNlICpkZXYsCiAJCQlnb3RvIGVycl9wYXJzZTsKIAkJfQogCisJCUdFTV9CVUdfT04odm1h
LT5vYmogIT0gYmF0Y2gtPm9iaik7CiAJCWJhdGNoID0gdm1hOwogCX0KIApAQCAtMjkxNCw2ICsz
NjE4LDcgQEAgaTkxNV9nZW1fZG9fZXhlY2J1ZmZlcihzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LAog
ZXJyX3BhcnNlOgogCWlmIChiYXRjaC0+cHJpdmF0ZSkKIAkJaW50ZWxfZ3RfYnVmZmVyX3Bvb2xf
cHV0KGJhdGNoLT5wcml2YXRlKTsKKwlpOTE1X3ZtYV9wdXQoYmF0Y2gpOwogZXJyX3ZtYToKIAlp
ZiAoZWIudHJhbXBvbGluZSkKIAkJaTkxNV92bWFfdW5waW4oZWIudHJhbXBvbGluZSk7CmRpZmYg
LS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9nZW42X3BwZ3R0LmMgYi9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9ndC9nZW42X3BwZ3R0LmMKaW5kZXggN2U1YTg2Yjc3NGE3Li4xYjRmYTljZTY2
NTggMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2dlbjZfcHBndHQuYworKysg
Yi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9nZW42X3BwZ3R0LmMKQEAgLTM2Miw2ICszNjIsNyBA
QCBzdGF0aWMgc3RydWN0IGk5MTVfdm1hICpwZF92bWFfY3JlYXRlKHN0cnVjdCBnZW42X3BwZ3R0
ICpwcGd0dCwgaW50IHNpemUpCiAJYXRvbWljX3NldCgmdm1hLT5mbGFncywgSTkxNV9WTUFfR0dU
VCk7CiAJdm1hLT5nZ3R0X3ZpZXcudHlwZSA9IEk5MTVfR0dUVF9WSUVXX1JPVEFURUQ7IC8qIHBy
ZXZlbnQgZmVuY2luZyAqLwogCisJSU5JVF9MSVNUX0hFQUQoJnZtYS0+dm1fbGluayk7CiAJSU5J
VF9MSVNUX0hFQUQoJnZtYS0+b2JqX2xpbmspOwogCUlOSVRfTElTVF9IRUFEKCZ2bWEtPmNsb3Nl
ZF9saW5rKTsKIApkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZ3R0
LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9ndHQuYwppbmRleCAzZjExMTRiNThi
MDEuLjFlNTQxYmM5NDJhMCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50
ZWxfZ3R0LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZ3R0LmMKQEAgLTU4
LDYgKzU4LDggQEAgdm9pZCBfX2k5MTVfdm1fY2xvc2Uoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFj
ZSAqdm0pCiAKIHZvaWQgaTkxNV9hZGRyZXNzX3NwYWNlX2Zpbmkoc3RydWN0IGk5MTVfYWRkcmVz
c19zcGFjZSAqdm0pCiB7CisJaTkxNV9hY3RpdmVfZmluaSgmdm0tPmJpbmRpbmcpOworCiAJZHJt
X21tX3Rha2Vkb3duKCZ2bS0+bW0pOwogCW11dGV4X2Rlc3Ryb3koJnZtLT5tdXRleCk7CiB9CkBA
IC0xMDMsNiArMTA1LDggQEAgdm9pZCBpOTE1X2FkZHJlc3Nfc3BhY2VfaW5pdChzdHJ1Y3QgaTkx
NV9hZGRyZXNzX3NwYWNlICp2bSwgaW50IHN1YmNsYXNzKQogCWRybV9tbV9pbml0KCZ2bS0+bW0s
IDAsIHZtLT50b3RhbCk7CiAJdm0tPm1tLmhlYWRfbm9kZS5jb2xvciA9IEk5MTVfQ09MT1JfVU5F
VklDVEFCTEU7CiAKKwlpOTE1X2FjdGl2ZV9pbml0KCZ2bS0+YmluZGluZywgTlVMTCwgTlVMTCk7
CisKIAlJTklUX0xJU1RfSEVBRCgmdm0tPmJvdW5kX2xpc3QpOwogfQogCmRpZmYgLS1naXQgYS9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9ndHQuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2d0L2ludGVsX2d0dC5oCmluZGV4IGMxM2M2NTBjZWQyMi4uN2U5NTZkZDFhOTY5IDEwMDY0NAot
LS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9ndHQuaAorKysgYi9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9ndC9pbnRlbF9ndHQuaApAQCAtMjQ3LDYgKzI0Nyw4IEBAIHN0cnVjdCBpOTE1
X2FkZHJlc3Nfc3BhY2UgewogCSAqLwogCXN0cnVjdCBsaXN0X2hlYWQgYm91bmRfbGlzdDsKIAor
CXN0cnVjdCBpOTE1X2FjdGl2ZSBiaW5kaW5nOworCiAJLyogR2xvYmFsIEdUVCAqLwogCWJvb2wg
aXNfZ2d0dDoxOwogCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbS5j
IGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW0uYwppbmRleCBlMWRlNTA3ODBlZDUuLjA0
MjBhNDlmODc2YyAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW0uYwor
KysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbS5jCkBAIC05OTcsNiArOTk3LDkgQEAg
aTkxNV9nZW1fb2JqZWN0X2dndHRfcGluKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmos
CiAJCXJldHVybiB2bWE7CiAKIAlpZiAoaTkxNV92bWFfbWlzcGxhY2VkKHZtYSwgc2l6ZSwgYWxp
Z25tZW50LCBmbGFncykpIHsKKwkJaWYgKGZsYWdzICYgUElOX05PRVZJQ1QpCisJCQlyZXR1cm4g
RVJSX1BUUigtRU5PU1BDKTsKKwogCQlpZiAoZmxhZ3MgJiBQSU5fTk9OQkxPQ0spIHsKIAkJCWlm
IChpOTE1X3ZtYV9pc19waW5uZWQodm1hKSB8fCBpOTE1X3ZtYV9pc19hY3RpdmUodm1hKSkKIAkJ
CQlyZXR1cm4gRVJSX1BUUigtRU5PU1BDKTsKQEAgLTEwMTYsNiArMTAxOSwxMCBAQCBpOTE1X2dl
bV9vYmplY3RfZ2d0dF9waW4oc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiwKIAkJCXJl
dHVybiBFUlJfUFRSKHJldCk7CiAJfQogCisJaWYgKGZsYWdzICYgUElOX05PTkJMT0NLICYmCisJ
ICAgIGk5MTVfYWN0aXZlX2ZlbmNlX2lzc2V0KCZ2bWEtPmFjdGl2ZS5leGNsKSkKKwkJcmV0dXJu
IEVSUl9QVFIoLUVBR0FJTik7CisKIAlyZXQgPSBpOTE1X3ZtYV9waW4odm1hLCBzaXplLCBhbGln
bm1lbnQsIGZsYWdzIHwgUElOX0dMT0JBTCk7CiAJaWYgKHJldCkKIAkJcmV0dXJuIEVSUl9QVFIo
cmV0KTsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtX2d0dC5jIGIv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW1fZ3R0LmMKaW5kZXggYzVlZTE1NjdmM2QxLi4z
NTZjNDkyYjgwZTAgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtX2d0
dC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtX2d0dC5jCkBAIC0yMjEsNiAr
MjIxLDggQEAgaW50IGk5MTVfZ2VtX2d0dF9pbnNlcnQoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFj
ZSAqdm0sCiAJCW1vZGUgPSBEUk1fTU1fSU5TRVJUX0hJR0hFU1Q7CiAJaWYgKGZsYWdzICYgUElO
X01BUFBBQkxFKQogCQltb2RlID0gRFJNX01NX0lOU0VSVF9MT1c7CisJaWYgKGZsYWdzICYgUElO
X05PU0VBUkNIKQorCQltb2RlIHw9IERSTV9NTV9JTlNFUlRfT05DRTsKIAogCS8qIFdlIG9ubHkg
YWxsb2NhdGUgaW4gUEFHRV9TSVpFL0dUVF9QQUdFX1NJWkUgKDQwOTYpIGNodW5rcywKIAkgKiBz
byB3ZSBrbm93IHRoYXQgd2UgYWx3YXlzIGhhdmUgYSBtaW5pbXVtIGFsaWdubWVudCBvZiA0MDk2
LgpAQCAtMjM4LDYgKzI0MCw5IEBAIGludCBpOTE1X2dlbV9ndHRfaW5zZXJ0KHN0cnVjdCBpOTE1
X2FkZHJlc3Nfc3BhY2UgKnZtLAogCWlmIChlcnIgIT0gLUVOT1NQQykKIAkJcmV0dXJuIGVycjsK
IAorCWlmIChmbGFncyAmIFBJTl9OT1NFQVJDSCkKKwkJcmV0dXJuIC1FTk9TUEM7CisKIAlpZiAo
bW9kZSAmIERSTV9NTV9JTlNFUlRfT05DRSkgewogCQllcnIgPSBkcm1fbW1faW5zZXJ0X25vZGVf
aW5fcmFuZ2UoJnZtLT5tbSwgbm9kZSwKIAkJCQkJCSAgc2l6ZSwgYWxpZ25tZW50LCBjb2xvciwK
ZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfdm1hLmMgYi9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9pOTE1X3ZtYS5jCmluZGV4IDE3Y2UwYmNlMzE4ZS4uODk5ZDgzYjU2N2U3IDEw
MDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3ZtYS5jCisrKyBiL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2k5MTVfdm1hLmMKQEAgLTEzMyw2ICsxMzMsNyBAQCB2bWFfY3JlYXRlKHN0
cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmosCiAJCWZzX3JlY2xhaW1fcmVsZWFzZShHRlBf
S0VSTkVMKTsKIAl9CiAKKwlJTklUX0xJU1RfSEVBRCgmdm1hLT52bV9saW5rKTsKIAlJTklUX0xJ
U1RfSEVBRCgmdm1hLT5jbG9zZWRfbGluayk7CiAKIAlpZiAodmlldyAmJiB2aWV3LT50eXBlICE9
IEk5MTVfR0dUVF9WSUVXX05PUk1BTCkgewpAQCAtMzQxLDI1ICszNDIsMzcgQEAgc3RydWN0IGk5
MTVfdm1hX3dvcmsgKmk5MTVfdm1hX3dvcmsodm9pZCkKIAlyZXR1cm4gdnc7CiB9CiAKLWludCBp
OTE1X3ZtYV93YWl0X2Zvcl9iaW5kKHN0cnVjdCBpOTE1X3ZtYSAqdm1hKQorc3RhdGljIGludAor
X19pOTE1X3ZtYV93YWl0X2V4Y2woc3RydWN0IGk5MTVfdm1hICp2bWEsIGJvb2wgYm91bmQsIHVu
c2lnbmVkIGludCBmbGFncykKIHsKKwlzdHJ1Y3QgZG1hX2ZlbmNlICpmZW5jZTsKIAlpbnQgZXJy
ID0gMDsKIAotCWlmIChyY3VfYWNjZXNzX3BvaW50ZXIodm1hLT5hY3RpdmUuZXhjbC5mZW5jZSkp
IHsKLQkJc3RydWN0IGRtYV9mZW5jZSAqZmVuY2U7CisJZmVuY2UgPSBpOTE1X2FjdGl2ZV9mZW5j
ZV9nZXQoJnZtYS0+YWN0aXZlLmV4Y2wpOworCWlmICghZmVuY2UpCisJCXJldHVybiAwOwogCi0J
CXJjdV9yZWFkX2xvY2soKTsKLQkJZmVuY2UgPSBkbWFfZmVuY2VfZ2V0X3JjdV9zYWZlKCZ2bWEt
PmFjdGl2ZS5leGNsLmZlbmNlKTsKLQkJcmN1X3JlYWRfdW5sb2NrKCk7Ci0JCWlmIChmZW5jZSkg
ewotCQkJZXJyID0gZG1hX2ZlbmNlX3dhaXQoZmVuY2UsIE1BWF9TQ0hFRFVMRV9USU1FT1VUKTsK
LQkJCWRtYV9mZW5jZV9wdXQoZmVuY2UpOwotCQl9CisJaWYgKGRybV9tbV9ub2RlX2FsbG9jYXRl
ZCgmdm1hLT5ub2RlKSA9PSBib3VuZCkgeworCQlpZiAoZmxhZ3MgJiBQSU5fTk9FVklDVCkKKwkJ
CWVyciA9IC1FQlVTWTsKKwkJZWxzZQorCQkJZXJyID0gZG1hX2ZlbmNlX3dhaXQoZmVuY2UsIHRy
dWUpOwogCX0KIAorCWRtYV9mZW5jZV9wdXQoZmVuY2UpOwogCXJldHVybiBlcnI7CiB9CiAKK2lu
dCBpOTE1X3ZtYV93YWl0X2Zvcl9iaW5kKHN0cnVjdCBpOTE1X3ZtYSAqdm1hKQoreworCXJldHVy
biBfX2k5MTVfdm1hX3dhaXRfZXhjbCh2bWEsIHRydWUsIDApOworfQorCitpbnQgaTkxNV92bWFf
d2FpdF9mb3JfdW5iaW5kKHN0cnVjdCBpOTE1X3ZtYSAqdm1hKQoreworCXJldHVybiBfX2k5MTVf
dm1hX3dhaXRfZXhjbCh2bWEsIGZhbHNlLCAwKTsKK30KKwogLyoqCiAgKiBpOTE1X3ZtYV9iaW5k
IC0gU2V0cyB1cCBQVEVzIGZvciBhbiBWTUEgaW4gaXQncyBjb3JyZXNwb25kaW5nIGFkZHJlc3Mg
c3BhY2UuCiAgKiBAdm1hOiBWTUEgdG8gbWFwCkBAIC02MjQsOCArNjM3LDkgQEAgaTkxNV92bWFf
aW5zZXJ0KHN0cnVjdCBpOTE1X3ZtYSAqdm1hLCB1NjQgc2l6ZSwgdTY0IGFsaWdubWVudCwgdTY0
IGZsYWdzKQogCXU2NCBzdGFydCwgZW5kOwogCWludCByZXQ7CiAKLQlHRU1fQlVHX09OKGk5MTVf
dm1hX2lzX2JvdW5kKHZtYSwgSTkxNV9WTUFfR0xPQkFMX0JJTkQgfCBJOTE1X1ZNQV9MT0NBTF9C
SU5EKSk7CisJR0VNX0JVR19PTihpOTE1X3ZtYV9pc19ib3VuZCh2bWEsIEk5MTVfVk1BX0JJTkRf
TUFTSykpOwogCUdFTV9CVUdfT04oZHJtX21tX25vZGVfYWxsb2NhdGVkKCZ2bWEtPm5vZGUpKTsK
KwlHRU1fQlVHX09OKGk5MTVfYWN0aXZlX2ZlbmNlX2lzc2V0KCZ2bWEtPmFjdGl2ZS5leGNsKSk7
CiAKIAlzaXplID0gbWF4KHNpemUsIHZtYS0+c2l6ZSk7CiAJYWxpZ25tZW50ID0gbWF4KGFsaWdu
bWVudCwgdm1hLT5kaXNwbGF5X2FsaWdubWVudCk7CkBAIC03MjEsNyArNzM1LDcgQEAgaTkxNV92
bWFfaW5zZXJ0KHN0cnVjdCBpOTE1X3ZtYSAqdm1hLCB1NjQgc2l6ZSwgdTY0IGFsaWdubWVudCwg
dTY0IGZsYWdzKQogCUdFTV9CVUdfT04oIWRybV9tbV9ub2RlX2FsbG9jYXRlZCgmdm1hLT5ub2Rl
KSk7CiAJR0VNX0JVR19PTighaTkxNV9nZW1fdmFsaWRfZ3R0X3NwYWNlKHZtYSwgY29sb3IpKTsK
IAotCWxpc3RfYWRkX3RhaWwoJnZtYS0+dm1fbGluaywgJnZtYS0+dm0tPmJvdW5kX2xpc3QpOwor
CWxpc3RfbW92ZV90YWlsKCZ2bWEtPnZtX2xpbmssICZ2bWEtPnZtLT5ib3VuZF9saXN0KTsKIAog
CXJldHVybiAwOwogfQpAQCAtNzI5LDE1ICs3NDMsMTIgQEAgaTkxNV92bWFfaW5zZXJ0KHN0cnVj
dCBpOTE1X3ZtYSAqdm1hLCB1NjQgc2l6ZSwgdTY0IGFsaWdubWVudCwgdTY0IGZsYWdzKQogc3Rh
dGljIHZvaWQKIGk5MTVfdm1hX2RldGFjaChzdHJ1Y3QgaTkxNV92bWEgKnZtYSkKIHsKLQlHRU1f
QlVHX09OKCFkcm1fbW1fbm9kZV9hbGxvY2F0ZWQoJnZtYS0+bm9kZSkpOwotCUdFTV9CVUdfT04o
aTkxNV92bWFfaXNfYm91bmQodm1hLCBJOTE1X1ZNQV9HTE9CQUxfQklORCB8IEk5MTVfVk1BX0xP
Q0FMX0JJTkQpKTsKLQogCS8qCiAJICogQW5kIGZpbmFsbHkgbm93IHRoZSBvYmplY3QgaXMgY29t
cGxldGVseSBkZWNvdXBsZWQgZnJvbSB0aGlzCiAJICogdm1hLCB3ZSBjYW4gZHJvcCBpdHMgaG9s
ZCBvbiB0aGUgYmFja2luZyBzdG9yYWdlIGFuZCBhbGxvdwogCSAqIGl0IHRvIGJlIHJlYXBlZCBi
eSB0aGUgc2hyaW5rZXIuCiAJICovCi0JbGlzdF9kZWwoJnZtYS0+dm1fbGluayk7CisJbGlzdF9k
ZWxfaW5pdCgmdm1hLT52bV9saW5rKTsKIH0KIAogYm9vbCBpOTE1X3ZtYV9waW5faW5wbGFjZShz
dHJ1Y3QgaTkxNV92bWEgKnZtYSwgdW5zaWduZWQgaW50IGZsYWdzKQpAQCAtNzU5LDcgKzc3MCw3
IEBAIGJvb2wgaTkxNV92bWFfcGluX2lucGxhY2Uoc3RydWN0IGk5MTVfdm1hICp2bWEsIHVuc2ln
bmVkIGludCBmbGFncykKIAlyZXR1cm4gdHJ1ZTsKIH0KIAotc3RhdGljIGludCB2bWFfZ2V0X3Bh
Z2VzKHN0cnVjdCBpOTE1X3ZtYSAqdm1hKQoraW50IGk5MTVfdm1hX2dldF9wYWdlcyhzdHJ1Y3Qg
aTkxNV92bWEgKnZtYSkKIHsKIAlpbnQgZXJyID0gMDsKIApAQCAtODA2LDcgKzgxNyw3IEBAIHN0
YXRpYyB2b2lkIF9fdm1hX3B1dF9wYWdlcyhzdHJ1Y3QgaTkxNV92bWEgKnZtYSwgdW5zaWduZWQg
aW50IGNvdW50KQogCW11dGV4X3VubG9jaygmdm1hLT5wYWdlc19tdXRleCk7CiB9CiAKLXN0YXRp
YyB2b2lkIHZtYV9wdXRfcGFnZXMoc3RydWN0IGk5MTVfdm1hICp2bWEpCit2b2lkIGk5MTVfdm1h
X3B1dF9wYWdlcyhzdHJ1Y3QgaTkxNV92bWEgKnZtYSkKIHsKIAlpZiAoYXRvbWljX2FkZF91bmxl
c3MoJnZtYS0+cGFnZXNfY291bnQsIC0xLCAxKSkKIAkJcmV0dXJuOwpAQCAtODIzLDkgKzgzNCwx
MyBAQCBzdGF0aWMgdm9pZCB2bWFfdW5iaW5kX3BhZ2VzKHN0cnVjdCBpOTE1X3ZtYSAqdm1hKQog
CS8qIFRoZSB1cHBlciBwb3J0aW9uIG9mIHBhZ2VzX2NvdW50IGlzIHRoZSBudW1iZXIgb2YgYmlu
ZGluZ3MgKi8KIAljb3VudCA9IGF0b21pY19yZWFkKCZ2bWEtPnBhZ2VzX2NvdW50KTsKIAljb3Vu
dCA+Pj0gSTkxNV9WTUFfUEFHRVNfQklBUzsKLQlHRU1fQlVHX09OKCFjb3VudCk7CisJaWYgKGNv
dW50KQorCQlfX3ZtYV9wdXRfcGFnZXModm1hLCBjb3VudCB8IGNvdW50IDw8IEk5MTVfVk1BX1BB
R0VTX0JJQVMpOworfQogCi0JX192bWFfcHV0X3BhZ2VzKHZtYSwgY291bnQgfCBjb3VudCA8PCBJ
OTE1X1ZNQV9QQUdFU19CSUFTKTsKK3N0YXRpYyBpbnQgX193YWl0X2Zvcl91bmJpbmQoc3RydWN0
IGk5MTVfdm1hICp2bWEsIHVuc2lnbmVkIGludCBmbGFncykKK3sKKwlyZXR1cm4gX19pOTE1X3Zt
YV93YWl0X2V4Y2wodm1hLCBmYWxzZSwgZmxhZ3MpOwogfQogCiBpbnQgaTkxNV92bWFfcGluKHN0
cnVjdCBpOTE1X3ZtYSAqdm1hLCB1NjQgc2l6ZSwgdTY0IGFsaWdubWVudCwgdTY0IGZsYWdzKQpA
QCAtODQ0LDEzICs4NTksMTcgQEAgaW50IGk5MTVfdm1hX3BpbihzdHJ1Y3QgaTkxNV92bWEgKnZt
YSwgdTY0IHNpemUsIHU2NCBhbGlnbm1lbnQsIHU2NCBmbGFncykKIAlpZiAoaTkxNV92bWFfcGlu
X2lucGxhY2Uodm1hLCBmbGFncyAmIEk5MTVfVk1BX0JJTkRfTUFTSykpCiAJCXJldHVybiAwOwog
Ci0JZXJyID0gdm1hX2dldF9wYWdlcyh2bWEpOworCWVyciA9IGk5MTVfdm1hX2dldF9wYWdlcyh2
bWEpOwogCWlmIChlcnIpCiAJCXJldHVybiBlcnI7CiAKIAlpZiAoZmxhZ3MgJiBQSU5fR0xPQkFM
KQogCQl3YWtlcmVmID0gaW50ZWxfcnVudGltZV9wbV9nZXQoJnZtYS0+dm0tPmk5MTUtPnJ1bnRp
bWVfcG0pOwogCisJZXJyID0gX193YWl0X2Zvcl91bmJpbmQodm1hLCBmbGFncyk7CisJaWYgKGVy
cikKKwkJZ290byBlcnJfcnBtOworCiAJaWYgKGZsYWdzICYgdm1hLT52bS0+YmluZF9hc3luY19m
bGFncykgewogCQl3b3JrID0gaTkxNV92bWFfd29yaygpOwogCQlpZiAoIXdvcmspIHsKQEAgLTky
Myw2ICs5NDIsMTAgQEAgaW50IGk5MTVfdm1hX3BpbihzdHJ1Y3QgaTkxNV92bWEgKnZtYSwgdTY0
IHNpemUsIHU2NCBhbGlnbm1lbnQsIHU2NCBmbGFncykKIAkJZ290byBlcnJfdW5sb2NrOwogCiAJ
aWYgKCEoYm91bmQgJiBJOTE1X1ZNQV9CSU5EX01BU0spKSB7CisJCWVyciA9IF9fd2FpdF9mb3Jf
dW5iaW5kKHZtYSwgZmxhZ3MpOworCQlpZiAoZXJyKQorCQkJZ290byBlcnJfYWN0aXZlOworCiAJ
CWVyciA9IGk5MTVfdm1hX2luc2VydCh2bWEsIHNpemUsIGFsaWdubWVudCwgZmxhZ3MpOwogCQlp
ZiAoZXJyKQogCQkJZ290byBlcnJfYWN0aXZlOwpAQCAtOTQyLDYgKzk2NSw3IEBAIGludCBpOTE1
X3ZtYV9waW4oc3RydWN0IGk5MTVfdm1hICp2bWEsIHU2NCBzaXplLCB1NjQgYWxpZ25tZW50LCB1
NjQgZmxhZ3MpCiAJR0VNX0JVR19PTihib3VuZCArIEk5MTVfVk1BX1BBR0VTX0FDVElWRSA8IGJv
dW5kKTsKIAlhdG9taWNfYWRkKEk5MTVfVk1BX1BBR0VTX0FDVElWRSwgJnZtYS0+cGFnZXNfY291
bnQpOwogCWxpc3RfbW92ZV90YWlsKCZ2bWEtPnZtX2xpbmssICZ2bWEtPnZtLT5ib3VuZF9saXN0
KTsKKwlHRU1fQlVHX09OKCFpOTE1X3ZtYV9pc19hY3RpdmUodm1hKSk7CiAKIAlfX2k5MTVfdm1h
X3Bpbih2bWEpOwogCUdFTV9CVUdfT04oIWk5MTVfdm1hX2lzX3Bpbm5lZCh2bWEpKTsKQEAgLTk2
Myw3ICs5ODcsNyBAQCBpbnQgaTkxNV92bWFfcGluKHN0cnVjdCBpOTE1X3ZtYSAqdm1hLCB1NjQg
c2l6ZSwgdTY0IGFsaWdubWVudCwgdTY0IGZsYWdzKQogZXJyX3JwbToKIAlpZiAod2FrZXJlZikK
IAkJaW50ZWxfcnVudGltZV9wbV9wdXQoJnZtYS0+dm0tPmk5MTUtPnJ1bnRpbWVfcG0sIHdha2Vy
ZWYpOwotCXZtYV9wdXRfcGFnZXModm1hKTsKKwlpOTE1X3ZtYV9wdXRfcGFnZXModm1hKTsKIAly
ZXR1cm4gZXJyOwogfQogCkBAIC0xMDY3LDYgKzEwOTEsNyBAQCB2b2lkIGk5MTVfdm1hX3JlbGVh
c2Uoc3RydWN0IGtyZWYgKnJlZikKIAkJR0VNX0JVR19PTihkcm1fbW1fbm9kZV9hbGxvY2F0ZWQo
JnZtYS0+bm9kZSkpOwogCX0KIAlHRU1fQlVHX09OKGk5MTVfdm1hX2lzX2FjdGl2ZSh2bWEpKTsK
KwlHRU1fQlVHX09OKCFsaXN0X2VtcHR5KCZ2bWEtPnZtX2xpbmspKTsKIAogCWlmICh2bWEtPm9i
aikgewogCQlzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqID0gdm1hLT5vYmo7CkBAIC0x
MTI2LDcgKzExNTEsNyBAQCBzdGF0aWMgdm9pZCBfX2k5MTVfdm1hX2lvdW5tYXAoc3RydWN0IGk5
MTVfdm1hICp2bWEpCiB7CiAJR0VNX0JVR19PTihpOTE1X3ZtYV9pc19waW5uZWQodm1hKSk7CiAK
LQlpZiAodm1hLT5pb21hcCA9PSBOVUxMKQorCWlmICghdm1hLT5pb21hcCkKIAkJcmV0dXJuOwog
CiAJaW9fbWFwcGluZ191bm1hcCh2bWEtPmlvbWFwKTsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L2k5MTVfdm1hLmggYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3ZtYS5oCmlu
ZGV4IDAzZmVhNTRmZDU3My4uOWEyNmU2Y2JlOGNkIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9pOTE1X3ZtYS5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfdm1hLmgK
QEAgLTIzNiw2ICsyMzYsOSBAQCBzdGF0aWMgaW5saW5lIHZvaWQgaTkxNV92bWFfdW5sb2NrKHN0
cnVjdCBpOTE1X3ZtYSAqdm1hKQogCWRtYV9yZXN2X3VubG9jayh2bWEtPnJlc3YpOwogfQogCitp
bnQgaTkxNV92bWFfZ2V0X3BhZ2VzKHN0cnVjdCBpOTE1X3ZtYSAqdm1hKTsKK3ZvaWQgaTkxNV92
bWFfcHV0X3BhZ2VzKHN0cnVjdCBpOTE1X3ZtYSAqdm1hKTsKKwogYm9vbCBpOTE1X3ZtYV9waW5f
aW5wbGFjZShzdHJ1Y3QgaTkxNV92bWEgKnZtYSwgdW5zaWduZWQgaW50IGZsYWdzKTsKIAogaW50
IF9fbXVzdF9jaGVjawpAQCAtMzc5LDYgKzM4Miw3IEBAIHZvaWQgaTkxNV92bWFfbWFrZV9zaHJp
bmthYmxlKHN0cnVjdCBpOTE1X3ZtYSAqdm1hKTsKIHZvaWQgaTkxNV92bWFfbWFrZV9wdXJnZWFi
bGUoc3RydWN0IGk5MTVfdm1hICp2bWEpOwogCiBpbnQgaTkxNV92bWFfd2FpdF9mb3JfYmluZChz
dHJ1Y3QgaTkxNV92bWEgKnZtYSk7CitpbnQgaTkxNV92bWFfd2FpdF9mb3JfdW5iaW5kKHN0cnVj
dCBpOTE1X3ZtYSAqdm1hKTsKIAogc3RhdGljIGlubGluZSBpbnQgaTkxNV92bWFfc3luYyhzdHJ1
Y3QgaTkxNV92bWEgKnZtYSkKIHsKLS0gCjIuMjAuMQoKX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhA
bGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxt
YW4vbGlzdGluZm8vaW50ZWwtZ2Z4Cg==

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 378C768527
	for <lists+intel-gfx@lfdr.de>; Mon, 15 Jul 2019 10:28:00 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 0B0BB89453;
	Mon, 15 Jul 2019 08:27:58 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 5980389453
 for <intel-gfx@lists.freedesktop.org>; Mon, 15 Jul 2019 08:27:54 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17303259-1500050 
 for multiple; Mon, 15 Jul 2019 09:09:54 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 15 Jul 2019 09:09:44 +0100
Message-Id: <20190715080946.15593-22-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.22.0
In-Reply-To: <20190715080946.15593-1-chris@chris-wilson.co.uk>
References: <20190715080946.15593-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 22/24] drm/i915: Move context management under
 GEM
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

S2VlcCB0cmFjayBvZiB0aGUgR0VNIGNvbnRleHRzIHVuZGVybmVhdGggaTkxNS0+Z2VtLmNvbnRl
eHRzIGFuZCBhc3NpZ24KdGhlbSB0aGVpciBvd24gbG9jayBmb3IgdGhlIHB1cnBvc2VzIG9mIGxp
c3QgbWFuYWdlbWVudC4KClNpZ25lZC1vZmYtYnk6IENocmlzIFdpbHNvbiA8Y2hyaXNAY2hyaXMt
d2lsc29uLmNvLnVrPgpDYzogVHZydGtvIFVyc3VsaW4gPHR2cnRrby51cnN1bGluQGludGVsLmNv
bT4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fY29udGV4dC5jICAgfCAx
MTYgKysrKysrKy0tLS0tLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1f
Y29udGV4dC5oICAgfCAgIDQgKy0KIC4uLi9ncHUvZHJtL2k5MTUvZ2VtL3NlbGZ0ZXN0cy9tb2Nr
X2NvbnRleHQuYyB8ICAgMiArLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kZWJ1Z2ZzLmMg
ICAgICAgICAgIHwgIDIwICstLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYuYyAgICAg
ICAgICAgICAgIHwgICAyIC0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZHJ2LmggICAgICAg
ICAgICAgICB8ICAyNCArKy0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbS5jICAgICAg
ICAgICAgICAgfCAgIDggKy0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcGVyZi5jICAgICAg
ICAgICAgICB8ICAgOCArLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9zeXNmcy5jICAgICAg
ICAgICAgIHwgIDM4ICsrKy0tLQogLi4uL2dwdS9kcm0vaTkxNS9zZWxmdGVzdHMvbW9ja19nZW1f
ZGV2aWNlLmMgIHwgICA0ICstCiAxMCBmaWxlcyBjaGFuZ2VkLCA5MiBpbnNlcnRpb25zKCspLCAx
MzQgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5
MTVfZ2VtX2NvbnRleHQuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jb250
ZXh0LmMKaW5kZXggMjY2OWUwMzg2NjFlLi4zZWUzNTJkMzg5YzggMTAwNjQ0Ci0tLSBhL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jb250ZXh0LmMKKysrIGIvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRleHQuYwpAQCAtMjE3LDkgKzIxNywxMiBAQCBzdGF0
aWMgc3RydWN0IGk5MTVfZ2VtX2VuZ2luZXMgKmRlZmF1bHRfZW5naW5lcyhzdHJ1Y3QgaTkxNV9n
ZW1fY29udGV4dCAqY3R4KQogCiBzdGF0aWMgdm9pZCBpOTE1X2dlbV9jb250ZXh0X2ZyZWUoc3Ry
dWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCkKIHsKLQlsb2NrZGVwX2Fzc2VydF9oZWxkKCZjdHgt
Pmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOwogCUdFTV9CVUdfT04oIWk5MTVfZ2VtX2NvbnRleHRf
aXNfY2xvc2VkKGN0eCkpOwogCisJbXV0ZXhfbG9jaygmY3R4LT5pOTE1LT5nZW0uY29udGV4dHMu
bXV0ZXgpOworCWxpc3RfZGVsKCZjdHgtPmxpbmspOworCW11dGV4X3VubG9jaygmY3R4LT5pOTE1
LT5nZW0uY29udGV4dHMubXV0ZXgpOworCiAJaWYgKGN0eC0+dm0pCiAJCWk5MTVfdm1fcHV0KGN0
eC0+dm0pOwogCkBAIC0yMzIsNTYgKzIzNSw0MCBAQCBzdGF0aWMgdm9pZCBpOTE1X2dlbV9jb250
ZXh0X2ZyZWUoc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCkKIAlrZnJlZShjdHgtPm5hbWUp
OwogCXB1dF9waWQoY3R4LT5waWQpOwogCi0JbGlzdF9kZWwoJmN0eC0+bGluayk7CiAJbXV0ZXhf
ZGVzdHJveSgmY3R4LT5tdXRleCk7CiAKIAlrZnJlZV9yY3UoY3R4LCByY3UpOwogfQogCi1zdGF0
aWMgdm9pZCBjb250ZXh0c19mcmVlKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQorc3Rh
dGljIHZvaWQgY29udGV4dHNfZnJlZV9hbGwoc3RydWN0IGxsaXN0X25vZGUgKmxpc3QpCiB7Ci0J
c3RydWN0IGxsaXN0X25vZGUgKmZyZWVkID0gbGxpc3RfZGVsX2FsbCgmaTkxNS0+Y29udGV4dHMu
ZnJlZV9saXN0KTsKIAlzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4LCAqY247CiAKLQlsb2Nr
ZGVwX2Fzc2VydF9oZWxkKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKLQotCWxsaXN0X2Zvcl9l
YWNoX2VudHJ5X3NhZmUoY3R4LCBjbiwgZnJlZWQsIGZyZWVfbGluaykKKwlsbGlzdF9mb3JfZWFj
aF9lbnRyeV9zYWZlKGN0eCwgY24sIGxpc3QsIGZyZWVfbGluaykKIAkJaTkxNV9nZW1fY29udGV4
dF9mcmVlKGN0eCk7CiB9CiAKLXN0YXRpYyB2b2lkIGNvbnRleHRzX2ZyZWVfZmlyc3Qoc3RydWN0
IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCitzdGF0aWMgdm9pZCBjb250ZXh0c19mbHVzaF9mcmVl
KHN0cnVjdCBpOTE1X2dlbV9jb250ZXh0cyAqZ2MpCiB7Ci0Jc3RydWN0IGk5MTVfZ2VtX2NvbnRl
eHQgKmN0eDsKLQlzdHJ1Y3QgbGxpc3Rfbm9kZSAqZnJlZWQ7Ci0KLQlsb2NrZGVwX2Fzc2VydF9o
ZWxkKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKLQotCWZyZWVkID0gbGxpc3RfZGVsX2ZpcnN0
KCZpOTE1LT5jb250ZXh0cy5mcmVlX2xpc3QpOwotCWlmICghZnJlZWQpCi0JCXJldHVybjsKLQot
CWN0eCA9IGNvbnRhaW5lcl9vZihmcmVlZCwgdHlwZW9mKCpjdHgpLCBmcmVlX2xpbmspOwotCWk5
MTVfZ2VtX2NvbnRleHRfZnJlZShjdHgpOworCWNvbnRleHRzX2ZyZWVfYWxsKGxsaXN0X2RlbF9h
bGwoJmdjLT5mcmVlX2xpc3QpKTsKIH0KIAogc3RhdGljIHZvaWQgY29udGV4dHNfZnJlZV93b3Jr
ZXIoc3RydWN0IHdvcmtfc3RydWN0ICp3b3JrKQogewotCXN0cnVjdCBkcm1faTkxNV9wcml2YXRl
ICppOTE1ID0KLQkJY29udGFpbmVyX29mKHdvcmssIHR5cGVvZigqaTkxNSksIGNvbnRleHRzLmZy
ZWVfd29yayk7CisJc3RydWN0IGk5MTVfZ2VtX2NvbnRleHRzICpnYyA9CisJCWNvbnRhaW5lcl9v
Zih3b3JrLCB0eXBlb2YoKmdjKSwgZnJlZV93b3JrKTsKIAotCW11dGV4X2xvY2soJmk5MTUtPmRy
bS5zdHJ1Y3RfbXV0ZXgpOwotCWNvbnRleHRzX2ZyZWUoaTkxNSk7Ci0JbXV0ZXhfdW5sb2NrKCZp
OTE1LT5kcm0uc3RydWN0X211dGV4KTsKKwljb250ZXh0c19mbHVzaF9mcmVlKGdjKTsKIH0KIAog
dm9pZCBpOTE1X2dlbV9jb250ZXh0X3JlbGVhc2Uoc3RydWN0IGtyZWYgKnJlZikKIHsKIAlzdHJ1
Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4ID0gY29udGFpbmVyX29mKHJlZiwgdHlwZW9mKCpjdHgp
LCByZWYpOwotCXN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1ID0gY3R4LT5pOTE1OworCXN0
cnVjdCBpOTE1X2dlbV9jb250ZXh0cyAqZ2MgPSAmY3R4LT5pOTE1LT5nZW0uY29udGV4dHM7CiAK
IAl0cmFjZV9pOTE1X2NvbnRleHRfZnJlZShjdHgpOwotCWlmIChsbGlzdF9hZGQoJmN0eC0+ZnJl
ZV9saW5rLCAmaTkxNS0+Y29udGV4dHMuZnJlZV9saXN0KSkKLQkJcXVldWVfd29yayhpOTE1LT53
cSwgJmk5MTUtPmNvbnRleHRzLmZyZWVfd29yayk7CisJaWYgKGxsaXN0X2FkZCgmY3R4LT5mcmVl
X2xpbmssICZnYy0+ZnJlZV9saXN0KSkKKwkJcXVldWVfd29yayhjdHgtPmk5MTUtPndxLCAmZ2Mt
PmZyZWVfd29yayk7CiB9CiAKIHN0YXRpYyB2b2lkIGNvbnRleHRfY2xvc2Uoc3RydWN0IGk5MTVf
Z2VtX2NvbnRleHQgKmN0eCkKQEAgLTMzOSw3ICszMjYsNiBAQCBfX2NyZWF0ZV9jb250ZXh0KHN0
cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQogCQlyZXR1cm4gRVJSX1BUUigtRU5PTUVNKTsK
IAogCWtyZWZfaW5pdCgmY3R4LT5yZWYpOwotCWxpc3RfYWRkX3RhaWwoJmN0eC0+bGluaywgJmk5
MTUtPmNvbnRleHRzLmxpc3QpOwogCWN0eC0+aTkxNSA9IGk5MTU7CiAJY3R4LT5zY2hlZC5wcmlv
cml0eSA9IEk5MTVfVVNFUl9QUklPUklUWShJOTE1X1BSSU9SSVRZX05PUk1BTCk7CiAJbXV0ZXhf
aW5pdCgmY3R4LT5tdXRleCk7CkBAIC0zNjksNiArMzU1LDEwIEBAIF9fY3JlYXRlX2NvbnRleHQo
c3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCiAJZm9yIChpID0gMDsgaSA8IEFSUkFZX1NJ
WkUoY3R4LT5oYW5nX3RpbWVzdGFtcCk7IGkrKykKIAkJY3R4LT5oYW5nX3RpbWVzdGFtcFtpXSA9
IGppZmZpZXMgLSBDT05URVhUX0ZBU1RfSEFOR19KSUZGSUVTOwogCisJbXV0ZXhfbG9jaygmaTkx
NS0+Z2VtLmNvbnRleHRzLm11dGV4KTsKKwlsaXN0X2FkZF90YWlsKCZjdHgtPmxpbmssICZpOTE1
LT5nZW0uY29udGV4dHMubGlzdCk7CisJbXV0ZXhfdW5sb2NrKCZpOTE1LT5nZW0uY29udGV4dHMu
bXV0ZXgpOworCiAJcmV0dXJuIGN0eDsKIAogZXJyX2ZyZWU6CkBAIC0zOTksMjcgKzM4OSwyNSBA
QCBzdGF0aWMgdm9pZCBfX2Fzc2lnbl9wcGd0dChzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4
LAogfQogCiBzdGF0aWMgc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKgotaTkxNV9nZW1fY3JlYXRl
X2NvbnRleHQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2LCB1bnNpZ25lZCBpbnQg
ZmxhZ3MpCitpOTE1X2dlbV9jcmVhdGVfY29udGV4dChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAq
aTkxNSwgdW5zaWduZWQgaW50IGZsYWdzKQogewogCXN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICpj
dHg7CiAKLQlsb2NrZGVwX2Fzc2VydF9oZWxkKCZkZXZfcHJpdi0+ZHJtLnN0cnVjdF9tdXRleCk7
Ci0KIAlpZiAoZmxhZ3MgJiBJOTE1X0NPTlRFWFRfQ1JFQVRFX0ZMQUdTX1NJTkdMRV9USU1FTElO
RSAmJgotCSAgICAhSEFTX0VYRUNMSVNUUyhkZXZfcHJpdikpCisJICAgICFIQVNfRVhFQ0xJU1RT
KGk5MTUpKQogCQlyZXR1cm4gRVJSX1BUUigtRUlOVkFMKTsKIAotCS8qIFJlYXAgdGhlIG1vc3Qg
c3RhbGUgY29udGV4dCAqLwotCWNvbnRleHRzX2ZyZWVfZmlyc3QoZGV2X3ByaXYpOworCS8qIFJl
YXAgdGhlIHN0YWxlIGNvbnRleHRzICovCisJY29udGV4dHNfZmx1c2hfZnJlZSgmaTkxNS0+Z2Vt
LmNvbnRleHRzKTsKIAotCWN0eCA9IF9fY3JlYXRlX2NvbnRleHQoZGV2X3ByaXYpOworCWN0eCA9
IF9fY3JlYXRlX2NvbnRleHQoaTkxNSk7CiAJaWYgKElTX0VSUihjdHgpKQogCQlyZXR1cm4gY3R4
OwogCi0JaWYgKEhBU19GVUxMX1BQR1RUKGRldl9wcml2KSkgeworCWlmIChIQVNfRlVMTF9QUEdU
VChpOTE1KSkgewogCQlzdHJ1Y3QgaTkxNV9wcGd0dCAqcHBndHQ7CiAKLQkJcHBndHQgPSBpOTE1
X3BwZ3R0X2NyZWF0ZShkZXZfcHJpdik7CisJCXBwZ3R0ID0gaTkxNV9wcGd0dF9jcmVhdGUoaTkx
NSk7CiAJCWlmIChJU19FUlIocHBndHQpKSB7CiAJCQlEUk1fREVCVUdfRFJJVkVSKCJQUEdUVCBz
ZXR1cCBmYWlsZWQgKCVsZClcbiIsCiAJCQkJCSBQVFJfRVJSKHBwZ3R0KSk7CkBAIC00MzQsNyAr
NDIyLDcgQEAgaTkxNV9nZW1fY3JlYXRlX2NvbnRleHQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUg
KmRldl9wcml2LCB1bnNpZ25lZCBpbnQgZmxhZ3MpCiAJaWYgKGZsYWdzICYgSTkxNV9DT05URVhU
X0NSRUFURV9GTEFHU19TSU5HTEVfVElNRUxJTkUpIHsKIAkJc3RydWN0IGludGVsX3RpbWVsaW5l
ICp0aW1lbGluZTsKIAotCQl0aW1lbGluZSA9IGludGVsX3RpbWVsaW5lX2NyZWF0ZSgmZGV2X3By
aXYtPmd0LCBOVUxMKTsKKwkJdGltZWxpbmUgPSBpbnRlbF90aW1lbGluZV9jcmVhdGUoJmk5MTUt
Pmd0LCBOVUxMKTsKIAkJaWYgKElTX0VSUih0aW1lbGluZSkpIHsKIAkJCWNvbnRleHRfY2xvc2Uo
Y3R4KTsKIAkJCXJldHVybiBFUlJfQ0FTVCh0aW1lbGluZSk7CkBAIC00NjIsMTggKzQ1MCwxMyBA
QCBzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqCiBpOTE1X2dlbV9jb250ZXh0X2NyZWF0ZV9ndnQo
c3RydWN0IGRybV9kZXZpY2UgKmRldikKIHsKIAlzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4
OwotCWludCByZXQ7CiAKIAlpZiAoIUlTX0VOQUJMRUQoQ09ORklHX0RSTV9JOTE1X0dWVCkpCiAJ
CXJldHVybiBFUlJfUFRSKC1FTk9ERVYpOwogCi0JcmV0ID0gaTkxNV9tdXRleF9sb2NrX2ludGVy
cnVwdGlibGUoZGV2KTsKLQlpZiAocmV0KQotCQlyZXR1cm4gRVJSX1BUUihyZXQpOwotCiAJY3R4
ID0gaTkxNV9nZW1fY3JlYXRlX2NvbnRleHQodG9faTkxNShkZXYpLCAwKTsKIAlpZiAoSVNfRVJS
KGN0eCkpCi0JCWdvdG8gb3V0OworCQlyZXR1cm4gY3R4OwogCiAJY3R4LT5maWxlX3ByaXYgPSBF
UlJfUFRSKC1FQkFERik7CiAJaTkxNV9nZW1fY29udGV4dF9zZXRfY2xvc2VkKGN0eCk7IC8qIG5v
dCB1c2VyIGFjY2Vzc2libGUgKi8KQEAgLTQ4Myw4ICs0NjYsNiBAQCBpOTE1X2dlbV9jb250ZXh0
X2NyZWF0ZV9ndnQoc3RydWN0IGRybV9kZXZpY2UgKmRldikKIAkJY3R4LT5yaW5nX3NpemUgPSA1
MTIgKiBQQUdFX1NJWkU7IC8qIE1heCByaW5nIGJ1ZmZlciBzaXplICovCiAKIAlHRU1fQlVHX09O
KGk5MTVfZ2VtX2NvbnRleHRfaXNfa2VybmVsKGN0eCkpOwotb3V0OgotCW11dGV4X3VubG9jaygm
ZGV2LT5zdHJ1Y3RfbXV0ZXgpOwogCXJldHVybiBjdHg7CiB9CiAKQEAgLTUxOSw0OCArNTAwLDQw
IEBAIGk5MTVfZ2VtX2NvbnRleHRfY3JlYXRlX2tlcm5lbChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0
ZSAqaTkxNSwgaW50IHByaW8pCiAJcmV0dXJuIGN0eDsKIH0KIAotc3RhdGljIHZvaWQgaW5pdF9j
b250ZXh0cyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKK3N0YXRpYyB2b2lkIGluaXRf
Y29udGV4dHMoc3RydWN0IGk5MTVfZ2VtX2NvbnRleHRzICpnYykKIHsKLQltdXRleF9pbml0KCZp
OTE1LT5jb250ZXh0cy5tdXRleCk7Ci0JSU5JVF9MSVNUX0hFQUQoJmk5MTUtPmNvbnRleHRzLmxp
c3QpOwotCi0JLyogVXNpbmcgdGhlIHNpbXBsZSBpZGEgaW50ZXJmYWNlLCB0aGUgbWF4IGlzIGxp
bWl0ZWQgYnkgc2l6ZW9mKGludCkgKi8KLQlCVUlMRF9CVUdfT04oTUFYX0NPTlRFWFRfSFdfSUQg
PiBJTlRfTUFYKTsKLQlCVUlMRF9CVUdfT04oR0VOMTFfTUFYX0NPTlRFWFRfSFdfSUQgPiBJTlRf
TUFYKTsKLQlpZGFfaW5pdCgmaTkxNS0+Y29udGV4dHMuaHdfaWRhKTsKLQlJTklUX0xJU1RfSEVB
RCgmaTkxNS0+Y29udGV4dHMuaHdfaWRfbGlzdCk7CisJbXV0ZXhfaW5pdCgmZ2MtPm11dGV4KTsK
KwlJTklUX0xJU1RfSEVBRCgmZ2MtPmxpc3QpOwogCi0JSU5JVF9XT1JLKCZpOTE1LT5jb250ZXh0
cy5mcmVlX3dvcmssIGNvbnRleHRzX2ZyZWVfd29ya2VyKTsKLQlpbml0X2xsaXN0X2hlYWQoJmk5
MTUtPmNvbnRleHRzLmZyZWVfbGlzdCk7CisJSU5JVF9XT1JLKCZnYy0+ZnJlZV93b3JrLCBjb250
ZXh0c19mcmVlX3dvcmtlcik7CisJaW5pdF9sbGlzdF9oZWFkKCZnYy0+ZnJlZV9saXN0KTsKIH0K
IAotaW50IGk5MTVfZ2VtX2NvbnRleHRzX2luaXQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRl
dl9wcml2KQoraW50IGk5MTVfZ2VtX2luaXRfY29udGV4dHMoc3RydWN0IGRybV9pOTE1X3ByaXZh
dGUgKmk5MTUpCiB7CiAJc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eDsKIAogCS8qIFJlYXNz
dXJlIG91cnNlbHZlcyB3ZSBhcmUgb25seSBjYWxsZWQgb25jZSAqLwotCUdFTV9CVUdfT04oZGV2
X3ByaXYtPmtlcm5lbF9jb250ZXh0KTsKKwlHRU1fQlVHX09OKGk5MTUtPmtlcm5lbF9jb250ZXh0
KTsKIAotCWluaXRfY29udGV4dHMoZGV2X3ByaXYpOworCWluaXRfY29udGV4dHMoJmk5MTUtPmdl
bS5jb250ZXh0cyk7CiAKIAkvKiBsb3dlc3QgcHJpb3JpdHk7IGlkbGUgdGFzayAqLwotCWN0eCA9
IGk5MTVfZ2VtX2NvbnRleHRfY3JlYXRlX2tlcm5lbChkZXZfcHJpdiwgSTkxNV9QUklPUklUWV9N
SU4pOworCWN0eCA9IGk5MTVfZ2VtX2NvbnRleHRfY3JlYXRlX2tlcm5lbChpOTE1LCBJOTE1X1BS
SU9SSVRZX01JTik7CiAJaWYgKElTX0VSUihjdHgpKSB7CiAJCURSTV9FUlJPUigiRmFpbGVkIHRv
IGNyZWF0ZSBkZWZhdWx0IGdsb2JhbCBjb250ZXh0XG4iKTsKIAkJcmV0dXJuIFBUUl9FUlIoY3R4
KTsKIAl9Ci0JZGV2X3ByaXYtPmtlcm5lbF9jb250ZXh0ID0gY3R4OworCWk5MTUtPmtlcm5lbF9j
b250ZXh0ID0gY3R4OwogCiAJRFJNX0RFQlVHX0RSSVZFUigiJXMgY29udGV4dCBzdXBwb3J0IGlu
aXRpYWxpemVkXG4iLAotCQkJIERSSVZFUl9DQVBTKGRldl9wcml2KS0+aGFzX2xvZ2ljYWxfY29u
dGV4dHMgPworCQkJIERSSVZFUl9DQVBTKGk5MTUpLT5oYXNfbG9naWNhbF9jb250ZXh0cyA/CiAJ
CQkgImxvZ2ljYWwiIDogImZha2UiKTsKIAlyZXR1cm4gMDsKIH0KIAotdm9pZCBpOTE1X2dlbV9j
b250ZXh0c19maW5pKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQordm9pZCBpOTE1X2dl
bV9maW5pX2NvbnRleHRzKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQogewotCWxvY2tk
ZXBfYXNzZXJ0X2hlbGQoJmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOwotCiAJZGVzdHJveV9rZXJu
ZWxfY29udGV4dCgmaTkxNS0+a2VybmVsX2NvbnRleHQpOwogfQogCkBAIC02MjAsOSArNTkzLDcg
QEAgaW50IGk5MTVfZ2VtX2NvbnRleHRfb3BlbihzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkx
NSwKIAlpZHJfaW5pdCgmZmlsZV9wcml2LT5jb250ZXh0X2lkcik7CiAJaWRyX2luaXRfYmFzZSgm
ZmlsZV9wcml2LT52bV9pZHIsIDEpOwogCi0JbXV0ZXhfbG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9t
dXRleCk7CiAJY3R4ID0gaTkxNV9nZW1fY3JlYXRlX2NvbnRleHQoaTkxNSwgMCk7Ci0JbXV0ZXhf
dW5sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKIAlpZiAoSVNfRVJSKGN0eCkpIHsKIAkJ
ZXJyID0gUFRSX0VSUihjdHgpOwogCQlnb3RvIGVycjsKQEAgLTIwMDQsMTIgKzE5NzUsNyBAQCBp
bnQgaTkxNV9nZW1fY29udGV4dF9jcmVhdGVfaW9jdGwoc3RydWN0IGRybV9kZXZpY2UgKmRldiwg
dm9pZCAqZGF0YSwKIAkJcmV0dXJuIC1FSU87CiAJfQogCi0JcmV0ID0gaTkxNV9tdXRleF9sb2Nr
X2ludGVycnVwdGlibGUoZGV2KTsKLQlpZiAocmV0KQotCQlyZXR1cm4gcmV0OwotCiAJZXh0X2Rh
dGEuY3R4ID0gaTkxNV9nZW1fY3JlYXRlX2NvbnRleHQoaTkxNSwgYXJncy0+ZmxhZ3MpOwotCW11
dGV4X3VubG9jaygmZGV2LT5zdHJ1Y3RfbXV0ZXgpOwogCWlmIChJU19FUlIoZXh0X2RhdGEuY3R4
KSkKIAkJcmV0dXJuIFBUUl9FUlIoZXh0X2RhdGEuY3R4KTsKIApAQCAtMjIwNyw3ICsyMTczLDcg
QEAgaW50IGk5MTVfZ2VtX2NvbnRleHRfc2V0cGFyYW1faW9jdGwoc3RydWN0IGRybV9kZXZpY2Ug
KmRldiwgdm9pZCAqZGF0YSwKIGludCBpOTE1X2dlbV9jb250ZXh0X3Jlc2V0X3N0YXRzX2lvY3Rs
KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsCiAJCQkJICAgICAgIHZvaWQgKmRhdGEsIHN0cnVjdCBk
cm1fZmlsZSAqZmlsZSkKIHsKLQlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYgPSB0
b19pOTE1KGRldik7CisJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUgPSB0b19pOTE1KGRl
dik7CiAJc3RydWN0IGRybV9pOTE1X3Jlc2V0X3N0YXRzICphcmdzID0gZGF0YTsKIAlzdHJ1Y3Qg
aTkxNV9nZW1fY29udGV4dCAqY3R4OwogCWludCByZXQ7CkBAIC0yMjI5LDcgKzIxOTUsNyBAQCBp
bnQgaTkxNV9nZW1fY29udGV4dF9yZXNldF9zdGF0c19pb2N0bChzdHJ1Y3QgZHJtX2RldmljZSAq
ZGV2LAogCSAqLwogCiAJaWYgKGNhcGFibGUoQ0FQX1NZU19BRE1JTikpCi0JCWFyZ3MtPnJlc2V0
X2NvdW50ID0gaTkxNV9yZXNldF9jb3VudCgmZGV2X3ByaXYtPmdwdV9lcnJvcik7CisJCWFyZ3Mt
PnJlc2V0X2NvdW50ID0gaTkxNV9yZXNldF9jb3VudCgmaTkxNS0+Z3B1X2Vycm9yKTsKIAllbHNl
CiAJCWFyZ3MtPnJlc2V0X2NvdW50ID0gMDsKIApkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJt
L2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRleHQuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9p
OTE1X2dlbV9jb250ZXh0LmgKaW5kZXggNmZiM2FkN2UwM2ZjLi43MzhjYTE4ZjA4NWIgMTAwNjQ0
Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jb250ZXh0LmgKKysrIGIv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2NvbnRleHQuaApAQCAtMTE4LDggKzEx
OCw4IEBAIHN0YXRpYyBpbmxpbmUgYm9vbCBpOTE1X2dlbV9jb250ZXh0X2lzX2tlcm5lbChzdHJ1
Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4KQogfQogCiAvKiBpOTE1X2dlbV9jb250ZXh0LmMgKi8K
LWludCBfX211c3RfY2hlY2sgaTkxNV9nZW1fY29udGV4dHNfaW5pdChzdHJ1Y3QgZHJtX2k5MTVf
cHJpdmF0ZSAqZGV2X3ByaXYpOwotdm9pZCBpOTE1X2dlbV9jb250ZXh0c19maW5pKHN0cnVjdCBk
cm1faTkxNV9wcml2YXRlICpkZXZfcHJpdik7CitpbnQgX19tdXN0X2NoZWNrIGk5MTVfZ2VtX2lu
aXRfY29udGV4dHMoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpOwordm9pZCBpOTE1X2dl
bV9maW5pX2NvbnRleHRzKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KTsKIAogaW50IGk5
MTVfZ2VtX2NvbnRleHRfb3BlbihzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSwKIAkJCSAg
c3RydWN0IGRybV9maWxlICpmaWxlKTsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2dlbS9zZWxmdGVzdHMvbW9ja19jb250ZXh0LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0v
c2VsZnRlc3RzL21vY2tfY29udGV4dC5jCmluZGV4IDAxMDRmMTZiMTMyNy4uZTM2YWY1YTVjZTQy
IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vc2VsZnRlc3RzL21vY2tfY29u
dGV4dC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMvbW9ja19jb250
ZXh0LmMKQEAgLTY1LDcgKzY1LDcgQEAgdm9pZCBtb2NrX2NvbnRleHRfY2xvc2Uoc3RydWN0IGk5
MTVfZ2VtX2NvbnRleHQgKmN0eCkKIAogdm9pZCBtb2NrX2luaXRfY29udGV4dHMoc3RydWN0IGRy
bV9pOTE1X3ByaXZhdGUgKmk5MTUpCiB7Ci0JaW5pdF9jb250ZXh0cyhpOTE1KTsKKwlpbml0X2Nv
bnRleHRzKCZpOTE1LT5nZW0uY29udGV4dHMpOwogfQogCiBzdHJ1Y3QgaTkxNV9nZW1fY29udGV4
dCAqCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2RlYnVnZnMuYyBiL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZGVidWdmcy5jCmluZGV4IGI3ZWM5ZjNjZGMyYy4uYmNm
NjE3YWMyYmMwIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2RlYnVnZnMu
YworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2RlYnVnZnMuYwpAQCAtMjQyLDggKzI0
Miw2IEBAIHN0YXRpYyBpbnQgcGVyX2ZpbGVfc3RhdHMoaW50IGlkLCB2b2lkICpwdHIsIHZvaWQg
KmRhdGEpCiAJc3RydWN0IGZpbGVfc3RhdHMgKnN0YXRzID0gZGF0YTsKIAlzdHJ1Y3QgaTkxNV92
bWEgKnZtYTsKIAotCWxvY2tkZXBfYXNzZXJ0X2hlbGQoJm9iai0+YmFzZS5kZXYtPnN0cnVjdF9t
dXRleCk7Ci0KIAlzdGF0cy0+Y291bnQrKzsKIAlzdGF0cy0+dG90YWwgKz0gb2JqLT5iYXNlLnNp
emU7CiAJaWYgKCFhdG9taWNfcmVhZCgmb2JqLT5iaW5kX2NvdW50KSkKQEAgLTI1MSw2ICsyNDks
NyBAQCBzdGF0aWMgaW50IHBlcl9maWxlX3N0YXRzKGludCBpZCwgdm9pZCAqcHRyLCB2b2lkICpk
YXRhKQogCWlmIChvYmotPmJhc2UubmFtZSB8fCBvYmotPmJhc2UuZG1hX2J1ZikKIAkJc3RhdHMt
PnNoYXJlZCArPSBvYmotPmJhc2Uuc2l6ZTsKIAorCXNwaW5fbG9jaygmb2JqLT52bWEubG9jayk7
CiAJbGlzdF9mb3JfZWFjaF9lbnRyeSh2bWEsICZvYmotPnZtYS5saXN0LCBvYmpfbGluaykgewog
CQlpZiAoIWRybV9tbV9ub2RlX2FsbG9jYXRlZCgmdm1hLT5ub2RlKSkKIAkJCWNvbnRpbnVlOwpA
QCAtMjcwLDYgKzI2OSw3IEBAIHN0YXRpYyBpbnQgcGVyX2ZpbGVfc3RhdHMoaW50IGlkLCB2b2lk
ICpwdHIsIHZvaWQgKmRhdGEpCiAJCWlmIChpOTE1X3ZtYV9pc19jbG9zZWQodm1hKSkKIAkJCXN0
YXRzLT5jbG9zZWQgKz0gdm1hLT5ub2RlLnNpemU7CiAJfQorCXNwaW5fdW5sb2NrKCZvYmotPnZt
YS5sb2NrKTsKIAogCXJldHVybiAwOwogfQpAQCAtMjk0LDcgKzI5NCw4IEBAIHN0YXRpYyB2b2lk
IHByaW50X2NvbnRleHRfc3RhdHMoc3RydWN0IHNlcV9maWxlICptLAogCXN0cnVjdCBmaWxlX3N0
YXRzIGtzdGF0cyA9IHt9OwogCXN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICpjdHg7CiAKLQlsaXN0
X2Zvcl9lYWNoX2VudHJ5KGN0eCwgJmk5MTUtPmNvbnRleHRzLmxpc3QsIGxpbmspIHsKKwlsb2Nr
ZGVwX2Fzc2VydF9oZWxkKCZpOTE1LT5nZW0uY29udGV4dHMubXV0ZXgpOworCWxpc3RfZm9yX2Vh
Y2hfZW50cnkoY3R4LCAmaTkxNS0+Z2VtLmNvbnRleHRzLmxpc3QsIGxpbmspIHsKIAkJc3RydWN0
IGk5MTVfZ2VtX2VuZ2luZXNfaXRlciBpdDsKIAkJc3RydWN0IGludGVsX2NvbnRleHQgKmNlOwog
CkBAIC0zNDIsMTIgKzM0MywxMiBAQCBzdGF0aWMgaW50IGk5MTVfZ2VtX29iamVjdF9pbmZvKHN0
cnVjdCBzZXFfZmlsZSAqbSwgdm9pZCAqZGF0YSkKIAogCXNlcV9wdXRjKG0sICdcbicpOwogCi0J
cmV0ID0gbXV0ZXhfbG9ja19pbnRlcnJ1cHRpYmxlKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsK
KwlyZXQgPSBtdXRleF9sb2NrX2ludGVycnVwdGlibGUoJmk5MTUtPmdlbS5jb250ZXh0cy5tdXRl
eCk7CiAJaWYgKHJldCkKIAkJcmV0dXJuIHJldDsKIAogCXByaW50X2NvbnRleHRfc3RhdHMobSwg
aTkxNSk7Ci0JbXV0ZXhfdW5sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKKwltdXRleF91
bmxvY2soJmk5MTUtPmdlbS5jb250ZXh0cy5tdXRleCk7CiAKIAlyZXR1cm4gMDsKIH0KQEAgLTE1
NjcsMTYgKzE1NjgsMTUgQEAgc3RhdGljIHZvaWQgZGVzY3JpYmVfY3R4X3Jpbmcoc3RydWN0IHNl
cV9maWxlICptLCBzdHJ1Y3QgaW50ZWxfcmluZyAqcmluZykKIAogc3RhdGljIGludCBpOTE1X2Nv
bnRleHRfc3RhdHVzKHN0cnVjdCBzZXFfZmlsZSAqbSwgdm9pZCAqdW51c2VkKQogewotCXN0cnVj
dCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiA9IG5vZGVfdG9faTkxNShtLT5wcml2YXRlKTsK
LQlzdHJ1Y3QgZHJtX2RldmljZSAqZGV2ID0gJmRldl9wcml2LT5kcm07CisJc3RydWN0IGRybV9p
OTE1X3ByaXZhdGUgKmk5MTUgPSBub2RlX3RvX2k5MTUobS0+cHJpdmF0ZSk7CiAJc3RydWN0IGk5
MTVfZ2VtX2NvbnRleHQgKmN0eDsKIAlpbnQgcmV0OwogCi0JcmV0ID0gbXV0ZXhfbG9ja19pbnRl
cnJ1cHRpYmxlKCZkZXYtPnN0cnVjdF9tdXRleCk7CisJcmV0ID0gbXV0ZXhfbG9ja19pbnRlcnJ1
cHRpYmxlKCZpOTE1LT5nZW0uY29udGV4dHMubXV0ZXgpOwogCWlmIChyZXQpCiAJCXJldHVybiBy
ZXQ7CiAKLQlsaXN0X2Zvcl9lYWNoX2VudHJ5KGN0eCwgJmRldl9wcml2LT5jb250ZXh0cy5saXN0
LCBsaW5rKSB7CisJbGlzdF9mb3JfZWFjaF9lbnRyeShjdHgsICZpOTE1LT5nZW0uY29udGV4dHMu
bGlzdCwgbGluaykgewogCQlzdHJ1Y3QgaTkxNV9nZW1fZW5naW5lc19pdGVyIGl0OwogCQlzdHJ1
Y3QgaW50ZWxfY29udGV4dCAqY2U7CiAKQEAgLTE2MTMsNyArMTYxMyw3IEBAIHN0YXRpYyBpbnQg
aTkxNV9jb250ZXh0X3N0YXR1cyhzdHJ1Y3Qgc2VxX2ZpbGUgKm0sIHZvaWQgKnVudXNlZCkKIAkJ
c2VxX3B1dGMobSwgJ1xuJyk7CiAJfQogCi0JbXV0ZXhfdW5sb2NrKCZkZXYtPnN0cnVjdF9tdXRl
eCk7CisJbXV0ZXhfdW5sb2NrKCZpOTE1LT5nZW0uY29udGV4dHMubXV0ZXgpOwogCiAJcmV0dXJu
IDA7CiB9CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2Rydi5jIGIvZHJp
dmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYuYwppbmRleCA3YzIwOTc0M2U0NzguLjAyNDQ0MjEy
NDFmZCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYuYworKysgYi9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2Rydi5jCkBAIC0yMDU2LDEwICsyMDU2LDggQEAgc3Rh
dGljIHZvaWQgaTkxNV9kcml2ZXJfcG9zdGNsb3NlKHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsIHN0
cnVjdCBkcm1fZmlsZSAqZmlsZSkKIHsKIAlzdHJ1Y3QgZHJtX2k5MTVfZmlsZV9wcml2YXRlICpm
aWxlX3ByaXYgPSBmaWxlLT5kcml2ZXJfcHJpdjsKIAotCW11dGV4X2xvY2soJmRldi0+c3RydWN0
X211dGV4KTsKIAlpOTE1X2dlbV9jb250ZXh0X2Nsb3NlKGZpbGUpOwogCWk5MTVfZ2VtX3JlbGVh
c2UoZGV2LCBmaWxlKTsKLQltdXRleF91bmxvY2soJmRldi0+c3RydWN0X211dGV4KTsKIAogCWtm
cmVlKGZpbGVfcHJpdik7CiB9CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1
X2Rydi5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYuaAppbmRleCA4ZmJlZGJiYjM5
ZGMuLmZiYWFhYTdjMTJhZCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9k
cnYuaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2Rydi5oCkBAIC0xNTY1LDIzICsx
NTY1LDYgQEAgc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgewogCXN0cnVjdCBtdXRleCBhdl9tdXRl
eDsKIAlpbnQgYXVkaW9fcG93ZXJfcmVmY291bnQ7CiAKLQlzdHJ1Y3QgewotCQlzdHJ1Y3QgbXV0
ZXggbXV0ZXg7Ci0JCXN0cnVjdCBsaXN0X2hlYWQgbGlzdDsKLQkJc3RydWN0IGxsaXN0X2hlYWQg
ZnJlZV9saXN0OwotCQlzdHJ1Y3Qgd29ya19zdHJ1Y3QgZnJlZV93b3JrOwotCi0JCS8qIFRoZSBo
dyB3YW50cyB0byBoYXZlIGEgc3RhYmxlIGNvbnRleHQgaWRlbnRpZmllciBmb3IgdGhlCi0JCSAq
IGxpZmV0aW1lIG9mIHRoZSBjb250ZXh0IChmb3IgT0EsIFBBU0lELCBmYXVsdHMsIGV0YykuCi0J
CSAqIFRoaXMgaXMgbGltaXRlZCBpbiBleGVjbGlzdHMgdG8gMjEgYml0cy4KLQkJICovCi0JCXN0
cnVjdCBpZGEgaHdfaWRhOwotI2RlZmluZSBNQVhfQ09OVEVYVF9IV19JRCAoMTw8MjEpIC8qIGV4
Y2x1c2l2ZSAqLwotI2RlZmluZSBNQVhfR1VDX0NPTlRFWFRfSFdfSUQgKDEgPDwgMjApIC8qIGV4
Y2x1c2l2ZSAqLwotI2RlZmluZSBHRU4xMV9NQVhfQ09OVEVYVF9IV19JRCAoMTw8MTEpIC8qIGV4
Y2x1c2l2ZSAqLwotCQlzdHJ1Y3QgbGlzdF9oZWFkIGh3X2lkX2xpc3Q7Ci0JfSBjb250ZXh0czsK
LQogCXUzMiBmZGlfcnhfY29uZmlnOwogCiAJLyogU2hhZG93IGZvciBESVNQTEFZX1BIWV9DT05U
Uk9MIHdoaWNoIGNhbid0IGJlIHNhZmVseSByZWFkICovCkBAIC0xODQwLDYgKzE4MjMsMTMgQEAg
c3RydWN0IGRybV9pOTE1X3ByaXZhdGUgewogCQkgKiBvZmYgdGhlIGlkbGVfd29yay4KIAkJICov
CiAJCXN0cnVjdCB3b3JrX3N0cnVjdCBpZGxlX3dvcms7CisKKwkJc3RydWN0IGk5MTVfZ2VtX2Nv
bnRleHRzIHsKKwkJCXN0cnVjdCBtdXRleCBtdXRleDsKKwkJCXN0cnVjdCBsaXN0X2hlYWQgbGlz
dDsKKwkJCXN0cnVjdCBsbGlzdF9oZWFkIGZyZWVfbGlzdDsKKwkJCXN0cnVjdCB3b3JrX3N0cnVj
dCBmcmVlX3dvcms7CisJCX0gY29udGV4dHM7CiAJfSBnZW07CiAKIAkvKiBGb3IgaTk0NWdtIHZi
bGFuayBpcnEgdnMuIEMzIHdvcmthcm91bmQgKi8KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2k5MTVfZ2VtLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbS5jCmluZGV4
IDQ2ZWQ5MGU1OWE4ZC4uNmNhNzAwMTg5YTg2IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9pOTE1X2dlbS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtLmMKQEAg
LTE0NjksNyArMTQ2OSw3IEBAIGludCBpOTE1X2dlbV9pbml0KHN0cnVjdCBkcm1faTkxNV9wcml2
YXRlICpkZXZfcHJpdikKIAkJZ290byBlcnJfdW5sb2NrOwogCX0KIAotCXJldCA9IGk5MTVfZ2Vt
X2NvbnRleHRzX2luaXQoZGV2X3ByaXYpOworCXJldCA9IGk5MTVfZ2VtX2luaXRfY29udGV4dHMo
ZGV2X3ByaXYpOwogCWlmIChyZXQpIHsKIAkJR0VNX0JVR19PTihyZXQgPT0gLUVJTyk7CiAJCWdv
dG8gZXJyX3NjcmF0Y2g7CkBAIC0xNTU3LDcgKzE1NTcsNyBAQCBpbnQgaTkxNV9nZW1faW5pdChz
dHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYpCiAJfQogZXJyX2NvbnRleHQ6CiAJaWYg
KHJldCAhPSAtRUlPKQotCQlpOTE1X2dlbV9jb250ZXh0c19maW5pKGRldl9wcml2KTsKKwkJaTkx
NV9nZW1fZmluaV9jb250ZXh0cyhkZXZfcHJpdik7CiBlcnJfc2NyYXRjaDoKIAlpOTE1X2dlbV9m
aW5pX3NjcmF0Y2goZGV2X3ByaXYpOwogZXJyX2dndHQ6CkBAIC0xNjI0LDcgKzE2MjQsNyBAQCB2
b2lkIGk5MTVfZ2VtX2RyaXZlcl9yZWxlYXNlKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZf
cHJpdikKIHsKIAltdXRleF9sb2NrKCZkZXZfcHJpdi0+ZHJtLnN0cnVjdF9tdXRleCk7CiAJaW50
ZWxfZW5naW5lc19jbGVhbnVwKGRldl9wcml2KTsKLQlpOTE1X2dlbV9jb250ZXh0c19maW5pKGRl
dl9wcml2KTsKKwlpOTE1X2dlbV9maW5pX2NvbnRleHRzKGRldl9wcml2KTsKIAlpOTE1X2dlbV9m
aW5pX3NjcmF0Y2goZGV2X3ByaXYpOwogCW11dGV4X3VubG9jaygmZGV2X3ByaXYtPmRybS5zdHJ1
Y3RfbXV0ZXgpOwogCkBAIC0xNjM4LDcgKzE2MzgsNyBAQCB2b2lkIGk5MTVfZ2VtX2RyaXZlcl9y
ZWxlYXNlKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdikKIAogCWk5MTVfZ2VtX2Ry
YWluX2ZyZWVkX29iamVjdHMoZGV2X3ByaXYpOwogCi0JV0FSTl9PTighbGlzdF9lbXB0eSgmZGV2
X3ByaXYtPmNvbnRleHRzLmxpc3QpKTsKKwlXQVJOX09OKCFsaXN0X2VtcHR5KCZkZXZfcHJpdi0+
Z2VtLmNvbnRleHRzLmxpc3QpKTsKIH0KIAogdm9pZCBpOTE1X2dlbV9pbml0X21taW8oc3RydWN0
IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9pOTE1X3BlcmYuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcGVyZi5jCmluZGV4IGRm
MDJlMGZlMDcwMS4uNjBjMTBkY2UxY2IwIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9pOTE1X3BlcmYuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3BlcmYuYwpAQCAt
MTg3MSw3ICsxODcxLDggQEAgc3RhdGljIGludCBnZW44X2NvbmZpZ3VyZV9hbGxfY29udGV4dHMo
c3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUsCiAJICogY29udGV4dC4gQ29udGV4dHMgaWRs
ZSBhdCB0aGUgdGltZSBvZiByZWNvbmZpZ3VyYXRpb24gYXJlIG5vdAogCSAqIHRyYXBwZWQgYmVo
aW5kIHRoZSBiYXJyaWVyLgogCSAqLwotCWxpc3RfZm9yX2VhY2hfZW50cnkoY3R4LCAmaTkxNS0+
Y29udGV4dHMubGlzdCwgbGluaykgeworCW11dGV4X2xvY2soJmk5MTUtPmdlbS5jb250ZXh0cy5t
dXRleCk7CisJbGlzdF9mb3JfZWFjaF9lbnRyeShjdHgsICZpOTE1LT5nZW0uY29udGV4dHMubGlz
dCwgbGluaykgewogCQlzdHJ1Y3QgaTkxNV9nZW1fZW5naW5lc19pdGVyIGl0OwogCQlzdHJ1Y3Qg
aW50ZWxfY29udGV4dCAqY2U7CiAKQEAgLTE5MDIsOCArMTkwMywxMSBAQCBzdGF0aWMgaW50IGdl
bjhfY29uZmlndXJlX2FsbF9jb250ZXh0cyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSwK
IAkJfQogCQlpOTE1X2dlbV9jb250ZXh0X3VubG9ja19lbmdpbmVzKGN0eCk7CiAJCWlmIChlcnIp
Ci0JCQlyZXR1cm4gZXJyOworCQkJYnJlYWs7CiAJfQorCW11dGV4X3VubG9jaygmaTkxNS0+Z2Vt
LmNvbnRleHRzLm11dGV4KTsKKwlpZiAoZXJyKQorCQlyZXR1cm4gZXJyOwogCiAJLyoKIAkgKiBB
ZnRlciB1cGRhdGluZyBhbGwgb3RoZXIgY29udGV4dHMsIHdlIG5lZWQgdG8gbW9kaWZ5IG91cnNl
bHZlcy4KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfc3lzZnMuYyBiL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfc3lzZnMuYwppbmRleCBlY2FjMWMzODYxMDkuLjY4MzZl
Njg5ZjAyNSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9zeXNmcy5jCisr
KyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfc3lzZnMuYwpAQCAtMTQyLDkgKzE0Miw5IEBA
IHN0YXRpYyBjb25zdCBzdHJ1Y3QgYXR0cmlidXRlX2dyb3VwIG1lZGlhX3JjNl9hdHRyX2dyb3Vw
ID0gewogfTsKICNlbmRpZgogCi1zdGF0aWMgaW50IGwzX2FjY2Vzc192YWxpZChzdHJ1Y3QgZHJt
X2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYsIGxvZmZfdCBvZmZzZXQpCitzdGF0aWMgaW50IGwzX2Fj
Y2Vzc192YWxpZChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSwgbG9mZl90IG9mZnNldCkK
IHsKLQlpZiAoIUhBU19MM19EUEYoZGV2X3ByaXYpKQorCWlmICghSEFTX0wzX0RQRihpOTE1KSkK
IAkJcmV0dXJuIC1FUEVSTTsKIAogCWlmIChvZmZzZXQgJSA0ICE9IDApCkBAIC0xNjIsMzEgKzE2
MiwzMCBAQCBpOTE1X2wzX3JlYWQoc3RydWN0IGZpbGUgKmZpbHAsIHN0cnVjdCBrb2JqZWN0ICpr
b2JqLAogCSAgICAgbG9mZl90IG9mZnNldCwgc2l6ZV90IGNvdW50KQogewogCXN0cnVjdCBkZXZp
Y2UgKmtkZXYgPSBrb2JqX3RvX2Rldihrb2JqKTsKLQlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAq
ZGV2X3ByaXYgPSBrZGV2X21pbm9yX3RvX2k5MTUoa2Rldik7Ci0Jc3RydWN0IGRybV9kZXZpY2Ug
KmRldiA9ICZkZXZfcHJpdi0+ZHJtOworCXN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1ID0g
a2Rldl9taW5vcl90b19pOTE1KGtkZXYpOwogCWludCBzbGljZSA9IChpbnQpKHVpbnRwdHJfdClh
dHRyLT5wcml2YXRlOwogCWludCByZXQ7CiAKIAljb3VudCA9IHJvdW5kX2Rvd24oY291bnQsIDQp
OwogCi0JcmV0ID0gbDNfYWNjZXNzX3ZhbGlkKGRldl9wcml2LCBvZmZzZXQpOworCXJldCA9IGwz
X2FjY2Vzc192YWxpZChpOTE1LCBvZmZzZXQpOwogCWlmIChyZXQpCiAJCXJldHVybiByZXQ7CiAK
IAljb3VudCA9IG1pbl90KHNpemVfdCwgR0VON19MM0xPR19TSVpFIC0gb2Zmc2V0LCBjb3VudCk7
CiAKLQlyZXQgPSBpOTE1X211dGV4X2xvY2tfaW50ZXJydXB0aWJsZShkZXYpOworCXJldCA9IG11
dGV4X2xvY2tfaW50ZXJydXB0aWJsZSgmaTkxNS0+Z2VtLmNvbnRleHRzLm11dGV4KTsKIAlpZiAo
cmV0KQogCQlyZXR1cm4gcmV0OwogCi0JaWYgKGRldl9wcml2LT5sM19wYXJpdHkucmVtYXBfaW5m
b1tzbGljZV0pCisJaWYgKGk5MTUtPmwzX3Bhcml0eS5yZW1hcF9pbmZvW3NsaWNlXSkKIAkJbWVt
Y3B5KGJ1ZiwKLQkJICAgICAgIGRldl9wcml2LT5sM19wYXJpdHkucmVtYXBfaW5mb1tzbGljZV0g
KyAob2Zmc2V0LzQpLAorCQkgICAgICAgaTkxNS0+bDNfcGFyaXR5LnJlbWFwX2luZm9bc2xpY2Vd
ICsgb2Zmc2V0IC8gNCwKIAkJICAgICAgIGNvdW50KTsKIAllbHNlCiAJCW1lbXNldChidWYsIDAs
IGNvdW50KTsKIAotCW11dGV4X3VubG9jaygmZGV2LT5zdHJ1Y3RfbXV0ZXgpOworCW11dGV4X3Vu
bG9jaygmaTkxNS0+Z2VtLmNvbnRleHRzLm11dGV4KTsKIAogCXJldHVybiBjb3VudDsKIH0KQEAg
LTE5NywyMiArMTk2LDIzIEBAIGk5MTVfbDNfd3JpdGUoc3RydWN0IGZpbGUgKmZpbHAsIHN0cnVj
dCBrb2JqZWN0ICprb2JqLAogCSAgICAgIGxvZmZfdCBvZmZzZXQsIHNpemVfdCBjb3VudCkKIHsK
IAlzdHJ1Y3QgZGV2aWNlICprZGV2ID0ga29ial90b19kZXYoa29iaik7Ci0Jc3RydWN0IGRybV9p
OTE1X3ByaXZhdGUgKmRldl9wcml2ID0ga2Rldl9taW5vcl90b19pOTE1KGtkZXYpOwotCXN0cnVj
dCBkcm1fZGV2aWNlICpkZXYgPSAmZGV2X3ByaXYtPmRybTsKKwlzdHJ1Y3QgZHJtX2k5MTVfcHJp
dmF0ZSAqaTkxNSA9IGtkZXZfbWlub3JfdG9faTkxNShrZGV2KTsKIAlzdHJ1Y3QgaTkxNV9nZW1f
Y29udGV4dCAqY3R4OwogCWludCBzbGljZSA9IChpbnQpKHVpbnRwdHJfdClhdHRyLT5wcml2YXRl
OwogCXUzMiAqKnJlbWFwX2luZm87CiAJaW50IHJldDsKIAotCXJldCA9IGwzX2FjY2Vzc192YWxp
ZChkZXZfcHJpdiwgb2Zmc2V0KTsKKwljb3VudCA9IHJvdW5kX2Rvd24oY291bnQsIDQpOworCisJ
cmV0ID0gbDNfYWNjZXNzX3ZhbGlkKGk5MTUsIG9mZnNldCk7CiAJaWYgKHJldCkKIAkJcmV0dXJu
IHJldDsKIAotCXJldCA9IGk5MTVfbXV0ZXhfbG9ja19pbnRlcnJ1cHRpYmxlKGRldik7CisJcmV0
ID0gbXV0ZXhfbG9ja19pbnRlcnJ1cHRpYmxlKCZpOTE1LT5nZW0uY29udGV4dHMubXV0ZXgpOwog
CWlmIChyZXQpCiAJCXJldHVybiByZXQ7CiAKLQlyZW1hcF9pbmZvID0gJmRldl9wcml2LT5sM19w
YXJpdHkucmVtYXBfaW5mb1tzbGljZV07CisJcmVtYXBfaW5mbyA9ICZpOTE1LT5sM19wYXJpdHku
cmVtYXBfaW5mb1tzbGljZV07CiAJaWYgKCEqcmVtYXBfaW5mbykgewogCQkqcmVtYXBfaW5mbyA9
IGt6YWxsb2MoR0VON19MM0xPR19TSVpFLCBHRlBfS0VSTkVMKTsKIAkJaWYgKCEqcmVtYXBfaW5m
bykgewpAQCAtMjIxLDIwICsyMjEsMjAgQEAgaTkxNV9sM193cml0ZShzdHJ1Y3QgZmlsZSAqZmls
cCwgc3RydWN0IGtvYmplY3QgKmtvYmosCiAJCX0KIAl9CiAKLQkvKiBUT0RPOiBJZGVhbGx5IHdl
IHJlYWxseSB3YW50IGEgR1BVIHJlc2V0IGhlcmUgdG8gbWFrZSBzdXJlIGVycm9ycworCS8qCisJ
ICogVE9ETzogSWRlYWxseSB3ZSByZWFsbHkgd2FudCBhIEdQVSByZXNldCBoZXJlIHRvIG1ha2Ug
c3VyZSBlcnJvcnMKIAkgKiBhcmVuJ3QgcHJvcGFnYXRlZC4gU2luY2UgSSBjYW5ub3QgZmluZCBh
IHN0YWJsZSB3YXkgdG8gcmVzZXQgdGhlIEdQVQogCSAqIGF0IHRoaXMgcG9pbnQgaXQgaXMgbGVm
dCBhcyBhIFRPRE8uCiAJKi8KIAltZW1jcHkoKnJlbWFwX2luZm8gKyAob2Zmc2V0LzQpLCBidWYs
IGNvdW50KTsKIAogCS8qIE5COiBXZSBkZWZlciB0aGUgcmVtYXBwaW5nIHVudGlsIHdlIHN3aXRj
aCB0byB0aGUgY29udGV4dCAqLwotCWxpc3RfZm9yX2VhY2hfZW50cnkoY3R4LCAmZGV2X3ByaXYt
PmNvbnRleHRzLmxpc3QsIGxpbmspCi0JCWN0eC0+cmVtYXBfc2xpY2UgfD0gKDE8PHNsaWNlKTsK
KwlsaXN0X2Zvcl9lYWNoX2VudHJ5KGN0eCwgJmk5MTUtPmdlbS5jb250ZXh0cy5saXN0LCBsaW5r
KQorCQljdHgtPnJlbWFwX3NsaWNlIHw9IEJJVChzbGljZSk7CiAKIAlyZXQgPSBjb3VudDsKLQog
b3V0OgotCW11dGV4X3VubG9jaygmZGV2LT5zdHJ1Y3RfbXV0ZXgpOworCW11dGV4X3VubG9jaygm
aTkxNS0+Z2VtLmNvbnRleHRzLm11dGV4KTsKIAogCXJldHVybiByZXQ7CiB9CmRpZmYgLS1naXQg
YS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9zZWxmdGVzdHMvbW9ja19nZW1fZGV2aWNlLmMgYi9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9zZWxmdGVzdHMvbW9ja19nZW1fZGV2aWNlLmMKaW5kZXggZmQ0Y2M0
ODA5ZWI4Li4xMDcwNDlhZmUyMDEgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L3Nl
bGZ0ZXN0cy9tb2NrX2dlbV9kZXZpY2UuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9zZWxm
dGVzdHMvbW9ja19nZW1fZGV2aWNlLmMKQEAgLTY1LDcgKzY1LDcgQEAgc3RhdGljIHZvaWQgbW9j
a19kZXZpY2VfcmVsZWFzZShzdHJ1Y3QgZHJtX2RldmljZSAqZGV2KQogCW11dGV4X2xvY2soJmk5
MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOwogCWZvcl9lYWNoX2VuZ2luZShlbmdpbmUsIGk5MTUsIGlk
KQogCQltb2NrX2VuZ2luZV9mcmVlKGVuZ2luZSk7Ci0JaTkxNV9nZW1fY29udGV4dHNfZmluaShp
OTE1KTsKKwlpOTE1X2dlbV9maW5pX2NvbnRleHRzKGk5MTUpOwogCW11dGV4X3VubG9jaygmaTkx
NS0+ZHJtLnN0cnVjdF9tdXRleCk7CiAKIAlpbnRlbF90aW1lbGluZXNfZmluaShpOTE1KTsKQEAg
LTIyMCw3ICsyMjAsNyBAQCBzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqbW9ja19nZW1fZGV2aWNl
KHZvaWQpCiAJcmV0dXJuIGk5MTU7CiAKIGVycl9jb250ZXh0OgotCWk5MTVfZ2VtX2NvbnRleHRz
X2ZpbmkoaTkxNSk7CisJaTkxNV9nZW1fZmluaV9jb250ZXh0cyhpOTE1KTsKIGVycl9lbmdpbmU6
CiAJbW9ja19lbmdpbmVfZnJlZShpOTE1LT5lbmdpbmVbUkNTMF0pOwogZXJyX3VubG9jazoKLS0g
CjIuMjIuMAoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18K
SW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0
dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 3B37133737
	for <lists+intel-gfx@lfdr.de>; Mon,  3 Jun 2019 19:49:53 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 9E974892CD;
	Mon,  3 Jun 2019 17:49:48 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 5585B892AE
 for <intel-gfx@lists.freedesktop.org>; Mon,  3 Jun 2019 17:49:46 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 16778862-1500050 
 for multiple; Mon, 03 Jun 2019 18:49:38 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon,  3 Jun 2019 18:49:31 +0100
Message-Id: <20190603174935.23982-3-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190603174935.23982-1-chris@chris-wilson.co.uk>
References: <20190603174935.23982-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 3/7] drm/i915: Allow page pinning to be in the
 background
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

QXNzdW1lIHRoYXQgcGFnZXMgbWF5IGJlIHBpbm5lZCBpbiBhIGJhY2tncm91bmQgdGFzayBhbmQg
dXNlIGEKY29tcGxldGlvbiBldmVudCB0byBzeW5jaHJvbmlzZSB3aXRoIGNhbGxlcnMgdGhhdCBt
dXN0IGFjY2VzcyB0aGUgcGFnZXMKaW1tZWRpYXRlbHkuCgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBX
aWxzb24gPGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkx
NS9nZW0vaTkxNV9nZW1fb2JqZWN0LmMgICAgfCAgMSArCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9n
ZW0vaTkxNV9nZW1fb2JqZWN0LmggICAgfCAgNyArLS0KIC4uLi9ncHUvZHJtL2k5MTUvZ2VtL2k5
MTVfZ2VtX29iamVjdF90eXBlcy5oICB8ICAzICsrCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0v
aTkxNV9nZW1fcGFnZXMuYyAgICAgfCA1MyArKysrKysrKysrKysrKystLS0tCiA0IGZpbGVzIGNo
YW5nZWQsIDUyIGluc2VydGlvbnMoKyksIDEyIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9vYmplY3QuYyBiL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2dlbS9pOTE1X2dlbV9vYmplY3QuYwppbmRleCAyNzAyZTA2MDEwMmUuLjJjNWEwMjI3
NDE3MCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX29iamVj
dC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9vYmplY3QuYwpAQCAt
NzksNiArNzksNyBAQCB2b2lkIGk5MTVfZ2VtX29iamVjdF9pbml0KHN0cnVjdCBkcm1faTkxNV9n
ZW1fb2JqZWN0ICpvYmosCiAJb2JqLT5tbS5tYWR2ID0gSTkxNV9NQURWX1dJTExORUVEOwogCUlO
SVRfUkFESVhfVFJFRSgmb2JqLT5tbS5nZXRfcGFnZS5yYWRpeCwgR0ZQX0tFUk5FTCB8IF9fR0ZQ
X05PV0FSTik7CiAJbXV0ZXhfaW5pdCgmb2JqLT5tbS5nZXRfcGFnZS5sb2NrKTsKKwlpbml0X2Nv
bXBsZXRpb24oJm9iai0+bW0uY29tcGxldGlvbik7CiB9CiAKIC8qKgpkaWZmIC0tZ2l0IGEvZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX29iamVjdC5oIGIvZHJpdmVycy9ncHUvZHJt
L2k5MTUvZ2VtL2k5MTVfZ2VtX29iamVjdC5oCmluZGV4IDdjYjE4NzFkNzEyOC4uMTk0ZTRmYjZh
MjU5IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fb2JqZWN0
LmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX29iamVjdC5oCkBAIC0y
NDAsNyArMjQwLDcgQEAgaW50IF9fX19pOTE1X2dlbV9vYmplY3RfZ2V0X3BhZ2VzKHN0cnVjdCBk
cm1faTkxNV9nZW1fb2JqZWN0ICpvYmopOwogaW50IF9faTkxNV9nZW1fb2JqZWN0X2dldF9wYWdl
cyhzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqKTsKIAogc3RhdGljIGlubGluZSBpbnQg
X19tdXN0X2NoZWNrCi1pOTE1X2dlbV9vYmplY3RfcGluX3BhZ2VzKHN0cnVjdCBkcm1faTkxNV9n
ZW1fb2JqZWN0ICpvYmopCitpOTE1X2dlbV9vYmplY3RfcGluX3BhZ2VzX2FzeW5jKHN0cnVjdCBk
cm1faTkxNV9nZW1fb2JqZWN0ICpvYmopCiB7CiAJbWlnaHRfbG9jaygmb2JqLT5tbS5sb2NrKTsK
IApAQCAtMjUwLDYgKzI1MCw5IEBAIGk5MTVfZ2VtX29iamVjdF9waW5fcGFnZXMoc3RydWN0IGRy
bV9pOTE1X2dlbV9vYmplY3QgKm9iaikKIAlyZXR1cm4gX19pOTE1X2dlbV9vYmplY3RfZ2V0X3Bh
Z2VzKG9iaik7CiB9CiAKK2ludCBfX211c3RfY2hlY2sKK2k5MTVfZ2VtX29iamVjdF9waW5fcGFn
ZXMoc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaik7CisKIHN0YXRpYyBpbmxpbmUgYm9v
bAogaTkxNV9nZW1fb2JqZWN0X2hhc19wYWdlcyhzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAq
b2JqKQogewpAQCAtMjczLDkgKzI3Niw3IEBAIGk5MTVfZ2VtX29iamVjdF9oYXNfcGlubmVkX3Bh
Z2VzKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmopCiBzdGF0aWMgaW5saW5lIHZvaWQK
IF9faTkxNV9nZW1fb2JqZWN0X3VucGluX3BhZ2VzKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0
ICpvYmopCiB7Ci0JR0VNX0JVR19PTighaTkxNV9nZW1fb2JqZWN0X2hhc19wYWdlcyhvYmopKTsK
IAlHRU1fQlVHX09OKCFpOTE1X2dlbV9vYmplY3RfaGFzX3Bpbm5lZF9wYWdlcyhvYmopKTsKLQog
CWF0b21pY19kZWMoJm9iai0+bW0ucGFnZXNfcGluX2NvdW50KTsKIH0KIApkaWZmIC0tZ2l0IGEv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX29iamVjdF90eXBlcy5oIGIvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX29iamVjdF90eXBlcy5oCmluZGV4IDQxZDJlN2M4
ZTMzMi4uNjE1YTU5YjkyN2Q2IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0v
aTkxNV9nZW1fb2JqZWN0X3R5cGVzLmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5
MTVfZ2VtX29iamVjdF90eXBlcy5oCkBAIC03LDYgKzcsNyBAQAogI2lmbmRlZiBfX0k5MTVfR0VN
X09CSkVDVF9UWVBFU19IX18KICNkZWZpbmUgX19JOTE1X0dFTV9PQkpFQ1RfVFlQRVNfSF9fCiAK
KyNpbmNsdWRlIDxsaW51eC9jb21wbGV0aW9uLmg+CiAjaW5jbHVkZSA8bGludXgvcmVzZXJ2YXRp
b24uaD4KIAogI2luY2x1ZGUgPGRybS9kcm1fZ2VtLmg+CkBAIC0yMTEsNiArMjEyLDggQEAgc3Ry
dWN0IGRybV9pOTE1X2dlbV9vYmplY3QgewogCQkgKi8KIAkJc3RydWN0IGxpc3RfaGVhZCBsaW5r
OwogCisJCXN0cnVjdCBjb21wbGV0aW9uIGNvbXBsZXRpb247CisKIAkJLyoqCiAJCSAqIEFkdmlj
ZTogYXJlIHRoZSBiYWNraW5nIHBhZ2VzIHB1cmdlYWJsZT8KIAkJICovCmRpZmYgLS1naXQgYS9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fcGFnZXMuYyBiL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2dlbS9pOTE1X2dlbV9wYWdlcy5jCmluZGV4IDc4NjhkZDQ4ZDkzMS4uNjgyNjIyMzFm
NTZmIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fcGFnZXMu
YworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fcGFnZXMuYwpAQCAtNzIs
MjEgKzcyLDE4IEBAIHZvaWQgX19pOTE1X2dlbV9vYmplY3Rfc2V0X3BhZ2VzKHN0cnVjdCBkcm1f
aTkxNV9nZW1fb2JqZWN0ICpvYmosCiAKIAkJc3Bpbl91bmxvY2soJmk5MTUtPm1tLm9ial9sb2Nr
KTsKIAl9CisKKwljb21wbGV0ZV9hbGwoJm9iai0+bW0uY29tcGxldGlvbik7CiB9CiAKIGludCBf
X19faTkxNV9nZW1fb2JqZWN0X2dldF9wYWdlcyhzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAq
b2JqKQogewotCWludCBlcnI7Ci0KIAlpZiAodW5saWtlbHkob2JqLT5tbS5tYWR2ICE9IEk5MTVf
TUFEVl9XSUxMTkVFRCkpIHsKIAkJRFJNX0RFQlVHKCJBdHRlbXB0aW5nIHRvIG9idGFpbiBhIHB1
cmdlYWJsZSBvYmplY3RcbiIpOwogCQlyZXR1cm4gLUVGQVVMVDsKIAl9CiAKLQllcnIgPSBvYmot
Pm9wcy0+Z2V0X3BhZ2VzKG9iaik7Ci0JR0VNX0JVR19PTighZXJyICYmICFpOTE1X2dlbV9vYmpl
Y3RfaGFzX3BhZ2VzKG9iaikpOwotCi0JcmV0dXJuIGVycjsKKwlyZXR1cm4gb2JqLT5vcHMtPmdl
dF9wYWdlcyhvYmopOwogfQogCiAvKiBFbnN1cmUgdGhhdCB0aGUgYXNzb2NpYXRlZCBwYWdlcyBh
cmUgZ2F0aGVyZWQgZnJvbSB0aGUgYmFja2luZyBzdG9yYWdlCkBAIC0xMDQsNyArMTAxLDcgQEAg
aW50IF9faTkxNV9nZW1fb2JqZWN0X2dldF9wYWdlcyhzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVj
dCAqb2JqKQogCWlmIChlcnIpCiAJCXJldHVybiBlcnI7CiAKLQlpZiAodW5saWtlbHkoIWk5MTVf
Z2VtX29iamVjdF9oYXNfcGFnZXMob2JqKSkpIHsKKwlpZiAoIW9iai0+bW0ucGFnZXMpIHsKIAkJ
R0VNX0JVR19PTihpOTE1X2dlbV9vYmplY3RfaGFzX3Bpbm5lZF9wYWdlcyhvYmopKTsKIAogCQll
cnIgPSBfX19faTkxNV9nZW1fb2JqZWN0X2dldF9wYWdlcyhvYmopOwpAQCAtMTIwLDYgKzExNywz
MiBAQCBpbnQgX19pOTE1X2dlbV9vYmplY3RfZ2V0X3BhZ2VzKHN0cnVjdCBkcm1faTkxNV9nZW1f
b2JqZWN0ICpvYmopCiAJcmV0dXJuIGVycjsKIH0KIAoraW50IGk5MTVfZ2VtX29iamVjdF9waW5f
cGFnZXMoc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaikKK3sKKwlpbnQgZXJyOworCisJ
ZXJyID0gaTkxNV9nZW1fb2JqZWN0X3Bpbl9wYWdlc19hc3luYyhvYmopOworCWlmIChlcnIpCisJ
CXJldHVybiBlcnI7CisKKwllcnIgPSB3YWl0X2Zvcl9jb21wbGV0aW9uX2ludGVycnVwdGlibGUo
Jm9iai0+bW0uY29tcGxldGlvbik7CisJaWYgKGVycikKKwkJZ290byBlcnJfdW5waW47CisKKwlp
ZiAoSVNfRVJSKG9iai0+bW0ucGFnZXMpKSB7CisJCWVyciA9IFBUUl9FUlIob2JqLT5tbS5wYWdl
cyk7CisJCWdvdG8gZXJyX3VucGluOworCX0KKworCUdFTV9CVUdfT04oIWk5MTVfZ2VtX29iamVj
dF9oYXNfcGFnZXMob2JqKSk7CisJcmV0dXJuIDA7CisKK2Vycl91bnBpbjoKKwlHRU1fQlVHX09O
KCFpOTE1X2dlbV9vYmplY3RfaGFzX3Bpbm5lZF9wYWdlcyhvYmopKTsKKwlhdG9taWNfZGVjKCZv
YmotPm1tLnBhZ2VzX3Bpbl9jb3VudCk7CisJcmV0dXJuIGVycjsKK30KKwogLyogSW1tZWRpYXRl
bHkgZGlzY2FyZCB0aGUgYmFja2luZyBzdG9yYWdlICovCiB2b2lkIGk5MTVfZ2VtX29iamVjdF90
cnVuY2F0ZShzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqKQogewpAQCAtMTk2LDYgKzIx
OSw5IEBAIGludCBfX2k5MTVfZ2VtX29iamVjdF9wdXRfcGFnZXMoc3RydWN0IGRybV9pOTE1X2dl
bV9vYmplY3QgKm9iaiwKIAogCUdFTV9CVUdfT04oYXRvbWljX3JlYWQoJm9iai0+YmluZF9jb3Vu
dCkpOwogCisJaWYgKG9iai0+bW0ucGFnZXMgPT0gRVJSX1BUUigtRUFHQUlOKSkKKwkJd2FpdF9m
b3JfY29tcGxldGlvbigmb2JqLT5tbS5jb21wbGV0aW9uKTsKKwogCS8qIE1heSBiZSBjYWxsZWQg
Ynkgc2hyaW5rZXIgZnJvbSB3aXRoaW4gZ2V0X3BhZ2VzKCkgKG9uIGFub3RoZXIgYm8pICovCiAJ
bXV0ZXhfbG9ja19uZXN0ZWQoJm9iai0+bW0ubG9jaywgc3ViY2xhc3MpOwogCWlmICh1bmxpa2Vs
eShhdG9taWNfcmVhZCgmb2JqLT5tbS5wYWdlc19waW5fY291bnQpKSkgewpAQCAtMjIyLDYgKzI0
OCw3IEBAIGludCBfX2k5MTVfZ2VtX29iamVjdF9wdXRfcGFnZXMoc3RydWN0IGRybV9pOTE1X2dl
bV9vYmplY3QgKm9iaiwKIAlpZiAoIUlTX0VSUihwYWdlcykpCiAJCW9iai0+b3BzLT5wdXRfcGFn
ZXMob2JqLCBwYWdlcyk7CiAKKwlyZWluaXRfY29tcGxldGlvbigmb2JqLT5tbS5jb21wbGV0aW9u
KTsKIAllcnIgPSAwOwogdW5sb2NrOgogCW11dGV4X3VubG9jaygmb2JqLT5tbS5sb2NrKTsKQEAg
LTI5OSw3ICszMjYsNyBAQCB2b2lkICppOTE1X2dlbV9vYmplY3RfcGluX21hcChzdHJ1Y3QgZHJt
X2k5MTVfZ2VtX29iamVjdCAqb2JqLAogCXR5cGUgJj0gfkk5MTVfTUFQX09WRVJSSURFOwogCiAJ
aWYgKCFhdG9taWNfaW5jX25vdF96ZXJvKCZvYmotPm1tLnBhZ2VzX3Bpbl9jb3VudCkpIHsKLQkJ
aWYgKHVubGlrZWx5KCFpOTE1X2dlbV9vYmplY3RfaGFzX3BhZ2VzKG9iaikpKSB7CisJCWlmICgh
b2JqLT5tbS5wYWdlcykgewogCQkJR0VNX0JVR19PTihpOTE1X2dlbV9vYmplY3RfaGFzX3Bpbm5l
ZF9wYWdlcyhvYmopKTsKIAogCQkJZXJyID0gX19fX2k5MTVfZ2VtX29iamVjdF9nZXRfcGFnZXMo
b2JqKTsKQEAgLTMxMSw3ICszMzgsNiBAQCB2b2lkICppOTE1X2dlbV9vYmplY3RfcGluX21hcChz
dHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqLAogCQlhdG9taWNfaW5jKCZvYmotPm1tLnBh
Z2VzX3Bpbl9jb3VudCk7CiAJCXBpbm5lZCA9IGZhbHNlOwogCX0KLQlHRU1fQlVHX09OKCFpOTE1
X2dlbV9vYmplY3RfaGFzX3BhZ2VzKG9iaikpOwogCiAJcHRyID0gcGFnZV91bnBhY2tfYml0cyhv
YmotPm1tLm1hcHBpbmcsICZoYXNfdHlwZSk7CiAJaWYgKHB0ciAmJiBoYXNfdHlwZSAhPSB0eXBl
KSB7CkBAIC0zMjksNiArMzU1LDE1IEBAIHZvaWQgKmk5MTVfZ2VtX29iamVjdF9waW5fbWFwKHN0
cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmosCiAJfQogCiAJaWYgKCFwdHIpIHsKKwkJZXJy
ID0gd2FpdF9mb3JfY29tcGxldGlvbl9pbnRlcnJ1cHRpYmxlKCZvYmotPm1tLmNvbXBsZXRpb24p
OworCQlpZiAoZXJyKQorCQkJZ290byBlcnJfdW5waW47CisKKwkJaWYgKElTX0VSUihvYmotPm1t
LnBhZ2VzKSkgeworCQkJZXJyID0gUFRSX0VSUihvYmotPm1tLnBhZ2VzKTsKKwkJCWdvdG8gZXJy
X3VucGluOworCQl9CisKIAkJcHRyID0gaTkxNV9nZW1fb2JqZWN0X21hcChvYmosIHR5cGUpOwog
CQlpZiAoIXB0cikgewogCQkJZXJyID0gLUVOT01FTTsKLS0gCjIuMjAuMQoKX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlz
dApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0
b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 54B8F6399D
	for <lists+intel-gfx@lfdr.de>; Tue,  9 Jul 2019 18:42:44 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 3430589CD5;
	Tue,  9 Jul 2019 16:42:42 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 19D3989CD5
 for <intel-gfx@lists.freedesktop.org>; Tue,  9 Jul 2019 16:42:39 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17188112-1500050 
 for multiple; Tue, 09 Jul 2019 17:42:28 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Tue,  9 Jul 2019 17:42:27 +0100
Message-Id: <20190709164227.25859-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.22.0
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH] drm/i915: add infrastructure to hold off
 preemption on a request
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

RnJvbTogTGlvbmVsIExhbmR3ZXJsaW4gPGxpb25lbC5nLmxhbmR3ZXJsaW5AaW50ZWwuY29tPgoK
V2Ugd2FudCB0byBzZXQgdGhpcyBmbGFnIGluIHRoZSBuZXh0IGNvbW1pdCBvbiByZXF1ZXN0cyBj
b250YWluaW5nCnBlcmYgcXVlcmllcyBzbyB0aGF0IHRoZSByZXN1bHQgb2YgdGhlIHBlcmYgcXVl
cnkgY2FuIGp1c3QgYmUgYSBkZWx0YQpvZiBnbG9iYWwgY291bnRlcnMsIHJhdGhlciB0aGFuIGRv
aW5nIHBvc3QgcHJvY2Vzc2luZyBvZiB0aGUgT0EKYnVmZmVyLgoKU2lnbmVkLW9mZi1ieTogTGlv
bmVsIExhbmR3ZXJsaW4gPGxpb25lbC5nLmxhbmR3ZXJsaW5AaW50ZWwuY29tPgpSZXZpZXdlZC1i
eTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28udWs+CltpY2tsZTogYWRkIGJh
c2ljIHNlbGZ0ZXN0IGZvciBub3ByZWVtcHRdClNpZ25lZC1vZmYtYnk6IENocmlzIFdpbHNvbiA8
Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPgpDYzogVHZydGtvIFVyc3VsaW4gPHR2cnRrby51cnN1
bGluQGludGVsLmNvbT4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9scmMuYyAg
ICAgICAgIHwgIDExICsrCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVzdF9scmMuYyAg
ICAgIHwgMTA5ICsrKysrKysrKysrKysrKysrKysrCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1
X3ByaW9saXN0X3R5cGVzLmggIHwgIDEwICsrCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3Jl
cXVlc3QuYyAgICAgICAgIHwgICA0ICstCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3JlcXVl
c3QuaCAgICAgICAgIHwgIDE1ICsrLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfZ3VjX3N1
Ym1pc3Npb24uYyB8ICAxMyArKy0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2ludGVsX3BtLmMgICAg
ICAgICAgICAgfCAgIDUgKy0KIDcgZmlsZXMgY2hhbmdlZCwgMTYxIGluc2VydGlvbnMoKyksIDYg
ZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxf
bHJjLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9scmMuYwppbmRleCBlMWFlMTM5
OWM3MmIuLmQxNmQ2NWUxOTViMCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Qv
aW50ZWxfbHJjLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjLmMKQEAg
LTI1OCw2ICsyNTgsMTcgQEAgc3RhdGljIGludCBlZmZlY3RpdmVfcHJpbyhjb25zdCBzdHJ1Y3Qg
aTkxNV9yZXF1ZXN0ICpycSkKIHsKIAlpbnQgcHJpbyA9IHJxX3ByaW8ocnEpOwogCisJLyoKKwkg
KiBJZiB0aGlzIHJlcXVlc3QgaXMgc3BlY2lhbCBhbmQgbXVzdCBub3QgYmUgaW50ZXJydXB0ZWQg
YXQgYW55CisJICogY29zdCwgc28gYmUgaXQuIE5vdGUgd2UgYXJlIG9ubHkgY2hlY2tpbmcgdGhl
IG1vc3QgcmVjZW50IHJlcXVlc3QKKwkgKiBpbiB0aGUgY29udGV4dCBhbmQgc28gbWF5IGJlIG1h
c2tpbmcgYW4gZWFybGllciB2aXAgcmVxdWVzdC4gSXQKKwkgKiBpcyBob3BlZCB0aGF0IHVuZGVy
IHRoZSBjb25kaXRpb25zIHdoZXJlIG5vcHJlZW1wdCBpcyB1c2VkLCB0aGlzCisJICogd2lsbCBu
b3QgbWF0dGVyIChpLmUuIGFsbCByZXF1ZXN0cyB0byB0aGF0IGNvbnRleHQgd2lsbCBiZQorCSAq
IG5vcHJlZW1wdCBmb3IgYXMgbG9uZyBhcyBkZXNpcmVkKS4KKwkgKi8KKwlpZiAoaTkxNV9yZXF1
ZXN0X2hhc19ub3ByZWVtcHQocnEpKQorCQlwcmlvID0gSTkxNV9QUklPUklUWV9VTlBSRUVNUFRB
QkxFOworCiAJLyoKIAkgKiBPbiB1bndpbmRpbmcgdGhlIGFjdGl2ZSByZXF1ZXN0LCB3ZSBnaXZl
IGl0IGEgcHJpb3JpdHkgYnVtcAogCSAqIGlmIGl0IGhhcyBjb21wbGV0ZWQgd2FpdGluZyBvbiBh
bnkgc2VtYXBob3JlLiBJZiB3ZSBrbm93IHRoYXQKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2d0L3NlbGZ0ZXN0X2xyYy5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Qvc2VsZnRl
c3RfbHJjLmMKaW5kZXggNjcyYmRhYTY2NTQwLi5iOWI4ODFhYjhlN2MgMTAwNjQ0Ci0tLSBhL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2d0L3NlbGZ0ZXN0X2xyYy5jCisrKyBiL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2d0L3NlbGZ0ZXN0X2xyYy5jCkBAIC03MjEsNiArNzIxLDExNCBAQCBzdGF0aWMgdm9p
ZCBwcmVlbXB0X2NsaWVudF9maW5pKHN0cnVjdCBwcmVlbXB0X2NsaWVudCAqYykKIAlrZXJuZWxf
Y29udGV4dF9jbG9zZShjLT5jdHgpOwogfQogCitzdGF0aWMgaW50IGxpdmVfbm9wcmVlbXB0KHZv
aWQgKmFyZykKK3sKKwlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSA9IGFyZzsKKwlzdHJ1
Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmU7CisJc3RydWN0IHByZWVtcHRfY2xpZW50IGEsIGI7
CisJZW51bSBpbnRlbF9lbmdpbmVfaWQgaWQ7CisJaW50ZWxfd2FrZXJlZl90IHdha2VyZWY7CisJ
aW50IGVyciA9IC1FTk9NRU07CisKKwkvKgorCSAqIFZlcmlmeSB0aGF0IHdlIGNhbiBkaXNhYmxl
IHByZWVtcHRpb24gZm9yIGFuIGluZGl2aWR1YWwgcmVxdWVzdAorCSAqIHRoYXQgbWF5IGJlIGJl
aW5nIG9ic2VydmVkIGFuZCBub3Qgd2FudCB0byBiZSBpbnRlcnJ1cHRlZC4KKwkgKi8KKworCWlm
ICghSEFTX0xPR0lDQUxfUklOR19QUkVFTVBUSU9OKGk5MTUpKQorCQlyZXR1cm4gMDsKKworCW11
dGV4X2xvY2soJmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOworCXdha2VyZWYgPSBpbnRlbF9ydW50
aW1lX3BtX2dldCgmaTkxNS0+cnVudGltZV9wbSk7CisKKwlpZiAocHJlZW1wdF9jbGllbnRfaW5p
dChpOTE1LCAmYSkpCisJCWdvdG8gZXJyX3VubG9jazsKKwlpZiAocHJlZW1wdF9jbGllbnRfaW5p
dChpOTE1LCAmYikpCisJCWdvdG8gZXJyX2NsaWVudF9hOworCWIuY3R4LT5zY2hlZC5wcmlvcml0
eSA9IEk5MTVfVVNFUl9QUklPUklUWShJOTE1X1BSSU9SSVRZX01BWCk7CisKKwlmb3JfZWFjaF9l
bmdpbmUoZW5naW5lLCBpOTE1LCBpZCkgeworCQlzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycV9hLCAq
cnFfYjsKKworCQlpZiAoIWludGVsX2VuZ2luZV9oYXNfcHJlZW1wdGlvbihlbmdpbmUpKQorCQkJ
Y29udGludWU7CisKKwkJZW5naW5lLT5leGVjbGlzdHMucHJlZW1wdF9oYW5nLmNvdW50ID0gMDsK
KworCQlycV9hID0gaWd0X3NwaW5uZXJfY3JlYXRlX3JlcXVlc3QoJmEuc3BpbiwKKwkJCQkJCSAg
YS5jdHgsIGVuZ2luZSwKKwkJCQkJCSAgTUlfQVJCX0NIRUNLKTsKKwkJaWYgKElTX0VSUihycV9h
KSkgeworCQkJZXJyID0gUFRSX0VSUihycV9hKTsKKwkJCWdvdG8gZXJyX2NsaWVudF9iOworCQl9
CisKKwkJLyogTG93IHByaW9yaXR5IGNsaWVudCwgYnV0IHVucHJlZW1wdGFibGUhICovCisJCXJx
X2EtPmZsYWdzIHw9IEk5MTVfUkVRVUVTVF9OT1BSRUVNUFQ7CisKKwkJaTkxNV9yZXF1ZXN0X2Fk
ZChycV9hKTsKKwkJaWYgKCFpZ3Rfd2FpdF9mb3Jfc3Bpbm5lcigmYS5zcGluLCBycV9hKSkgewor
CQkJcHJfZXJyKCJGaXJzdCBjbGllbnQgZmFpbGVkIHRvIHN0YXJ0XG4iKTsKKwkJCWdvdG8gZXJy
X3dlZGdlZDsKKwkJfQorCisJCXJxX2IgPSBpZ3Rfc3Bpbm5lcl9jcmVhdGVfcmVxdWVzdCgmYi5z
cGluLAorCQkJCQkJICBiLmN0eCwgZW5naW5lLAorCQkJCQkJICBNSV9BUkJfQ0hFQ0spOworCQlp
ZiAoSVNfRVJSKHJxX2IpKSB7CisJCQllcnIgPSBQVFJfRVJSKHJxX2IpOworCQkJZ290byBlcnJf
Y2xpZW50X2I7CisJCX0KKworCQlpOTE1X3JlcXVlc3RfYWRkKHJxX2IpOworCisJCS8qIEIgaXMg
bXVjaCBtb3JlIGltcG9ydGFudCB0aGFuIEEhIChCdXQgQSBpcyB1bnByZWVtcHRhYmxlLikgKi8K
KwkJR0VNX0JVR19PTihycV9wcmlvKHJxX2IpIDw9IHJxX3ByaW8ocnFfYSkpOworCisJCS8qIFdh
aXQgbG9uZyBlbm91Z2ggZm9yIHByZWVtcHRpb24gYW5kIHRpbWVzbGljaW5nICovCisJCWlmIChp
Z3Rfd2FpdF9mb3Jfc3Bpbm5lcigmYi5zcGluLCBycV9iKSkgeworCQkJcHJfZXJyKCJTZWNvbmQg
Y2xpZW50IHN0YXJ0ZWQgdG9vIGVhcmx5IVxuIik7CisJCQlnb3RvIGVycl93ZWRnZWQ7CisJCX0K
KworCQlpZ3Rfc3Bpbm5lcl9lbmQoJmEuc3Bpbik7CisKKwkJaWYgKCFpZ3Rfd2FpdF9mb3Jfc3Bp
bm5lcigmYi5zcGluLCBycV9iKSkgeworCQkJcHJfZXJyKCJTZWNvbmQgY2xpZW50IGZhaWxlZCB0
byBzdGFydFxuIik7CisJCQlnb3RvIGVycl93ZWRnZWQ7CisJCX0KKworCQlpZ3Rfc3Bpbm5lcl9l
bmQoJmIuc3Bpbik7CisKKwkJaWYgKGVuZ2luZS0+ZXhlY2xpc3RzLnByZWVtcHRfaGFuZy5jb3Vu
dCkgeworCQkJcHJfZXJyKCJQcmVlbXB0aW9uIHJlY29yZGVkIHglZDsgc2hvdWxkIGhhdmUgYmVl
biBzdXBwcmVzc2VkIVxuIiwKKwkJCSAgICAgICBlbmdpbmUtPmV4ZWNsaXN0cy5wcmVlbXB0X2hh
bmcuY291bnQpOworCQkJZXJyID0gLUVJTlZBTDsKKwkJCWdvdG8gZXJyX3dlZGdlZDsKKwkJfQor
CisJCWlmIChpZ3RfZmx1c2hfdGVzdChpOTE1LCBJOTE1X1dBSVRfTE9DS0VEKSkKKwkJCWdvdG8g
ZXJyX3dlZGdlZDsKKwl9CisKKwllcnIgPSAwOworZXJyX2NsaWVudF9iOgorCXByZWVtcHRfY2xp
ZW50X2ZpbmkoJmIpOworZXJyX2NsaWVudF9hOgorCXByZWVtcHRfY2xpZW50X2ZpbmkoJmEpOwor
ZXJyX3VubG9jazoKKwlpbnRlbF9ydW50aW1lX3BtX3B1dCgmaTkxNS0+cnVudGltZV9wbSwgd2Fr
ZXJlZik7CisJbXV0ZXhfdW5sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKKwlyZXR1cm4g
ZXJyOworCitlcnJfd2VkZ2VkOgorCWlndF9zcGlubmVyX2VuZCgmYi5zcGluKTsKKwlpZ3Rfc3Bp
bm5lcl9lbmQoJmEuc3Bpbik7CisJaTkxNV9nZW1fc2V0X3dlZGdlZChpOTE1KTsKKwllcnIgPSAt
RUlPOworCWdvdG8gZXJyX2NsaWVudF9iOworfQorCiBzdGF0aWMgaW50IGxpdmVfc3VwcHJlc3Nf
c2VsZl9wcmVlbXB0KHZvaWQgKmFyZykKIHsKIAlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkx
NSA9IGFyZzsKQEAgLTIwMjgsNiArMjEzNiw3IEBAIGludCBpbnRlbF9leGVjbGlzdHNfbGl2ZV9z
ZWxmdGVzdHMoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCiAJCVNVQlRFU1QobGl2ZV9i
dXN5d2FpdF9wcmVlbXB0KSwKIAkJU1VCVEVTVChsaXZlX3ByZWVtcHQpLAogCQlTVUJURVNUKGxp
dmVfbGF0ZV9wcmVlbXB0KSwKKwkJU1VCVEVTVChsaXZlX25vcHJlZW1wdCksCiAJCVNVQlRFU1Qo
bGl2ZV9zdXBwcmVzc19zZWxmX3ByZWVtcHQpLAogCQlTVUJURVNUKGxpdmVfc3VwcHJlc3Nfd2Fp
dF9wcmVlbXB0KSwKIAkJU1VCVEVTVChsaXZlX2NoYWluX3ByZWVtcHQpLApkaWZmIC0tZ2l0IGEv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wcmlvbGlzdF90eXBlcy5oIGIvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvaTkxNV9wcmlvbGlzdF90eXBlcy5oCmluZGV4IDQ5NzA5ZGU2OTg3NS4uYjAyZGVh
MTdkY2FiIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3ByaW9saXN0X3R5
cGVzLmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wcmlvbGlzdF90eXBlcy5oCkBA
IC0xNyw2ICsxNywxNiBAQCBlbnVtIHsKIAlJOTE1X1BSSU9SSVRZX05PUk1BTCA9IEk5MTVfQ09O
VEVYVF9ERUZBVUxUX1BSSU9SSVRZLAogCUk5MTVfUFJJT1JJVFlfTUFYID0gSTkxNV9DT05URVhU
X01BWF9VU0VSX1BSSU9SSVRZICsgMSwKIAorCS8qCisJICogUmVxdWVzdHMgY29udGFpbmluZyBw
ZXJmb3JtYW5jZSBxdWVyaWVzIG11c3Qgbm90IGJlIHByZWVtcHRlZCBieQorCSAqIGFub3RoZXIg
Y29udGV4dC4gVGhleSBnZXQgc2NoZWR1bGVkIHdpdGggdGhlaXIgZGVmYXVsdCBwcmlvcml0eSBh
bmQKKwkgKiBvbmNlIHRoZXkgcmVhY2ggdGhlIGV4ZWNsaXN0IHBvcnRzIHdlIGVuc3VyZSB0aGF0
IHRoZXkgc3RpY2sgb24gdGhlCisJICogSFcgdW50aWwgZmluaXNoZWQgYnkgcHJldGVuZGluZyB0
aGF0IHRoZXkgaGF2ZSBtYXhpbXVtIHByaW9yaXR5LAorCSAqIGkuZS4gbm90aGluZyBjYW4gaGF2
ZSBoaWdoZXIgcHJpb3JpdHkgYW5kIGZvcmNlIHVzIHRvIHVzdXJwIHRoZQorCSAqIGFjdGl2ZSBy
ZXF1ZXN0LgorCSAqLworCUk5MTVfUFJJT1JJVFlfVU5QUkVFTVBUQUJMRSA9IElOVF9NQVgsCisK
IAlJOTE1X1BSSU9SSVRZX0lOVkFMSUQgPSBJTlRfTUlOCiB9OwogCmRpZmYgLS1naXQgYS9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3JlcXVlc3QuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5
MTVfcmVxdWVzdC5jCmluZGV4IDVmZjg3YzRhMGNkNS4uMjIyYzljNTZlOWRlIDEwMDY0NAotLS0g
YS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3JlcXVlc3QuYworKysgYi9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9pOTE1X3JlcXVlc3QuYwpAQCAtMjkyLDcgKzI5Miw3IEBAIHN0YXRpYyBib29sIGk5
MTVfcmVxdWVzdF9yZXRpcmUoc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEpCiAJCWRtYV9mZW5jZV9z
aWduYWxfbG9ja2VkKCZycS0+ZmVuY2UpOwogCWlmICh0ZXN0X2JpdChETUFfRkVOQ0VfRkxBR19F
TkFCTEVfU0lHTkFMX0JJVCwgJnJxLT5mZW5jZS5mbGFncykpCiAJCWk5MTVfcmVxdWVzdF9jYW5j
ZWxfYnJlYWRjcnVtYihycSk7Ci0JaWYgKHJxLT53YWl0Ym9vc3QpIHsKKwlpZiAoaTkxNV9yZXF1
ZXN0X2hhc193YWl0Ym9vc3QocnEpKSB7CiAJCUdFTV9CVUdfT04oIWF0b21pY19yZWFkKCZycS0+
aTkxNS0+Z3RfcG0ucnBzLm51bV93YWl0ZXJzKSk7CiAJCWF0b21pY19kZWMoJnJxLT5pOTE1LT5n
dF9wbS5ycHMubnVtX3dhaXRlcnMpOwogCX0KQEAgLTY4NCw3ICs2ODQsNyBAQCBfX2k5MTVfcmVx
dWVzdF9jcmVhdGUoc3RydWN0IGludGVsX2NvbnRleHQgKmNlLCBnZnBfdCBnZnApCiAJcnEtPmZp
bGVfcHJpdiA9IE5VTEw7CiAJcnEtPmJhdGNoID0gTlVMTDsKIAlycS0+Y2FwdHVyZV9saXN0ID0g
TlVMTDsKLQlycS0+d2FpdGJvb3N0ID0gZmFsc2U7CisJcnEtPmZsYWdzID0gMDsKIAlycS0+ZXhl
Y3V0aW9uX21hc2sgPSBBTExfRU5HSU5FUzsKIAogCUlOSVRfTElTVF9IRUFEKCZycS0+YWN0aXZl
X2xpc3QpOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9yZXF1ZXN0Lmgg
Yi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3JlcXVlc3QuaAppbmRleCBiNThjZWVmOTJlMjAu
LjMxM2RmM2MzNzE1OCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9yZXF1
ZXN0LmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9yZXF1ZXN0LmgKQEAgLTIxNiw3
ICsyMTYsOSBAQCBzdHJ1Y3QgaTkxNV9yZXF1ZXN0IHsKIAkvKiogVGltZSBhdCB3aGljaCB0aGlz
IHJlcXVlc3Qgd2FzIGVtaXR0ZWQsIGluIGppZmZpZXMuICovCiAJdW5zaWduZWQgbG9uZyBlbWl0
dGVkX2ppZmZpZXM7CiAKLQlib29sIHdhaXRib29zdDsKKwl1bnNpZ25lZCBsb25nIGZsYWdzOwor
I2RlZmluZSBJOTE1X1JFUVVFU1RfV0FJVEJPT1NUIEJJVCgwKQorI2RlZmluZSBJOTE1X1JFUVVF
U1RfTk9QUkVFTVBUIEJJVCgxKQogCiAJLyoqIHRpbWVsaW5lLT5yZXF1ZXN0IGVudHJ5IGZvciB0
aGlzIHJlcXVlc3QgKi8KIAlzdHJ1Y3QgbGlzdF9oZWFkIGxpbms7CkBAIC00MzAsNiArNDMyLDE3
IEBAIHN0YXRpYyBpbmxpbmUgdm9pZCBpOTE1X3JlcXVlc3RfbWFya19jb21wbGV0ZShzdHJ1Y3Qg
aTkxNV9yZXF1ZXN0ICpycSkKIAlycS0+aHdzcF9zZXFubyA9ICh1MzIgKikmcnEtPmZlbmNlLnNl
cW5vOyAvKiBkZWNvdXBsZSBmcm9tIEhXU1AgKi8KIH0KIAorc3RhdGljIGlubGluZSBib29sIGk5
MTVfcmVxdWVzdF9oYXNfd2FpdGJvb3N0KGNvbnN0IHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxKQor
eworCXJldHVybiBycS0+ZmxhZ3MgJiBJOTE1X1JFUVVFU1RfV0FJVEJPT1NUOworfQorCitzdGF0
aWMgaW5saW5lIGJvb2wgaTkxNV9yZXF1ZXN0X2hhc19ub3ByZWVtcHQoY29uc3Qgc3RydWN0IGk5
MTVfcmVxdWVzdCAqcnEpCit7CisJLyogUHJlZW1wdGlvbiBzaG91bGQgb25seSBiZSBkaXNhYmxl
ZCB2ZXJ5IHJhcmVseSAqLworCXJldHVybiB1bmxpa2VseShycS0+ZmxhZ3MgJiBJOTE1X1JFUVVF
U1RfTk9QUkVFTVBUKTsKK30KKwogYm9vbCBpOTE1X3JldGlyZV9yZXF1ZXN0cyhzdHJ1Y3QgZHJt
X2k5MTVfcHJpdmF0ZSAqaTkxNSk7CiAKICNlbmRpZiAvKiBJOTE1X1JFUVVFU1RfSCAqLwpkaWZm
IC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfZ3VjX3N1Ym1pc3Npb24uYyBiL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2ludGVsX2d1Y19zdWJtaXNzaW9uLmMKaW5kZXggMTJjMjIzNTlm
ZGFjLi5mMTA0Yjk0YzE0ZWYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2ludGVs
X2d1Y19zdWJtaXNzaW9uLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfZ3VjX3N1
Ym1pc3Npb24uYwpAQCAtNzA3LDYgKzcwNywxNiBAQCBzdGF0aWMgaW5saW5lIGludCBycV9wcmlv
KGNvbnN0IHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxKQogCXJldHVybiBycS0+c2NoZWQuYXR0ci5w
cmlvcml0eSB8IF9fTk9fUFJFRU1QVElPTjsKIH0KIAorc3RhdGljIGlubGluZSBpbnQgZWZmZWN0
aXZlX3ByaW8oY29uc3Qgc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEpCit7CisJaW50IHByaW8gPSBy
cV9wcmlvKHJxKTsKKworCWlmIChpOTE1X3JlcXVlc3RfaGFzX25vcHJlZW1wdChycSkpCisJCXBy
aW8gPSBJOTE1X1BSSU9SSVRZX1VOUFJFRU1QVEFCTEU7CisKKwlyZXR1cm4gcHJpbzsKK30KKwog
c3RhdGljIHN0cnVjdCBpOTE1X3JlcXVlc3QgKnNjaGVkdWxlX2luKHN0cnVjdCBpOTE1X3JlcXVl
c3QgKnJxLCBpbnQgaWR4KQogewogCXRyYWNlX2k5MTVfcmVxdWVzdF9pbihycSwgaWR4KTsKQEAg
LTc0Nyw3ICs3NTcsOCBAQCBzdGF0aWMgdm9pZCBfX2d1Y19kZXF1ZXVlKHN0cnVjdCBpbnRlbF9l
bmdpbmVfY3MgKmVuZ2luZSkKIAkJCQkmZW5naW5lLT5pOTE1LT5ndWMucHJlZW1wdF93b3JrW2Vu
Z2luZS0+aWRdOwogCQkJaW50IHByaW8gPSBleGVjbGlzdHMtPnF1ZXVlX3ByaW9yaXR5X2hpbnQ7
CiAKLQkJCWlmIChpOTE1X3NjaGVkdWxlcl9uZWVkX3ByZWVtcHQocHJpbywgcnFfcHJpbyhsYXN0
KSkpIHsKKwkJCWlmIChpOTE1X3NjaGVkdWxlcl9uZWVkX3ByZWVtcHQocHJpbywKKwkJCQkJCQll
ZmZlY3RpdmVfcHJpbyhsYXN0KSkpIHsKIAkJCQlpbnRlbF93cml0ZV9zdGF0dXNfcGFnZShlbmdp
bmUsCiAJCQkJCQkJSTkxNV9HRU1fSFdTX1BSRUVNUFQsCiAJCQkJCQkJR1VDX1BSRUVNUFRfSU5Q
Uk9HUkVTUyk7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pbnRlbF9wbS5jIGIv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfcG0uYwppbmRleCA4NzI0NGQ4MjE1YTcuLjBjZWNl
YTIyODU0NiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfcG0uYworKysg
Yi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pbnRlbF9wbS5jCkBAIC02ODc2LDkgKzY4NzYsMTAgQEAg
dm9pZCBnZW42X3Jwc19ib29zdChzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSkKIAkvKiBTZXJpYWxp
emVzIHdpdGggaTkxNV9yZXF1ZXN0X3JldGlyZSgpICovCiAJYm9vc3QgPSBmYWxzZTsKIAlzcGlu
X2xvY2tfaXJxc2F2ZSgmcnEtPmxvY2ssIGZsYWdzKTsKLQlpZiAoIXJxLT53YWl0Ym9vc3QgJiYg
IWRtYV9mZW5jZV9pc19zaWduYWxlZF9sb2NrZWQoJnJxLT5mZW5jZSkpIHsKKwlpZiAoIWk5MTVf
cmVxdWVzdF9oYXNfd2FpdGJvb3N0KHJxKSAmJgorCSAgICAhZG1hX2ZlbmNlX2lzX3NpZ25hbGVk
X2xvY2tlZCgmcnEtPmZlbmNlKSkgewogCQlib29zdCA9ICFhdG9taWNfZmV0Y2hfaW5jKCZycHMt
Pm51bV93YWl0ZXJzKTsKLQkJcnEtPndhaXRib29zdCA9IHRydWU7CisJCXJxLT5mbGFncyB8PSBJ
OTE1X1JFUVVFU1RfV0FJVEJPT1NUOwogCX0KIAlzcGluX3VubG9ja19pcnFyZXN0b3JlKCZycS0+
bG9jaywgZmxhZ3MpOwogCWlmICghYm9vc3QpCi0tIAoyLjIyLjAKCl9fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50
ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9y
Zy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWdmeA==

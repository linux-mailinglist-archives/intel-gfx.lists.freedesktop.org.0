Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id C603E8CF78
	for <lists+intel-gfx@lfdr.de>; Wed, 14 Aug 2019 11:28:39 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id C67D489E3B;
	Wed, 14 Aug 2019 09:28:37 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 086BB89F0B
 for <intel-gfx@lists.freedesktop.org>; Wed, 14 Aug 2019 09:28:34 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18076221-1500050 
 for multiple; Wed, 14 Aug 2019 10:26:45 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Wed, 14 Aug 2019 10:26:40 +0100
Message-Id: <20190814092643.1908-5-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0.rc1
In-Reply-To: <20190814092643.1908-1-chris@chris-wilson.co.uk>
References: <20190814092643.1908-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 5/8] drm/i915: Protect request retirement with
 timeline->mutex
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

Rm9yZ28gdGhlIHN0cnVjdF9tdXRleCByZXF1aXJlbWVudCBmb3IgcmVxdWVzdCByZXRpcmVtZW50
IGFzIHdlIGhhdmUKYmVlbiB0cmFuc2l0aW9uaW5nIG92ZXIgdG8gb25seSB1c2luZyB0aGUgdGlt
ZWxpbmUtPm11dGV4IGZvcgpjb250cm9sbGluZyB0aGUgbGlmZXRpbWUgb2YgYSByZXF1ZXN0IG9u
IHRoYXQgdGltZWxpbmUuCgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNocmlzQGNocmlz
LXdpbHNvbi5jby51az4KLS0tCiAuLi4vZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9leGVjYnVm
ZmVyLmMgICAgfCAxODMgKysrKysrKysrKy0tLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9n
dC9pbnRlbF9jb250ZXh0LmggICAgICAgfCAgMTggKy0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0
L2ludGVsX2VuZ2luZV9jcy5jICAgICB8ICAgMSAtCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9p
bnRlbF9lbmdpbmVfdHlwZXMuaCAgfCAgIDMgLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50
ZWxfZ3QuYyAgICAgICAgICAgIHwgICAyIC0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVs
X2d0X3R5cGVzLmggICAgICB8ICAgMiAtCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9s
cmMuYyAgICAgICAgICAgfCAgIDEgKwogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfcmlu
Z2J1ZmZlci5jICAgIHwgIDE5ICstCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9tb2NrX2VuZ2lu
ZS5jICAgICAgICAgfCAgIDEgLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Qvc2VsZnRlc3RfY29u
dGV4dC5jICAgIHwgICA5ICstCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3JlcXVlc3QuYyAg
ICAgICAgICAgfCAxNTYgKysrKysrKy0tLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1
X3JlcXVlc3QuaCAgICAgICAgICAgfCAgIDMgLQogMTIgZmlsZXMgY2hhbmdlZCwgMjA5IGluc2Vy
dGlvbnMoKyksIDE4OSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9nZW0vaTkxNV9nZW1fZXhlY2J1ZmZlci5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2Vt
L2k5MTVfZ2VtX2V4ZWNidWZmZXIuYwppbmRleCA5MTUxMmNjNmQ3YTYuLjEyNjNiMDIwMTFmNCAx
MDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2V4ZWNidWZmZXIu
YworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fZXhlY2J1ZmZlci5jCkBA
IC03MzUsNjMgKzczNSw2IEBAIHN0YXRpYyBpbnQgZWJfc2VsZWN0X2NvbnRleHQoc3RydWN0IGk5
MTVfZXhlY2J1ZmZlciAqZWIpCiAJcmV0dXJuIDA7CiB9CiAKLXN0YXRpYyBzdHJ1Y3QgaTkxNV9y
ZXF1ZXN0ICpfX2ViX3dhaXRfZm9yX3Jpbmcoc3RydWN0IGludGVsX3JpbmcgKnJpbmcpCi17Ci0J
c3RydWN0IGk5MTVfcmVxdWVzdCAqcnE7Ci0KLQkvKgotCSAqIENvbXBsZXRlbHkgdW5zY2llbnRp
ZmljIGZpbmdlci1pbi10aGUtYWlyIGVzdGltYXRlcyBmb3Igc3VpdGFibGUKLQkgKiBtYXhpbXVt
IHVzZXIgcmVxdWVzdCBzaXplICh0byBhdm9pZCBibG9ja2luZykgYW5kIHRoZW4gYmFja29mZi4K
LQkgKi8KLQlpZiAoaW50ZWxfcmluZ191cGRhdGVfc3BhY2UocmluZykgPj0gUEFHRV9TSVpFKQot
CQlyZXR1cm4gTlVMTDsKLQotCS8qCi0JICogRmluZCBhIHJlcXVlc3QgdGhhdCBhZnRlciB3YWl0
aW5nIHVwb24sIHRoZXJlIHdpbGwgYmUgYXQgbGVhc3QgaGFsZgotCSAqIHRoZSByaW5nIGF2YWls
YWJsZS4gVGhlIGh5c3RlcmVzaXMgYWxsb3dzIHVzIHRvIGNvbXBldGUgZm9yIHRoZQotCSAqIHNo
YXJlZCByaW5nIGFuZCBzaG91bGQgbWVhbiB0aGF0IHdlIHNsZWVwIGxlc3Mgb2Z0ZW4gcHJpb3Ig
dG8KLQkgKiBjbGFpbWluZyBvdXIgcmVzb3VyY2VzLCBidXQgbm90IHNvIGxvbmcgdGhhdCB0aGUg
cmluZyBjb21wbGV0ZWx5Ci0JICogZHJhaW5zIGJlZm9yZSB3ZSBjYW4gc3VibWl0IG91ciBuZXh0
IHJlcXVlc3QuCi0JICovCi0JbGlzdF9mb3JfZWFjaF9lbnRyeShycSwgJnJpbmctPnJlcXVlc3Rf
bGlzdCwgcmluZ19saW5rKSB7Ci0JCWlmIChfX2ludGVsX3Jpbmdfc3BhY2UocnEtPnBvc3RmaXgs
Ci0JCQkJICAgICAgIHJpbmctPmVtaXQsIHJpbmctPnNpemUpID4gcmluZy0+c2l6ZSAvIDIpCi0J
CQlicmVhazsKLQl9Ci0JaWYgKCZycS0+cmluZ19saW5rID09ICZyaW5nLT5yZXF1ZXN0X2xpc3Qp
Ci0JCXJldHVybiBOVUxMOyAvKiB3ZWlyZCwgd2Ugd2lsbCBjaGVjayBhZ2FpbiBsYXRlciBmb3Ig
cmVhbCAqLwotCi0JcmV0dXJuIGk5MTVfcmVxdWVzdF9nZXQocnEpOwotfQotCi1zdGF0aWMgaW50
IGViX3dhaXRfZm9yX3JpbmcoY29uc3Qgc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIpCi17Ci0J
c3RydWN0IGk5MTVfcmVxdWVzdCAqcnE7Ci0JaW50IHJldCA9IDA7Ci0KLQkvKgotCSAqIEFwcGx5
IGEgbGlnaHQgYW1vdW50IG9mIGJhY2twcmVzc3VyZSB0byBwcmV2ZW50IGV4Y2Vzc2l2ZSBob2dz
Ci0JICogZnJvbSBibG9ja2luZyB3YWl0aW5nIGZvciBzcGFjZSB3aGlsc3QgaG9sZGluZyBzdHJ1
Y3RfbXV0ZXggYW5kCi0JICoga2VlcGluZyBhbGwgb2YgdGhlaXIgcmVzb3VyY2VzIHBpbm5lZC4K
LQkgKi8KLQotCXJxID0gX19lYl93YWl0X2Zvcl9yaW5nKGViLT5jb250ZXh0LT5yaW5nKTsKLQlp
ZiAocnEpIHsKLQkJbXV0ZXhfdW5sb2NrKCZlYi0+aTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7Ci0K
LQkJaWYgKGk5MTVfcmVxdWVzdF93YWl0KHJxLAotCQkJCSAgICAgIEk5MTVfV0FJVF9JTlRFUlJV
UFRJQkxFLAotCQkJCSAgICAgIE1BWF9TQ0hFRFVMRV9USU1FT1VUKSA8IDApCi0JCQlyZXQgPSAt
RUlOVFI7Ci0KLQkJaTkxNV9yZXF1ZXN0X3B1dChycSk7Ci0KLQkJbXV0ZXhfbG9jaygmZWItPmk5
MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOwotCX0KLQotCXJldHVybiByZXQ7Ci19Ci0KIHN0YXRpYyBp
bnQgZWJfbG9va3VwX3ZtYXMoc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIpCiB7CiAJc3RydWN0
IHJhZGl4X3RyZWVfcm9vdCAqaGFuZGxlc192bWEgPSAmZWItPmdlbV9jb250ZXh0LT5oYW5kbGVz
X3ZtYTsKQEAgLTIxMzIsMTAgKzIwNzUsNzUgQEAgc3RhdGljIGNvbnN0IGVudW0gaW50ZWxfZW5n
aW5lX2lkIHVzZXJfcmluZ19tYXBbXSA9IHsKIAlbSTkxNV9FWEVDX1ZFQk9YXQk9IFZFQ1MwCiB9
OwogCi1zdGF0aWMgaW50IGViX3Bpbl9jb250ZXh0KHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmVi
LCBzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UpCitzdGF0aWMgc3RydWN0IGk5MTVfcmVxdWVzdCAq
ZWJfdGhyb3R0bGUoc3RydWN0IGludGVsX2NvbnRleHQgKmNlKQoreworCXN0cnVjdCBpbnRlbF9y
aW5nICpyaW5nID0gY2UtPnJpbmc7CisJc3RydWN0IGludGVsX3RpbWVsaW5lICp0bCA9IGNlLT50
aW1lbGluZTsKKwlzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycTsKKworCS8qCisJICogQ29tcGxldGVs
eSB1bnNjaWVudGlmaWMgZmluZ2VyLWluLXRoZS1haXIgZXN0aW1hdGVzIGZvciBzdWl0YWJsZQor
CSAqIG1heGltdW0gdXNlciByZXF1ZXN0IHNpemUgKHRvIGF2b2lkIGJsb2NraW5nKSBhbmQgdGhl
biBiYWNrb2ZmLgorCSAqLworCWlmIChpbnRlbF9yaW5nX3VwZGF0ZV9zcGFjZShyaW5nKSA+PSBQ
QUdFX1NJWkUpCisJCXJldHVybiBOVUxMOworCisJLyoKKwkgKiBGaW5kIGEgcmVxdWVzdCB0aGF0
IGFmdGVyIHdhaXRpbmcgdXBvbiwgdGhlcmUgd2lsbCBiZSBhdCBsZWFzdCBoYWxmCisJICogdGhl
IHJpbmcgYXZhaWxhYmxlLiBUaGUgaHlzdGVyZXNpcyBhbGxvd3MgdXMgdG8gY29tcGV0ZSBmb3Ig
dGhlCisJICogc2hhcmVkIHJpbmcgYW5kIHNob3VsZCBtZWFuIHRoYXQgd2Ugc2xlZXAgbGVzcyBv
ZnRlbiBwcmlvciB0bworCSAqIGNsYWltaW5nIG91ciByZXNvdXJjZXMsIGJ1dCBub3Qgc28gbG9u
ZyB0aGF0IHRoZSByaW5nIGNvbXBsZXRlbHkKKwkgKiBkcmFpbnMgYmVmb3JlIHdlIGNhbiBzdWJt
aXQgb3VyIG5leHQgcmVxdWVzdC4KKwkgKi8KKwlsaXN0X2Zvcl9lYWNoX2VudHJ5KHJxLCAmdGwt
PnJlcXVlc3RzLCBsaW5rKSB7CisJCWlmIChycS0+cmluZyAhPSByaW5nKQorCQkJY29udGludWU7
CisKKwkJaWYgKF9faW50ZWxfcmluZ19zcGFjZShycS0+cG9zdGZpeCwKKwkJCQkgICAgICAgcmlu
Zy0+ZW1pdCwgcmluZy0+c2l6ZSkgPiByaW5nLT5zaXplIC8gMikKKwkJCWJyZWFrOworCX0KKwlp
ZiAoJnJxLT5saW5rID09ICZ0bC0+cmVxdWVzdHMpCisJCXJldHVybiBOVUxMOyAvKiB3ZWlyZCwg
d2Ugd2lsbCBjaGVjayBhZ2FpbiBsYXRlciBmb3IgcmVhbCAqLworCisJcmV0dXJuIGk5MTVfcmVx
dWVzdF9nZXQocnEpOworfQorCitzdGF0aWMgaW50CitfX2ViX3Bpbl9jb250ZXh0KHN0cnVjdCBp
OTE1X2V4ZWNidWZmZXIgKmViLCBzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UpCiB7CiAJaW50IGVy
cjsKIAorCWlmIChsaWtlbHkoYXRvbWljX2luY19ub3RfemVybygmY2UtPnBpbl9jb3VudCkpKQor
CQlyZXR1cm4gMDsKKworCWVyciA9IG11dGV4X2xvY2tfaW50ZXJydXB0aWJsZSgmZWItPmk5MTUt
PmRybS5zdHJ1Y3RfbXV0ZXgpOworCWlmIChlcnIpCisJCXJldHVybiBlcnI7CisKKwllcnIgPSBf
X2ludGVsX2NvbnRleHRfZG9fcGluKGNlKTsKKwltdXRleF91bmxvY2soJmViLT5pOTE1LT5kcm0u
c3RydWN0X211dGV4KTsKKworCXJldHVybiBlcnI7Cit9CisKK3N0YXRpYyB2b2lkCitfX2ViX3Vu
cGluX2NvbnRleHQoc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIsIHN0cnVjdCBpbnRlbF9jb250
ZXh0ICpjZSkKK3sKKwlpZiAobGlrZWx5KGF0b21pY19hZGRfdW5sZXNzKCZjZS0+cGluX2NvdW50
LCAtMSwgMSkpKQorCQlyZXR1cm47CisKKwltdXRleF9sb2NrKCZlYi0+aTkxNS0+ZHJtLnN0cnVj
dF9tdXRleCk7CisJaW50ZWxfY29udGV4dF91bnBpbihjZSk7CisJbXV0ZXhfdW5sb2NrKCZlYi0+
aTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7Cit9CisKK3N0YXRpYyBpbnQgX19lYl9waW5fZW5naW5l
KHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViLCBzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UpCit7
CisJc3RydWN0IGludGVsX3RpbWVsaW5lICp0bDsKKwlzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycTsK
KwlpbnQgZXJyOworCiAJLyoKIAkgKiBBQkk6IEJlZm9yZSB1c2Vyc3BhY2UgYWNjZXNzZXMgdGhl
IEdQVSAoZS5nLiBleGVjYnVmZmVyKSwgcmVwb3J0CiAJICogRUlPIGlmIHRoZSBHUFUgaXMgYWxy
ZWFkeSB3ZWRnZWQuCkBAIC0yMTQ5LDcgKzIxNTcsNyBAQCBzdGF0aWMgaW50IGViX3Bpbl9jb250
ZXh0KHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViLCBzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2Up
CiAJICogR0dUVCBzcGFjZSwgc28gZG8gdGhpcyBmaXJzdCBiZWZvcmUgd2UgcmVzZXJ2ZSBhIHNl
cW5vIGZvcgogCSAqIG91cnNlbHZlcy4KIAkgKi8KLQllcnIgPSBpbnRlbF9jb250ZXh0X3Bpbihj
ZSk7CisJZXJyID0gX19lYl9waW5fY29udGV4dChlYiwgY2UpOwogCWlmIChlcnIpCiAJCXJldHVy
biBlcnI7CiAKQEAgLTIxNjEsMjMgKzIxNjksNDMgQEAgc3RhdGljIGludCBlYl9waW5fY29udGV4
dChzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYiwgc3RydWN0IGludGVsX2NvbnRleHQgKmNlKQog
CSAqIHVudGlsIHRoZSB0aW1lbGluZSBpcyBpZGxlLCB3aGljaCBpbiB0dXJuIHJlbGVhc2VzIHRo
ZSB3YWtlcmVmCiAJICogdGFrZW4gb24gdGhlIGVuZ2luZSwgYW5kIHRoZSBwYXJlbnQgZGV2aWNl
LgogCSAqLwotCWVyciA9IGludGVsX2NvbnRleHRfdGltZWxpbmVfbG9jayhjZSk7Ci0JaWYgKGVy
cikKKwl0bCA9IGludGVsX2NvbnRleHRfdGltZWxpbmVfbG9jayhjZSk7CisJaWYgKElTX0VSUih0
bCkpIHsKKwkJZXJyID0gUFRSX0VSUih0bCk7CiAJCWdvdG8gZXJyX3VucGluOworCX0KIAogCWlu
dGVsX2NvbnRleHRfZW50ZXIoY2UpOwotCWludGVsX2NvbnRleHRfdGltZWxpbmVfdW5sb2NrKGNl
KTsKKwlycSA9IGViX3Rocm90dGxlKGNlKTsKKworCWludGVsX2NvbnRleHRfdGltZWxpbmVfdW5s
b2NrKHRsKTsKKworCWlmIChycSkgeworCQlpZiAoaTkxNV9yZXF1ZXN0X3dhaXQocnEsCisJCQkJ
ICAgICAgSTkxNV9XQUlUX0lOVEVSUlVQVElCTEUsCisJCQkJICAgICAgTUFYX1NDSEVEVUxFX1RJ
TUVPVVQpIDwgMCkgeworCQkJaTkxNV9yZXF1ZXN0X3B1dChycSk7CisJCQllcnIgPSAtRUlOVFI7
CisJCQlnb3RvIGVycl9leGl0OworCQl9CisKKwkJaTkxNV9yZXF1ZXN0X3B1dChycSk7CisJfQog
CiAJZWItPmVuZ2luZSA9IGNlLT5lbmdpbmU7CiAJZWItPmNvbnRleHQgPSBjZTsKIAlyZXR1cm4g
MDsKIAorZXJyX2V4aXQ6CisJbXV0ZXhfbG9jaygmdGwtPm11dGV4KTsKKwlpbnRlbF9jb250ZXh0
X2V4aXQoY2UpOworCWludGVsX2NvbnRleHRfdGltZWxpbmVfdW5sb2NrKHRsKTsKIGVycl91bnBp
bjoKLQlpbnRlbF9jb250ZXh0X3VucGluKGNlKTsKKwlfX2ViX3VucGluX2NvbnRleHQoZWIsIGNl
KTsKIAlyZXR1cm4gZXJyOwogfQogCi1zdGF0aWMgdm9pZCBlYl91bnBpbl9jb250ZXh0KHN0cnVj
dCBpOTE1X2V4ZWNidWZmZXIgKmViKQorc3RhdGljIHZvaWQgZWJfdW5waW5fZW5naW5lKHN0cnVj
dCBpOTE1X2V4ZWNidWZmZXIgKmViKQogewogCXN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSA9IGVi
LT5jb250ZXh0OwogCXN0cnVjdCBpbnRlbF90aW1lbGluZSAqdGwgPSBjZS0+dGltZWxpbmU7CkBA
IC0yMTg2LDcgKzIyMTQsNyBAQCBzdGF0aWMgdm9pZCBlYl91bnBpbl9jb250ZXh0KHN0cnVjdCBp
OTE1X2V4ZWNidWZmZXIgKmViKQogCWludGVsX2NvbnRleHRfZXhpdChjZSk7CiAJbXV0ZXhfdW5s
b2NrKCZ0bC0+bXV0ZXgpOwogCi0JaW50ZWxfY29udGV4dF91bnBpbihjZSk7CisJX19lYl91bnBp
bl9jb250ZXh0KGViLCBjZSk7CiB9CiAKIHN0YXRpYyB1bnNpZ25lZCBpbnQKQEAgLTIyMzEsOSAr
MjI1OSw5IEBAIGViX3NlbGVjdF9sZWdhY3lfcmluZyhzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICpl
YiwKIH0KIAogc3RhdGljIGludAotZWJfc2VsZWN0X2VuZ2luZShzdHJ1Y3QgaTkxNV9leGVjYnVm
ZmVyICplYiwKLQkJIHN0cnVjdCBkcm1fZmlsZSAqZmlsZSwKLQkJIHN0cnVjdCBkcm1faTkxNV9n
ZW1fZXhlY2J1ZmZlcjIgKmFyZ3MpCitlYl9waW5fZW5naW5lKHN0cnVjdCBpOTE1X2V4ZWNidWZm
ZXIgKmViLAorCSAgICAgIHN0cnVjdCBkcm1fZmlsZSAqZmlsZSwKKwkgICAgICBzdHJ1Y3QgZHJt
X2k5MTVfZ2VtX2V4ZWNidWZmZXIyICphcmdzKQogewogCXN0cnVjdCBpbnRlbF9jb250ZXh0ICpj
ZTsKIAl1bnNpZ25lZCBpbnQgaWR4OwpAQCAtMjI0OCw3ICsyMjc2LDcgQEAgZWJfc2VsZWN0X2Vu
Z2luZShzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYiwKIAlpZiAoSVNfRVJSKGNlKSkKIAkJcmV0
dXJuIFBUUl9FUlIoY2UpOwogCi0JZXJyID0gZWJfcGluX2NvbnRleHQoZWIsIGNlKTsKKwllcnIg
PSBfX2ViX3Bpbl9lbmdpbmUoZWIsIGNlKTsKIAlpbnRlbF9jb250ZXh0X3B1dChjZSk7CiAKIAly
ZXR1cm4gZXJyOwpAQCAtMjQ2NiwxNiArMjQ5NCwxMiBAQCBpOTE1X2dlbV9kb19leGVjYnVmZmVy
KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsCiAJaWYgKHVubGlrZWx5KGVycikpCiAJCWdvdG8gZXJy
X2Rlc3Ryb3k7CiAKLQllcnIgPSBpOTE1X211dGV4X2xvY2tfaW50ZXJydXB0aWJsZShkZXYpOwot
CWlmIChlcnIpCi0JCWdvdG8gZXJyX2NvbnRleHQ7Ci0KLQllcnIgPSBlYl9zZWxlY3RfZW5naW5l
KCZlYiwgZmlsZSwgYXJncyk7CisJZXJyID0gZWJfcGluX2VuZ2luZSgmZWIsIGZpbGUsIGFyZ3Mp
OwogCWlmICh1bmxpa2VseShlcnIpKQotCQlnb3RvIGVycl91bmxvY2s7CisJCWdvdG8gZXJyX2Nv
bnRleHQ7CiAKLQllcnIgPSBlYl93YWl0X2Zvcl9yaW5nKCZlYik7IC8qIG1heSB0ZW1wb3Jhcmls
eSBkcm9wIHN0cnVjdF9tdXRleCAqLwotCWlmICh1bmxpa2VseShlcnIpKQorCWVyciA9IGk5MTVf
bXV0ZXhfbG9ja19pbnRlcnJ1cHRpYmxlKGRldik7CisJaWYgKGVycikKIAkJZ290byBlcnJfZW5n
aW5lOwogCiAJZXJyID0gZWJfcmVsb2NhdGUoJmViKTsKQEAgLTI2MzMsMTAgKzI2NTcsOSBAQCBp
OTE1X2dlbV9kb19leGVjYnVmZmVyKHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsCiBlcnJfdm1hOgog
CWlmIChlYi5leGVjKQogCQllYl9yZWxlYXNlX3ZtYXMoJmViKTsKLWVycl9lbmdpbmU6Ci0JZWJf
dW5waW5fY29udGV4dCgmZWIpOwotZXJyX3VubG9jazoKIAltdXRleF91bmxvY2soJmRldi0+c3Ry
dWN0X211dGV4KTsKK2Vycl9lbmdpbmU6CisJZWJfdW5waW5fZW5naW5lKCZlYik7CiBlcnJfY29u
dGV4dDoKIAlpOTE1X2dlbV9jb250ZXh0X3B1dChlYi5nZW1fY29udGV4dCk7CiBlcnJfZGVzdHJv
eToKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2NvbnRleHQuaCBi
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2NvbnRleHQuaAppbmRleCA5ZmE4YjU4OGYx
OGUuLjA1M2ExMzA3ZWNiNCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50
ZWxfY29udGV4dC5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2NvbnRleHQu
aApAQCAtMTIsNiArMTIsNyBAQAogI2luY2x1ZGUgImk5MTVfYWN0aXZlLmgiCiAjaW5jbHVkZSAi
aW50ZWxfY29udGV4dF90eXBlcy5oIgogI2luY2x1ZGUgImludGVsX2VuZ2luZV90eXBlcy5oIgor
I2luY2x1ZGUgImludGVsX3RpbWVsaW5lX3R5cGVzLmgiCiAKIHZvaWQgaW50ZWxfY29udGV4dF9p
bml0KHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSwKIAkJCXN0cnVjdCBpOTE1X2dlbV9jb250ZXh0
ICpjdHgsCkBAIC0xMTgsMTcgKzExOSwyNCBAQCBzdGF0aWMgaW5saW5lIHZvaWQgaW50ZWxfY29u
dGV4dF9wdXQoc3RydWN0IGludGVsX2NvbnRleHQgKmNlKQogCWtyZWZfcHV0KCZjZS0+cmVmLCBj
ZS0+b3BzLT5kZXN0cm95KTsKIH0KIAotc3RhdGljIGlubGluZSBpbnQgX19tdXN0X2NoZWNrCitz
dGF0aWMgaW5saW5lIHN0cnVjdCBpbnRlbF90aW1lbGluZSAqX19tdXN0X2NoZWNrCiBpbnRlbF9j
b250ZXh0X3RpbWVsaW5lX2xvY2soc3RydWN0IGludGVsX2NvbnRleHQgKmNlKQogCV9fYWNxdWly
ZXMoJmNlLT50aW1lbGluZS0+bXV0ZXgpCiB7Ci0JcmV0dXJuIG11dGV4X2xvY2tfaW50ZXJydXB0
aWJsZSgmY2UtPnRpbWVsaW5lLT5tdXRleCk7CisJc3RydWN0IGludGVsX3RpbWVsaW5lICp0bCA9
IGNlLT50aW1lbGluZTsKKwlpbnQgZXJyOworCisJZXJyID0gbXV0ZXhfbG9ja19pbnRlcnJ1cHRp
YmxlKCZ0bC0+bXV0ZXgpOworCWlmIChlcnIpCisJCXJldHVybiBFUlJfUFRSKGVycik7CisKKwly
ZXR1cm4gdGw7CiB9CiAKLXN0YXRpYyBpbmxpbmUgdm9pZCBpbnRlbF9jb250ZXh0X3RpbWVsaW5l
X3VubG9jayhzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UpCi0JX19yZWxlYXNlcygmY2UtPnRpbWVs
aW5lLT5tdXRleCkKK3N0YXRpYyBpbmxpbmUgdm9pZCBpbnRlbF9jb250ZXh0X3RpbWVsaW5lX3Vu
bG9jayhzdHJ1Y3QgaW50ZWxfdGltZWxpbmUgKnRsKQorCV9fcmVsZWFzZXMoJnRsLT5tdXRleCkK
IHsKLQltdXRleF91bmxvY2soJmNlLT50aW1lbGluZS0+bXV0ZXgpOworCW11dGV4X3VubG9jaygm
dGwtPm11dGV4KTsKIH0KIAogaW50IGludGVsX2NvbnRleHRfcHJlcGFyZV9yZW1vdGVfcmVxdWVz
dChzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UsCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9ndC9pbnRlbF9lbmdpbmVfY3MuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVs
X2VuZ2luZV9jcy5jCmluZGV4IGFiZDRmZGUyZTUyZC4uYmE0NTdjMWM3ZGMwIDEwMDY0NAotLS0g
YS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfY3MuYworKysgYi9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfY3MuYwpAQCAtNjc5LDcgKzY3OSw2IEBAIHN0
YXRpYyBpbnQgbWVhc3VyZV9icmVhZGNydW1iX2R3KHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVu
Z2luZSkKIAkJCQllbmdpbmUtPnN0YXR1c19wYWdlLnZtYSkpCiAJCWdvdG8gb3V0X2ZyYW1lOwog
Ci0JSU5JVF9MSVNUX0hFQUQoJmZyYW1lLT5yaW5nLnJlcXVlc3RfbGlzdCk7CiAJZnJhbWUtPnJp
bmcudmFkZHIgPSBmcmFtZS0+Y3M7CiAJZnJhbWUtPnJpbmcuc2l6ZSA9IHNpemVvZihmcmFtZS0+
Y3MpOwogCWZyYW1lLT5yaW5nLmVmZmVjdGl2ZV9zaXplID0gZnJhbWUtPnJpbmcuc2l6ZTsKZGlm
ZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZV90eXBlcy5oIGIv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZW5naW5lX3R5cGVzLmgKaW5kZXggYTBmMzcy
ODA3ZGQ0Li45OTY1YTMyNjAxZDYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0
L2ludGVsX2VuZ2luZV90eXBlcy5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVs
X2VuZ2luZV90eXBlcy5oCkBAIC02OSw5ICs2OSw2IEBAIHN0cnVjdCBpbnRlbF9yaW5nIHsKIAlz
dHJ1Y3QgaTkxNV92bWEgKnZtYTsKIAl2b2lkICp2YWRkcjsKIAotCXN0cnVjdCBsaXN0X2hlYWQg
cmVxdWVzdF9saXN0OwotCXN0cnVjdCBsaXN0X2hlYWQgYWN0aXZlX2xpbms7Ci0KIAkvKgogCSAq
IEFzIHdlIGhhdmUgdHdvIHR5cGVzIG9mIHJpbmdzLCBvbmUgZ2xvYmFsIHRvIHRoZSBlbmdpbmUg
dXNlZAogCSAqIGJ5IHJpbmdidWZmZXIgc3VibWlzc2lvbiBhbmQgdGhvc2UgdGhhdCBhcmUgZXhj
bHVzaXZlIHRvIGEKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2d0
LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9ndC5jCmluZGV4IDkxNGJkMmRiM2Jj
Ny4uZDQ4ZWM5YTc2ZWQxIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRl
bF9ndC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2d0LmMKQEAgLTE1LDgg
KzE1LDYgQEAgdm9pZCBpbnRlbF9ndF9pbml0X2Vhcmx5KHN0cnVjdCBpbnRlbF9ndCAqZ3QsIHN0
cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQogCiAJc3Bpbl9sb2NrX2luaXQoJmd0LT5pcnFf
bG9jayk7CiAKLQlJTklUX0xJU1RfSEVBRCgmZ3QtPmFjdGl2ZV9yaW5ncyk7Ci0KIAlJTklUX0xJ
U1RfSEVBRCgmZ3QtPmNsb3NlZF92bWEpOwogCXNwaW5fbG9ja19pbml0KCZndC0+Y2xvc2VkX2xv
Y2spOwogCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9ndF90eXBl
cy5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZ3RfdHlwZXMuaAppbmRleCAxNDNi
MmQ3OGMyY2MuLmY4ODJlMmNmMTU5YyAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUv
Z3QvaW50ZWxfZ3RfdHlwZXMuaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9n
dF90eXBlcy5oCkBAIC00OCw4ICs0OCw2IEBAIHN0cnVjdCBpbnRlbF9ndCB7CiAJCXN0cnVjdCBs
aXN0X2hlYWQgaHdzcF9mcmVlX2xpc3Q7CiAJfSB0aW1lbGluZXM7CiAKLQlzdHJ1Y3QgbGlzdF9o
ZWFkIGFjdGl2ZV9yaW5nczsKLQogCXN0cnVjdCBpbnRlbF93YWtlcmVmIHdha2VyZWY7CiAKIAlz
dHJ1Y3QgbGlzdF9oZWFkIGNsb3NlZF92bWE7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9ndC9pbnRlbF9scmMuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2xyYy5j
CmluZGV4IDExNmQ3YjNmOTQ2Yi4uNTY1NTY3Y2FlZDZmIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9ndC9pbnRlbF9scmMuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9p
bnRlbF9scmMuYwpAQCAtMTYxOSw2ICsxNjE5LDcgQEAgc3RhdGljIHZvaWQgZXhlY2xpc3RzX2Nv
bnRleHRfdW5waW4oc3RydWN0IGludGVsX2NvbnRleHQgKmNlKQogewogCWk5MTVfZ2VtX2NvbnRl
eHRfdW5waW5faHdfaWQoY2UtPmdlbV9jb250ZXh0KTsKIAlpOTE1X2dlbV9vYmplY3RfdW5waW5f
bWFwKGNlLT5zdGF0ZS0+b2JqKTsKKwlpbnRlbF9yaW5nX3Jlc2V0KGNlLT5yaW5nLCBjZS0+cmlu
Zy0+dGFpbCk7CiB9CiAKIHN0YXRpYyB2b2lkCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9ndC9pbnRlbF9yaW5nYnVmZmVyLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRl
bF9yaW5nYnVmZmVyLmMKaW5kZXggNDA5ZDc2NGY4YzZkLi4xZDljMTI1Yjc2ZDAgMTAwNjQ0Ci0t
LSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX3JpbmdidWZmZXIuYworKysgYi9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9yaW5nYnVmZmVyLmMKQEAgLTEyNTAsNyArMTI1MCw3
IEBAIHZvaWQgaW50ZWxfcmluZ191bnBpbihzdHJ1Y3QgaW50ZWxfcmluZyAqcmluZykKIAkJcmV0
dXJuOwogCiAJLyogRGlzY2FyZCBhbnkgdW51c2VkIGJ5dGVzIGJleW9uZCB0aGF0IHN1Ym1pdHRl
ZCB0byBody4gKi8KLQlpbnRlbF9yaW5nX3Jlc2V0KHJpbmcsIHJpbmctPnRhaWwpOworCWludGVs
X3JpbmdfcmVzZXQocmluZywgcmluZy0+ZW1pdCk7CiAKIAlpOTE1X3ZtYV91bnNldF9nZ3R0X3dy
aXRlKHZtYSk7CiAJaWYgKGk5MTVfdm1hX2lzX21hcF9hbmRfZmVuY2VhYmxlKHZtYSkpCkBAIC0x
MzExLDcgKzEzMTEsNiBAQCBpbnRlbF9lbmdpbmVfY3JlYXRlX3Jpbmcoc3RydWN0IGludGVsX2Vu
Z2luZV9jcyAqZW5naW5lLCBpbnQgc2l6ZSkKIAkJcmV0dXJuIEVSUl9QVFIoLUVOT01FTSk7CiAK
IAlrcmVmX2luaXQoJnJpbmctPnJlZik7Ci0JSU5JVF9MSVNUX0hFQUQoJnJpbmctPnJlcXVlc3Rf
bGlzdCk7CiAKIAlyaW5nLT5zaXplID0gc2l6ZTsKIAkvKiBXb3JrYXJvdW5kIGFuIGVycmF0dW0g
b24gdGhlIGk4MzAgd2hpY2ggY2F1c2VzIGEgaGFuZyBpZgpAQCAtMTg2NSw3ICsxODY0LDEwIEBA
IHN0YXRpYyBpbnQgcmluZ19yZXF1ZXN0X2FsbG9jKHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJlcXVl
c3QpCiAJcmV0dXJuIDA7CiB9CiAKLXN0YXRpYyBub2lubGluZSBpbnQgd2FpdF9mb3Jfc3BhY2Uo
c3RydWN0IGludGVsX3JpbmcgKnJpbmcsIHVuc2lnbmVkIGludCBieXRlcykKK3N0YXRpYyBub2lu
bGluZSBpbnQKK3dhaXRfZm9yX3NwYWNlKHN0cnVjdCBpbnRlbF9yaW5nICpyaW5nLAorCSAgICAg
ICBzdHJ1Y3QgaW50ZWxfdGltZWxpbmUgKnRsLAorCSAgICAgICB1bnNpZ25lZCBpbnQgYnl0ZXMp
CiB7CiAJc3RydWN0IGk5MTVfcmVxdWVzdCAqdGFyZ2V0OwogCWxvbmcgdGltZW91dDsKQEAgLTE4
NzMsMTUgKzE4NzUsMTggQEAgc3RhdGljIG5vaW5saW5lIGludCB3YWl0X2Zvcl9zcGFjZShzdHJ1
Y3QgaW50ZWxfcmluZyAqcmluZywgdW5zaWduZWQgaW50IGJ5dGVzKQogCWlmIChpbnRlbF9yaW5n
X3VwZGF0ZV9zcGFjZShyaW5nKSA+PSBieXRlcykKIAkJcmV0dXJuIDA7CiAKLQlHRU1fQlVHX09O
KGxpc3RfZW1wdHkoJnJpbmctPnJlcXVlc3RfbGlzdCkpOwotCWxpc3RfZm9yX2VhY2hfZW50cnko
dGFyZ2V0LCAmcmluZy0+cmVxdWVzdF9saXN0LCByaW5nX2xpbmspIHsKKwlHRU1fQlVHX09OKGxp
c3RfZW1wdHkoJnRsLT5yZXF1ZXN0cykpOworCWxpc3RfZm9yX2VhY2hfZW50cnkodGFyZ2V0LCAm
dGwtPnJlcXVlc3RzLCBsaW5rKSB7CisJCWlmICh0YXJnZXQtPnJpbmcgIT0gcmluZykKKwkJCWNv
bnRpbnVlOworCiAJCS8qIFdvdWxkIGNvbXBsZXRpb24gb2YgdGhpcyByZXF1ZXN0IGZyZWUgZW5v
dWdoIHNwYWNlPyAqLwogCQlpZiAoYnl0ZXMgPD0gX19pbnRlbF9yaW5nX3NwYWNlKHRhcmdldC0+
cG9zdGZpeCwKIAkJCQkJCXJpbmctPmVtaXQsIHJpbmctPnNpemUpKQogCQkJYnJlYWs7CiAJfQog
Ci0JaWYgKFdBUk5fT04oJnRhcmdldC0+cmluZ19saW5rID09ICZyaW5nLT5yZXF1ZXN0X2xpc3Qp
KQorCWlmIChHRU1fV0FSTl9PTigmdGFyZ2V0LT5saW5rID09ICZ0bC0+cmVxdWVzdHMpKQogCQly
ZXR1cm4gLUVOT1NQQzsKIAogCXRpbWVvdXQgPSBpOTE1X3JlcXVlc3Rfd2FpdCh0YXJnZXQsCkBA
IC0xOTQ4LDcgKzE5NTMsNyBAQCB1MzIgKmludGVsX3JpbmdfYmVnaW4oc3RydWN0IGk5MTVfcmVx
dWVzdCAqcnEsIHVuc2lnbmVkIGludCBudW1fZHdvcmRzKQogCQkgKi8KIAkJR0VNX0JVR19PTigh
cnEtPnJlc2VydmVkX3NwYWNlKTsKIAotCQlyZXQgPSB3YWl0X2Zvcl9zcGFjZShyaW5nLCB0b3Rh
bF9ieXRlcyk7CisJCXJldCA9IHdhaXRfZm9yX3NwYWNlKHJpbmcsIHJxLT50aW1lbGluZSwgdG90
YWxfYnl0ZXMpOwogCQlpZiAodW5saWtlbHkocmV0KSkKIAkJCXJldHVybiBFUlJfUFRSKHJldCk7
CiAJfQpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvbW9ja19lbmdpbmUuYyBi
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L21vY2tfZW5naW5lLmMKaW5kZXggNTRhMTFkZGUzMDc2
Li41ZDQzY2JjM2YzNDUgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L21vY2tf
ZW5naW5lLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvbW9ja19lbmdpbmUuYwpAQCAt
NTgsNyArNTgsNiBAQCBzdGF0aWMgc3RydWN0IGludGVsX3JpbmcgKm1vY2tfcmluZyhzdHJ1Y3Qg
aW50ZWxfZW5naW5lX2NzICplbmdpbmUpCiAJcmluZy0+dmFkZHIgPSAodm9pZCAqKShyaW5nICsg
MSk7CiAJYXRvbWljX3NldCgmcmluZy0+cGluX2NvdW50LCAxKTsKIAotCUlOSVRfTElTVF9IRUFE
KCZyaW5nLT5yZXF1ZXN0X2xpc3QpOwogCWludGVsX3JpbmdfdXBkYXRlX3NwYWNlKHJpbmcpOwog
CiAJcmV0dXJuIHJpbmc7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxm
dGVzdF9jb250ZXh0LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVzdF9jb250ZXh0
LmMKaW5kZXggZGE5YzQ5ZTJhZGFmLi42ZmJjNzJiYzI5MGUgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2d0L3NlbGZ0ZXN0X2NvbnRleHQuYworKysgYi9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9ndC9zZWxmdGVzdF9jb250ZXh0LmMKQEAgLTIwLDEwICsyMCwxMyBAQCBzdGF0aWMgaW50
IHJlcXVlc3Rfc3luYyhzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSkKIAogCWk5MTVfcmVxdWVzdF9h
ZGQocnEpOwogCXRpbWVvdXQgPSBpOTE1X3JlcXVlc3Rfd2FpdChycSwgMCwgSFogLyAxMCk7Ci0J
aWYgKHRpbWVvdXQgPCAwKQorCWlmICh0aW1lb3V0IDwgMCkgewogCQllcnIgPSB0aW1lb3V0Owot
CWVsc2UKKwl9IGVsc2UgeworCQltdXRleF9sb2NrKCZycS0+dGltZWxpbmUtPm11dGV4KTsKIAkJ
aTkxNV9yZXF1ZXN0X3JldGlyZV91cHRvKHJxKTsKKwkJbXV0ZXhfdW5sb2NrKCZycS0+dGltZWxp
bmUtPm11dGV4KTsKKwl9CiAKIAlpOTE1X3JlcXVlc3RfcHV0KHJxKTsKIApAQCAtMzUsNiArMzgs
NyBAQCBzdGF0aWMgaW50IGNvbnRleHRfc3luYyhzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UpCiAJ
c3RydWN0IGludGVsX3RpbWVsaW5lICp0bCA9IGNlLT50aW1lbGluZTsKIAlpbnQgZXJyID0gMDsK
IAorCW11dGV4X2xvY2soJnRsLT5tdXRleCk7CiAJZG8gewogCQlzdHJ1Y3QgaTkxNV9yZXF1ZXN0
ICpycTsKIAkJbG9uZyB0aW1lb3V0OwpAQCAtNTUsNiArNTksNyBAQCBzdGF0aWMgaW50IGNvbnRl
eHRfc3luYyhzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UpCiAKIAkJaTkxNV9yZXF1ZXN0X3B1dChy
cSk7CiAJfSB3aGlsZSAoIWVycik7CisJbXV0ZXhfdW5sb2NrKCZ0bC0+bXV0ZXgpOwogCiAJcmV0
dXJuIGVycjsKIH0KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcmVxdWVz
dC5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9yZXF1ZXN0LmMKaW5kZXggNDAyMTMzNGRk
MmM1Li5mNzQ0YWNiZjU1NDEgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVf
cmVxdWVzdC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcmVxdWVzdC5jCkBAIC0x
ODEsNDAgKzE4MSw2IEBAIGk5MTVfcmVxdWVzdF9yZW1vdmVfZnJvbV9jbGllbnQoc3RydWN0IGk5
MTVfcmVxdWVzdCAqcmVxdWVzdCkKIAlzcGluX3VubG9jaygmZmlsZV9wcml2LT5tbS5sb2NrKTsK
IH0KIAotc3RhdGljIHZvaWQgYWR2YW5jZV9yaW5nKHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJlcXVl
c3QpCi17Ci0Jc3RydWN0IGludGVsX3JpbmcgKnJpbmcgPSByZXF1ZXN0LT5yaW5nOwotCXVuc2ln
bmVkIGludCB0YWlsOwotCi0JLyoKLQkgKiBXZSBrbm93IHRoZSBHUFUgbXVzdCBoYXZlIHJlYWQg
dGhlIHJlcXVlc3QgdG8gaGF2ZQotCSAqIHNlbnQgdXMgdGhlIHNlcW5vICsgaW50ZXJydXB0LCBz
byB1c2UgdGhlIHBvc2l0aW9uCi0JICogb2YgdGFpbCBvZiB0aGUgcmVxdWVzdCB0byB1cGRhdGUg
dGhlIGxhc3Qga25vd24gcG9zaXRpb24KLQkgKiBvZiB0aGUgR1BVIGhlYWQuCi0JICoKLQkgKiBO
b3RlIHRoaXMgcmVxdWlyZXMgdGhhdCB3ZSBhcmUgYWx3YXlzIGNhbGxlZCBpbiByZXF1ZXN0Ci0J
ICogY29tcGxldGlvbiBvcmRlci4KLQkgKi8KLQlHRU1fQlVHX09OKCFsaXN0X2lzX2ZpcnN0KCZy
ZXF1ZXN0LT5yaW5nX2xpbmssICZyaW5nLT5yZXF1ZXN0X2xpc3QpKTsKLQlpZiAobGlzdF9pc19s
YXN0KCZyZXF1ZXN0LT5yaW5nX2xpbmssICZyaW5nLT5yZXF1ZXN0X2xpc3QpKSB7Ci0JCS8qCi0J
CSAqIFdlIG1heSByYWNlIGhlcmUgd2l0aCBleGVjbGlzdHMgcmVzdWJtaXR0aW5nIHRoaXMgcmVx
dWVzdAotCQkgKiBhcyB3ZSByZXRpcmUgaXQuIFRoZSByZXN1Ym1pc3Npb24gd2lsbCBtb3ZlIHRo
ZSByaW5nLT50YWlsCi0JCSAqIGZvcndhcmRzICh0byByZXF1ZXN0LT53YV90YWlsKS4gV2UgZWl0
aGVyIHJlYWQgdGhlCi0JCSAqIGN1cnJlbnQgdmFsdWUgdGhhdCB3YXMgd3JpdHRlbiB0byBodywg
b3IgdGhlIHZhbHVlIHRoYXQKLQkJICogaXMganVzdCBhYm91dCB0byBiZS4gRWl0aGVyIHdvcmtz
LCBpZiB3ZSBtaXNzIHRoZSBsYXN0IHR3bwotCQkgKiBub29wcyAtIHRoZXkgYXJlIHNhZmUgdG8g
YmUgcmVwbGF5ZWQgb24gYSByZXNldC4KLQkJICovCi0JCXRhaWwgPSBSRUFEX09OQ0UocmVxdWVz
dC0+dGFpbCk7Ci0JCWxpc3RfZGVsKCZyaW5nLT5hY3RpdmVfbGluayk7Ci0JfSBlbHNlIHsKLQkJ
dGFpbCA9IHJlcXVlc3QtPnBvc3RmaXg7Ci0JfQotCWxpc3RfZGVsX2luaXQoJnJlcXVlc3QtPnJp
bmdfbGluayk7Ci0KLQlyaW5nLT5oZWFkID0gdGFpbDsKLX0KLQogc3RhdGljIHZvaWQgZnJlZV9j
YXB0dXJlX2xpc3Qoc3RydWN0IGk5MTVfcmVxdWVzdCAqcmVxdWVzdCkKIHsKIAlzdHJ1Y3QgaTkx
NV9jYXB0dXJlX2xpc3QgKmNhcHR1cmU7CkBAIC0yMzIsNyArMTk4LDcgQEAgc3RhdGljIGJvb2wg
aTkxNV9yZXF1ZXN0X3JldGlyZShzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSkKIHsKIAlzdHJ1Y3Qg
aTkxNV9hY3RpdmVfcmVxdWVzdCAqYWN0aXZlLCAqbmV4dDsKIAotCWxvY2tkZXBfYXNzZXJ0X2hl
bGQoJnJxLT5pOTE1LT5kcm0uc3RydWN0X211dGV4KTsKKwlsb2NrZGVwX2Fzc2VydF9oZWxkKCZy
cS0+dGltZWxpbmUtPm11dGV4KTsKIAlpZiAoIWk5MTVfcmVxdWVzdF9jb21wbGV0ZWQocnEpKQog
CQlyZXR1cm4gZmFsc2U7CiAKQEAgLTI0NCw3ICsyMTAsMTcgQEAgc3RhdGljIGJvb2wgaTkxNV9y
ZXF1ZXN0X3JldGlyZShzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSkKIAlHRU1fQlVHX09OKCFpOTE1
X3N3X2ZlbmNlX3NpZ25hbGVkKCZycS0+c3VibWl0KSk7CiAJdHJhY2VfaTkxNV9yZXF1ZXN0X3Jl
dGlyZShycSk7CiAKLQlhZHZhbmNlX3JpbmcocnEpOworCS8qCisJICogV2Uga25vdyB0aGUgR1BV
IG11c3QgaGF2ZSByZWFkIHRoZSByZXF1ZXN0IHRvIGhhdmUKKwkgKiBzZW50IHVzIHRoZSBzZXFu
byArIGludGVycnVwdCwgc28gdXNlIHRoZSBwb3NpdGlvbgorCSAqIG9mIHRhaWwgb2YgdGhlIHJl
cXVlc3QgdG8gdXBkYXRlIHRoZSBsYXN0IGtub3duIHBvc2l0aW9uCisJICogb2YgdGhlIEdQVSBo
ZWFkLgorCSAqCisJICogTm90ZSB0aGlzIHJlcXVpcmVzIHRoYXQgd2UgYXJlIGFsd2F5cyBjYWxs
ZWQgaW4gcmVxdWVzdAorCSAqIGNvbXBsZXRpb24gb3JkZXIuCisJICovCisJR0VNX0JVR19PTigh
bGlzdF9pc19maXJzdCgmcnEtPmxpbmssICZycS0+dGltZWxpbmUtPnJlcXVlc3RzKSk7CisJcnEt
PnJpbmctPmhlYWQgPSBycS0+cG9zdGZpeDsKIAogCS8qCiAJICogV2FsayB0aHJvdWdoIHRoZSBh
Y3RpdmUgbGlzdCwgY2FsbGluZyByZXRpcmUgb24gZWFjaC4gVGhpcyBhbGxvd3MKQEAgLTMyMSw3
ICsyOTcsNyBAQCBzdGF0aWMgYm9vbCBpOTE1X3JlcXVlc3RfcmV0aXJlKHN0cnVjdCBpOTE1X3Jl
cXVlc3QgKnJxKQogCiB2b2lkIGk5MTVfcmVxdWVzdF9yZXRpcmVfdXB0byhzdHJ1Y3QgaTkxNV9y
ZXF1ZXN0ICpycSkKIHsKLQlzdHJ1Y3QgaW50ZWxfcmluZyAqcmluZyA9IHJxLT5yaW5nOworCXN0
cnVjdCBpbnRlbF90aW1lbGluZSAqIGNvbnN0IHRsID0gcnEtPnRpbWVsaW5lOwogCXN0cnVjdCBp
OTE1X3JlcXVlc3QgKnRtcDsKIAogCUdFTV9UUkFDRSgiJXMgZmVuY2UgJWxseDolbGxkLCBjdXJy
ZW50ICVkXG4iLApAQCAtMzI5LDE1ICszMDUsMTEgQEAgdm9pZCBpOTE1X3JlcXVlc3RfcmV0aXJl
X3VwdG8oc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEpCiAJCSAgcnEtPmZlbmNlLmNvbnRleHQsIHJx
LT5mZW5jZS5zZXFubywKIAkJICBod3NwX3NlcW5vKHJxKSk7CiAKLQlsb2NrZGVwX2Fzc2VydF9o
ZWxkKCZycS0+aTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CisJbG9ja2RlcF9hc3NlcnRfaGVsZCgm
dGwtPm11dGV4KTsKIAlHRU1fQlVHX09OKCFpOTE1X3JlcXVlc3RfY29tcGxldGVkKHJxKSk7CiAK
LQlpZiAobGlzdF9lbXB0eSgmcnEtPnJpbmdfbGluaykpCi0JCXJldHVybjsKLQogCWRvIHsKLQkJ
dG1wID0gbGlzdF9maXJzdF9lbnRyeSgmcmluZy0+cmVxdWVzdF9saXN0LAotCQkJCSAgICAgICB0
eXBlb2YoKnRtcCksIHJpbmdfbGluayk7CisJCXRtcCA9IGxpc3RfZmlyc3RfZW50cnkoJnRsLT5y
ZXF1ZXN0cywgdHlwZW9mKCp0bXApLCBsaW5rKTsKIAl9IHdoaWxlIChpOTE1X3JlcXVlc3RfcmV0
aXJlKHRtcCkgJiYgdG1wICE9IHJxKTsKIH0KIApAQCAtNTY0LDI5ICs1MzYsMjggQEAgc2VtYXBo
b3JlX25vdGlmeShzdHJ1Y3QgaTkxNV9zd19mZW5jZSAqZmVuY2UsIGVudW0gaTkxNV9zd19mZW5j
ZV9ub3RpZnkgc3RhdGUpCiAJcmV0dXJuIE5PVElGWV9ET05FOwogfQogCi1zdGF0aWMgdm9pZCBy
aW5nX3JldGlyZV9yZXF1ZXN0cyhzdHJ1Y3QgaW50ZWxfcmluZyAqcmluZykKK3N0YXRpYyB2b2lk
IHJldGlyZV9yZXF1ZXN0cyhzdHJ1Y3QgaW50ZWxfdGltZWxpbmUgKnRsKQogewogCXN0cnVjdCBp
OTE1X3JlcXVlc3QgKnJxLCAqcm47CiAKLQlsaXN0X2Zvcl9lYWNoX2VudHJ5X3NhZmUocnEsIHJu
LCAmcmluZy0+cmVxdWVzdF9saXN0LCByaW5nX2xpbmspCisJbGlzdF9mb3JfZWFjaF9lbnRyeV9z
YWZlKHJxLCBybiwgJnRsLT5yZXF1ZXN0cywgbGluaykKIAkJaWYgKCFpOTE1X3JlcXVlc3RfcmV0
aXJlKHJxKSkKIAkJCWJyZWFrOwogfQogCiBzdGF0aWMgbm9pbmxpbmUgc3RydWN0IGk5MTVfcmVx
dWVzdCAqCi1yZXF1ZXN0X2FsbG9jX3Nsb3coc3RydWN0IGludGVsX2NvbnRleHQgKmNlLCBnZnBf
dCBnZnApCityZXF1ZXN0X2FsbG9jX3Nsb3coc3RydWN0IGludGVsX3RpbWVsaW5lICp0bCwgZ2Zw
X3QgZ2ZwKQogewotCXN0cnVjdCBpbnRlbF9yaW5nICpyaW5nID0gY2UtPnJpbmc7CiAJc3RydWN0
IGk5MTVfcmVxdWVzdCAqcnE7CiAKLQlpZiAobGlzdF9lbXB0eSgmcmluZy0+cmVxdWVzdF9saXN0
KSkKKwlpZiAobGlzdF9lbXB0eSgmdGwtPnJlcXVlc3RzKSkKIAkJZ290byBvdXQ7CiAKIAlpZiAo
IWdmcGZsYWdzX2FsbG93X2Jsb2NraW5nKGdmcCkpCiAJCWdvdG8gb3V0OwogCiAJLyogTW92ZSBv
dXIgb2xkZXN0IHJlcXVlc3QgdG8gdGhlIHNsYWItY2FjaGUgKGlmIG5vdCBpbiB1c2UhKSAqLwot
CXJxID0gbGlzdF9maXJzdF9lbnRyeSgmcmluZy0+cmVxdWVzdF9saXN0LCB0eXBlb2YoKnJxKSwg
cmluZ19saW5rKTsKKwlycSA9IGxpc3RfZmlyc3RfZW50cnkoJnRsLT5yZXF1ZXN0cywgdHlwZW9m
KCpycSksIGxpbmspOwogCWk5MTVfcmVxdWVzdF9yZXRpcmUocnEpOwogCiAJcnEgPSBrbWVtX2Nh
Y2hlX2FsbG9jKGdsb2JhbC5zbGFiX3JlcXVlc3RzLApAQCAtNTk1LDExICs1NjYsMTEgQEAgcmVx
dWVzdF9hbGxvY19zbG93KHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSwgZ2ZwX3QgZ2ZwKQogCQly
ZXR1cm4gcnE7CiAKIAkvKiBSYXRlbGltaXQgb3Vyc2VsdmVzIHRvIHByZXZlbnQgb29tIGZyb20g
bWFsaWNpb3VzIGNsaWVudHMgKi8KLQlycSA9IGxpc3RfbGFzdF9lbnRyeSgmcmluZy0+cmVxdWVz
dF9saXN0LCB0eXBlb2YoKnJxKSwgcmluZ19saW5rKTsKKwlycSA9IGxpc3RfbGFzdF9lbnRyeSgm
dGwtPnJlcXVlc3RzLCB0eXBlb2YoKnJxKSwgbGluayk7CiAJY29uZF9zeW5jaHJvbml6ZV9yY3Uo
cnEtPnJjdXN0YXRlKTsKIAogCS8qIFJldGlyZSBvdXIgb2xkIHJlcXVlc3RzIGluIHRoZSBob3Bl
IHRoYXQgd2UgZnJlZSBzb21lICovCi0JcmluZ19yZXRpcmVfcmVxdWVzdHMocmluZyk7CisJcmV0
aXJlX3JlcXVlc3RzKHRsKTsKIAogb3V0OgogCXJldHVybiBrbWVtX2NhY2hlX2FsbG9jKGdsb2Jh
bC5zbGFiX3JlcXVlc3RzLCBnZnApOwpAQCAtNjUwLDcgKzYyMSw3IEBAIF9faTkxNV9yZXF1ZXN0
X2NyZWF0ZShzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UsIGdmcF90IGdmcCkKIAlycSA9IGttZW1f
Y2FjaGVfYWxsb2MoZ2xvYmFsLnNsYWJfcmVxdWVzdHMsCiAJCQkgICAgICBnZnAgfCBfX0dGUF9S
RVRSWV9NQVlGQUlMIHwgX19HRlBfTk9XQVJOKTsKIAlpZiAodW5saWtlbHkoIXJxKSkgewotCQly
cSA9IHJlcXVlc3RfYWxsb2Nfc2xvdyhjZSwgZ2ZwKTsKKwkJcnEgPSByZXF1ZXN0X2FsbG9jX3Ns
b3codGwsIGdmcCk7CiAJCWlmICghcnEpIHsKIAkJCXJldCA9IC1FTk9NRU07CiAJCQlnb3RvIGVy
cl91bnJlc2VydmU7CkBAIC03NDIsMTUgKzcxMywxNSBAQCBzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICoK
IGk5MTVfcmVxdWVzdF9jcmVhdGUoc3RydWN0IGludGVsX2NvbnRleHQgKmNlKQogewogCXN0cnVj
dCBpOTE1X3JlcXVlc3QgKnJxOwotCWludCBlcnI7CisJc3RydWN0IGludGVsX3RpbWVsaW5lICp0
bDsKIAotCWVyciA9IGludGVsX2NvbnRleHRfdGltZWxpbmVfbG9jayhjZSk7Ci0JaWYgKGVycikK
LQkJcmV0dXJuIEVSUl9QVFIoZXJyKTsKKwl0bCA9IGludGVsX2NvbnRleHRfdGltZWxpbmVfbG9j
ayhjZSk7CisJaWYgKElTX0VSUih0bCkpCisJCXJldHVybiBFUlJfQ0FTVCh0bCk7CiAKIAkvKiBN
b3ZlIG91ciBvbGRlc3QgcmVxdWVzdCB0byB0aGUgc2xhYi1jYWNoZSAoaWYgbm90IGluIHVzZSEp
ICovCi0JcnEgPSBsaXN0X2ZpcnN0X2VudHJ5KCZjZS0+cmluZy0+cmVxdWVzdF9saXN0LCB0eXBl
b2YoKnJxKSwgcmluZ19saW5rKTsKLQlpZiAoIWxpc3RfaXNfbGFzdCgmcnEtPnJpbmdfbGluaywg
JmNlLT5yaW5nLT5yZXF1ZXN0X2xpc3QpKQorCXJxID0gbGlzdF9maXJzdF9lbnRyeSgmdGwtPnJl
cXVlc3RzLCB0eXBlb2YoKnJxKSwgbGluayk7CisJaWYgKCFsaXN0X2lzX2xhc3QoJnJxLT5saW5r
LCAmdGwtPnJlcXVlc3RzKSkKIAkJaTkxNV9yZXF1ZXN0X3JldGlyZShycSk7CiAKIAlpbnRlbF9j
b250ZXh0X2VudGVyKGNlKTsKQEAgLTc2MCwyMiArNzMxLDIyIEBAIGk5MTVfcmVxdWVzdF9jcmVh
dGUoc3RydWN0IGludGVsX2NvbnRleHQgKmNlKQogCQlnb3RvIGVycl91bmxvY2s7CiAKIAkvKiBD
aGVjayB0aGF0IHdlIGRvIG5vdCBpbnRlcnJ1cHQgb3Vyc2VsdmVzIHdpdGggYSBuZXcgcmVxdWVz
dCAqLwotCXJxLT5jb29raWUgPSBsb2NrZGVwX3Bpbl9sb2NrKCZjZS0+dGltZWxpbmUtPm11dGV4
KTsKKwlycS0+Y29va2llID0gbG9ja2RlcF9waW5fbG9jaygmdGwtPm11dGV4KTsKIAogCXJldHVy
biBycTsKIAogZXJyX3VubG9jazoKLQlpbnRlbF9jb250ZXh0X3RpbWVsaW5lX3VubG9jayhjZSk7
CisJaW50ZWxfY29udGV4dF90aW1lbGluZV91bmxvY2sodGwpOwogCXJldHVybiBycTsKIH0KIAog
c3RhdGljIGludAogaTkxNV9yZXF1ZXN0X2F3YWl0X3N0YXJ0KHN0cnVjdCBpOTE1X3JlcXVlc3Qg
KnJxLCBzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpzaWduYWwpCiB7Ci0JaWYgKGxpc3RfaXNfZmlyc3Qo
JnNpZ25hbC0+cmluZ19saW5rLCAmc2lnbmFsLT5yaW5nLT5yZXF1ZXN0X2xpc3QpKQorCWlmIChs
aXN0X2lzX2ZpcnN0KCZzaWduYWwtPmxpbmssICZzaWduYWwtPnRpbWVsaW5lLT5yZXF1ZXN0cykp
CiAJCXJldHVybiAwOwogCi0Jc2lnbmFsID0gbGlzdF9wcmV2X2VudHJ5KHNpZ25hbCwgcmluZ19s
aW5rKTsKKwlzaWduYWwgPSBsaXN0X3ByZXZfZW50cnkoc2lnbmFsLCBsaW5rKTsKIAlpZiAoaW50
ZWxfdGltZWxpbmVfc3luY19pc19sYXRlcihycS0+dGltZWxpbmUsICZzaWduYWwtPmZlbmNlKSkK
IAkJcmV0dXJuIDA7CiAKQEAgLTExNTUsNyArMTEyNiw2IEBAIHN0cnVjdCBpOTE1X3JlcXVlc3Qg
Kl9faTkxNV9yZXF1ZXN0X2NvbW1pdChzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSkKIHsKIAlzdHJ1
Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUgPSBycS0+ZW5naW5lOwogCXN0cnVjdCBpbnRlbF9y
aW5nICpyaW5nID0gcnEtPnJpbmc7Ci0Jc3RydWN0IGk5MTVfcmVxdWVzdCAqcHJldjsKIAl1MzIg
KmNzOwogCiAJR0VNX1RSQUNFKCIlcyBmZW5jZSAlbGx4OiVsbGRcbiIsCkBAIC0xMTY4LDYgKzEx
MzgsNyBAQCBzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpfX2k5MTVfcmVxdWVzdF9jb21taXQoc3RydWN0
IGk5MTVfcmVxdWVzdCAqcnEpCiAJICovCiAJR0VNX0JVR19PTihycS0+cmVzZXJ2ZWRfc3BhY2Ug
PiByaW5nLT5zcGFjZSk7CiAJcnEtPnJlc2VydmVkX3NwYWNlID0gMDsKKwlycS0+ZW1pdHRlZF9q
aWZmaWVzID0gamlmZmllczsKIAogCS8qCiAJICogUmVjb3JkIHRoZSBwb3NpdGlvbiBvZiB0aGUg
c3RhcnQgb2YgdGhlIGJyZWFkY3J1bWIgc28gdGhhdApAQCAtMTE3OSwxNCArMTE1MCw3IEBAIHN0
cnVjdCBpOTE1X3JlcXVlc3QgKl9faTkxNV9yZXF1ZXN0X2NvbW1pdChzdHJ1Y3QgaTkxNV9yZXF1
ZXN0ICpycSkKIAlHRU1fQlVHX09OKElTX0VSUihjcykpOwogCXJxLT5wb3N0Zml4ID0gaW50ZWxf
cmluZ19vZmZzZXQocnEsIGNzKTsKIAotCXByZXYgPSBfX2k5MTVfcmVxdWVzdF9hZGRfdG9fdGlt
ZWxpbmUocnEpOwotCi0JbGlzdF9hZGRfdGFpbCgmcnEtPnJpbmdfbGluaywgJnJpbmctPnJlcXVl
c3RfbGlzdCk7Ci0JaWYgKGxpc3RfaXNfZmlyc3QoJnJxLT5yaW5nX2xpbmssICZyaW5nLT5yZXF1
ZXN0X2xpc3QpKQotCQlsaXN0X2FkZCgmcmluZy0+YWN0aXZlX2xpbmssICZycS0+aTkxNS0+Z3Qu
YWN0aXZlX3JpbmdzKTsKLQlycS0+ZW1pdHRlZF9qaWZmaWVzID0gamlmZmllczsKLQotCXJldHVy
biBwcmV2OworCXJldHVybiBfX2k5MTVfcmVxdWVzdF9hZGRfdG9fdGltZWxpbmUocnEpOwogfQog
CiB2b2lkIF9faTkxNV9yZXF1ZXN0X3F1ZXVlKHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxLApAQCAt
MTIxNCwxMCArMTE3OCwxMSBAQCB2b2lkIF9faTkxNV9yZXF1ZXN0X3F1ZXVlKHN0cnVjdCBpOTE1
X3JlcXVlc3QgKnJxLAogdm9pZCBpOTE1X3JlcXVlc3RfYWRkKHN0cnVjdCBpOTE1X3JlcXVlc3Qg
KnJxKQogewogCXN0cnVjdCBpOTE1X3NjaGVkX2F0dHIgYXR0ciA9IHJxLT5nZW1fY29udGV4dC0+
c2NoZWQ7CisJc3RydWN0IGludGVsX3RpbWVsaW5lICogY29uc3QgdGwgPSBycS0+dGltZWxpbmU7
CiAJc3RydWN0IGk5MTVfcmVxdWVzdCAqcHJldjsKIAotCWxvY2tkZXBfYXNzZXJ0X2hlbGQoJnJx
LT50aW1lbGluZS0+bXV0ZXgpOwotCWxvY2tkZXBfdW5waW5fbG9jaygmcnEtPnRpbWVsaW5lLT5t
dXRleCwgcnEtPmNvb2tpZSk7CisJbG9ja2RlcF9hc3NlcnRfaGVsZCgmdGwtPm11dGV4KTsKKwls
b2NrZGVwX3VucGluX2xvY2soJnRsLT5tdXRleCwgcnEtPmNvb2tpZSk7CiAKIAl0cmFjZV9pOTE1
X3JlcXVlc3RfYWRkKHJxKTsKIApAQCAtMTI2NiwxMCArMTIzMSwxMCBAQCB2b2lkIGk5MTVfcmVx
dWVzdF9hZGQoc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEpCiAJICogd29yayBvbiBiZWhhbGYgb2Yg
b3RoZXJzIC0tIGJ1dCBpbnN0ZWFkIHdlIHNob3VsZCBiZW5lZml0IGZyb20KIAkgKiBpbXByb3Zl
ZCByZXNvdXJjZSBtYW5hZ2VtZW50LiAoV2VsbCwgdGhhdCdzIHRoZSB0aGVvcnkgYXQgbGVhc3Qu
KQogCSAqLwotCWlmIChwcmV2ICYmIGk5MTVfcmVxdWVzdF9jb21wbGV0ZWQocHJldikpCisJaWYg
KHByZXYgJiYgaTkxNV9yZXF1ZXN0X2NvbXBsZXRlZChwcmV2KSAmJiBwcmV2LT50aW1lbGluZSA9
PSB0bCkKIAkJaTkxNV9yZXF1ZXN0X3JldGlyZV91cHRvKHByZXYpOwogCi0JbXV0ZXhfdW5sb2Nr
KCZycS0+dGltZWxpbmUtPm11dGV4KTsKKwltdXRleF91bmxvY2soJnRsLT5tdXRleCk7CiB9CiAK
IHN0YXRpYyB1bnNpZ25lZCBsb25nIGxvY2FsX2Nsb2NrX3VzKHVuc2lnbmVkIGludCAqY3B1KQpA
QCAtMTQ4OSwxOCArMTQ1NCw0MyBAQCBsb25nIGk5MTVfcmVxdWVzdF93YWl0KHN0cnVjdCBpOTE1
X3JlcXVlc3QgKnJxLAogCiBib29sIGk5MTVfcmV0aXJlX3JlcXVlc3RzKHN0cnVjdCBkcm1faTkx
NV9wcml2YXRlICppOTE1KQogewotCXN0cnVjdCBpbnRlbF9yaW5nICpyaW5nLCAqdG1wOworCXN0
cnVjdCBpbnRlbF9ndF90aW1lbGluZXMgKnRpbWVsaW5lcyA9ICZpOTE1LT5ndC50aW1lbGluZXM7
CisJc3RydWN0IGludGVsX3RpbWVsaW5lICp0bCwgKnRuOworCUxJU1RfSEVBRChmcmVlKTsKKwor
CXNwaW5fbG9jaygmdGltZWxpbmVzLT5sb2NrKTsKKwlsaXN0X2Zvcl9lYWNoX2VudHJ5X3NhZmUo
dGwsIHRuLCAmdGltZWxpbmVzLT5hY3RpdmVfbGlzdCwgbGluaykgeworCQlpZiAoIW11dGV4X3Ry
eWxvY2soJnRsLT5tdXRleCkpCisJCQljb250aW51ZTsKIAotCWxvY2tkZXBfYXNzZXJ0X2hlbGQo
Jmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOworCQlpbnRlbF90aW1lbGluZV9nZXQodGwpOworCQlH
RU1fQlVHX09OKCF0bC0+YWN0aXZlX2NvdW50KTsKKwkJdGwtPmFjdGl2ZV9jb3VudCsrOyAvKiBw
aW4gdGhlIGxpc3QgZWxlbWVudCAqLworCQlzcGluX3VubG9jaygmdGltZWxpbmVzLT5sb2NrKTsK
IAotCWxpc3RfZm9yX2VhY2hfZW50cnlfc2FmZShyaW5nLCB0bXAsCi0JCQkJICZpOTE1LT5ndC5h
Y3RpdmVfcmluZ3MsIGFjdGl2ZV9saW5rKSB7Ci0JCWludGVsX3JpbmdfZ2V0KHJpbmcpOyAvKiBs
YXN0IHJxIGhvbGRzIHJlZmVyZW5jZSEgKi8KLQkJcmluZ19yZXRpcmVfcmVxdWVzdHMocmluZyk7
Ci0JCWludGVsX3JpbmdfcHV0KHJpbmcpOworCQlyZXRpcmVfcmVxdWVzdHModGwpOworCisJCXNw
aW5fbG9jaygmdGltZWxpbmVzLT5sb2NrKTsKKworCQkvKiBSZXN0YXJ0IGl0ZXJhdGlvbiBhZnRl
ciBkcm9wcGluZyBsb2NrICovCisJCWxpc3Rfc2FmZV9yZXNldF9uZXh0KHRsLCB0biwgbGluayk7
CisJCWlmICghLS10bC0+YWN0aXZlX2NvdW50KQorCQkJbGlzdF9kZWwoJnRsLT5saW5rKTsKKwor
CQltdXRleF91bmxvY2soJnRsLT5tdXRleCk7CisKKwkJLyogRGVmZXIgdGhlIGZpbmFsIHJlbGVh
c2UgdG8gYWZ0ZXIgdGhlIHNwaW5sb2NrICovCisJCWlmIChyZWZjb3VudF9kZWNfYW5kX3Rlc3Qo
JnRsLT5rcmVmLnJlZmNvdW50KSkgeworCQkJR0VNX0JVR19PTih0bC0+YWN0aXZlX2NvdW50KTsK
KwkJCWxpc3RfYWRkKCZ0bC0+bGluaywgJmZyZWUpOworCQl9CiAJfQorCXNwaW5fdW5sb2NrKCZ0
aW1lbGluZXMtPmxvY2spOworCisJbGlzdF9mb3JfZWFjaF9lbnRyeV9zYWZlKHRsLCB0biwgJmZy
ZWUsIGxpbmspCisJCV9faW50ZWxfdGltZWxpbmVfZnJlZSgmdGwtPmtyZWYpOwogCi0JcmV0dXJu
ICFsaXN0X2VtcHR5KCZpOTE1LT5ndC5hY3RpdmVfcmluZ3MpOworCXJldHVybiAhbGlzdF9lbXB0
eSgmdGltZWxpbmVzLT5hY3RpdmVfbGlzdCk7CiB9CiAKICNpZiBJU19FTkFCTEVEKENPTkZJR19E
Uk1fSTkxNV9TRUxGVEVTVCkKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVf
cmVxdWVzdC5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9yZXF1ZXN0LmgKaW5kZXggZmVj
MWQ1ZjE3Yzk0Li44YWM2ZTEyMjZhNTYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2k5MTVfcmVxdWVzdC5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcmVxdWVzdC5o
CkBAIC0yMjMsOSArMjIzLDYgQEAgc3RydWN0IGk5MTVfcmVxdWVzdCB7CiAJLyoqIHRpbWVsaW5l
LT5yZXF1ZXN0IGVudHJ5IGZvciB0aGlzIHJlcXVlc3QgKi8KIAlzdHJ1Y3QgbGlzdF9oZWFkIGxp
bms7CiAKLQkvKiogcmluZy0+cmVxdWVzdF9saXN0IGVudHJ5IGZvciB0aGlzIHJlcXVlc3QgKi8K
LQlzdHJ1Y3QgbGlzdF9oZWFkIHJpbmdfbGluazsKLQogCXN0cnVjdCBkcm1faTkxNV9maWxlX3By
aXZhdGUgKmZpbGVfcHJpdjsKIAkvKiogZmlsZV9wcml2IGxpc3QgZW50cnkgZm9yIHRoaXMgcmVx
dWVzdCAqLwogCXN0cnVjdCBsaXN0X2hlYWQgY2xpZW50X2xpbms7Ci0tIAoyLjIzLjAucmMxCgpf
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpJbnRlbC1nZngg
bWFpbGluZyBsaXN0CkludGVsLWdmeEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0
cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9pbnRlbC1nZng=

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id A197A37FF4
	for <lists+intel-gfx@lfdr.de>; Thu,  6 Jun 2019 23:52:48 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 870F5899BE;
	Thu,  6 Jun 2019 21:52:46 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mga07.intel.com (mga07.intel.com [134.134.136.100])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 2ECC2899BE
 for <intel-gfx@lists.freedesktop.org>; Thu,  6 Jun 2019 21:52:45 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga002.jf.intel.com ([10.7.209.21])
 by orsmga105.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 06 Jun 2019 14:52:45 -0700
X-ExtLoop1: 1
Received: from dceraolo-linux.fm.intel.com ([10.1.27.145])
 by orsmga002.jf.intel.com with ESMTP; 06 Jun 2019 14:52:44 -0700
From: Daniele Ceraolo Spurio <daniele.ceraolospurio@intel.com>
To: intel-gfx@lists.freedesktop.org
Date: Thu,  6 Jun 2019 14:52:12 -0700
Message-Id: <20190606215218.34486-4-daniele.ceraolospurio@intel.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190606215218.34486-1-daniele.ceraolospurio@intel.com>
References: <20190606215218.34486-1-daniele.ceraolospurio@intel.com>
MIME-Version: 1.0
Subject: [Intel-gfx] [RFC 3/8] drm/i915: dynamically allocate forcewake
 domains
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SW4gYW4gdXBjb21pbmcgcGF0Y2ggd2Ugd2lsbCBpbnRyb2R1Y2UgYSBkaXNwbGF5IHVuY29yZSB3
aXRoIG5vIGZvcmNld2FrZQpkb21haW5zLCBzbyBsZXQncyBhdm9pZCB3YXN0aW5nIG1lbW9yeSBh
bmQgYmUgcmVhZHkgdG8gYWxsb2NhdGUgb25seSB3aGF0CndlIG5lZWQuCgpTaWduZWQtb2ZmLWJ5
OiBEYW5pZWxlIENlcmFvbG8gU3B1cmlvIDxkYW5pZWxlLmNlcmFvbG9zcHVyaW9AaW50ZWwuY29t
PgotLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2ludGVsX3VuY29yZS5jIHwgMTQxICsrKysrKysr
KysrKysrKysrLS0tLS0tLS0tLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2ludGVsX3VuY29yZS5o
IHwgIDEzICstLQogMiBmaWxlcyBjaGFuZ2VkLCA5MiBpbnNlcnRpb25zKCspLCA2MiBkZWxldGlv
bnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pbnRlbF91bmNvcmUuYyBi
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2ludGVsX3VuY29yZS5jCmluZGV4IGVmN2VlZDkyMzdhMC4u
MzA2NTBlNmUyZjU0IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pbnRlbF91bmNv
cmUuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pbnRlbF91bmNvcmUuYwpAQCAtMzQ0LDcg
KzM0NCw3IEBAIGludGVsX3VuY29yZV9md19yZWxlYXNlX3RpbWVyKHN0cnVjdCBocnRpbWVyICp0
aW1lcikKIHsKIAlzdHJ1Y3QgaW50ZWxfdW5jb3JlX2ZvcmNld2FrZV9kb21haW4gKmRvbWFpbiA9
CiAJICAgICAgIGNvbnRhaW5lcl9vZih0aW1lciwgc3RydWN0IGludGVsX3VuY29yZV9mb3JjZXdh
a2VfZG9tYWluLCB0aW1lcik7Ci0Jc3RydWN0IGludGVsX3VuY29yZSAqdW5jb3JlID0gZm9yY2V3
YWtlX2RvbWFpbl90b191bmNvcmUoZG9tYWluKTsKKwlzdHJ1Y3QgaW50ZWxfdW5jb3JlICp1bmNv
cmUgPSBkb21haW4tPnVuY29yZTsKIAl1bnNpZ25lZCBsb25nIGlycWZsYWdzOwogCiAJYXNzZXJ0
X3JwbV9kZXZpY2Vfbm90X3N1c3BlbmRlZCh1bmNvcmUtPnJwbSk7CkBAIC0xMjgzLDIzICsxMjgz
LDI0IEBAIGRvIHsgXAogCSh1bmNvcmUpLT5mdW5jcy5yZWFkX2Z3X2RvbWFpbnMgPSB4IyNfcmVn
X3JlYWRfZndfZG9tYWluczsgXAogfSB3aGlsZSAoMCkKIAotc3RhdGljIHZvaWQgZndfZG9tYWlu
X2luaXQoc3RydWN0IGludGVsX3VuY29yZSAqdW5jb3JlLAorc3RhdGljIGludCBmd19kb21haW5f
aW5pdChzdHJ1Y3QgaW50ZWxfdW5jb3JlICp1bmNvcmUsCiAJCQkgICBlbnVtIGZvcmNld2FrZV9k
b21haW5faWQgZG9tYWluX2lkLAogCQkJICAgaTkxNV9yZWdfdCByZWdfc2V0LAogCQkJICAgaTkx
NV9yZWdfdCByZWdfYWNrKQogewogCXN0cnVjdCBpbnRlbF91bmNvcmVfZm9yY2V3YWtlX2RvbWFp
biAqZDsKIAotCWlmIChXQVJOX09OKGRvbWFpbl9pZCA+PSBGV19ET01BSU5fSURfQ09VTlQpKQot
CQlyZXR1cm47Ci0KLQlkID0gJnVuY29yZS0+ZndfZG9tYWluW2RvbWFpbl9pZF07CisJR0VNX0JV
R19PTihkb21haW5faWQgPj0gRldfRE9NQUlOX0lEX0NPVU5UKTsKKwlHRU1fQlVHX09OKHVuY29y
ZS0+ZndfZG9tYWluW2RvbWFpbl9pZF0pOwogCi0JV0FSTl9PTihkLT53YWtlX2NvdW50KTsKKwlk
ID0ga3phbGxvYyhzaXplb2YoKmQpLCBHRlBfS0VSTkVMKTsKKwlpZiAoIWQpCisJCXJldHVybiAt
RU5PTUVNOwogCiAJV0FSTl9PTighaTkxNV9tbWlvX3JlZ192YWxpZChyZWdfc2V0KSk7CiAJV0FS
Tl9PTighaTkxNV9tbWlvX3JlZ192YWxpZChyZWdfYWNrKSk7CiAKKwlkLT51bmNvcmUgPSB1bmNv
cmU7CiAJZC0+d2FrZV9jb3VudCA9IDA7CiAJZC0+cmVnX3NldCA9IHVuY29yZS0+cmVncyArIGk5
MTVfbW1pb19yZWdfb2Zmc2V0KHJlZ19zZXQpOwogCWQtPnJlZ19hY2sgPSB1bmNvcmUtPnJlZ3Mg
KyBpOTE1X21taW9fcmVnX29mZnNldChyZWdfYWNrKTsKQEAgLTEzMjUsNiArMTMyNiwxMCBAQCBz
dGF0aWMgdm9pZCBmd19kb21haW5faW5pdChzdHJ1Y3QgaW50ZWxfdW5jb3JlICp1bmNvcmUsCiAJ
dW5jb3JlLT5md19kb21haW5zIHw9IEJJVChkb21haW5faWQpOwogCiAJZndfZG9tYWluX3Jlc2V0
KGQpOworCisJdW5jb3JlLT5md19kb21haW5bZG9tYWluX2lkXSA9IGQ7CisKKwlyZXR1cm4gMDsK
IH0KIAogc3RhdGljIHZvaWQgZndfZG9tYWluX2Zpbmkoc3RydWN0IGludGVsX3VuY29yZSAqdW5j
b3JlLApAQCAtMTMzMiw3OCArMTMzNyw5MyBAQCBzdGF0aWMgdm9pZCBmd19kb21haW5fZmluaShz
dHJ1Y3QgaW50ZWxfdW5jb3JlICp1bmNvcmUsCiB7CiAJc3RydWN0IGludGVsX3VuY29yZV9mb3Jj
ZXdha2VfZG9tYWluICpkOwogCi0JaWYgKFdBUk5fT04oZG9tYWluX2lkID49IEZXX0RPTUFJTl9J
RF9DT1VOVCkpCi0JCXJldHVybjsKKwlHRU1fQlVHX09OKGRvbWFpbl9pZCA+PSBGV19ET01BSU5f
SURfQ09VTlQpOwogCi0JZCA9ICZ1bmNvcmUtPmZ3X2RvbWFpbltkb21haW5faWRdOworCWQgPSBm
ZXRjaF9hbmRfemVybygmdW5jb3JlLT5md19kb21haW5bZG9tYWluX2lkXSk7CisJdW5jb3JlLT5m
d19kb21haW5zICY9IH5CSVQoZG9tYWluX2lkKTsKIAotCVdBUk5fT04oZC0+d2FrZV9jb3VudCk7
Ci0JV0FSTl9PTihocnRpbWVyX2NhbmNlbCgmZC0+dGltZXIpKTsKLQltZW1zZXQoZCwgMCwgc2l6
ZW9mKCpkKSk7CisJaWYgKGQpIHsKKwkJV0FSTl9PTihkLT53YWtlX2NvdW50KTsKKwkJV0FSTl9P
TihocnRpbWVyX2NhbmNlbCgmZC0+dGltZXIpKTsKKwkJa2ZyZWUoZCk7CisJfQorfQogCi0JdW5j
b3JlLT5md19kb21haW5zICY9IH5CSVQoZG9tYWluX2lkKTsKK3N0YXRpYyB2b2lkIGludGVsX3Vu
Y29yZV9md19kb21haW5zX2Zpbmkoc3RydWN0IGludGVsX3VuY29yZSAqdW5jb3JlKQoreworCXN0
cnVjdCBpbnRlbF91bmNvcmVfZm9yY2V3YWtlX2RvbWFpbiAqZDsKKwlpbnQgdG1wOworCisJZm9y
X2VhY2hfZndfZG9tYWluKGQsIHVuY29yZSwgdG1wKQorCQlmd19kb21haW5fZmluaSh1bmNvcmUs
IGQtPmlkKTsKIH0KIAotc3RhdGljIHZvaWQgaW50ZWxfdW5jb3JlX2Z3X2RvbWFpbnNfaW5pdChz
dHJ1Y3QgaW50ZWxfdW5jb3JlICp1bmNvcmUpCitzdGF0aWMgaW50IGludGVsX3VuY29yZV9md19k
b21haW5zX2luaXQoc3RydWN0IGludGVsX3VuY29yZSAqdW5jb3JlKQogewogCXN0cnVjdCBkcm1f
aTkxNV9wcml2YXRlICppOTE1ID0gdW5jb3JlX3RvX2k5MTUodW5jb3JlKTsKKwlpbnQgcmV0Owor
CisjZGVmaW5lIF9fZndfZG9tYWluX2luaXQoaWQsIHNldCwgYWNrKSBcCisJcmV0ID0gZndfZG9t
YWluX2luaXQodW5jb3JlLCBpZCwgc2V0LCBhY2spOyBcCisJaWYgKHJldCkgXAorCQlnb3RvIG91
dF9jbGVhbjsKIAogCWlmICghaW50ZWxfdW5jb3JlX2hhc19mb3JjZXdha2UodW5jb3JlKSkKLQkJ
cmV0dXJuOworCQlyZXR1cm4gMDsKIAogCWlmIChJTlRFTF9HRU4oaTkxNSkgPj0gMTEpIHsKIAkJ
aW50IGk7CiAKLQkJdW5jb3JlLT5mdW5jcy5mb3JjZV93YWtlX2dldCA9Ci0JCQlmd19kb21haW5z
X2dldF93aXRoX2ZhbGxiYWNrOworCQl1bmNvcmUtPmZ1bmNzLmZvcmNlX3dha2VfZ2V0ID0gZndf
ZG9tYWluc19nZXRfd2l0aF9mYWxsYmFjazsKIAkJdW5jb3JlLT5mdW5jcy5mb3JjZV93YWtlX3B1
dCA9IGZ3X2RvbWFpbnNfcHV0OwotCQlmd19kb21haW5faW5pdCh1bmNvcmUsIEZXX0RPTUFJTl9J
RF9SRU5ERVIsCi0JCQkgICAgICAgRk9SQ0VXQUtFX1JFTkRFUl9HRU45LAotCQkJICAgICAgIEZP
UkNFV0FLRV9BQ0tfUkVOREVSX0dFTjkpOwotCQlmd19kb21haW5faW5pdCh1bmNvcmUsIEZXX0RP
TUFJTl9JRF9CTElUVEVSLAotCQkJICAgICAgIEZPUkNFV0FLRV9CTElUVEVSX0dFTjksCi0JCQkg
ICAgICAgRk9SQ0VXQUtFX0FDS19CTElUVEVSX0dFTjkpOworCQlfX2Z3X2RvbWFpbl9pbml0KEZX
X0RPTUFJTl9JRF9SRU5ERVIsCisJCQkJIEZPUkNFV0FLRV9SRU5ERVJfR0VOOSwKKwkJCQkgRk9S
Q0VXQUtFX0FDS19SRU5ERVJfR0VOOSk7CisJCV9fZndfZG9tYWluX2luaXQoRldfRE9NQUlOX0lE
X0JMSVRURVIsCisJCQkJIEZPUkNFV0FLRV9CTElUVEVSX0dFTjksCisJCQkJIEZPUkNFV0FLRV9B
Q0tfQkxJVFRFUl9HRU45KTsKKwogCQlmb3IgKGkgPSAwOyBpIDwgSTkxNV9NQVhfVkNTOyBpKysp
IHsKIAkJCWlmICghSEFTX0VOR0lORShpOTE1LCBfVkNTKGkpKSkKIAkJCQljb250aW51ZTsKIAot
CQkJZndfZG9tYWluX2luaXQodW5jb3JlLCBGV19ET01BSU5fSURfTUVESUFfVkRCT1gwICsgaSwK
LQkJCQkgICAgICAgRk9SQ0VXQUtFX01FRElBX1ZEQk9YX0dFTjExKGkpLAotCQkJCSAgICAgICBG
T1JDRVdBS0VfQUNLX01FRElBX1ZEQk9YX0dFTjExKGkpKTsKKwkJCV9fZndfZG9tYWluX2luaXQo
RldfRE9NQUlOX0lEX01FRElBX1ZEQk9YMCArIGksCisJCQkJCSBGT1JDRVdBS0VfTUVESUFfVkRC
T1hfR0VOMTEoaSksCisJCQkJCSBGT1JDRVdBS0VfQUNLX01FRElBX1ZEQk9YX0dFTjExKGkpKTsK
IAkJfQogCQlmb3IgKGkgPSAwOyBpIDwgSTkxNV9NQVhfVkVDUzsgaSsrKSB7CiAJCQlpZiAoIUhB
U19FTkdJTkUoaTkxNSwgX1ZFQ1MoaSkpKQogCQkJCWNvbnRpbnVlOwogCi0JCQlmd19kb21haW5f
aW5pdCh1bmNvcmUsIEZXX0RPTUFJTl9JRF9NRURJQV9WRUJPWDAgKyBpLAotCQkJCSAgICAgICBG
T1JDRVdBS0VfTUVESUFfVkVCT1hfR0VOMTEoaSksCi0JCQkJICAgICAgIEZPUkNFV0FLRV9BQ0tf
TUVESUFfVkVCT1hfR0VOMTEoaSkpOworCQkJX19md19kb21haW5faW5pdChGV19ET01BSU5fSURf
TUVESUFfVkVCT1gwICsgaSwKKwkJCQkJIEZPUkNFV0FLRV9NRURJQV9WRUJPWF9HRU4xMShpKSwK
KwkJCQkJIEZPUkNFV0FLRV9BQ0tfTUVESUFfVkVCT1hfR0VOMTEoaSkpOwogCQl9CiAJfSBlbHNl
IGlmIChJU19HRU5fUkFOR0UoaTkxNSwgOSwgMTApKSB7Ci0JCXVuY29yZS0+ZnVuY3MuZm9yY2Vf
d2FrZV9nZXQgPQotCQkJZndfZG9tYWluc19nZXRfd2l0aF9mYWxsYmFjazsKKwkJdW5jb3JlLT5m
dW5jcy5mb3JjZV93YWtlX2dldCA9IGZ3X2RvbWFpbnNfZ2V0X3dpdGhfZmFsbGJhY2s7CiAJCXVu
Y29yZS0+ZnVuY3MuZm9yY2Vfd2FrZV9wdXQgPSBmd19kb21haW5zX3B1dDsKLQkJZndfZG9tYWlu
X2luaXQodW5jb3JlLCBGV19ET01BSU5fSURfUkVOREVSLAotCQkJICAgICAgIEZPUkNFV0FLRV9S
RU5ERVJfR0VOOSwKLQkJCSAgICAgICBGT1JDRVdBS0VfQUNLX1JFTkRFUl9HRU45KTsKLQkJZndf
ZG9tYWluX2luaXQodW5jb3JlLCBGV19ET01BSU5fSURfQkxJVFRFUiwKLQkJCSAgICAgICBGT1JD
RVdBS0VfQkxJVFRFUl9HRU45LAotCQkJICAgICAgIEZPUkNFV0FLRV9BQ0tfQkxJVFRFUl9HRU45
KTsKLQkJZndfZG9tYWluX2luaXQodW5jb3JlLCBGV19ET01BSU5fSURfTUVESUEsCi0JCQkgICAg
ICAgRk9SQ0VXQUtFX01FRElBX0dFTjksIEZPUkNFV0FLRV9BQ0tfTUVESUFfR0VOOSk7CisJCV9f
ZndfZG9tYWluX2luaXQoRldfRE9NQUlOX0lEX1JFTkRFUiwKKwkJCQkgRk9SQ0VXQUtFX1JFTkRF
Ul9HRU45LAorCQkJCSBGT1JDRVdBS0VfQUNLX1JFTkRFUl9HRU45KTsKKwkJX19md19kb21haW5f
aW5pdChGV19ET01BSU5fSURfQkxJVFRFUiwKKwkJCQkgRk9SQ0VXQUtFX0JMSVRURVJfR0VOOSwK
KwkJCQkgRk9SQ0VXQUtFX0FDS19CTElUVEVSX0dFTjkpOworCQlfX2Z3X2RvbWFpbl9pbml0KEZX
X0RPTUFJTl9JRF9NRURJQSwKKwkJCQkgRk9SQ0VXQUtFX01FRElBX0dFTjksCisJCQkJIEZPUkNF
V0FLRV9BQ0tfTUVESUFfR0VOOSk7CiAJfSBlbHNlIGlmIChJU19WQUxMRVlWSUVXKGk5MTUpIHx8
IElTX0NIRVJSWVZJRVcoaTkxNSkpIHsKIAkJdW5jb3JlLT5mdW5jcy5mb3JjZV93YWtlX2dldCA9
IGZ3X2RvbWFpbnNfZ2V0OwogCQl1bmNvcmUtPmZ1bmNzLmZvcmNlX3dha2VfcHV0ID0gZndfZG9t
YWluc19wdXQ7Ci0JCWZ3X2RvbWFpbl9pbml0KHVuY29yZSwgRldfRE9NQUlOX0lEX1JFTkRFUiwK
LQkJCSAgICAgICBGT1JDRVdBS0VfVkxWLCBGT1JDRVdBS0VfQUNLX1ZMVik7Ci0JCWZ3X2RvbWFp
bl9pbml0KHVuY29yZSwgRldfRE9NQUlOX0lEX01FRElBLAotCQkJICAgICAgIEZPUkNFV0FLRV9N
RURJQV9WTFYsIEZPUkNFV0FLRV9BQ0tfTUVESUFfVkxWKTsKKwkJX19md19kb21haW5faW5pdChG
V19ET01BSU5fSURfUkVOREVSLAorCQkJCSBGT1JDRVdBS0VfVkxWLCBGT1JDRVdBS0VfQUNLX1ZM
Vik7CisJCV9fZndfZG9tYWluX2luaXQoRldfRE9NQUlOX0lEX01FRElBLAorCQkJCSBGT1JDRVdB
S0VfTUVESUFfVkxWLCBGT1JDRVdBS0VfQUNLX01FRElBX1ZMVik7CiAJfSBlbHNlIGlmIChJU19I
QVNXRUxMKGk5MTUpIHx8IElTX0JST0FEV0VMTChpOTE1KSkgewogCQl1bmNvcmUtPmZ1bmNzLmZv
cmNlX3dha2VfZ2V0ID0KIAkJCWZ3X2RvbWFpbnNfZ2V0X3dpdGhfdGhyZWFkX3N0YXR1czsKIAkJ
dW5jb3JlLT5mdW5jcy5mb3JjZV93YWtlX3B1dCA9IGZ3X2RvbWFpbnNfcHV0OwotCQlmd19kb21h
aW5faW5pdCh1bmNvcmUsIEZXX0RPTUFJTl9JRF9SRU5ERVIsCi0JCQkgICAgICAgRk9SQ0VXQUtF
X01ULCBGT1JDRVdBS0VfQUNLX0hTVyk7CisJCV9fZndfZG9tYWluX2luaXQoRldfRE9NQUlOX0lE
X1JFTkRFUiwKKwkJCQkgRk9SQ0VXQUtFX01ULCBGT1JDRVdBS0VfQUNLX0hTVyk7CiAJfSBlbHNl
IGlmIChJU19JVllCUklER0UoaTkxNSkpIHsKIAkJdTMyIGVjb2J1czsKIApAQCAtMTQzMCw4ICsx
NDUwLDggQEAgc3RhdGljIHZvaWQgaW50ZWxfdW5jb3JlX2Z3X2RvbWFpbnNfaW5pdChzdHJ1Y3Qg
aW50ZWxfdW5jb3JlICp1bmNvcmUpCiAJCV9fcmF3X3VuY29yZV93cml0ZTMyKHVuY29yZSwgRk9S
Q0VXQUtFLCAwKTsKIAkJX19yYXdfcG9zdGluZ19yZWFkKHVuY29yZSwgRUNPQlVTKTsKIAotCQlm
d19kb21haW5faW5pdCh1bmNvcmUsIEZXX0RPTUFJTl9JRF9SRU5ERVIsCi0JCQkgICAgICAgRk9S
Q0VXQUtFX01ULCBGT1JDRVdBS0VfTVRfQUNLKTsKKwkJX19md19kb21haW5faW5pdChGV19ET01B
SU5fSURfUkVOREVSLAorCQkJCSBGT1JDRVdBS0VfTVQsIEZPUkNFV0FLRV9NVF9BQ0spOwogCiAJ
CXNwaW5fbG9ja19pcnEoJnVuY29yZS0+bG9jayk7CiAJCWZ3X2RvbWFpbnNfZ2V0X3dpdGhfdGhy
ZWFkX3N0YXR1cyh1bmNvcmUsIEZPUkNFV0FLRV9SRU5ERVIpOwpAQCAtMTQ0MiwxOSArMTQ2Miwy
OCBAQCBzdGF0aWMgdm9pZCBpbnRlbF91bmNvcmVfZndfZG9tYWluc19pbml0KHN0cnVjdCBpbnRl
bF91bmNvcmUgKnVuY29yZSkKIAkJaWYgKCEoZWNvYnVzICYgRk9SQ0VXQUtFX01UX0VOQUJMRSkp
IHsKIAkJCURSTV9JTkZPKCJObyBNVCBmb3JjZXdha2UgYXZhaWxhYmxlIG9uIEl2eWJyaWRnZSwg
dGhpcyBjYW4gcmVzdWx0IGluIGlzc3Vlc1xuIik7CiAJCQlEUk1fSU5GTygid2hlbiB1c2luZyB2
Ymxhbmstc3luY2VkIHBhcnRpYWwgc2NyZWVuIHVwZGF0ZXMuXG4iKTsKLQkJCWZ3X2RvbWFpbl9p
bml0KHVuY29yZSwgRldfRE9NQUlOX0lEX1JFTkRFUiwKLQkJCQkgICAgICAgRk9SQ0VXQUtFLCBG
T1JDRVdBS0VfQUNLKTsKKwkJCV9fZndfZG9tYWluX2luaXQoRldfRE9NQUlOX0lEX1JFTkRFUiwK
KwkJCQkJIEZPUkNFV0FLRSwgRk9SQ0VXQUtFX0FDSyk7CiAJCX0KIAl9IGVsc2UgaWYgKElTX0dF
TihpOTE1LCA2KSkgewogCQl1bmNvcmUtPmZ1bmNzLmZvcmNlX3dha2VfZ2V0ID0KIAkJCWZ3X2Rv
bWFpbnNfZ2V0X3dpdGhfdGhyZWFkX3N0YXR1czsKIAkJdW5jb3JlLT5mdW5jcy5mb3JjZV93YWtl
X3B1dCA9IGZ3X2RvbWFpbnNfcHV0OwotCQlmd19kb21haW5faW5pdCh1bmNvcmUsIEZXX0RPTUFJ
Tl9JRF9SRU5ERVIsCi0JCQkgICAgICAgRk9SQ0VXQUtFLCBGT1JDRVdBS0VfQUNLKTsKKwkJX19m
d19kb21haW5faW5pdChGV19ET01BSU5fSURfUkVOREVSLAorCQkJCSBGT1JDRVdBS0UsIEZPUkNF
V0FLRV9BQ0spOwogCX0KIAorI3VuZGVmIF9fZndfZG9tYWluX2luaXQKKwogCS8qIEFsbCBmdXR1
cmUgcGxhdGZvcm1zIGFyZSBleHBlY3RlZCB0byByZXF1aXJlIGNvbXBsZXggcG93ZXIgZ2F0aW5n
ICovCiAJV0FSTl9PTih1bmNvcmUtPmZ3X2RvbWFpbnMgPT0gMCk7CisKKwlyZXR1cm4gMDsKKwor
b3V0X2NsZWFuOgorCWludGVsX3VuY29yZV9md19kb21haW5zX2ZpbmkodW5jb3JlKTsKKwlyZXR1
cm4gcmV0OworCiB9CiAKICNkZWZpbmUgQVNTSUdOX0ZXX0RPTUFJTlNfVEFCTEUodW5jb3JlLCBk
KSBcCkBAIC0xNTU0LDcgKzE1ODMsMTIgQEAgaW50IGludGVsX3VuY29yZV9pbml0X21taW8oc3Ry
dWN0IGludGVsX3VuY29yZSAqdW5jb3JlKQogCWlmIChJTlRFTF9HRU4oaTkxNSkgPiA1ICYmICFp
bnRlbF92Z3B1X2FjdGl2ZShpOTE1KSkKIAkJdW5jb3JlLT5mbGFncyB8PSBVTkNPUkVfSEFTX0ZP
UkNFV0FLRTsKIAotCWludGVsX3VuY29yZV9md19kb21haW5zX2luaXQodW5jb3JlKTsKKwlyZXQg
PSBpbnRlbF91bmNvcmVfZndfZG9tYWluc19pbml0KHVuY29yZSk7CisJaWYgKHJldCkgeworCQl1
bmNvcmVfbW1pb19jbGVhbnVwKHVuY29yZSk7CisJCXJldHVybiByZXQ7CisJfQorCiAJX19pbnRl
bF91bmNvcmVfZWFybHlfc2FuaXRpemUodW5jb3JlLCAwKTsKIAogCXVuY29yZS0+dW5jbGFpbWVk
X21taW9fY2hlY2sgPSAxOwpAQCAtMTY2Miw2ICsxNjk2LDcgQEAgdm9pZCBpbnRlbF91bmNvcmVf
ZmluaV9tbWlvKHN0cnVjdCBpbnRlbF91bmNvcmUgKnVuY29yZSkKIAlpb3NmX21iaV91bnJlZ2lz
dGVyX3BtaWNfYnVzX2FjY2Vzc19ub3RpZmllcl91bmxvY2tlZCgKIAkJJnVuY29yZS0+cG1pY19i
dXNfYWNjZXNzX25iKTsKIAlpbnRlbF91bmNvcmVfZm9yY2V3YWtlX3Jlc2V0KHVuY29yZSk7CisJ
aW50ZWxfdW5jb3JlX2Z3X2RvbWFpbnNfZmluaSh1bmNvcmUpOwogCWlvc2ZfbWJpX3B1bml0X3Jl
bGVhc2UoKTsKIAl1bmNvcmVfbW1pb19jbGVhbnVwKHVuY29yZSk7CiB9CmRpZmYgLS1naXQgYS9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9pbnRlbF91bmNvcmUuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2ludGVsX3VuY29yZS5oCmluZGV4IGJmMDZiNmIxNjg5Mi4uMmJiODA5NjJlN2M1IDEwMDY0NAot
LS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pbnRlbF91bmNvcmUuaAorKysgYi9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9pbnRlbF91bmNvcmUuaApAQCAtMTI1LDYgKzEyNSw3IEBAIHN0cnVjdCBpbnRl
bF91bmNvcmUgewogCWVudW0gZm9yY2V3YWtlX2RvbWFpbnMgZndfZG9tYWluc19zYXZlZDsgLyog
dXNlciBkb21haW5zIHNhdmVkIGZvciBTMyAqLwogCiAJc3RydWN0IGludGVsX3VuY29yZV9mb3Jj
ZXdha2VfZG9tYWluIHsKKwkJc3RydWN0IGludGVsX3VuY29yZSAqdW5jb3JlOwogCQllbnVtIGZv
cmNld2FrZV9kb21haW5faWQgaWQ7CiAJCWVudW0gZm9yY2V3YWtlX2RvbWFpbnMgbWFzazsKIAkJ
dW5zaWduZWQgaW50IHdha2VfY291bnQ7CkBAIC0xMzIsNyArMTMzLDcgQEAgc3RydWN0IGludGVs
X3VuY29yZSB7CiAJCXN0cnVjdCBocnRpbWVyIHRpbWVyOwogCQl1MzIgX19pb21lbSAqcmVnX3Nl
dDsKIAkJdTMyIF9faW9tZW0gKnJlZ19hY2s7Ci0JfSBmd19kb21haW5bRldfRE9NQUlOX0lEX0NP
VU5UXTsKKwl9ICpmd19kb21haW5bRldfRE9NQUlOX0lEX0NPVU5UXTsKIAogCXN0cnVjdCB7CiAJ
CXVuc2lnbmVkIGludCBjb3VudDsKQEAgLTE0NiwxOCArMTQ3LDEyIEBAIHN0cnVjdCBpbnRlbF91
bmNvcmUgewogCiAvKiBJdGVyYXRlIG92ZXIgaW5pdGlhbGlzZWQgZncgZG9tYWlucyAqLwogI2Rl
ZmluZSBmb3JfZWFjaF9md19kb21haW5fbWFza2VkKGRvbWFpbl9fLCBtYXNrX18sIHVuY29yZV9f
LCB0bXBfXykgXAotCWZvciAodG1wX18gPSAobWFza19fKTsgXAotCSAgICAgdG1wX18gPyAoZG9t
YWluX18gPSAmKHVuY29yZV9fKS0+ZndfZG9tYWluW19fbWFza19uZXh0X2JpdCh0bXBfXyldKSwg
MSA6IDA7KQorCWZvciAodG1wX18gPSAobWFza19fKTsgdG1wX18gOykgXAorCQlmb3JfZWFjaF9p
Zihkb21haW5fXyA9ICh1bmNvcmVfXyktPmZ3X2RvbWFpbltfX21hc2tfbmV4dF9iaXQodG1wX18p
XSkKIAogI2RlZmluZSBmb3JfZWFjaF9md19kb21haW4oZG9tYWluX18sIHVuY29yZV9fLCB0bXBf
XykgXAogCWZvcl9lYWNoX2Z3X2RvbWFpbl9tYXNrZWQoZG9tYWluX18sICh1bmNvcmVfXyktPmZ3
X2RvbWFpbnMsIHVuY29yZV9fLCB0bXBfXykKIAotc3RhdGljIGlubGluZSBzdHJ1Y3QgaW50ZWxf
dW5jb3JlICoKLWZvcmNld2FrZV9kb21haW5fdG9fdW5jb3JlKGNvbnN0IHN0cnVjdCBpbnRlbF91
bmNvcmVfZm9yY2V3YWtlX2RvbWFpbiAqZCkKLXsKLQlyZXR1cm4gY29udGFpbmVyX29mKGQsIHN0
cnVjdCBpbnRlbF91bmNvcmUsIGZ3X2RvbWFpbltkLT5pZF0pOwotfQotCiBzdGF0aWMgaW5saW5l
IGJvb2wKIGludGVsX3VuY29yZV9oYXNfZm9yY2V3YWtlKGNvbnN0IHN0cnVjdCBpbnRlbF91bmNv
cmUgKnVuY29yZSkKIHsKLS0gCjIuMjAuMQoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMu
ZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlz
dGluZm8vaW50ZWwtZ2Z4

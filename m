Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 81A2BE19E4
	for <lists+intel-gfx@lfdr.de>; Wed, 23 Oct 2019 14:22:13 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id C730D6EA71;
	Wed, 23 Oct 2019 12:22:11 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id EC6666EA6E
 for <intel-gfx@lists.freedesktop.org>; Wed, 23 Oct 2019 12:22:02 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18936918-1500050 
 for <intel-gfx@lists.freedesktop.org>; Wed, 23 Oct 2019 13:22:00 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Wed, 23 Oct 2019 13:21:51 +0100
Message-Id: <20191023122151.5017-4-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.24.0.rc0
In-Reply-To: <20191023122151.5017-1-chris@chris-wilson.co.uk>
References: <20191023122151.5017-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [CI 4/4] drm/i915/gem: Cancel contexts when
 hangchecking is disabled
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

Tm9ybWFsbHksIHdlIHJlbHkgb24gb3VyIGhhbmdjaGVjayB0byBwcmV2ZW50IHBlcnNpc3RlbnQg
YmF0Y2hlcyBmcm9tCmhvZ2dpbmcgdGhlIEdQVS4gSG93ZXZlciwgaWYgdGhlIHVzZXIgZGlzYWJs
ZXMgaGFuZ2NoZWNrLCB0aGlzIG1lY2hhbmlzbQpicmVha3MgZG93bi4gRGVzcGl0ZSBvdXIgaW5z
aXN0ZW5jZSB0aGF0IHRoaXMgaXMgdW5zYWZlLCB0aGUgdXNlcnMgYXJlCmVxdWFsbHkgaW5zaXN0
ZW50IHRoYXQgdGhleSB3YW50IHRvIHVzZSBlbmRsZXNzIGJhdGNoZXMgYW5kIHdpbGwgZGlzYWJs
ZQp0aGUgaGFuZ2NoZWNrIG1lY2hhbmlzbS4gV2UgYXJlIGxvb2tpbmcgYXQgcmVwbGFjaW5nIGhh
bmdjaGVjaywgaW4gdGhlCm5leHQgcGF0Y2gsIHdpdGggYSBzb2Z0ZXIgbWVjaGFuaXNtLCB0aGF0
IHNlbmRzIGEgcHVsc2UgZG93biB0aGUgZW5naW5lCnRvIGNoZWNrIGlmIGl0IGlzIHdlbGwuIFdl
IGNhbiB1c2UgdGhlIHNhbWUgcHJlZW1wdGl2ZSBwdWxzZSB0byBmbHVzaCBhbgphY3RpdmUgY29u
dGV4dCBvZmYgdGhlIEdQVSB1cG9uIGNvbnRleHQgY2xvc2UsIHByZXZlbnRpbmcgcmVzb3VyY2Vz
CmJlaW5nIGxvc3QgYW5kIHVua2lsbGFibGUgcmVxdWVzdHMgcmVtYWluaW5nIG9uIHRoZSBHUFUg
YWZ0ZXIgcHJvY2Vzcwp0ZXJtaW5hdGlvbi4KClRlc3RjYXNlOiBpZ3QvZ2VtX2N0eF9leGVjL2Jh
c2ljLW5vaGFuZ2NoZWNrClNpZ25lZC1vZmYtYnk6IENocmlzIFdpbHNvbiA8Y2hyaXNAY2hyaXMt
d2lsc29uLmNvLnVrPgpDYzogSm9vbmFzIExhaHRpbmVuIDxqb29uYXMubGFodGluZW5AbGludXgu
aW50ZWwuY29tPgpDYzogTWljaGHFgiBXaW5pYXJza2kgPG1pY2hhbC53aW5pYXJza2lAaW50ZWwu
Y29tPgpDYzogSm9uIEJsb29tZmllbGQgPGpvbi5ibG9vbWZpZWxkQGludGVsLmNvbT4KUmV2aWV3
ZWQtYnk6IEpvbiBCbG9vbWZpZWxkIDxqb24uYmxvb21maWVsZEBpbnRlbC5jb20+ClJldmlld2Vk
LWJ5OiBUdnJ0a28gVXJzdWxpbiA8dHZydGtvLnVyc3VsaW5AaW50ZWwuY29tPgotLS0KIGRyaXZl
cnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jb250ZXh0LmMgfCAxNDEgKysrKysrKysrKysr
KysrKysrKysKIDEgZmlsZSBjaGFuZ2VkLCAxNDEgaW5zZXJ0aW9ucygrKQoKZGlmZiAtLWdpdCBh
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jb250ZXh0LmMgYi9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fY29udGV4dC5jCmluZGV4IDdiMDFmNDYwNWYyMS4uYjJm
MDQyZDg3YmUwIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1f
Y29udGV4dC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9jb250ZXh0
LmMKQEAgLTcwLDYgKzcwLDcgQEAKICNpbmNsdWRlIDxkcm0vaTkxNV9kcm0uaD4KIAogI2luY2x1
ZGUgImd0L2ludGVsX2xyY19yZWcuaCIKKyNpbmNsdWRlICJndC9pbnRlbF9lbmdpbmVfaGVhcnRi
ZWF0LmgiCiAjaW5jbHVkZSAiZ3QvaW50ZWxfZW5naW5lX3VzZXIuaCIKIAogI2luY2x1ZGUgImk5
MTVfZ2VtX2NvbnRleHQuaCIKQEAgLTI3Niw2ICsyNzcsMTM1IEBAIHZvaWQgaTkxNV9nZW1fY29u
dGV4dF9yZWxlYXNlKHN0cnVjdCBrcmVmICpyZWYpCiAJCXNjaGVkdWxlX3dvcmsoJmdjLT5mcmVl
X3dvcmspOwogfQogCitzdGF0aWMgaW5saW5lIHN0cnVjdCBpOTE1X2dlbV9lbmdpbmVzICoKK19f
Y29udGV4dF9lbmdpbmVzX3N0YXRpYyhjb25zdCBzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4
KQoreworCXJldHVybiByY3VfZGVyZWZlcmVuY2VfcHJvdGVjdGVkKGN0eC0+ZW5naW5lcywgdHJ1
ZSk7Cit9CisKK3N0YXRpYyBib29sIF9fcmVzZXRfZW5naW5lKHN0cnVjdCBpbnRlbF9lbmdpbmVf
Y3MgKmVuZ2luZSkKK3sKKwlzdHJ1Y3QgaW50ZWxfZ3QgKmd0ID0gZW5naW5lLT5ndDsKKwlib29s
IHN1Y2Nlc3MgPSBmYWxzZTsKKworCWlmICghaW50ZWxfaGFzX3Jlc2V0X2VuZ2luZShndCkpCisJ
CXJldHVybiBmYWxzZTsKKworCWlmICghdGVzdF9hbmRfc2V0X2JpdChJOTE1X1JFU0VUX0VOR0lO
RSArIGVuZ2luZS0+aWQsCisJCQkgICAgICAmZ3QtPnJlc2V0LmZsYWdzKSkgeworCQlzdWNjZXNz
ID0gaW50ZWxfZW5naW5lX3Jlc2V0KGVuZ2luZSwgTlVMTCkgPT0gMDsKKwkJY2xlYXJfYW5kX3dh
a2VfdXBfYml0KEk5MTVfUkVTRVRfRU5HSU5FICsgZW5naW5lLT5pZCwKKwkJCQkgICAgICAmZ3Qt
PnJlc2V0LmZsYWdzKTsKKwl9CisKKwlyZXR1cm4gc3VjY2VzczsKK30KKworc3RhdGljIHZvaWQg
X19yZXNldF9jb250ZXh0KHN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICpjdHgsCisJCQkgICAgc3Ry
dWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lKQoreworCWludGVsX2d0X2hhbmRsZV9lcnJvcihl
bmdpbmUtPmd0LCBlbmdpbmUtPm1hc2ssIDAsCisJCQkgICAgICAiY29udGV4dCBjbG9zdXJlIGlu
ICVzIiwgY3R4LT5uYW1lKTsKK30KKworc3RhdGljIGJvb2wgX19jYW5jZWxfZW5naW5lKHN0cnVj
dCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKK3sKKwkvKgorCSAqIFNlbmQgYSAiaGlnaCBwcmlv
cml0eSBwdWxzZSIgZG93biB0aGUgZW5naW5lIHRvIGNhdXNlIHRoZQorCSAqIGN1cnJlbnQgcmVx
dWVzdCB0byBiZSBtb21lbnRhcmlseSBwcmVlbXB0ZWQuIChJZiBpdCBmYWlscyB0bworCSAqIGJl
IHByZWVtcHRlZCwgaXQgd2lsbCBiZSByZXNldCkuIEFzIHdlIGhhdmUgbWFya2VkIG91ciBjb250
ZXh0CisJICogYXMgYmFubmVkLCBhbnkgaW5jb21wbGV0ZSByZXF1ZXN0LCBpbmNsdWRpbmcgYW55
IHJ1bm5pbmcsIHdpbGwKKwkgKiBiZSBza2lwcGVkIGZvbGxvd2luZyB0aGUgcHJlZW1wdGlvbi4K
KwkgKgorCSAqIElmIHRoZXJlIGlzIG5vIGhhbmdjaGVja2luZyAob25lIG9mIHRoZSByZWFzb25z
IHdoeSB3ZSB0cnkgdG8KKwkgKiBjYW5jZWwgdGhlIGNvbnRleHQpIGFuZCBubyBmb3JjZWQgcHJl
ZW1wdGlvbiwgdGhlcmUgbWF5IGJlIG5vCisJICogbWVhbnMgYnkgd2hpY2ggd2UgcmVzZXQgdGhl
IEdQVSBhbmQgZXZpY3QgdGhlIHBlcnNpc3RlbnQgaG9nLgorCSAqIEVyZ28gaWYgd2UgYXJlIHVu
YWJsZSB0byBpbmplY3QgYSBwcmVlbXB0aXZlIHB1bHNlIHRoYXQgY2FuCisJICoga2lsbCB0aGUg
YmFubmVkIGNvbnRleHQsIHdlIGZhbGxiYWNrIHRvIGRvaW5nIGEgbG9jYWwgcmVzZXQKKwkgKiBp
bnN0ZWFkLgorCSAqLworCWlmIChDT05GSUdfRFJNX0k5MTVfUFJFRU1QVF9USU1FT1VUICYmICFp
bnRlbF9lbmdpbmVfcHVsc2UoZW5naW5lKSkKKwkJcmV0dXJuIHRydWU7CisKKwkvKiBJZiB3ZSBh
cmUgdW5hYmxlIHRvIHNlbmQgYSBwdWxzZSwgdHJ5IHJlc2V0dGluZyB0aGlzIGVuZ2luZS4gKi8K
KwlyZXR1cm4gX19yZXNldF9lbmdpbmUoZW5naW5lKTsKK30KKworc3RhdGljIHN0cnVjdCBpbnRl
bF9lbmdpbmVfY3MgKgorYWN0aXZlX2VuZ2luZShzdHJ1Y3QgZG1hX2ZlbmNlICpmZW5jZSwgc3Ry
dWN0IGludGVsX2NvbnRleHQgKmNlKQoreworCXN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxID0gdG9f
cmVxdWVzdChmZW5jZSk7CisJc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lLCAqbG9ja2Vk
OworCisJLyoKKwkgKiBTZXJpYWxpc2Ugd2l0aCBfX2k5MTVfcmVxdWVzdF9zdWJtaXQoKSBzbyB0
aGF0IGl0IHNlZXMKKwkgKiBpcy1iYW5uZWQ/LCBvciB3ZSBrbm93IHRoZSByZXF1ZXN0IGlzIGFs
cmVhZHkgaW5mbGlnaHQuCisJICovCisJbG9ja2VkID0gUkVBRF9PTkNFKHJxLT5lbmdpbmUpOwor
CXNwaW5fbG9ja19pcnEoJmxvY2tlZC0+YWN0aXZlLmxvY2spOworCXdoaWxlICh1bmxpa2VseShs
b2NrZWQgIT0gKGVuZ2luZSA9IFJFQURfT05DRShycS0+ZW5naW5lKSkpKSB7CisJCXNwaW5fdW5s
b2NrKCZsb2NrZWQtPmFjdGl2ZS5sb2NrKTsKKwkJc3Bpbl9sb2NrKCZlbmdpbmUtPmFjdGl2ZS5s
b2NrKTsKKwkJbG9ja2VkID0gZW5naW5lOworCX0KKworCWVuZ2luZSA9IE5VTEw7CisJaWYgKGk5
MTVfcmVxdWVzdF9pc19hY3RpdmUocnEpICYmICFycS0+ZmVuY2UuZXJyb3IpCisJCWVuZ2luZSA9
IHJxLT5lbmdpbmU7CisKKwlzcGluX3VubG9ja19pcnEoJmxvY2tlZC0+YWN0aXZlLmxvY2spOwor
CisJcmV0dXJuIGVuZ2luZTsKK30KKworc3RhdGljIHZvaWQga2lsbF9jb250ZXh0KHN0cnVjdCBp
OTE1X2dlbV9jb250ZXh0ICpjdHgpCit7CisJc3RydWN0IGk5MTVfZ2VtX2VuZ2luZXNfaXRlciBp
dDsKKwlzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2U7CisKKwkvKgorCSAqIElmIHdlIGFyZSBhbHJl
YWR5IGJhbm5lZCwgaXQgd2FzIGR1ZSB0byBhIGd1aWx0eSByZXF1ZXN0IGNhdXNpbmcKKwkgKiBh
IHJlc2V0IGFuZCB0aGUgZW50aXJlIGNvbnRleHQgYmVpbmcgZXZpY3RlZCBmcm9tIHRoZSBHUFUu
CisJICovCisJaWYgKGk5MTVfZ2VtX2NvbnRleHRfaXNfYmFubmVkKGN0eCkpCisJCXJldHVybjsK
KworCWk5MTVfZ2VtX2NvbnRleHRfc2V0X2Jhbm5lZChjdHgpOworCisJLyoKKwkgKiBNYXAgdGhl
IHVzZXIncyBlbmdpbmUgYmFjayB0byB0aGUgYWN0dWFsIGVuZ2luZXM7IG9uZSB2aXJ0dWFsCisJ
ICogZW5naW5lIHdpbGwgYmUgbWFwcGVkIHRvIG11bHRpcGxlIGVuZ2luZXMsIGFuZCB1c2luZyBj
dHgtPmVuZ2luZVtdCisJICogdGhlIHNhbWUgZW5naW5lIG1heSBiZSBoYXZlIG11bHRpcGxlIGlu
c3RhbmNlcyBpbiB0aGUgdXNlcidzIG1hcC4KKwkgKiBIb3dldmVyLCB3ZSBvbmx5IGNhcmUgYWJv
dXQgcGVuZGluZyByZXF1ZXN0cywgc28gb25seSBpbmNsdWRlCisJICogZW5naW5lcyBvbiB3aGlj
aCB0aGVyZSBhcmUgaW5jb21wbGV0ZSByZXF1ZXN0cy4KKwkgKi8KKwlmb3JfZWFjaF9nZW1fZW5n
aW5lKGNlLCBfX2NvbnRleHRfZW5naW5lc19zdGF0aWMoY3R4KSwgaXQpIHsKKwkJc3RydWN0IGlu
dGVsX2VuZ2luZV9jcyAqZW5naW5lOworCQlzdHJ1Y3QgZG1hX2ZlbmNlICpmZW5jZTsKKworCQlp
ZiAoIWNlLT50aW1lbGluZSkKKwkJCWNvbnRpbnVlOworCisJCWZlbmNlID0gaTkxNV9hY3RpdmVf
ZmVuY2VfZ2V0KCZjZS0+dGltZWxpbmUtPmxhc3RfcmVxdWVzdCk7CisJCWlmICghZmVuY2UpCisJ
CQljb250aW51ZTsKKworCQkvKiBDaGVjayB3aXRoIHRoZSBiYWNrZW5kIGlmIHRoZSByZXF1ZXN0
IGlzIHN0aWxsIGluZmxpZ2h0ICovCisJCWVuZ2luZSA9IGFjdGl2ZV9lbmdpbmUoZmVuY2UsIGNl
KTsKKworCQkvKiBGaXJzdCBhdHRlbXB0IHRvIGdyYWNlZnVsbHkgY2FuY2VsIHRoZSBjb250ZXh0
ICovCisJCWlmIChlbmdpbmUgJiYgIV9fY2FuY2VsX2VuZ2luZShlbmdpbmUpKQorCQkJLyoKKwkJ
CSAqIElmIHdlIGFyZSB1bmFibGUgdG8gc2VuZCBhIHByZWVtcHRpdmUgcHVsc2UgdG8gYnVtcAor
CQkJICogdGhlIGNvbnRleHQgZnJvbSB0aGUgR1BVLCB3ZSBoYXZlIHRvIHJlc29ydCB0byBhIGZ1
bGwKKwkJCSAqIHJlc2V0LiBXZSBob3BlIHRoZSBjb2xsYXRlcmFsIGRhbWFnZSBpcyB3b3J0aCBp
dC4KKwkJCSAqLworCQkJX19yZXNldF9jb250ZXh0KGN0eCwgZW5naW5lKTsKKworCQlkbWFfZmVu
Y2VfcHV0KGZlbmNlKTsKKwl9Cit9CisKIHN0YXRpYyB2b2lkIGNvbnRleHRfY2xvc2Uoc3RydWN0
IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCkKIHsKIAlzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2
bTsKQEAgLTI5OCw2ICs0MjgsMTcgQEAgc3RhdGljIHZvaWQgY29udGV4dF9jbG9zZShzdHJ1Y3Qg
aTkxNV9nZW1fY29udGV4dCAqY3R4KQogCWx1dF9jbG9zZShjdHgpOwogCiAJbXV0ZXhfdW5sb2Nr
KCZjdHgtPm11dGV4KTsKKworCS8qCisJICogSWYgdGhlIHVzZXIgaGFzIGRpc2FibGVkIGhhbmdj
aGVja2luZywgd2UgY2FuIG5vdCBiZSBzdXJlIHRoYXQKKwkgKiB0aGUgYmF0Y2hlcyB3aWxsIGV2
ZXIgY29tcGxldGUgYWZ0ZXIgdGhlIGNvbnRleHQgaXMgY2xvc2VkLAorCSAqIGtlZXBpbmcgdGhl
IGNvbnRleHQgYW5kIGFsbCByZXNvdXJjZXMgcGlubmVkIGZvcmV2ZXIuIFNvIGluIHRoaXMKKwkg
KiBjYXNlIHdlIG9wdCB0byBmb3JjaWJseSBraWxsIG9mZiBhbGwgcmVtYWluaW5nIHJlcXVlc3Rz
IG9uCisJICogY29udGV4dCBjbG9zZS4KKwkgKi8KKwlpZiAoIWk5MTVfbW9kcGFyYW1zLmVuYWJs
ZV9oYW5nY2hlY2spCisJCWtpbGxfY29udGV4dChjdHgpOworCiAJaTkxNV9nZW1fY29udGV4dF9w
dXQoY3R4KTsKIH0KIAotLSAKMi4yNC4wLnJjMAoKX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlz
dHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4v
bGlzdGluZm8vaW50ZWwtZ2Z4

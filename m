Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id C5FA189FD7
	for <lists+intel-gfx@lfdr.de>; Mon, 12 Aug 2019 15:39:44 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 10D3589BD4;
	Mon, 12 Aug 2019 13:39:43 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 55D1089BD4
 for <intel-gfx@lists.freedesktop.org>; Mon, 12 Aug 2019 13:39:39 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17969922-1500050 
 for multiple; Mon, 12 Aug 2019 14:39:18 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 12 Aug 2019 14:39:05 +0100
Message-Id: <20190812133915.18824-8-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0.rc1
In-Reply-To: <20190812133915.18824-1-chris@chris-wilson.co.uk>
References: <20190812133915.18824-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 08/18] drm/i915: Protect request retirement with
 timeline->mutex
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

Rm9yZ28gdGhlIHN0cnVjdF9tdXRleCByZXF1aXJlbWVudCBmb3IgcmVxdWVzdCByZXRpcmVtZW50
IGFzIHdlIGhhdmUKYmVlbiB0cmFuc2l0aW9uaW5nIG92ZXIgdG8gb25seSB1c2luZyB0aGUgdGlt
ZWxpbmUtPm11dGV4IGZvcgpjb250cm9sbGluZyB0aGUgbGlmZXRpbWUgb2YgYSByZXF1ZXN0IG9u
IHRoYXQgdGltZWxpbmUuCgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNocmlzQGNocmlz
LXdpbHNvbi5jby51az4KLS0tCiAuLi4vZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9leGVjYnVm
ZmVyLmMgICAgfCAxODMgKysrKysrKysrKy0tLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9n
dC9pbnRlbF9jb250ZXh0LmggICAgICAgfCAgMTggKy0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0
L2ludGVsX2VuZ2luZV9jcy5jICAgICB8ICAgMSAtCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9p
bnRlbF9lbmdpbmVfdHlwZXMuaCAgfCAgIDMgLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50
ZWxfZ3QuYyAgICAgICAgICAgIHwgICAyIC0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVs
X2d0X3R5cGVzLmggICAgICB8ICAgMiAtCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9s
cmMuYyAgICAgICAgICAgfCAgIDEgKwogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfcmlu
Z2J1ZmZlci5jICAgIHwgIDE5ICstCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9tb2NrX2VuZ2lu
ZS5jICAgICAgICAgfCAgIDEgLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Qvc2VsZnRlc3RfY29u
dGV4dC5jICAgIHwgICA5ICstCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3JlcXVlc3QuYyAg
ICAgICAgICAgfCAxNTYgKysrKysrKy0tLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1
X3JlcXVlc3QuaCAgICAgICAgICAgfCAgIDMgLQogMTIgZmlsZXMgY2hhbmdlZCwgMjA5IGluc2Vy
dGlvbnMoKyksIDE4OSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9nZW0vaTkxNV9nZW1fZXhlY2J1ZmZlci5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2Vt
L2k5MTVfZ2VtX2V4ZWNidWZmZXIuYwppbmRleCA1MzNkYjJiMWZhZTkuLmI4NDMyYzM0MzdlOSAx
MDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2V4ZWNidWZmZXIu
YworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fZXhlY2J1ZmZlci5jCkBA
IC03MzUsNjMgKzczNSw2IEBAIHN0YXRpYyBpbnQgZWJfc2VsZWN0X2NvbnRleHQoc3RydWN0IGk5
MTVfZXhlY2J1ZmZlciAqZWIpCiAJcmV0dXJuIDA7CiB9CiAKLXN0YXRpYyBzdHJ1Y3QgaTkxNV9y
ZXF1ZXN0ICpfX2ViX3dhaXRfZm9yX3Jpbmcoc3RydWN0IGludGVsX3JpbmcgKnJpbmcpCi17Ci0J
c3RydWN0IGk5MTVfcmVxdWVzdCAqcnE7Ci0KLQkvKgotCSAqIENvbXBsZXRlbHkgdW5zY2llbnRp
ZmljIGZpbmdlci1pbi10aGUtYWlyIGVzdGltYXRlcyBmb3Igc3VpdGFibGUKLQkgKiBtYXhpbXVt
IHVzZXIgcmVxdWVzdCBzaXplICh0byBhdm9pZCBibG9ja2luZykgYW5kIHRoZW4gYmFja29mZi4K
LQkgKi8KLQlpZiAoaW50ZWxfcmluZ191cGRhdGVfc3BhY2UocmluZykgPj0gUEFHRV9TSVpFKQot
CQlyZXR1cm4gTlVMTDsKLQotCS8qCi0JICogRmluZCBhIHJlcXVlc3QgdGhhdCBhZnRlciB3YWl0
aW5nIHVwb24sIHRoZXJlIHdpbGwgYmUgYXQgbGVhc3QgaGFsZgotCSAqIHRoZSByaW5nIGF2YWls
YWJsZS4gVGhlIGh5c3RlcmVzaXMgYWxsb3dzIHVzIHRvIGNvbXBldGUgZm9yIHRoZQotCSAqIHNo
YXJlZCByaW5nIGFuZCBzaG91bGQgbWVhbiB0aGF0IHdlIHNsZWVwIGxlc3Mgb2Z0ZW4gcHJpb3Ig
dG8KLQkgKiBjbGFpbWluZyBvdXIgcmVzb3VyY2VzLCBidXQgbm90IHNvIGxvbmcgdGhhdCB0aGUg
cmluZyBjb21wbGV0ZWx5Ci0JICogZHJhaW5zIGJlZm9yZSB3ZSBjYW4gc3VibWl0IG91ciBuZXh0
IHJlcXVlc3QuCi0JICovCi0JbGlzdF9mb3JfZWFjaF9lbnRyeShycSwgJnJpbmctPnJlcXVlc3Rf
bGlzdCwgcmluZ19saW5rKSB7Ci0JCWlmIChfX2ludGVsX3Jpbmdfc3BhY2UocnEtPnBvc3RmaXgs
Ci0JCQkJICAgICAgIHJpbmctPmVtaXQsIHJpbmctPnNpemUpID4gcmluZy0+c2l6ZSAvIDIpCi0J
CQlicmVhazsKLQl9Ci0JaWYgKCZycS0+cmluZ19saW5rID09ICZyaW5nLT5yZXF1ZXN0X2xpc3Qp
Ci0JCXJldHVybiBOVUxMOyAvKiB3ZWlyZCwgd2Ugd2lsbCBjaGVjayBhZ2FpbiBsYXRlciBmb3Ig
cmVhbCAqLwotCi0JcmV0dXJuIGk5MTVfcmVxdWVzdF9nZXQocnEpOwotfQotCi1zdGF0aWMgaW50
IGViX3dhaXRfZm9yX3JpbmcoY29uc3Qgc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIpCi17Ci0J
c3RydWN0IGk5MTVfcmVxdWVzdCAqcnE7Ci0JaW50IHJldCA9IDA7Ci0KLQkvKgotCSAqIEFwcGx5
IGEgbGlnaHQgYW1vdW50IG9mIGJhY2twcmVzc3VyZSB0byBwcmV2ZW50IGV4Y2Vzc2l2ZSBob2dz
Ci0JICogZnJvbSBibG9ja2luZyB3YWl0aW5nIGZvciBzcGFjZSB3aGlsc3QgaG9sZGluZyBzdHJ1
Y3RfbXV0ZXggYW5kCi0JICoga2VlcGluZyBhbGwgb2YgdGhlaXIgcmVzb3VyY2VzIHBpbm5lZC4K
LQkgKi8KLQotCXJxID0gX19lYl93YWl0X2Zvcl9yaW5nKGViLT5jb250ZXh0LT5yaW5nKTsKLQlp
ZiAocnEpIHsKLQkJbXV0ZXhfdW5sb2NrKCZlYi0+aTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7Ci0K
LQkJaWYgKGk5MTVfcmVxdWVzdF93YWl0KHJxLAotCQkJCSAgICAgIEk5MTVfV0FJVF9JTlRFUlJV
UFRJQkxFLAotCQkJCSAgICAgIE1BWF9TQ0hFRFVMRV9USU1FT1VUKSA8IDApCi0JCQlyZXQgPSAt
RUlOVFI7Ci0KLQkJaTkxNV9yZXF1ZXN0X3B1dChycSk7Ci0KLQkJbXV0ZXhfbG9jaygmZWItPmk5
MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOwotCX0KLQotCXJldHVybiByZXQ7Ci19Ci0KIHN0YXRpYyBp
bnQgZWJfbG9va3VwX3ZtYXMoc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIpCiB7CiAJc3RydWN0
IHJhZGl4X3RyZWVfcm9vdCAqaGFuZGxlc192bWEgPSAmZWItPmdlbV9jb250ZXh0LT5oYW5kbGVz
X3ZtYTsKQEAgLTIxMzIsMTAgKzIwNzUsNzUgQEAgc3RhdGljIGNvbnN0IGVudW0gaW50ZWxfZW5n
aW5lX2lkIHVzZXJfcmluZ19tYXBbXSA9IHsKIAlbSTkxNV9FWEVDX1ZFQk9YXQk9IFZFQ1MwCiB9
OwogCi1zdGF0aWMgaW50IGViX3Bpbl9jb250ZXh0KHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmVi
LCBzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UpCitzdGF0aWMgc3RydWN0IGk5MTVfcmVxdWVzdCAq
ZWJfdGhyb3R0bGUoc3RydWN0IGludGVsX2NvbnRleHQgKmNlKQoreworCXN0cnVjdCBpbnRlbF9y
aW5nICpyaW5nID0gY2UtPnJpbmc7CisJc3RydWN0IGludGVsX3RpbWVsaW5lICp0bCA9IGNlLT50
aW1lbGluZTsKKwlzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycTsKKworCS8qCisJICogQ29tcGxldGVs
eSB1bnNjaWVudGlmaWMgZmluZ2VyLWluLXRoZS1haXIgZXN0aW1hdGVzIGZvciBzdWl0YWJsZQor
CSAqIG1heGltdW0gdXNlciByZXF1ZXN0IHNpemUgKHRvIGF2b2lkIGJsb2NraW5nKSBhbmQgdGhl
biBiYWNrb2ZmLgorCSAqLworCWlmIChpbnRlbF9yaW5nX3VwZGF0ZV9zcGFjZShyaW5nKSA+PSBQ
QUdFX1NJWkUpCisJCXJldHVybiBOVUxMOworCisJLyoKKwkgKiBGaW5kIGEgcmVxdWVzdCB0aGF0
IGFmdGVyIHdhaXRpbmcgdXBvbiwgdGhlcmUgd2lsbCBiZSBhdCBsZWFzdCBoYWxmCisJICogdGhl
IHJpbmcgYXZhaWxhYmxlLiBUaGUgaHlzdGVyZXNpcyBhbGxvd3MgdXMgdG8gY29tcGV0ZSBmb3Ig
dGhlCisJICogc2hhcmVkIHJpbmcgYW5kIHNob3VsZCBtZWFuIHRoYXQgd2Ugc2xlZXAgbGVzcyBv
ZnRlbiBwcmlvciB0bworCSAqIGNsYWltaW5nIG91ciByZXNvdXJjZXMsIGJ1dCBub3Qgc28gbG9u
ZyB0aGF0IHRoZSByaW5nIGNvbXBsZXRlbHkKKwkgKiBkcmFpbnMgYmVmb3JlIHdlIGNhbiBzdWJt
aXQgb3VyIG5leHQgcmVxdWVzdC4KKwkgKi8KKwlsaXN0X2Zvcl9lYWNoX2VudHJ5KHJxLCAmdGwt
PnJlcXVlc3RzLCBsaW5rKSB7CisJCWlmIChycS0+cmluZyAhPSByaW5nKQorCQkJY29udGludWU7
CisKKwkJaWYgKF9faW50ZWxfcmluZ19zcGFjZShycS0+cG9zdGZpeCwKKwkJCQkgICAgICAgcmlu
Zy0+ZW1pdCwgcmluZy0+c2l6ZSkgPiByaW5nLT5zaXplIC8gMikKKwkJCWJyZWFrOworCX0KKwlp
ZiAoJnJxLT5saW5rID09ICZ0bC0+cmVxdWVzdHMpCisJCXJldHVybiBOVUxMOyAvKiB3ZWlyZCwg
d2Ugd2lsbCBjaGVjayBhZ2FpbiBsYXRlciBmb3IgcmVhbCAqLworCisJcmV0dXJuIGk5MTVfcmVx
dWVzdF9nZXQocnEpOworfQorCitzdGF0aWMgaW50CitfX2ViX3Bpbl9jb250ZXh0KHN0cnVjdCBp
OTE1X2V4ZWNidWZmZXIgKmViLCBzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UpCiB7CiAJaW50IGVy
cjsKIAorCWlmIChsaWtlbHkoYXRvbWljX2luY19ub3RfemVybygmY2UtPnBpbl9jb3VudCkpKQor
CQlyZXR1cm4gMDsKKworCWVyciA9IG11dGV4X2xvY2tfaW50ZXJydXB0aWJsZSgmZWItPmk5MTUt
PmRybS5zdHJ1Y3RfbXV0ZXgpOworCWlmIChlcnIpCisJCXJldHVybiBlcnI7CisKKwllcnIgPSBf
X2ludGVsX2NvbnRleHRfZG9fcGluKGNlKTsKKwltdXRleF91bmxvY2soJmViLT5pOTE1LT5kcm0u
c3RydWN0X211dGV4KTsKKworCXJldHVybiBlcnI7Cit9CisKK3N0YXRpYyB2b2lkCitfX2ViX3Vu
cGluX2NvbnRleHQoc3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIsIHN0cnVjdCBpbnRlbF9jb250
ZXh0ICpjZSkKK3sKKwlpZiAobGlrZWx5KGF0b21pY19hZGRfdW5sZXNzKCZjZS0+cGluX2NvdW50
LCAtMSwgMSkpKQorCQlyZXR1cm47CisKKwltdXRleF9sb2NrKCZlYi0+aTkxNS0+ZHJtLnN0cnVj
dF9tdXRleCk7CisJaW50ZWxfY29udGV4dF91bnBpbihjZSk7CisJbXV0ZXhfdW5sb2NrKCZlYi0+
aTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7Cit9CisKK3N0YXRpYyBpbnQgX19lYl9waW5fZW5naW5l
KHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViLCBzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UpCit7
CisJc3RydWN0IGludGVsX3RpbWVsaW5lICp0bDsKKwlzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycTsK
KwlpbnQgZXJyOworCiAJLyoKIAkgKiBBQkk6IEJlZm9yZSB1c2Vyc3BhY2UgYWNjZXNzZXMgdGhl
IEdQVSAoZS5nLiBleGVjYnVmZmVyKSwgcmVwb3J0CiAJICogRUlPIGlmIHRoZSBHUFUgaXMgYWxy
ZWFkeSB3ZWRnZWQuCkBAIC0yMTQ5LDcgKzIxNTcsNyBAQCBzdGF0aWMgaW50IGViX3Bpbl9jb250
ZXh0KHN0cnVjdCBpOTE1X2V4ZWNidWZmZXIgKmViLCBzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2Up
CiAJICogR0dUVCBzcGFjZSwgc28gZG8gdGhpcyBmaXJzdCBiZWZvcmUgd2UgcmVzZXJ2ZSBhIHNl
cW5vIGZvcgogCSAqIG91cnNlbHZlcy4KIAkgKi8KLQllcnIgPSBpbnRlbF9jb250ZXh0X3Bpbihj
ZSk7CisJZXJyID0gX19lYl9waW5fY29udGV4dChlYiwgY2UpOwogCWlmIChlcnIpCiAJCXJldHVy
biBlcnI7CiAKQEAgLTIxNjEsMjMgKzIxNjksNDMgQEAgc3RhdGljIGludCBlYl9waW5fY29udGV4
dChzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYiwgc3RydWN0IGludGVsX2NvbnRleHQgKmNlKQog
CSAqIHVudGlsIHRoZSB0aW1lbGluZSBpcyBpZGxlLCB3aGljaCBpbiB0dXJuIHJlbGVhc2VzIHRo
ZSB3YWtlcmVmCiAJICogdGFrZW4gb24gdGhlIGVuZ2luZSwgYW5kIHRoZSBwYXJlbnQgZGV2aWNl
LgogCSAqLwotCWVyciA9IGludGVsX2NvbnRleHRfdGltZWxpbmVfbG9jayhjZSk7Ci0JaWYgKGVy
cikKKwl0bCA9IGludGVsX2NvbnRleHRfdGltZWxpbmVfbG9jayhjZSk7CisJaWYgKElTX0VSUih0
bCkpIHsKKwkJZXJyID0gUFRSX0VSUih0bCk7CiAJCWdvdG8gZXJyX3VucGluOworCX0KIAogCWlu
dGVsX2NvbnRleHRfZW50ZXIoY2UpOwotCWludGVsX2NvbnRleHRfdGltZWxpbmVfdW5sb2NrKGNl
KTsKKwlycSA9IGViX3Rocm90dGxlKGNlKTsKKworCWludGVsX2NvbnRleHRfdGltZWxpbmVfdW5s
b2NrKHRsKTsKKworCWlmIChycSkgeworCQlpZiAoaTkxNV9yZXF1ZXN0X3dhaXQocnEsCisJCQkJ
ICAgICAgSTkxNV9XQUlUX0lOVEVSUlVQVElCTEUsCisJCQkJICAgICAgTUFYX1NDSEVEVUxFX1RJ
TUVPVVQpIDwgMCkgeworCQkJaTkxNV9yZXF1ZXN0X3B1dChycSk7CisJCQllcnIgPSAtRUlOVFI7
CisJCQlnb3RvIGVycl9leGl0OworCQl9CisKKwkJaTkxNV9yZXF1ZXN0X3B1dChycSk7CisJfQog
CiAJZWItPmVuZ2luZSA9IGNlLT5lbmdpbmU7CiAJZWItPmNvbnRleHQgPSBjZTsKIAlyZXR1cm4g
MDsKIAorZXJyX2V4aXQ6CisJbXV0ZXhfbG9jaygmdGwtPm11dGV4KTsKKwlpbnRlbF9jb250ZXh0
X2V4aXQoY2UpOworCWludGVsX2NvbnRleHRfdGltZWxpbmVfdW5sb2NrKHRsKTsKIGVycl91bnBp
bjoKLQlpbnRlbF9jb250ZXh0X3VucGluKGNlKTsKKwlfX2ViX3VucGluX2NvbnRleHQoZWIsIGNl
KTsKIAlyZXR1cm4gZXJyOwogfQogCi1zdGF0aWMgdm9pZCBlYl91bnBpbl9jb250ZXh0KHN0cnVj
dCBpOTE1X2V4ZWNidWZmZXIgKmViKQorc3RhdGljIHZvaWQgZWJfdW5waW5fZW5naW5lKHN0cnVj
dCBpOTE1X2V4ZWNidWZmZXIgKmViKQogewogCXN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSA9IGVi
LT5jb250ZXh0OwogCXN0cnVjdCBpbnRlbF90aW1lbGluZSAqdGwgPSBjZS0+dGltZWxpbmU7CkBA
IC0yMTg2LDcgKzIyMTQsNyBAQCBzdGF0aWMgdm9pZCBlYl91bnBpbl9jb250ZXh0KHN0cnVjdCBp
OTE1X2V4ZWNidWZmZXIgKmViKQogCWludGVsX2NvbnRleHRfZXhpdChjZSk7CiAJbXV0ZXhfdW5s
b2NrKCZ0bC0+bXV0ZXgpOwogCi0JaW50ZWxfY29udGV4dF91bnBpbihjZSk7CisJX19lYl91bnBp
bl9jb250ZXh0KGViLCBjZSk7CiB9CiAKIHN0YXRpYyB1bnNpZ25lZCBpbnQKQEAgLTIyMzEsOSAr
MjI1OSw5IEBAIGViX3NlbGVjdF9sZWdhY3lfcmluZyhzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICpl
YiwKIH0KIAogc3RhdGljIGludAotZWJfc2VsZWN0X2VuZ2luZShzdHJ1Y3QgaTkxNV9leGVjYnVm
ZmVyICplYiwKLQkJIHN0cnVjdCBkcm1fZmlsZSAqZmlsZSwKLQkJIHN0cnVjdCBkcm1faTkxNV9n
ZW1fZXhlY2J1ZmZlcjIgKmFyZ3MpCitlYl9waW5fZW5naW5lKHN0cnVjdCBpOTE1X2V4ZWNidWZm
ZXIgKmViLAorCSAgICAgIHN0cnVjdCBkcm1fZmlsZSAqZmlsZSwKKwkgICAgICBzdHJ1Y3QgZHJt
X2k5MTVfZ2VtX2V4ZWNidWZmZXIyICphcmdzKQogewogCXN0cnVjdCBpbnRlbF9jb250ZXh0ICpj
ZTsKIAl1bnNpZ25lZCBpbnQgaWR4OwpAQCAtMjI0OCw3ICsyMjc2LDcgQEAgZWJfc2VsZWN0X2Vu
Z2luZShzdHJ1Y3QgaTkxNV9leGVjYnVmZmVyICplYiwKIAlpZiAoSVNfRVJSKGNlKSkKIAkJcmV0
dXJuIFBUUl9FUlIoY2UpOwogCi0JZXJyID0gZWJfcGluX2NvbnRleHQoZWIsIGNlKTsKKwllcnIg
PSBfX2ViX3Bpbl9lbmdpbmUoZWIsIGNlKTsKIAlpbnRlbF9jb250ZXh0X3B1dChjZSk7CiAKIAly
ZXR1cm4gZXJyOwpAQCAtMjQ2NiwxNiArMjQ5NCwxMiBAQCBpOTE1X2dlbV9kb19leGVjYnVmZmVy
KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsCiAJaWYgKHVubGlrZWx5KGVycikpCiAJCWdvdG8gZXJy
X2Rlc3Ryb3k7CiAKLQllcnIgPSBpOTE1X211dGV4X2xvY2tfaW50ZXJydXB0aWJsZShkZXYpOwot
CWlmIChlcnIpCi0JCWdvdG8gZXJyX2NvbnRleHQ7Ci0KLQllcnIgPSBlYl9zZWxlY3RfZW5naW5l
KCZlYiwgZmlsZSwgYXJncyk7CisJZXJyID0gZWJfcGluX2VuZ2luZSgmZWIsIGZpbGUsIGFyZ3Mp
OwogCWlmICh1bmxpa2VseShlcnIpKQotCQlnb3RvIGVycl91bmxvY2s7CisJCWdvdG8gZXJyX2Nv
bnRleHQ7CiAKLQllcnIgPSBlYl93YWl0X2Zvcl9yaW5nKCZlYik7IC8qIG1heSB0ZW1wb3Jhcmls
eSBkcm9wIHN0cnVjdF9tdXRleCAqLwotCWlmICh1bmxpa2VseShlcnIpKQorCWVyciA9IGk5MTVf
bXV0ZXhfbG9ja19pbnRlcnJ1cHRpYmxlKGRldik7CisJaWYgKGVycikKIAkJZ290byBlcnJfZW5n
aW5lOwogCiAJZXJyID0gZWJfcmVsb2NhdGUoJmViKTsKQEAgLTI2MzMsMTAgKzI2NTcsOSBAQCBp
OTE1X2dlbV9kb19leGVjYnVmZmVyKHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsCiBlcnJfdm1hOgog
CWlmIChlYi5leGVjKQogCQllYl9yZWxlYXNlX3ZtYXMoJmViKTsKLWVycl9lbmdpbmU6Ci0JZWJf
dW5waW5fY29udGV4dCgmZWIpOwotZXJyX3VubG9jazoKIAltdXRleF91bmxvY2soJmRldi0+c3Ry
dWN0X211dGV4KTsKK2Vycl9lbmdpbmU6CisJZWJfdW5waW5fZW5naW5lKCZlYik7CiBlcnJfY29u
dGV4dDoKIAlpOTE1X2dlbV9jb250ZXh0X3B1dChlYi5nZW1fY29udGV4dCk7CiBlcnJfZGVzdHJv
eToKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2NvbnRleHQuaCBi
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2NvbnRleHQuaAppbmRleCA5ZmE4YjU4OGYx
OGUuLjA1M2ExMzA3ZWNiNCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50
ZWxfY29udGV4dC5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2NvbnRleHQu
aApAQCAtMTIsNiArMTIsNyBAQAogI2luY2x1ZGUgImk5MTVfYWN0aXZlLmgiCiAjaW5jbHVkZSAi
aW50ZWxfY29udGV4dF90eXBlcy5oIgogI2luY2x1ZGUgImludGVsX2VuZ2luZV90eXBlcy5oIgor
I2luY2x1ZGUgImludGVsX3RpbWVsaW5lX3R5cGVzLmgiCiAKIHZvaWQgaW50ZWxfY29udGV4dF9p
bml0KHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSwKIAkJCXN0cnVjdCBpOTE1X2dlbV9jb250ZXh0
ICpjdHgsCkBAIC0xMTgsMTcgKzExOSwyNCBAQCBzdGF0aWMgaW5saW5lIHZvaWQgaW50ZWxfY29u
dGV4dF9wdXQoc3RydWN0IGludGVsX2NvbnRleHQgKmNlKQogCWtyZWZfcHV0KCZjZS0+cmVmLCBj
ZS0+b3BzLT5kZXN0cm95KTsKIH0KIAotc3RhdGljIGlubGluZSBpbnQgX19tdXN0X2NoZWNrCitz
dGF0aWMgaW5saW5lIHN0cnVjdCBpbnRlbF90aW1lbGluZSAqX19tdXN0X2NoZWNrCiBpbnRlbF9j
b250ZXh0X3RpbWVsaW5lX2xvY2soc3RydWN0IGludGVsX2NvbnRleHQgKmNlKQogCV9fYWNxdWly
ZXMoJmNlLT50aW1lbGluZS0+bXV0ZXgpCiB7Ci0JcmV0dXJuIG11dGV4X2xvY2tfaW50ZXJydXB0
aWJsZSgmY2UtPnRpbWVsaW5lLT5tdXRleCk7CisJc3RydWN0IGludGVsX3RpbWVsaW5lICp0bCA9
IGNlLT50aW1lbGluZTsKKwlpbnQgZXJyOworCisJZXJyID0gbXV0ZXhfbG9ja19pbnRlcnJ1cHRp
YmxlKCZ0bC0+bXV0ZXgpOworCWlmIChlcnIpCisJCXJldHVybiBFUlJfUFRSKGVycik7CisKKwly
ZXR1cm4gdGw7CiB9CiAKLXN0YXRpYyBpbmxpbmUgdm9pZCBpbnRlbF9jb250ZXh0X3RpbWVsaW5l
X3VubG9jayhzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UpCi0JX19yZWxlYXNlcygmY2UtPnRpbWVs
aW5lLT5tdXRleCkKK3N0YXRpYyBpbmxpbmUgdm9pZCBpbnRlbF9jb250ZXh0X3RpbWVsaW5lX3Vu
bG9jayhzdHJ1Y3QgaW50ZWxfdGltZWxpbmUgKnRsKQorCV9fcmVsZWFzZXMoJnRsLT5tdXRleCkK
IHsKLQltdXRleF91bmxvY2soJmNlLT50aW1lbGluZS0+bXV0ZXgpOworCW11dGV4X3VubG9jaygm
dGwtPm11dGV4KTsKIH0KIAogaW50IGludGVsX2NvbnRleHRfcHJlcGFyZV9yZW1vdGVfcmVxdWVz
dChzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UsCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9ndC9pbnRlbF9lbmdpbmVfY3MuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVs
X2VuZ2luZV9jcy5jCmluZGV4IDEzYTU2OTkwN2MzZC4uOGE5ZDNjZDJjMzFjIDEwMDY0NAotLS0g
YS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfY3MuYworKysgYi9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9lbmdpbmVfY3MuYwpAQCAtNjc5LDcgKzY3OSw2IEBAIHN0
YXRpYyBpbnQgbWVhc3VyZV9icmVhZGNydW1iX2R3KHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVu
Z2luZSkKIAkJCQllbmdpbmUtPnN0YXR1c19wYWdlLnZtYSkpCiAJCWdvdG8gb3V0X2ZyYW1lOwog
Ci0JSU5JVF9MSVNUX0hFQUQoJmZyYW1lLT5yaW5nLnJlcXVlc3RfbGlzdCk7CiAJZnJhbWUtPnJp
bmcudmFkZHIgPSBmcmFtZS0+Y3M7CiAJZnJhbWUtPnJpbmcuc2l6ZSA9IHNpemVvZihmcmFtZS0+
Y3MpOwogCWZyYW1lLT5yaW5nLmVmZmVjdGl2ZV9zaXplID0gZnJhbWUtPnJpbmcuc2l6ZTsKZGlm
ZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZV90eXBlcy5oIGIv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZW5naW5lX3R5cGVzLmgKaW5kZXggYTBmMzcy
ODA3ZGQ0Li45OTY1YTMyNjAxZDYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0
L2ludGVsX2VuZ2luZV90eXBlcy5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVs
X2VuZ2luZV90eXBlcy5oCkBAIC02OSw5ICs2OSw2IEBAIHN0cnVjdCBpbnRlbF9yaW5nIHsKIAlz
dHJ1Y3QgaTkxNV92bWEgKnZtYTsKIAl2b2lkICp2YWRkcjsKIAotCXN0cnVjdCBsaXN0X2hlYWQg
cmVxdWVzdF9saXN0OwotCXN0cnVjdCBsaXN0X2hlYWQgYWN0aXZlX2xpbms7Ci0KIAkvKgogCSAq
IEFzIHdlIGhhdmUgdHdvIHR5cGVzIG9mIHJpbmdzLCBvbmUgZ2xvYmFsIHRvIHRoZSBlbmdpbmUg
dXNlZAogCSAqIGJ5IHJpbmdidWZmZXIgc3VibWlzc2lvbiBhbmQgdGhvc2UgdGhhdCBhcmUgZXhj
bHVzaXZlIHRvIGEKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2d0
LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9ndC5jCmluZGV4IGM1NDM0NjdhOGEx
Yy4uYjUyNzc2MzIxMzdjIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRl
bF9ndC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2d0LmMKQEAgLTEzLDkg
KzEzLDcgQEAgdm9pZCBpbnRlbF9ndF9pbml0X2Vhcmx5KHN0cnVjdCBpbnRlbF9ndCAqZ3QsIHN0
cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQogCWd0LT5pOTE1ID0gaTkxNTsKIAlndC0+dW5j
b3JlID0gJmk5MTUtPnVuY29yZTsKIAotCUlOSVRfTElTVF9IRUFEKCZndC0+YWN0aXZlX3Jpbmdz
KTsKIAlJTklUX0xJU1RfSEVBRCgmZ3QtPmNsb3NlZF92bWEpOwotCiAJc3Bpbl9sb2NrX2luaXQo
Jmd0LT5jbG9zZWRfbG9jayk7CiAKIAlpbnRlbF9ndF9pbml0X2hhbmdjaGVjayhndCk7CmRpZmYg
LS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9ndF90eXBlcy5oIGIvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZ3RfdHlwZXMuaAppbmRleCAzYjM0YjY1OGRlM2YuLjhk
YTdiOWYxZjQ2ZSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZ3Rf
dHlwZXMuaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9ndF90eXBlcy5oCkBA
IC00OCw4ICs0OCw2IEBAIHN0cnVjdCBpbnRlbF9ndCB7CiAJCXN0cnVjdCBsaXN0X2hlYWQgaHdz
cF9mcmVlX2xpc3Q7CiAJfSB0aW1lbGluZXM7CiAKLQlzdHJ1Y3QgbGlzdF9oZWFkIGFjdGl2ZV9y
aW5nczsKLQogCXN0cnVjdCBpbnRlbF93YWtlcmVmIHdha2VyZWY7CiAKIAlzdHJ1Y3QgbGlzdF9o
ZWFkIGNsb3NlZF92bWE7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRl
bF9scmMuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2xyYy5jCmluZGV4IGI1NjE4
ZTZjMTM2MS4uNzFjNjkzODFhMWFhIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9n
dC9pbnRlbF9scmMuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9scmMuYwpA
QCAtMTYxOSw2ICsxNjE5LDcgQEAgc3RhdGljIHZvaWQgZXhlY2xpc3RzX2NvbnRleHRfdW5waW4o
c3RydWN0IGludGVsX2NvbnRleHQgKmNlKQogewogCWk5MTVfZ2VtX2NvbnRleHRfdW5waW5faHdf
aWQoY2UtPmdlbV9jb250ZXh0KTsKIAlpOTE1X2dlbV9vYmplY3RfdW5waW5fbWFwKGNlLT5zdGF0
ZS0+b2JqKTsKKwlpbnRlbF9yaW5nX3Jlc2V0KGNlLT5yaW5nLCBjZS0+cmluZy0+dGFpbCk7CiB9
CiAKIHN0YXRpYyB2b2lkCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRl
bF9yaW5nYnVmZmVyLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9yaW5nYnVmZmVy
LmMKaW5kZXggYmUxNzBiMTBkOTJmLi44Y2U1YTU1NDI3YzEgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2d0L2ludGVsX3JpbmdidWZmZXIuYworKysgYi9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9ndC9pbnRlbF9yaW5nYnVmZmVyLmMKQEAgLTEyNDgsNyArMTI0OCw3IEBAIHZvaWQgaW50
ZWxfcmluZ191bnBpbihzdHJ1Y3QgaW50ZWxfcmluZyAqcmluZykKIAkJcmV0dXJuOwogCiAJLyog
RGlzY2FyZCBhbnkgdW51c2VkIGJ5dGVzIGJleW9uZCB0aGF0IHN1Ym1pdHRlZCB0byBody4gKi8K
LQlpbnRlbF9yaW5nX3Jlc2V0KHJpbmcsIHJpbmctPnRhaWwpOworCWludGVsX3JpbmdfcmVzZXQo
cmluZywgcmluZy0+ZW1pdCk7CiAKIAlpOTE1X3ZtYV91bnNldF9nZ3R0X3dyaXRlKHZtYSk7CiAJ
aWYgKGk5MTVfdm1hX2lzX21hcF9hbmRfZmVuY2VhYmxlKHZtYSkpCkBAIC0xMzA5LDcgKzEzMDks
NiBAQCBpbnRlbF9lbmdpbmVfY3JlYXRlX3Jpbmcoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5n
aW5lLCBpbnQgc2l6ZSkKIAkJcmV0dXJuIEVSUl9QVFIoLUVOT01FTSk7CiAKIAlrcmVmX2luaXQo
JnJpbmctPnJlZik7Ci0JSU5JVF9MSVNUX0hFQUQoJnJpbmctPnJlcXVlc3RfbGlzdCk7CiAKIAly
aW5nLT5zaXplID0gc2l6ZTsKIAkvKiBXb3JrYXJvdW5kIGFuIGVycmF0dW0gb24gdGhlIGk4MzAg
d2hpY2ggY2F1c2VzIGEgaGFuZyBpZgpAQCAtMTg2Myw3ICsxODYyLDEwIEBAIHN0YXRpYyBpbnQg
cmluZ19yZXF1ZXN0X2FsbG9jKHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJlcXVlc3QpCiAJcmV0dXJu
IDA7CiB9CiAKLXN0YXRpYyBub2lubGluZSBpbnQgd2FpdF9mb3Jfc3BhY2Uoc3RydWN0IGludGVs
X3JpbmcgKnJpbmcsIHVuc2lnbmVkIGludCBieXRlcykKK3N0YXRpYyBub2lubGluZSBpbnQKK3dh
aXRfZm9yX3NwYWNlKHN0cnVjdCBpbnRlbF9yaW5nICpyaW5nLAorCSAgICAgICBzdHJ1Y3QgaW50
ZWxfdGltZWxpbmUgKnRsLAorCSAgICAgICB1bnNpZ25lZCBpbnQgYnl0ZXMpCiB7CiAJc3RydWN0
IGk5MTVfcmVxdWVzdCAqdGFyZ2V0OwogCWxvbmcgdGltZW91dDsKQEAgLTE4NzEsMTUgKzE4NzMs
MTggQEAgc3RhdGljIG5vaW5saW5lIGludCB3YWl0X2Zvcl9zcGFjZShzdHJ1Y3QgaW50ZWxfcmlu
ZyAqcmluZywgdW5zaWduZWQgaW50IGJ5dGVzKQogCWlmIChpbnRlbF9yaW5nX3VwZGF0ZV9zcGFj
ZShyaW5nKSA+PSBieXRlcykKIAkJcmV0dXJuIDA7CiAKLQlHRU1fQlVHX09OKGxpc3RfZW1wdHko
JnJpbmctPnJlcXVlc3RfbGlzdCkpOwotCWxpc3RfZm9yX2VhY2hfZW50cnkodGFyZ2V0LCAmcmlu
Zy0+cmVxdWVzdF9saXN0LCByaW5nX2xpbmspIHsKKwlHRU1fQlVHX09OKGxpc3RfZW1wdHkoJnRs
LT5yZXF1ZXN0cykpOworCWxpc3RfZm9yX2VhY2hfZW50cnkodGFyZ2V0LCAmdGwtPnJlcXVlc3Rz
LCBsaW5rKSB7CisJCWlmICh0YXJnZXQtPnJpbmcgIT0gcmluZykKKwkJCWNvbnRpbnVlOworCiAJ
CS8qIFdvdWxkIGNvbXBsZXRpb24gb2YgdGhpcyByZXF1ZXN0IGZyZWUgZW5vdWdoIHNwYWNlPyAq
LwogCQlpZiAoYnl0ZXMgPD0gX19pbnRlbF9yaW5nX3NwYWNlKHRhcmdldC0+cG9zdGZpeCwKIAkJ
CQkJCXJpbmctPmVtaXQsIHJpbmctPnNpemUpKQogCQkJYnJlYWs7CiAJfQogCi0JaWYgKFdBUk5f
T04oJnRhcmdldC0+cmluZ19saW5rID09ICZyaW5nLT5yZXF1ZXN0X2xpc3QpKQorCWlmIChHRU1f
V0FSTl9PTigmdGFyZ2V0LT5saW5rID09ICZ0bC0+cmVxdWVzdHMpKQogCQlyZXR1cm4gLUVOT1NQ
QzsKIAogCXRpbWVvdXQgPSBpOTE1X3JlcXVlc3Rfd2FpdCh0YXJnZXQsCkBAIC0xOTQ2LDcgKzE5
NTEsNyBAQCB1MzIgKmludGVsX3JpbmdfYmVnaW4oc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEsIHVu
c2lnbmVkIGludCBudW1fZHdvcmRzKQogCQkgKi8KIAkJR0VNX0JVR19PTighcnEtPnJlc2VydmVk
X3NwYWNlKTsKIAotCQlyZXQgPSB3YWl0X2Zvcl9zcGFjZShyaW5nLCB0b3RhbF9ieXRlcyk7CisJ
CXJldCA9IHdhaXRfZm9yX3NwYWNlKHJpbmcsIHJxLT50aW1lbGluZSwgdG90YWxfYnl0ZXMpOwog
CQlpZiAodW5saWtlbHkocmV0KSkKIAkJCXJldHVybiBFUlJfUFRSKHJldCk7CiAJfQpkaWZmIC0t
Z2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvbW9ja19lbmdpbmUuYyBiL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L2d0L21vY2tfZW5naW5lLmMKaW5kZXggNTRhMTFkZGUzMDc2Li41ZDQzY2JjM2Yz
NDUgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L21vY2tfZW5naW5lLmMKKysr
IGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvbW9ja19lbmdpbmUuYwpAQCAtNTgsNyArNTgsNiBA
QCBzdGF0aWMgc3RydWN0IGludGVsX3JpbmcgKm1vY2tfcmluZyhzdHJ1Y3QgaW50ZWxfZW5naW5l
X2NzICplbmdpbmUpCiAJcmluZy0+dmFkZHIgPSAodm9pZCAqKShyaW5nICsgMSk7CiAJYXRvbWlj
X3NldCgmcmluZy0+cGluX2NvdW50LCAxKTsKIAotCUlOSVRfTElTVF9IRUFEKCZyaW5nLT5yZXF1
ZXN0X2xpc3QpOwogCWludGVsX3JpbmdfdXBkYXRlX3NwYWNlKHJpbmcpOwogCiAJcmV0dXJuIHJp
bmc7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVzdF9jb250ZXh0
LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxmdGVzdF9jb250ZXh0LmMKaW5kZXggZGE5
YzQ5ZTJhZGFmLi42ZmJjNzJiYzI5MGUgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2d0L3NlbGZ0ZXN0X2NvbnRleHQuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9zZWxm
dGVzdF9jb250ZXh0LmMKQEAgLTIwLDEwICsyMCwxMyBAQCBzdGF0aWMgaW50IHJlcXVlc3Rfc3lu
YyhzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSkKIAogCWk5MTVfcmVxdWVzdF9hZGQocnEpOwogCXRp
bWVvdXQgPSBpOTE1X3JlcXVlc3Rfd2FpdChycSwgMCwgSFogLyAxMCk7Ci0JaWYgKHRpbWVvdXQg
PCAwKQorCWlmICh0aW1lb3V0IDwgMCkgewogCQllcnIgPSB0aW1lb3V0OwotCWVsc2UKKwl9IGVs
c2UgeworCQltdXRleF9sb2NrKCZycS0+dGltZWxpbmUtPm11dGV4KTsKIAkJaTkxNV9yZXF1ZXN0
X3JldGlyZV91cHRvKHJxKTsKKwkJbXV0ZXhfdW5sb2NrKCZycS0+dGltZWxpbmUtPm11dGV4KTsK
Kwl9CiAKIAlpOTE1X3JlcXVlc3RfcHV0KHJxKTsKIApAQCAtMzUsNiArMzgsNyBAQCBzdGF0aWMg
aW50IGNvbnRleHRfc3luYyhzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UpCiAJc3RydWN0IGludGVs
X3RpbWVsaW5lICp0bCA9IGNlLT50aW1lbGluZTsKIAlpbnQgZXJyID0gMDsKIAorCW11dGV4X2xv
Y2soJnRsLT5tdXRleCk7CiAJZG8gewogCQlzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycTsKIAkJbG9u
ZyB0aW1lb3V0OwpAQCAtNTUsNiArNTksNyBAQCBzdGF0aWMgaW50IGNvbnRleHRfc3luYyhzdHJ1
Y3QgaW50ZWxfY29udGV4dCAqY2UpCiAKIAkJaTkxNV9yZXF1ZXN0X3B1dChycSk7CiAJfSB3aGls
ZSAoIWVycik7CisJbXV0ZXhfdW5sb2NrKCZ0bC0+bXV0ZXgpOwogCiAJcmV0dXJuIGVycjsKIH0K
ZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcmVxdWVzdC5jIGIvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvaTkxNV9yZXF1ZXN0LmMKaW5kZXggNDcwM2FhYjNhZTIxLi43NGI2MTFh
YjYwYTIgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcmVxdWVzdC5jCisr
KyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcmVxdWVzdC5jCkBAIC0xODEsNDAgKzE4MSw2
IEBAIGk5MTVfcmVxdWVzdF9yZW1vdmVfZnJvbV9jbGllbnQoc3RydWN0IGk5MTVfcmVxdWVzdCAq
cmVxdWVzdCkKIAlzcGluX3VubG9jaygmZmlsZV9wcml2LT5tbS5sb2NrKTsKIH0KIAotc3RhdGlj
IHZvaWQgYWR2YW5jZV9yaW5nKHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJlcXVlc3QpCi17Ci0Jc3Ry
dWN0IGludGVsX3JpbmcgKnJpbmcgPSByZXF1ZXN0LT5yaW5nOwotCXVuc2lnbmVkIGludCB0YWls
OwotCi0JLyoKLQkgKiBXZSBrbm93IHRoZSBHUFUgbXVzdCBoYXZlIHJlYWQgdGhlIHJlcXVlc3Qg
dG8gaGF2ZQotCSAqIHNlbnQgdXMgdGhlIHNlcW5vICsgaW50ZXJydXB0LCBzbyB1c2UgdGhlIHBv
c2l0aW9uCi0JICogb2YgdGFpbCBvZiB0aGUgcmVxdWVzdCB0byB1cGRhdGUgdGhlIGxhc3Qga25v
d24gcG9zaXRpb24KLQkgKiBvZiB0aGUgR1BVIGhlYWQuCi0JICoKLQkgKiBOb3RlIHRoaXMgcmVx
dWlyZXMgdGhhdCB3ZSBhcmUgYWx3YXlzIGNhbGxlZCBpbiByZXF1ZXN0Ci0JICogY29tcGxldGlv
biBvcmRlci4KLQkgKi8KLQlHRU1fQlVHX09OKCFsaXN0X2lzX2ZpcnN0KCZyZXF1ZXN0LT5yaW5n
X2xpbmssICZyaW5nLT5yZXF1ZXN0X2xpc3QpKTsKLQlpZiAobGlzdF9pc19sYXN0KCZyZXF1ZXN0
LT5yaW5nX2xpbmssICZyaW5nLT5yZXF1ZXN0X2xpc3QpKSB7Ci0JCS8qCi0JCSAqIFdlIG1heSBy
YWNlIGhlcmUgd2l0aCBleGVjbGlzdHMgcmVzdWJtaXR0aW5nIHRoaXMgcmVxdWVzdAotCQkgKiBh
cyB3ZSByZXRpcmUgaXQuIFRoZSByZXN1Ym1pc3Npb24gd2lsbCBtb3ZlIHRoZSByaW5nLT50YWls
Ci0JCSAqIGZvcndhcmRzICh0byByZXF1ZXN0LT53YV90YWlsKS4gV2UgZWl0aGVyIHJlYWQgdGhl
Ci0JCSAqIGN1cnJlbnQgdmFsdWUgdGhhdCB3YXMgd3JpdHRlbiB0byBodywgb3IgdGhlIHZhbHVl
IHRoYXQKLQkJICogaXMganVzdCBhYm91dCB0byBiZS4gRWl0aGVyIHdvcmtzLCBpZiB3ZSBtaXNz
IHRoZSBsYXN0IHR3bwotCQkgKiBub29wcyAtIHRoZXkgYXJlIHNhZmUgdG8gYmUgcmVwbGF5ZWQg
b24gYSByZXNldC4KLQkJICovCi0JCXRhaWwgPSBSRUFEX09OQ0UocmVxdWVzdC0+dGFpbCk7Ci0J
CWxpc3RfZGVsKCZyaW5nLT5hY3RpdmVfbGluayk7Ci0JfSBlbHNlIHsKLQkJdGFpbCA9IHJlcXVl
c3QtPnBvc3RmaXg7Ci0JfQotCWxpc3RfZGVsX2luaXQoJnJlcXVlc3QtPnJpbmdfbGluayk7Ci0K
LQlyaW5nLT5oZWFkID0gdGFpbDsKLX0KLQogc3RhdGljIHZvaWQgZnJlZV9jYXB0dXJlX2xpc3Qo
c3RydWN0IGk5MTVfcmVxdWVzdCAqcmVxdWVzdCkKIHsKIAlzdHJ1Y3QgaTkxNV9jYXB0dXJlX2xp
c3QgKmNhcHR1cmU7CkBAIC0yMzIsNyArMTk4LDcgQEAgc3RhdGljIGJvb2wgaTkxNV9yZXF1ZXN0
X3JldGlyZShzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSkKIHsKIAlzdHJ1Y3QgaTkxNV9hY3RpdmVf
cmVxdWVzdCAqYWN0aXZlLCAqbmV4dDsKIAotCWxvY2tkZXBfYXNzZXJ0X2hlbGQoJnJxLT5pOTE1
LT5kcm0uc3RydWN0X211dGV4KTsKKwlsb2NrZGVwX2Fzc2VydF9oZWxkKCZycS0+dGltZWxpbmUt
Pm11dGV4KTsKIAlpZiAoIWk5MTVfcmVxdWVzdF9jb21wbGV0ZWQocnEpKQogCQlyZXR1cm4gZmFs
c2U7CiAKQEAgLTI0NCw3ICsyMTAsMTcgQEAgc3RhdGljIGJvb2wgaTkxNV9yZXF1ZXN0X3JldGly
ZShzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSkKIAlHRU1fQlVHX09OKCFpOTE1X3N3X2ZlbmNlX3Np
Z25hbGVkKCZycS0+c3VibWl0KSk7CiAJdHJhY2VfaTkxNV9yZXF1ZXN0X3JldGlyZShycSk7CiAK
LQlhZHZhbmNlX3JpbmcocnEpOworCS8qCisJICogV2Uga25vdyB0aGUgR1BVIG11c3QgaGF2ZSBy
ZWFkIHRoZSByZXF1ZXN0IHRvIGhhdmUKKwkgKiBzZW50IHVzIHRoZSBzZXFubyArIGludGVycnVw
dCwgc28gdXNlIHRoZSBwb3NpdGlvbgorCSAqIG9mIHRhaWwgb2YgdGhlIHJlcXVlc3QgdG8gdXBk
YXRlIHRoZSBsYXN0IGtub3duIHBvc2l0aW9uCisJICogb2YgdGhlIEdQVSBoZWFkLgorCSAqCisJ
ICogTm90ZSB0aGlzIHJlcXVpcmVzIHRoYXQgd2UgYXJlIGFsd2F5cyBjYWxsZWQgaW4gcmVxdWVz
dAorCSAqIGNvbXBsZXRpb24gb3JkZXIuCisJICovCisJR0VNX0JVR19PTighbGlzdF9pc19maXJz
dCgmcnEtPmxpbmssICZycS0+dGltZWxpbmUtPnJlcXVlc3RzKSk7CisJcnEtPnJpbmctPmhlYWQg
PSBycS0+cG9zdGZpeDsKIAogCS8qCiAJICogV2FsayB0aHJvdWdoIHRoZSBhY3RpdmUgbGlzdCwg
Y2FsbGluZyByZXRpcmUgb24gZWFjaC4gVGhpcyBhbGxvd3MKQEAgLTMyMSw3ICsyOTcsNyBAQCBz
dGF0aWMgYm9vbCBpOTE1X3JlcXVlc3RfcmV0aXJlKHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxKQog
CiB2b2lkIGk5MTVfcmVxdWVzdF9yZXRpcmVfdXB0byhzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSkK
IHsKLQlzdHJ1Y3QgaW50ZWxfcmluZyAqcmluZyA9IHJxLT5yaW5nOworCXN0cnVjdCBpbnRlbF90
aW1lbGluZSAqIGNvbnN0IHRsID0gcnEtPnRpbWVsaW5lOwogCXN0cnVjdCBpOTE1X3JlcXVlc3Qg
KnRtcDsKIAogCUdFTV9UUkFDRSgiJXMgZmVuY2UgJWxseDolbGxkLCBjdXJyZW50ICVkXG4iLApA
QCAtMzI5LDE1ICszMDUsMTEgQEAgdm9pZCBpOTE1X3JlcXVlc3RfcmV0aXJlX3VwdG8oc3RydWN0
IGk5MTVfcmVxdWVzdCAqcnEpCiAJCSAgcnEtPmZlbmNlLmNvbnRleHQsIHJxLT5mZW5jZS5zZXFu
bywKIAkJICBod3NwX3NlcW5vKHJxKSk7CiAKLQlsb2NrZGVwX2Fzc2VydF9oZWxkKCZycS0+aTkx
NS0+ZHJtLnN0cnVjdF9tdXRleCk7CisJbG9ja2RlcF9hc3NlcnRfaGVsZCgmdGwtPm11dGV4KTsK
IAlHRU1fQlVHX09OKCFpOTE1X3JlcXVlc3RfY29tcGxldGVkKHJxKSk7CiAKLQlpZiAobGlzdF9l
bXB0eSgmcnEtPnJpbmdfbGluaykpCi0JCXJldHVybjsKLQogCWRvIHsKLQkJdG1wID0gbGlzdF9m
aXJzdF9lbnRyeSgmcmluZy0+cmVxdWVzdF9saXN0LAotCQkJCSAgICAgICB0eXBlb2YoKnRtcCks
IHJpbmdfbGluayk7CisJCXRtcCA9IGxpc3RfZmlyc3RfZW50cnkoJnRsLT5yZXF1ZXN0cywgdHlw
ZW9mKCp0bXApLCBsaW5rKTsKIAl9IHdoaWxlIChpOTE1X3JlcXVlc3RfcmV0aXJlKHRtcCkgJiYg
dG1wICE9IHJxKTsKIH0KIApAQCAtNTY0LDI5ICs1MzYsMjggQEAgc2VtYXBob3JlX25vdGlmeShz
dHJ1Y3QgaTkxNV9zd19mZW5jZSAqZmVuY2UsIGVudW0gaTkxNV9zd19mZW5jZV9ub3RpZnkgc3Rh
dGUpCiAJcmV0dXJuIE5PVElGWV9ET05FOwogfQogCi1zdGF0aWMgdm9pZCByaW5nX3JldGlyZV9y
ZXF1ZXN0cyhzdHJ1Y3QgaW50ZWxfcmluZyAqcmluZykKK3N0YXRpYyB2b2lkIHJldGlyZV9yZXF1
ZXN0cyhzdHJ1Y3QgaW50ZWxfdGltZWxpbmUgKnRsKQogewogCXN0cnVjdCBpOTE1X3JlcXVlc3Qg
KnJxLCAqcm47CiAKLQlsaXN0X2Zvcl9lYWNoX2VudHJ5X3NhZmUocnEsIHJuLCAmcmluZy0+cmVx
dWVzdF9saXN0LCByaW5nX2xpbmspCisJbGlzdF9mb3JfZWFjaF9lbnRyeV9zYWZlKHJxLCBybiwg
JnRsLT5yZXF1ZXN0cywgbGluaykKIAkJaWYgKCFpOTE1X3JlcXVlc3RfcmV0aXJlKHJxKSkKIAkJ
CWJyZWFrOwogfQogCiBzdGF0aWMgbm9pbmxpbmUgc3RydWN0IGk5MTVfcmVxdWVzdCAqCi1yZXF1
ZXN0X2FsbG9jX3Nsb3coc3RydWN0IGludGVsX2NvbnRleHQgKmNlLCBnZnBfdCBnZnApCityZXF1
ZXN0X2FsbG9jX3Nsb3coc3RydWN0IGludGVsX3RpbWVsaW5lICp0bCwgZ2ZwX3QgZ2ZwKQogewot
CXN0cnVjdCBpbnRlbF9yaW5nICpyaW5nID0gY2UtPnJpbmc7CiAJc3RydWN0IGk5MTVfcmVxdWVz
dCAqcnE7CiAKLQlpZiAobGlzdF9lbXB0eSgmcmluZy0+cmVxdWVzdF9saXN0KSkKKwlpZiAobGlz
dF9lbXB0eSgmdGwtPnJlcXVlc3RzKSkKIAkJZ290byBvdXQ7CiAKIAlpZiAoIWdmcGZsYWdzX2Fs
bG93X2Jsb2NraW5nKGdmcCkpCiAJCWdvdG8gb3V0OwogCiAJLyogTW92ZSBvdXIgb2xkZXN0IHJl
cXVlc3QgdG8gdGhlIHNsYWItY2FjaGUgKGlmIG5vdCBpbiB1c2UhKSAqLwotCXJxID0gbGlzdF9m
aXJzdF9lbnRyeSgmcmluZy0+cmVxdWVzdF9saXN0LCB0eXBlb2YoKnJxKSwgcmluZ19saW5rKTsK
KwlycSA9IGxpc3RfZmlyc3RfZW50cnkoJnRsLT5yZXF1ZXN0cywgdHlwZW9mKCpycSksIGxpbmsp
OwogCWk5MTVfcmVxdWVzdF9yZXRpcmUocnEpOwogCiAJcnEgPSBrbWVtX2NhY2hlX2FsbG9jKGds
b2JhbC5zbGFiX3JlcXVlc3RzLApAQCAtNTk1LDExICs1NjYsMTEgQEAgcmVxdWVzdF9hbGxvY19z
bG93KHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSwgZ2ZwX3QgZ2ZwKQogCQlyZXR1cm4gcnE7CiAK
IAkvKiBSYXRlbGltaXQgb3Vyc2VsdmVzIHRvIHByZXZlbnQgb29tIGZyb20gbWFsaWNpb3VzIGNs
aWVudHMgKi8KLQlycSA9IGxpc3RfbGFzdF9lbnRyeSgmcmluZy0+cmVxdWVzdF9saXN0LCB0eXBl
b2YoKnJxKSwgcmluZ19saW5rKTsKKwlycSA9IGxpc3RfbGFzdF9lbnRyeSgmdGwtPnJlcXVlc3Rz
LCB0eXBlb2YoKnJxKSwgbGluayk7CiAJY29uZF9zeW5jaHJvbml6ZV9yY3UocnEtPnJjdXN0YXRl
KTsKIAogCS8qIFJldGlyZSBvdXIgb2xkIHJlcXVlc3RzIGluIHRoZSBob3BlIHRoYXQgd2UgZnJl
ZSBzb21lICovCi0JcmluZ19yZXRpcmVfcmVxdWVzdHMocmluZyk7CisJcmV0aXJlX3JlcXVlc3Rz
KHRsKTsKIAogb3V0OgogCXJldHVybiBrbWVtX2NhY2hlX2FsbG9jKGdsb2JhbC5zbGFiX3JlcXVl
c3RzLCBnZnApOwpAQCAtNjUwLDcgKzYyMSw3IEBAIF9faTkxNV9yZXF1ZXN0X2NyZWF0ZShzdHJ1
Y3QgaW50ZWxfY29udGV4dCAqY2UsIGdmcF90IGdmcCkKIAlycSA9IGttZW1fY2FjaGVfYWxsb2Mo
Z2xvYmFsLnNsYWJfcmVxdWVzdHMsCiAJCQkgICAgICBnZnAgfCBfX0dGUF9SRVRSWV9NQVlGQUlM
IHwgX19HRlBfTk9XQVJOKTsKIAlpZiAodW5saWtlbHkoIXJxKSkgewotCQlycSA9IHJlcXVlc3Rf
YWxsb2Nfc2xvdyhjZSwgZ2ZwKTsKKwkJcnEgPSByZXF1ZXN0X2FsbG9jX3Nsb3codGwsIGdmcCk7
CiAJCWlmICghcnEpIHsKIAkJCXJldCA9IC1FTk9NRU07CiAJCQlnb3RvIGVycl91bnJlc2VydmU7
CkBAIC03NDIsMTUgKzcxMywxNSBAQCBzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICoKIGk5MTVfcmVxdWVz
dF9jcmVhdGUoc3RydWN0IGludGVsX2NvbnRleHQgKmNlKQogewogCXN0cnVjdCBpOTE1X3JlcXVl
c3QgKnJxOwotCWludCBlcnI7CisJc3RydWN0IGludGVsX3RpbWVsaW5lICp0bDsKIAotCWVyciA9
IGludGVsX2NvbnRleHRfdGltZWxpbmVfbG9jayhjZSk7Ci0JaWYgKGVycikKLQkJcmV0dXJuIEVS
Ul9QVFIoZXJyKTsKKwl0bCA9IGludGVsX2NvbnRleHRfdGltZWxpbmVfbG9jayhjZSk7CisJaWYg
KElTX0VSUih0bCkpCisJCXJldHVybiBFUlJfQ0FTVCh0bCk7CiAKIAkvKiBNb3ZlIG91ciBvbGRl
c3QgcmVxdWVzdCB0byB0aGUgc2xhYi1jYWNoZSAoaWYgbm90IGluIHVzZSEpICovCi0JcnEgPSBs
aXN0X2ZpcnN0X2VudHJ5KCZjZS0+cmluZy0+cmVxdWVzdF9saXN0LCB0eXBlb2YoKnJxKSwgcmlu
Z19saW5rKTsKLQlpZiAoIWxpc3RfaXNfbGFzdCgmcnEtPnJpbmdfbGluaywgJmNlLT5yaW5nLT5y
ZXF1ZXN0X2xpc3QpKQorCXJxID0gbGlzdF9maXJzdF9lbnRyeSgmdGwtPnJlcXVlc3RzLCB0eXBl
b2YoKnJxKSwgbGluayk7CisJaWYgKCFsaXN0X2lzX2xhc3QoJnJxLT5saW5rLCAmdGwtPnJlcXVl
c3RzKSkKIAkJaTkxNV9yZXF1ZXN0X3JldGlyZShycSk7CiAKIAlpbnRlbF9jb250ZXh0X2VudGVy
KGNlKTsKQEAgLTc2MCwyMiArNzMxLDIyIEBAIGk5MTVfcmVxdWVzdF9jcmVhdGUoc3RydWN0IGlu
dGVsX2NvbnRleHQgKmNlKQogCQlnb3RvIGVycl91bmxvY2s7CiAKIAkvKiBDaGVjayB0aGF0IHdl
IGRvIG5vdCBpbnRlcnJ1cHQgb3Vyc2VsdmVzIHdpdGggYSBuZXcgcmVxdWVzdCAqLwotCXJxLT5j
b29raWUgPSBsb2NrZGVwX3Bpbl9sb2NrKCZjZS0+dGltZWxpbmUtPm11dGV4KTsKKwlycS0+Y29v
a2llID0gbG9ja2RlcF9waW5fbG9jaygmdGwtPm11dGV4KTsKIAogCXJldHVybiBycTsKIAogZXJy
X3VubG9jazoKLQlpbnRlbF9jb250ZXh0X3RpbWVsaW5lX3VubG9jayhjZSk7CisJaW50ZWxfY29u
dGV4dF90aW1lbGluZV91bmxvY2sodGwpOwogCXJldHVybiBycTsKIH0KIAogc3RhdGljIGludAog
aTkxNV9yZXF1ZXN0X2F3YWl0X3N0YXJ0KHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxLCBzdHJ1Y3Qg
aTkxNV9yZXF1ZXN0ICpzaWduYWwpCiB7Ci0JaWYgKGxpc3RfaXNfZmlyc3QoJnNpZ25hbC0+cmlu
Z19saW5rLCAmc2lnbmFsLT5yaW5nLT5yZXF1ZXN0X2xpc3QpKQorCWlmIChsaXN0X2lzX2ZpcnN0
KCZzaWduYWwtPmxpbmssICZzaWduYWwtPnRpbWVsaW5lLT5yZXF1ZXN0cykpCiAJCXJldHVybiAw
OwogCi0Jc2lnbmFsID0gbGlzdF9wcmV2X2VudHJ5KHNpZ25hbCwgcmluZ19saW5rKTsKKwlzaWdu
YWwgPSBsaXN0X3ByZXZfZW50cnkoc2lnbmFsLCBsaW5rKTsKIAlpZiAoaW50ZWxfdGltZWxpbmVf
c3luY19pc19sYXRlcihycS0+dGltZWxpbmUsICZzaWduYWwtPmZlbmNlKSkKIAkJcmV0dXJuIDA7
CiAKQEAgLTExNTUsNyArMTEyNiw2IEBAIHN0cnVjdCBpOTE1X3JlcXVlc3QgKl9faTkxNV9yZXF1
ZXN0X2NvbW1pdChzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSkKIHsKIAlzdHJ1Y3QgaW50ZWxfZW5n
aW5lX2NzICplbmdpbmUgPSBycS0+ZW5naW5lOwogCXN0cnVjdCBpbnRlbF9yaW5nICpyaW5nID0g
cnEtPnJpbmc7Ci0Jc3RydWN0IGk5MTVfcmVxdWVzdCAqcHJldjsKIAl1MzIgKmNzOwogCiAJR0VN
X1RSQUNFKCIlcyBmZW5jZSAlbGx4OiVsbGRcbiIsCkBAIC0xMTY4LDYgKzExMzgsNyBAQCBzdHJ1
Y3QgaTkxNV9yZXF1ZXN0ICpfX2k5MTVfcmVxdWVzdF9jb21taXQoc3RydWN0IGk5MTVfcmVxdWVz
dCAqcnEpCiAJICovCiAJR0VNX0JVR19PTihycS0+cmVzZXJ2ZWRfc3BhY2UgPiByaW5nLT5zcGFj
ZSk7CiAJcnEtPnJlc2VydmVkX3NwYWNlID0gMDsKKwlycS0+ZW1pdHRlZF9qaWZmaWVzID0gamlm
ZmllczsKIAogCS8qCiAJICogUmVjb3JkIHRoZSBwb3NpdGlvbiBvZiB0aGUgc3RhcnQgb2YgdGhl
IGJyZWFkY3J1bWIgc28gdGhhdApAQCAtMTE3OSwxNCArMTE1MCw3IEBAIHN0cnVjdCBpOTE1X3Jl
cXVlc3QgKl9faTkxNV9yZXF1ZXN0X2NvbW1pdChzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycSkKIAlH
RU1fQlVHX09OKElTX0VSUihjcykpOwogCXJxLT5wb3N0Zml4ID0gaW50ZWxfcmluZ19vZmZzZXQo
cnEsIGNzKTsKIAotCXByZXYgPSBfX2k5MTVfcmVxdWVzdF9hZGRfdG9fdGltZWxpbmUocnEpOwot
Ci0JbGlzdF9hZGRfdGFpbCgmcnEtPnJpbmdfbGluaywgJnJpbmctPnJlcXVlc3RfbGlzdCk7Ci0J
aWYgKGxpc3RfaXNfZmlyc3QoJnJxLT5yaW5nX2xpbmssICZyaW5nLT5yZXF1ZXN0X2xpc3QpKQot
CQlsaXN0X2FkZCgmcmluZy0+YWN0aXZlX2xpbmssICZycS0+aTkxNS0+Z3QuYWN0aXZlX3Jpbmdz
KTsKLQlycS0+ZW1pdHRlZF9qaWZmaWVzID0gamlmZmllczsKLQotCXJldHVybiBwcmV2OworCXJl
dHVybiBfX2k5MTVfcmVxdWVzdF9hZGRfdG9fdGltZWxpbmUocnEpOwogfQogCiB2b2lkIF9faTkx
NV9yZXF1ZXN0X3F1ZXVlKHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxLApAQCAtMTIxNCwxMCArMTE3
OCwxMSBAQCB2b2lkIF9faTkxNV9yZXF1ZXN0X3F1ZXVlKHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJx
LAogdm9pZCBpOTE1X3JlcXVlc3RfYWRkKHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxKQogewogCXN0
cnVjdCBpOTE1X3NjaGVkX2F0dHIgYXR0ciA9IHJxLT5nZW1fY29udGV4dC0+c2NoZWQ7CisJc3Ry
dWN0IGludGVsX3RpbWVsaW5lICogY29uc3QgdGwgPSBycS0+dGltZWxpbmU7CiAJc3RydWN0IGk5
MTVfcmVxdWVzdCAqcHJldjsKIAotCWxvY2tkZXBfYXNzZXJ0X2hlbGQoJnJxLT50aW1lbGluZS0+
bXV0ZXgpOwotCWxvY2tkZXBfdW5waW5fbG9jaygmcnEtPnRpbWVsaW5lLT5tdXRleCwgcnEtPmNv
b2tpZSk7CisJbG9ja2RlcF9hc3NlcnRfaGVsZCgmdGwtPm11dGV4KTsKKwlsb2NrZGVwX3VucGlu
X2xvY2soJnRsLT5tdXRleCwgcnEtPmNvb2tpZSk7CiAKIAl0cmFjZV9pOTE1X3JlcXVlc3RfYWRk
KHJxKTsKIApAQCAtMTI2NiwxMCArMTIzMSwxMCBAQCB2b2lkIGk5MTVfcmVxdWVzdF9hZGQoc3Ry
dWN0IGk5MTVfcmVxdWVzdCAqcnEpCiAJICogd29yayBvbiBiZWhhbGYgb2Ygb3RoZXJzIC0tIGJ1
dCBpbnN0ZWFkIHdlIHNob3VsZCBiZW5lZml0IGZyb20KIAkgKiBpbXByb3ZlZCByZXNvdXJjZSBt
YW5hZ2VtZW50LiAoV2VsbCwgdGhhdCdzIHRoZSB0aGVvcnkgYXQgbGVhc3QuKQogCSAqLwotCWlm
IChwcmV2ICYmIGk5MTVfcmVxdWVzdF9jb21wbGV0ZWQocHJldikpCisJaWYgKHByZXYgJiYgaTkx
NV9yZXF1ZXN0X2NvbXBsZXRlZChwcmV2KSAmJiBwcmV2LT50aW1lbGluZSA9PSB0bCkKIAkJaTkx
NV9yZXF1ZXN0X3JldGlyZV91cHRvKHByZXYpOwogCi0JbXV0ZXhfdW5sb2NrKCZycS0+dGltZWxp
bmUtPm11dGV4KTsKKwltdXRleF91bmxvY2soJnRsLT5tdXRleCk7CiB9CiAKIHN0YXRpYyB1bnNp
Z25lZCBsb25nIGxvY2FsX2Nsb2NrX3VzKHVuc2lnbmVkIGludCAqY3B1KQpAQCAtMTQ4OSwxOCAr
MTQ1NCw0MyBAQCBsb25nIGk5MTVfcmVxdWVzdF93YWl0KHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJx
LAogCiBib29sIGk5MTVfcmV0aXJlX3JlcXVlc3RzKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpp
OTE1KQogewotCXN0cnVjdCBpbnRlbF9yaW5nICpyaW5nLCAqdG1wOworCXN0cnVjdCBpbnRlbF9n
dF90aW1lbGluZXMgKnRpbWVsaW5lcyA9ICZpOTE1LT5ndC50aW1lbGluZXM7CisJc3RydWN0IGlu
dGVsX3RpbWVsaW5lICp0bCwgKnRuOworCUxJU1RfSEVBRChmcmVlKTsKKworCXNwaW5fbG9jaygm
dGltZWxpbmVzLT5sb2NrKTsKKwlsaXN0X2Zvcl9lYWNoX2VudHJ5X3NhZmUodGwsIHRuLCAmdGlt
ZWxpbmVzLT5hY3RpdmVfbGlzdCwgbGluaykgeworCQlpZiAoIW11dGV4X3RyeWxvY2soJnRsLT5t
dXRleCkpCisJCQljb250aW51ZTsKIAotCWxvY2tkZXBfYXNzZXJ0X2hlbGQoJmk5MTUtPmRybS5z
dHJ1Y3RfbXV0ZXgpOworCQlpbnRlbF90aW1lbGluZV9nZXQodGwpOworCQlHRU1fQlVHX09OKCF0
bC0+YWN0aXZlX2NvdW50KTsKKwkJdGwtPmFjdGl2ZV9jb3VudCsrOyAvKiBwaW4gdGhlIGxpc3Qg
ZWxlbWVudCAqLworCQlzcGluX3VubG9jaygmdGltZWxpbmVzLT5sb2NrKTsKIAotCWxpc3RfZm9y
X2VhY2hfZW50cnlfc2FmZShyaW5nLCB0bXAsCi0JCQkJICZpOTE1LT5ndC5hY3RpdmVfcmluZ3Ms
IGFjdGl2ZV9saW5rKSB7Ci0JCWludGVsX3JpbmdfZ2V0KHJpbmcpOyAvKiBsYXN0IHJxIGhvbGRz
IHJlZmVyZW5jZSEgKi8KLQkJcmluZ19yZXRpcmVfcmVxdWVzdHMocmluZyk7Ci0JCWludGVsX3Jp
bmdfcHV0KHJpbmcpOworCQlyZXRpcmVfcmVxdWVzdHModGwpOworCisJCXNwaW5fbG9jaygmdGlt
ZWxpbmVzLT5sb2NrKTsKKworCQkvKiBSZXN0YXJ0IGl0ZXJhdGlvbiBhZnRlciBkcm9wcGluZyBs
b2NrICovCisJCWxpc3Rfc2FmZV9yZXNldF9uZXh0KHRsLCB0biwgbGluayk7CisJCWlmICghLS10
bC0+YWN0aXZlX2NvdW50KQorCQkJbGlzdF9kZWwoJnRsLT5saW5rKTsKKworCQltdXRleF91bmxv
Y2soJnRsLT5tdXRleCk7CisKKwkJLyogRGVmZXIgdGhlIGZpbmFsIHJlbGVhc2UgdG8gYWZ0ZXIg
dGhlIHNwaW5sb2NrICovCisJCWlmIChyZWZjb3VudF9kZWNfYW5kX3Rlc3QoJnRsLT5rcmVmLnJl
ZmNvdW50KSkgeworCQkJR0VNX0JVR19PTih0bC0+YWN0aXZlX2NvdW50KTsKKwkJCWxpc3RfYWRk
KCZ0bC0+bGluaywgJmZyZWUpOworCQl9CiAJfQorCXNwaW5fdW5sb2NrKCZ0aW1lbGluZXMtPmxv
Y2spOworCisJbGlzdF9mb3JfZWFjaF9lbnRyeV9zYWZlKHRsLCB0biwgJmZyZWUsIGxpbmspCisJ
CV9faW50ZWxfdGltZWxpbmVfZnJlZSgmdGwtPmtyZWYpOwogCi0JcmV0dXJuICFsaXN0X2VtcHR5
KCZpOTE1LT5ndC5hY3RpdmVfcmluZ3MpOworCXJldHVybiAhbGlzdF9lbXB0eSgmdGltZWxpbmVz
LT5hY3RpdmVfbGlzdCk7CiB9CiAKICNpZiBJU19FTkFCTEVEKENPTkZJR19EUk1fSTkxNV9TRUxG
VEVTVCkKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcmVxdWVzdC5oIGIv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9yZXF1ZXN0LmgKaW5kZXggZmVjMWQ1ZjE3Yzk0Li44
YWM2ZTEyMjZhNTYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcmVxdWVz
dC5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcmVxdWVzdC5oCkBAIC0yMjMsOSAr
MjIzLDYgQEAgc3RydWN0IGk5MTVfcmVxdWVzdCB7CiAJLyoqIHRpbWVsaW5lLT5yZXF1ZXN0IGVu
dHJ5IGZvciB0aGlzIHJlcXVlc3QgKi8KIAlzdHJ1Y3QgbGlzdF9oZWFkIGxpbms7CiAKLQkvKiog
cmluZy0+cmVxdWVzdF9saXN0IGVudHJ5IGZvciB0aGlzIHJlcXVlc3QgKi8KLQlzdHJ1Y3QgbGlz
dF9oZWFkIHJpbmdfbGluazsKLQogCXN0cnVjdCBkcm1faTkxNV9maWxlX3ByaXZhdGUgKmZpbGVf
cHJpdjsKIAkvKiogZmlsZV9wcml2IGxpc3QgZW50cnkgZm9yIHRoaXMgcmVxdWVzdCAqLwogCXN0
cnVjdCBsaXN0X2hlYWQgY2xpZW50X2xpbms7Ci0tIAoyLjIzLjAucmMxCgpfX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpJbnRlbC1nZnggbWFpbGluZyBsaXN0
CkludGVsLWdmeEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3Rv
cC5vcmcvbWFpbG1hbi9saXN0aW5mby9pbnRlbC1nZng=

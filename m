Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 079A02C1EF
	for <lists+intel-gfx@lfdr.de>; Tue, 28 May 2019 11:00:24 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 02712882B5;
	Tue, 28 May 2019 09:00:22 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 801A688437
 for <intel-gfx@lists.freedesktop.org>; Tue, 28 May 2019 09:00:20 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 16702495-1500050 
 for multiple; Tue, 28 May 2019 10:00:04 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Tue, 28 May 2019 10:00:01 +0100
Message-Id: <20190528090001.17248-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH] drm/i915: Kill the undead intel_context.c zombie
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SXQgd2FzIG1vdmVkIG92ZXIgdG8gZ3QvIGJ1dCB0aGUgYmFja21lcmdlIGJyb3VnaHQgaXQgYmFj
ayBmcm9tIHRoZSBkZWFkLgoKU2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJp
cy13aWxzb24uY28udWs+CkNjOiBKYW5pIE5pa3VsYSA8amFuaS5uaWt1bGFAbGludXguaW50ZWwu
Y29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2ludGVsX2NvbnRleHQuYyB8IDI3MCAtLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KIDEgZmlsZSBjaGFuZ2VkLCAyNzAgZGVsZXRpb25zKC0p
CiBkZWxldGUgbW9kZSAxMDA2NDQgZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfY29udGV4dC5j
CgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfY29udGV4dC5jIGIvZHJp
dmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfY29udGV4dC5jCmRlbGV0ZWQgZmlsZSBtb2RlIDEwMDY0
NAppbmRleCA5MjRjYzU1NjIyM2EuLjAwMDAwMDAwMDAwMAotLS0gYS9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9pbnRlbF9jb250ZXh0LmMKKysrIC9kZXYvbnVsbApAQCAtMSwyNzAgKzAsMCBAQAotLyoK
LSAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNSVQKLSAqCi0gKiBDb3B5cmlnaHQgwqkgMjAx
OSBJbnRlbCBDb3Jwb3JhdGlvbgotICovCi0KLSNpbmNsdWRlICJpOTE1X2Rydi5oIgotI2luY2x1
ZGUgImk5MTVfZ2VtX2NvbnRleHQuaCIKLSNpbmNsdWRlICJpOTE1X2dsb2JhbHMuaCIKLSNpbmNs
dWRlICJpbnRlbF9jb250ZXh0LmgiCi0jaW5jbHVkZSAiaW50ZWxfcmluZ2J1ZmZlci5oIgotCi1z
dGF0aWMgc3RydWN0IGk5MTVfZ2xvYmFsX2NvbnRleHQgewotCXN0cnVjdCBpOTE1X2dsb2JhbCBi
YXNlOwotCXN0cnVjdCBrbWVtX2NhY2hlICpzbGFiX2NlOwotfSBnbG9iYWw7Ci0KLXN0cnVjdCBp
bnRlbF9jb250ZXh0ICppbnRlbF9jb250ZXh0X2FsbG9jKHZvaWQpCi17Ci0JcmV0dXJuIGttZW1f
Y2FjaGVfemFsbG9jKGdsb2JhbC5zbGFiX2NlLCBHRlBfS0VSTkVMKTsKLX0KLQotdm9pZCBpbnRl
bF9jb250ZXh0X2ZyZWUoc3RydWN0IGludGVsX2NvbnRleHQgKmNlKQotewotCWttZW1fY2FjaGVf
ZnJlZShnbG9iYWwuc2xhYl9jZSwgY2UpOwotfQotCi1zdHJ1Y3QgaW50ZWxfY29udGV4dCAqCi1p
bnRlbF9jb250ZXh0X2xvb2t1cChzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4LAotCQkgICAg
IHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKLXsKLQlzdHJ1Y3QgaW50ZWxfY29udGV4
dCAqY2UgPSBOVUxMOwotCXN0cnVjdCByYl9ub2RlICpwOwotCi0Jc3Bpbl9sb2NrKCZjdHgtPmh3
X2NvbnRleHRzX2xvY2spOwotCXAgPSBjdHgtPmh3X2NvbnRleHRzLnJiX25vZGU7Ci0Jd2hpbGUg
KHApIHsKLQkJc3RydWN0IGludGVsX2NvbnRleHQgKnRoaXMgPQotCQkJcmJfZW50cnkocCwgc3Ry
dWN0IGludGVsX2NvbnRleHQsIG5vZGUpOwotCi0JCWlmICh0aGlzLT5lbmdpbmUgPT0gZW5naW5l
KSB7Ci0JCQlHRU1fQlVHX09OKHRoaXMtPmdlbV9jb250ZXh0ICE9IGN0eCk7Ci0JCQljZSA9IHRo
aXM7Ci0JCQlicmVhazsKLQkJfQotCi0JCWlmICh0aGlzLT5lbmdpbmUgPCBlbmdpbmUpCi0JCQlw
ID0gcC0+cmJfcmlnaHQ7Ci0JCWVsc2UKLQkJCXAgPSBwLT5yYl9sZWZ0OwotCX0KLQlzcGluX3Vu
bG9jaygmY3R4LT5od19jb250ZXh0c19sb2NrKTsKLQotCXJldHVybiBjZTsKLX0KLQotc3RydWN0
IGludGVsX2NvbnRleHQgKgotX19pbnRlbF9jb250ZXh0X2luc2VydChzdHJ1Y3QgaTkxNV9nZW1f
Y29udGV4dCAqY3R4LAotCQkgICAgICAgc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lLAot
CQkgICAgICAgc3RydWN0IGludGVsX2NvbnRleHQgKmNlKQotewotCXN0cnVjdCByYl9ub2RlICoq
cCwgKnBhcmVudDsKLQlpbnQgZXJyID0gMDsKLQotCXNwaW5fbG9jaygmY3R4LT5od19jb250ZXh0
c19sb2NrKTsKLQotCXBhcmVudCA9IE5VTEw7Ci0JcCA9ICZjdHgtPmh3X2NvbnRleHRzLnJiX25v
ZGU7Ci0Jd2hpbGUgKCpwKSB7Ci0JCXN0cnVjdCBpbnRlbF9jb250ZXh0ICp0aGlzOwotCi0JCXBh
cmVudCA9ICpwOwotCQl0aGlzID0gcmJfZW50cnkocGFyZW50LCBzdHJ1Y3QgaW50ZWxfY29udGV4
dCwgbm9kZSk7Ci0KLQkJaWYgKHRoaXMtPmVuZ2luZSA9PSBlbmdpbmUpIHsKLQkJCWVyciA9IC1F
RVhJU1Q7Ci0JCQljZSA9IHRoaXM7Ci0JCQlicmVhazsKLQkJfQotCi0JCWlmICh0aGlzLT5lbmdp
bmUgPCBlbmdpbmUpCi0JCQlwID0gJnBhcmVudC0+cmJfcmlnaHQ7Ci0JCWVsc2UKLQkJCXAgPSAm
cGFyZW50LT5yYl9sZWZ0OwotCX0KLQlpZiAoIWVycikgewotCQlyYl9saW5rX25vZGUoJmNlLT5u
b2RlLCBwYXJlbnQsIHApOwotCQlyYl9pbnNlcnRfY29sb3IoJmNlLT5ub2RlLCAmY3R4LT5od19j
b250ZXh0cyk7Ci0JfQotCi0Jc3Bpbl91bmxvY2soJmN0eC0+aHdfY29udGV4dHNfbG9jayk7Ci0K
LQlyZXR1cm4gY2U7Ci19Ci0KLXZvaWQgX19pbnRlbF9jb250ZXh0X3JlbW92ZShzdHJ1Y3QgaW50
ZWxfY29udGV4dCAqY2UpCi17Ci0Jc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCA9IGNlLT5n
ZW1fY29udGV4dDsKLQotCXNwaW5fbG9jaygmY3R4LT5od19jb250ZXh0c19sb2NrKTsKLQlyYl9l
cmFzZSgmY2UtPm5vZGUsICZjdHgtPmh3X2NvbnRleHRzKTsKLQlzcGluX3VubG9jaygmY3R4LT5o
d19jb250ZXh0c19sb2NrKTsKLX0KLQotc3RhdGljIHN0cnVjdCBpbnRlbF9jb250ZXh0ICoKLWlu
dGVsX2NvbnRleHRfaW5zdGFuY2Uoc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCwKLQkJICAg
ICAgIHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKLXsKLQlzdHJ1Y3QgaW50ZWxfY29u
dGV4dCAqY2UsICpwb3M7Ci0KLQljZSA9IGludGVsX2NvbnRleHRfbG9va3VwKGN0eCwgZW5naW5l
KTsKLQlpZiAobGlrZWx5KGNlKSkKLQkJcmV0dXJuIGNlOwotCi0JY2UgPSBpbnRlbF9jb250ZXh0
X2FsbG9jKCk7Ci0JaWYgKCFjZSkKLQkJcmV0dXJuIEVSUl9QVFIoLUVOT01FTSk7Ci0KLQlpbnRl
bF9jb250ZXh0X2luaXQoY2UsIGN0eCwgZW5naW5lKTsKLQotCXBvcyA9IF9faW50ZWxfY29udGV4
dF9pbnNlcnQoY3R4LCBlbmdpbmUsIGNlKTsKLQlpZiAodW5saWtlbHkocG9zICE9IGNlKSkgLyog
QmVhdGVuISBVc2UgdGhlaXIgSFcgY29udGV4dCBpbnN0ZWFkICovCi0JCWludGVsX2NvbnRleHRf
ZnJlZShjZSk7Ci0KLQlHRU1fQlVHX09OKGludGVsX2NvbnRleHRfbG9va3VwKGN0eCwgZW5naW5l
KSAhPSBwb3MpOwotCXJldHVybiBwb3M7Ci19Ci0KLXN0cnVjdCBpbnRlbF9jb250ZXh0ICoKLWlu
dGVsX2NvbnRleHRfcGluX2xvY2soc3RydWN0IGk5MTVfZ2VtX2NvbnRleHQgKmN0eCwKLQkJICAg
ICAgIHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKLQlfX2FjcXVpcmVzKGNlLT5waW5f
bXV0ZXgpCi17Ci0Jc3RydWN0IGludGVsX2NvbnRleHQgKmNlOwotCi0JY2UgPSBpbnRlbF9jb250
ZXh0X2luc3RhbmNlKGN0eCwgZW5naW5lKTsKLQlpZiAoSVNfRVJSKGNlKSkKLQkJcmV0dXJuIGNl
OwotCi0JaWYgKG11dGV4X2xvY2tfaW50ZXJydXB0aWJsZSgmY2UtPnBpbl9tdXRleCkpCi0JCXJl
dHVybiBFUlJfUFRSKC1FSU5UUik7Ci0KLQlyZXR1cm4gY2U7Ci19Ci0KLXN0cnVjdCBpbnRlbF9j
b250ZXh0ICoKLWludGVsX2NvbnRleHRfcGluKHN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICpjdHgs
Ci0JCSAgc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lKQotewotCXN0cnVjdCBpbnRlbF9j
b250ZXh0ICpjZTsKLQlpbnQgZXJyOwotCi0JY2UgPSBpbnRlbF9jb250ZXh0X2luc3RhbmNlKGN0
eCwgZW5naW5lKTsKLQlpZiAoSVNfRVJSKGNlKSkKLQkJcmV0dXJuIGNlOwotCi0JaWYgKGxpa2Vs
eShhdG9taWNfaW5jX25vdF96ZXJvKCZjZS0+cGluX2NvdW50KSkpCi0JCXJldHVybiBjZTsKLQot
CWlmIChtdXRleF9sb2NrX2ludGVycnVwdGlibGUoJmNlLT5waW5fbXV0ZXgpKQotCQlyZXR1cm4g
RVJSX1BUUigtRUlOVFIpOwotCi0JaWYgKGxpa2VseSghYXRvbWljX3JlYWQoJmNlLT5waW5fY291
bnQpKSkgewotCQllcnIgPSBjZS0+b3BzLT5waW4oY2UpOwotCQlpZiAoZXJyKQotCQkJZ290byBl
cnI7Ci0KLQkJaTkxNV9nZW1fY29udGV4dF9nZXQoY3R4KTsKLQkJR0VNX0JVR19PTihjZS0+Z2Vt
X2NvbnRleHQgIT0gY3R4KTsKLQotCQltdXRleF9sb2NrKCZjdHgtPm11dGV4KTsKLQkJbGlzdF9h
ZGQoJmNlLT5hY3RpdmVfbGluaywgJmN0eC0+YWN0aXZlX2VuZ2luZXMpOwotCQltdXRleF91bmxv
Y2soJmN0eC0+bXV0ZXgpOwotCi0JCWludGVsX2NvbnRleHRfZ2V0KGNlKTsKLQkJc21wX21iX19i
ZWZvcmVfYXRvbWljKCk7IC8qIGZsdXNoIHBpbiBiZWZvcmUgaXQgaXMgdmlzaWJsZSAqLwotCX0K
LQotCWF0b21pY19pbmMoJmNlLT5waW5fY291bnQpOwotCUdFTV9CVUdfT04oIWludGVsX2NvbnRl
eHRfaXNfcGlubmVkKGNlKSk7IC8qIG5vIG92ZXJmbG93ISAqLwotCi0JbXV0ZXhfdW5sb2NrKCZj
ZS0+cGluX211dGV4KTsKLQlyZXR1cm4gY2U7Ci0KLWVycjoKLQltdXRleF91bmxvY2soJmNlLT5w
aW5fbXV0ZXgpOwotCXJldHVybiBFUlJfUFRSKGVycik7Ci19Ci0KLXZvaWQgaW50ZWxfY29udGV4
dF91bnBpbihzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UpCi17Ci0JaWYgKGxpa2VseShhdG9taWNf
YWRkX3VubGVzcygmY2UtPnBpbl9jb3VudCwgLTEsIDEpKSkKLQkJcmV0dXJuOwotCi0JLyogV2Ug
bWF5IGJlIGNhbGxlZCBmcm9tIGluc2lkZSBpbnRlbF9jb250ZXh0X3BpbigpIHRvIGV2aWN0IGFu
b3RoZXIgKi8KLQlpbnRlbF9jb250ZXh0X2dldChjZSk7Ci0JbXV0ZXhfbG9ja19uZXN0ZWQoJmNl
LT5waW5fbXV0ZXgsIFNJTkdMRV9ERVBUSF9ORVNUSU5HKTsKLQotCWlmIChsaWtlbHkoYXRvbWlj
X2RlY19hbmRfdGVzdCgmY2UtPnBpbl9jb3VudCkpKSB7Ci0JCWNlLT5vcHMtPnVucGluKGNlKTsK
LQotCQltdXRleF9sb2NrKCZjZS0+Z2VtX2NvbnRleHQtPm11dGV4KTsKLQkJbGlzdF9kZWwoJmNl
LT5hY3RpdmVfbGluayk7Ci0JCW11dGV4X3VubG9jaygmY2UtPmdlbV9jb250ZXh0LT5tdXRleCk7
Ci0KLQkJaTkxNV9nZW1fY29udGV4dF9wdXQoY2UtPmdlbV9jb250ZXh0KTsKLQkJaW50ZWxfY29u
dGV4dF9wdXQoY2UpOwotCX0KLQotCW11dGV4X3VubG9jaygmY2UtPnBpbl9tdXRleCk7Ci0JaW50
ZWxfY29udGV4dF9wdXQoY2UpOwotfQotCi1zdGF0aWMgdm9pZCBpbnRlbF9jb250ZXh0X3JldGly
ZShzdHJ1Y3QgaTkxNV9hY3RpdmVfcmVxdWVzdCAqYWN0aXZlLAotCQkJCSBzdHJ1Y3QgaTkxNV9y
ZXF1ZXN0ICpycSkKLXsKLQlzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UgPQotCQljb250YWluZXJf
b2YoYWN0aXZlLCB0eXBlb2YoKmNlKSwgYWN0aXZlX3RyYWNrZXIpOwotCi0JaW50ZWxfY29udGV4
dF91bnBpbihjZSk7Ci19Ci0KLXZvaWQKLWludGVsX2NvbnRleHRfaW5pdChzdHJ1Y3QgaW50ZWxf
Y29udGV4dCAqY2UsCi0JCSAgIHN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICpjdHgsCi0JCSAgIHN0
cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKLXsKLQlrcmVmX2luaXQoJmNlLT5yZWYpOwot
Ci0JY2UtPmdlbV9jb250ZXh0ID0gY3R4OwotCWNlLT5lbmdpbmUgPSBlbmdpbmU7Ci0JY2UtPm9w
cyA9IGVuZ2luZS0+Y29wczsKLQljZS0+c2F0dXJhdGVkID0gMDsKLQotCUlOSVRfTElTVF9IRUFE
KCZjZS0+c2lnbmFsX2xpbmspOwotCUlOSVRfTElTVF9IRUFEKCZjZS0+c2lnbmFscyk7Ci0KLQlt
dXRleF9pbml0KCZjZS0+cGluX211dGV4KTsKLQotCS8qIFVzZSB0aGUgd2hvbGUgZGV2aWNlIGJ5
IGRlZmF1bHQgKi8KLQljZS0+c3NldSA9IGludGVsX2RldmljZV9kZWZhdWx0X3NzZXUoY3R4LT5p
OTE1KTsKLQotCWk5MTVfYWN0aXZlX3JlcXVlc3RfaW5pdCgmY2UtPmFjdGl2ZV90cmFja2VyLAot
CQkJCSBOVUxMLCBpbnRlbF9jb250ZXh0X3JldGlyZSk7Ci19Ci0KLXN0YXRpYyB2b2lkIGk5MTVf
Z2xvYmFsX2NvbnRleHRfc2hyaW5rKHZvaWQpCi17Ci0Ja21lbV9jYWNoZV9zaHJpbmsoZ2xvYmFs
LnNsYWJfY2UpOwotfQotCi1zdGF0aWMgdm9pZCBpOTE1X2dsb2JhbF9jb250ZXh0X2V4aXQodm9p
ZCkKLXsKLQlrbWVtX2NhY2hlX2Rlc3Ryb3koZ2xvYmFsLnNsYWJfY2UpOwotfQotCi1zdGF0aWMg
c3RydWN0IGk5MTVfZ2xvYmFsX2NvbnRleHQgZ2xvYmFsID0geyB7Ci0JLnNocmluayA9IGk5MTVf
Z2xvYmFsX2NvbnRleHRfc2hyaW5rLAotCS5leGl0ID0gaTkxNV9nbG9iYWxfY29udGV4dF9leGl0
LAotfSB9OwotCi1pbnQgX19pbml0IGk5MTVfZ2xvYmFsX2NvbnRleHRfaW5pdCh2b2lkKQotewot
CWdsb2JhbC5zbGFiX2NlID0gS01FTV9DQUNIRShpbnRlbF9jb250ZXh0LCBTTEFCX0hXQ0FDSEVf
QUxJR04pOwotCWlmICghZ2xvYmFsLnNsYWJfY2UpCi0JCXJldHVybiAtRU5PTUVNOwotCi0JaTkx
NV9nbG9iYWxfcmVnaXN0ZXIoJmdsb2JhbC5iYXNlKTsKLQlyZXR1cm4gMDsKLX0KLS0gCjIuMjAu
MQoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwt
Z2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8v
bGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

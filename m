Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 654A2C1FFD
	for <lists+intel-gfx@lfdr.de>; Mon, 30 Sep 2019 13:31:21 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id B8B2189991;
	Mon, 30 Sep 2019 11:31:19 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 1CF4289991
 for <intel-gfx@lists.freedesktop.org>; Mon, 30 Sep 2019 11:31:17 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18665912-1500050 
 for multiple; Mon, 30 Sep 2019 12:31:11 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Mon, 30 Sep 2019 12:31:06 +0100
Message-Id: <20190930113106.27596-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20190930110917.21194-1-chris@chris-wilson.co.uk>
References: <20190930110917.21194-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v2] drm/i915/selftests: Exercise context
 switching in parallel
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

V2UgY3VycmVudGx5IHRlc3QgY29udGV4dCBzd2l0Y2hpbmcgb24gZWFjaCBlbmdpbmUgYXMgYSBi
YXNpYyBzdHJlc3MKdGVzdCAoanVzdCB2ZXJpZnlpbmcgdGhhdCBub3RoaW5nIGV4cGxvZGVzIGlm
IHdlIGV4ZWN1dGUgMiByZXF1ZXN0cyBmcm9tCmRpZmZlcmVudCBjb250ZXh0cyBzZXF1ZW50aWFs
bHkpLiBXaGF0IHdlIGhhdmUgbm90IHRlc3RlZCBpcyB3aGF0CmhhcHBlbnMgaWYgd2UgdHJ5IGFu
ZCBkbyBzbyBvbiBhbGwgYXZhaWxhYmxlIGVuZ2luZXMgc2ltdWx0YW5lb3VzbHksCnB1dHRpbmcg
b3VyIFNXIGFuZCB0aGUgSFcgdW5kZXIgdGhlIG1heGltYWwgc3RyZXNzLgoKU2lnbmVkLW9mZi1i
eTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28udWs+CkNjOiBNaWthIEt1b3Bw
YWxhIDxtaWthLmt1b3BwYWxhQGxpbnV4LmludGVsLmNvbT4KLS0tCktlZXAgc3RydWN0X211dGV4
IHRoZSBvdXRlciBsb2NrIHdoaWxlIGl0IHN0aWxsIGV4aXN0cwotLS0KIC4uLi9kcm0vaTkxNS9n
ZW0vc2VsZnRlc3RzL2k5MTVfZ2VtX2NvbnRleHQuYyB8IDIwMyArKysrKysrKysrKysrKysrKysK
IDEgZmlsZSBjaGFuZ2VkLCAyMDMgaW5zZXJ0aW9ucygrKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMvaTkxNV9nZW1fY29udGV4dC5jIGIvZHJpdmVycy9n
cHUvZHJtL2k5MTUvZ2VtL3NlbGZ0ZXN0cy9pOTE1X2dlbV9jb250ZXh0LmMKaW5kZXggZGMyNWJj
YzNlMzcyLi44MzI1YzczMjlkYzcgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dl
bS9zZWxmdGVzdHMvaTkxNV9nZW1fY29udGV4dC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2dlbS9zZWxmdGVzdHMvaTkxNV9nZW1fY29udGV4dC5jCkBAIC0xNTYsNiArMTU2LDIwOCBAQCBz
dGF0aWMgaW50IGxpdmVfbm9wX3N3aXRjaCh2b2lkICphcmcpCiAJcmV0dXJuIGVycjsKIH0KIAor
c3RydWN0IHBhcmFsbGVsX3N3aXRjaCB7CisJc3RydWN0IHRhc2tfc3RydWN0ICp0c2s7CisJc3Ry
dWN0IGludGVsX2NvbnRleHQgKmNlWzJdOworfTsKKworc3RhdGljIGludCBfX2xpdmVfcGFyYWxs
ZWxfc3dpdGNoMSh2b2lkICpkYXRhKQoreworCXN0cnVjdCBwYXJhbGxlbF9zd2l0Y2ggKmFyZyA9
IGRhdGE7CisJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUgPSBhcmctPmNlWzBdLT5lbmdp
bmUtPmk5MTU7CisJSUdUX1RJTUVPVVQoZW5kX3RpbWUpOworCXVuc2lnbmVkIGxvbmcgY291bnQ7
CisKKwljb3VudCA9IDA7CisJZG8geworCQlzdHJ1Y3QgaTkxNV9yZXF1ZXN0ICpycTsKKwkJaW50
IGVycjsKKworCQltdXRleF9sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKKwkJcnEgPSBp
OTE1X3JlcXVlc3RfY3JlYXRlKGFyZy0+Y2VbMF0pOworCQlpZiAoSVNfRVJSKHJxKSkgeworCQkJ
bXV0ZXhfdW5sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKKwkJCXJldHVybiBQVFJfRVJS
KHJxKTsKKwkJfQorCisJCWk5MTVfcmVxdWVzdF9hZGQocnEpOworCQltdXRleF91bmxvY2soJmk5
MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOworCisJCW11dGV4X2xvY2soJmk5MTUtPmRybS5zdHJ1Y3Rf
bXV0ZXgpOworCQlycSA9IGk5MTVfcmVxdWVzdF9jcmVhdGUoYXJnLT5jZVsxXSk7CisJCWlmIChJ
U19FUlIocnEpKSB7CisJCQltdXRleF91bmxvY2soJmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOwor
CQkJcmV0dXJuIFBUUl9FUlIocnEpOworCQl9CisKKwkJaTkxNV9yZXF1ZXN0X2dldChycSk7CisJ
CWk5MTVfcmVxdWVzdF9hZGQocnEpOworCQltdXRleF91bmxvY2soJmk5MTUtPmRybS5zdHJ1Y3Rf
bXV0ZXgpOworCisJCWVyciA9IDA7CisJCWlmIChpOTE1X3JlcXVlc3Rfd2FpdChycSwgMCwgSFog
LyA1KSA8IDApCisJCQllcnIgPSAtRVRJTUU7CisJCWk5MTVfcmVxdWVzdF9wdXQocnEpOworCQlp
ZiAoZXJyKQorCQkJcmV0dXJuIGVycjsKKworCQljb3VudCsrOworCX0gd2hpbGUgKCFfX2lndF90
aW1lb3V0KGVuZF90aW1lLCBOVUxMKSk7CisKKwlwcl9pbmZvKCIlczogJWx1IHN3aXRjaGVzIChz
eW5jKVxuIiwgYXJnLT5jZVswXS0+ZW5naW5lLT5uYW1lLCBjb3VudCk7CisJcmV0dXJuIDA7Cit9
CisKK3N0YXRpYyBpbnQgX19saXZlX3BhcmFsbGVsX3N3aXRjaE4odm9pZCAqZGF0YSkKK3sKKwlz
dHJ1Y3QgcGFyYWxsZWxfc3dpdGNoICphcmcgPSBkYXRhOworCXN0cnVjdCBkcm1faTkxNV9wcml2
YXRlICppOTE1ID0gYXJnLT5jZVswXS0+ZW5naW5lLT5pOTE1OworCUlHVF9USU1FT1VUKGVuZF90
aW1lKTsKKwl1bnNpZ25lZCBsb25nIGNvdW50OworCisJY291bnQgPSAwOworCWRvIHsKKwkJc3Ry
dWN0IGk5MTVfcmVxdWVzdCAqcnE7CisKKwkJbXV0ZXhfbG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9t
dXRleCk7CisJCXJxID0gaTkxNV9yZXF1ZXN0X2NyZWF0ZShhcmctPmNlWzBdKTsKKwkJaWYgKElT
X0VSUihycSkpIHsKKwkJCW11dGV4X3VubG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CisJ
CQlyZXR1cm4gUFRSX0VSUihycSk7CisJCX0KKworCQlpOTE1X3JlcXVlc3RfYWRkKHJxKTsKKwkJ
bXV0ZXhfdW5sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKKworCQltdXRleF9sb2NrKCZp
OTE1LT5kcm0uc3RydWN0X211dGV4KTsKKwkJcnEgPSBpOTE1X3JlcXVlc3RfY3JlYXRlKGFyZy0+
Y2VbMV0pOworCQlpZiAoSVNfRVJSKHJxKSkgeworCQkJbXV0ZXhfdW5sb2NrKCZpOTE1LT5kcm0u
c3RydWN0X211dGV4KTsKKwkJCXJldHVybiBQVFJfRVJSKHJxKTsKKwkJfQorCisJCWk5MTVfcmVx
dWVzdF9hZGQocnEpOworCQltdXRleF91bmxvY2soJmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOwor
CisJCWNvdW50Kys7CisJfSB3aGlsZSAoIV9faWd0X3RpbWVvdXQoZW5kX3RpbWUsIE5VTEwpKTsK
KworCXByX2luZm8oIiVzOiAlbHUgc3dpdGNoZXMgKG1hbnkpXG4iLCBhcmctPmNlWzBdLT5lbmdp
bmUtPm5hbWUsIGNvdW50KTsKKwlyZXR1cm4gMDsKK30KKworc3RhdGljIGludCBsaXZlX3BhcmFs
bGVsX3N3aXRjaCh2b2lkICphcmcpCit7CisJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUg
PSBhcmc7CisJc3RhdGljIGludCAoKiBjb25zdCBmdW5jW10pKHZvaWQgKmFyZykgPSB7CisJCV9f
bGl2ZV9wYXJhbGxlbF9zd2l0Y2gxLAorCQlfX2xpdmVfcGFyYWxsZWxfc3dpdGNoTiwKKwkJTlVM
TCwKKwl9OworCXN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICpjdHhbMl07CisJc3RydWN0IHBhcmFs
bGVsX3N3aXRjaCAqZGF0YTsKKwlpbnQgKCogY29uc3QgKmZuKSh2b2lkICphcmcpOworCXN0cnVj
dCBkcm1fZmlsZSAqZmlsZTsKKwlpbnQgZXJyID0gMDsKKwlpbnQgbjsKKworCS8qCisJICogQ2hl
Y2sgd2UgY2FuIHByb2Nlc3Mgc3dpdGNoZXMgb24gYWxsIGVuZ2luZXMgc2ltdWx0YW5lb3VzbHku
CisJICovCisKKwlpZiAoIURSSVZFUl9DQVBTKGk5MTUpLT5oYXNfbG9naWNhbF9jb250ZXh0cykK
KwkJcmV0dXJuIDA7CisKKwlmaWxlID0gbW9ja19maWxlKGk5MTUpOworCWlmIChJU19FUlIoZmls
ZSkpCisJCXJldHVybiBQVFJfRVJSKGZpbGUpOworCisJZGF0YSA9IGtjYWxsb2MoSTkxNV9OVU1f
RU5HSU5FUywgc2l6ZW9mKCpkYXRhKSwgR0ZQX0tFUk5FTCk7CisJaWYgKCFkYXRhKQorCQlyZXR1
cm4gLUVOT01FTTsKKworCWZvciAobiA9IDA7IG4gPCBBUlJBWV9TSVpFKGN0eCk7IG4rKykgewor
CQlzdHJ1Y3QgaTkxNV9nZW1fZW5naW5lc19pdGVyIGl0OworCQlzdHJ1Y3QgaW50ZWxfY29udGV4
dCAqY2U7CisKKwkJbXV0ZXhfbG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CisJCWN0eFtu
XSA9IGxpdmVfY29udGV4dChpOTE1LCBmaWxlKTsKKwkJaWYgKElTX0VSUihjdHhbbl0pKSB7CisJ
CQllcnIgPSBQVFJfRVJSKGN0eFtuXSk7CisJCQlnb3RvIG91dF9sb2NrZWQ7CisJCX0KKworCQlm
b3JfZWFjaF9nZW1fZW5naW5lKGNlLAorCQkJCSAgICBpOTE1X2dlbV9jb250ZXh0X2xvY2tfZW5n
aW5lcyhjdHhbbl0pLCBpdCkgeworCQkJZXJyID0gaW50ZWxfY29udGV4dF9waW4oY2UpOworCQkJ
aWYgKGVycikgeworCQkJCWk5MTVfZ2VtX2NvbnRleHRfdW5sb2NrX2VuZ2luZXMoY3R4W25dKTsK
KwkJCQlnb3RvIG91dF9sb2NrZWQ7CisJCQl9CisJCQlkYXRhW2NlLT5lbmdpbmUtPmxlZ2FjeV9p
ZHhdLmNlW25dID0gY2U7CisJCX0KKwkJaTkxNV9nZW1fY29udGV4dF91bmxvY2tfZW5naW5lcyhj
dHhbbl0pOworCQltdXRleF91bmxvY2soJmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOworCX0KKwor
CWZvciAoZm4gPSBmdW5jOyAhZXJyICYmICpmbjsgZm4rKykgeworCQlzdHJ1Y3QgaWd0X2xpdmVf
dGVzdCB0OworCQlpbnQgbjsKKworCQltdXRleF9sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4
KTsKKwkJZXJyID0gaWd0X2xpdmVfdGVzdF9iZWdpbigmdCwgaTkxNSwgX19mdW5jX18sICIiKTsK
KwkJbXV0ZXhfdW5sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsKKwkJaWYgKGVycikKKwkJ
CWJyZWFrOworCisJCWZvciAobiA9IDA7IG4gPCBJOTE1X05VTV9FTkdJTkVTOyBuKyspIHsKKwkJ
CWlmIChkYXRhW25dLmNlWzBdID09IE5VTEwgfHwgZGF0YVtuXS5jZVsxXSA9PSBOVUxMKQorCQkJ
CWNvbnRpbnVlOworCisJCQlkYXRhW25dLnRzayA9IGt0aHJlYWRfcnVuKCpmbiwgJmRhdGFbbl0s
CisJCQkJCQkgICJpZ3QvcGFyYWxsZWw6JXMiLAorCQkJCQkJICBkYXRhW25dLmNlWzBdLT5lbmdp
bmUtPm5hbWUpOworCQkJaWYgKElTX0VSUihkYXRhW25dLnRzaykpIHsKKwkJCQllcnIgPSBQVFJf
RVJSKGRhdGFbbl0udHNrKTsKKwkJCQlicmVhazsKKwkJCX0KKwkJCWdldF90YXNrX3N0cnVjdChk
YXRhW25dLnRzayk7CisJCX0KKworCQlmb3IgKG4gPSAwOyBuIDwgSTkxNV9OVU1fRU5HSU5FUzsg
bisrKSB7CisJCQlpbnQgc3RhdHVzOworCisJCQlpZiAoSVNfRVJSX09SX05VTEwoZGF0YVtuXS50
c2spKQorCQkJCWNvbnRpbnVlOworCisJCQlzdGF0dXMgPSBrdGhyZWFkX3N0b3AoZGF0YVtuXS50
c2spOworCQkJaWYgKHN0YXR1cyAmJiAhZXJyKQorCQkJCWVyciA9IHN0YXR1czsKKworCQkJcHV0
X3Rhc2tfc3RydWN0KGRhdGFbbl0udHNrKTsKKwkJCWRhdGFbbl0udHNrID0gTlVMTDsKKwkJfQor
CisJCW11dGV4X2xvY2soJmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOworCQlpZiAoaWd0X2xpdmVf
dGVzdF9lbmQoJnQpKQorCQkJZXJyID0gLUVJTzsKKwkJbXV0ZXhfdW5sb2NrKCZpOTE1LT5kcm0u
c3RydWN0X211dGV4KTsKKwl9CisKKwltdXRleF9sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4
KTsKK291dF9sb2NrZWQ6CisJZm9yIChuID0gMDsgbiA8IEk5MTVfTlVNX0VOR0lORVM7IG4rKykg
eworCQlpZiAoZGF0YVtuXS5jZVswXSkKKwkJCWludGVsX2NvbnRleHRfdW5waW4oZGF0YVtuXS5j
ZVswXSk7CisJCWlmIChkYXRhW25dLmNlWzFdKQorCQkJaW50ZWxfY29udGV4dF91bnBpbihkYXRh
W25dLmNlWzFdKTsKKwl9CisJbXV0ZXhfdW5sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsK
KwlrZnJlZShkYXRhKTsKKwltb2NrX2ZpbGVfZnJlZShpOTE1LCBmaWxlKTsKKwlyZXR1cm4gZXJy
OworfQorCiBzdGF0aWMgdW5zaWduZWQgbG9uZyByZWFsX3BhZ2VfY291bnQoc3RydWN0IGRybV9p
OTE1X2dlbV9vYmplY3QgKm9iaikKIHsKIAlyZXR1cm4gaHVnZV9nZW1fb2JqZWN0X3BoeXNfc2l6
ZShvYmopID4+IFBBR0VfU0hJRlQ7CkBAIC0xNjgxLDYgKzE4ODMsNyBAQCBpbnQgaTkxNV9nZW1f
Y29udGV4dF9saXZlX3NlbGZ0ZXN0cyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKIHsK
IAlzdGF0aWMgY29uc3Qgc3RydWN0IGk5MTVfc3VidGVzdCB0ZXN0c1tdID0gewogCQlTVUJURVNU
KGxpdmVfbm9wX3N3aXRjaCksCisJCVNVQlRFU1QobGl2ZV9wYXJhbGxlbF9zd2l0Y2gpLAogCQlT
VUJURVNUKGlndF9jdHhfZXhlYyksCiAJCVNVQlRFU1QoaWd0X2N0eF9yZWFkb25seSksCiAJCVNV
QlRFU1QoaWd0X2N0eF9zc2V1KSwKLS0gCjIuMjMuMAoKX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhA
bGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxt
YW4vbGlzdGluZm8vaW50ZWwtZ2Z4

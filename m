Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id AE961E0364
	for <lists+intel-gfx@lfdr.de>; Tue, 22 Oct 2019 13:51:50 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id E2EFE6E5F6;
	Tue, 22 Oct 2019 11:51:48 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 1DD856E5F3
 for <intel-gfx@lists.freedesktop.org>; Tue, 22 Oct 2019 11:51:44 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18924477-1500050 
 for multiple; Tue, 22 Oct 2019 12:51:39 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Tue, 22 Oct 2019 12:51:25 +0100
Message-Id: <20191022115126.18746-3-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.24.0.rc0
In-Reply-To: <20191022115126.18746-1-chris@chris-wilson.co.uk>
References: <20191022115126.18746-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 3/4] drm/i915/gt: Refactor mocs loops into
 single control macro
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

V2UgcmVwZWF0ZWRseSAoYW5kIG1vcmUgc28gaW4gZnV0dXJlKSB1c2UgdGhlIHNhbWUgbG9vcGlu
ZyBjb25zdHJ1Y3QKb3ZlciB0aGUgbW9jcyBkZWZpbml0aW9uIHRhYmxlIHRvIHNldHVwIHRoZSBy
ZWdpc3RlciBzdGF0ZS4gUmVmYWN0b3IgdGhlCmxvb3AgY29uc3RydWN0IGludG8gYSByZXVzYWJs
ZSBtYWNyby4KCmFkZC9yZW1vdmU6IDIvMSBncm93L3NocmluazogMS8yIHVwL2Rvd246IDExMy8t
MzMwICgtMjE3KQpGdW5jdGlvbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBv
bGQgICAgIG5ldyAgIGRlbHRhCmludGVsX21vY3NfaW5pdF9lbmdpbmUuY29sZCAgICAgICAgICAg
ICAgICAgICAgLSAgICAgIDcxICAgICArNzEKb2Zmc2V0ICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAtICAgICAgMjggICAgICsyOApfX2Z1bmNfXyAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgMTcyNzMgICAxNzI4NyAgICAgKzE0CmludGVsX21vY3NfaW5p
dCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDE0MyAgICAgMTEzICAgICAtMzAKbW9jc19y
ZWdpc3Rlci5pc3JhICAgICAgICAgICAgICAgICAgICAgICAgICAgIDkxICAgICAgIC0gICAgIC05
MQppbnRlbF9tb2NzX2luaXRfZW5naW5lICAgICAgICAgICAgICAgICAgICAgICA1MDMgICAgIDI5
NCAgICAtMjA5CgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNocmlzQGNocmlzLXdpbHNv
bi5jby51az4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9tb2NzLmMgfCAxMjgg
KysrKysrKysrKy0tLS0tLS0tLS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgNDcgaW5zZXJ0aW9u
cygrKSwgODEgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUv
Z3QvaW50ZWxfbW9jcy5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbW9jcy5jCmlu
ZGV4IDc0OWRjNzNlYTkzOC4uNDQ1ZWMwMjViZGEwIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9ndC9pbnRlbF9tb2NzLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50
ZWxfbW9jcy5jCkBAIC0zMjgsMjcgKzMyOCw2IEBAIHN0YXRpYyBib29sIGdldF9tb2NzX3NldHRp
bmdzKGNvbnN0IHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1LAogCXJldHVybiB0cnVlOwog
fQogCi1zdGF0aWMgaTkxNV9yZWdfdCBtb2NzX3JlZ2lzdGVyKGNvbnN0IHN0cnVjdCBpbnRlbF9l
bmdpbmVfY3MgKmVuZ2luZSwgaW50IGluZGV4KQotewotCXN3aXRjaCAoZW5naW5lLT5pZCkgewot
CWNhc2UgUkNTMDoKLQkJcmV0dXJuIEdFTjlfR0ZYX01PQ1MoaW5kZXgpOwotCWNhc2UgVkNTMDoK
LQkJcmV0dXJuIEdFTjlfTUZYMF9NT0NTKGluZGV4KTsKLQljYXNlIEJDUzA6Ci0JCXJldHVybiBH
RU45X0JMVF9NT0NTKGluZGV4KTsKLQljYXNlIFZFQ1MwOgotCQlyZXR1cm4gR0VOOV9WRUJPWF9N
T0NTKGluZGV4KTsKLQljYXNlIFZDUzE6Ci0JCXJldHVybiBHRU45X01GWDFfTU9DUyhpbmRleCk7
Ci0JY2FzZSBWQ1MyOgotCQlyZXR1cm4gR0VOMTFfTUZYMl9NT0NTKGluZGV4KTsKLQlkZWZhdWx0
OgotCQlNSVNTSU5HX0NBU0UoZW5naW5lLT5pZCk7Ci0JCXJldHVybiBJTlZBTElEX01NSU9fUkVH
OwotCX0KLX0KLQogLyoKICAqIEdldCBjb250cm9sX3ZhbHVlIGZyb20gTU9DUyBlbnRyeSB0YWtp
bmcgaW50byBhY2NvdW50IHdoZW4gaXQncyBub3QgdXNlZDoKICAqIEk5MTVfTU9DU19QVEUncyB2
YWx1ZSBpcyByZXR1cm5lZCBpbiB0aGlzIGNhc2UuCkBAIC0zNTYsMjkgKzMzNSw0NyBAQCBzdGF0
aWMgaTkxNV9yZWdfdCBtb2NzX3JlZ2lzdGVyKGNvbnN0IHN0cnVjdCBpbnRlbF9lbmdpbmVfY3Mg
KmVuZ2luZSwgaW50IGluZGV4KQogc3RhdGljIHUzMiBnZXRfZW50cnlfY29udHJvbChjb25zdCBz
dHJ1Y3QgZHJtX2k5MTVfbW9jc190YWJsZSAqdGFibGUsCiAJCQkgICAgIHVuc2lnbmVkIGludCBp
bmRleCkKIHsKLQlpZiAodGFibGUtPnRhYmxlW2luZGV4XS51c2VkKQorCWlmIChpbmRleCA8IHRh
YmxlLT5zaXplICYmIHRhYmxlLT50YWJsZVtpbmRleF0udXNlZCkKIAkJcmV0dXJuIHRhYmxlLT50
YWJsZVtpbmRleF0uY29udHJvbF92YWx1ZTsKIAogCXJldHVybiB0YWJsZS0+dGFibGVbSTkxNV9N
T0NTX1BURV0uY29udHJvbF92YWx1ZTsKIH0KIAotc3RhdGljIHZvaWQgaW5pdF9tb2NzX3RhYmxl
KHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSwKLQkJCSAgICBjb25zdCBzdHJ1Y3QgZHJt
X2k5MTVfbW9jc190YWJsZSAqdGFibGUpCisjZGVmaW5lIGZvcl9lYWNoX21vY3MobW9jcywgdCwg
aSkgXAorCWZvciAoaSA9IDA7IFwKKwkgICAgIGkgPCB0LT5uX2VudHJpZXMgPyAobW9jcyA9IGdl
dF9lbnRyeV9jb250cm9sKHQsIGkpKSwgMSA6IDA7XAorCSAgICAgaSsrKQorCitzdGF0aWMgdm9p
ZCBfX2luaXRfbW9jc190YWJsZShzdHJ1Y3QgaW50ZWxfdW5jb3JlICp1bmNvcmUsCisJCQkgICAg
ICBjb25zdCBzdHJ1Y3QgZHJtX2k5MTVfbW9jc190YWJsZSAqdGFibGUsCisJCQkgICAgICB1MzIg
YWRkcikKIHsKLQlzdHJ1Y3QgaW50ZWxfdW5jb3JlICp1bmNvcmUgPSBlbmdpbmUtPnVuY29yZTsK
LQl1MzIgdW51c2VkX3ZhbHVlID0gdGFibGUtPnRhYmxlW0k5MTVfTU9DU19QVEVdLmNvbnRyb2xf
dmFsdWU7CiAJdW5zaWduZWQgaW50IGk7CisJdTMyIG1vY3M7CiAKLQlmb3IgKGkgPSAwOyBpIDwg
dGFibGUtPnNpemU7IGkrKykKLQkJaW50ZWxfdW5jb3JlX3dyaXRlX2Z3KHVuY29yZSwKLQkJCQkg
ICAgICBtb2NzX3JlZ2lzdGVyKGVuZ2luZSwgaSksCi0JCQkJICAgICAgZ2V0X2VudHJ5X2NvbnRy
b2wodGFibGUsIGkpKTsKKwlmb3JfZWFjaF9tb2NzKG1vY3MsIHRhYmxlLCBpKQorCQlpbnRlbF91
bmNvcmVfd3JpdGVfZncodW5jb3JlLCBfTU1JTyhhZGRyICsgaSAqIDQpLCBtb2NzKTsKK30KIAot
CS8qIEFsbCByZW1haW5pbmcgZW50cmllcyBhcmUgdW51c2VkICovCi0JZm9yICg7IGkgPCB0YWJs
ZS0+bl9lbnRyaWVzOyBpKyspCi0JCWludGVsX3VuY29yZV93cml0ZV9mdyh1bmNvcmUsCi0JCQkJ
ICAgICAgbW9jc19yZWdpc3RlcihlbmdpbmUsIGkpLAotCQkJCSAgICAgIHVudXNlZF92YWx1ZSk7
CitzdGF0aWMgdTMyIG1vY3NfcmVnaXN0ZXIoY29uc3Qgc3RydWN0IGludGVsX2VuZ2luZV9jcyAq
ZW5naW5lKQoreworCXN0YXRpYyBjb25zdCB1MzIgb2Zmc2V0W10gPSB7CisJCVtSQ1MwXSAgPSAw
eDBjODAwLAorCQlbVkNTMF0gID0gMHgwYzkwMCwKKwkJW1ZDUzFdICA9IDB4MGNhMDAsCisJCVtW
RUNTMF0gPSAweDBjYjAwLAorCQlbQkNTMF0gID0gMHgwY2MwMCwKKwkJW1ZDUzJdICA9IDB4MTAw
MDAsCisJfTsKKworCUdFTV9CVUdfT04oZW5naW5lLT5pZCA+IEFSUkFZX1NJWkUob2Zmc2V0KSk7
CisJcmV0dXJuIG9mZnNldFtlbmdpbmUtPmlkXTsKK30KKworc3RhdGljIHZvaWQgaW5pdF9tb2Nz
X3RhYmxlKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSwKKwkJCSAgICBjb25zdCBzdHJ1
Y3QgZHJtX2k5MTVfbW9jc190YWJsZSAqdGFibGUpCit7CisJX19pbml0X21vY3NfdGFibGUoZW5n
aW5lLT51bmNvcmUsIHRhYmxlLCBtb2NzX3JlZ2lzdGVyKGVuZ2luZSkpOwogfQogCiAvKgpAQCAt
Mzg4LDcgKzM4NSw3IEBAIHN0YXRpYyB2b2lkIGluaXRfbW9jc190YWJsZShzdHJ1Y3QgaW50ZWxf
ZW5naW5lX2NzICplbmdpbmUsCiBzdGF0aWMgdTE2IGdldF9lbnRyeV9sM2NjKGNvbnN0IHN0cnVj
dCBkcm1faTkxNV9tb2NzX3RhYmxlICp0YWJsZSwKIAkJCSAgdW5zaWduZWQgaW50IGluZGV4KQog
ewotCWlmICh0YWJsZS0+dGFibGVbaW5kZXhdLnVzZWQpCisJaWYgKGluZGV4IDwgdGFibGUtPnNp
emUgJiYgdGFibGUtPnRhYmxlW2luZGV4XS51c2VkKQogCQlyZXR1cm4gdGFibGUtPnRhYmxlW2lu
ZGV4XS5sM2NjX3ZhbHVlOwogCiAJcmV0dXJuIHRhYmxlLT50YWJsZVtJOTE1X01PQ1NfUFRFXS5s
M2NjX3ZhbHVlOwpAQCAtMzk5LDM3ICszOTYsMjMgQEAgc3RhdGljIGlubGluZSB1MzIgbDNjY19j
b21iaW5lKHUxNiBsb3csIHUxNiBoaWdoKQogCXJldHVybiBsb3cgfCAodTMyKWhpZ2ggPDwgMTY7
CiB9CiAKKyNkZWZpbmUgZm9yX2VhY2hfbDNjYyhsM2NjLCB0LCBpKSBcCisJZm9yIChpID0gMDsg
XAorCSAgICAgaSA8ICh0LT5uX2VudHJpZXMgKyAxKSAvIDIgPyBcCisJICAgICAobDNjYyA9IGwz
Y2NfY29tYmluZShnZXRfZW50cnlfbDNjYyh0LCAyICogaSksIFwKKwkJCQkgIGdldF9lbnRyeV9s
M2NjKHQsIDIgKiBpICsgMSkpKSwgMSA6IFwKKwkgICAgIDA7IFwKKwkgICAgIGkrKykKKwogc3Rh
dGljIHZvaWQgaW5pdF9sM2NjX3RhYmxlKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSwK
IAkJCSAgICBjb25zdCBzdHJ1Y3QgZHJtX2k5MTVfbW9jc190YWJsZSAqdGFibGUpCiB7CiAJc3Ry
dWN0IGludGVsX3VuY29yZSAqdW5jb3JlID0gZW5naW5lLT51bmNvcmU7Ci0JdTE2IHVudXNlZF92
YWx1ZSA9IHRhYmxlLT50YWJsZVtJOTE1X01PQ1NfUFRFXS5sM2NjX3ZhbHVlOwogCXVuc2lnbmVk
IGludCBpOworCXUzMiBsM2NjOwogCi0JZm9yIChpID0gMDsgaSA8IHRhYmxlLT5zaXplIC8gMjsg
aSsrKSB7Ci0JCXUxNiBsb3cgPSBnZXRfZW50cnlfbDNjYyh0YWJsZSwgMiAqIGkpOwotCQl1MTYg
aGlnaCA9IGdldF9lbnRyeV9sM2NjKHRhYmxlLCAyICogaSArIDEpOwotCi0JCWludGVsX3VuY29y
ZV93cml0ZSh1bmNvcmUsCi0JCQkJICAgR0VOOV9MTkNGQ01PQ1MoaSksCi0JCQkJICAgbDNjY19j
b21iaW5lKGxvdywgaGlnaCkpOwotCX0KLQotCS8qIE9kZCB0YWJsZSBzaXplIC0gMSBsZWZ0IG92
ZXIgKi8KLQlpZiAodGFibGUtPnNpemUgJiAxKSB7Ci0JCXUxNiBsb3cgPSBnZXRfZW50cnlfbDNj
Yyh0YWJsZSwgMiAqIGkpOwotCi0JCWludGVsX3VuY29yZV93cml0ZSh1bmNvcmUsCi0JCQkJICAg
R0VOOV9MTkNGQ01PQ1MoaSksCi0JCQkJICAgbDNjY19jb21iaW5lKGxvdywgdW51c2VkX3ZhbHVl
KSk7Ci0JCWkrKzsKLQl9Ci0KLQkvKiBBbGwgcmVtYWluaW5nIGVudHJpZXMgYXJlIGFsc28gdW51
c2VkICovCi0JZm9yICg7IGkgPCB0YWJsZS0+bl9lbnRyaWVzIC8gMjsgaSsrKQotCQlpbnRlbF91
bmNvcmVfd3JpdGUodW5jb3JlLAotCQkJCSAgIEdFTjlfTE5DRkNNT0NTKGkpLAotCQkJCSAgIGwz
Y2NfY29tYmluZSh1bnVzZWRfdmFsdWUsIHVudXNlZF92YWx1ZSkpOworCWZvcl9lYWNoX2wzY2Mo
bDNjYywgdGFibGUsIGkpCisJCWludGVsX3VuY29yZV93cml0ZV9mdyh1bmNvcmUsIEdFTjlfTE5D
RkNNT0NTKGkpLCBsM2NjKTsKIH0KIAogdm9pZCBpbnRlbF9tb2NzX2luaXRfZW5naW5lKHN0cnVj
dCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKQEAgLTQ1MCwzNSArNDMzLDE4IEBAIHZvaWQgaW50
ZWxfbW9jc19pbml0X2VuZ2luZShzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUpCiAJCWlu
aXRfbDNjY190YWJsZShlbmdpbmUsICZ0YWJsZSk7CiB9CiAKLXN0YXRpYyB2b2lkIGludGVsX21v
Y3NfaW5pdF9nbG9iYWwoc3RydWN0IGludGVsX2d0ICpndCkKK3N0YXRpYyB2b2lkIGluaXRfZ2xv
YmFsX21vY3Moc3RydWN0IGludGVsX2d0ICpndCkKIHsKLQlzdHJ1Y3QgaW50ZWxfdW5jb3JlICp1
bmNvcmUgPSBndC0+dW5jb3JlOwogCXN0cnVjdCBkcm1faTkxNV9tb2NzX3RhYmxlIHRhYmxlOwot
CXVuc2lnbmVkIGludCBpbmRleDsKLQotCUdFTV9CVUdfT04oIUhBU19HTE9CQUxfTU9DU19SRUdJ
U1RFUlMoZ3QtPmk5MTUpKTsKIAogCWlmICghZ2V0X21vY3Nfc2V0dGluZ3MoZ3QtPmk5MTUsICZ0
YWJsZSkpCiAJCXJldHVybjsKIAotCWZvciAoaW5kZXggPSAwOyBpbmRleCA8IHRhYmxlLnNpemU7
IGluZGV4KyspCi0JCWludGVsX3VuY29yZV93cml0ZSh1bmNvcmUsCi0JCQkJICAgR0VOMTJfR0xP
QkFMX01PQ1MoaW5kZXgpLAotCQkJCSAgIHRhYmxlLnRhYmxlW2luZGV4XS5jb250cm9sX3ZhbHVl
KTsKLQotCS8qCi0JICogT2ssIG5vdyBzZXQgdGhlIHVudXNlZCBlbnRyaWVzIHRvIHRoZSBpbnZh
bGlkIGVudHJ5IChpbmRleCAwKS4gVGhlc2UKLQkgKiBlbnRyaWVzIGFyZSBvZmZpY2lhbGx5IHVu
ZGVmaW5lZCBhbmQgbm8gY29udHJhY3QgZm9yIHRoZSBjb250ZW50cyBhbmQKLQkgKiBzZXR0aW5n
cyBpcyBnaXZlbiBmb3IgdGhlc2UgZW50cmllcy4KLQkgKi8KLQlmb3IgKDsgaW5kZXggPCB0YWJs
ZS5uX2VudHJpZXM7IGluZGV4KyspCi0JCWludGVsX3VuY29yZV93cml0ZSh1bmNvcmUsCi0JCQkJ
ICAgR0VOMTJfR0xPQkFMX01PQ1MoaW5kZXgpLAotCQkJCSAgIHRhYmxlLnRhYmxlW0k5MTVfTU9D
U19QVEVdLmNvbnRyb2xfdmFsdWUpOworCV9faW5pdF9tb2NzX3RhYmxlKGd0LT51bmNvcmUsICZ0
YWJsZSwgMHg0MDAwKTsKIH0KIAogdm9pZCBpbnRlbF9tb2NzX2luaXQoc3RydWN0IGludGVsX2d0
ICpndCkKIHsKIAlpZiAoSEFTX0dMT0JBTF9NT0NTX1JFR0lTVEVSUyhndC0+aTkxNSkpCi0JCWlu
dGVsX21vY3NfaW5pdF9nbG9iYWwoZ3QpOworCQlpbml0X2dsb2JhbF9tb2NzKGd0KTsKIH0KLS0g
CjIuMjQuMC5yYzAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9y
ZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWdm
eA==

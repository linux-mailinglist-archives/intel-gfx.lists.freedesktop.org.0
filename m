Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 844B161793
	for <lists+intel-gfx@lfdr.de>; Sun,  7 Jul 2019 23:02:26 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id D059E89AC6;
	Sun,  7 Jul 2019 21:02:24 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 3ABFF89AC6
 for <intel-gfx@lists.freedesktop.org>; Sun,  7 Jul 2019 21:02:20 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17163715-1500050 
 for multiple; Sun, 07 Jul 2019 22:00:29 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Sun,  7 Jul 2019 22:00:24 +0100
Message-Id: <20190707210024.26192-12-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190707210024.26192-1-chris@chris-wilson.co.uk>
References: <20190707210024.26192-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 11/11] drm/i915/gtt: Tidy up ppgtt insertion for
 gen8
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

QXBwbHkgdGhlIG5ldyByYWRpeCBzaGlmdCBoZWxwZXJzIHRvIGV4dHJhY3QgdGhlIG11bHRpLWxl
dmVsIGluZGljZXMKY2xlYW5seSB3aGVuIGluc2VydGluZyBwdGUgaW50byB0aGUgZ3R0IHRyZWUu
CgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNocmlzQGNocmlzLXdpbHNvbi5jby51az4K
LS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuYyB8IDExNSArKysrKysrKysr
Ky0tLS0tLS0tLS0tLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuaCB8
ICA5MiArKy0tLS0tLS0tLS0tLS0tLS0tLS0tCiAyIGZpbGVzIGNoYW5nZWQsIDQ5IGluc2VydGlv
bnMoKyksIDE1OCBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9pOTE1X2dlbV9ndHQuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtX2d0dC5jCmlu
ZGV4IDgzZjAzZjhmNGQyYy4uZTJjM2M0Mjg4ZWRiIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9pOTE1X2dlbV9ndHQuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dl
bV9ndHQuYwpAQCAtMTEyOCw0NyArMTEyOCwyOCBAQCBzdGF0aWMgaW5saW5lIHN0cnVjdCBzZ3Rf
ZG1hIHsKIAlyZXR1cm4gKHN0cnVjdCBzZ3RfZG1hKSB7IHNnLCBhZGRyLCBhZGRyICsgc2ctPmxl
bmd0aCB9OwogfQogCi1zdHJ1Y3QgZ2VuOF9pbnNlcnRfcHRlIHsKLQl1MTYgcG1sNGU7Ci0JdTE2
IHBkcGU7Ci0JdTE2IHBkZTsKLQl1MTYgcHRlOwotfTsKLQotc3RhdGljIF9fYWx3YXlzX2lubGlu
ZSBzdHJ1Y3QgZ2VuOF9pbnNlcnRfcHRlIGdlbjhfaW5zZXJ0X3B0ZSh1NjQgc3RhcnQpCi17Ci0J
cmV0dXJuIChzdHJ1Y3QgZ2VuOF9pbnNlcnRfcHRlKSB7Ci0JCSBnZW44X3BtbDRlX2luZGV4KHN0
YXJ0KSwKLQkJIGdlbjhfcGRwZV9pbmRleChzdGFydCksCi0JCSBnZW44X3BkZV9pbmRleChzdGFy
dCksCi0JCSBnZW44X3B0ZV9pbmRleChzdGFydCksCi0JfTsKLX0KLQotc3RhdGljIF9fYWx3YXlz
X2lubGluZSBib29sCitzdGF0aWMgX19hbHdheXNfaW5saW5lIHU2NAogZ2VuOF9wcGd0dF9pbnNl
cnRfcHRlX2VudHJpZXMoc3RydWN0IGk5MTVfcHBndHQgKnBwZ3R0LAogCQkJICAgICAgc3RydWN0
IGk5MTVfcGFnZV9kaXJlY3RvcnkgKnBkcCwKIAkJCSAgICAgIHN0cnVjdCBzZ3RfZG1hICppdGVy
LAotCQkJICAgICAgc3RydWN0IGdlbjhfaW5zZXJ0X3B0ZSAqaWR4LAorCQkJICAgICAgdTY0IGlk
eCwKIAkJCSAgICAgIGVudW0gaTkxNV9jYWNoZV9sZXZlbCBjYWNoZV9sZXZlbCwKIAkJCSAgICAg
IHUzMiBmbGFncykKIHsKIAlzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeSAqcGQ7CiAJY29uc3Qg
Z2VuOF9wdGVfdCBwdGVfZW5jb2RlID0gZ2VuOF9wdGVfZW5jb2RlKDAsIGNhY2hlX2xldmVsLCBm
bGFncyk7CiAJZ2VuOF9wdGVfdCAqdmFkZHI7Ci0JYm9vbCByZXQ7CiAKLQlHRU1fQlVHX09OKGlk
eC0+cGRwZSA+PSBpOTE1X3BkcGVzX3Blcl9wZHAoJnBwZ3R0LT52bSkpOwotCXBkID0gaTkxNV9w
ZF9lbnRyeShwZHAsIGlkeC0+cGRwZSk7Ci0JdmFkZHIgPSBrbWFwX2F0b21pY19weChpOTE1X3B0
X2VudHJ5KHBkLCBpZHgtPnBkZSkpOworCXBkID0gaTkxNV9wZF9lbnRyeShwZHAsIGdlbjhfcGRf
aW5kZXgoaWR4LCAyKSk7CisJdmFkZHIgPSBrbWFwX2F0b21pY19weChpOTE1X3B0X2VudHJ5KHBk
LCBnZW44X3BkX2luZGV4KGlkeCwgMSkpKTsKIAlkbyB7Ci0JCXZhZGRyW2lkeC0+cHRlXSA9IHB0
ZV9lbmNvZGUgfCBpdGVyLT5kbWE7CisJCXZhZGRyW2dlbjhfcGRfaW5kZXgoaWR4LCAwKV0gPSBw
dGVfZW5jb2RlIHwgaXRlci0+ZG1hOwogCiAJCWl0ZXItPmRtYSArPSBJOTE1X0dUVF9QQUdFX1NJ
WkU7CiAJCWlmIChpdGVyLT5kbWEgPj0gaXRlci0+bWF4KSB7CiAJCQlpdGVyLT5zZyA9IF9fc2df
bmV4dChpdGVyLT5zZyk7CiAJCQlpZiAoIWl0ZXItPnNnKSB7Ci0JCQkJcmV0ID0gZmFsc2U7CisJ
CQkJaWR4ID0gMDsKIAkJCQlicmVhazsKIAkJCX0KIApAQCAtMTE3NiwzMCArMTE1NywyMiBAQCBn
ZW44X3BwZ3R0X2luc2VydF9wdGVfZW50cmllcyhzdHJ1Y3QgaTkxNV9wcGd0dCAqcHBndHQsCiAJ
CQlpdGVyLT5tYXggPSBpdGVyLT5kbWEgKyBpdGVyLT5zZy0+bGVuZ3RoOwogCQl9CiAKLQkJaWYg
KCsraWR4LT5wdGUgPT0gR0VOOF9QVEVTKSB7Ci0JCQlpZHgtPnB0ZSA9IDA7Ci0KLQkJCWlmICgr
K2lkeC0+cGRlID09IEk5MTVfUERFUykgewotCQkJCWlkeC0+cGRlID0gMDsKLQorCQlpZiAoZ2Vu
OF9wZF9pbmRleCgrK2lkeCwgMCkgPT0gMCkgeworCQkJaWYgKGdlbjhfcGRfaW5kZXgoaWR4LCAx
KSA9PSAwKSB7CiAJCQkJLyogTGltaXRlZCBieSBzZyBsZW5ndGggZm9yIDNsdmwgKi8KLQkJCQlp
ZiAoKytpZHgtPnBkcGUgPT0gR0VOOF9QTUw0RVNfUEVSX1BNTDQpIHsKLQkJCQkJaWR4LT5wZHBl
ID0gMDsKLQkJCQkJcmV0ID0gdHJ1ZTsKKwkJCQlpZiAoZ2VuOF9wZF9pbmRleChpZHgsIDIpID09
IDApCiAJCQkJCWJyZWFrOwotCQkJCX0KIAotCQkJCUdFTV9CVUdfT04oaWR4LT5wZHBlID49IGk5
MTVfcGRwZXNfcGVyX3BkcCgmcHBndHQtPnZtKSk7Ci0JCQkJcGQgPSBwZHAtPmVudHJ5W2lkeC0+
cGRwZV07CisJCQkJcGQgPSBwZHAtPmVudHJ5W2dlbjhfcGRfaW5kZXgoaWR4LCAyKV07CiAJCQl9
CiAKIAkJCWt1bm1hcF9hdG9taWModmFkZHIpOwotCQkJdmFkZHIgPSBrbWFwX2F0b21pY19weChp
OTE1X3B0X2VudHJ5KHBkLCBpZHgtPnBkZSkpOworCQkJdmFkZHIgPSBrbWFwX2F0b21pY19weChp
OTE1X3B0X2VudHJ5KHBkLCBnZW44X3BkX2luZGV4KGlkeCwgMSkpKTsKIAkJfQogCX0gd2hpbGUg
KDEpOwogCWt1bm1hcF9hdG9taWModmFkZHIpOwogCi0JcmV0dXJuIHJldDsKKwlyZXR1cm4gaWR4
OwogfQogCiBzdGF0aWMgdm9pZCBnZW44X3BwZ3R0X2luc2VydF8zbHZsKHN0cnVjdCBpOTE1X2Fk
ZHJlc3Nfc3BhY2UgKnZtLApAQCAtMTIwOSw5ICsxMTgyLDkgQEAgc3RhdGljIHZvaWQgZ2VuOF9w
cGd0dF9pbnNlcnRfM2x2bChzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSwKIHsKIAlzdHJ1
Y3QgaTkxNV9wcGd0dCAqcHBndHQgPSBpOTE1X3ZtX3RvX3BwZ3R0KHZtKTsKIAlzdHJ1Y3Qgc2d0
X2RtYSBpdGVyID0gc2d0X2RtYSh2bWEpOwotCXN0cnVjdCBnZW44X2luc2VydF9wdGUgaWR4ID0g
Z2VuOF9pbnNlcnRfcHRlKHZtYS0+bm9kZS5zdGFydCk7CiAKLQlnZW44X3BwZ3R0X2luc2VydF9w
dGVfZW50cmllcyhwcGd0dCwgcHBndHQtPnBkLCAmaXRlciwgJmlkeCwKKwlnZW44X3BwZ3R0X2lu
c2VydF9wdGVfZW50cmllcyhwcGd0dCwgcHBndHQtPnBkLCAmaXRlciwKKwkJCQkgICAgICB2bWEt
Pm5vZGUuc3RhcnQgPj4gR0VOOF9QVEVfU0hJRlQsCiAJCQkJICAgICAgY2FjaGVfbGV2ZWwsIGZs
YWdzKTsKIAogCXZtYS0+cGFnZV9zaXplcy5ndHQgPSBJOTE1X0dUVF9QQUdFX1NJWkU7CkBAIC0x
MjI4LDM5ICsxMjAxLDM4IEBAIHN0YXRpYyB2b2lkIGdlbjhfcHBndHRfaW5zZXJ0X2h1Z2VfZW50
cmllcyhzdHJ1Y3QgaTkxNV92bWEgKnZtYSwKIAlkbWFfYWRkcl90IHJlbSA9IGl0ZXItPnNnLT5s
ZW5ndGg7CiAKIAlkbyB7Ci0JCXN0cnVjdCBnZW44X2luc2VydF9wdGUgaWR4ID0gZ2VuOF9pbnNl
cnRfcHRlKHN0YXJ0KTsKIAkJc3RydWN0IGk5MTVfcGFnZV9kaXJlY3RvcnkgKnBkcCA9Ci0JCQlp
OTE1X3BkcF9lbnRyeShwbWw0LCBpZHgucG1sNGUpOwotCQlzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVj
dG9yeSAqcGQgPSBpOTE1X3BkX2VudHJ5KHBkcCwgaWR4LnBkcGUpOwotCQl1bnNpZ25lZCBpbnQg
cGFnZV9zaXplOwotCQlib29sIG1heWJlXzY0SyA9IGZhbHNlOworCQkJaTkxNV9wZF9lbnRyeShw
bWw0LCBfX2dlbjhfcHRlX2luZGV4KHN0YXJ0LCAzKSk7CisJCXN0cnVjdCBpOTE1X3BhZ2VfZGly
ZWN0b3J5ICpwZCA9CisJCQlpOTE1X3BkX2VudHJ5KHBkcCwgX19nZW44X3B0ZV9pbmRleChzdGFy
dCwgMikpOwogCQlnZW44X3B0ZV90IGVuY29kZSA9IHB0ZV9lbmNvZGU7CisJCXVuc2lnbmVkIGlu
dCBtYXliZV82NEsgPSAtMTsKKwkJdW5zaWduZWQgaW50IHBhZ2Vfc2l6ZTsKIAkJZ2VuOF9wdGVf
dCAqdmFkZHI7Ci0JCXUxNiBpbmRleCwgbWF4OworCQl1MTYgaW5kZXg7CiAKIAkJaWYgKHZtYS0+
cGFnZV9zaXplcy5zZyAmIEk5MTVfR1RUX1BBR0VfU0laRV8yTSAmJgogCQkgICAgSVNfQUxJR05F
RChpdGVyLT5kbWEsIEk5MTVfR1RUX1BBR0VfU0laRV8yTSkgJiYKLQkJICAgIHJlbSA+PSBJOTE1
X0dUVF9QQUdFX1NJWkVfMk0gJiYgIWlkeC5wdGUpIHsKLQkJCWluZGV4ID0gaWR4LnBkZTsKLQkJ
CW1heCA9IEk5MTVfUERFUzsKLQkJCXBhZ2Vfc2l6ZSA9IEk5MTVfR1RUX1BBR0VfU0laRV8yTTsK
LQorCQkgICAgcmVtID49IEk5MTVfR1RUX1BBR0VfU0laRV8yTSAmJgorCQkgICAgIV9fZ2VuOF9w
dGVfaW5kZXgoc3RhcnQsIDApKSB7CisJCQlpbmRleCA9IF9fZ2VuOF9wdGVfaW5kZXgoc3RhcnQs
IDEpOwogCQkJZW5jb2RlIHw9IEdFTjhfUERFX1BTXzJNOworCQkJcGFnZV9zaXplID0gSTkxNV9H
VFRfUEFHRV9TSVpFXzJNOwogCiAJCQl2YWRkciA9IGttYXBfYXRvbWljX3B4KHBkKTsKIAkJfSBl
bHNlIHsKLQkJCXN0cnVjdCBpOTE1X3BhZ2VfdGFibGUgKnB0ID0gaTkxNV9wdF9lbnRyeShwZCwg
aWR4LnBkZSk7CisJCQlzdHJ1Y3QgaTkxNV9wYWdlX3RhYmxlICpwdCA9CisJCQkJaTkxNV9wdF9l
bnRyeShwZCwgX19nZW44X3B0ZV9pbmRleChzdGFydCwgMSkpOwogCi0JCQlpbmRleCA9IGlkeC5w
dGU7Ci0JCQltYXggPSBHRU44X1BURVM7CisJCQlpbmRleCA9IF9fZ2VuOF9wdGVfaW5kZXgoc3Rh
cnQsIDApOwogCQkJcGFnZV9zaXplID0gSTkxNV9HVFRfUEFHRV9TSVpFOwogCiAJCQlpZiAoIWlu
ZGV4ICYmCiAJCQkgICAgdm1hLT5wYWdlX3NpemVzLnNnICYgSTkxNV9HVFRfUEFHRV9TSVpFXzY0
SyAmJgogCQkJICAgIElTX0FMSUdORUQoaXRlci0+ZG1hLCBJOTE1X0dUVF9QQUdFX1NJWkVfNjRL
KSAmJgogCQkJICAgIChJU19BTElHTkVEKHJlbSwgSTkxNV9HVFRfUEFHRV9TSVpFXzY0SykgfHwK
LQkJCSAgICAgcmVtID49IChtYXggLSBpbmRleCkgKiBJOTE1X0dUVF9QQUdFX1NJWkUpKQotCQkJ
CW1heWJlXzY0SyA9IHRydWU7CisJCQkgICAgIHJlbSA+PSAoSTkxNV9QREVTIC0gaW5kZXgpICog
STkxNV9HVFRfUEFHRV9TSVpFKSkKKwkJCQltYXliZV82NEsgPSBfX2dlbjhfcHRlX2luZGV4KHN0
YXJ0LCAxKTsKIAogCQkJdmFkZHIgPSBrbWFwX2F0b21pY19weChwdCk7CiAJCX0KQEAgLTEyODEs
MTYgKzEyNTMsMTYgQEAgc3RhdGljIHZvaWQgZ2VuOF9wcGd0dF9pbnNlcnRfaHVnZV9lbnRyaWVz
KHN0cnVjdCBpOTE1X3ZtYSAqdm1hLAogCQkJCWl0ZXItPmRtYSA9IHNnX2RtYV9hZGRyZXNzKGl0
ZXItPnNnKTsKIAkJCQlpdGVyLT5tYXggPSBpdGVyLT5kbWEgKyByZW07CiAKLQkJCQlpZiAobWF5
YmVfNjRLICYmIGluZGV4IDwgbWF4ICYmCisJCQkJaWYgKG1heWJlXzY0SyAhPSAtMSAmJiBpbmRl
eCA8IEk5MTVfUERFUyAmJgogCQkJCSAgICAhKElTX0FMSUdORUQoaXRlci0+ZG1hLCBJOTE1X0dU
VF9QQUdFX1NJWkVfNjRLKSAmJgogCQkJCSAgICAgIChJU19BTElHTkVEKHJlbSwgSTkxNV9HVFRf
UEFHRV9TSVpFXzY0SykgfHwKLQkJCQkgICAgICAgcmVtID49IChtYXggLSBpbmRleCkgKiBJOTE1
X0dUVF9QQUdFX1NJWkUpKSkKLQkJCQkJbWF5YmVfNjRLID0gZmFsc2U7CisJCQkJICAgICAgIHJl
bSA+PSAoSTkxNV9QREVTIC0gaW5kZXgpICogSTkxNV9HVFRfUEFHRV9TSVpFKSkpCisJCQkJCW1h
eWJlXzY0SyA9IC0xOwogCiAJCQkJaWYgKHVubGlrZWx5KCFJU19BTElHTkVEKGl0ZXItPmRtYSwg
cGFnZV9zaXplKSkpCiAJCQkJCWJyZWFrOwogCQkJfQotCQl9IHdoaWxlIChyZW0gPj0gcGFnZV9z
aXplICYmIGluZGV4IDwgbWF4KTsKKwkJfSB3aGlsZSAocmVtID49IHBhZ2Vfc2l6ZSAmJiBpbmRl
eCA8IEk5MTVfUERFUyk7CiAKIAkJa3VubWFwX2F0b21pYyh2YWRkcik7CiAKQEAgLTEzMDAsMTQg
KzEyNzIsMTQgQEAgc3RhdGljIHZvaWQgZ2VuOF9wcGd0dF9pbnNlcnRfaHVnZV9lbnRyaWVzKHN0
cnVjdCBpOTE1X3ZtYSAqdm1hLAogCQkgKiBpdCBhbmQgaGF2ZSByZWFjaGVkIHRoZSBlbmQgb2Yg
dGhlIHNnIHRhYmxlIGFuZCB3ZSBoYXZlCiAJCSAqIGVub3VnaCBwYWRkaW5nLgogCQkgKi8KLQkJ
aWYgKG1heWJlXzY0SyAmJgotCQkgICAgKGluZGV4ID09IG1heCB8fAorCQlpZiAobWF5YmVfNjRL
ICE9IC0xICYmCisJCSAgICAoaW5kZXggPT0gSTkxNV9QREVTIHx8CiAJCSAgICAgKGk5MTVfdm1f
aGFzX3NjcmF0Y2hfNjRLKHZtYS0+dm0pICYmCiAJCSAgICAgICFpdGVyLT5zZyAmJiBJU19BTElH
TkVEKHZtYS0+bm9kZS5zdGFydCArCiAJCQkJCSAgICAgIHZtYS0+bm9kZS5zaXplLAogCQkJCQkg
ICAgICBJOTE1X0dUVF9QQUdFX1NJWkVfMk0pKSkpIHsKIAkJCXZhZGRyID0ga21hcF9hdG9taWNf
cHgocGQpOwotCQkJdmFkZHJbaWR4LnBkZV0gfD0gR0VOOF9QREVfSVBTXzY0SzsKKwkJCXZhZGRy
W21heWJlXzY0S10gfD0gR0VOOF9QREVfSVBTXzY0SzsKIAkJCWt1bm1hcF9hdG9taWModmFkZHIp
OwogCQkJcGFnZV9zaXplID0gSTkxNV9HVFRfUEFHRV9TSVpFXzY0SzsKIApAQCAtMTMyNCw4ICsx
Mjk2LDcgQEAgc3RhdGljIHZvaWQgZ2VuOF9wcGd0dF9pbnNlcnRfaHVnZV9lbnRyaWVzKHN0cnVj
dCBpOTE1X3ZtYSAqdm1hLAogCQkJCXUxNiBpOwogCiAJCQkJZW5jb2RlID0gdm1hLT52bS0+c2Ny
YXRjaFswXS5lbmNvZGU7Ci0JCQkJdmFkZHIgPSBrbWFwX2F0b21pY19weChpOTE1X3B0X2VudHJ5
KHBkLAotCQkJCQkJCQkgICAgIGlkeC5wZGUpKTsKKwkJCQl2YWRkciA9IGttYXBfYXRvbWljX3B4
KGk5MTVfcHRfZW50cnkocGQsIG1heWJlXzY0SykpOwogCiAJCQkJZm9yIChpID0gMTsgaSA8IGlu
ZGV4OyBpICs9IDE2KQogCQkJCQltZW1zZXQ2NCh2YWRkciArIGksIGVuY29kZSwgMTUpOwpAQCAt
MTM1MSwxMyArMTMyMiwxMyBAQCBzdGF0aWMgdm9pZCBnZW44X3BwZ3R0X2luc2VydF80bHZsKHN0
cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAogCQlnZW44X3BwZ3R0X2luc2VydF9odWdlX2Vu
dHJpZXModm1hLCBwbWw0LCAmaXRlciwgY2FjaGVfbGV2ZWwsCiAJCQkJCSAgICAgICBmbGFncyk7
CiAJfSBlbHNlIHsKLQkJc3RydWN0IGdlbjhfaW5zZXJ0X3B0ZSBpZHggPSBnZW44X2luc2VydF9w
dGUodm1hLT5ub2RlLnN0YXJ0KTsKKwkJdTY0IGlkeCA9IHZtYS0+bm9kZS5zdGFydCA+PiBHRU44
X1BURV9TSElGVDsKIAotCQl3aGlsZSAoZ2VuOF9wcGd0dF9pbnNlcnRfcHRlX2VudHJpZXMocHBn
dHQsCi0JCQkJCQkgICAgIGk5MTVfcGRwX2VudHJ5KHBtbDQsIGlkeC5wbWw0ZSsrKSwKLQkJCQkJ
CSAgICAgJml0ZXIsICZpZHgsIGNhY2hlX2xldmVsLAotCQkJCQkJICAgICBmbGFncykpCi0JCQlH
RU1fQlVHX09OKGlkeC5wbWw0ZSA+PSBHRU44X1BNTDRFU19QRVJfUE1MNCk7CisJCXdoaWxlICgo
aWR4ID0gZ2VuOF9wcGd0dF9pbnNlcnRfcHRlX2VudHJpZXMocHBndHQsCisJCQkJCQkJICAgIGk5
MTVfcGRfZW50cnkocG1sNCwgZ2VuOF9wZF9pbmRleChpZHgsIDMpKSwKKwkJCQkJCQkgICAgJml0
ZXIsIGlkeCwgY2FjaGVfbGV2ZWwsCisJCQkJCQkJICAgIGZsYWdzKSkpCisJCQk7CiAKIAkJdm1h
LT5wYWdlX3NpemVzLmd0dCA9IEk5MTVfR1RUX1BBR0VfU0laRTsKIAl9CmRpZmYgLS1naXQgYS9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2k5MTVfZ2VtX2d0dC5oCmluZGV4IGQwMTI4ZjUyMTg0Yi4uNGJjZjYxZTQ4NTcwIDEwMDY0NAot
LS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuaAorKysgYi9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuaApAQCAtMTE1LDMwICsxMTUsMTkgQEAgdHlwZWRlZiB1
NjQgZ2VuOF9wdGVfdDsKICNkZWZpbmUgSFNXX0dUVF9BRERSX0VOQ09ERShhZGRyKQkoKGFkZHIp
IHwgKCgoYWRkcikgPj4gMjgpICYgMHg3ZjApKQogI2RlZmluZSBIU1dfUFRFX0FERFJfRU5DT0RF
KGFkZHIpCUhTV19HVFRfQUREUl9FTkNPREUoYWRkcikKIAotLyogR0VOOCAzMmIgc3R5bGUgYWRk
cmVzcyBpcyBkZWZpbmVkIGFzIGEgMyBsZXZlbCBwYWdlIHRhYmxlOgorLyoKKyAqIEdFTjggMzJi
IHN0eWxlIGFkZHJlc3MgaXMgZGVmaW5lZCBhcyBhIDMgbGV2ZWwgcGFnZSB0YWJsZToKICAqIDMx
OjMwIHwgMjk6MjEgfCAyMDoxMiB8ICAxMTowCiAgKiBQRFBFICB8ICBQREUgIHwgIFBURSAgfCBv
ZmZzZXQKICAqIFRoZSBkaWZmZXJlbmNlIGFzIGNvbXBhcmVkIHRvIG5vcm1hbCB4ODYgMyBsZXZl
bCBwYWdlIHRhYmxlIGlzIHRoZSBQRFBFcyBhcmUKICAqIHByb2dyYW1tZWQgdmlhIHJlZ2lzdGVy
LgotICovCi0jZGVmaW5lIEdFTjhfM0xWTF9QRFBFUwkJCTQKLSNkZWZpbmUgR0VOOF9QREVfU0hJ
RlQJCQkyMQotI2RlZmluZSBHRU44X1BERV9NQVNLCQkJMHgxZmYKLSNkZWZpbmUgR0VOOF9QVEVf
U0hJRlQJCQkxMgotI2RlZmluZSBHRU44X1BURV9NQVNLCQkJMHgxZmYKLSNkZWZpbmUgR0VOOF9Q
VEVTCQkJSTkxNV9QVEVTKHNpemVvZihnZW44X3B0ZV90KSkKLQotLyogR0VOOCA0OGIgc3R5bGUg
YWRkcmVzcyBpcyBkZWZpbmVkIGFzIGEgNCBsZXZlbCBwYWdlIHRhYmxlOgorICoKKyAqIEdFTjgg
NDhiIHN0eWxlIGFkZHJlc3MgaXMgZGVmaW5lZCBhcyBhIDQgbGV2ZWwgcGFnZSB0YWJsZToKICAq
IDQ3OjM5IHwgMzg6MzAgfCAyOToyMSB8IDIwOjEyIHwgIDExOjAKICAqIFBNTDRFIHwgUERQRSAg
fCAgUERFICB8ICBQVEUgIHwgb2Zmc2V0CiAgKi8KLSNkZWZpbmUgR0VOOF9QTUw0RVNfUEVSX1BN
TDQJCTUxMgotI2RlZmluZSBHRU44X1BNTDRFX1NISUZUCQkzOQotI2RlZmluZSBHRU44X1BNTDRF
X01BU0sJCQkoR0VOOF9QTUw0RVNfUEVSX1BNTDQgLSAxKQotI2RlZmluZSBHRU44X1BEUEVfU0hJ
RlQJCQkzMAotLyogTkI6IEdFTjhfUERQRV9NQVNLIGlzIHVudHJ1ZSBmb3IgMzJiIHBsYXRmb3Jt
cywgYnV0IGl0IGhhcyBubyBpbXBhY3Qgb24gMzJiIHBhZ2UKLSAqIHRhYmxlcyAqLwotI2RlZmlu
ZSBHRU44X1BEUEVfTUFTSwkJCTB4MWZmCisjZGVmaW5lIEdFTjhfM0xWTF9QRFBFUwkJCTQKKyNk
ZWZpbmUgR0VOOF9QVEVfU0hJRlQJCQkxMgogCiAjZGVmaW5lIFBQQVRfVU5DQUNIRUQJCQkoX1BB
R0VfUFdUIHwgX1BBR0VfUENEKQogI2RlZmluZSBQUEFUX0NBQ0hFRF9QREUJCQkwIC8qIFdCIExM
QyAqLwpAQCAtNTIyLDE1ICs1MTEsNiBAQCBzdGF0aWMgaW5saW5lIHUzMiBnZW42X3BkZV9pbmRl
eCh1MzIgYWRkcikKIAlyZXR1cm4gaTkxNV9wZGVfaW5kZXgoYWRkciwgR0VONl9QREVfU0hJRlQp
OwogfQogCi1zdGF0aWMgaW5saW5lIHVuc2lnbmVkIGludAotaTkxNV9wZHBlc19wZXJfcGRwKGNv
bnN0IHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtKQotewotCWlmIChpOTE1X3ZtX2lzXzRs
dmwodm0pKQotCQlyZXR1cm4gR0VOOF9QTUw0RVNfUEVSX1BNTDQ7Ci0KLQlyZXR1cm4gR0VOOF8z
TFZMX1BEUEVTOwotfQotCiBzdGF0aWMgaW5saW5lIHN0cnVjdCBpOTE1X3BhZ2VfdGFibGUgKgog
aTkxNV9wdF9lbnRyeShjb25zdCBzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeSAqIGNvbnN0IHBk
LAogCSAgICAgIGNvbnN0IHVuc2lnbmVkIHNob3J0IG4pCkBAIC01NDUsNjYgKzUyNSw2IEBAIGk5
MTVfcGRfZW50cnkoY29uc3Qgc3RydWN0IGk5MTVfcGFnZV9kaXJlY3RvcnkgKiBjb25zdCBwZHAs
CiAJcmV0dXJuIHBkcC0+ZW50cnlbbl07CiB9CiAKLXN0YXRpYyBpbmxpbmUgc3RydWN0IGk5MTVf
cGFnZV9kaXJlY3RvcnkgKgotaTkxNV9wZHBfZW50cnkoY29uc3Qgc3RydWN0IGk5MTVfcGFnZV9k
aXJlY3RvcnkgKiBjb25zdCBwbWw0LAotCSAgICAgICBjb25zdCB1bnNpZ25lZCBzaG9ydCBuKQot
ewotCXJldHVybiBwbWw0LT5lbnRyeVtuXTsKLX0KLQotLyogRXF1aXZhbGVudCB0byB0aGUgZ2Vu
NiB2ZXJzaW9uLCBGb3IgZWFjaCBwZGUgaXRlcmF0ZXMgb3ZlciBldmVyeSBwZGUKLSAqIGJldHdl
ZW4gZnJvbSBzdGFydCB1bnRpbCBzdGFydCArIGxlbmd0aC4gT24gZ2VuOCsgaXQgc2ltcGx5IGl0
ZXJhdGVzCi0gKiBvdmVyIGV2ZXJ5IHBhZ2UgZGlyZWN0b3J5IGVudHJ5IGluIGEgcGFnZSBkaXJl
Y3RvcnkuCi0gKi8KLSNkZWZpbmUgZ2VuOF9mb3JfZWFjaF9wZGUocHQsIHBkLCBzdGFydCwgbGVu
Z3RoLCBpdGVyKQkJCVwKLQlmb3IgKGl0ZXIgPSBnZW44X3BkZV9pbmRleChzdGFydCk7CQkJCVwK
LQkgICAgIGxlbmd0aCA+IDAgJiYgaXRlciA8IEk5MTVfUERFUyAmJgkJCQlcCi0JCSAgICAgKHB0
ID0gaTkxNV9wdF9lbnRyeShwZCwgaXRlciksIHRydWUpOwkJXAotCSAgICAgKHsgdTY0IHRlbXAg
PSBBTElHTihzdGFydCsxLCAxIDw8IEdFTjhfUERFX1NISUZUKTsJCVwKLQkJICAgIHRlbXAgPSBt
aW4odGVtcCAtIHN0YXJ0LCBsZW5ndGgpOwkJCVwKLQkJICAgIHN0YXJ0ICs9IHRlbXAsIGxlbmd0
aCAtPSB0ZW1wOyB9KSwgKytpdGVyKQotCi0jZGVmaW5lIGdlbjhfZm9yX2VhY2hfcGRwZShwZCwg
cGRwLCBzdGFydCwgbGVuZ3RoLCBpdGVyKQkJXAotCWZvciAoaXRlciA9IGdlbjhfcGRwZV9pbmRl
eChzdGFydCk7CQkJCVwKLQkgICAgIGxlbmd0aCA+IDAgJiYgaXRlciA8IGk5MTVfcGRwZXNfcGVy
X3BkcCh2bSkgJiYJCVwKLQkJICAgICAocGQgPSBpOTE1X3BkX2VudHJ5KHBkcCwgaXRlciksIHRy
dWUpOwkJXAotCSAgICAgKHsgdTY0IHRlbXAgPSBBTElHTihzdGFydCsxLCAxIDw8IEdFTjhfUERQ
RV9TSElGVCk7CVwKLQkJICAgIHRlbXAgPSBtaW4odGVtcCAtIHN0YXJ0LCBsZW5ndGgpOwkJCVwK
LQkJICAgIHN0YXJ0ICs9IHRlbXAsIGxlbmd0aCAtPSB0ZW1wOyB9KSwgKytpdGVyKQotCi0jZGVm
aW5lIGdlbjhfZm9yX2VhY2hfcG1sNGUocGRwLCBwbWw0LCBzdGFydCwgbGVuZ3RoLCBpdGVyKQkJ
XAotCWZvciAoaXRlciA9IGdlbjhfcG1sNGVfaW5kZXgoc3RhcnQpOwkJCQlcCi0JICAgICBsZW5n
dGggPiAwICYmIGl0ZXIgPCBHRU44X1BNTDRFU19QRVJfUE1MNCAmJgkJXAotCQkgICAgIChwZHAg
PSBpOTE1X3BkcF9lbnRyeShwbWw0LCBpdGVyKSwgdHJ1ZSk7CQlcCi0JICAgICAoeyB1NjQgdGVt
cCA9IEFMSUdOKHN0YXJ0KzEsIDFVTEwgPDwgR0VOOF9QTUw0RV9TSElGVCk7CVwKLQkJICAgIHRl
bXAgPSBtaW4odGVtcCAtIHN0YXJ0LCBsZW5ndGgpOwkJCVwKLQkJICAgIHN0YXJ0ICs9IHRlbXAs
IGxlbmd0aCAtPSB0ZW1wOyB9KSwgKytpdGVyKQotCi1zdGF0aWMgaW5saW5lIHUzMiBnZW44X3B0
ZV9pbmRleCh1NjQgYWRkcmVzcykKLXsKLQlyZXR1cm4gaTkxNV9wdGVfaW5kZXgoYWRkcmVzcywg
R0VOOF9QREVfU0hJRlQpOwotfQotCi1zdGF0aWMgaW5saW5lIHUzMiBnZW44X3BkZV9pbmRleCh1
NjQgYWRkcmVzcykKLXsKLQlyZXR1cm4gaTkxNV9wZGVfaW5kZXgoYWRkcmVzcywgR0VOOF9QREVf
U0hJRlQpOwotfQotCi1zdGF0aWMgaW5saW5lIHUzMiBnZW44X3BkcGVfaW5kZXgodTY0IGFkZHJl
c3MpCi17Ci0JcmV0dXJuIChhZGRyZXNzID4+IEdFTjhfUERQRV9TSElGVCkgJiBHRU44X1BEUEVf
TUFTSzsKLX0KLQotc3RhdGljIGlubGluZSB1MzIgZ2VuOF9wbWw0ZV9pbmRleCh1NjQgYWRkcmVz
cykKLXsKLQlyZXR1cm4gKGFkZHJlc3MgPj4gR0VOOF9QTUw0RV9TSElGVCkgJiBHRU44X1BNTDRF
X01BU0s7Ci19Ci0KLXN0YXRpYyBpbmxpbmUgdTY0IGdlbjhfcHRlX2NvdW50KHU2NCBhZGRyZXNz
LCB1NjQgbGVuZ3RoKQotewotCXJldHVybiBpOTE1X3B0ZV9jb3VudChhZGRyZXNzLCBsZW5ndGgs
IEdFTjhfUERFX1NISUZUKTsKLX0KLQogc3RhdGljIGlubGluZSBkbWFfYWRkcl90CiBpOTE1X3Bh
Z2VfZGlyX2RtYV9hZGRyKGNvbnN0IHN0cnVjdCBpOTE1X3BwZ3R0ICpwcGd0dCwgY29uc3QgdW5z
aWduZWQgaW50IG4pCiB7Ci0tIAoyLjIwLjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3Rz
LmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xp
c3RpbmZvL2ludGVsLWdmeA==

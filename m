Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 99C6410233F
	for <lists+intel-gfx@lfdr.de>; Tue, 19 Nov 2019 12:37:30 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id C8CB26E8D2;
	Tue, 19 Nov 2019 11:37:28 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mga14.intel.com (mga14.intel.com [192.55.52.115])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 17EE86E904
 for <intel-gfx@lists.freedesktop.org>; Tue, 19 Nov 2019 11:37:23 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from fmsmga003.fm.intel.com ([10.253.24.29])
 by fmsmga103.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 19 Nov 2019 03:37:22 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.68,322,1569308400"; d="scan'208";a="258700084"
Received: from alooi-mobl.gar.corp.intel.com (HELO
 skylake-nuc.ger.corp.intel.com) ([10.249.254.144])
 by FMSMGA003.fm.intel.com with ESMTP; 19 Nov 2019 03:37:21 -0800
From: Abdiel Janulgue <abdiel.janulgue@linux.intel.com>
To: intel-gfx@lists.freedesktop.org
Date: Tue, 19 Nov 2019 13:37:10 +0200
Message-Id: <20191119113710.1162-4-abdiel.janulgue@linux.intel.com>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20191119113710.1162-1-abdiel.janulgue@linux.intel.com>
References: <20191119113710.1162-1-abdiel.janulgue@linux.intel.com>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 4/4] drm/i915: Add cpu fault handler for
 mmap_offset
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Matthew Auld <matthew.auld@intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

RmF1bHQgaGFuZGxlciB0byBoYW5kbGUgbWlzc2luZyBwYWdlcyBmb3Igc2htZW0tYmFja2VkIG9i
amVjdHMuCgp2MjogYmFpbCBvdXQgb2YgaW5zZXJ0aW5nIFBURXMgd2hlbiBmYWlsaW5nIHRvIGlu
c2VydCB0aGUKICAgIGZhdWx0IGFkZHJlc3MKdjM6IGhhcyBzdHJ1Y3QgcGFnZSBjaGVjawp2NDog
QWRkIHNlbGYtdGVzdCBmb3IgdmFsaWRhdGluZyBDUFUgZmF1bHQgaGFuZGxlciB0byBlbnN1cmUg
UFRFcwogICAgYXJlIHJldm9rZWQgd2hlbiBhbiBvYmplY3QgaXMgdW5ib3VuZC4KdjU6IEFkZCBj
b21tZW50IHdoZXJlIFBURXMgYXJlIHJldm9rZWQgKENocmlzKQoKU2lnbmVkLW9mZi1ieTogQWJk
aWVsIEphbnVsZ3VlIDxhYmRpZWwuamFudWxndWVAbGludXguaW50ZWwuY29tPgpTaWduZWQtb2Zm
LWJ5OiBNYXR0aGV3IEF1bGQgPG1hdHRoZXcuYXVsZEBpbnRlbC5jb20+CkNjOiBKb29uYXMgTGFo
dGluZW4gPGpvb25hcy5sYWh0aW5lbkBsaW51eC5pbnRlbC5jb20+ClJldmlld2VkLWJ5OiBDaHJp
cyBXaWxzb24gPGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KLS0tCiBkcml2ZXJzL2dwdS9kcm0v
aTkxNS9nZW0vaTkxNV9nZW1fbW1hbi5jICAgICAgfCAxMjkgKysrKysrKysrKysrKystLS0tCiAu
Li4vZHJtL2k5MTUvZ2VtL3NlbGZ0ZXN0cy9pOTE1X2dlbV9tbWFuLmMgICAgfCAgNDggKysrKysr
LQogMiBmaWxlcyBjaGFuZ2VkLCAxNDUgaW5zZXJ0aW9ucygrKSwgMzIgZGVsZXRpb25zKC0pCgpk
aWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX21tYW4uYyBiL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9tbWFuLmMKaW5kZXggMzkxMzYzNGFiNzE3
Li5iODkyZjY0NWNhMmQgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1
X2dlbV9tbWFuLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX21tYW4u
YwpAQCAtNSw2ICs1LDcgQEAKICAqLwogCiAjaW5jbHVkZSA8bGludXgvbW1hbi5oPgorI2luY2x1
ZGUgPGxpbnV4L3Bmbl90Lmg+CiAjaW5jbHVkZSA8bGludXgvc2l6ZXMuaD4KIAogI2luY2x1ZGUg
Imd0L2ludGVsX2d0LmgiCkBAIC0yMDEsNiArMjAyLDcxIEBAIGNvbXB1dGVfcGFydGlhbF92aWV3
KGNvbnN0IHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmosCiAJcmV0dXJuIHZpZXc7CiB9
CiAKK3N0YXRpYyB2bV9mYXVsdF90IGk5MTVfZXJyb3JfdG9fdm1mX2ZhdWx0KGludCBlcnIpCit7
CisJc3dpdGNoIChlcnIpIHsKKwlkZWZhdWx0OgorCQlXQVJOX09OQ0UoZXJyLCAidW5oYW5kbGVk
IGVycm9yIGluICVzOiAlaVxuIiwgX19mdW5jX18sIGVycik7CisJCS8qIGZhbGx0aHJvdWdoICov
CisJY2FzZSAtRUlPOiAvKiBzaG1lbWZzIGZhaWx1cmUgZnJvbSBzd2FwIGRldmljZSAqLworCWNh
c2UgLUVGQVVMVDogLyogcHVyZ2VkIG9iamVjdCAqLworCWNhc2UgLUVOT0RFVjogLyogYmFkIG9i
amVjdCwgaG93IGRpZCB5b3UgZ2V0IGhlcmUhICovCisJCXJldHVybiBWTV9GQVVMVF9TSUdCVVM7
CisKKwljYXNlIC1FTk9TUEM6IC8qIHNobWVtZnMgYWxsb2NhdGlvbiBmYWlsdXJlICovCisJY2Fz
ZSAtRU5PTUVNOiAvKiBvdXIgYWxsb2NhdGlvbiBmYWlsdXJlICovCisJCXJldHVybiBWTV9GQVVM
VF9PT007CisKKwljYXNlIDA6CisJY2FzZSAtRUFHQUlOOgorCWNhc2UgLUVSRVNUQVJUU1lTOgor
CWNhc2UgLUVJTlRSOgorCWNhc2UgLUVCVVNZOgorCQkvKgorCQkgKiBFQlVTWSBpcyBvazogdGhp
cyBqdXN0IG1lYW5zIHRoYXQgYW5vdGhlciB0aHJlYWQKKwkJICogYWxyZWFkeSBkaWQgdGhlIGpv
Yi4KKwkJICovCisJCXJldHVybiBWTV9GQVVMVF9OT1BBR0U7CisJfQorfQorCitzdGF0aWMgdm1f
ZmF1bHRfdCBpOTE1X2dlbV9mYXVsdF9jcHUoc3RydWN0IHZtX2ZhdWx0ICp2bWYpCit7CisJc3Ry
dWN0IHZtX2FyZWFfc3RydWN0ICphcmVhID0gdm1mLT52bWE7CisJc3RydWN0IGk5MTVfbW1hcF9v
ZmZzZXQgKnByaXYgPSBhcmVhLT52bV9wcml2YXRlX2RhdGE7CisJc3RydWN0IGRybV9pOTE1X2dl
bV9vYmplY3QgKm9iaiA9IHByaXYtPm9iajsKKwl2bV9mYXVsdF90IHZtZl9yZXQ7CisJdW5zaWdu
ZWQgbG9uZyBpLCBzaXplID0gYXJlYS0+dm1fZW5kIC0gYXJlYS0+dm1fc3RhcnQ7CisJYm9vbCB3
cml0ZSA9IGFyZWEtPnZtX2ZsYWdzICYgVk1fV1JJVEU7CisJaW50IHJldDsKKworCWlmICghaTkx
NV9nZW1fb2JqZWN0X2hhc19zdHJ1Y3RfcGFnZShvYmopKQorCQlyZXR1cm4gVk1fRkFVTFRfU0lH
QlVTOworCisJLyogU2FuaXR5IGNoZWNrIHRoYXQgd2UgYWxsb3cgd3JpdGluZyBpbnRvIHRoaXMg
b2JqZWN0ICovCisJaWYgKGk5MTVfZ2VtX29iamVjdF9pc19yZWFkb25seShvYmopICYmIHdyaXRl
KQorCQlyZXR1cm4gVk1fRkFVTFRfU0lHQlVTOworCisJcmV0ID0gaTkxNV9nZW1fb2JqZWN0X3Bp
bl9wYWdlcyhvYmopOworCWlmIChyZXQpCisJCXJldHVybiBpOTE1X2Vycm9yX3RvX3ZtZl9mYXVs
dChyZXQpOworCisJLyogUFRFcyBhcmUgcmV2b2tlZCBpbiBvYmotPm9wcy0+cHV0X3BhZ2VzKCkg
Ki8KKwlmb3IgKGkgPSAwOyBpIDwgc2l6ZSA+PiBQQUdFX1NISUZUOyBpKyspIHsKKwkJc3RydWN0
IHBhZ2UgKnBhZ2UgPSBpOTE1X2dlbV9vYmplY3RfZ2V0X3BhZ2Uob2JqLCBpKTsKKworCQl2bWZf
cmV0ID0gdm1mX2luc2VydF9wZm4oYXJlYSwKKwkJCQkJICh1bnNpZ25lZCBsb25nKWFyZWEtPnZt
X3N0YXJ0ICsgaSAqIFBBR0VfU0laRSwKKwkJCQkJIHBhZ2VfdG9fcGZuKHBhZ2UpKTsKKwkJaWYg
KHZtZl9yZXQgIT0gVk1fRkFVTFRfTk9QQUdFKQorCQkJYnJlYWs7CisJfQorCisJaTkxNV9nZW1f
b2JqZWN0X3VucGluX3BhZ2VzKG9iaik7CisKKwlyZXR1cm4gdm1mX3JldDsKK30KKwogLyoqCiAg
KiBpOTE1X2dlbV9mYXVsdCAtIGZhdWx0IGEgcGFnZSBpbnRvIHRoZSBHVFQKICAqIEB2bWY6IGZh
dWx0IGluZm8KQEAgLTM0MCwzMCArNDA2LDcgQEAgdm1fZmF1bHRfdCBpOTE1X2dlbV9mYXVsdChz
dHJ1Y3Qgdm1fZmF1bHQgKnZtZikKIAlpbnRlbF9ydW50aW1lX3BtX3B1dChycG0sIHdha2VyZWYp
OwogCWk5MTVfZ2VtX29iamVjdF91bnBpbl9wYWdlcyhvYmopOwogZXJyOgotCXN3aXRjaCAocmV0
KSB7Ci0JZGVmYXVsdDoKLQkJV0FSTl9PTkNFKHJldCwgInVuaGFuZGxlZCBlcnJvciBpbiAlczog
JWlcbiIsIF9fZnVuY19fLCByZXQpOwotCQkvKiBmYWxsdGhyb3VnaCAqLwotCWNhc2UgLUVJTzog
Lyogc2htZW1mcyBmYWlsdXJlIGZyb20gc3dhcCBkZXZpY2UgKi8KLQljYXNlIC1FRkFVTFQ6IC8q
IHB1cmdlZCBvYmplY3QgKi8KLQljYXNlIC1FTk9ERVY6IC8qIGJhZCBvYmplY3QsIGhvdyBkaWQg
eW91IGdldCBoZXJlISAqLwotCQlyZXR1cm4gVk1fRkFVTFRfU0lHQlVTOwotCi0JY2FzZSAtRU5P
U1BDOiAvKiBzaG1lbWZzIGFsbG9jYXRpb24gZmFpbHVyZSAqLwotCWNhc2UgLUVOT01FTTogLyog
b3VyIGFsbG9jYXRpb24gZmFpbHVyZSAqLwotCQlyZXR1cm4gVk1fRkFVTFRfT09NOwotCi0JY2Fz
ZSAwOgotCWNhc2UgLUVBR0FJTjoKLQljYXNlIC1FUkVTVEFSVFNZUzoKLQljYXNlIC1FSU5UUjoK
LQljYXNlIC1FQlVTWToKLQkJLyoKLQkJICogRUJVU1kgaXMgb2s6IHRoaXMganVzdCBtZWFucyB0
aGF0IGFub3RoZXIgdGhyZWFkCi0JCSAqIGFscmVhZHkgZGlkIHRoZSBqb2IuCi0JCSAqLwotCQly
ZXR1cm4gVk1fRkFVTFRfTk9QQUdFOwotCX0KKwlyZXR1cm4gaTkxNV9lcnJvcl90b192bWZfZmF1
bHQocmV0KTsKIH0KIAogdm9pZCBfX2k5MTVfZ2VtX29iamVjdF9yZWxlYXNlX21tYXBfZ3R0KHN0
cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmopCkBAIC02NDcsNiArNjkwLDMzIEBAIHN0YXRp
YyBjb25zdCBzdHJ1Y3Qgdm1fb3BlcmF0aW9uc19zdHJ1Y3QgaTkxNV9nZW1fZ3R0X3ZtX29wcyA9
IHsKIAkuY2xvc2UgPSBpOTE1X2dlbV92bV9jbG9zZSwKIH07CiAKK3N0YXRpYyBjb25zdCBzdHJ1
Y3Qgdm1fb3BlcmF0aW9uc19zdHJ1Y3QgaTkxNV9nZW1fY3B1X3ZtX29wcyA9IHsKKwkuZmF1bHQg
PSBpOTE1X2dlbV9mYXVsdF9jcHUsCisJLm9wZW4gPSBpOTE1X2dlbV92bV9vcGVuLAorCS5jbG9z
ZSA9IGk5MTVfZ2VtX3ZtX2Nsb3NlLAorfTsKKworc3RhdGljIHZvaWQgc2V0X3ZtZGF0YV9tbWFw
X29mZnNldChzdHJ1Y3QgaTkxNV9tbWFwX29mZnNldCAqbW1vLCBzdHJ1Y3Qgdm1fYXJlYV9zdHJ1
Y3QgKnZtYSkKK3sKKwlzd2l0Y2ggKG1tby0+bW1hcF90eXBlKSB7CisJY2FzZSBJOTE1X01NQVBf
VFlQRV9XQzoKKwkJdm1hLT52bV9wYWdlX3Byb3QgPQorCQkJcGdwcm90X3dyaXRlY29tYmluZSh2
bV9nZXRfcGFnZV9wcm90KHZtYS0+dm1fZmxhZ3MpKTsKKwkJYnJlYWs7CisJY2FzZSBJOTE1X01N
QVBfVFlQRV9XQjoKKwkJdm1hLT52bV9wYWdlX3Byb3QgPSB2bV9nZXRfcGFnZV9wcm90KHZtYS0+
dm1fZmxhZ3MpOworCQlicmVhazsKKwljYXNlIEk5MTVfTU1BUF9UWVBFX1VDOgorCQl2bWEtPnZt
X3BhZ2VfcHJvdCA9CisJCQlwZ3Byb3Rfbm9uY2FjaGVkKHZtX2dldF9wYWdlX3Byb3Qodm1hLT52
bV9mbGFncykpOworCQlicmVhazsKKwlkZWZhdWx0OgorCQlicmVhazsKKwl9CisKKwl2bWEtPnZt
X29wcyA9ICZpOTE1X2dlbV9jcHVfdm1fb3BzOworfQorCiAvKiBUaGlzIG92ZXJjb21lcyB0aGUg
bGltaXRhdGlvbiBpbiBkcm1fZ2VtX21tYXAncyBhc3NpZ25tZW50IG9mIGEKICAqIGRybV9nZW1f
b2JqZWN0IGFzIHRoZSB2bWEtPnZtX3ByaXZhdGVfZGF0YS4gU2luY2Ugd2UgbmVlZCB0bwogICog
YmUgYWJsZSB0byByZXNvbHZlIG11bHRpcGxlIG1tYXAgb2Zmc2V0cyB3aGljaCBjb3VsZCBiZSB0
aWVkCkBAIC03MTQsNyArNzg0LDE2IEBAIGludCBpOTE1X2dlbV9tbWFwKHN0cnVjdCBmaWxlICpm
aWxwLCBzdHJ1Y3Qgdm1fYXJlYV9zdHJ1Y3QgKnZtYSkKIAl2bWEtPnZtX3BhZ2VfcHJvdCA9IHBn
cHJvdF9kZWNyeXB0ZWQodm1hLT52bV9wYWdlX3Byb3QpOwogCXZtYS0+dm1fcHJpdmF0ZV9kYXRh
ID0gbW1vOwogCi0Jdm1hLT52bV9vcHMgPSAmaTkxNV9nZW1fZ3R0X3ZtX29wczsKKwlzd2l0Y2gg
KG1tby0+bW1hcF90eXBlKSB7CisJY2FzZSBJOTE1X01NQVBfVFlQRV9XQzoKKwljYXNlIEk5MTVf
TU1BUF9UWVBFX1dCOgorCWNhc2UgSTkxNV9NTUFQX1RZUEVfVUM6CisJCXNldF92bWRhdGFfbW1h
cF9vZmZzZXQobW1vLCB2bWEpOworCQlicmVhazsKKwljYXNlIEk5MTVfTU1BUF9UWVBFX0dUVDoK
KwkJdm1hLT52bV9vcHMgPSAmaTkxNV9nZW1fZ3R0X3ZtX29wczsKKwkJYnJlYWs7CisJfQogCiAJ
cmV0dXJuIDA7CiB9CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vc2VsZnRl
c3RzL2k5MTVfZ2VtX21tYW4uYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMv
aTkxNV9nZW1fbW1hbi5jCmluZGV4IDZjMjMzM2M2MTQ2OS4uMWJlZGM5ZDExNWM1IDEwMDY0NAot
LS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vc2VsZnRlc3RzL2k5MTVfZ2VtX21tYW4uYwor
KysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vc2VsZnRlc3RzL2k5MTVfZ2VtX21tYW4uYwpA
QCAtNzMxLDcgKzczMSw3IEBAIHN0YXRpYyBpbnQgaWd0X21tYXBfb2Zmc2V0X2V4aGF1c3Rpb24o
dm9pZCAqYXJnKQogfQogCiAjZGVmaW5lIGV4cGFuZDMyKHgpICgoKHgpIDw8IDApIHwgKCh4KSA8
PCA4KSB8ICgoeCkgPDwgMTYpIHwgKCh4KSA8PCAyNCkpCi1zdGF0aWMgaW50IGlndF9tbWFwX2d0
dCh2b2lkICphcmcpCitzdGF0aWMgaW50IGlndF9tbWFwKHZvaWQgKmFyZywgZW51bSBpOTE1X21t
YXBfdHlwZSB0eXBlKQogewogCXN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1ID0gYXJnOwog
CXN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmo7CkBAIC03NjIsNyArNzYyLDggQEAgc3Rh
dGljIGludCBpZ3RfbW1hcF9ndHQodm9pZCAqYXJnKQogCWlmIChlcnIpCiAJCWdvdG8gb3V0Owog
Ci0JYWRkciA9IGlndF9tbWFwX25vZGUoaTkxNSwgJm9iai0+YmFzZS52bWFfbm9kZSwKKwltbW8t
Pm1tYXBfdHlwZSA9IHR5cGU7CisJYWRkciA9IGlndF9tbWFwX25vZGUoaTkxNSwgJm1tby0+dm1h
X25vZGUsCiAJCQkgICAgIDAsIFBST1RfV1JJVEUsIE1BUF9TSEFSRUQpOwogCWlmIChJU19FUlJf
VkFMVUUoYWRkcikpIHsKIAkJZXJyID0gYWRkcjsKQEAgLTc3OCw4ICs3NzksOCBAQCBzdGF0aWMg
aW50IGlndF9tbWFwX2d0dCh2b2lkICphcmcpCiAJCWdvdG8gb3V0X3VubWFwOwogCX0KIAotCWlm
IChhcmVhLT52bV9wcml2YXRlX2RhdGEgIT0gb2JqKSB7Ci0JCXByX2Vycigidm1fYXJlYV9zdHJ1
Y3QgZGlkIG5vdCBwb2ludCBiYWNrIHRvIG91ciBvYmplY3QhXG4iKTsKKwlpZiAoYXJlYS0+dm1f
cHJpdmF0ZV9kYXRhICE9IG1tbykgeworCQlwcl9lcnIoInZtX2FyZWFfc3RydWN0IGRpZCBub3Qg
cG9pbnQgYmFjayB0byBvdXIgbW1hcF9vZmZzZXQgb2JqZWN0IVxuIik7CiAJCWVyciA9IC1FSU5W
QUw7CiAJCWdvdG8gb3V0X3VubWFwOwogCX0KQEAgLTgzMCw2ICs4MzEsMTYgQEAgc3RhdGljIGlu
dCBpZ3RfbW1hcF9ndHQodm9pZCAqYXJnKQogCXJldHVybiBlcnI7CiB9CiAKK3N0YXRpYyBpbnQg
aWd0X21tYXBfZ3R0KHZvaWQgKmFyZykKK3sKKwlyZXR1cm4gaWd0X21tYXAoYXJnLCBJOTE1X01N
QVBfVFlQRV9HVFQpOworfQorCitzdGF0aWMgaW50IGlndF9tbWFwX2NwdSh2b2lkICphcmcpCit7
CisJcmV0dXJuIGlndF9tbWFwKGFyZywgSTkxNV9NTUFQX1RZUEVfV0MpOworfQorCiBzdGF0aWMg
aW50IGNoZWNrX3ByZXNlbnRfcHRlKHB0ZV90ICpwdGUsIHVuc2lnbmVkIGxvbmcgYWRkciwgdm9p
ZCAqZGF0YSkKIHsKIAlpZiAoIXB0ZV9wcmVzZW50KCpwdGUpIHx8IHB0ZV9ub25lKCpwdGUpKSB7
CkBAIC04ODIsNyArODkzLDcgQEAgc3RhdGljIGludCBwcmVmYXVsdF9yYW5nZSh1NjQgc3RhcnQs
IHU2NCBsZW4pCiAJcmV0dXJuIF9fZ2V0X3VzZXIoYywgZW5kIC0gMSk7CiB9CiAKLXN0YXRpYyBp
bnQgaWd0X21tYXBfZ3R0X3Jldm9rZSh2b2lkICphcmcpCitzdGF0aWMgaW50IGlndF9tbWFwX3Jl
dm9rZSh2b2lkICphcmcsIGVudW0gaTkxNV9tbWFwX3R5cGUgdHlwZSkKIHsKIAlzdHJ1Y3QgZHJt
X2k5MTVfcHJpdmF0ZSAqaTkxNSA9IGFyZzsKIAlzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAq
b2JqOwpAQCAtOTAyLDcgKzkxMyw4IEBAIHN0YXRpYyBpbnQgaWd0X21tYXBfZ3R0X3Jldm9rZSh2
b2lkICphcmcpCiAJaWYgKGVycikKIAkJZ290byBvdXQ7CiAKLQlhZGRyID0gaWd0X21tYXBfbm9k
ZShpOTE1LCAmb2JqLT5iYXNlLnZtYV9ub2RlLAorCW1tby0+bW1hcF90eXBlID0gdHlwZTsKKwlh
ZGRyID0gaWd0X21tYXBfbm9kZShpOTE1LCAmbW1vLT52bWFfbm9kZSwKIAkJCSAgICAgMCwgUFJP
VF9XUklURSwgTUFQX1NIQVJFRCk7CiAJaWYgKElTX0VSUl9WQUxVRShhZGRyKSkgewogCQllcnIg
PSBhZGRyOwpAQCAtOTEzLDcgKzkyNSw4IEBAIHN0YXRpYyBpbnQgaWd0X21tYXBfZ3R0X3Jldm9r
ZSh2b2lkICphcmcpCiAJaWYgKGVycikKIAkJZ290byBvdXRfdW5tYXA7CiAKLQlHRU1fQlVHX09O
KCFhdG9taWNfcmVhZCgmb2JqLT5iaW5kX2NvdW50KSk7CisJR0VNX0JVR19PTihtbW8tPm1tYXBf
dHlwZSA9PSBJOTE1X01NQVBfVFlQRV9HVFQgJiYKKwkJICAgIWF0b21pY19yZWFkKCZvYmotPmJp
bmRfY291bnQpKTsKIAogCWVyciA9IGNoZWNrX3ByZXNlbnQoYWRkciwgb2JqLT5iYXNlLnNpemUp
OwogCWlmIChlcnIpCkBAIC05MzEsNiArOTQ0LDE1IEBAIHN0YXRpYyBpbnQgaWd0X21tYXBfZ3R0
X3Jldm9rZSh2b2lkICphcmcpCiAJfQogCUdFTV9CVUdfT04oYXRvbWljX3JlYWQoJm9iai0+Ymlu
ZF9jb3VudCkpOwogCisJaWYgKHR5cGUgIT0gSTkxNV9NTUFQX1RZUEVfR1RUKSB7CisJCV9faTkx
NV9nZW1fb2JqZWN0X3B1dF9wYWdlcyhvYmopOworCQlpZiAoaTkxNV9nZW1fb2JqZWN0X2hhc19w
YWdlcyhvYmopKSB7CisJCQlwcl9lcnIoIkZhaWxlZCB0byBwdXQtcGFnZXMgb2JqZWN0IVxuIik7
CisJCQllcnIgPSAtRUlOVkFMOworCQkJZ290byBvdXRfdW5tYXA7CisJCX0KKwl9CisKIAllcnIg
PSBjaGVja19hYnNlbnQoYWRkciwgb2JqLT5iYXNlLnNpemUpOwogCWlmIChlcnIpCiAJCWdvdG8g
b3V0X3VubWFwOwpAQCAtOTQyLDYgKzk2NCwxNiBAQCBzdGF0aWMgaW50IGlndF9tbWFwX2d0dF9y
ZXZva2Uodm9pZCAqYXJnKQogCXJldHVybiBlcnI7CiB9CiAKK3N0YXRpYyBpbnQgaWd0X21tYXBf
Z3R0X3Jldm9rZSh2b2lkICphcmcpCit7CisJcmV0dXJuIGlndF9tbWFwX3Jldm9rZShhcmcsIEk5
MTVfTU1BUF9UWVBFX0dUVCk7Cit9CisKK3N0YXRpYyBpbnQgaWd0X21tYXBfY3B1X3Jldm9rZSh2
b2lkICphcmcpCit7CisJcmV0dXJuIGlndF9tbWFwX3Jldm9rZShhcmcsIEk5MTVfTU1BUF9UWVBF
X1dDKTsKK30KKwogaW50IGk5MTVfZ2VtX21tYW5fbGl2ZV9zZWxmdGVzdHMoc3RydWN0IGRybV9p
OTE1X3ByaXZhdGUgKmk5MTUpCiB7CiAJc3RhdGljIGNvbnN0IHN0cnVjdCBpOTE1X3N1YnRlc3Qg
dGVzdHNbXSA9IHsKQEAgLTk0OSw3ICs5ODEsOSBAQCBpbnQgaTkxNV9nZW1fbW1hbl9saXZlX3Nl
bGZ0ZXN0cyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKIAkJU1VCVEVTVChpZ3Rfc21v
a2VfdGlsaW5nKSwKIAkJU1VCVEVTVChpZ3RfbW1hcF9vZmZzZXRfZXhoYXVzdGlvbiksCiAJCVNV
QlRFU1QoaWd0X21tYXBfZ3R0KSwKKwkJU1VCVEVTVChpZ3RfbW1hcF9jcHUpLAogCQlTVUJURVNU
KGlndF9tbWFwX2d0dF9yZXZva2UpLAorCQlTVUJURVNUKGlndF9tbWFwX2NwdV9yZXZva2UpLAog
CX07CiAKIAlyZXR1cm4gaTkxNV9zdWJ0ZXN0cyh0ZXN0cywgaTkxNSk7Ci0tIAoyLjIzLjAKCl9f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCkludGVsLWdmeCBt
YWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3Rz
LmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWdmeA==

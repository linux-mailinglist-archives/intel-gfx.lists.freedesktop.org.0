Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id A0244A135A
	for <lists+intel-gfx@lfdr.de>; Thu, 29 Aug 2019 10:12:33 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id F0C126E03A;
	Thu, 29 Aug 2019 08:12:18 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 89C006E041
 for <intel-gfx@lists.freedesktop.org>; Thu, 29 Aug 2019 08:12:05 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18299884-1500050 
 for multiple; Thu, 29 Aug 2019 09:11:58 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Thu, 29 Aug 2019 09:11:39 +0100
Message-Id: <20190829081150.10271-26-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20190829081150.10271-1-chris@chris-wilson.co.uk>
References: <20190829081150.10271-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 25/36] drm/i915/execlists: Force preemption
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SWYgdGhlIHByZWVtcHRlZCBjb250ZXh0IHRha2VzIHRvbyBsb25nIHRvIHJlbGlucXVpc2ggY29u
dHJvbCwgZS5nLiBpdAppcyBzdHVjayBpbnNpZGUgYSBzaGFkZXIgd2l0aCBhcmJpdHJhdGlvbiBk
aXNhYmxlZCwgZXZpY3QgdGhhdCBjb250ZXh0CndpdGggYW4gZW5naW5lIHJlc2V0LiBUaGlzIGVu
c3VyZXMgdGhhdCBwcmVlbXB0aW9ucyBhcmUgcmVhc29uYWJseQpyZXNwb25zaXZlLCBwcm92aWRp
bmcgYSB0aWdodGVyIFFvUyBmb3IgdGhlIG1vcmUgaW1wb3J0YW50IGNvbnRleHQgYXQKdGhlIGNv
c3Qgb2YgZmxhZ2dpbmcgdW5yZXNwb25zaXZlIGNvbnRleHRzIG1vcmUgZnJlcXVlbnRseSAoaS5l
LiBpbnN0ZWFkCm9mIHVzaW5nIGFuIH4xMHMgaGFuZ2NoZWNrLCB3ZSBub3cgZXZpY3QgYXQgfjEw
MG1zKS4gIFRoZSBjaGFsbGVuZ2Ugb2YKbGllcyBpbiBwaWNraW5nIGEgdGltZW91dCB0aGF0IGNh
biBiZSByZWFzb25hYmx5IHNlcnZpY2VkIGJ5IEhXIGZvcgp0eXBpY2FsIHdvcmtsb2FkcywgYmFs
YW5jaW5nIHRoZSBleGlzdGluZyBjbGllbnRzIGFnYWluc3QgdGhlIG5lZWRzIGZvcgpyZXNwb25z
aXZlbmVzcy4KCk5vdGUgdGhhdCBjb3VwbGVkIHdpdGggdGltZXNsaWNpbmcsIHRoaXMgd2lsbCBs
ZWFkIHRvIHJhcGlkIEdQVSAiaGFuZyIKZGV0ZWN0aW9uIHdpdGggbXVsdGlwbGUgYWN0aXZlIGNv
bnRleHRzIHZ5aW5nIGZvciBHUFUgdGltZS4KClNpZ25lZC1vZmYtYnk6IENocmlzIFdpbHNvbiA8
Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPgpDYzogTWlrYSBLdW9wcGFsYSA8bWlrYS5rdW9wcGFs
YUBsaW51eC5pbnRlbC5jb20+CkNjOiBUdnJ0a28gVXJzdWxpbiA8dHZydGtvLnVyc3VsaW5AaW50
ZWwuY29tPgpSZXZpZXdlZC1ieTogTWlrYSBLdW9wcGFsYSA8bWlrYS5rdW9wcGFsYUBsaW51eC5p
bnRlbC5jb20+Ci0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvS2NvbmZpZy5wcm9maWxlIHwgMTIg
KysrKysrKwogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjLmMgIHwgNTEgKysrKysr
KysrKysrKysrKysrKysrKysrKysrKwogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wYXJhbXMu
aCAgIHwgIDIgKy0KIDMgZmlsZXMgY2hhbmdlZCwgNjQgaW5zZXJ0aW9ucygrKSwgMSBkZWxldGlv
bigtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L0tjb25maWcucHJvZmlsZSBi
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L0tjb25maWcucHJvZmlsZQppbmRleCA0OGRmODg4OWE4OGEu
LjMxODRlODQ5MTMzMyAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvS2NvbmZpZy5w
cm9maWxlCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L0tjb25maWcucHJvZmlsZQpAQCAtMjUs
MyArMjUsMTUgQEAgY29uZmlnIERSTV9JOTE1X1NQSU5fUkVRVUVTVAogCSAgTWF5IGJlIDAgdG8g
ZGlzYWJsZSB0aGUgaW5pdGlhbCBzcGluLiBJbiBwcmFjdGljZSwgd2UgZXN0aW1hdGUKIAkgIHRo
ZSBjb3N0IG9mIGVuYWJsaW5nIHRoZSBpbnRlcnJ1cHQgKGlmIGN1cnJlbnRseSBkaXNhYmxlZCkg
dG8gYmUKIAkgIGEgZmV3IG1pY3Jvc2Vjb25kcy4KKworY29uZmlnIERSTV9JOTE1X1BSRUVNUFRf
VElNRU9VVAorCWludCAiUHJlZW1wdCB0aW1lb3V0IChtcykiCisJZGVmYXVsdCAxMDAgIyBtaWxs
aXNlY29uZHMKKwloZWxwCisJICBIb3cgbG9uZyB0byB3YWl0IChpbiBtaWxsaXNlY29uZHMpIGZv
ciBhIHByZWVtcHRpb24gZXZlbnQgdG8gb2NjdXIKKwkgIHdoZW4gc3VibWl0dGluZyBhIG5ldyBj
b250ZXh0IHZpYSBleGVjbGlzdHMuIElmIHRoZSBjdXJyZW50IGNvbnRleHQKKwkgIGRvZXMgbm90
IGhpdCBhbiBhcmJpdHJhdGlvbiBwb2ludCBhbmQgeWllbGQgdG8gSFcgYmVmb3JlIHRoZSB0aW1l
cgorCSAgZXhwaXJlcywgdGhlIEhXIHdpbGwgYmUgcmVzZXQgdG8gYWxsb3cgdGhlIG1vcmUgaW1w
b3J0YW50IGNvbnRleHQKKwkgIHRvIGV4ZWN1dGUuCisKKwkgIE1heSBiZSAwIHRvIGRpc2FibGUg
dGhlIHRpbWVvdXQuCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9s
cmMuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2xyYy5jCmluZGV4IDNhMjNhN2Jk
YTUwZS4uM2U3ZWJhZDgzNmFjIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9p
bnRlbF9scmMuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9scmMuYwpAQCAt
MTAwNSw2ICsxMDA1LDIxIEBAIHN0YXRpYyB2b2lkIHJlY29yZF9wcmVlbXB0aW9uKHN0cnVjdCBp
bnRlbF9lbmdpbmVfZXhlY2xpc3RzICpleGVjbGlzdHMpCiAJKHZvaWQpSTkxNV9TRUxGVEVTVF9P
TkxZKGV4ZWNsaXN0cy0+cHJlZW1wdF9oYW5nLmNvdW50KyspOwogfQogCitzdGF0aWMgdW5zaWdu
ZWQgbG9uZyBwcmVlbXB0X2V4cGlyZXModm9pZCkKK3sKKwljb25zdCB1bnNpZ25lZCBsb25nIHRp
bWVvdXQgPQorCQltc2Vjc190b19qaWZmaWVzX3RpbWVvdXQoQ09ORklHX0RSTV9JOTE1X1BSRUVN
UFRfVElNRU9VVCk7CisKKwkvKgorCSAqIFBhcmFub2lhIHRvIG1ha2Ugc3VyZSB0aGUgY29tcGls
ZXIgY29tcHV0ZXMgdGhlIHRpbWVvdXQgYmVmb3JlCisJICogbG9hZGluZyAnamlmZmllcycgYXMg
amlmZmllcyBpcyB2b2xhdGlsZSBhbmQgbWF5IGJlIHVwZGF0ZWQgaW4KKwkgKiB0aGUgYmFja2dy
b3VuZCBieSBhIHRpbWVyIHRpY2suIEFsbCB0byByZWR1Y2UgdGhlIGNvbXBsZXhpdHkKKwkgKiBv
ZiB0aGUgYWRkaXRpb24gYW5kIHJlZHVjZSB0aGUgcmlzayBvZiBsb3NpbmcgYSBqaWZmaWUuCisJ
ICovCisJYmFycmllcigpOworCXJldHVybiBqaWZmaWVzICsgdGltZW91dDsKK30KKwogc3RhdGlj
IHZvaWQgZXhlY2xpc3RzX2RlcXVldWUoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lKQog
ewogCXN0cnVjdCBpbnRlbF9lbmdpbmVfZXhlY2xpc3RzICogY29uc3QgZXhlY2xpc3RzID0gJmVu
Z2luZS0+ZXhlY2xpc3RzOwpAQCAtMTM0NSw2ICsxMzYwLDggQEAgc3RhdGljIHZvaWQgZXhlY2xp
c3RzX2RlcXVldWUoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lKQogCQlleGVjbGlzdHMt
PnN3aXRjaF9wcmlvcml0eV9oaW50ID0KIAkJCXN3aXRjaF9wcmlvKGVuZ2luZSwgKmV4ZWNsaXN0
cy0+cGVuZGluZyk7CiAJCWV4ZWNsaXN0c19zdWJtaXRfcG9ydHMoZW5naW5lKTsKKwkJaWYgKENP
TkZJR19EUk1fSTkxNV9QUkVFTVBUX1RJTUVPVVQpCisJCQltb2RfdGltZXIoJmV4ZWNsaXN0cy0+
dGltZXIsIHByZWVtcHRfZXhwaXJlcygpKTsKIAl9IGVsc2UgewogCQlyaW5nX3NldF9wYXVzZWQo
ZW5naW5lLCAwKTsKIAl9CkBAIC0xNjA0LDYgKzE2MjEsMzcgQEAgc3RhdGljIHZvaWQgX19leGVj
bGlzdHNfc3VibWlzc2lvbl90YXNrbGV0KHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmNvbnN0IGVu
Z2luZSkKIAkJZXhlY2xpc3RzX2RlcXVldWUoZW5naW5lKTsKIH0KIAorc3RhdGljIG5vaW5saW5l
IHZvaWQgcHJlZW1wdF9yZXNldChzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUpCit7CisJ
Y29uc3QgdW5zaWduZWQgaW50IGJpdCA9IEk5MTVfUkVTRVRfRU5HSU5FICsgZW5naW5lLT5pZDsK
Kwl1bnNpZ25lZCBsb25nICpsb2NrID0gJmVuZ2luZS0+Z3QtPnJlc2V0LmZsYWdzOworCisJaWYg
KGk5MTVfbW9kcGFyYW1zLnJlc2V0IDwgMykKKwkJcmV0dXJuOworCisJaWYgKHRlc3RfYW5kX3Nl
dF9iaXQoYml0LCBsb2NrKSkKKwkJcmV0dXJuOworCisJLyogTWFyayB0aGlzIHRhc2tsZXQgYXMg
ZGlzYWJsZWQgdG8gYXZvaWQgd2FpdGluZyBmb3IgaXQgdG8gY29tcGxldGUgKi8KKwl0YXNrbGV0
X2Rpc2FibGVfbm9zeW5jKCZlbmdpbmUtPmV4ZWNsaXN0cy50YXNrbGV0KTsKKworCWludGVsX2Vu
Z2luZV9yZXNldChlbmdpbmUsICJwcmVlbXB0aW9uIHRpbWUgb3V0Iik7CisKKwl0YXNrbGV0X2Vu
YWJsZSgmZW5naW5lLT5leGVjbGlzdHMudGFza2xldCk7CisJY2xlYXJfYW5kX3dha2VfdXBfYml0
KGJpdCwgbG9jayk7Cit9CisKK3N0YXRpYyBib29sIHByZWVtcHRfdGltZW91dChzdHJ1Y3QgaW50
ZWxfZW5naW5lX2NzICpjb25zdCBlbmdpbmUpCit7CisJaWYgKCFDT05GSUdfRFJNX0k5MTVfUFJF
RU1QVF9USU1FT1VUKQorCQlyZXR1cm4gZmFsc2U7CisKKwlpZiAoIWludGVsX2VuZ2luZV9oYXNf
cHJlZW1wdGlvbihlbmdpbmUpKQorCQlyZXR1cm4gZmFsc2U7CisKKwlyZXR1cm4gIXRpbWVyX3Bl
bmRpbmcoJmVuZ2luZS0+ZXhlY2xpc3RzLnRpbWVyKTsKK30KKwogLyoKICAqIENoZWNrIHRoZSB1
bnJlYWQgQ29udGV4dCBTdGF0dXMgQnVmZmVycyBhbmQgbWFuYWdlIHRoZSBzdWJtaXNzaW9uIG9m
IG5ldwogICogY29udGV4dHMgdG8gdGhlIEVMU1AgYWNjb3JkaW5nbHkuCkBAIC0xNjE4LDYgKzE2
NjYsOSBAQCBzdGF0aWMgdm9pZCBleGVjbGlzdHNfc3VibWlzc2lvbl90YXNrbGV0KHVuc2lnbmVk
IGxvbmcgZGF0YSkKIAkJc3Bpbl9sb2NrX2lycXNhdmUoJmVuZ2luZS0+YWN0aXZlLmxvY2ssIGZs
YWdzKTsKIAkJX19leGVjbGlzdHNfc3VibWlzc2lvbl90YXNrbGV0KGVuZ2luZSk7CiAJCXNwaW5f
dW5sb2NrX2lycXJlc3RvcmUoJmVuZ2luZS0+YWN0aXZlLmxvY2ssIGZsYWdzKTsKKwl9IGVsc2Ug
eworCQlpZiAocHJlZW1wdF90aW1lb3V0KGVuZ2luZSkpCisJCQlwcmVlbXB0X3Jlc2V0KGVuZ2lu
ZSk7CiAJfQogfQogCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3BhcmFt
cy5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wYXJhbXMuaAppbmRleCBkMjlhZGUzYjdk
ZTYuLjU2MDU4OTc4YmIyNyAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9w
YXJhbXMuaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3BhcmFtcy5oCkBAIC02MSw3
ICs2MSw3IEBAIHN0cnVjdCBkcm1fcHJpbnRlcjsKIAlwYXJhbShjaGFyICosIGRtY19maXJtd2Fy
ZV9wYXRoLCBOVUxMKSBcCiAJcGFyYW0oaW50LCBtbWlvX2RlYnVnLCAtSVNfRU5BQkxFRChDT05G
SUdfRFJNX0k5MTVfREVCVUdfTU1JTykpIFwKIAlwYXJhbShpbnQsIGVkcF92c3dpbmcsIDApIFwK
LQlwYXJhbShpbnQsIHJlc2V0LCAyKSBcCisJcGFyYW0oaW50LCByZXNldCwgMykgXAogCXBhcmFt
KHVuc2lnbmVkIGludCwgaW5qZWN0X2xvYWRfZmFpbHVyZSwgMCkgXAogCXBhcmFtKGludCwgZmFz
dGJvb3QsIC0xKSBcCiAJcGFyYW0oaW50LCBlbmFibGVfZHBjZF9iYWNrbGlnaHQsIDApIFwKLS0g
CjIuMjMuMAoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18K
SW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0
dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

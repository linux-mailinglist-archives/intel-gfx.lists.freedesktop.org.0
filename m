Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id A39E3E2F7B
	for <lists+intel-gfx@lfdr.de>; Thu, 24 Oct 2019 12:55:09 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id D5C346E264;
	Thu, 24 Oct 2019 10:55:03 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 72BEB6E265
 for <intel-gfx@lists.freedesktop.org>; Thu, 24 Oct 2019 10:55:00 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18947985-1500050 
 for multiple; Thu, 24 Oct 2019 11:54:51 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Thu, 24 Oct 2019 11:54:45 +0100
Message-Id: <20191024105449.31948-5-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.24.0.rc0
In-Reply-To: <20191024105449.31948-1-chris@chris-wilson.co.uk>
References: <20191024105449.31948-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH i-g-t 5/9] i915/gem_ctx_isolation: Check engine
 relative registers
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

U29tZSBvZiB0aGUgbm9uLXByaXZpbGVnZWQgcmVnaXN0ZXJzIGFyZSBhdCB0aGUgc2FtZSBvZmZz
ZXQgb24gZWFjaAplbmdpbmUuIFdlIGNhbiBpbXByb3ZlIG91ciBjb3ZlcmFnZSBmb3IgdW5rbm93
biBIVyBsYXlvdXQgYnkgdXNpbmcgdGhlCnJlcG9ydGVkIGVuZ2luZS0+bW1pb19iYXNlIGZvciBy
ZWxhdGl2ZSBvZmZzZXRzLgoKU2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJp
cy13aWxzb24uY28udWs+Ci0tLQogdGVzdHMvaTkxNS9nZW1fY3R4X2lzb2xhdGlvbi5jIHwgMTYw
ICsrKysrKysrKysrKysrKysrKysrLS0tLS0tLS0tLS0tLQogMSBmaWxlIGNoYW5nZWQsIDk5IGlu
c2VydGlvbnMoKyksIDYxIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL3Rlc3RzL2k5MTUvZ2Vt
X2N0eF9pc29sYXRpb24uYyBiL3Rlc3RzL2k5MTUvZ2VtX2N0eF9pc29sYXRpb24uYwppbmRleCA2
YWEyNzEzM2MuLjVlODJjMzFjMiAxMDA2NDQKLS0tIGEvdGVzdHMvaTkxNS9nZW1fY3R4X2lzb2xh
dGlvbi5jCisrKyBiL3Rlc3RzL2k5MTUvZ2VtX2N0eF9pc29sYXRpb24uYwpAQCAtNzAsNiArNzAs
NyBAQCBzdGF0aWMgY29uc3Qgc3RydWN0IG5hbWVkX3JlZ2lzdGVyIHsKIAl1aW50MzJfdCBpZ25v
cmVfYml0czsKIAl1aW50MzJfdCB3cml0ZV9tYXNrOyAvKiBzb21lIHJlZ2lzdGVycyBiaXRzIGRv
IG5vdCBleGlzdCAqLwogCWJvb2wgbWFza2VkOworCWJvb2wgcmVsYXRpdmU7CiB9IG5vbnByaXZf
cmVnaXN0ZXJzW10gPSB7CiAJeyAiTk9QSUQiLCBOT0NUWCwgUkNTMCwgMHgyMDk0IH0sCiAJeyAi
TUlfUFJFRElDQVRFX1JFU1VMVF8yIiwgTk9DVFgsIFJDUzAsIDB4MjNiYyB9LApAQCAtMTUwLDY3
ICsxNTEsNDUgQEAgc3RhdGljIGNvbnN0IHN0cnVjdCBuYW1lZF9yZWdpc3RlciB7CiAJeyAiSEFM
Rl9TTElDRV9DSElDS0VONyIsIEdFTl9SQU5HRSgxMSwgMTEpLCBSQ1MwLCAweGUxOTQsIC5tYXNr
ZWQgPSB0cnVlIH0sCiAJeyAiU0FNUExFUl9NT0RFIiwgR0VOX1JBTkdFKDExLCAxMSksIFJDUzAs
IDB4ZTE4YywgLm1hc2tlZCA9IHRydWUgfSwKIAotCXsgIkJDU19HUFIiLCBHRU45LCBCQ1MwLCAw
eDIyNjAwLCAzMiB9LAogCXsgIkJDU19TV0NUUkwiLCBHRU44LCBCQ1MwLCAweDIyMjAwLCAud3Jp
dGVfbWFzayA9IDB4MywgLm1hc2tlZCA9IHRydWUgfSwKIAogCXsgIk1GQ19WREJPWDEiLCBOT0NU
WCwgVkNTMCwgMHgxMjgwMCwgNjQgfSwKIAl7ICJNRkNfVkRCT1gyIiwgTk9DVFgsIFZDUzEsIDB4
MWM4MDAsIDY0IH0sCiAKLQl7ICJWQ1MwX0dQUiIsIEdFTl9SQU5HRSg5LCAxMCksIFZDUzAsIDB4
MTI2MDAsIDMyIH0sCi0JeyAiVkNTMV9HUFIiLCBHRU5fUkFOR0UoOSwgMTApLCBWQ1MxLCAweDFj
NjAwLCAzMiB9LAotCXsgIlZFQ1NfR1BSIiwgR0VOX1JBTkdFKDksIDEwKSwgVkVDUzAsIDB4MWE2
MDAsIDMyIH0sCi0KLQl7ICJWQ1MwX0dQUiIsIEdFTjExLCBWQ1MwLCAweDFjMDYwMCwgMzIgfSwK
LQl7ICJWQ1MxX0dQUiIsIEdFTjExLCBWQ1MxLCAweDFjNDYwMCwgMzIgfSwKLQl7ICJWQ1MyX0dQ
UiIsIEdFTjExLCBWQ1MyLCAweDFkMDYwMCwgMzIgfSwKLQl7ICJWQ1MzX0dQUiIsIEdFTjExLCBW
Q1MzLCAweDFkNDYwMCwgMzIgfSwKLQl7ICJWRUNTX0dQUiIsIEdFTjExLCBWRUNTMCwgMHgxYzg2
MDAsIDMyIH0sCisJeyAieENTX0dQUiIsIEdFTjksIEFMTCwgMHg2MDAsIDMyLCAucmVsYXRpdmUg
PSB0cnVlIH0sCiAKIAl7fQogfSwgaWdub3JlX3JlZ2lzdGVyc1tdID0gewogCXsgIlJDUyB0aW1l
c3RhbXAiLCBHRU42LCB+MHUsIDB4MjM1OCB9LAogCXsgIkJDUyB0aW1lc3RhbXAiLCBHRU43LCB+
MHUsIDB4MjIzNTggfSwKIAotCXsgIlZDUzAgdGltZXN0YW1wIiwgR0VOX1JBTkdFKDcsIDEwKSwg
fjB1LCAweDEyMzU4IH0sCi0JeyAiVkNTMSB0aW1lc3RhbXAiLCBHRU5fUkFOR0UoNywgMTApLCB+
MHUsIDB4MWMzNTggfSwKLQl7ICJWRUNTIHRpbWVzdGFtcCIsIEdFTl9SQU5HRSg4LCAxMCksIH4w
dSwgMHgxYTM1OCB9LAotCi0JeyAiVkNTMCB0aW1lc3RhbXAiLCBHRU4xMSwgfjB1LCAweDFjMDM1
OCB9LAotCXsgIlZDUzEgdGltZXN0YW1wIiwgR0VOMTEsIH4wdSwgMHgxYzQzNTggfSwKLQl7ICJW
Q1MyIHRpbWVzdGFtcCIsIEdFTjExLCB+MHUsIDB4MWQwMzU4IH0sCi0JeyAiVkNTMyB0aW1lc3Rh
bXAiLCBHRU4xMSwgfjB1LCAweDFkNDM1OCB9LAotCXsgIlZFQ1MgdGltZXN0YW1wIiwgR0VOMTEs
IH4wdSwgMHgxYzgzNTggfSwKKwl7ICJ4Q1MgdGltZXN0YW1wIiwgR0VOOCwgQUxMLCAweDM1OCwg
LnJlbGF0aXZlID0gdHJ1ZSB9LAogCiAJLyogaHVjIHJlYWQgb25seSAqLwotCXsgIkJTRDAgMHgy
MDAwIiwgR0VOMTEsIH4wdSwgMHgxYzAwMDAgKyAweDIwMDAgfSwKLQl7ICJCU0QwIDB4MjAwMCIs
IEdFTjExLCB+MHUsIDB4MWMwMDAwICsgMHgyMDE0IH0sCi0JeyAiQlNEMCAweDIwMDAiLCBHRU4x
MSwgfjB1LCAweDFjMDAwMCArIDB4MjNiMCB9LAotCi0JeyAiQlNEMSAweDIwMDAiLCBHRU4xMSwg
fjB1LCAweDFjNDAwMCArIDB4MjAwMCB9LAotCXsgIkJTRDEgMHgyMDAwIiwgR0VOMTEsIH4wdSwg
MHgxYzQwMDAgKyAweDIwMTQgfSwKLQl7ICJCU0QxIDB4MjAwMCIsIEdFTjExLCB+MHUsIDB4MWM0
MDAwICsgMHgyM2IwIH0sCi0KLQl7ICJCU0QyIDB4MjAwMCIsIEdFTjExLCB+MHUsIDB4MWQwMDAw
ICsgMHgyMDAwIH0sCi0JeyAiQlNEMiAweDIwMDAiLCBHRU4xMSwgfjB1LCAweDFkMDAwMCArIDB4
MjAxNCB9LAotCXsgIkJTRDIgMHgyMDAwIiwgR0VOMTEsIH4wdSwgMHgxZDAwMDAgKyAweDIzYjAg
fSwKLQotCXsgIkJTRDMgMHgyMDAwIiwgR0VOMTEsIH4wdSwgMHgxZDQwMDAgKyAweDIwMDAgfSwK
LQl7ICJCU0QzIDB4MjAwMCIsIEdFTjExLCB+MHUsIDB4MWQ0MDAwICsgMHgyMDE0IH0sCi0JeyAi
QlNEMyAweDIwMDAiLCBHRU4xMSwgfjB1LCAweDFkNDAwMCArIDB4MjNiMCB9LAorCXsgIkJTRCAw
eDIwMDAiLCBHRU4xMSwgQUxMLCAweDIwMDAsIC5yZWxhdGl2ZSA9IHRydWUgfSwKKwl7ICJCU0Qg
MHgyMDE0IiwgR0VOMTEsIEFMTCwgMHgyMDE0LCAucmVsYXRpdmUgPSB0cnVlIH0sCisJeyAiQlNE
IDB4MjNiMCIsIEdFTjExLCBBTEwsIDB4MjNiMCwgLnJlbGF0aXZlID0gdHJ1ZSB9LAogCiAJe30K
IH07CiAKLXN0YXRpYyBjb25zdCBjaGFyICpyZWdpc3Rlcl9uYW1lKHVpbnQzMl90IG9mZnNldCwg
Y2hhciAqYnVmLCBzaXplX3QgbGVuKQorc3RhdGljIGNvbnN0IGNoYXIgKgorcmVnaXN0ZXJfbmFt
ZSh1aW50MzJfdCBvZmZzZXQsIHVpbnQzMl90IG1taW9fYmFzZSwgY2hhciAqYnVmLCBzaXplX3Qg
bGVuKQogewogCWZvciAoY29uc3Qgc3RydWN0IG5hbWVkX3JlZ2lzdGVyICpyID0gbm9ucHJpdl9y
ZWdpc3RlcnM7IHItPm5hbWU7IHIrKykgewogCQl1bnNpZ25lZCBpbnQgd2lkdGggPSByLT5jb3Vu
dCA/IDQqci0+Y291bnQgOiA0OwotCQlpZiAob2Zmc2V0ID49IHItPm9mZnNldCAmJiBvZmZzZXQg
PCByLT5vZmZzZXQgKyB3aWR0aCkgeworCQl1aW50MzJfdCBiYXNlOworCisJCWJhc2UgPSByLT5v
ZmZzZXQ7CisJCWlmIChyLT5yZWxhdGl2ZSkKKwkJCWJhc2UgKz0gbW1pb19iYXNlOworCisJCWlm
IChvZmZzZXQgPj0gYmFzZSAmJiBvZmZzZXQgPCBiYXNlICsgd2lkdGgpIHsKIAkJCWlmIChyLT5j
b3VudCA8PSAxKQogCQkJCXJldHVybiByLT5uYW1lOwogCiAJCQlzbnByaW50ZihidWYsIGxlbiwg
IiVzWyVkXSIsCi0JCQkJIHItPm5hbWUsIChvZmZzZXQgLSByLT5vZmZzZXQpLzQpOworCQkJCSBy
LT5uYW1lLCAob2Zmc2V0IC0gYmFzZSkgLyA0KTsKIAkJCXJldHVybiBidWY7CiAJCX0KIAl9CkBA
IC0yMTgsMjIgKzE5NywzNSBAQCBzdGF0aWMgY29uc3QgY2hhciAqcmVnaXN0ZXJfbmFtZSh1aW50
MzJfdCBvZmZzZXQsIGNoYXIgKmJ1Ziwgc2l6ZV90IGxlbikKIAlyZXR1cm4gInVua25vd24iOwog
fQogCi1zdGF0aWMgY29uc3Qgc3RydWN0IG5hbWVkX3JlZ2lzdGVyICpsb29rdXBfcmVnaXN0ZXIo
dWludDMyX3Qgb2Zmc2V0KQorc3RhdGljIGNvbnN0IHN0cnVjdCBuYW1lZF9yZWdpc3RlciAqCits
b29rdXBfcmVnaXN0ZXIodWludDMyX3Qgb2Zmc2V0LCB1aW50MzJfdCBtbWlvX2Jhc2UpCiB7CiAJ
Zm9yIChjb25zdCBzdHJ1Y3QgbmFtZWRfcmVnaXN0ZXIgKnIgPSBub25wcml2X3JlZ2lzdGVyczsg
ci0+bmFtZTsgcisrKSB7CiAJCXVuc2lnbmVkIGludCB3aWR0aCA9IHItPmNvdW50ID8gNCpyLT5j
b3VudCA6IDQ7Ci0JCWlmIChvZmZzZXQgPj0gci0+b2Zmc2V0ICYmIG9mZnNldCA8IHItPm9mZnNl
dCArIHdpZHRoKQorCQl1aW50MzJfdCBiYXNlOworCisJCWJhc2UgPSByLT5vZmZzZXQ7CisJCWlm
IChyLT5yZWxhdGl2ZSkKKwkJCWJhc2UgKz0gbW1pb19iYXNlOworCisJCWlmIChvZmZzZXQgPj0g
YmFzZSAmJiBvZmZzZXQgPCBiYXNlICsgd2lkdGgpCiAJCQlyZXR1cm4gcjsKIAl9CiAKIAlyZXR1
cm4gTlVMTDsKIH0KIAotc3RhdGljIGJvb2wgaWdub3JlX3JlZ2lzdGVyKHVpbnQzMl90IG9mZnNl
dCkKK3N0YXRpYyBib29sIGlnbm9yZV9yZWdpc3Rlcih1aW50MzJfdCBvZmZzZXQsIHVpbnQzMl90
IG1taW9fYmFzZSkKIHsKIAlmb3IgKGNvbnN0IHN0cnVjdCBuYW1lZF9yZWdpc3RlciAqciA9IGln
bm9yZV9yZWdpc3RlcnM7IHItPm5hbWU7IHIrKykgewogCQl1bnNpZ25lZCBpbnQgd2lkdGggPSBy
LT5jb3VudCA/IDQqci0+Y291bnQgOiA0OwotCQlpZiAob2Zmc2V0ID49IHItPm9mZnNldCAmJiBv
ZmZzZXQgPCByLT5vZmZzZXQgKyB3aWR0aCkKKwkJdWludDMyX3QgYmFzZTsKKworCQliYXNlID0g
ci0+b2Zmc2V0OworCQlpZiAoci0+cmVsYXRpdmUpCisJCQliYXNlICs9IG1taW9fYmFzZTsKKwor
CQlpZiAob2Zmc2V0ID49IGJhc2UgJiYgb2Zmc2V0IDwgYmFzZSArIHdpZHRoKQogCQkJcmV0dXJu
IHRydWU7CiAJfQogCkBAIC0yNDgsNiArMjQwLDcgQEAgc3RhdGljIHZvaWQgdG1wbF9yZWdzKGlu
dCBmZCwKIHsKIAljb25zdCB1bnNpZ25lZCBpbnQgZ2VuX2JpdCA9IDEgPDwgaW50ZWxfZ2VuKGlu
dGVsX2dldF9kcm1fZGV2aWQoZmQpKTsKIAljb25zdCB1bnNpZ25lZCBpbnQgZW5naW5lX2JpdCA9
IEVOR0lORShlLT5jbGFzcywgZS0+aW5zdGFuY2UpOworCWNvbnN0IHVpbnQzMl90IG1taW9fYmFz
ZSA9IGdlbV9lbmdpbmVfbW1pb19iYXNlKGZkLCBlLT5uYW1lKTsKIAl1bnNpZ25lZCBpbnQgcmVn
c19zaXplOwogCXVpbnQzMl90ICpyZWdzOwogCkBAIC0yNTksMTIgKzI1MiwyMCBAQCBzdGF0aWMg
dm9pZCB0bXBsX3JlZ3MoaW50IGZkLAogCQkgICAgICAgSTkxNV9HRU1fRE9NQUlOX0NQVSwgSTkx
NV9HRU1fRE9NQUlOX0NQVSk7CiAKIAlmb3IgKGNvbnN0IHN0cnVjdCBuYW1lZF9yZWdpc3RlciAq
ciA9IG5vbnByaXZfcmVnaXN0ZXJzOyByLT5uYW1lOyByKyspIHsKKwkJdWludDMyX3Qgb2Zmc2V0
OworCiAJCWlmICghKHItPmVuZ2luZV9tYXNrICYgZW5naW5lX2JpdCkpCiAJCQljb250aW51ZTsK
IAkJaWYgKCEoci0+Z2VuX21hc2sgJiBnZW5fYml0KSkKIAkJCWNvbnRpbnVlOwotCQlmb3IgKHVu
c2lnbmVkIGNvdW50ID0gci0+Y291bnQgPzogMSwgb2Zmc2V0ID0gci0+b2Zmc2V0OwotCQkgICAg
IGNvdW50LS07IG9mZnNldCArPSA0KSB7CisJCWlmIChyLT5yZWxhdGl2ZSAmJiAhbW1pb19iYXNl
KQorCQkJY29udGludWU7CisKKwkJb2Zmc2V0ID0gci0+b2Zmc2V0OworCQlpZiAoci0+cmVsYXRp
dmUpCisJCQlvZmZzZXQgKz0gbW1pb19iYXNlOworCisJCWZvciAodW5zaWduZWQgY291bnQgPSBy
LT5jb3VudCA/OiAxOyBjb3VudC0tOyBvZmZzZXQgKz0gNCkgewogCQkJdWludDMyX3QgeCA9IHZh
bHVlOwogCQkJaWYgKHItPndyaXRlX21hc2spCiAJCQkJeCAmPSByLT53cml0ZV9tYXNrOwpAQCAt
Mjg0LDYgKzI4NSw3IEBAIHN0YXRpYyB1aW50MzJfdCByZWFkX3JlZ3MoaW50IGZkLAogCWNvbnN0
IHVuc2lnbmVkIGludCBnZW4gPSBpbnRlbF9nZW4oaW50ZWxfZ2V0X2RybV9kZXZpZChmZCkpOwog
CWNvbnN0IHVuc2lnbmVkIGludCBnZW5fYml0ID0gMSA8PCBnZW47CiAJY29uc3QgdW5zaWduZWQg
aW50IGVuZ2luZV9iaXQgPSBFTkdJTkUoZS0+Y2xhc3MsIGUtPmluc3RhbmNlKTsKKwljb25zdCB1
aW50MzJfdCBtbWlvX2Jhc2UgPSBnZW1fZW5naW5lX21taW9fYmFzZShmZCwgZS0+bmFtZSk7CiAJ
Y29uc3QgYm9vbCByNjRiID0gZ2VuID49IDg7CiAJc3RydWN0IGRybV9pOTE1X2dlbV9leGVjX29i
amVjdDIgb2JqWzJdOwogCXN0cnVjdCBkcm1faTkxNV9nZW1fcmVsb2NhdGlvbl9lbnRyeSAqcmVs
b2M7CkBAIC0zMTEsMTMgKzMxMywyMCBAQCBzdGF0aWMgdWludDMyX3QgcmVhZF9yZWdzKGludCBm
ZCwKIAogCW4gPSAwOwogCWZvciAoY29uc3Qgc3RydWN0IG5hbWVkX3JlZ2lzdGVyICpyID0gbm9u
cHJpdl9yZWdpc3RlcnM7IHItPm5hbWU7IHIrKykgeworCQl1aW50MzJfdCBvZmZzZXQ7CisKIAkJ
aWYgKCEoci0+ZW5naW5lX21hc2sgJiBlbmdpbmVfYml0KSkKIAkJCWNvbnRpbnVlOwogCQlpZiAo
IShyLT5nZW5fbWFzayAmIGdlbl9iaXQpKQogCQkJY29udGludWU7CisJCWlmIChyLT5yZWxhdGl2
ZSAmJiAhbW1pb19iYXNlKQorCQkJY29udGludWU7CisKKwkJb2Zmc2V0ID0gci0+b2Zmc2V0Owor
CQlpZiAoci0+cmVsYXRpdmUpCisJCQlvZmZzZXQgKz0gbW1pb19iYXNlOwogCi0JCWZvciAodW5z
aWduZWQgY291bnQgPSByLT5jb3VudCA/OiAxLCBvZmZzZXQgPSByLT5vZmZzZXQ7Ci0JCSAgICAg
Y291bnQtLTsgb2Zmc2V0ICs9IDQpIHsKKwkJZm9yICh1bnNpZ25lZCBjb3VudCA9IHItPmNvdW50
ID86IDE7IGNvdW50LS07IG9mZnNldCArPSA0KSB7CiAJCQkqYisrID0gMHgyNCA8PCAyMyB8ICgx
ICsgcjY0Yik7IC8qIFNSTSAqLwogCQkJKmIrKyA9IG9mZnNldDsKIAkJCXJlbG9jW25dLnRhcmdl
dF9oYW5kbGUgPSBvYmpbMF0uaGFuZGxlOwpAQCAtMzU3LDYgKzM2Niw3IEBAIHN0YXRpYyB2b2lk
IHdyaXRlX3JlZ3MoaW50IGZkLAogewogCWNvbnN0IHVuc2lnbmVkIGludCBnZW5fYml0ID0gMSA8
PCBpbnRlbF9nZW4oaW50ZWxfZ2V0X2RybV9kZXZpZChmZCkpOwogCWNvbnN0IHVuc2lnbmVkIGlu
dCBlbmdpbmVfYml0ID0gRU5HSU5FKGUtPmNsYXNzLCBlLT5pbnN0YW5jZSk7CisJY29uc3QgdWlu
dDMyX3QgbW1pb19iYXNlID0gZ2VtX2VuZ2luZV9tbWlvX2Jhc2UoZmQsIGUtPm5hbWUpOwogCXN0
cnVjdCBkcm1faTkxNV9nZW1fZXhlY19vYmplY3QyIG9iajsKIAlzdHJ1Y3QgZHJtX2k5MTVfZ2Vt
X2V4ZWNidWZmZXIyIGV4ZWNidWY7CiAJdW5zaWduZWQgaW50IGJhdGNoX3NpemU7CkBAIC0zNzIs
MTIgKzM4MiwyMCBAQCBzdGF0aWMgdm9pZCB3cml0ZV9yZWdzKGludCBmZCwKIAlnZW1fc2V0X2Rv
bWFpbihmZCwgb2JqLmhhbmRsZSwKIAkJICAgICAgIEk5MTVfR0VNX0RPTUFJTl9DUFUsIEk5MTVf
R0VNX0RPTUFJTl9DUFUpOwogCWZvciAoY29uc3Qgc3RydWN0IG5hbWVkX3JlZ2lzdGVyICpyID0g
bm9ucHJpdl9yZWdpc3RlcnM7IHItPm5hbWU7IHIrKykgeworCQl1aW50MzJfdCBvZmZzZXQ7CisK
IAkJaWYgKCEoci0+ZW5naW5lX21hc2sgJiBlbmdpbmVfYml0KSkKIAkJCWNvbnRpbnVlOwogCQlp
ZiAoIShyLT5nZW5fbWFzayAmIGdlbl9iaXQpKQogCQkJY29udGludWU7Ci0JCWZvciAodW5zaWdu
ZWQgY291bnQgPSByLT5jb3VudCA/OiAxLCBvZmZzZXQgPSByLT5vZmZzZXQ7Ci0JCSAgICAgY291
bnQtLTsgb2Zmc2V0ICs9IDQpIHsKKwkJaWYgKHItPnJlbGF0aXZlICYmICFtbWlvX2Jhc2UpCisJ
CQljb250aW51ZTsKKworCQlvZmZzZXQgPSByLT5vZmZzZXQ7CisJCWlmIChyLT5yZWxhdGl2ZSkK
KwkJCW9mZnNldCArPSBtbWlvX2Jhc2U7CisKKwkJZm9yICh1bnNpZ25lZCBjb3VudCA9IHItPmNv
dW50ID86IDE7IGNvdW50LS07IG9mZnNldCArPSA0KSB7CiAJCQl1aW50MzJfdCB4ID0gdmFsdWU7
CiAJCQlpZiAoci0+d3JpdGVfbWFzaykKIAkJCQl4ICY9IHItPndyaXRlX21hc2s7CkBAIC00MTAs
NiArNDI4LDcgQEAgc3RhdGljIHZvaWQgcmVzdG9yZV9yZWdzKGludCBmZCwKIAljb25zdCB1bnNp
Z25lZCBpbnQgZ2VuID0gaW50ZWxfZ2VuKGludGVsX2dldF9kcm1fZGV2aWQoZmQpKTsKIAljb25z
dCB1bnNpZ25lZCBpbnQgZ2VuX2JpdCA9IDEgPDwgZ2VuOwogCWNvbnN0IHVuc2lnbmVkIGludCBl
bmdpbmVfYml0ID0gRU5HSU5FKGUtPmNsYXNzLCBlLT5pbnN0YW5jZSk7CisJY29uc3QgdWludDMy
X3QgbW1pb19iYXNlID0gZ2VtX2VuZ2luZV9tbWlvX2Jhc2UoZmQsIGUtPm5hbWUpOwogCWNvbnN0
IGJvb2wgcjY0YiA9IGdlbiA+PSA4OwogCXN0cnVjdCBkcm1faTkxNV9nZW1fZXhlY19vYmplY3Qy
IG9ialsyXTsKIAlzdHJ1Y3QgZHJtX2k5MTVfZ2VtX2V4ZWNidWZmZXIyIGV4ZWNidWY7CkBAIC00
MzcsMTMgKzQ1NiwyMCBAQCBzdGF0aWMgdm9pZCByZXN0b3JlX3JlZ3MoaW50IGZkLAogCiAJbiA9
IDA7CiAJZm9yIChjb25zdCBzdHJ1Y3QgbmFtZWRfcmVnaXN0ZXIgKnIgPSBub25wcml2X3JlZ2lz
dGVyczsgci0+bmFtZTsgcisrKSB7CisJCXVpbnQzMl90IG9mZnNldDsKKwogCQlpZiAoIShyLT5l
bmdpbmVfbWFzayAmIGVuZ2luZV9iaXQpKQogCQkJY29udGludWU7CiAJCWlmICghKHItPmdlbl9t
YXNrICYgZ2VuX2JpdCkpCiAJCQljb250aW51ZTsKKwkJaWYgKHItPnJlbGF0aXZlICYmICFtbWlv
X2Jhc2UpCisJCQljb250aW51ZTsKKworCQlvZmZzZXQgPSByLT5vZmZzZXQ7CisJCWlmIChyLT5y
ZWxhdGl2ZSkKKwkJCW9mZnNldCArPSBtbWlvX2Jhc2U7CiAKLQkJZm9yICh1bnNpZ25lZCBjb3Vu
dCA9IHItPmNvdW50ID86IDEsIG9mZnNldCA9IHItPm9mZnNldDsKLQkJICAgICBjb3VudC0tOyBv
ZmZzZXQgKz0gNCkgeworCQlmb3IgKHVuc2lnbmVkIGNvdW50ID0gci0+Y291bnQgPzogMTsgY291
bnQtLTsgb2Zmc2V0ICs9IDQpIHsKIAkJCSpiKysgPSAweDI5IDw8IDIzIHwgKDEgKyByNjRiKTsg
LyogTFJNICovCiAJCQkqYisrID0gb2Zmc2V0OwogCQkJcmVsb2Nbbl0udGFyZ2V0X2hhbmRsZSA9
IG9ialswXS5oYW5kbGU7CkBAIC00NzksNiArNTA1LDcgQEAgc3RhdGljIHZvaWQgZHVtcF9yZWdz
KGludCBmZCwKIAljb25zdCBpbnQgZ2VuID0gaW50ZWxfZ2VuKGludGVsX2dldF9kcm1fZGV2aWQo
ZmQpKTsKIAljb25zdCB1bnNpZ25lZCBpbnQgZ2VuX2JpdCA9IDEgPDwgZ2VuOwogCWNvbnN0IHVu
c2lnbmVkIGludCBlbmdpbmVfYml0ID0gRU5HSU5FKGUtPmNsYXNzLCBlLT5pbnN0YW5jZSk7CisJ
Y29uc3QgdWludDMyX3QgbW1pb19iYXNlID0gZ2VtX2VuZ2luZV9tbWlvX2Jhc2UoZmQsIGUtPm5h
bWUpOwogCXVuc2lnbmVkIGludCByZWdzX3NpemU7CiAJdWludDMyX3QgKm91dDsKIApAQCAtNDg5
LDI2ICs1MTYsMzYgQEAgc3RhdGljIHZvaWQgZHVtcF9yZWdzKGludCBmZCwKIAlnZW1fc2V0X2Rv
bWFpbihmZCwgcmVncywgSTkxNV9HRU1fRE9NQUlOX0NQVSwgMCk7CiAKIAlmb3IgKGNvbnN0IHN0
cnVjdCBuYW1lZF9yZWdpc3RlciAqciA9IG5vbnByaXZfcmVnaXN0ZXJzOyByLT5uYW1lOyByKysp
IHsKKwkJdWludDMyX3Qgb2Zmc2V0OworCiAJCWlmICghKHItPmVuZ2luZV9tYXNrICYgZW5naW5l
X2JpdCkpCiAJCQljb250aW51ZTsKIAkJaWYgKCEoci0+Z2VuX21hc2sgJiBnZW5fYml0KSkKIAkJ
CWNvbnRpbnVlOworCQlpZiAoci0+cmVsYXRpdmUgJiYgIW1taW9fYmFzZSkKKwkJCWNvbnRpbnVl
OworCisJCW9mZnNldCA9IHItPm9mZnNldDsKKwkJaWYgKHItPnJlbGF0aXZlKQorCQkJb2Zmc2V0
ICs9IG1taW9fYmFzZTsKIAogCQlpZiAoci0+Y291bnQgPD0gMSkgewogCQkJaWd0X2RlYnVnKCIw
eCUwNHggKCVzKTogMHglMDh4XG4iLAotCQkJCSAgci0+b2Zmc2V0LCByLT5uYW1lLCBvdXRbci0+
b2Zmc2V0LzRdKTsKKwkJCQkgIG9mZnNldCwgci0+bmFtZSwgb3V0W29mZnNldCAvIDRdKTsKIAkJ
fSBlbHNlIHsKIAkJCWZvciAodW5zaWduZWQgeCA9IDA7IHggPCByLT5jb3VudDsgeCsrKQogCQkJ
CWlndF9kZWJ1ZygiMHglMDR4ICglc1slZF0pOiAweCUwOHhcbiIsCi0JCQkJCSAgci0+b2Zmc2V0
KzQqeCwgci0+bmFtZSwgeCwKLQkJCQkJICBvdXRbci0+b2Zmc2V0LzQgKyB4XSk7CisJCQkJCSAg
b2Zmc2V0ICsgNCAqIHgsIHItPm5hbWUsIHgsCisJCQkJCSAgb3V0W29mZnNldCAvIDQgKyB4XSk7
CiAJCX0KIAl9CiAJbXVubWFwKG91dCwgcmVnc19zaXplKTsKIH0KIAotc3RhdGljIHZvaWQgY29t
cGFyZV9yZWdzKGludCBmZCwgdWludDMyX3QgQSwgdWludDMyX3QgQiwgY29uc3QgY2hhciAqd2hv
KQorc3RhdGljIHZvaWQgY29tcGFyZV9yZWdzKGludCBmZCwgY29uc3Qgc3RydWN0IGludGVsX2V4
ZWN1dGlvbl9lbmdpbmUyICplLAorCQkJIHVpbnQzMl90IEEsIHVpbnQzMl90IEIsIGNvbnN0IGNo
YXIgKndobykKIHsKKwljb25zdCB1aW50MzJfdCBtbWlvX2Jhc2UgPSBnZW1fZW5naW5lX21taW9f
YmFzZShmZCwgZS0+bmFtZSk7CiAJdW5zaWduZWQgaW50IG51bV9lcnJvcnM7CiAJdW5zaWduZWQg
aW50IHJlZ3Nfc2l6ZTsKIAl1aW50MzJfdCAqYSwgKmI7CkBAIC01MzIsMTEgKzU2OSwxMSBAQCBz
dGF0aWMgdm9pZCBjb21wYXJlX3JlZ3MoaW50IGZkLCB1aW50MzJfdCBBLCB1aW50MzJfdCBCLCBj
b25zdCBjaGFyICp3aG8pCiAJCWlmIChhW25dID09IGJbbl0pCiAJCQljb250aW51ZTsKIAotCQlp
ZiAoaWdub3JlX3JlZ2lzdGVyKG9mZnNldCkpCisJCWlmIChpZ25vcmVfcmVnaXN0ZXIob2Zmc2V0
LCBtbWlvX2Jhc2UpKQogCQkJY29udGludWU7CiAKIAkJbWFzayA9IH4wdTsKLQkJciA9IGxvb2t1
cF9yZWdpc3RlcihvZmZzZXQpOworCQlyID0gbG9va3VwX3JlZ2lzdGVyKG9mZnNldCwgbW1pb19i
YXNlKTsKIAkJaWYgKHIgJiYgci0+bWFza2VkKQogCQkJbWFzayA+Pj0gMTY7CiAJCWlmIChyICYm
IHItPmlnbm9yZV9iaXRzKQpAQCAtNTQ3LDcgKzU4NCw3IEBAIHN0YXRpYyB2b2lkIGNvbXBhcmVf
cmVncyhpbnQgZmQsIHVpbnQzMl90IEEsIHVpbnQzMl90IEIsIGNvbnN0IGNoYXIgKndobykKIAog
CQlpZ3Rfd2FybigiUmVnaXN0ZXIgMHglMDR4ICglcyk6IEE9JTA4eCBCPSUwOHhcbiIsCiAJCQkg
b2Zmc2V0LAotCQkJIHJlZ2lzdGVyX25hbWUob2Zmc2V0LCBidWYsIHNpemVvZihidWYpKSwKKwkJ
CSByZWdpc3Rlcl9uYW1lKG9mZnNldCwgbW1pb19iYXNlLCBidWYsIHNpemVvZihidWYpKSwKIAkJ
CSBhW25dICYgbWFzaywgYltuXSAmIG1hc2spOwogCQludW1fZXJyb3JzKys7CiAJfQpAQCAtNjM4
LDcgKzY3NSw3IEBAIHN0YXRpYyB2b2lkIG5vbnByaXYoaW50IGZkLAogCiAJCWlndF9zcGluX2Zy
ZWUoZmQsIHNwaW4pOwogCi0JCWNvbXBhcmVfcmVncyhmZCwgdG1wbCwgcmVnc1sxXSwgIm5vbnBy
aXYgcmVhZC93cml0ZXMiKTsKKwkJY29tcGFyZV9yZWdzKGZkLCBlLCB0bXBsLCByZWdzWzFdLCAi
bm9ucHJpdiByZWFkL3dyaXRlcyIpOwogCiAJCWZvciAoaW50IG4gPSAwOyBuIDwgQVJSQVlfU0la
RShyZWdzKTsgbisrKQogCQkJZ2VtX2Nsb3NlKGZkLCByZWdzW25dKTsKQEAgLTcwOCw4ICs3NDUs
OSBAQCBzdGF0aWMgdm9pZCBpc29sYXRpb24oaW50IGZkLAogCQlpZ3Rfc3Bpbl9mcmVlKGZkLCBz
cGluKTsKIAogCQlpZiAoIShmbGFncyAmIERJUlRZMSkpCi0JCQljb21wYXJlX3JlZ3MoZmQsIHJl
Z3NbMF0sIHRtcCwgInR3byByZWFkcyBvZiB0aGUgc2FtZSBjdHgiKTsKLQkJY29tcGFyZV9yZWdz
KGZkLCByZWdzWzBdLCByZWdzWzFdLCAidHdvIHZpcmdpbiBjb250ZXh0cyIpOworCQkJY29tcGFy
ZV9yZWdzKGZkLCBlLCByZWdzWzBdLCB0bXAsCisJCQkJICAgICAidHdvIHJlYWRzIG9mIHRoZSBz
YW1lIGN0eCIpOworCQljb21wYXJlX3JlZ3MoZmQsIGUsIHJlZ3NbMF0sIHJlZ3NbMV0sICJ0d28g
dmlyZ2luIGNvbnRleHRzIik7CiAKIAkJZm9yIChpbnQgbiA9IDA7IG4gPCBBUlJBWV9TSVpFKGN0
eCk7IG4rKykgewogCQkJZ2VtX2Nsb3NlKGZkLCByZWdzW25dKTsKQEAgLTgyOSwxMyArODY3LDEz
IEBAIHN0YXRpYyB2b2lkIHByZXNlcnZhdGlvbihpbnQgZmQsCiAJCWNoYXIgYnVmWzgwXTsKIAog
CQlzbnByaW50ZihidWYsIHNpemVvZihidWYpLCAiZGlydHkgJXggY29udGV4dFxuIiwgdmFsdWVz
W3ZdKTsKLQkJY29tcGFyZV9yZWdzKGZkLCByZWdzW3ZdWzBdLCByZWdzW3ZdWzFdLCBidWYpOwor
CQljb21wYXJlX3JlZ3MoZmQsIGUsIHJlZ3Nbdl1bMF0sIHJlZ3Nbdl1bMV0sIGJ1Zik7CiAKIAkJ
Z2VtX2Nsb3NlKGZkLCByZWdzW3ZdWzBdKTsKIAkJZ2VtX2Nsb3NlKGZkLCByZWdzW3ZdWzFdKTsK
IAkJZ2VtX2NvbnRleHRfZGVzdHJveShmZCwgY3R4W3ZdKTsKIAl9Ci0JY29tcGFyZV9yZWdzKGZk
LCByZWdzW251bV92YWx1ZXNdWzBdLCByZWdzW251bV92YWx1ZXNdWzFdLCAiY2xlYW4iKTsKKwlj
b21wYXJlX3JlZ3MoZmQsIGUsIHJlZ3NbbnVtX3ZhbHVlc11bMF0sIHJlZ3NbbnVtX3ZhbHVlc11b
MV0sICJjbGVhbiIpOwogCWdlbV9jb250ZXh0X2Rlc3Ryb3koZmQsIGN0eFtudW1fdmFsdWVzXSk7
CiB9CiAKLS0gCjIuMjQuMC5yYzAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVk
ZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZv
L2ludGVsLWdmeA==

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id F166CB075E
	for <lists+intel-gfx@lfdr.de>; Thu, 12 Sep 2019 06:12:42 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 7413F6E05D;
	Thu, 12 Sep 2019 04:12:21 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 040466E31D
 for <intel-gfx@lists.freedesktop.org>; Wed, 11 Sep 2019 16:38:27 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18454399-1500050 
 for multiple; Wed, 11 Sep 2019 17:38:15 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Wed, 11 Sep 2019 17:38:15 +0100
Message-Id: <20190911163815.11430-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH] drm/i915/pmu: Use GT parked for estimating RC6
 while asleep
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

QXMgd2UgdHJhY2sgd2hlbiB3ZSBwdXQgdGhlIEdUIGRldmljZSB0byBzbGVlcCB1cG9uIGlkbGlu
Zywgd2UgY2FuIHVzZQp0aGF0IGNhbGxiYWNrIHRvIHNhbXBsZSB0aGUgY3VycmVudCByYzYgY291
bnRlcnMgYW5kIHJlY29yZCB0aGUKdGltZXN0YW1wIGZvciBlc3RpbWF0aW5nIHNhbXBsZXMgYWZ0
ZXIgdGhhdCBwb2ludCB3aGlsZSBhc2xlZXAuCgp2MjogU3RpY2sgdG8gdXNpbmcga3RpbWVfdAp2
MzogVHJhY2sgdXNlcl93YWtlcmVmcyB0aGF0IGludGVyZmVyZSB3aXRoIHRoZSBuZXcKaW50ZWxf
Z3RfcG1fd2FpdF9mb3JfaWRsZQoKQnVnemlsbGE6IGh0dHBzOi8vYnVncy5mcmVlZGVza3RvcC5v
cmcvc2hvd19idWcuY2dpP2lkPTEwNTAxMApTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNo
cmlzQGNocmlzLXdpbHNvbi5jby51az4KQ2M6IFR2cnRrbyBVcnN1bGluIDx0dnJ0a28udXJzdWxp
bkBpbnRlbC5jb20+Ci0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3BtLmMg
ICB8ICAxOSArKysrCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9ndF90eXBlcy5oIHwg
ICAxICsKIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZGVidWdmcy5jICAgICAgfCAgMjIgKyst
LS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcG11LmMgICAgICAgICAgfCAxMjAgKysrKysr
KysrKystLS0tLS0tLS0tLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcG11LmggICAgICAg
ICAgfCAgIDQgKy0KIDUgZmlsZXMgY2hhbmdlZCwgOTAgaW5zZXJ0aW9ucygrKSwgNzYgZGVsZXRp
b25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3Bt
LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fcG0uYwppbmRleCAzYmQ3NjQx
MDRkNDEuLjQ1YTcyY2I2OThkYiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2Vt
L2k5MTVfZ2VtX3BtLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3Bt
LmMKQEAgLTE0MSw2ICsxNDEsMjEgQEAgYm9vbCBpOTE1X2dlbV9sb2FkX3Bvd2VyX2NvbnRleHQo
c3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCiAJcmV0dXJuIHN3aXRjaF90b19rZXJuZWxf
Y29udGV4dF9zeW5jKCZpOTE1LT5ndCk7CiB9CiAKK3N0YXRpYyB2b2lkIHVzZXJfZm9yY2V3YWtl
KHN0cnVjdCBpbnRlbF9ndCAqZ3QsIGJvb2wgc3VzcGVuZCkKK3sKKwlpbnQgY291bnQgPSBhdG9t
aWNfcmVhZCgmZ3QtPnVzZXJfd2FrZXJlZik7CisKKwlpZiAobGlrZWx5KCFjb3VudCkpCisJCXJl
dHVybjsKKworCWludGVsX2d0X3BtX2dldChndCk7CisJaWYgKHN1c3BlbmQpCisJCWF0b21pY19z
dWIoY291bnQsICZndC0+d2FrZXJlZi5jb3VudCk7CisJZWxzZQorCQlhdG9taWNfYWRkKGNvdW50
LCAmZ3QtPndha2VyZWYuY291bnQpOworCWludGVsX2d0X3BtX3B1dChndCk7Cit9CisKIHZvaWQg
aTkxNV9nZW1fc3VzcGVuZChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKIHsKIAlHRU1f
VFJBQ0UoIlxuIik7CkBAIC0xNDgsNiArMTYzLDggQEAgdm9pZCBpOTE1X2dlbV9zdXNwZW5kKHN0
cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KQogCWludGVsX3dha2VyZWZfYXV0bygmaTkxNS0+
Z2d0dC51c2VyZmF1bHRfd2FrZXJlZiwgMCk7CiAJZmx1c2hfd29ya3F1ZXVlKGk5MTUtPndxKTsK
IAorCXVzZXJfZm9yY2V3YWtlKCZpOTE1LT5ndCwgdHJ1ZSk7CisKIAltdXRleF9sb2NrKCZpOTE1
LT5kcm0uc3RydWN0X211dGV4KTsKIAogCS8qCkBAIC0yNTksNiArMjc2LDggQEAgdm9pZCBpOTE1
X2dlbV9yZXN1bWUoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCiAJaWYgKCFpOTE1X2dl
bV9sb2FkX3Bvd2VyX2NvbnRleHQoaTkxNSkpCiAJCWdvdG8gZXJyX3dlZGdlZDsKIAorCXVzZXJf
Zm9yY2V3YWtlKCZpOTE1LT5ndCwgZmFsc2UpOworCiBvdXRfdW5sb2NrOgogCWludGVsX3VuY29y
ZV9mb3JjZXdha2VfcHV0KCZpOTE1LT51bmNvcmUsIEZPUkNFV0FLRV9BTEwpOwogCW11dGV4X3Vu
bG9jaygmaTkxNS0+ZHJtLnN0cnVjdF9tdXRleCk7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9ndC9pbnRlbF9ndF90eXBlcy5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50
ZWxfZ3RfdHlwZXMuaAppbmRleCBkYzI5NWMxOTZkMTEuLjMwMzljZWY2NGIxMSAxMDA2NDQKLS0t
IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZ3RfdHlwZXMuaAorKysgYi9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9ndF90eXBlcy5oCkBAIC01MCw2ICs1MCw3IEBAIHN0cnVj
dCBpbnRlbF9ndCB7CiAJfSB0aW1lbGluZXM7CiAKIAlzdHJ1Y3QgaW50ZWxfd2FrZXJlZiB3YWtl
cmVmOworCWF0b21pY190IHVzZXJfd2FrZXJlZjsKIAogCXN0cnVjdCBsaXN0X2hlYWQgY2xvc2Vk
X3ZtYTsKIAlzcGlubG9ja190IGNsb3NlZF9sb2NrOyAvKiBndWFyZHMgdGhlIGxpc3Qgb2YgY2xv
c2VkX3ZtYSAqLwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kZWJ1Z2Zz
LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2RlYnVnZnMuYwppbmRleCA3MDg4NTVlMDUx
YjUuLmYwMGMwZGM0ZjU3ZSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9k
ZWJ1Z2ZzLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kZWJ1Z2ZzLmMKQEAgLTM5
ODgsMTMgKzM5ODgsMTIgQEAgc3RhdGljIGludCBpOTE1X3NzZXVfc3RhdHVzKHN0cnVjdCBzZXFf
ZmlsZSAqbSwgdm9pZCAqdW51c2VkKQogc3RhdGljIGludCBpOTE1X2ZvcmNld2FrZV9vcGVuKHN0
cnVjdCBpbm9kZSAqaW5vZGUsIHN0cnVjdCBmaWxlICpmaWxlKQogewogCXN0cnVjdCBkcm1faTkx
NV9wcml2YXRlICppOTE1ID0gaW5vZGUtPmlfcHJpdmF0ZTsKKwlzdHJ1Y3QgaW50ZWxfZ3QgKmd0
ID0gJmk5MTUtPmd0OwogCi0JaWYgKElOVEVMX0dFTihpOTE1KSA8IDYpCi0JCXJldHVybiAwOwot
Ci0JZmlsZS0+cHJpdmF0ZV9kYXRhID0KLQkJKHZvaWQgKikodWludHB0cl90KWludGVsX3J1bnRp
bWVfcG1fZ2V0KCZpOTE1LT5ydW50aW1lX3BtKTsKLQlpbnRlbF91bmNvcmVfZm9yY2V3YWtlX3Vz
ZXJfZ2V0KCZpOTE1LT51bmNvcmUpOworCWF0b21pY19pbmMoJmd0LT51c2VyX3dha2VyZWYpOwor
CWludGVsX2d0X3BtX2dldChndCk7CisJaWYgKElOVEVMX0dFTihpOTE1KSA+PSA2KQorCQlpbnRl
bF91bmNvcmVfZm9yY2V3YWtlX3VzZXJfZ2V0KGd0LT51bmNvcmUpOwogCiAJcmV0dXJuIDA7CiB9
CkBAIC00MDAyLDEzICs0MDAxLDEyIEBAIHN0YXRpYyBpbnQgaTkxNV9mb3JjZXdha2Vfb3Blbihz
dHJ1Y3QgaW5vZGUgKmlub2RlLCBzdHJ1Y3QgZmlsZSAqZmlsZSkKIHN0YXRpYyBpbnQgaTkxNV9m
b3JjZXdha2VfcmVsZWFzZShzdHJ1Y3QgaW5vZGUgKmlub2RlLCBzdHJ1Y3QgZmlsZSAqZmlsZSkK
IHsKIAlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSA9IGlub2RlLT5pX3ByaXZhdGU7CisJ
c3RydWN0IGludGVsX2d0ICpndCA9ICZpOTE1LT5ndDsKIAotCWlmIChJTlRFTF9HRU4oaTkxNSkg
PCA2KQotCQlyZXR1cm4gMDsKLQotCWludGVsX3VuY29yZV9mb3JjZXdha2VfdXNlcl9wdXQoJmk5
MTUtPnVuY29yZSk7Ci0JaW50ZWxfcnVudGltZV9wbV9wdXQoJmk5MTUtPnJ1bnRpbWVfcG0sCi0J
CQkgICAgIChpbnRlbF93YWtlcmVmX3QpKHVpbnRwdHJfdClmaWxlLT5wcml2YXRlX2RhdGEpOwor
CWlmIChJTlRFTF9HRU4oaTkxNSkgPj0gNikKKwkJaW50ZWxfdW5jb3JlX2ZvcmNld2FrZV91c2Vy
X3B1dCgmaTkxNS0+dW5jb3JlKTsKKwlpbnRlbF9ndF9wbV9wdXQoZ3QpOworCWF0b21pY19kZWMo
Jmd0LT51c2VyX3dha2VyZWYpOwogCiAJcmV0dXJuIDA7CiB9CmRpZmYgLS1naXQgYS9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9pOTE1X3BtdS5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wbXUu
YwppbmRleCA4ZTI1MWU3MTkzOTAuLmEzZDNkM2UzOWMxNSAxMDA2NDQKLS0tIGEvZHJpdmVycy9n
cHUvZHJtL2k5MTUvaTkxNV9wbXUuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3Bt
dS5jCkBAIC0xMTYsMTkgKzExNiw1MSBAQCBzdGF0aWMgYm9vbCBwbXVfbmVlZHNfdGltZXIoc3Ry
dWN0IGk5MTVfcG11ICpwbXUsIGJvb2wgZ3B1X2FjdGl2ZSkKIAlyZXR1cm4gZW5hYmxlOwogfQog
CitzdGF0aWMgdTY0IF9fZ2V0X3JjNihzdHJ1Y3QgaW50ZWxfZ3QgKmd0KQoreworCXN0cnVjdCBk
cm1faTkxNV9wcml2YXRlICppOTE1ID0gZ3QtPmk5MTU7CisJdTY0IHZhbDsKKworCXZhbCA9IGlu
dGVsX3JjNl9yZXNpZGVuY3lfbnMoaTkxNSwKKwkJCQkgICAgIElTX1ZBTExFWVZJRVcoaTkxNSkg
PworCQkJCSAgICAgVkxWX0dUX1JFTkRFUl9SQzYgOgorCQkJCSAgICAgR0VONl9HVF9HRlhfUkM2
KTsKKworCWlmIChIQVNfUkM2cChpOTE1KSkKKwkJdmFsICs9IGludGVsX3JjNl9yZXNpZGVuY3lf
bnMoaTkxNSwgR0VONl9HVF9HRlhfUkM2cCk7CisKKwlpZiAoSEFTX1JDNnBwKGk5MTUpKQorCQl2
YWwgKz0gaW50ZWxfcmM2X3Jlc2lkZW5jeV9ucyhpOTE1LCBHRU42X0dUX0dGWF9SQzZwcCk7CisK
KwlyZXR1cm4gdmFsOworfQorCiB2b2lkIGk5MTVfcG11X2d0X3BhcmtlZChzdHJ1Y3QgZHJtX2k5
MTVfcHJpdmF0ZSAqaTkxNSkKIHsKIAlzdHJ1Y3QgaTkxNV9wbXUgKnBtdSA9ICZpOTE1LT5wbXU7
CisJdTY0IHZhbDsKIAogCWlmICghcG11LT5iYXNlLmV2ZW50X2luaXQpCiAJCXJldHVybjsKIAog
CXNwaW5fbG9ja19pcnEoJnBtdS0+bG9jayk7CisKKwl2YWwgPSAwOworCWlmIChwbXUtPnNhbXBs
ZVtfX0k5MTVfU0FNUExFX1JDNl0uY3VyKQorCQl2YWwgPSBfX2dldF9yYzYoJmk5MTUtPmd0KTsK
KworCWlmICh2YWwgPj0gcG11LT5zYW1wbGVbX19JOTE1X1NBTVBMRV9SQzZfRVNUSU1BVEVEXS5j
dXIpIHsKKwkJcG11LT5zYW1wbGVbX19JOTE1X1NBTVBMRV9SQzZfRVNUSU1BVEVEXS5jdXIgPSAw
OworCQlwbXUtPnNhbXBsZVtfX0k5MTVfU0FNUExFX1JDNl0uY3VyID0gdmFsOworCX0KKwlwbXUt
PnNsZWVwX2xhc3QgPSBrdGltZV9nZXQoKTsKKwogCS8qCiAJICogU2lnbmFsIHNhbXBsaW5nIHRp
bWVyIHRvIHN0b3AgaWYgb25seSBlbmdpbmUgZXZlbnRzIGFyZSBlbmFibGVkIGFuZAogCSAqIEdQ
VSB3ZW50IGlkbGUuCiAJICovCiAJcG11LT50aW1lcl9lbmFibGVkID0gcG11X25lZWRzX3RpbWVy
KHBtdSwgZmFsc2UpOworCiAJc3Bpbl91bmxvY2tfaXJxKCZwbXUtPmxvY2spOwogfQogCkBAIC0x
NDMsNiArMTc1LDExIEBAIHN0YXRpYyB2b2lkIF9faTkxNV9wbXVfbWF5YmVfc3RhcnRfdGltZXIo
c3RydWN0IGk5MTVfcG11ICpwbXUpCiAJfQogfQogCitzdGF0aWMgaW5saW5lIHM2NCBrdGltZV9z
aW5jZShjb25zdCBrdGltZV90IGt0KQoreworCXJldHVybiBrdGltZV90b19ucyhrdGltZV9zdWIo
a3RpbWVfZ2V0KCksIGt0KSk7Cit9CisKIHZvaWQgaTkxNV9wbXVfZ3RfdW5wYXJrZWQoc3RydWN0
IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCiB7CiAJc3RydWN0IGk5MTVfcG11ICpwbXUgPSAmaTkx
NS0+cG11OwpAQCAtMTUxLDEwICsxODgsMjIgQEAgdm9pZCBpOTE1X3BtdV9ndF91bnBhcmtlZChz
dHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKIAkJcmV0dXJuOwogCiAJc3Bpbl9sb2NrX2ly
cSgmcG11LT5sb2NrKTsKKwogCS8qCiAJICogUmUtZW5hYmxlIHNhbXBsaW5nIHRpbWVyIHdoZW4g
R1BVIGdvZXMgYWN0aXZlLgogCSAqLwogCV9faTkxNV9wbXVfbWF5YmVfc3RhcnRfdGltZXIocG11
KTsKKworCS8qIEVzdGltYXRlIGhvdyBsb25nIHdlIHNsZXB0IGFuZCBhY2N1bXVsYXRlIHRoYXQg
aW50byByYzYgY291bnRlcnMgKi8KKwlpZiAocG11LT5zYW1wbGVbX19JOTE1X1NBTVBMRV9SQzZd
LmN1cikgeworCQl1NjQgdmFsOworCisJCXZhbCA9IGt0aW1lX3NpbmNlKHBtdS0+c2xlZXBfbGFz
dCk7CisJCXZhbCArPSBwbXUtPnNhbXBsZVtfX0k5MTVfU0FNUExFX1JDNl0uY3VyOworCisJCXBt
dS0+c2FtcGxlW19fSTkxNV9TQU1QTEVfUkM2X0VTVElNQVRFRF0uY3VyID0gdmFsOworCX0KKwog
CXNwaW5fdW5sb2NrX2lycSgmcG11LT5sb2NrKTsKIH0KIApAQCAtNDI2LDM5ICs0NzUsMTggQEAg
c3RhdGljIGludCBpOTE1X3BtdV9ldmVudF9pbml0KHN0cnVjdCBwZXJmX2V2ZW50ICpldmVudCkK
IAlyZXR1cm4gMDsKIH0KIAotc3RhdGljIHU2NCBfX2dldF9yYzYoc3RydWN0IGludGVsX2d0ICpn
dCkKLXsKLQlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSA9IGd0LT5pOTE1OwotCXU2NCB2
YWw7Ci0KLQl2YWwgPSBpbnRlbF9yYzZfcmVzaWRlbmN5X25zKGk5MTUsCi0JCQkJICAgICBJU19W
QUxMRVlWSUVXKGk5MTUpID8KLQkJCQkgICAgIFZMVl9HVF9SRU5ERVJfUkM2IDoKLQkJCQkgICAg
IEdFTjZfR1RfR0ZYX1JDNik7Ci0KLQlpZiAoSEFTX1JDNnAoaTkxNSkpCi0JCXZhbCArPSBpbnRl
bF9yYzZfcmVzaWRlbmN5X25zKGk5MTUsIEdFTjZfR1RfR0ZYX1JDNnApOwotCi0JaWYgKEhBU19S
QzZwcChpOTE1KSkKLQkJdmFsICs9IGludGVsX3JjNl9yZXNpZGVuY3lfbnMoaTkxNSwgR0VONl9H
VF9HRlhfUkM2cHApOwotCi0JcmV0dXJuIHZhbDsKLX0KLQogc3RhdGljIHU2NCBnZXRfcmM2KHN0
cnVjdCBpbnRlbF9ndCAqZ3QpCiB7Ci0jaWYgSVNfRU5BQkxFRChDT05GSUdfUE0pCiAJc3RydWN0
IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUgPSBndC0+aTkxNTsKLQlzdHJ1Y3QgaW50ZWxfcnVudGlt
ZV9wbSAqcnBtID0gJmk5MTUtPnJ1bnRpbWVfcG07CiAJc3RydWN0IGk5MTVfcG11ICpwbXUgPSAm
aTkxNS0+cG11OwotCWludGVsX3dha2VyZWZfdCB3YWtlcmVmOwogCXVuc2lnbmVkIGxvbmcgZmxh
Z3M7CiAJdTY0IHZhbDsKIAotCXdha2VyZWYgPSBpbnRlbF9ydW50aW1lX3BtX2dldF9pZl9pbl91
c2UocnBtKTsKLQlpZiAod2FrZXJlZikgeworCXNwaW5fbG9ja19pcnFzYXZlKCZwbXUtPmxvY2ss
IGZsYWdzKTsKKworCWlmIChpbnRlbF9ndF9wbV9nZXRfaWZfYXdha2UoZ3QpKSB7CiAJCXZhbCA9
IF9fZ2V0X3JjNihndCk7Ci0JCWludGVsX3J1bnRpbWVfcG1fcHV0KHJwbSwgd2FrZXJlZik7CisJ
CWludGVsX2d0X3BtX3B1dChndCk7CiAKIAkJLyoKIAkJICogSWYgd2UgYXJlIGNvbWluZyBiYWNr
IGZyb20gYmVpbmcgcnVudGltZSBzdXNwZW5kZWQgd2UgbXVzdApAQCAtNDY2LDE5ICs0OTQsMTMg
QEAgc3RhdGljIHU2NCBnZXRfcmM2KHN0cnVjdCBpbnRlbF9ndCAqZ3QpCiAJCSAqIHByZXZpb3Vz
bHkuCiAJCSAqLwogCi0JCXNwaW5fbG9ja19pcnFzYXZlKCZwbXUtPmxvY2ssIGZsYWdzKTsKLQog
CQlpZiAodmFsID49IHBtdS0+c2FtcGxlW19fSTkxNV9TQU1QTEVfUkM2X0VTVElNQVRFRF0uY3Vy
KSB7CiAJCQlwbXUtPnNhbXBsZVtfX0k5MTVfU0FNUExFX1JDNl9FU1RJTUFURURdLmN1ciA9IDA7
CiAJCQlwbXUtPnNhbXBsZVtfX0k5MTVfU0FNUExFX1JDNl0uY3VyID0gdmFsOwogCQl9IGVsc2Ug
ewogCQkJdmFsID0gcG11LT5zYW1wbGVbX19JOTE1X1NBTVBMRV9SQzZfRVNUSU1BVEVEXS5jdXI7
CiAJCX0KLQotCQlzcGluX3VubG9ja19pcnFyZXN0b3JlKCZwbXUtPmxvY2ssIGZsYWdzKTsKIAl9
IGVsc2UgewotCQlzdHJ1Y3QgZGV2aWNlICprZGV2ID0gcnBtLT5rZGV2OwotCiAJCS8qCiAJCSAq
IFdlIGFyZSBydW50aW1lIHN1c3BlbmRlZC4KIAkJICoKQEAgLTQ4Niw0MiArNTA4LDE2IEBAIHN0
YXRpYyB1NjQgZ2V0X3JjNihzdHJ1Y3QgaW50ZWxfZ3QgKmd0KQogCQkgKiBvbiB0b3Agb2YgdGhl
IGxhc3Qga25vd24gcmVhbCB2YWx1ZSwgYXMgdGhlIGFwcHJveGltYXRlZCBSQzYKIAkJICogY291
bnRlciB2YWx1ZS4KIAkJICovCi0JCXNwaW5fbG9ja19pcnFzYXZlKCZwbXUtPmxvY2ssIGZsYWdz
KTsKIAotCQkvKgotCQkgKiBBZnRlciB0aGUgYWJvdmUgYnJhbmNoIGludGVsX3J1bnRpbWVfcG1f
Z2V0X2lmX2luX3VzZSBmYWlsZWQKLQkJICogdG8gZ2V0IHRoZSBydW50aW1lIFBNIHJlZmVyZW5j
ZSB3ZSBjYW5ub3QgYXNzdW1lIHdlIGFyZSBpbgotCQkgKiBydW50aW1lIHN1c3BlbmQgc2luY2Ug
d2UgY2FuIGVpdGhlcjogYSkgcmFjZSB3aXRoIGNvbWluZyBvdXQKLQkJICogb2YgaXQgYmVmb3Jl
IHdlIHRvb2sgdGhlIHBvd2VyLmxvY2ssIG9yIGIpIHRoZXJlIGFyZSBvdGhlcgotCQkgKiBzdGF0
ZXMgdGhhbiBzdXNwZW5kZWQgd2hpY2ggY2FuIGJyaW5nIHVzIGhlcmUuCi0JCSAqCi0JCSAqIFdl
IG5lZWQgdG8gZG91YmxlLWNoZWNrIHRoYXQgd2UgYXJlIGluZGVlZCBjdXJyZW50bHkgcnVudGlt
ZQotCQkgKiBzdXNwZW5kZWQgYW5kIGlmIG5vdCB3ZSBjYW5ub3QgZG8gYmV0dGVyIHRoYW4gcmVw
b3J0IHRoZSBsYXN0Ci0JCSAqIGtub3duIFJDNiB2YWx1ZS4KLQkJICovCi0JCWlmIChwbV9ydW50
aW1lX3N0YXR1c19zdXNwZW5kZWQoa2RldikpIHsKLQkJCXZhbCA9IHBtX3J1bnRpbWVfc3VzcGVu
ZGVkX3RpbWUoa2Rldik7CisJCXZhbCA9IGt0aW1lX3NpbmNlKHBtdS0+c2xlZXBfbGFzdCk7CisJ
CXZhbCArPSBwbXUtPnNhbXBsZVtfX0k5MTVfU0FNUExFX1JDNl0uY3VyOwogCi0JCQlpZiAoIXBt
dS0+c2FtcGxlW19fSTkxNV9TQU1QTEVfUkM2X0VTVElNQVRFRF0uY3VyKQotCQkJCXBtdS0+c3Vz
cGVuZGVkX3RpbWVfbGFzdCA9IHZhbDsKLQotCQkJdmFsIC09IHBtdS0+c3VzcGVuZGVkX3RpbWVf
bGFzdDsKLQkJCXZhbCArPSBwbXUtPnNhbXBsZVtfX0k5MTVfU0FNUExFX1JDNl0uY3VyOwotCi0J
CQlwbXUtPnNhbXBsZVtfX0k5MTVfU0FNUExFX1JDNl9FU1RJTUFURURdLmN1ciA9IHZhbDsKLQkJ
fSBlbHNlIGlmIChwbXUtPnNhbXBsZVtfX0k5MTVfU0FNUExFX1JDNl9FU1RJTUFURURdLmN1cikg
ewotCQkJdmFsID0gcG11LT5zYW1wbGVbX19JOTE1X1NBTVBMRV9SQzZfRVNUSU1BVEVEXS5jdXI7
Ci0JCX0gZWxzZSB7Ci0JCQl2YWwgPSBwbXUtPnNhbXBsZVtfX0k5MTVfU0FNUExFX1JDNl0uY3Vy
OwotCQl9Ci0KLQkJc3Bpbl91bmxvY2tfaXJxcmVzdG9yZSgmcG11LT5sb2NrLCBmbGFncyk7CisJ
CXBtdS0+c2FtcGxlW19fSTkxNV9TQU1QTEVfUkM2X0VTVElNQVRFRF0uY3VyID0gdmFsOwogCX0K
IAorCXNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJnBtdS0+bG9jaywgZmxhZ3MpOworCiAJcmV0dXJu
IHZhbDsKLSNlbHNlCi0JcmV0dXJuIF9fZ2V0X3JjNihndCk7Ci0jZW5kaWYKIH0KIAogc3RhdGlj
IHU2NCBfX2k5MTVfcG11X2V2ZW50X3JlYWQoc3RydWN0IHBlcmZfZXZlbnQgKmV2ZW50KQpkaWZm
IC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wbXUuaCBiL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2k5MTVfcG11LmgKaW5kZXggNGZjNGYyNDc4MzAxLi4wNjdkYmJmM2JkZmYgMTAwNjQ0
Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcG11LmgKKysrIGIvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvaTkxNV9wbXUuaApAQCAtOTcsOSArOTcsOSBAQCBzdHJ1Y3QgaTkxNV9wbXUgewog
CSAqLwogCXN0cnVjdCBpOTE1X3BtdV9zYW1wbGUgc2FtcGxlW19fSTkxNV9OVU1fUE1VX1NBTVBM
RVJTXTsKIAkvKioKLQkgKiBAc3VzcGVuZGVkX3RpbWVfbGFzdDogQ2FjaGVkIHN1c3BlbmQgdGlt
ZSBmcm9tIFBNIGNvcmUuCisJICogQHNsZWVwX2xhc3Q6IExhc3QgdGltZSBHVCBwYXJrZWQgZm9y
IFJDNiBlc3RpbWF0aW9uLgogCSAqLwotCXU2NCBzdXNwZW5kZWRfdGltZV9sYXN0OworCWt0aW1l
X3Qgc2xlZXBfbGFzdDsKIAkvKioKIAkgKiBAaTkxNV9hdHRyOiBNZW1vcnkgYmxvY2sgaG9sZGlu
ZyBkZXZpY2UgYXR0cmlidXRlcy4KIAkgKi8KLS0gCjIuMjMuMAoKX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRl
bC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3Jn
L21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

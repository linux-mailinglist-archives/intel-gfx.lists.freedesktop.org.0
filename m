Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id AD70D8CFED
	for <lists+intel-gfx@lfdr.de>; Wed, 14 Aug 2019 11:44:49 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 1C9A589B48;
	Wed, 14 Aug 2019 09:44:48 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 7A3F589B48
 for <intel-gfx@lists.freedesktop.org>; Wed, 14 Aug 2019 09:44:46 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18076216-1500050 
 for multiple; Wed, 14 Aug 2019 10:26:44 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Wed, 14 Aug 2019 10:26:36 +0100
Message-Id: <20190814092643.1908-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0.rc1
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 1/8] drm/i915/execlists: Lift process_csb() out
 of the irq-off spinlock
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

SWYgd2Ugb25seSBjYWxsIHByb2Nlc3NfY3NiKCkgZnJvbSB0aGUgdGFza2xldCwgdGhvdWdoIHdl
IGxvc2UgdGhlCmFiaWxpdHkgdG8gYnlwYXNzIGtzb2Z0aXJxZCBpbnRlcnJ1cHQgcHJvY2Vzc2lu
ZyBvbiBkaXJlY3Qgc3VibWlzc2lvbgpwYXRocywgd2UgY2FuIHB1c2ggaXQgb3V0IG9mIHRoZSBp
cnEtb2ZmIHNwaW5sb2NrLgoKVGhlIHBlbmFsdHkgaXMgdGhhdCB3ZSB0aGVuIGFsbG93IHNjaGVk
dWxlX291dCB0byBiZSBjYWxsZWQgY29uY3VycmVudGx5CndpdGggc2NoZWR1bGVfaW4gcmVxdWly
aW5nIHVzIHRvIGhhbmRsZSB0aGUgdXNhZ2UgY291bnQgKGJha2VkIGludG8gdGhlCnBvaW50ZXIg
aXRzZWxmKSBhdG9taWNhbGx5LgoKQXMgd2UgZG8ga2ljayB0aGUgdGFza2xldHMgKHZpYSBsb2Nh
bF9iaF9lbmFibGUoKSkgYWZ0ZXIgb3VyIHN1Ym1pc3Npb24sCnRoZXJlIGlzIGEgcG9zc2liaWxp
dHkgdGhlcmUgdG8gc2VlIGlmIHdlIGNhbiBwdWxsIHRoZSBsb2NhbCBzb2Z0aXJxCnByb2Nlc3Np
bmcgYmFjayBmcm9tIHRoZSBrc29mdGlycWQuCgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24g
PGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9p
bnRlbF9jb250ZXh0X3R5cGVzLmggfCAgIDQgKy0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2lu
dGVsX2VuZ2luZV9jcy5jICAgICB8ICAgMiArLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50
ZWxfbHJjLmMgICAgICAgICAgIHwgMTMwICsrKysrKysrKysrLS0tLS0tLQogZHJpdmVycy9ncHUv
ZHJtL2k5MTUvaTkxNV91dGlscy5oICAgICAgICAgICAgIHwgIDIwICsrLQogNCBmaWxlcyBjaGFu
Z2VkLCA5NCBpbnNlcnRpb25zKCspLCA2MiBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9jb250ZXh0X3R5cGVzLmggYi9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9ndC9pbnRlbF9jb250ZXh0X3R5cGVzLmgKaW5kZXggYTYzMmIyMGVjNGQ4Li5kOGNl
MjY2YzA0OWYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2NvbnRl
eHRfdHlwZXMuaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9jb250ZXh0X3R5
cGVzLmgKQEAgLTQxLDkgKzQxLDcgQEAgc3RydWN0IGludGVsX2NvbnRleHQgewogCXN0cnVjdCBp
bnRlbF9lbmdpbmVfY3MgKmVuZ2luZTsKIAlzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICppbmZsaWdo
dDsKICNkZWZpbmUgaW50ZWxfY29udGV4dF9pbmZsaWdodChjZSkgcHRyX21hc2tfYml0cygoY2Up
LT5pbmZsaWdodCwgMikKLSNkZWZpbmUgaW50ZWxfY29udGV4dF9pbmZsaWdodF9jb3VudChjZSkg
IHB0cl91bm1hc2tfYml0cygoY2UpLT5pbmZsaWdodCwgMikKLSNkZWZpbmUgaW50ZWxfY29udGV4
dF9pbmZsaWdodF9pbmMoY2UpIHB0cl9jb3VudF9pbmMoJihjZSktPmluZmxpZ2h0KQotI2RlZmlu
ZSBpbnRlbF9jb250ZXh0X2luZmxpZ2h0X2RlYyhjZSkgcHRyX2NvdW50X2RlYygmKGNlKS0+aW5m
bGlnaHQpCisjZGVmaW5lIGludGVsX2NvbnRleHRfaW5mbGlnaHRfY291bnQoY2UpIHB0cl91bm1h
c2tfYml0cygoY2UpLT5pbmZsaWdodCwgMikKIAogCXN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2Ug
KnZtOwogCXN0cnVjdCBpOTE1X2dlbV9jb250ZXh0ICpnZW1fY29udGV4dDsKZGlmZiAtLWdpdCBh
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZV9jcy5jIGIvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvZ3QvaW50ZWxfZW5naW5lX2NzLmMKaW5kZXggZDIwNzUwZTQyMGMwLi5hYmQ0ZmRl
MmU1MmQgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZV9j
cy5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2VuZ2luZV9jcy5jCkBAIC0x
NDYwLDcgKzE0NjAsNyBAQCBpbnQgaW50ZWxfZW5hYmxlX2VuZ2luZV9zdGF0cyhzdHJ1Y3QgaW50
ZWxfZW5naW5lX2NzICplbmdpbmUpCiAKIAkJZm9yIChwb3J0ID0gZXhlY2xpc3RzLT5wZW5kaW5n
OyAocnEgPSAqcG9ydCk7IHBvcnQrKykgewogCQkJLyogRXhjbHVkZSBhbnkgY29udGV4dHMgYWxy
ZWFkeSBjb3VudGVkIGluIGFjdGl2ZSAqLwotCQkJaWYgKGludGVsX2NvbnRleHRfaW5mbGlnaHRf
Y291bnQocnEtPmh3X2NvbnRleHQpID09IDEpCisJCQlpZiAoIWludGVsX2NvbnRleHRfaW5mbGln
aHRfY291bnQocnEtPmh3X2NvbnRleHQpKQogCQkJCWVuZ2luZS0+c3RhdHMuYWN0aXZlKys7CiAJ
CX0KIApkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjLmMgYi9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9scmMuYwppbmRleCA1YzI2YzRhZTEzOWIuLjA5
ZDhjYjg2MTVjZiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJj
LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfbHJjLmMKQEAgLTU0NywyNyAr
NTQ3LDM5IEBAIGV4ZWNsaXN0c19jb250ZXh0X3N0YXR1c19jaGFuZ2Uoc3RydWN0IGk5MTVfcmVx
dWVzdCAqcnEsIHVuc2lnbmVkIGxvbmcgc3RhdHVzKQogCQkJCSAgIHN0YXR1cywgcnEpOwogfQog
CitzdGF0aWMgaW5saW5lIHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKgorX19leGVjbGlzdHNfc2No
ZWR1bGVfaW4oc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEpCit7CisJc3RydWN0IGludGVsX2VuZ2lu
ZV9jcyAqIGNvbnN0IGVuZ2luZSA9IHJxLT5lbmdpbmU7CisJc3RydWN0IGludGVsX2NvbnRleHQg
KiBjb25zdCBjZSA9IHJxLT5od19jb250ZXh0OworCisJaW50ZWxfY29udGV4dF9nZXQoY2UpOwor
CisJaW50ZWxfZ3RfcG1fZ2V0KGVuZ2luZS0+Z3QpOworCWV4ZWNsaXN0c19jb250ZXh0X3N0YXR1
c19jaGFuZ2UocnEsIElOVEVMX0NPTlRFWFRfU0NIRURVTEVfSU4pOworCWludGVsX2VuZ2luZV9j
b250ZXh0X2luKGVuZ2luZSk7CisKKwlyZXR1cm4gZW5naW5lOworfQorCiBzdGF0aWMgaW5saW5l
IHN0cnVjdCBpOTE1X3JlcXVlc3QgKgogZXhlY2xpc3RzX3NjaGVkdWxlX2luKHN0cnVjdCBpOTE1
X3JlcXVlc3QgKnJxLCBpbnQgaWR4KQogewotCXN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSA9IHJx
LT5od19jb250ZXh0OwotCWludCBjb3VudDsKKwlzdHJ1Y3QgaW50ZWxfY29udGV4dCAqIGNvbnN0
IGNlID0gcnEtPmh3X2NvbnRleHQ7CisJc3RydWN0IGludGVsX2VuZ2luZV9jcyAqb2xkOwogCisJ
R0VNX0JVR19PTighaW50ZWxfZW5naW5lX3BtX2lzX2F3YWtlKHJxLT5lbmdpbmUpKTsKIAl0cmFj
ZV9pOTE1X3JlcXVlc3RfaW4ocnEsIGlkeCk7CiAKLQljb3VudCA9IGludGVsX2NvbnRleHRfaW5m
bGlnaHRfY291bnQoY2UpOwotCWlmICghY291bnQpIHsKLQkJaW50ZWxfY29udGV4dF9nZXQoY2Up
OwotCQljZS0+aW5mbGlnaHQgPSBycS0+ZW5naW5lOwotCi0JCWludGVsX2d0X3BtX2dldChjZS0+
aW5mbGlnaHQtPmd0KTsKLQkJZXhlY2xpc3RzX2NvbnRleHRfc3RhdHVzX2NoYW5nZShycSwgSU5U
RUxfQ09OVEVYVF9TQ0hFRFVMRV9JTik7Ci0JCWludGVsX2VuZ2luZV9jb250ZXh0X2luKGNlLT5p
bmZsaWdodCk7Ci0JfQorCW9sZCA9IFJFQURfT05DRShjZS0+aW5mbGlnaHQpOworCWRvIHsKKwkJ
aWYgKCFvbGQpIHsKKwkJCVdSSVRFX09OQ0UoY2UtPmluZmxpZ2h0LCBfX2V4ZWNsaXN0c19zY2hl
ZHVsZV9pbihycSkpOworCQkJYnJlYWs7CisJCX0KKwl9IHdoaWxlICghdHJ5X2NtcHhjaGcoJmNl
LT5pbmZsaWdodCwgJm9sZCwgcHRyX2luYyhvbGQpKSk7CiAKLQlpbnRlbF9jb250ZXh0X2luZmxp
Z2h0X2luYyhjZSk7CiAJR0VNX0JVR19PTihpbnRlbF9jb250ZXh0X2luZmxpZ2h0KGNlKSAhPSBy
cS0+ZW5naW5lKTsKLQogCXJldHVybiBpOTE1X3JlcXVlc3RfZ2V0KHJxKTsKIH0KIApAQCAtNTgx
LDM1ICs1OTMsNDUgQEAgc3RhdGljIHZvaWQga2lja19zaWJsaW5ncyhzdHJ1Y3QgaTkxNV9yZXF1
ZXN0ICpycSwgc3RydWN0IGludGVsX2NvbnRleHQgKmNlKQogfQogCiBzdGF0aWMgaW5saW5lIHZv
aWQKLWV4ZWNsaXN0c19zY2hlZHVsZV9vdXQoc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEpCitfX2V4
ZWNsaXN0c19zY2hlZHVsZV9vdXQoc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEsCisJCQkgc3RydWN0
IGludGVsX2VuZ2luZV9jcyAqIGNvbnN0IGVuZ2luZSkKIHsKLQlzdHJ1Y3QgaW50ZWxfY29udGV4
dCAqY2UgPSBycS0+aHdfY29udGV4dDsKKwlzdHJ1Y3QgaW50ZWxfY29udGV4dCAqIGNvbnN0IGNl
ID0gcnEtPmh3X2NvbnRleHQ7CiAKLQlHRU1fQlVHX09OKCFpbnRlbF9jb250ZXh0X2luZmxpZ2h0
X2NvdW50KGNlKSk7CisJaW50ZWxfZW5naW5lX2NvbnRleHRfb3V0KGVuZ2luZSk7CisJZXhlY2xp
c3RzX2NvbnRleHRfc3RhdHVzX2NoYW5nZShycSwgSU5URUxfQ09OVEVYVF9TQ0hFRFVMRV9PVVQp
OworCWludGVsX2d0X3BtX3B1dChlbmdpbmUtPmd0KTsKIAotCXRyYWNlX2k5MTVfcmVxdWVzdF9v
dXQocnEpOworCS8qCisJICogSWYgdGhpcyBpcyBwYXJ0IG9mIGEgdmlydHVhbCBlbmdpbmUsIGl0
cyBuZXh0IHJlcXVlc3QgbWF5CisJICogaGF2ZSBiZWVuIGJsb2NrZWQgd2FpdGluZyBmb3IgYWNj
ZXNzIHRvIHRoZSBhY3RpdmUgY29udGV4dC4KKwkgKiBXZSBoYXZlIHRvIGtpY2sgYWxsIHRoZSBz
aWJsaW5ncyBhZ2FpbiBpbiBjYXNlIHdlIG5lZWQgdG8KKwkgKiBzd2l0Y2ggKGUuZy4gdGhlIG5l
eHQgcmVxdWVzdCBpcyBub3QgcnVubmFibGUgb24gdGhpcworCSAqIGVuZ2luZSkuIEhvcGVmdWxs
eSwgd2Ugd2lsbCBhbHJlYWR5IGhhdmUgc3VibWl0dGVkIHRoZSBuZXh0CisJICogcmVxdWVzdCBi
ZWZvcmUgdGhlIHRhc2tsZXQgcnVucyBhbmQgZG8gbm90IG5lZWQgdG8gcmVidWlsZAorCSAqIGVh
Y2ggdmlydHVhbCB0cmVlIGFuZCBraWNrIGV2ZXJ5b25lIGFnYWluLgorCSAqLworCWlmIChjZS0+
ZW5naW5lICE9IGVuZ2luZSkKKwkJa2lja19zaWJsaW5ncyhycSwgY2UpOwogCi0JaW50ZWxfY29u
dGV4dF9pbmZsaWdodF9kZWMoY2UpOwotCWlmICghaW50ZWxfY29udGV4dF9pbmZsaWdodF9jb3Vu
dChjZSkpIHsKLQkJaW50ZWxfZW5naW5lX2NvbnRleHRfb3V0KGNlLT5pbmZsaWdodCk7Ci0JCWV4
ZWNsaXN0c19jb250ZXh0X3N0YXR1c19jaGFuZ2UocnEsIElOVEVMX0NPTlRFWFRfU0NIRURVTEVf
T1VUKTsKLQkJaW50ZWxfZ3RfcG1fcHV0KGNlLT5pbmZsaWdodC0+Z3QpOworCWludGVsX2NvbnRl
eHRfcHV0KGNlKTsKK30KIAotCQkvKgotCQkgKiBJZiB0aGlzIGlzIHBhcnQgb2YgYSB2aXJ0dWFs
IGVuZ2luZSwgaXRzIG5leHQgcmVxdWVzdCBtYXkKLQkJICogaGF2ZSBiZWVuIGJsb2NrZWQgd2Fp
dGluZyBmb3IgYWNjZXNzIHRvIHRoZSBhY3RpdmUgY29udGV4dC4KLQkJICogV2UgaGF2ZSB0byBr
aWNrIGFsbCB0aGUgc2libGluZ3MgYWdhaW4gaW4gY2FzZSB3ZSBuZWVkIHRvCi0JCSAqIHN3aXRj
aCAoZS5nLiB0aGUgbmV4dCByZXF1ZXN0IGlzIG5vdCBydW5uYWJsZSBvbiB0aGlzCi0JCSAqIGVu
Z2luZSkuIEhvcGVmdWxseSwgd2Ugd2lsbCBhbHJlYWR5IGhhdmUgc3VibWl0dGVkIHRoZSBuZXh0
Ci0JCSAqIHJlcXVlc3QgYmVmb3JlIHRoZSB0YXNrbGV0IHJ1bnMgYW5kIGRvIG5vdCBuZWVkIHRv
IHJlYnVpbGQKLQkJICogZWFjaCB2aXJ0dWFsIHRyZWUgYW5kIGtpY2sgZXZlcnlvbmUgYWdhaW4u
Ci0JCSAqLwotCQljZS0+aW5mbGlnaHQgPSBOVUxMOwotCQlpZiAocnEtPmVuZ2luZSAhPSBjZS0+
ZW5naW5lKQotCQkJa2lja19zaWJsaW5ncyhycSwgY2UpOworc3RhdGljIGlubGluZSB2b2lkCitl
eGVjbGlzdHNfc2NoZWR1bGVfb3V0KHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxKQoreworCXN0cnVj
dCBpbnRlbF9jb250ZXh0ICogY29uc3QgY2UgPSBycS0+aHdfY29udGV4dDsKKwlzdHJ1Y3QgaW50
ZWxfZW5naW5lX2NzICpjdXIsICpvbGQ7CiAKLQkJaW50ZWxfY29udGV4dF9wdXQoY2UpOwotCX0K
Kwl0cmFjZV9pOTE1X3JlcXVlc3Rfb3V0KHJxKTsKKwlHRU1fQlVHX09OKGludGVsX2NvbnRleHRf
aW5mbGlnaHQoY2UpICE9IHJxLT5lbmdpbmUpOworCisJb2xkID0gUkVBRF9PTkNFKGNlLT5pbmZs
aWdodCk7CisJZG8KKwkJY3VyID0gcHRyX3VubWFza19iaXRzKG9sZCwgMikgPyBwdHJfZGVjKG9s
ZCkgOiBOVUxMOworCXdoaWxlICghdHJ5X2NtcHhjaGcoJmNlLT5pbmZsaWdodCwgJm9sZCwgY3Vy
KSk7CisJaWYgKCFjdXIpCisJCV9fZXhlY2xpc3RzX3NjaGVkdWxlX291dChycSwgb2xkKTsKIAog
CWk5MTVfcmVxdWVzdF9wdXQocnEpOwogfQpAQCAtNjg0LDYgKzcwNiw5IEBAIGFzc2VydF9wZW5k
aW5nX3ZhbGlkKGNvbnN0IHN0cnVjdCBpbnRlbF9lbmdpbmVfZXhlY2xpc3RzICpleGVjbGlzdHMs
CiAKIAl0cmFjZV9wb3J0cyhleGVjbGlzdHMsIG1zZywgZXhlY2xpc3RzLT5wZW5kaW5nKTsKIAor
CWlmICghZXhlY2xpc3RzLT5wZW5kaW5nWzBdKQorCQlyZXR1cm4gZmFsc2U7CisKIAlpZiAoZXhl
Y2xpc3RzLT5wZW5kaW5nW2V4ZWNsaXN0c19udW1fcG9ydHMoZXhlY2xpc3RzKV0pCiAJCXJldHVy
biBmYWxzZTsKIApAQCAtOTQ0LDkgKzk2OSwyMSBAQCBuZWVkX3RpbWVzbGljZShzdHJ1Y3QgaW50
ZWxfZW5naW5lX2NzICplbmdpbmUsIGNvbnN0IHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxKQogc3Rh
dGljIGJvb2wKIGVuYWJsZV90aW1lc2xpY2Uoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5l
KQogewotCXN0cnVjdCBpOTE1X3JlcXVlc3QgKmxhc3QgPSBsYXN0X2FjdGl2ZSgmZW5naW5lLT5l
eGVjbGlzdHMpOworCXN0cnVjdCBpOTE1X3JlcXVlc3QgKiBjb25zdCAqcG9ydDsKKwlpbnQgaGlu
dDsKKworCXBvcnQgPSBlbmdpbmUtPmV4ZWNsaXN0cy5hY3RpdmU7CisJd2hpbGUgKHBvcnRbMF0g
JiYgaTkxNV9yZXF1ZXN0X2NvbXBsZXRlZChwb3J0WzBdKSkKKwkJcG9ydCsrOworCWlmICghcG9y
dFswXSkKKwkJcmV0dXJuIGZhbHNlOwogCi0JcmV0dXJuIGxhc3QgJiYgbmVlZF90aW1lc2xpY2Uo
ZW5naW5lLCBsYXN0KTsKKwloaW50ID0gZW5naW5lLT5leGVjbGlzdHMucXVldWVfcHJpb3JpdHlf
aGludDsKKwlpZiAocG9ydFsxXSkKKwkJaGludCA9IG1heChycV9wcmlvKHBvcnRbMV0pLCBoaW50
KTsKKworCS8qIENvbXBhcmUgdGhlIHR3byBlbmQtcG9pbnRzIGFzIGFuIHVubG9ja2VkIGFwcHJv
eGltYXRpb24gKi8KKwlyZXR1cm4gaGludCA+PSBlZmZlY3RpdmVfcHJpbyhwb3J0WzBdKTsKIH0K
IAogc3RhdGljIHZvaWQgcmVjb3JkX3ByZWVtcHRpb24oc3RydWN0IGludGVsX2VuZ2luZV9leGVj
bGlzdHMgKmV4ZWNsaXN0cykKQEAgLTEzNTYsNyArMTM5Myw2IEBAIHN0YXRpYyB2b2lkIHByb2Nl
c3NfY3NiKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkKIAljb25zdCB1OCBudW1fZW50
cmllcyA9IGV4ZWNsaXN0cy0+Y3NiX3NpemU7CiAJdTggaGVhZCwgdGFpbDsKIAotCWxvY2tkZXBf
YXNzZXJ0X2hlbGQoJmVuZ2luZS0+YWN0aXZlLmxvY2spOwogCUdFTV9CVUdfT04oVVNFU19HVUNf
U1VCTUlTU0lPTihlbmdpbmUtPmk5MTUpKTsKIAogCS8qCkBAIC0xNDI3LDE1ICsxNDYzLDE0IEBA
IHN0YXRpYyB2b2lkIHByb2Nlc3NfY3NiKHN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSkK
IAkJCQkgICAgICAgZXhlY2xpc3RzLT5wZW5kaW5nLAogCQkJCSAgICAgICBleGVjbGlzdHNfbnVt
X3BvcnRzKGV4ZWNsaXN0cykgKgogCQkJCSAgICAgICBzaXplb2YoKmV4ZWNsaXN0cy0+cGVuZGlu
ZykpOwotCQkJZXhlY2xpc3RzLT5wZW5kaW5nWzBdID0gTlVMTDsKLQotCQkJdHJhY2VfcG9ydHMo
ZXhlY2xpc3RzLCAicHJvbW90ZWQiLCBleGVjbGlzdHMtPmFjdGl2ZSk7CiAKIAkJCWlmIChlbmFi
bGVfdGltZXNsaWNlKGVuZ2luZSkpCiAJCQkJbW9kX3RpbWVyKCZleGVjbGlzdHMtPnRpbWVyLCBq
aWZmaWVzICsgMSk7CiAKIAkJCWlmICghaW5qZWN0X3ByZWVtcHRfaGFuZyhleGVjbGlzdHMpKQog
CQkJCXJpbmdfc2V0X3BhdXNlZChlbmdpbmUsIDApOworCisJCQlXUklURV9PTkNFKGV4ZWNsaXN0
cy0+cGVuZGluZ1swXSwgTlVMTCk7CiAJCQlicmVhazsKIAogCQljYXNlIENTQl9DT01QTEVURTog
LyogcG9ydDAgY29tcGxldGVkLCBhZHZhbmNlZCB0byBwb3J0MSAqLwpAQCAtMTQ3OSw4ICsxNTE0
LDYgQEAgc3RhdGljIHZvaWQgcHJvY2Vzc19jc2Ioc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5n
aW5lKQogc3RhdGljIHZvaWQgX19leGVjbGlzdHNfc3VibWlzc2lvbl90YXNrbGV0KHN0cnVjdCBp
bnRlbF9lbmdpbmVfY3MgKmNvbnN0IGVuZ2luZSkKIHsKIAlsb2NrZGVwX2Fzc2VydF9oZWxkKCZl
bmdpbmUtPmFjdGl2ZS5sb2NrKTsKLQotCXByb2Nlc3NfY3NiKGVuZ2luZSk7CiAJaWYgKCFlbmdp
bmUtPmV4ZWNsaXN0cy5wZW5kaW5nWzBdKQogCQlleGVjbGlzdHNfZGVxdWV1ZShlbmdpbmUpOwog
fQpAQCAtMTQ5NCw5ICsxNTI3LDEyIEBAIHN0YXRpYyB2b2lkIGV4ZWNsaXN0c19zdWJtaXNzaW9u
X3Rhc2tsZXQodW5zaWduZWQgbG9uZyBkYXRhKQogCXN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKiBj
b25zdCBlbmdpbmUgPSAoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqKWRhdGE7CiAJdW5zaWduZWQg
bG9uZyBmbGFnczsKIAotCXNwaW5fbG9ja19pcnFzYXZlKCZlbmdpbmUtPmFjdGl2ZS5sb2NrLCBm
bGFncyk7Ci0JX19leGVjbGlzdHNfc3VibWlzc2lvbl90YXNrbGV0KGVuZ2luZSk7Ci0Jc3Bpbl91
bmxvY2tfaXJxcmVzdG9yZSgmZW5naW5lLT5hY3RpdmUubG9jaywgZmxhZ3MpOworCXByb2Nlc3Nf
Y3NiKGVuZ2luZSk7CisJaWYgKCFlbmdpbmUtPmV4ZWNsaXN0cy5wZW5kaW5nWzBdKSB7CisJCXNw
aW5fbG9ja19pcnFzYXZlKCZlbmdpbmUtPmFjdGl2ZS5sb2NrLCBmbGFncyk7CisJCV9fZXhlY2xp
c3RzX3N1Ym1pc3Npb25fdGFza2xldChlbmdpbmUpOworCQlzcGluX3VubG9ja19pcnFyZXN0b3Jl
KCZlbmdpbmUtPmFjdGl2ZS5sb2NrLCBmbGFncyk7CisJfQogfQogCiBzdGF0aWMgdm9pZCBleGVj
bGlzdHNfc3VibWlzc2lvbl90aW1lcihzdHJ1Y3QgdGltZXJfbGlzdCAqdGltZXIpCmRpZmYgLS1n
aXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3V0aWxzLmggYi9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9pOTE1X3V0aWxzLmgKaW5kZXggZDY1MmJhNWQyMzIwLi41NjJmNzU2ZGE0MjEgMTAwNjQ0
Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfdXRpbHMuaAorKysgYi9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9pOTE1X3V0aWxzLmgKQEAgLTE2MSwxNyArMTYxLDE1IEBAIF9fY2hlY2tfc3Ry
dWN0X3NpemUoc2l6ZV90IGJhc2UsIHNpemVfdCBhcnIsIHNpemVfdCBjb3VudCwgc2l6ZV90ICpz
aXplKQogCSgodHlwZW9mKHB0cikpKCh1bnNpZ25lZCBsb25nKShwdHIpIHwgX19iaXRzKSk7CQkJ
XAogfSkKIAotI2RlZmluZSBwdHJfY291bnRfZGVjKHBfcHRyKSBkbyB7CQkJCQlcCi0JdHlwZW9m
KHBfcHRyKSBfX3AgPSAocF9wdHIpOwkJCQkJXAotCXVuc2lnbmVkIGxvbmcgX192ID0gKHVuc2ln
bmVkIGxvbmcpKCpfX3ApOwkJCVwKLQkqX19wID0gKHR5cGVvZigqcF9wdHIpKSgtLV9fdik7CQkJ
CQlcCi19IHdoaWxlICgwKQotCi0jZGVmaW5lIHB0cl9jb3VudF9pbmMocF9wdHIpIGRvIHsJCQkJ
CVwKLQl0eXBlb2YocF9wdHIpIF9fcCA9IChwX3B0cik7CQkJCQlcCi0JdW5zaWduZWQgbG9uZyBf
X3YgPSAodW5zaWduZWQgbG9uZykoKl9fcCk7CQkJXAotCSpfX3AgPSAodHlwZW9mKCpwX3B0cikp
KCsrX192KTsJCQkJCVwKLX0gd2hpbGUgKDApCisjZGVmaW5lIHB0cl9kZWMocHRyKSAoewkJCQkJ
CQlcCisJdW5zaWduZWQgbG9uZyBfX3YgPSAodW5zaWduZWQgbG9uZykocHRyKTsJCQlcCisJKHR5
cGVvZihwdHIpKShfX3YgLSAxKTsJCQkJCQlcCit9KQorCisjZGVmaW5lIHB0cl9pbmMocHRyKSAo
ewkJCQkJCQlcCisJdW5zaWduZWQgbG9uZyBfX3YgPSAodW5zaWduZWQgbG9uZykocHRyKTsJCQlc
CisJKHR5cGVvZihwdHIpKShfX3YgKyAxKTsJCQkJCQlcCit9KQogCiAjZGVmaW5lIHBhZ2VfbWFz
a19iaXRzKHB0cikgcHRyX21hc2tfYml0cyhwdHIsIFBBR0VfU0hJRlQpCiAjZGVmaW5lIHBhZ2Vf
dW5tYXNrX2JpdHMocHRyKSBwdHJfdW5tYXNrX2JpdHMocHRyLCBQQUdFX1NISUZUKQotLSAKMi4y
My4wLnJjMQoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18K
SW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0
dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 86A9D277E3
	for <lists+intel-gfx@lfdr.de>; Thu, 23 May 2019 10:24:39 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 6727389CE2;
	Thu, 23 May 2019 08:24:36 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from mga14.intel.com (mga14.intel.com [192.55.52.115])
 by gabe.freedesktop.org (Postfix) with ESMTPS id D415989CDB
 for <intel-gfx@lists.freedesktop.org>; Thu, 23 May 2019 08:24:30 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga001.jf.intel.com ([10.7.209.18])
 by fmsmga103.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 23 May 2019 01:24:30 -0700
X-ExtLoop1: 1
Received: from igivoni-mobl.amr.corp.intel.com (HELO
 ldmartin-desk.amr.corp.intel.com) ([10.255.88.102])
 by orsmga001.jf.intel.com with ESMTP; 23 May 2019 01:24:30 -0700
From: Lucas De Marchi <lucas.demarchi@intel.com>
To: intel-gfx@lists.freedesktop.org
Date: Thu, 23 May 2019 01:24:19 -0700
Message-Id: <20190523082420.10352-9-lucas.demarchi@intel.com>
X-Mailer: git-send-email 2.21.0
In-Reply-To: <20190523082420.10352-1-lucas.demarchi@intel.com>
References: <20190523082420.10352-1-lucas.demarchi@intel.com>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 09/10] drm/i915/dmc: protect against reading
 random memory
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Lucas De Marchi <lucas.demarchi@intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

V2hpbGUgbG9hZGluZyB0aGUgRE1DIGZpcm13YXJlIHdlIHdlcmUgZG91YmxlIGNoZWNraW5nIHRo
ZSBoZWFkZXJzIG1hZGUKc2Vuc2UsIGJ1dCBpbiBubyBwbGFjZSB3ZSBjaGVja2VkIHRoYXQgd2Ug
d2VyZSBhY3R1YWxseSByZWFkaW5nIG1lbW9yeQp3ZSB3ZXJlIHN1cHBvc2VkIHRvLiBUaGlzIGNv
dWxkIGJlIHdyb25nIGluIGNhc2UgdGhlIGZpcm13YXJlIGZpbGUgaXMKdHJ1bmNhdGVkLgoKQmVm
b3JlIHBhcnNpbmcgYW55IHBhcnQgb2YgdGhlIGZpcm13YXJlLCB2YWxpZGF0ZSB0aGUgaW5wdXQg
Zmlyc3QuCgpTaWduZWQtb2ZmLWJ5OiBMdWNhcyBEZSBNYXJjaGkgPGx1Y2FzLmRlbWFyY2hpQGlu
dGVsLmNvbT4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pbnRlbF9jc3IuYyB8IDcxICsrKysr
KysrKysrKysrKysrKysrKysrKy0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgNTMgaW5zZXJ0aW9u
cygrKSwgMTggZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUv
aW50ZWxfY3NyLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pbnRlbF9jc3IuYwppbmRleCA3ZmYw
OGRlODNjYzYuLmI3MTgxY2E2YzhmNSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUv
aW50ZWxfY3NyLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfY3NyLmMKQEAgLTM2
MCw3ICszNjAsOCBAQCBzdGF0aWMgdTMyIGZpbmRfZG1jX2Z3X29mZnNldChjb25zdCBzdHJ1Y3Qg
aW50ZWxfZndfaW5mbyAqZndfaW5mbywKIH0KIAogc3RhdGljIHUzMiBwYXJzZV9jc3JfZndfZG1j
KHN0cnVjdCBpbnRlbF9jc3IgKmNzciwKLQkJCSAgICBjb25zdCBzdHJ1Y3QgaW50ZWxfZG1jX2hl
YWRlcl9iYXNlICpkbWNfaGVhZGVyKQorCQkJICAgIGNvbnN0IHN0cnVjdCBpbnRlbF9kbWNfaGVh
ZGVyX2Jhc2UgKmRtY19oZWFkZXIsCisJCQkgICAgc2l6ZV90IHJlbV9zaXplKQogewogCXVuc2ln
bmVkIGludCBoZWFkZXJfbGVuX2J5dGVzLCBkbWNfaGVhZGVyX3NpemUsIHBheWxvYWRfc2l6ZSwg
aTsKIAljb25zdCB1MzIgKm1taW9hZGRyLCAqbW1pb2RhdGE7CkBAIC0zNzUsNiArMzc2LDkgQEAg
c3RhdGljIHUzMiBwYXJzZV9jc3JfZndfZG1jKHN0cnVjdCBpbnRlbF9jc3IgKmNzciwKIAkJY29u
c3Qgc3RydWN0IGludGVsX2RtY19oZWFkZXJfdjMgKnYzID0KIAkJCShjb25zdCBzdHJ1Y3QgaW50
ZWxfZG1jX2hlYWRlcl92MyAqKWRtY19oZWFkZXI7CiAKKwkJaWYgKHJlbV9zaXplIDwgc2l6ZW9m
KHN0cnVjdCBpbnRlbF9kbWNfaGVhZGVyX3YzKSkKKwkJCWdvdG8gZXJyb3JfdHJ1bmNhdGVkOwor
CiAJCW1taW9hZGRyID0gdjMtPm1taW9hZGRyOwogCQltbWlvZGF0YSA9IHYzLT5tbWlvZGF0YTsK
IAkJbW1pb19jb3VudCA9IHYzLT5tbWlvX2NvdW50OwpAQCAtMzg2LDYgKzM5MCw5IEBAIHN0YXRp
YyB1MzIgcGFyc2VfY3NyX2Z3X2RtYyhzdHJ1Y3QgaW50ZWxfY3NyICpjc3IsCiAJCWNvbnN0IHN0
cnVjdCBpbnRlbF9kbWNfaGVhZGVyX3YxICp2MSA9CiAJCQkoY29uc3Qgc3RydWN0IGludGVsX2Rt
Y19oZWFkZXJfdjEgKilkbWNfaGVhZGVyOwogCisJCWlmIChyZW1fc2l6ZSA8IHNpemVvZihzdHJ1
Y3QgaW50ZWxfZG1jX2hlYWRlcl92MSkpCisJCQlnb3RvIGVycm9yX3RydW5jYXRlZDsKKwogCQlt
bWlvYWRkciA9IHYxLT5tbWlvYWRkcjsKIAkJbW1pb2RhdGEgPSB2MS0+bW1pb2RhdGE7CiAJCW1t
aW9fY291bnQgPSB2MS0+bW1pb19jb3VudDsKQEAgLTQwNCw2ICs0MTEsOCBAQCBzdGF0aWMgdTMy
IHBhcnNlX2Nzcl9md19kbWMoc3RydWN0IGludGVsX2NzciAqY3NyLAogCQlyZXR1cm4gMDsKIAl9
CiAKKwlyZW1fc2l6ZSAtPSBoZWFkZXJfbGVuX2J5dGVzOworCiAJLyogQ2FjaGUgdGhlIGRtYyBo
ZWFkZXIgaW5mby4gKi8KIAlpZiAobW1pb19jb3VudCA+IG1taW9fY291bnRfbWF4KSB7CiAJCURS
TV9FUlJPUigiRE1DIGZpcm13YXJlIGhhcyB3cm9uZyBtbWlvIGNvdW50ICV1XG4iLCBtbWlvX2Nv
dW50KTsKQEAgLTQyNCw2ICs0MzMsOSBAQCBzdGF0aWMgdTMyIHBhcnNlX2Nzcl9md19kbWMoc3Ry
dWN0IGludGVsX2NzciAqY3NyLAogCiAJLyogZndfc2l6ZSBpcyBpbiBkd29yZHMsIHNvIG11bHRp
cGxpZWQgYnkgNCB0byBjb252ZXJ0IGludG8gYnl0ZXMuICovCiAJcGF5bG9hZF9zaXplID0gZG1j
X2hlYWRlci0+Zndfc2l6ZSAqIDQ7CisJaWYgKHJlbV9zaXplIDwgcGF5bG9hZF9zaXplKQorCQln
b3RvIGVycm9yX3RydW5jYXRlZDsKKwogCWlmIChwYXlsb2FkX3NpemUgPiBjc3ItPm1heF9md19z
aXplKSB7CiAJCURSTV9FUlJPUigiRE1DIEZXIHRvbyBiaWcgKCV1IGJ5dGVzKVxuIiwgcGF5bG9h
ZF9zaXplKTsKIAkJcmV0dXJuIDA7CkBAIC00NDAsMTYgKzQ1MiwyNSBAQCBzdGF0aWMgdTMyIHBh
cnNlX2Nzcl9md19kbWMoc3RydWN0IGludGVsX2NzciAqY3NyLAogCW1lbWNweShjc3ItPmRtY19w
YXlsb2FkLCBwYXlsb2FkLCBwYXlsb2FkX3NpemUpOwogCiAJcmV0dXJuIGhlYWRlcl9sZW5fYnl0
ZXMgKyBwYXlsb2FkX3NpemU7CisKK2Vycm9yX3RydW5jYXRlZDoKKwlEUk1fRVJST1IoIlRydW5j
YXRlZCBETUMgZmlybXdhcmUsIHJlZnVzaW5nLlxuIik7CisJcmV0dXJuIDA7CiB9CiAKIHN0YXRp
YyB1MzIKIHBhcnNlX2Nzcl9md19wYWNrYWdlKHN0cnVjdCBpbnRlbF9jc3IgKmNzciwKIAkJICAg
ICBjb25zdCBzdHJ1Y3QgaW50ZWxfcGFja2FnZV9oZWFkZXIgKnBhY2thZ2VfaGVhZGVyLAotCQkg
ICAgIGNvbnN0IHN0cnVjdCBzdGVwcGluZ19pbmZvICpzaSkKKwkJICAgICBjb25zdCBzdHJ1Y3Qg
c3RlcHBpbmdfaW5mbyAqc2ksCisJCSAgICAgc2l6ZV90IHJlbV9zaXplKQogewotCXUzMiBudW1f
ZW50cmllcywgbWF4X2VudHJpZXMsIGRtY19vZmZzZXQsIHI7CisJdTMyIHBhY2thZ2Vfc2l6ZSA9
IHNpemVvZihzdHJ1Y3QgaW50ZWxfcGFja2FnZV9oZWFkZXIpOworCXUzMiBudW1fZW50cmllcywg
bWF4X2VudHJpZXMsIGRtY19vZmZzZXQ7CiAJY29uc3Qgc3RydWN0IGludGVsX2Z3X2luZm8gKmZ3
X2luZm87CiAKKwlpZiAocmVtX3NpemUgPCBwYWNrYWdlX3NpemUpCisJCWdvdG8gZXJyb3JfdHJ1
bmNhdGVkOworCiAJaWYgKHBhY2thZ2VfaGVhZGVyLT5oZWFkZXJfdmVyID09IDEpIHsKIAkJbWF4
X2VudHJpZXMgPSBQQUNLQUdFX01BWF9GV19JTkZPX0VOVFJJRVM7CiAJfSBlbHNlIGlmIChwYWNr
YWdlX2hlYWRlci0+aGVhZGVyX3ZlciA9PSAyKSB7CkBAIC00NjAsMTEgKzQ4MSwxNyBAQCBwYXJz
ZV9jc3JfZndfcGFja2FnZShzdHJ1Y3QgaW50ZWxfY3NyICpjc3IsCiAJCXJldHVybiAwOwogCX0K
IAotCWlmIChwYWNrYWdlX2hlYWRlci0+aGVhZGVyX2xlbiAqIDQgIT0KLQkgICAgc2l6ZW9mKHN0
cnVjdCBpbnRlbF9wYWNrYWdlX2hlYWRlcikgKwotCSAgICBtYXhfZW50cmllcyAqIHNpemVvZihz
dHJ1Y3QgaW50ZWxfZndfaW5mbykpIHsKKwkvKgorCSAqIFdlIHNob3VsZCBhbHdheXMgaGF2ZSBz
cGFjZSBmb3IgbWF4X2VudHJpZXMsCisJICogZXZlbiBpZiBub3QgYWxsIGFyZSB1c2VkCisJICov
CisJcGFja2FnZV9zaXplICs9IG1heF9lbnRyaWVzICogc2l6ZW9mKHN0cnVjdCBpbnRlbF9md19p
bmZvKTsKKwlpZiAocmVtX3NpemUgPCBwYWNrYWdlX3NpemUpCisJCWdvdG8gZXJyb3JfdHJ1bmNh
dGVkOworCisJaWYgKHBhY2thZ2VfaGVhZGVyLT5oZWFkZXJfbGVuICogNCAhPSBwYWNrYWdlX3Np
emUpIHsKIAkJRFJNX0VSUk9SKCJETUMgZmlybXdhcmUgaGFzIHdyb25nIHBhY2thZ2UgaGVhZGVy
IGxlbmd0aCAiCi0JCQkgICIoJXUgYnl0ZXMpXG4iLCBwYWNrYWdlX2hlYWRlci0+aGVhZGVyX2xl
biAqIDQpOworCQkJICAiKCV1IGJ5dGVzKVxuIiwgcGFja2FnZV9zaXplKTsKIAkJcmV0dXJuIDA7
CiAJfQogCkBAIC00ODEsMjEgKzUwOCwyNCBAQCBwYXJzZV9jc3JfZndfcGFja2FnZShzdHJ1Y3Qg
aW50ZWxfY3NyICpjc3IsCiAJCXJldHVybiAwOwogCX0KIAotCXIgPSBzaXplb2Yoc3RydWN0IGlu
dGVsX3BhY2thZ2VfaGVhZGVyKTsKLQotCS8qIHdlIGFsd2F5cyBoYXZlIHNwYWNlIGZvciBtYXhf
ZW50cmllcywgZXZlbiBpZiBub3QgYWxsIGFyZSB1c2VkICovCi0JciArPSBtYXhfZW50cmllcyAq
IHNpemVvZihzdHJ1Y3QgaW50ZWxfZndfaW5mbyk7Ci0KIAkvKiBkbWNfb2Zmc2V0IGlzIGluIGR3
b3JkcyAqLwotCXIgKz0gZG1jX29mZnNldCAqIDQ7CisJcmV0dXJuIHBhY2thZ2Vfc2l6ZSArIGRt
Y19vZmZzZXQgKiA0OwogCi0JcmV0dXJuIHI7CitlcnJvcl90cnVuY2F0ZWQ6CisJRFJNX0VSUk9S
KCJUcnVuY2F0ZWQgRE1DIGZpcm13YXJlLCByZWZ1c2luZy5cbiIpOworCXJldHVybiAwOwogfQog
CiAvKiBSZXR1cm4gbnVtYmVyIG9mIGJ5dGVzIHBhcnNlZCBvciAwIG9uIGVycm9yICovCiBzdGF0
aWMgdTMyIHBhcnNlX2Nzcl9md19jc3Moc3RydWN0IGludGVsX2NzciAqY3NyLAotCQkJICAgIHN0
cnVjdCBpbnRlbF9jc3NfaGVhZGVyICpjc3NfaGVhZGVyKQorCQkJICAgIHN0cnVjdCBpbnRlbF9j
c3NfaGVhZGVyICpjc3NfaGVhZGVyLAorCQkJICAgIHNpemVfdCByZW1fc2l6ZSkKIHsKKwlpZiAo
cmVtX3NpemUgPCBzaXplb2Yoc3RydWN0IGludGVsX2Nzc19oZWFkZXIpKSB7CisJCURSTV9FUlJP
UigiVHJ1bmNhdGVkIERNQyBmaXJtd2FyZSwgcmVmdXNpbmcuXG4iKTsKKwkJcmV0dXJuIDA7CisJ
fQorCiAJaWYgKHNpemVvZihzdHJ1Y3QgaW50ZWxfY3NzX2hlYWRlcikgIT0KIAkgICAgKGNzc19o
ZWFkZXItPmhlYWRlcl9sZW4gKiA0KSkgewogCQlEUk1fRVJST1IoIkRNQyBmaXJtd2FyZSBoYXMg
d3JvbmcgQ1NTIGhlYWRlciBsZW5ndGggIgpAQCAtNTMwLDI5ICs1NjAsMzQgQEAgc3RhdGljIHZv
aWQgcGFyc2VfY3NyX2Z3KHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiwKIAljb25z
dCBzdHJ1Y3Qgc3RlcHBpbmdfaW5mbyAqc2kgPSBpbnRlbF9nZXRfc3RlcHBpbmdfaW5mbyhkZXZf
cHJpdik7CiAJdTMyIHJlYWRjb3VudCA9IDA7CiAJdTMyIHI7CisJc2l6ZV90IHJlbV9zaXplOwog
CiAJaWYgKCFmdykKIAkJcmV0dXJuOwogCisJcmVtX3NpemUgPSBmdy0+c2l6ZTsKKwogCS8qIEV4
dHJhY3QgQ1NTIEhlYWRlciBpbmZvcm1hdGlvbiovCiAJY3NzX2hlYWRlciA9IChzdHJ1Y3QgaW50
ZWxfY3NzX2hlYWRlciAqKWZ3LT5kYXRhOwotCXIgPSBwYXJzZV9jc3JfZndfY3NzKGNzciwgY3Nz
X2hlYWRlcik7CisJciA9IHBhcnNlX2Nzcl9md19jc3MoY3NyLCBjc3NfaGVhZGVyLCByZW1fc2l6
ZSk7CiAJaWYgKCFyKQogCQlyZXR1cm47CiAKKwlyZW1fc2l6ZSAtPSByOwogCXJlYWRjb3VudCAr
PSByOwogCiAJLyogRXh0cmFjdCBQYWNrYWdlIEhlYWRlciBpbmZvcm1hdGlvbiovCiAJcGFja2Fn
ZV9oZWFkZXIgPSAoc3RydWN0IGludGVsX3BhY2thZ2VfaGVhZGVyICopJmZ3LT5kYXRhW3JlYWRj
b3VudF07Ci0JciA9IHBhcnNlX2Nzcl9md19wYWNrYWdlKGNzciwgcGFja2FnZV9oZWFkZXIsIHNp
KTsKKwlyID0gcGFyc2VfY3NyX2Z3X3BhY2thZ2UoY3NyLCBwYWNrYWdlX2hlYWRlciwgc2ksIHJl
bV9zaXplKTsKIAlpZiAoIXIpCiAJCXJldHVybjsKIAorCXJlbV9zaXplIC09IHI7CiAJcmVhZGNv
dW50ICs9IHI7CiAKIAkvKiBFeHRyYWN0IGRtY19oZWFkZXIgaW5mb3JtYXRpb24uICovCiAJZG1j
X2hlYWRlciA9IChzdHJ1Y3QgaW50ZWxfZG1jX2hlYWRlcl9iYXNlICopJmZ3LT5kYXRhW3JlYWRj
b3VudF07Ci0JcGFyc2VfY3NyX2Z3X2RtYyhjc3IsIGRtY19oZWFkZXIpOworCXBhcnNlX2Nzcl9m
d19kbWMoY3NyLCBkbWNfaGVhZGVyLCByZW1fc2l6ZSk7CiB9CiAKIHN0YXRpYyB2b2lkIGludGVs
X2Nzcl9ydW50aW1lX3BtX2dldChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2X3ByaXYpCi0t
IAoyLjIxLjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
CkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpo
dHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWdmeA==

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 2F4147E225
	for <lists+intel-gfx@lfdr.de>; Thu,  1 Aug 2019 20:27:20 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 2ED6D6E76C;
	Thu,  1 Aug 2019 18:27:17 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 79B056E76A
 for <intel-gfx@lists.freedesktop.org>; Thu,  1 Aug 2019 18:27:15 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17796131-1500050 
 for multiple; Thu, 01 Aug 2019 19:26:59 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Thu,  1 Aug 2019 19:26:56 +0100
Message-Id: <20190801182657.5311-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0.rc0
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 1/2] drm/i915/pmu: Atomically acquire the gt_pm
 wakeref
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

Q3VycmVudGx5LCB3ZSBvbmx5IHNhbXBsZSBpZiB0aGUgaW50ZWxfZ3QgaXMgYXdha2UsIGJ1dCB3
ZSBhY3F1aXJlIG91cgpvd24gcnVudGltZV9wbSB3YWtlcmVmLiBTaW5jZSBpbnRlbF9ndCBoYXMg
dHJhbnNpdGlvbmVkIHRvIHRyYWNraW5nIGl0cwpvd24gd2FrZXJlZiwgd2UgY2FuIGF0b21pY2Fs
bHkgdGVzdCBhbmQgYWNxdWlyZSB0aGF0IHdha2VyZWYgaW5zdGVhZC4KCnYyOiBUYWtlIGVuZ2lu
ZS0+d2FrZXJlZiBmb3IgZW5naW5lIHNhbXBsaW5nCgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxz
b24gPGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KQ2M6IFR2cnRrbyBVcnN1bGluIDx0dnJ0a28u
dXJzdWxpbkBpbnRlbC5jb20+ClJldmlld2VkLWJ5OiBUdnJ0a28gVXJzdWxpbiA8dHZydGtvLnVy
c3VsaW5AaW50ZWwuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2d0X3Bt
LmggfCAgOCArKysrKy0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcG11LmMgICAgICAgfCA0
MCArKysrKysrKysrKystLS0tLS0tLS0tLS0tLS0KIDIgZmlsZXMgY2hhbmdlZCwgMjUgaW5zZXJ0
aW9ucygrKSwgMjMgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ3QvaW50ZWxfZ3RfcG0uaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2d0X3Bt
LmgKaW5kZXggNTI3ODk0ZmUxMzQ1Li5lOGExOGQ0YjI3YzkgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2d0L2ludGVsX2d0X3BtLmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUv
Z3QvaW50ZWxfZ3RfcG0uaApAQCAtOSw3ICs5LDggQEAKIAogI2luY2x1ZGUgPGxpbnV4L3R5cGVz
Lmg+CiAKLXN0cnVjdCBpbnRlbF9ndDsKKyNpbmNsdWRlICJpbnRlbF9ndF90eXBlcy5oIgorI2lu
Y2x1ZGUgImludGVsX3dha2VyZWYuaCIKIAogZW51bSB7CiAJSU5URUxfR1RfVU5QQVJLLApAQCAt
MTksNiArMjAsMTEgQEAgZW51bSB7CiB2b2lkIGludGVsX2d0X3BtX2dldChzdHJ1Y3QgaW50ZWxf
Z3QgKmd0KTsKIHZvaWQgaW50ZWxfZ3RfcG1fcHV0KHN0cnVjdCBpbnRlbF9ndCAqZ3QpOwogCitz
dGF0aWMgaW5saW5lIGJvb2wgaW50ZWxfZ3RfcG1fZ2V0X2lmX2F3YWtlKHN0cnVjdCBpbnRlbF9n
dCAqZ3QpCit7CisJcmV0dXJuIGludGVsX3dha2VyZWZfZ2V0X2lmX2FjdGl2ZSgmZ3QtPndha2Vy
ZWYpOworfQorCiB2b2lkIGludGVsX2d0X3BtX2luaXRfZWFybHkoc3RydWN0IGludGVsX2d0ICpn
dCk7CiAKIHZvaWQgaW50ZWxfZ3Rfc2FuaXRpemUoc3RydWN0IGludGVsX2d0ICpndCwgYm9vbCBm
b3JjZSk7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3BtdS5jIGIvZHJp
dmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wbXUuYwppbmRleCBlZmY4NjQ4M2JlYzAuLjRkN2NhYmVl
YTY4NyAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wbXUuYworKysgYi9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3BtdS5jCkBAIC04LDYgKzgsOCBAQAogI2luY2x1ZGUg
PGxpbnV4L3BtX3J1bnRpbWUuaD4KIAogI2luY2x1ZGUgImd0L2ludGVsX2VuZ2luZS5oIgorI2lu
Y2x1ZGUgImd0L2ludGVsX2VuZ2luZV9wbS5oIgorI2luY2x1ZGUgImd0L2ludGVsX2d0X3BtLmgi
CiAKICNpbmNsdWRlICJpOTE1X2Rydi5oIgogI2luY2x1ZGUgImk5MTVfcG11LmgiCkBAIC0xNjEs
MjcgKzE2MywyNCBAQCBlbmdpbmVzX3NhbXBsZShzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqZGV2
X3ByaXYsIHVuc2lnbmVkIGludCBwZXJpb2RfbnMpCiB7CiAJc3RydWN0IGludGVsX2VuZ2luZV9j
cyAqZW5naW5lOwogCWVudW0gaW50ZWxfZW5naW5lX2lkIGlkOwotCWludGVsX3dha2VyZWZfdCB3
YWtlcmVmOwotCXVuc2lnbmVkIGxvbmcgZmxhZ3M7CiAKIAlpZiAoKGRldl9wcml2LT5wbXUuZW5h
YmxlICYgRU5HSU5FX1NBTVBMRV9NQVNLKSA9PSAwKQogCQlyZXR1cm47CiAKLQl3YWtlcmVmID0g
MDsKLQlpZiAoUkVBRF9PTkNFKGRldl9wcml2LT5ndC5hd2FrZSkpCi0JCXdha2VyZWYgPSBpbnRl
bF9ydW50aW1lX3BtX2dldF9pZl9pbl91c2UoJmRldl9wcml2LT5ydW50aW1lX3BtKTsKLQlpZiAo
IXdha2VyZWYpCi0JCXJldHVybjsKLQotCXNwaW5fbG9ja19pcnFzYXZlKCZkZXZfcHJpdi0+dW5j
b3JlLmxvY2ssIGZsYWdzKTsKIAlmb3JfZWFjaF9lbmdpbmUoZW5naW5lLCBkZXZfcHJpdiwgaWQp
IHsKIAkJc3RydWN0IGludGVsX2VuZ2luZV9wbXUgKnBtdSA9ICZlbmdpbmUtPnBtdTsKKwkJdW5z
aWduZWQgbG9uZyBmbGFnczsKIAkJYm9vbCBidXN5OwogCQl1MzIgdmFsOwogCisJCWlmICghaW50
ZWxfZW5naW5lX3BtX2dldF9pZl9hd2FrZShlbmdpbmUpKQorCQkJY29udGludWU7CisKKwkJc3Bp
bl9sb2NrX2lycXNhdmUoJmRldl9wcml2LT51bmNvcmUubG9jaywgZmxhZ3MpOworCiAJCXZhbCA9
IEk5MTVfUkVBRF9GVyhSSU5HX0NUTChlbmdpbmUtPm1taW9fYmFzZSkpOwogCQlpZiAodmFsID09
IDApIC8qIHBvd2Vyd2VsbCBvZmYgPT4gZW5naW5lIGlkbGUgKi8KLQkJCWNvbnRpbnVlOworCQkJ
Z290byBza2lwOwogCiAJCWlmICh2YWwgJiBSSU5HX1dBSVQpCiAJCQlhZGRfc2FtcGxlKCZwbXUt
PnNhbXBsZVtJOTE1X1NBTVBMRV9XQUlUXSwgcGVyaW9kX25zKTsKQEAgLTIwMiwxMCArMjAxLDEx
IEBAIGVuZ2luZXNfc2FtcGxlKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiwgdW5z
aWduZWQgaW50IHBlcmlvZF9ucykKIAkJfQogCQlpZiAoYnVzeSkKIAkJCWFkZF9zYW1wbGUoJnBt
dS0+c2FtcGxlW0k5MTVfU0FNUExFX0JVU1ldLCBwZXJpb2RfbnMpOwotCX0KLQlzcGluX3VubG9j
a19pcnFyZXN0b3JlKCZkZXZfcHJpdi0+dW5jb3JlLmxvY2ssIGZsYWdzKTsKIAotCWludGVsX3J1
bnRpbWVfcG1fcHV0KCZkZXZfcHJpdi0+cnVudGltZV9wbSwgd2FrZXJlZik7Citza2lwOgorCQlz
cGluX3VubG9ja19pcnFyZXN0b3JlKCZkZXZfcHJpdi0+dW5jb3JlLmxvY2ssIGZsYWdzKTsKKwkJ
aW50ZWxfZW5naW5lX3BtX3B1dChlbmdpbmUpOworCX0KIH0KIAogc3RhdGljIHZvaWQKQEAgLTIy
MiwxNSArMjIyLDExIEBAIGZyZXF1ZW5jeV9zYW1wbGUoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUg
KmRldl9wcml2LCB1bnNpZ25lZCBpbnQgcGVyaW9kX25zKQogCQl1MzIgdmFsOwogCiAJCXZhbCA9
IGRldl9wcml2LT5ndF9wbS5ycHMuY3VyX2ZyZXE7Ci0JCWlmIChkZXZfcHJpdi0+Z3QuYXdha2Up
IHsKLQkJCWludGVsX3dha2VyZWZfdCB3YWtlcmVmOwotCi0JCQl3aXRoX2ludGVsX3J1bnRpbWVf
cG1faWZfaW5fdXNlKCZkZXZfcHJpdi0+cnVudGltZV9wbSwKLQkJCQkJCQl3YWtlcmVmKSB7Ci0J
CQkJdmFsID0gaW50ZWxfdW5jb3JlX3JlYWRfbm90cmFjZSgmZGV2X3ByaXYtPnVuY29yZSwKLQkJ
CQkJCQkJR0VONl9SUFNUQVQxKTsKLQkJCQl2YWwgPSBpbnRlbF9nZXRfY2FnZihkZXZfcHJpdiwg
dmFsKTsKLQkJCX0KKwkJaWYgKGludGVsX2d0X3BtX2dldF9pZl9hd2FrZSgmZGV2X3ByaXYtPmd0
KSkgeworCQkJdmFsID0gaW50ZWxfdW5jb3JlX3JlYWRfbm90cmFjZSgmZGV2X3ByaXYtPnVuY29y
ZSwKKwkJCQkJCQlHRU42X1JQU1RBVDEpOworCQkJdmFsID0gaW50ZWxfZ2V0X2NhZ2YoZGV2X3By
aXYsIHZhbCk7CisJCQlpbnRlbF9ndF9wbV9wdXQoJmRldl9wcml2LT5ndCk7CiAJCX0KIAogCQlh
ZGRfc2FtcGxlX211bHQoJmRldl9wcml2LT5wbXUuc2FtcGxlW19fSTkxNV9TQU1QTEVfRlJFUV9B
Q1RdLAotLSAKMi4yMy4wLnJjMAoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX18KSW50ZWwtZ2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRl
c2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8v
aW50ZWwtZ2Z4

Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 5D14F1410A9
	for <lists+intel-gfx@lfdr.de>; Fri, 17 Jan 2020 19:19:52 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 51C496F89A;
	Fri, 17 Jan 2020 18:19:47 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id B75D76F898;
 Fri, 17 Jan 2020 18:19:44 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 19921009-1500050 
 for multiple; Fri, 17 Jan 2020 18:19:30 +0000
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Fri, 17 Jan 2020 18:19:24 +0000
Message-Id: <20200117181925.3249942-4-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.25.0
In-Reply-To: <20200117181925.3249942-1-chris@chris-wilson.co.uk>
References: <20200117181925.3249942-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH i-g-t 4/5] i915/gem_render_copy.c: Simplify code
 by switch to rendercopy bufmgr
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: igt-dev@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

RnJvbTogWmJpZ25pZXcgS2VtcGN6ecWEc2tpIDx6Ymlnbmlldy5rZW1wY3p5bnNraUBpbnRlbC5j
b20+CgpTd2l0Y2ggdG8gcmVuZGVyY29weSBidWZtZ3IgdG8gc2ltcGxpZnkgd29ya2luZyB3aXRo
IHRpbGVkIHN1cmZhY2VzLgoKU2lnbmVkLW9mZi1ieTogWmJpZ25pZXcgS2VtcGN6ecWEc2tpIDx6
Ymlnbmlldy5rZW1wY3p5bnNraUBpbnRlbC5jb20+CkNjOiBDaHJpcyBXaWxzb24gPGNocmlzQGNo
cmlzLXdpbHNvbi5jby51az4KQ2M6IEthdGFyenluYSBEZWMgPGthdGFyenluYS5kZWNAaW50ZWwu
Y29tPgotLS0KIHRlc3RzL2k5MTUvZ2VtX3JlbmRlcl9jb3B5LmMgfCA0MjIgKysrKysrKysrKy0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KIDEgZmlsZSBjaGFuZ2VkLCAxMTYgaW5zZXJ0aW9ucygr
KSwgMzA2IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL3Rlc3RzL2k5MTUvZ2VtX3JlbmRlcl9j
b3B5LmMgYi90ZXN0cy9pOTE1L2dlbV9yZW5kZXJfY29weS5jCmluZGV4IDVhYmIyMDM2Ny4uMjIw
MTY0MjQ3IDEwMDY0NAotLS0gYS90ZXN0cy9pOTE1L2dlbV9yZW5kZXJfY29weS5jCisrKyBiL3Rl
c3RzL2k5MTUvZ2VtX3JlbmRlcl9jb3B5LmMKQEAgLTQ3LDYgKzQ3LDcgQEAKICNpbmNsdWRlIDxk
cm0uaD4KIAogI2luY2x1ZGUgImludGVsX2J1Zm1nci5oIgorI2luY2x1ZGUgInJlbmRlcmNvcHlf
YnVmbWdyLmgiCiAKIElHVF9URVNUX0RFU0NSSVBUSU9OKCJCYXNpYyB0ZXN0IGZvciB0aGUgcmVu
ZGVyX2NvcHkoKSBmdW5jdGlvbi4iKTsKIApAQCAtNjAsOSArNjEsMTEgQEAgdHlwZWRlZiBzdHJ1
Y3QgewogCXN0cnVjdCBpbnRlbF9iYXRjaGJ1ZmZlciAqYmF0Y2g7CiAJaWd0X3JlbmRlcl9jb3B5
ZnVuY190IHJlbmRlcl9jb3B5OwogCWlndF92ZWJveF9jb3B5ZnVuY190IHZlYm94X2NvcHk7CisJ
c3RydWN0IHJlbmRlcmNvcHlfYnVmbWdyICpibWdyOwogfSBkYXRhX3Q7CiBzdGF0aWMgaW50IG9w
dF9kdW1wX3BuZyA9IGZhbHNlOwogc3RhdGljIGludCBjaGVja19hbGxfcGl4ZWxzID0gZmFsc2U7
CitzdGF0aWMgYm9vbCBkdW1wX2NvbXByZXNzZWRfc3JjX2J1ZiA9IGZhbHNlOwogCiBzdGF0aWMg
Y29uc3QgY2hhciAqbWFrZV9maWxlbmFtZShjb25zdCBjaGFyICpmaWxlbmFtZSkKIHsKQEAgLTcz
LDEzMSArNzYsMTMgQEAgc3RhdGljIGNvbnN0IGNoYXIgKm1ha2VfZmlsZW5hbWUoY29uc3QgY2hh
ciAqZmlsZW5hbWUpCiAJcmV0dXJuIGJ1ZjsKIH0KIAotc3RhdGljIHZvaWQgKnlmX3B0cih2b2lk
ICpwdHIsCi0JCSAgICB1bnNpZ25lZCBpbnQgeCwgdW5zaWduZWQgaW50IHksCi0JCSAgICB1bnNp
Z25lZCBpbnQgc3RyaWRlLCB1bnNpZ25lZCBpbnQgY3BwKQorc3RhdGljIHZvaWQgKmFsbG9jX2Fs
aWduZWQodWludDY0X3Qgc2l6ZSkKIHsKLQljb25zdCBpbnQgdGlsZV9zaXplID0gNCAqIDEwMjQ7
Ci0JY29uc3QgaW50IHRpbGVfd2lkdGggPSAxMjg7Ci0JaW50IHJvd19zaXplID0gKHN0cmlkZSAv
IHRpbGVfd2lkdGgpICogdGlsZV9zaXplOworCXZvaWQgKnA7CiAKLQl4ICo9IGNwcDsgLyogY29u
dmVydCB0byBCeXRlIG9mZnNldCAqLworCWlndF9hc3NlcnRfZXEocG9zaXhfbWVtYWxpZ24oJnAs
IDE2LCBzaXplKSwgMCk7CiAKLQotCS8qCi0JICogV2l0aGluIGEgNGsgWWYgdGlsZSwgdGhlIGJ5
dGUgc3dpenpsaW5nIHBhdHRlcm4gaXMKLQkgKiBtc2IuLi4uLi5sc2IKLQkgKiB4eXh5eHl5eXh4
eHgKLQkgKiBUaGUgdGlsZXMgdGhlbXNlbHZlcyBhcmUgbGFpZCBvdXQgaW4gcm93IG1ham9yIG9y
ZGVyLgotCSAqLwotCXJldHVybiBwdHIgKwotCQkoKHggJiAweGYpICogMSkgKyAvKiA0eDEgcGl4
ZWxzKDMyYnBwKSA9IDE2QiAqLwotCQkoKHkgJiAweDMpICogMTYpICsgLyogNHg0IHBpeGVscyA9
IDY0QiAqLwotCQkoKCh5ICYgMHg0KSA+PiAyKSAqIDY0KSArIC8qIDF4MiA2NEIgYmxvY2tzICov
Ci0JCSgoKHggJiAweDEwKSA+PiA0KSAqIDEyOCkgKyAvKiAyeDIgNjRCIGJsb2NrcyA9IDI1NkIg
YmxvY2sgKi8KLQkJKCgoeSAmIDB4OCkgPj4gMykgKiAyNTYpICsgLyogMngxIDI1NkIgYmxvY2tz
ICovCi0JCSgoKHggJiAweDIwKSA+PiA1KSAqIDUxMikgKyAvKiAyeDIgMjU2QiBibG9ja3MgKi8K
LQkJKCgoeSAmIDB4MTApID4+IDQpICogMTAyNCkgKyAvKiA0eDIgMjU2IGJsb2NrcyAqLwotCQko
KCh4ICYgMHg0MCkgPj4gNikgKiAyMDQ4KSArIC8qIDR4NCAyNTZCIGJsb2NrcyA9IDRrIHRpbGUg
Ki8KLQkJKCgoeCAmIH4weDdmKSA+PiA3KSAqIHRpbGVfc2l6ZSkgKyAvKiByb3cgb2YgdGlsZXMg
Ki8KLQkJKCgoeSAmIH4weDFmKSA+PiA1KSAqIHJvd19zaXplKTsKLX0KLQotc3RhdGljIHZvaWQg
Y29weV9saW5lYXJfdG9feWYoZGF0YV90ICpkYXRhLCBzdHJ1Y3QgaWd0X2J1ZiAqYnVmLAotCQkJ
ICAgICAgY29uc3QgdWludDMyX3QgKmxpbmVhcikKLXsKLQlpbnQgaGVpZ2h0ID0gaWd0X2J1Zl9o
ZWlnaHQoYnVmKTsKLQlpbnQgd2lkdGggPSBpZ3RfYnVmX3dpZHRoKGJ1Zik7Ci0Jdm9pZCAqbWFw
OwotCi0JZ2VtX3NldF9kb21haW4oZGF0YS0+ZHJtX2ZkLCBidWYtPmJvLT5oYW5kbGUsCi0JCSAg
ICAgICBJOTE1X0dFTV9ET01BSU5fQ1BVLCBJOTE1X0dFTV9ET01BSU5fQ1BVKTsKLQltYXAgPSBn
ZW1fbW1hcF9fY3B1KGRhdGEtPmRybV9mZCwgYnVmLT5iby0+aGFuZGxlLCAwLAotCQkJICAgIGJ1
Zi0+Ym8tPnNpemUsIFBST1RfUkVBRCB8IFBST1RfV1JJVEUpOwotCi0JZm9yIChpbnQgeSA9IDA7
IHkgPCBoZWlnaHQ7IHkrKykgewotCQlmb3IgKGludCB4ID0gMDsgeCA8IHdpZHRoOyB4KyspIHsK
LQkJCXVpbnQzMl90ICpwdHIgPSB5Zl9wdHIobWFwLCB4LCB5LAotCQkJCQkgICAgICAgYnVmLT5z
dXJmYWNlWzBdLnN0cmlkZSwKLQkJCQkJICAgICAgIGJ1Zi0+YnBwIC8gOCk7Ci0KLQkJCSpwdHIg
PSBsaW5lYXJbeSAqIHdpZHRoICsgeF07Ci0JCX0KLQl9Ci0KLQltdW5tYXAobWFwLCBidWYtPmJv
LT5zaXplKTsKLX0KLQotc3RhdGljIHZvaWQgY29weV95Zl90b19saW5lYXIoZGF0YV90ICpkYXRh
LCBzdHJ1Y3QgaWd0X2J1ZiAqYnVmLAotCQkJICAgICAgdWludDMyX3QgKmxpbmVhcikKLXsKLQlp
bnQgaGVpZ2h0ID0gaWd0X2J1Zl9oZWlnaHQoYnVmKTsKLQlpbnQgd2lkdGggPSBpZ3RfYnVmX3dp
ZHRoKGJ1Zik7Ci0Jdm9pZCAqbWFwOwotCi0JZ2VtX3NldF9kb21haW4oZGF0YS0+ZHJtX2ZkLCBi
dWYtPmJvLT5oYW5kbGUsCi0JCSAgICAgICBJOTE1X0dFTV9ET01BSU5fQ1BVLCAwKTsKLQltYXAg
PSBnZW1fbW1hcF9fY3B1KGRhdGEtPmRybV9mZCwgYnVmLT5iby0+aGFuZGxlLCAwLAotCQkJICAg
IGJ1Zi0+Ym8tPnNpemUsIFBST1RfUkVBRCk7Ci0KLQlmb3IgKGludCB5ID0gMDsgeSA8IGhlaWdo
dDsgeSsrKSB7Ci0JCWZvciAoaW50IHggPSAwOyB4IDwgd2lkdGg7IHgrKykgewotCQkJdWludDMy
X3QgKnB0ciA9IHlmX3B0cihtYXAsIHgsIHksCi0JCQkJCSAgICAgICBidWYtPnN1cmZhY2VbMF0u
c3RyaWRlLAotCQkJCQkgICAgICAgYnVmLT5icHAgLyA4KTsKLQotCQkJbGluZWFyW3kgKiB3aWR0
aCArIHhdID0gKnB0cjsKLQkJfQotCX0KLQotCW11bm1hcChtYXAsIGJ1Zi0+Ym8tPnNpemUpOwot
fQotCi1zdGF0aWMgdm9pZCBjb3B5X2xpbmVhcl90b19ndHQoZGF0YV90ICpkYXRhLCBzdHJ1Y3Qg
aWd0X2J1ZiAqYnVmLAotCQkJICAgICAgIGNvbnN0IHVpbnQzMl90ICpsaW5lYXIpCi17Ci0Jdm9p
ZCAqbWFwOwotCi0JZ2VtX3NldF9kb21haW4oZGF0YS0+ZHJtX2ZkLCBidWYtPmJvLT5oYW5kbGUs
Ci0JCSAgICAgICBJOTE1X0dFTV9ET01BSU5fR1RULCBJOTE1X0dFTV9ET01BSU5fR1RUKTsKLQot
CW1hcCA9IGdlbV9tbWFwX19ndHQoZGF0YS0+ZHJtX2ZkLCBidWYtPmJvLT5oYW5kbGUsCi0JCQkg
ICAgYnVmLT5iby0+c2l6ZSwgUFJPVF9SRUFEIHwgUFJPVF9XUklURSk7Ci0KLQltZW1jcHkobWFw
LCBsaW5lYXIsIGJ1Zi0+Ym8tPnNpemUpOwotCi0JbXVubWFwKG1hcCwgYnVmLT5iby0+c2l6ZSk7
Ci19Ci0KLXN0YXRpYyB2b2lkIGNvcHlfZ3R0X3RvX2xpbmVhcihkYXRhX3QgKmRhdGEsIHN0cnVj
dCBpZ3RfYnVmICpidWYsCi0JCQkgICAgICAgdWludDMyX3QgKmxpbmVhcikKLXsKLQl2b2lkICpt
YXA7Ci0KLQlnZW1fc2V0X2RvbWFpbihkYXRhLT5kcm1fZmQsIGJ1Zi0+Ym8tPmhhbmRsZSwKLQkJ
ICAgICAgIEk5MTVfR0VNX0RPTUFJTl9HVFQsIDApOwotCi0JbWFwID0gZ2VtX21tYXBfX2d0dChk
YXRhLT5kcm1fZmQsIGJ1Zi0+Ym8tPmhhbmRsZSwKLQkJCSAgICBidWYtPmJvLT5zaXplLCBQUk9U
X1JFQUQpOwotCi0JaWd0X21lbWNweV9mcm9tX3djKGxpbmVhciwgbWFwLCBidWYtPmJvLT5zaXpl
KTsKLQotCW11bm1hcChtYXAsIGJ1Zi0+Ym8tPnNpemUpOwotfQotCi1zdGF0aWMgdm9pZCAqbGlu
ZWFyX2NvcHkoZGF0YV90ICpkYXRhLCBzdHJ1Y3QgaWd0X2J1ZiAqYnVmKQotewotCXZvaWQgKmxp
bmVhcjsKLQotCS8qIDE2QiBhbGlnbm1lbnQgYWxsb3dzIHRvIHBvdGVudGlhbGx5IG1ha2UgdXNl
IG9mIFNTRTQgZm9yIGNvcHlpbmcgKi8KLQlpZ3RfYXNzZXJ0X2VxKHBvc2l4X21lbWFsaWduKCZs
aW5lYXIsIDE2LCBidWYtPmJvLT5zaXplKSwgMCk7Ci0KLQlpZiAoYnVmLT50aWxpbmcgPT0gSTkx
NV9USUxJTkdfWWYpCi0JCWNvcHlfeWZfdG9fbGluZWFyKGRhdGEsIGJ1ZiwgbGluZWFyKTsKLQll
bHNlCi0JCWNvcHlfZ3R0X3RvX2xpbmVhcihkYXRhLCBidWYsIGxpbmVhcik7Ci0KLQlyZXR1cm4g
bGluZWFyOworCXJldHVybiBwOwogfQogCiBzdGF0aWMgdm9pZApAQCAtMjA5LDEzICs5NCwxMyBA
QCBjb3B5X2Zyb21fbGluZWFyX2J1ZihkYXRhX3QgKmRhdGEsIHN0cnVjdCBpZ3RfYnVmICpzcmMs
IHN0cnVjdCBpZ3RfYnVmICpkc3QpCiAKIAlnZW1fc2V0X2RvbWFpbihkYXRhLT5kcm1fZmQsIHNy
Yy0+Ym8tPmhhbmRsZSwKIAkJICAgICAgIEk5MTVfR0VNX0RPTUFJTl9DUFUsIDApOwotCWxpbmVh
ciA9IGdlbV9tbWFwX19jcHUoZGF0YS0+ZHJtX2ZkLCBzcmMtPmJvLT5oYW5kbGUsIDAsCi0JCQkg
ICAgICAgc3JjLT5iby0+c2l6ZSwgUFJPVF9SRUFEKTsKKwlsaW5lYXIgPSBfX2dlbV9tbWFwX29m
ZnNldF9fY3B1KGRhdGEtPmRybV9mZCwgc3JjLT5iby0+aGFuZGxlLCAwLAorCQkJCQlzcmMtPmJv
LT5zaXplLCBQUk9UX1JFQUQpOworCWlmICghbGluZWFyKQorCQlsaW5lYXIgPSBnZW1fbW1hcF9f
Y3B1KGRhdGEtPmRybV9mZCwgc3JjLT5iby0+aGFuZGxlLCAwLAorCQkJCSAgICAgICBzcmMtPmJv
LT5zaXplLCBQUk9UX1JFQUQpOwogCi0JaWYgKGRzdC0+dGlsaW5nID09IEk5MTVfVElMSU5HX1lm
KQotCQljb3B5X2xpbmVhcl90b195ZihkYXRhLCBkc3QsIGxpbmVhcik7Ci0JZWxzZQotCQljb3B5
X2xpbmVhcl90b19ndHQoZGF0YSwgZHN0LCBsaW5lYXIpOworCWxpbmVhcl90b19pZ3RfYnVmKGRh
dGEtPmJtZ3IsIGRzdCwgbGluZWFyKTsKIAogCW11bm1hcChsaW5lYXIsIHNyYy0+Ym8tPnNpemUp
OwogfQpAQCAtMjI3LDcgKzExMiw4IEBAIHN0YXRpYyB2b2lkIHNjcmF0Y2hfYnVmX3dyaXRlX3Rv
X3BuZyhkYXRhX3QgKmRhdGEsIHN0cnVjdCBpZ3RfYnVmICpidWYsCiAJY2Fpcm9fc3RhdHVzX3Qg
cmV0OwogCXZvaWQgKmxpbmVhcjsKIAotCWxpbmVhciA9IGxpbmVhcl9jb3B5KGRhdGEsIGJ1Zik7
CisJbGluZWFyID0gYWxsb2NfYWxpZ25lZChidWYtPmJvLT5zaXplKTsKKwlpZ3RfYnVmX3RvX2xp
bmVhcihkYXRhLT5ibWdyLCBidWYsIGxpbmVhcik7CiAKIAlzdXJmYWNlID0gY2Fpcm9faW1hZ2Vf
c3VyZmFjZV9jcmVhdGVfZm9yX2RhdGEobGluZWFyLAogCQkJCQkJICAgICAgQ0FJUk9fRk9STUFU
X1JHQjI0LApAQCAtMjQxLDY3ICsxMjcsNDEgQEAgc3RhdGljIHZvaWQgc2NyYXRjaF9idWZfd3Jp
dGVfdG9fcG5nKGRhdGFfdCAqZGF0YSwgc3RydWN0IGlndF9idWYgKmJ1ZiwKIAlmcmVlKGxpbmVh
cik7CiB9CiAKLXN0YXRpYyBpbnQgc2NyYXRjaF9idWZfYXV4X3dpZHRoKHVpbnQzMl90IGRldmlk
LCBjb25zdCBzdHJ1Y3QgaWd0X2J1ZiAqYnVmKQorc3RhdGljIHZvaWQgKmxpbmVhcl9jb3B5X2Nj
cyhkYXRhX3QgKmRhdGEsIHN0cnVjdCBpZ3RfYnVmICpidWYpCiB7Ci0JLyoKLQkgKiBHRU4xMis6
IFRoZSBBVVggQ0NTIHVuaXQgc2l6ZSBpcyA2NCBieXRlcyBtYXBwaW5nIDQgbWFpbiBzdXJmYWNl
Ci0JICogdGlsZXMuIFRodXMgdGhlIHdpZHRoIG9mIHRoZSBDQ1MgdW5pdCBpcyA0KjMyPTEyOCBw
aXhlbHMgb24gdGhlCi0JICogbWFpbiBzdXJmYWNlLgotCSAqLwotCWlmIChpbnRlbF9nZW4oZGV2
aWQpID49IDEyKQotCQlyZXR1cm4gRElWX1JPVU5EX1VQKGlndF9idWZfd2lkdGgoYnVmKSwgMTI4
KSAqIDY0OwotCi0JcmV0dXJuIERJVl9ST1VORF9VUChpZ3RfYnVmX3dpZHRoKGJ1ZiksIDEwMjQp
ICogMTI4OwotfQotCi1zdGF0aWMgaW50IHNjcmF0Y2hfYnVmX2F1eF9oZWlnaHQodWludDMyX3Qg
ZGV2aWQsIGNvbnN0IHN0cnVjdCBpZ3RfYnVmICpidWYpCi17Ci0JLyoKLQkgKiBHRU4xMis6IFRo
ZSBBVVggQ0NTIHVuaXQgc2l6ZSBpcyA2NCBieXRlcyBtYXBwaW5nIDQgbWFpbiBzdXJmYWNlCi0J
ICogdGlsZXMuIFRodXMgdGhlIGhlaWdodCBvZiB0aGUgQ0NTIHVuaXQgaXMgMzIgcGl4ZWwgcm93
cyBvbiB0aGUgbWFpbgotCSAqIHN1cmZhY2UuCi0JICovCi0JaWYgKGludGVsX2dlbihkZXZpZCkg
Pj0gMTIpCi0JCXJldHVybiBESVZfUk9VTkRfVVAoaWd0X2J1Zl9oZWlnaHQoYnVmKSwgMzIpOwot
Ci0JcmV0dXJuIERJVl9ST1VORF9VUChpZ3RfYnVmX2hlaWdodChidWYpLCA1MTIpICogMzI7Ci19
Ci0KLXN0YXRpYyB2b2lkICpsaW5lYXJfY29weV9hdXgoZGF0YV90ICpkYXRhLCBzdHJ1Y3QgaWd0
X2J1ZiAqYnVmKQotewotCXZvaWQgKm1hcCwgKmxpbmVhcjsKLQlpbnQgYXV4X3NpemUgPSBzY3Jh
dGNoX2J1Zl9hdXhfd2lkdGgoZGF0YS0+ZGV2aWQsIGJ1ZikgKgotCQlzY3JhdGNoX2J1Zl9hdXhf
aGVpZ2h0KGRhdGEtPmRldmlkLCBidWYpOwotCi0JaWd0X2Fzc2VydF9lcShwb3NpeF9tZW1hbGln
bigmbGluZWFyLCAxNiwgYXV4X3NpemUpLCAwKTsKLQotCWdlbV9zZXRfZG9tYWluKGRhdGEtPmRy
bV9mZCwgYnVmLT5iby0+aGFuZGxlLAotCQkgICAgICAgSTkxNV9HRU1fRE9NQUlOX0dUVCwgMCk7
CisJdm9pZCAqY2NzX2RhdGEsICpsaW5lYXI7CisJaW50IGdlbiA9IGludGVsX2dlbihkYXRhLT5k
ZXZpZCk7CisJaW50IGNjc19zaXplID0gaWd0X2J1Zl9pbnRlbF9jY3Nfd2lkdGgoZ2VuLCBidWYp
ICoKKwkJaWd0X2J1Zl9pbnRlbF9jY3NfaGVpZ2h0KGdlbiwgYnVmKTsKIAotCW1hcCA9IGdlbV9t
bWFwX19ndHQoZGF0YS0+ZHJtX2ZkLCBidWYtPmJvLT5oYW5kbGUsCi0JCQkgICAgYnVmLT5iby0+
c2l6ZSwgUFJPVF9SRUFEKTsKKwljY3NfZGF0YSA9IGFsbG9jX2FsaWduZWQoY2NzX3NpemUpOwor
CWxpbmVhciA9IGFsbG9jX2FsaWduZWQoYnVmLT5iby0+c2l6ZSk7CisJbWVtc2V0KGxpbmVhciwg
MCwgYnVmLT5iby0+c2l6ZSk7CiAKLQlpZ3RfbWVtY3B5X2Zyb21fd2MobGluZWFyLCBtYXAgKyBi
dWYtPmNjc1swXS5vZmZzZXQsIGF1eF9zaXplKTsKKwlpZ3RfYnVmX3RvX2xpbmVhcihkYXRhLT5i
bWdyLCBidWYsIGxpbmVhcik7CisJaWd0X21lbWNweV9mcm9tX3djKGNjc19kYXRhLCBsaW5lYXIg
KyBidWYtPmNjc1swXS5vZmZzZXQsIGNjc19zaXplKTsKIAotCW11bm1hcChtYXAsIGJ1Zi0+Ym8t
PnNpemUpOworCWZyZWUobGluZWFyKTsKIAotCXJldHVybiBsaW5lYXI7CisJcmV0dXJuIGNjc19k
YXRhOwogfQogCi1zdGF0aWMgdm9pZCBzY3JhdGNoX2J1Zl9hdXhfd3JpdGVfdG9fcG5nKGRhdGFf
dCAqZGF0YSwKK3N0YXRpYyB2b2lkIHNjcmF0Y2hfYnVmX2Njc193cml0ZV90b19wbmcoZGF0YV90
ICpkYXRhLAogCQkJCQkgc3RydWN0IGlndF9idWYgKmJ1ZiwKIAkJCQkJIGNvbnN0IGNoYXIgKmZp
bGVuYW1lKQogewogCWNhaXJvX3N1cmZhY2VfdCAqc3VyZmFjZTsKIAljYWlyb19zdGF0dXNfdCBy
ZXQ7CiAJdm9pZCAqbGluZWFyOworCWludCBnZW4gPSBpbnRlbF9nZW4oZGF0YS0+ZGV2aWQpOwor
CXVuc2lnbmVkIGludCBjY3Nfd2lkdGggPSBpZ3RfYnVmX2ludGVsX2Njc193aWR0aChnZW4sIGJ1
Zik7CisJdW5zaWduZWQgaW50IGNjc19oZWlnaHQgPSBpZ3RfYnVmX2ludGVsX2Njc19oZWlnaHQo
Z2VuLCBidWYpOwogCi0JbGluZWFyID0gbGluZWFyX2NvcHlfYXV4KGRhdGEsIGJ1Zik7CisJbGlu
ZWFyID0gbGluZWFyX2NvcHlfY2NzKGRhdGEsIGJ1Zik7CiAKIAlzdXJmYWNlID0gY2Fpcm9faW1h
Z2Vfc3VyZmFjZV9jcmVhdGVfZm9yX2RhdGEobGluZWFyLAogCQkJCQkJICAgICAgQ0FJUk9fRk9S
TUFUX0E4LAotCQkJCQkJICAgICAgc2NyYXRjaF9idWZfYXV4X3dpZHRoKGRhdGEtPmRldmlkLCBi
dWYpLAotCQkJCQkJICAgICAgc2NyYXRjaF9idWZfYXV4X2hlaWdodChkYXRhLT5kZXZpZCwgYnVm
KSwKKwkJCQkJCSAgICAgIGNjc193aWR0aCwgY2NzX2hlaWdodCwKIAkJCQkJCSAgICAgIGJ1Zi0+
Y2NzWzBdLnN0cmlkZSk7CiAJcmV0ID0gY2Fpcm9fc3VyZmFjZV93cml0ZV90b19wbmcoc3VyZmFj
ZSwgbWFrZV9maWxlbmFtZShmaWxlbmFtZSkpOwogCWlndF9hc3NlcnQocmV0ID09IENBSVJPX1NU
QVRVU19TVUNDRVNTKTsKQEAgLTMyMCw3ICsxODAsNyBAQCBzdGF0aWMgdm9pZCBzY3JhdGNoX2J1
Zl9kcmF3X3BhdHRlcm4oZGF0YV90ICpkYXRhLCBzdHJ1Y3QgaWd0X2J1ZiAqYnVmLAogCWNhaXJv
X3QgKmNyOwogCXZvaWQgKmxpbmVhcjsKIAotCWxpbmVhciA9IGxpbmVhcl9jb3B5KGRhdGEsIGJ1
Zik7CisJbGluZWFyID0gYWxsb2NfYWxpZ25lZChidWYtPmJvLT5zaXplKTsKIAogCXN1cmZhY2Ug
PSBjYWlyb19pbWFnZV9zdXJmYWNlX2NyZWF0ZV9mb3JfZGF0YShsaW5lYXIsCiAJCQkJCQkgICAg
ICBDQUlST19GT1JNQVRfUkdCMjQsCkBAIC0zNjEsMTAgKzIyMSw3IEBAIHN0YXRpYyB2b2lkIHNj
cmF0Y2hfYnVmX2RyYXdfcGF0dGVybihkYXRhX3QgKmRhdGEsIHN0cnVjdCBpZ3RfYnVmICpidWYs
CiAKIAljYWlyb19zdXJmYWNlX2Rlc3Ryb3koc3VyZmFjZSk7CiAKLQlpZiAoYnVmLT50aWxpbmcg
PT0gSTkxNV9USUxJTkdfWWYpCi0JCWNvcHlfbGluZWFyX3RvX3lmKGRhdGEsIGJ1ZiwgbGluZWFy
KTsKLQllbHNlCi0JCWNvcHlfbGluZWFyX3RvX2d0dChkYXRhLCBidWYsIGxpbmVhcik7CisJbGlu
ZWFyX3RvX2lndF9idWYoZGF0YS0+Ym1nciwgYnVmLCBsaW5lYXIpOwogCiAJZnJlZShsaW5lYXIp
OwogfQpAQCAtMzc3LDYgKzIzNCw3IEBAIHNjcmF0Y2hfYnVmX2NvcHkoZGF0YV90ICpkYXRhLAog
CWludCB3aWR0aCA9IGlndF9idWZfd2lkdGgoZHN0KTsKIAlpbnQgaGVpZ2h0ICA9IGlndF9idWZf
aGVpZ2h0KGRzdCk7CiAJdWludDMyX3QgKmxpbmVhcl9kc3Q7CisJdWludDMyX3QgKmxpbmVhcl9z
cmM7CiAKIAlpZ3RfYXNzZXJ0X2VxKGlndF9idWZfd2lkdGgoZHN0KSwgaWd0X2J1Zl93aWR0aChz
cmMpKTsKIAlpZ3RfYXNzZXJ0X2VxKGlndF9idWZfaGVpZ2h0KGRzdCksIGlndF9idWZfaGVpZ2h0
KHNyYykpOwpAQCAtMzg5LDQ5ICsyNDcsMjAgQEAgc2NyYXRjaF9idWZfY29weShkYXRhX3QgKmRh
dGEsCiAJaCA9IG1pbihoLCBoZWlnaHQgLSBzeSk7CiAJaCA9IG1pbihoLCBoZWlnaHQgLSBkeSk7
CiAKLQlnZW1fc2V0X2RvbWFpbihkYXRhLT5kcm1fZmQsIGRzdC0+Ym8tPmhhbmRsZSwKLQkJICAg
ICAgIEk5MTVfR0VNX0RPTUFJTl9HVFQsIEk5MTVfR0VNX0RPTUFJTl9HVFQpOwotCWxpbmVhcl9k
c3QgPSBnZW1fbW1hcF9fZ3R0KGRhdGEtPmRybV9mZCwgZHN0LT5iby0+aGFuZGxlLAotCQkJCSAg
IGRzdC0+Ym8tPnNpemUsIFBST1RfV1JJVEUpOwotCi0JaWYgKHNyYy0+dGlsaW5nID09IEk5MTVf
VElMSU5HX1lmKSB7Ci0JCXZvaWQgKm1hcDsKLQotCQlnZW1fc2V0X2RvbWFpbihkYXRhLT5kcm1f
ZmQsIHNyYy0+Ym8tPmhhbmRsZSwKLQkJCSAgICAgICBJOTE1X0dFTV9ET01BSU5fQ1BVLCAwKTsK
LQkJbWFwID0gZ2VtX21tYXBfX2NwdShkYXRhLT5kcm1fZmQsIHNyYy0+Ym8tPmhhbmRsZSwgMCwK
LQkJCQkgICAgc3JjLT5iby0+c2l6ZSwgUFJPVF9SRUFEKTsKLQotCQlmb3IgKGludCB5ID0gMDsg
eSA8IGg7IHkrKykgewotCQkJZm9yIChpbnQgeCA9IDA7IHggPCB3OyB4KyspIHsKLQkJCQljb25z
dCB1aW50MzJfdCAqcHRyID0geWZfcHRyKG1hcCwgc3greCwgc3kreSwKLQkJCQkJCQkgICAgIHNy
Yy0+c3VyZmFjZVswXS5zdHJpZGUsCi0JCQkJCQkJICAgICBzcmMtPmJwcCAvIDgpOwotCi0JCQkJ
bGluZWFyX2RzdFsoZHkreSkgKiB3aWR0aCArIGR4K3hdID0gKnB0cjsKLQkJCX0KLQkJfQotCi0J
CW11bm1hcChtYXAsIHNyYy0+Ym8tPnNpemUpOwotCX0gZWxzZSB7Ci0JCXVpbnQzMl90ICpsaW5l
YXJfc3JjOwotCi0JCWdlbV9zZXRfZG9tYWluKGRhdGEtPmRybV9mZCwgc3JjLT5iby0+aGFuZGxl
LAotCQkJICAgICAgIEk5MTVfR0VNX0RPTUFJTl9HVFQsIDApOwotCi0JCWxpbmVhcl9zcmMgPSBn
ZW1fbW1hcF9fZ3R0KGRhdGEtPmRybV9mZCwgc3JjLT5iby0+aGFuZGxlLAotCQkJCQkgICBzcmMt
PmJvLT5zaXplLCBQUk9UX1JFQUQpOwotCi0JCWZvciAoaW50IHkgPSAwOyB5IDwgaDsgeSsrKSB7
Ci0JCQlpZ3RfbWVtY3B5X2Zyb21fd2MoJmxpbmVhcl9kc3RbKGR5K3kpICogd2lkdGggKyBkeF0s
Ci0JCQkJCSAgICZsaW5lYXJfc3JjWyhzeSt5KSAqIHdpZHRoICsgc3hdLAotCQkJCQkgICB3ICog
KHNyYy0+YnBwIC8gOCkpOwotCQl9CisJbGluZWFyX2RzdCA9IGFsbG9jX2FsaWduZWQoZHN0LT5i
by0+c2l6ZSk7CisJbGluZWFyX3NyYyA9IGFsbG9jX2FsaWduZWQoc3JjLT5iby0+c2l6ZSk7CisJ
aWd0X2J1Zl90b19saW5lYXIoZGF0YS0+Ym1nciwgc3JjLCBsaW5lYXJfc3JjKTsKKwlpZ3RfYnVm
X3RvX2xpbmVhcihkYXRhLT5ibWdyLCBkc3QsIGxpbmVhcl9kc3QpOwogCi0JCW11bm1hcChsaW5l
YXJfc3JjLCBzcmMtPmJvLT5zaXplKTsKKwlmb3IgKGludCB5ID0gMDsgeSA8IGg7IHkrKykgewor
CQltZW1jcHkoJmxpbmVhcl9kc3RbKGR5K3kpICogd2lkdGggKyBkeF0sCisJCQkJJmxpbmVhcl9z
cmNbKHN5K3kpICogd2lkdGggKyBzeF0sCisJCQkJdyAqIChzcmMtPmJwcCAvIDgpKTsKIAl9CisJ
ZnJlZShsaW5lYXJfc3JjKTsKIAotCW11bm1hcChsaW5lYXJfZHN0LCBkc3QtPmJvLT5zaXplKTsK
KwlsaW5lYXJfdG9faWd0X2J1ZihkYXRhLT5ibWdyLCBkc3QsIGxpbmVhcl9kc3QpOworCWZyZWUo
bGluZWFyX2RzdCk7CiB9CiAKIHN0YXRpYyB2b2lkIHNjcmF0Y2hfYnVmX2luaXQoZGF0YV90ICpk
YXRhLCBzdHJ1Y3QgaWd0X2J1ZiAqYnVmLApAQCAtNDM5LDc2ICsyNjgsMTAgQEAgc3RhdGljIHZv
aWQgc2NyYXRjaF9idWZfaW5pdChkYXRhX3QgKmRhdGEsIHN0cnVjdCBpZ3RfYnVmICpidWYsCiAJ
CQkgICAgIHVpbnQzMl90IHJlcV90aWxpbmcsCiAJCQkgICAgIGVudW0gaTkxNV9jb21wcmVzc2lv
biBjb21wcmVzc2lvbikKIHsKLQl1aW50MzJfdCB0aWxpbmcgPSByZXFfdGlsaW5nOwotCXVuc2ln
bmVkIGxvbmcgcGl0Y2g7CiAJaW50IGJwcCA9IDMyOwogCi0JbWVtc2V0KGJ1ZiwgMCwgc2l6ZW9m
KCpidWYpKTsKLQotCWlmIChjb21wcmVzc2lvbiAhPSBJOTE1X0NPTVBSRVNTSU9OX05PTkUpIHsK
LQkJaW50IGF1eF93aWR0aCwgYXV4X2hlaWdodDsKLQkJaW50IHNpemU7Ci0KLQkJaWd0X3JlcXVp
cmUoaW50ZWxfZ2VuKGRhdGEtPmRldmlkKSA+PSA5KTsKLQkJaWd0X2Fzc2VydCh0aWxpbmcgPT0g
STkxNV9USUxJTkdfWSB8fAotCQkJICAgdGlsaW5nID09IEk5MTVfVElMSU5HX1lmKTsKLQotCQkv
KgotCQkgKiBPbiBHRU4xMisgd2UgYWxpZ24gdGhlIG1haW4gc3VyZmFjZSB0byA0ICogNCBtYWlu
IHN1cmZhY2UKLQkJICogdGlsZXMsIHdoaWNoIGlzIDY0a0IuIFRoZXNlIDE2IHRpbGVzIGFyZSBt
YXBwZWQgYnkgNCBBVVgKLQkJICogQ0NTIHVuaXRzLCB0aGF0IGlzIDQgKiA2NCBieXRlcy4gVGhl
c2UgNCBDQ1MgdW5pdHMgYXJlIGluCi0JCSAqIHR1cm4gbWFwcGVkIGJ5IG9uZSBMMSBBVVggcGFn
ZSB0YWJsZSBlbnRyeS4KLQkJICovCi0JCWlmIChpbnRlbF9nZW4oZGF0YS0+ZGV2aWQpID49IDEy
KQotCQkJYnVmLT5zdXJmYWNlWzBdLnN0cmlkZSA9IEFMSUdOKHdpZHRoICogKGJwcCAvIDgpLCAx
MjggKiA0KTsKLQkJZWxzZQotCQkJYnVmLT5zdXJmYWNlWzBdLnN0cmlkZSA9IEFMSUdOKHdpZHRo
ICogKGJwcCAvIDgpLCAxMjgpOwotCi0JCWlmIChpbnRlbF9nZW4oZGF0YS0+ZGV2aWQpID49IDEy
KQotCQkJaGVpZ2h0ID0gQUxJR04oaGVpZ2h0LCA0ICogMzIpOwotCi0JCWJ1Zi0+c3VyZmFjZVsw
XS5zaXplID0gYnVmLT5zdXJmYWNlWzBdLnN0cmlkZSAqIGhlaWdodDsKLQkJYnVmLT50aWxpbmcg
PSB0aWxpbmc7Ci0JCWJ1Zi0+YnBwID0gYnBwOwotCi0JCWF1eF93aWR0aCA9IHNjcmF0Y2hfYnVm
X2F1eF93aWR0aChkYXRhLT5kZXZpZCwgYnVmKTsKLQkJYXV4X2hlaWdodCA9IHNjcmF0Y2hfYnVm
X2F1eF9oZWlnaHQoZGF0YS0+ZGV2aWQsIGJ1Zik7Ci0KLQkJYnVmLT5jb21wcmVzc2lvbiA9IGNv
bXByZXNzaW9uOwotCQlidWYtPmNjc1swXS5vZmZzZXQgPSBidWYtPnN1cmZhY2VbMF0uc3RyaWRl
ICogQUxJR04oaGVpZ2h0LCAzMik7Ci0JCWJ1Zi0+Y2NzWzBdLnN0cmlkZSA9IGF1eF93aWR0aDsK
LQotCQlzaXplID0gYnVmLT5jY3NbMF0ub2Zmc2V0ICsgYXV4X3dpZHRoICogYXV4X2hlaWdodDsK
LQotCQlidWYtPmJvID0gZHJtX2ludGVsX2JvX2FsbG9jKGRhdGEtPmJ1Zm1nciwgIiIsIHNpemUs
IDQwOTYpOwotCi0JCWlmICh0aWxpbmcgPT0gSTkxNV9USUxJTkdfWSkgewotCQkJZHJtX2ludGVs
X2JvX3NldF90aWxpbmcoYnVmLT5ibywgJnRpbGluZywKLQkJCQkJCWJ1Zi0+c3VyZmFjZVswXS5z
dHJpZGUpOwotCQkJaWd0X2Fzc2VydF9lcSh0aWxpbmcsIHJlcV90aWxpbmcpOwotCQl9Ci0JfSBl
bHNlIGlmIChyZXFfdGlsaW5nID09IEk5MTVfVElMSU5HX1lmKSB7Ci0JCWludCBzaXplOwotCi0J
CWJ1Zi0+c3VyZmFjZVswXS5zdHJpZGUgPSBBTElHTih3aWR0aCAqIChicHAgLyA4KSwgMTI4KTsK
LQkJYnVmLT5zdXJmYWNlWzBdLnNpemUgPSBidWYtPnN1cmZhY2VbMF0uc3RyaWRlICogaGVpZ2h0
OwotCQlidWYtPnRpbGluZyA9IHRpbGluZzsKLQkJYnVmLT5icHAgPSBicHA7Ci0KLQkJc2l6ZSA9
IGJ1Zi0+c3VyZmFjZVswXS5zdHJpZGUgKiBBTElHTihoZWlnaHQsIDMyKTsKLQotCQlidWYtPmJv
ID0gZHJtX2ludGVsX2JvX2FsbG9jKGRhdGEtPmJ1Zm1nciwgIiIsIHNpemUsIDQwOTYpOwotCX0g
ZWxzZSB7Ci0JCWJ1Zi0+Ym8gPSBkcm1faW50ZWxfYm9fYWxsb2NfdGlsZWQoZGF0YS0+YnVmbWdy
LCAiIiwKLQkJCQkJCSAgIHdpZHRoLCBoZWlnaHQsIGJwcCAvIDgsCi0JCQkJCQkgICAmdGlsaW5n
LCAmcGl0Y2gsIDApOwotCQlpZ3RfYXNzZXJ0X2VxKHRpbGluZywgcmVxX3RpbGluZyk7Ci0KLQkJ
YnVmLT5zdXJmYWNlWzBdLnN0cmlkZSA9IHBpdGNoOwotCQlidWYtPnRpbGluZyA9IHRpbGluZzsK
LQkJYnVmLT5zdXJmYWNlWzBdLnNpemUgPSBwaXRjaCAqIGhlaWdodDsKLQkJYnVmLT5icHAgPSBi
cHA7Ci0JfQorCWlndF9idWZfaW5pdChkYXRhLT5ibWdyLCBidWYsIHdpZHRoLCBoZWlnaHQsIGJw
cCwgcmVxX3RpbGluZywKKwkJICAgICBjb21wcmVzc2lvbik7CiAKIAlpZ3RfYXNzZXJ0KGlndF9i
dWZfd2lkdGgoYnVmKSA9PSB3aWR0aCk7CiAJaWd0X2Fzc2VydChpZ3RfYnVmX2hlaWdodChidWYp
ID09IGhlaWdodCk7CkBAIC01MzMsMTEgKzI5NiwxMyBAQCBzY3JhdGNoX2J1Zl9jaGVjayhkYXRh
X3QgKmRhdGEsCiAJaWd0X2Fzc2VydF9lcShpZ3RfYnVmX2hlaWdodChidWYpLCBpZ3RfYnVmX2hl
aWdodChyZWYpKTsKIAlpZ3RfYXNzZXJ0X2VxKGJ1Zi0+Ym8tPnNpemUsIHJlZi0+Ym8tPnNpemUp
OwogCi0JbGluZWFyID0gbGluZWFyX2NvcHkoZGF0YSwgYnVmKTsKKwlsaW5lYXIgPSBhbGxvY19h
bGlnbmVkKGJ1Zi0+Ym8tPnNpemUpOworCWlndF9idWZfdG9fbGluZWFyKGRhdGEtPmJtZ3IsIGJ1
ZiwgbGluZWFyKTsKIAlidWZfdmFsID0gbGluZWFyW3kgKiB3aWR0aCArIHhdOwogCWZyZWUobGlu
ZWFyKTsKIAotCWxpbmVhciA9IGxpbmVhcl9jb3B5KGRhdGEsIHJlZik7CisJbGluZWFyID0gYWxs
b2NfYWxpZ25lZChyZWYtPmJvLT5zaXplKTsKKwlpZ3RfYnVmX3RvX2xpbmVhcihkYXRhLT5ibWdy
LCBidWYsIGxpbmVhcik7CiAJcmVmX3ZhbCA9IGxpbmVhclt5ICogd2lkdGggKyB4XTsKIAlmcmVl
KGxpbmVhcik7CiAKQEAgLTU1OSw4ICszMjQsMTAgQEAgc2NyYXRjaF9idWZfY2hlY2tfYWxsKGRh
dGFfdCAqZGF0YSwKIAlpZ3RfYXNzZXJ0X2VxKGlndF9idWZfaGVpZ2h0KGJ1ZiksIGlndF9idWZf
aGVpZ2h0KHJlZikpOwogCWlndF9hc3NlcnRfZXEoYnVmLT5iby0+c2l6ZSwgcmVmLT5iby0+c2l6
ZSk7CiAKLQlsaW5lYXJfYnVmID0gbGluZWFyX2NvcHkoZGF0YSwgYnVmKTsKLQlsaW5lYXJfcmVm
ID0gbGluZWFyX2NvcHkoZGF0YSwgcmVmKTsKKwlsaW5lYXJfYnVmID0gYWxsb2NfYWxpZ25lZChi
dWYtPmJvLT5zaXplKTsKKwlsaW5lYXJfcmVmID0gYWxsb2NfYWxpZ25lZChyZWYtPmJvLT5zaXpl
KTsKKwlpZ3RfYnVmX3RvX2xpbmVhcihkYXRhLT5ibWdyLCBidWYsIGxpbmVhcl9idWYpOworCWln
dF9idWZfdG9fbGluZWFyKGRhdGEtPmJtZ3IsIHJlZiwgbGluZWFyX3JlZik7CiAKIAlmb3IgKGlu
dCB5ID0gMDsgeSA8IGhlaWdodDsgeSsrKSB7CiAJCWZvciAoaW50IHggPSAwOyB4IDwgd2lkdGg7
IHgrKykgewpAQCAtNTc3LDI1ICszNDQsNDkgQEAgc2NyYXRjaF9idWZfY2hlY2tfYWxsKGRhdGFf
dCAqZGF0YSwKIAlmcmVlKGxpbmVhcl9idWYpOwogfQogCi1zdGF0aWMgdm9pZCBzY3JhdGNoX2J1
Zl9hdXhfY2hlY2soZGF0YV90ICpkYXRhLAorc3RhdGljIHZvaWQgc2NyYXRjaF9idWZfY2NzX2No
ZWNrKGRhdGFfdCAqZGF0YSwKIAkJCQkgIHN0cnVjdCBpZ3RfYnVmICpidWYpCiB7Ci0JaW50IGF1
eF9zaXplID0gc2NyYXRjaF9idWZfYXV4X3dpZHRoKGRhdGEtPmRldmlkLCBidWYpICoKLQkJc2Ny
YXRjaF9idWZfYXV4X2hlaWdodChkYXRhLT5kZXZpZCwgYnVmKTsKKwlpbnQgZ2VuID0gaW50ZWxf
Z2VuKGRhdGEtPmRldmlkKTsKKwlpbnQgY2NzX3NpemUgPSBpZ3RfYnVmX2ludGVsX2Njc193aWR0
aChnZW4sIGJ1ZikgKgorCQlpZ3RfYnVmX2ludGVsX2Njc19oZWlnaHQoZ2VuLCBidWYpOwogCXVp
bnQ4X3QgKmxpbmVhcjsKIAlpbnQgaTsKIAotCWxpbmVhciA9IGxpbmVhcl9jb3B5X2F1eChkYXRh
LCBidWYpOworCWxpbmVhciA9IGxpbmVhcl9jb3B5X2NjcyhkYXRhLCBidWYpOwogCi0JZm9yIChp
ID0gMDsgaSA8IGF1eF9zaXplOyBpKyspIHsKKwlmb3IgKGkgPSAwOyBpIDwgY2NzX3NpemU7IGkr
KykgewogCQlpZiAobGluZWFyW2ldKQogCQkJYnJlYWs7CiAJfQogCiAJZnJlZShsaW5lYXIpOwog
Ci0JaWd0X2Fzc2VydF9mKGkgPCBhdXhfc2l6ZSwKLQkJICAgICAiQXV4IHN1cmZhY2UgaW5kaWNh
dGVzIHRoYXQgbm90aGluZyB3YXMgY29tcHJlc3NlZFxuIik7CisJaWd0X2Fzc2VydF9mKGkgPCBj
Y3Nfc2l6ZSwKKwkJICAgICAiQ2NzIHN1cmZhY2UgaW5kaWNhdGVzIHRoYXQgbm90aGluZyB3YXMg
Y29tcHJlc3NlZFxuIik7Cit9CisKK3N0YXRpYyB2b2lkCitkdW1wX2lndF9idWZfdG9fZmlsZShk
YXRhX3QgKmRhdGEsIHN0cnVjdCBpZ3RfYnVmICpidWYsIGNvbnN0IGNoYXIgKmZpbGVuYW1lKQor
eworCUZJTEUgKm91dDsKKwl2b2lkICpsaW5lYXI7CisKKwlnZW1fc2V0X2RvbWFpbihkYXRhLT5k
cm1fZmQsIGJ1Zi0+Ym8tPmhhbmRsZSwKKwkJICAgICAgIEk5MTVfR0VNX0RPTUFJTl9DUFUsIDAp
OworCisJbGluZWFyID0gX19nZW1fbW1hcF9vZmZzZXRfX2NwdShkYXRhLT5kcm1fZmQsIGJ1Zi0+
Ym8tPmhhbmRsZSwgMCwKKwkJCQkJYnVmLT5iby0+c2l6ZSwgUFJPVF9SRUFEKTsKKwlpZiAoIWxp
bmVhcikKKwkJbGluZWFyID0gZ2VtX21tYXBfX2NwdShkYXRhLT5kcm1fZmQsIGJ1Zi0+Ym8tPmhh
bmRsZSwgMCwKKwkJCQkgICAgICAgYnVmLT5iby0+c2l6ZSwgUFJPVF9SRUFEKTsKKwlvdXQgPSBm
b3BlbihmaWxlbmFtZSwgIndiIik7CisJaWd0X2Fzc2VydChvdXQpOworCWZ3cml0ZShsaW5lYXIs
IGJ1Zi0+Ym8tPnNpemUsIDEsIG91dCk7CisJZmNsb3NlKG91dCk7CisKKwltdW5tYXAobGluZWFy
LCBidWYtPmJvLT5zaXplKTsKKwogfQogCiAjZGVmaW5lIFNPVVJDRV9NSVhFRF9USUxFRAkxCkBA
IC02NzEsNiArNDYyLDcgQEAgc3RhdGljIHZvaWQgdGVzdChkYXRhX3QgKmRhdGEsIHVpbnQzMl90
IHNyY190aWxpbmcsIHVpbnQzMl90IGRzdF90aWxpbmcsCiAJCQkJIEk5MTVfQ09NUFJFU1NJT05f
Tk9ORSk7CiAJc2NyYXRjaF9idWZfaW5pdChkYXRhLCAmZHN0LCBXSURUSCwgSEVJR0hULCBkc3Rf
dGlsaW5nLAogCQkJIEk5MTVfQ09NUFJFU1NJT05fTk9ORSk7CisKIAlpZiAoc3JjX2NvbXByZXNz
ZWQpCiAJCXNjcmF0Y2hfYnVmX2luaXQoZGF0YSwgJnNyY19jY3MsIFdJRFRILCBIRUlHSFQsCiAJ
CQkJIHNyY190aWxpbmcsIHNyY19jb21wcmVzc2lvbik7CkBAIC02ODMsNyArNDc1LDggQEAgc3Rh
dGljIHZvaWQgdGVzdChkYXRhX3QgKmRhdGEsIHVpbnQzMl90IHNyY190aWxpbmcsIHVpbnQzMl90
IGRzdF90aWxpbmcsCiAJZm9yIChpbnQgaSA9IDA7IGkgPCBudW1fc3JjOyBpKyspCiAJCXNjcmF0
Y2hfYnVmX2RyYXdfcGF0dGVybihkYXRhLCAmc3JjW2ldLmJ1ZiwKIAkJCQkJIDAsIDAsIFdJRFRI
LCBIRUlHSFQsCi0JCQkJCSAwLCAwLCBXSURUSCwgSEVJR0hULCB0cnVlKTsKKwkJCQkJIDAsIDAs
IFdJRFRILCBIRUlHSFQsIChpICUgMikpOworCiAJc2NyYXRjaF9idWZfZHJhd19wYXR0ZXJuKGRh
dGEsICZkc3QsCiAJCQkJIDAsIDAsIFdJRFRILCBIRUlHSFQsCiAJCQkJIDAsIDAsIFdJRFRILCBI
RUlHSFQsIGZhbHNlKTsKQEAgLTc0MiwxNSArNTM1LDI4IEBAIHN0YXRpYyB2b2lkIHRlc3QoZGF0
YV90ICpkYXRhLCB1aW50MzJfdCBzcmNfdGlsaW5nLCB1aW50MzJfdCBkc3RfdGlsaW5nLAogCQkJ
CQkgICZkc3QsIDAsIDApOwogCiAJfSBlbHNlIHsKLQkJaWYgKHNyY19jb21wcmVzc2lvbiA9PSBJ
OTE1X0NPTVBSRVNTSU9OX1JFTkRFUikKKwkJaWYgKHNyY19jb21wcmVzc2lvbiA9PSBJOTE1X0NP
TVBSRVNTSU9OX1JFTkRFUikgewogCQkJZGF0YS0+cmVuZGVyX2NvcHkoZGF0YS0+YmF0Y2gsIE5V
TEwsCiAJCQkJCSAgJnNyY190aWxlZCwgMCwgMCwgV0lEVEgsIEhFSUdIVCwKIAkJCQkJICAmc3Jj
X2NjcywKIAkJCQkJICAwLCAwKTsKLQkJZWxzZSBpZiAoc3JjX2NvbXByZXNzaW9uID09IEk5MTVf
Q09NUFJFU1NJT05fTUVESUEpCisJCQlpZiAoZHVtcF9jb21wcmVzc2VkX3NyY19idWYpIHsKKwkJ
CQlkdW1wX2lndF9idWZfdG9fZmlsZShkYXRhLCAmc3JjX3RpbGVkLAorCQkJCQkJICAgICAicmVu
ZGVyLXNyY190aWxlZC5iaW4iKTsKKwkJCQlkdW1wX2lndF9idWZfdG9fZmlsZShkYXRhLCAmc3Jj
X2NjcywKKwkJCQkJCSAgICAgInJlbmRlci1zcmNfY2NzLmJpbiIpOworCQkJfQorCQl9IGVsc2Ug
aWYgKHNyY19jb21wcmVzc2lvbiA9PSBJOTE1X0NPTVBSRVNTSU9OX01FRElBKSB7CiAJCQlkYXRh
LT52ZWJveF9jb3B5KGRhdGEtPmJhdGNoLAogCQkJCQkgJnNyY190aWxlZCwgV0lEVEgsIEhFSUdI
VCwKIAkJCQkJICZzcmNfY2NzKTsKKwkJCWlmIChkdW1wX2NvbXByZXNzZWRfc3JjX2J1Zikgewor
CQkJCWR1bXBfaWd0X2J1Zl90b19maWxlKGRhdGEsICZzcmNfdGlsZWQsCisJCQkJCQkgICAgICJ2
ZWJveC1zcmNfdGlsZWQuYmluIik7CisJCQkJZHVtcF9pZ3RfYnVmX3RvX2ZpbGUoZGF0YSwgJnNy
Y19jY3MsCisJCQkJCQkgICAgICJ2ZWJveC1zcmNfY2NzLmJpbiIpOworCQkJfQorCQl9CiAKIAkJ
aWYgKGRzdF9jb21wcmVzc2lvbiA9PSBJOTE1X0NPTVBSRVNTSU9OX1JFTkRFUikgewogCQkJZGF0
YS0+cmVuZGVyX2NvcHkoZGF0YS0+YmF0Y2gsIE5VTEwsCkBAIC03OTMsMTQgKzU5OSwxNCBAQCBz
dGF0aWMgdm9pZCB0ZXN0KGRhdGFfdCAqZGF0YSwgdWludDMyX3Qgc3JjX3RpbGluZywgdWludDMy
X3QgZHN0X3RpbGluZywKIAkJaWYgKHNyY19jb21wcmVzc2VkKSB7CiAJCQlzY3JhdGNoX2J1Zl93
cml0ZV90b19wbmcoZGF0YSwgJnNyY19jY3MsCiAJCQkJCQkgImNvbXByZXNzZWQtc3JjLnBuZyIp
OwotCQkJc2NyYXRjaF9idWZfYXV4X3dyaXRlX3RvX3BuZyhkYXRhLCAmc3JjX2NjcywKLQkJCQkJ
CSAgICAgImNvbXByZXNzZWQtc3JjLWF1eC5wbmciKTsKKwkJCXNjcmF0Y2hfYnVmX2Njc193cml0
ZV90b19wbmcoZGF0YSwgJnNyY19jY3MsCisJCQkJCQkgICAgICJjb21wcmVzc2VkLXNyYy1jY3Mu
cG5nIik7CiAJCX0KIAkJaWYgKGRzdF9jb21wcmVzc2VkKSB7CiAJCQlzY3JhdGNoX2J1Zl93cml0
ZV90b19wbmcoZGF0YSwgJmRzdF9jY3MsCiAJCQkJCQkgImNvbXByZXNzZWQtZHN0LnBuZyIpOwot
CQkJc2NyYXRjaF9idWZfYXV4X3dyaXRlX3RvX3BuZyhkYXRhLCAmZHN0X2NjcywKLQkJCQkJCSAg
ICAgImNvbXByZXNzZWQtZHN0LWF1eC5wbmciKTsKKwkJCXNjcmF0Y2hfYnVmX2Njc193cml0ZV90
b19wbmcoZGF0YSwgJmRzdF9jY3MsCisJCQkJCQkgICAgICJjb21wcmVzc2VkLWRzdC1jY3MucG5n
Iik7CiAJCX0KIAl9CiAKQEAgLTgxOSw5ICs2MjUsOSBAQCBzdGF0aWMgdm9pZCB0ZXN0KGRhdGFf
dCAqZGF0YSwgdWludDMyX3Qgc3JjX3RpbGluZywgdWludDMyX3QgZHN0X3RpbGluZywKIAl9CiAK
IAlpZiAoc3JjX2NvbXByZXNzZWQpCi0JCXNjcmF0Y2hfYnVmX2F1eF9jaGVjayhkYXRhLCAmc3Jj
X2Njcyk7CisJCXNjcmF0Y2hfYnVmX2Njc19jaGVjayhkYXRhLCAmc3JjX2Njcyk7CiAJaWYgKGRz
dF9jb21wcmVzc2VkKQotCQlzY3JhdGNoX2J1Zl9hdXhfY2hlY2soZGF0YSwgJmRzdF9jY3MpOwor
CQlzY3JhdGNoX2J1Zl9jY3NfY2hlY2soZGF0YSwgJmRzdF9jY3MpOwogCiAJc2NyYXRjaF9idWZf
ZmluaSgmcmVmKTsKIAlpZiAoZHN0X2NvbXByZXNzZWQpCkBAIC0xMDU0LDYgKzg2MCw5IEBAIGln
dF9tYWluX2FyZ3MoImRhIiwgTlVMTCwgaGVscF9zdHIsIG9wdF9oYW5kbGVyLCBOVUxMKQogCQlk
YXRhLmJhdGNoID0gaW50ZWxfYmF0Y2hidWZmZXJfYWxsb2MoZGF0YS5idWZtZ3IsIGRhdGEuZGV2
aWQpOwogCQlpZ3RfYXNzZXJ0KGRhdGEuYmF0Y2gpOwogCisJCWRhdGEuYm1nciA9IHJlbmRlcmNv
cHlfYnVmbWdyX2NyZWF0ZShkYXRhLmRybV9mZCwgZGF0YS5idWZtZ3IpOworCQlpZ3RfYXNzZXJ0
KGRhdGEuYm1ncik7CisKIAkJaWd0X2ZvcmtfaGFuZ19kZXRlY3RvcihkYXRhLmRybV9mZCk7CiAJ
fQogCkBAIC0xMTA3LDUgKzkxNiw2IEBAIGlndF9tYWluX2FyZ3MoImRhIiwgTlVMTCwgaGVscF9z
dHIsIG9wdF9oYW5kbGVyLCBOVUxMKQogCQlpZ3Rfc3RvcF9oYW5nX2RldGVjdG9yKCk7CiAJCWlu
dGVsX2JhdGNoYnVmZmVyX2ZyZWUoZGF0YS5iYXRjaCk7CiAJCWRybV9pbnRlbF9idWZtZ3JfZGVz
dHJveShkYXRhLmJ1Zm1ncik7CisJCXJlbmRlcmNvcHlfYnVmbWdyX2Rlc3Ryb3koZGF0YS5ibWdy
KTsKIAl9CiB9Ci0tIAoyLjI1LjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fCkludGVsLWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVk
ZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZv
L2ludGVsLWdmeAo=

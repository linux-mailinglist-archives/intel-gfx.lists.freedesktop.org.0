Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 47CFBD566B
	for <lists+intel-gfx@lfdr.de>; Sun, 13 Oct 2019 15:50:36 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id E31116E10F;
	Sun, 13 Oct 2019 13:50:33 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 361B56E10B;
 Sun, 13 Oct 2019 13:50:31 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18822241-1500050 
 for multiple; Sun, 13 Oct 2019 14:50:23 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Sun, 13 Oct 2019 14:50:21 +0100
Message-Id: <20191013135021.31957-2-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20191013135021.31957-1-chris@chris-wilson.co.uk>
References: <20191013135021.31957-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH i-g-t 2/2] overlay: Show total package power
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: igt-dev@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

QWRkIHRoZSB0b3RhbCBwYWNrYWdlIHBvd2VyIGFmdGVyIHRoZSBHUFUgcGFja2FnZSBwb3dlciwg
Zm9yIHJlZmVyZW5jZS4KClNpZ25lZC1vZmYtYnk6IENocmlzIFdpbHNvbiA8Y2hyaXNAY2hyaXMt
d2lsc29uLmNvLnVrPgotLS0KIG92ZXJsYXkvb3ZlcmxheS5jIHwgMTggKysrKysrLS0tLQogb3Zl
cmxheS9wb3dlci5jICAgfCA4OCArKysrKysrKysrKysrKysrKysrLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLQogb3ZlcmxheS9wb3dlci5oICAgfCAyMSArKysrKy0tLS0tLQogMyBmaWxlcyBj
aGFuZ2VkLCA1OSBpbnNlcnRpb25zKCspLCA2OCBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9v
dmVybGF5L292ZXJsYXkuYyBiL292ZXJsYXkvb3ZlcmxheS5jCmluZGV4IGVhZTVkZGZhOC4uZGQ0
ZmNhMjllIDEwMDY0NAotLS0gYS9vdmVybGF5L292ZXJsYXkuYworKysgYi9vdmVybGF5L292ZXJs
YXkuYwpAQCAtNjA5LDEyICs2MDksMTIgQEAgc3RhdGljIHZvaWQgc2hvd19ncHVfZnJlcShzdHJ1
Y3Qgb3ZlcmxheV9jb250ZXh0ICpjdHgsIHN0cnVjdCBvdmVybGF5X2dwdV9mcmVxICoKIAl9CiAK
IAlpZiAoaGFzX3Bvd2VyKSB7Ci0JCWNoYXJ0X2FkZF9zYW1wbGUoJmdmLT5wb3dlcl9jaGFydCwg
Z2YtPnBvd2VyLnBvd2VyX21XKTsKLQkJaWYgKGdmLT5wb3dlci5uZXdfc2FtcGxlKSB7Ci0JCQlp
ZiAoZ2YtPnBvd2VyLnBvd2VyX21XID4gZ2YtPnBvd2VyX21heCkKLQkJCQlnZi0+cG93ZXJfbWF4
ID0gZ2YtPnBvd2VyLnBvd2VyX21XOworCQljaGFydF9hZGRfc2FtcGxlKCZnZi0+cG93ZXJfY2hh
cnQsIGdmLT5wb3dlci5ncHUucG93ZXJfbVcpOworCQlpZiAoZ2YtPnBvd2VyLmdwdS5uZXdfc2Ft
cGxlKSB7CisJCQlpZiAoZ2YtPnBvd2VyLmdwdS5wb3dlcl9tVyA+IGdmLT5wb3dlcl9tYXgpCisJ
CQkJZ2YtPnBvd2VyX21heCA9IGdmLT5wb3dlci5ncHUucG93ZXJfbVc7CiAJCQljaGFydF9zZXRf
cmFuZ2UoJmdmLT5wb3dlcl9jaGFydCwgMCwgZ2YtPnBvd2VyX21heCk7Ci0JCQlnZi0+cG93ZXIu
bmV3X3NhbXBsZSA9IDA7CisJCQlnZi0+cG93ZXIuZ3B1Lm5ld19zYW1wbGUgPSAwOwogCQl9CiAJ
CWNoYXJ0X2RyYXcoJmdmLT5wb3dlcl9jaGFydCwgY3R4LT5jcik7CiAJfQpAQCAtNzAwLDggKzcw
MCwxNCBAQCBzdGF0aWMgdm9pZCBzaG93X2dwdV9mcmVxKHN0cnVjdCBvdmVybGF5X2NvbnRleHQg
KmN0eCwgc3RydWN0IG92ZXJsYXlfZ3B1X2ZyZXEgKgogCX0KIAogCWlmIChoYXNfcG93ZXIpIHsK
LQkJc3ByaW50ZihidWYsICJQb3dlcjogJWxsdW1XIiwgKGxvbmcgbG9uZyB1bnNpZ25lZClnZi0+
cG93ZXIucG93ZXJfbVcpOwogCQljYWlyb19zZXRfc291cmNlX3JnYmEoY3R4LT5jciwgMSwgMSwg
MSwgMSk7CisKKwkJc3ByaW50ZihidWYsICJQb3dlcjogJWxsdW1XIiwgKGxvbmcgbG9uZyB1bnNp
Z25lZClnZi0+cG93ZXIuZ3B1LnBvd2VyX21XKTsKKwkJY2Fpcm9fbW92ZV90byhjdHgtPmNyLCBQ
QUQsIHkpOworCQljYWlyb19zaG93X3RleHQoY3R4LT5jciwgYnVmKTsKKwkJeSArPSAxNDsKKwor
CQlzcHJpbnRmKGJ1ZiwgIlBhY2thZ2U6ICVsbHVtVyIsIChsb25nIGxvbmcgdW5zaWduZWQpZ2Yt
PnBvd2VyLnBrZy5wb3dlcl9tVyk7CiAJCWNhaXJvX21vdmVfdG8oY3R4LT5jciwgUEFELCB5KTsK
IAkJY2Fpcm9fc2hvd190ZXh0KGN0eC0+Y3IsIGJ1Zik7CiAJCXkgKz0gMTQ7CmRpZmYgLS1naXQg
YS9vdmVybGF5L3Bvd2VyLmMgYi9vdmVybGF5L3Bvd2VyLmMKaW5kZXggMGY5OWUyYTRhLi43NmZh
ZmVhOTEgMTAwNjQ0Ci0tLSBhL292ZXJsYXkvcG93ZXIuYworKysgYi9vdmVybGF5L3Bvd2VyLmMK
QEAgLTc3LDE1ICs3Nyw2IEBAIHN0YXRpYyB1aW50NjRfdCBmaWxlbmFtZV90b191NjQoY29uc3Qg
Y2hhciAqZmlsZW5hbWUsIGludCBiYXNlKQogCXJldHVybiBzdHJ0b3VsbChiLCBOVUxMLCBiYXNl
KTsKIH0KIAotc3RhdGljIHVpbnQ2NF90IGRlYnVnZnNfZmlsZV90b191NjQoY29uc3QgY2hhciAq
bmFtZSkKLXsKLQljaGFyIGJ1ZlsxMDI0XTsKLQotCXNucHJpbnRmKGJ1Ziwgc2l6ZW9mKGJ1Ziks
ICIlcy8lcyIsIGRlYnVnZnNfZHJpX3BhdGgsIG5hbWUpOwotCi0JcmV0dXJuIGZpbGVuYW1lX3Rv
X3U2NChidWYsIDApOwotfQotCiBzdGF0aWMgdWludDY0X3QgcmFwbF90eXBlX2lkKHZvaWQpCiB7
CiAJcmV0dXJuIGZpbGVuYW1lX3RvX3U2NCgiL3N5cy9kZXZpY2VzL3Bvd2VyL3R5cGUiLCAxMCk7
CkBAIC05Niw2ICs4NywxMSBAQCBzdGF0aWMgdWludDY0X3QgcmFwbF9ncHVfcG93ZXIodm9pZCkK
IAlyZXR1cm4gZmlsZW5hbWVfdG9fdTY0KCIvc3lzL2RldmljZXMvcG93ZXIvZXZlbnRzL2VuZXJn
eS1ncHUiLCAwKTsKIH0KIAorc3RhdGljIHVpbnQ2NF90IHJhcGxfcGtnX3Bvd2VyKHZvaWQpCit7
CisJcmV0dXJuIGZpbGVuYW1lX3RvX3U2NCgiL3N5cy9kZXZpY2VzL3Bvd2VyL2V2ZW50cy9lbmVy
Z3ktcGtnIiwgMCk7Cit9CisKIHN0YXRpYyBkb3VibGUgZmlsZW5hbWVfdG9fZG91YmxlKGNvbnN0
IGNoYXIgKmZpbGVuYW1lKQogewogCWNoYXIgKm9sZGxvY2FsZTsKQEAgLTExNyw3MCArMTEzLDU4
IEBAIHN0YXRpYyBkb3VibGUgcmFwbF9ncHVfcG93ZXJfc2NhbGUodm9pZCkKIAlyZXR1cm4gZmls
ZW5hbWVfdG9fZG91YmxlKCIvc3lzL2RldmljZXMvcG93ZXIvZXZlbnRzL2VuZXJneS1ncHUuc2Nh
bGUiKTsKIH0KIAotaW50IHBvd2VyX2luaXQoc3RydWN0IHBvd2VyICpwb3dlcikKK3N0YXRpYyBk
b3VibGUgcmFwbF9wa2dfcG93ZXJfc2NhbGUodm9pZCkKIHsKLQl1aW50NjRfdCB2YWw7CisJcmV0
dXJuIGZpbGVuYW1lX3RvX2RvdWJsZSgiL3N5cy9kZXZpY2VzL3Bvd2VyL2V2ZW50cy9lbmVyZ3kt
cGtnLnNjYWxlIik7Cit9CiAKK2ludCBwb3dlcl9pbml0KHN0cnVjdCBwb3dlciAqcG93ZXIpCit7
CiAJbWVtc2V0KHBvd2VyLCAwLCBzaXplb2YoKnBvd2VyKSk7CiAKLQlwb3dlci0+ZmQgPSBpZ3Rf
cGVyZl9vcGVuKHJhcGxfdHlwZV9pZCgpLCByYXBsX2dwdV9wb3dlcigpKTsKLQlpZiAocG93ZXIt
PmZkID49IDApIHsKLQkJcG93ZXItPnJhcGxfc2NhbGUgPSByYXBsX2dwdV9wb3dlcl9zY2FsZSgp
OwotCi0JCWlmIChwb3dlci0+cmFwbF9zY2FsZSAhPSBOQU4pIHsKLQkJCXBvd2VyLT5yYXBsX3Nj
YWxlICo9IDFlMzsgLyogZnJvbSBuYW5vIHRvIG1pY3JvICovCi0JCQlyZXR1cm4gMDsKLQkJfQot
CX0KKwlwb3dlci0+Z3B1LmZkID0gaWd0X3BlcmZfb3BlbihyYXBsX3R5cGVfaWQoKSwgcmFwbF9n
cHVfcG93ZXIoKSk7CisJaWYgKHBvd2VyLT5ncHUuZmQgPCAwKQorCQlyZXR1cm4gcG93ZXItPmVy
cm9yID0gRU5PRU5UOworCXBvd2VyLT5ncHUuc2NhbGUgPSByYXBsX2dwdV9wb3dlcl9zY2FsZSgp
ICogMWUzOyAvKiB0byBtaWxsaSAqLwogCi0JdmFsID0gZGVidWdmc19maWxlX3RvX3U2NCgiaTkx
NV9lbmVyZ3lfdUoiKTsKLQlpZiAodmFsID09IDApCi0JCXJldHVybiBwb3dlci0+ZXJyb3IgPSBF
SU5WQUw7CisJcG93ZXItPnBrZy5mZCA9IGlndF9wZXJmX29wZW4ocmFwbF90eXBlX2lkKCksIHJh
cGxfcGtnX3Bvd2VyKCkpOworCXBvd2VyLT5wa2cuc2NhbGUgPSByYXBsX3BrZ19wb3dlcl9zY2Fs
ZSgpICoxZTM7IC8qIHRvIG1pbGxpICovCiAKIAlyZXR1cm4gMDsKIH0KIAotc3RhdGljIHVpbnQ2
NF90IGNsb2NrX21zX3RvX3U2NCh2b2lkKQorc3RhdGljIHZvaWQgX19wb3dlcl91cGRhdGUoc3Ry
dWN0IHBvd2VyX2RvbWFpbiAqcGQsIGludCBjb3VudCkKIHsKLQlzdHJ1Y3QgdGltZXNwZWMgdHY7
CisJc3RydWN0IHBvd2VyX3N0YXQgKnMgPSAmcGQtPnN0YXRbY291bnQgJiAxXTsKKwlzdHJ1Y3Qg
cG93ZXJfc3RhdCAqZCA9ICZwZC0+c3RhdFsoY291bnQgKyAxKSAmIDFdOworCXVpbnQ2NF90IGRh
dGFbMl0sIGRfdGltZTsKKwlpbnQgbGVuOwogCi0JaWYgKGNsb2NrX2dldHRpbWUoQ0xPQ0tfTU9O
T1RPTklDLCAmdHYpIDwgMCkKLQkJcmV0dXJuIDA7CisJbGVuID0gcmVhZChwZC0+ZmQsIGRhdGEs
IHNpemVvZihkYXRhKSk7CisJaWYgKGxlbiAhPSBzaXplb2YoZGF0YSkpCisJCXJldHVybjsKIAot
CXJldHVybiAodWludDY0X3QpdHYudHZfc2VjICogMWUzICsgdHYudHZfbnNlYyAvIDFlNjsKKwlz
LT5lbmVyZ3kgPSBsbHJvdW5kKChkb3VibGUpZGF0YVswXSAqIHBkLT5zY2FsZSk7CisJcy0+dGlt
ZXN0YW1wID0gZGF0YVsxXTsKKworCWlmICghY291bnQpCisJCXJldHVybjsKKworCWRfdGltZSA9
IHMtPnRpbWVzdGFtcCAtIGQtPnRpbWVzdGFtcDsKKwlwZC0+cG93ZXJfbVcgPSByb3VuZCgocy0+
ZW5lcmd5IC0gZC0+ZW5lcmd5KSAqIDFlOSAvIGRfdGltZSk7CisJcGQtPm5ld19zYW1wbGUgPSAx
OwogfQogCiBpbnQgcG93ZXJfdXBkYXRlKHN0cnVjdCBwb3dlciAqcG93ZXIpCiB7Ci0Jc3RydWN0
IHBvd2VyX3N0YXQgKnMgPSAmcG93ZXItPnN0YXRbcG93ZXItPmNvdW50KysgJiAxXTsKLQlzdHJ1
Y3QgcG93ZXJfc3RhdCAqZCA9ICZwb3dlci0+c3RhdFtwb3dlci0+Y291bnQgJiAxXTsKLQl1aW50
NjRfdCBkX3RpbWU7Ci0KIAlpZiAocG93ZXItPmVycm9yKQogCQlyZXR1cm4gcG93ZXItPmVycm9y
OwogCi0JaWYgKHBvd2VyLT5mZCA+PSAwKSB7Ci0JCXVpbnQ2NF90IGRhdGFbMl07Ci0JCWludCBs
ZW47Ci0KLQkJbGVuID0gcmVhZChwb3dlci0+ZmQsIGRhdGEsIHNpemVvZihkYXRhKSk7Ci0JCWlm
IChsZW4gIT0gc2l6ZW9mKGRhdGEpKQotCQkJcmV0dXJuIHBvd2VyLT5lcnJvciA9IGVycm5vOwot
Ci0JCXMtPmVuZXJneSA9IGxscm91bmQoKGRvdWJsZSlkYXRhWzBdICogcG93ZXItPnJhcGxfc2Nh
bGUpOwotCQlzLT50aW1lc3RhbXAgPSBkYXRhWzFdIC8gMWU2OwotCX0gZWxzZSB7Ci0JCXMtPmVu
ZXJneSA9IGRlYnVnZnNfZmlsZV90b191NjQoImk5MTVfZW5lcmd5X3VKIikgLyAxZTM7Ci0JCXMt
PnRpbWVzdGFtcCA9IGNsb2NrX21zX3RvX3U2NCgpOwotCX0KKwlfX3Bvd2VyX3VwZGF0ZSgmcG93
ZXItPmdwdSwgcG93ZXItPmNvdW50KTsKKwlfX3Bvd2VyX3VwZGF0ZSgmcG93ZXItPnBrZywgcG93
ZXItPmNvdW50KTsKIAotCWlmIChwb3dlci0+Y291bnQgPT0gMSkKKwlpZiAoIXBvd2VyLT5jb3Vu
dCsrKQogCQlyZXR1cm4gRUFHQUlOOwogCi0JZF90aW1lID0gcy0+dGltZXN0YW1wIC0gZC0+dGlt
ZXN0YW1wOwotCXBvd2VyLT5wb3dlcl9tVyA9IHJvdW5kKChkb3VibGUpKHMtPmVuZXJneSAtIGQt
PmVuZXJneSkgKgotCQkJCSgxZTNmIC8gZF90aW1lKSk7Ci0JcG93ZXItPm5ld19zYW1wbGUgPSAx
OwotCiAJcmV0dXJuIDA7CiB9CmRpZmYgLS1naXQgYS9vdmVybGF5L3Bvd2VyLmggYi9vdmVybGF5
L3Bvd2VyLmgKaW5kZXggMjhhYmZjMzIyLi5iZTlmMWUyMTkgMTAwNjQ0Ci0tLSBhL292ZXJsYXkv
cG93ZXIuaAorKysgYi9vdmVybGF5L3Bvd2VyLmgKQEAgLTI4LDE5ICsyOCwyMCBAQAogI2luY2x1
ZGUgPHN0ZGludC5oPgogCiBzdHJ1Y3QgcG93ZXIgewotCXN0cnVjdCBwb3dlcl9zdGF0IHsKLQkJ
dWludDY0X3QgZW5lcmd5OwotCQl1aW50NjRfdCB0aW1lc3RhbXA7Ci0JfSBzdGF0WzJdOworCXN0
cnVjdCBwb3dlcl9kb21haW4geworCQlkb3VibGUgc2NhbGU7CisJCXVpbnQ2NF90IHBvd2VyX21X
OworCQlpbnQgbmV3X3NhbXBsZTsKKwkJaW50IGZkOworCisJCXN0cnVjdCBwb3dlcl9zdGF0IHsK
KwkJCXVpbnQ2NF90IGVuZXJneTsKKwkJCXVpbnQ2NF90IHRpbWVzdGFtcDsKKwkJfSBzdGF0WzJd
OworCX0gZ3B1LCBwa2c7CiAKLQlpbnQgZmQ7CiAJaW50IGVycm9yOwogCWludCBjb3VudDsKLQlp
bnQgbmV3X3NhbXBsZTsKLQotCXVpbnQ2NF90IHBvd2VyX21XOwotCi0JZG91YmxlIHJhcGxfc2Nh
bGU7CiB9OwogCiBpbnQgcG93ZXJfaW5pdChzdHJ1Y3QgcG93ZXIgKnBvd2VyKTsKLS0gCjIuMjMu
MAoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KSW50ZWwt
Z2Z4IG1haWxpbmcgbGlzdApJbnRlbC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8v
bGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vaW50ZWwtZ2Z4

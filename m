Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 4FF65B0C5F
	for <lists+intel-gfx@lfdr.de>; Thu, 12 Sep 2019 12:13:55 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 1EAC16ECA2;
	Thu, 12 Sep 2019 10:13:53 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 6EFAA6E88B
 for <intel-gfx@lists.freedesktop.org>; Thu, 12 Sep 2019 10:13:51 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18462014-1500050 
 for multiple; Thu, 12 Sep 2019 11:13:40 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Thu, 12 Sep 2019 11:13:39 +0100
Message-Id: <20190912101339.543-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20190911163815.11430-1-chris@chris-wilson.co.uk>
References: <20190911163815.11430-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH v4] drm/i915/pmu: Use GT parked for estimating
 RC6 while asleep
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

QXMgd2UgdHJhY2sgd2hlbiB3ZSBwdXQgdGhlIEdUIGRldmljZSB0byBzbGVlcCB1cG9uIGlkbGlu
Zywgd2UgY2FuIHVzZQp0aGF0IGNhbGxiYWNrIHRvIHNhbXBsZSB0aGUgY3VycmVudCByYzYgY291
bnRlcnMgYW5kIHJlY29yZCB0aGUKdGltZXN0YW1wIGZvciBlc3RpbWF0aW5nIHNhbXBsZXMgYWZ0
ZXIgdGhhdCBwb2ludCB3aGlsZSBhc2xlZXAuCgp2MjogU3RpY2sgdG8gdXNpbmcga3RpbWVfdAp2
MzogVHJhY2sgdXNlcl93YWtlcmVmcyB0aGF0IGludGVyZmVyZSB3aXRoIHRoZSBuZXcKaW50ZWxf
Z3RfcG1fd2FpdF9mb3JfaWRsZQp2NDogTm8gbmVlZCBmb3IgcGFya2VkL3VucGFya2VkIGVzdGlt
YXRpb24gaWYgIUNPTkZJR19QTQoKQnVnemlsbGE6IGh0dHBzOi8vYnVncy5mcmVlZGVza3RvcC5v
cmcvc2hvd19idWcuY2dpP2lkPTEwNTAxMApTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNo
cmlzQGNocmlzLXdpbHNvbi5jby51az4KQ2M6IFR2cnRrbyBVcnN1bGluIDx0dnJ0a28udXJzdWxp
bkBpbnRlbC5jb20+Ci0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3BtLmMg
ICB8ICAyMiArKysKIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2d0X3R5cGVzLmggfCAg
IDEgKwogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kZWJ1Z2ZzLmMgICAgICB8ICAyMiArLS0K
IGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcG11LmMgICAgICAgICAgfCAyMjUgKysrKysrKysr
KysrLS0tLS0tLS0tLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcG11LmggICAgICAgICAg
fCAgMTQgKy0KIDUgZmlsZXMgY2hhbmdlZCwgMTU4IGluc2VydGlvbnMoKyksIDEyNiBkZWxldGlv
bnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fcG0u
YyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9wbS5jCmluZGV4IDNiZDc2NDEw
NGQ0MS4uYTExYWQ0ZDkxNGNhIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0v
aTkxNV9nZW1fcG0uYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fcG0u
YwpAQCAtMTQxLDYgKzE0MSwyNCBAQCBib29sIGk5MTVfZ2VtX2xvYWRfcG93ZXJfY29udGV4dChz
dHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKIAlyZXR1cm4gc3dpdGNoX3RvX2tlcm5lbF9j
b250ZXh0X3N5bmMoJmk5MTUtPmd0KTsKIH0KIAorc3RhdGljIHZvaWQgdXNlcl9mb3JjZXdha2Uo
c3RydWN0IGludGVsX2d0ICpndCwgYm9vbCBzdXNwZW5kKQoreworCWludCBjb3VudCA9IGF0b21p
Y19yZWFkKCZndC0+dXNlcl93YWtlcmVmKTsKKworCS8qIEluc2lkZSBzdXNwZW5kL3Jlc3VtZSBz
byBzaW5nbGUgdGhyZWFkZWQsIG5vIHJhY2VzIHRvIHdvcnJ5IGFib3V0LiAqLworCWlmIChsaWtl
bHkoIWNvdW50KSkKKwkJcmV0dXJuOworCisJaW50ZWxfZ3RfcG1fZ2V0KGd0KTsKKwlpZiAoc3Vz
cGVuZCkgeworCQlHRU1fQlVHX09OKGNvdW50ID4gYXRvbWljX3JlYWQoJmd0LT53YWtlcmVmLmNv
dW50KSk7CisJCWF0b21pY19zdWIoY291bnQsICZndC0+d2FrZXJlZi5jb3VudCk7CisJfSBlbHNl
IHsKKwkJYXRvbWljX2FkZChjb3VudCwgJmd0LT53YWtlcmVmLmNvdW50KTsKKwl9CisJaW50ZWxf
Z3RfcG1fcHV0KGd0KTsKK30KKwogdm9pZCBpOTE1X2dlbV9zdXNwZW5kKHN0cnVjdCBkcm1faTkx
NV9wcml2YXRlICppOTE1KQogewogCUdFTV9UUkFDRSgiXG4iKTsKQEAgLTE0OCw2ICsxNjYsOCBA
QCB2b2lkIGk5MTVfZ2VtX3N1c3BlbmQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCiAJ
aW50ZWxfd2FrZXJlZl9hdXRvKCZpOTE1LT5nZ3R0LnVzZXJmYXVsdF93YWtlcmVmLCAwKTsKIAlm
bHVzaF93b3JrcXVldWUoaTkxNS0+d3EpOwogCisJdXNlcl9mb3JjZXdha2UoJmk5MTUtPmd0LCB0
cnVlKTsKKwogCW11dGV4X2xvY2soJmk5MTUtPmRybS5zdHJ1Y3RfbXV0ZXgpOwogCiAJLyoKQEAg
LTI1OSw2ICsyNzksOCBAQCB2b2lkIGk5MTVfZ2VtX3Jlc3VtZShzdHJ1Y3QgZHJtX2k5MTVfcHJp
dmF0ZSAqaTkxNSkKIAlpZiAoIWk5MTVfZ2VtX2xvYWRfcG93ZXJfY29udGV4dChpOTE1KSkKIAkJ
Z290byBlcnJfd2VkZ2VkOwogCisJdXNlcl9mb3JjZXdha2UoJmk5MTUtPmd0LCBmYWxzZSk7CisK
IG91dF91bmxvY2s6CiAJaW50ZWxfdW5jb3JlX2ZvcmNld2FrZV9wdXQoJmk5MTUtPnVuY29yZSwg
Rk9SQ0VXQUtFX0FMTCk7CiAJbXV0ZXhfdW5sb2NrKCZpOTE1LT5kcm0uc3RydWN0X211dGV4KTsK
ZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2d0X3R5cGVzLmggYi9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9ndF90eXBlcy5oCmluZGV4IGRjMjk1YzE5NmQx
MS4uMzAzOWNlZjY0YjExIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRl
bF9ndF90eXBlcy5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2d0X3R5cGVz
LmgKQEAgLTUwLDYgKzUwLDcgQEAgc3RydWN0IGludGVsX2d0IHsKIAl9IHRpbWVsaW5lczsKIAog
CXN0cnVjdCBpbnRlbF93YWtlcmVmIHdha2VyZWY7CisJYXRvbWljX3QgdXNlcl93YWtlcmVmOwog
CiAJc3RydWN0IGxpc3RfaGVhZCBjbG9zZWRfdm1hOwogCXNwaW5sb2NrX3QgY2xvc2VkX2xvY2s7
IC8qIGd1YXJkcyB0aGUgbGlzdCBvZiBjbG9zZWRfdm1hICovCmRpZmYgLS1naXQgYS9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9pOTE1X2RlYnVnZnMuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVf
ZGVidWdmcy5jCmluZGV4IGU1ODM1MzM3ZjAyMi4uZjNhZTUyNWI3N2MwIDEwMDY0NAotLS0gYS9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2RlYnVnZnMuYworKysgYi9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9pOTE1X2RlYnVnZnMuYwpAQCAtMzk5NSwxMyArMzk5NSwxMiBAQCBzdGF0aWMgaW50IGk5
MTVfc3NldV9zdGF0dXMoc3RydWN0IHNlcV9maWxlICptLCB2b2lkICp1bnVzZWQpCiBzdGF0aWMg
aW50IGk5MTVfZm9yY2V3YWtlX29wZW4oc3RydWN0IGlub2RlICppbm9kZSwgc3RydWN0IGZpbGUg
KmZpbGUpCiB7CiAJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUgPSBpbm9kZS0+aV9wcml2
YXRlOworCXN0cnVjdCBpbnRlbF9ndCAqZ3QgPSAmaTkxNS0+Z3Q7CiAKLQlpZiAoSU5URUxfR0VO
KGk5MTUpIDwgNikKLQkJcmV0dXJuIDA7Ci0KLQlmaWxlLT5wcml2YXRlX2RhdGEgPQotCQkodm9p
ZCAqKSh1aW50cHRyX3QpaW50ZWxfcnVudGltZV9wbV9nZXQoJmk5MTUtPnJ1bnRpbWVfcG0pOwot
CWludGVsX3VuY29yZV9mb3JjZXdha2VfdXNlcl9nZXQoJmk5MTUtPnVuY29yZSk7CisJYXRvbWlj
X2luYygmZ3QtPnVzZXJfd2FrZXJlZik7CisJaW50ZWxfZ3RfcG1fZ2V0KGd0KTsKKwlpZiAoSU5U
RUxfR0VOKGk5MTUpID49IDYpCisJCWludGVsX3VuY29yZV9mb3JjZXdha2VfdXNlcl9nZXQoZ3Qt
PnVuY29yZSk7CiAKIAlyZXR1cm4gMDsKIH0KQEAgLTQwMDksMTMgKzQwMDgsMTIgQEAgc3RhdGlj
IGludCBpOTE1X2ZvcmNld2FrZV9vcGVuKHN0cnVjdCBpbm9kZSAqaW5vZGUsIHN0cnVjdCBmaWxl
ICpmaWxlKQogc3RhdGljIGludCBpOTE1X2ZvcmNld2FrZV9yZWxlYXNlKHN0cnVjdCBpbm9kZSAq
aW5vZGUsIHN0cnVjdCBmaWxlICpmaWxlKQogewogCXN0cnVjdCBkcm1faTkxNV9wcml2YXRlICpp
OTE1ID0gaW5vZGUtPmlfcHJpdmF0ZTsKKwlzdHJ1Y3QgaW50ZWxfZ3QgKmd0ID0gJmk5MTUtPmd0
OwogCi0JaWYgKElOVEVMX0dFTihpOTE1KSA8IDYpCi0JCXJldHVybiAwOwotCi0JaW50ZWxfdW5j
b3JlX2ZvcmNld2FrZV91c2VyX3B1dCgmaTkxNS0+dW5jb3JlKTsKLQlpbnRlbF9ydW50aW1lX3Bt
X3B1dCgmaTkxNS0+cnVudGltZV9wbSwKLQkJCSAgICAgKGludGVsX3dha2VyZWZfdCkodWludHB0
cl90KWZpbGUtPnByaXZhdGVfZGF0YSk7CisJaWYgKElOVEVMX0dFTihpOTE1KSA+PSA2KQorCQlp
bnRlbF91bmNvcmVfZm9yY2V3YWtlX3VzZXJfcHV0KCZpOTE1LT51bmNvcmUpOworCWludGVsX2d0
X3BtX3B1dChndCk7CisJYXRvbWljX2RlYygmZ3QtPnVzZXJfd2FrZXJlZik7CiAKIAlyZXR1cm4g
MDsKIH0KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcG11LmMgYi9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3BtdS5jCmluZGV4IDhlMjUxZTcxOTM5MC4uZjkzNGQ4ZGZi
MmQxIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3BtdS5jCisrKyBiL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcG11LmMKQEAgLTExNiwyMCArMTE2LDIzIEBAIHN0YXRp
YyBib29sIHBtdV9uZWVkc190aW1lcihzdHJ1Y3QgaTkxNV9wbXUgKnBtdSwgYm9vbCBncHVfYWN0
aXZlKQogCXJldHVybiBlbmFibGU7CiB9CiAKLXZvaWQgaTkxNV9wbXVfZ3RfcGFya2VkKHN0cnVj
dCBkcm1faTkxNV9wcml2YXRlICppOTE1KQorc3RhdGljIHU2NCBfX2dldF9yYzYoY29uc3Qgc3Ry
dWN0IGludGVsX2d0ICpndCkKIHsKLQlzdHJ1Y3QgaTkxNV9wbXUgKnBtdSA9ICZpOTE1LT5wbXU7
CisJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUgPSBndC0+aTkxNTsKKwl1NjQgdmFsOwog
Ci0JaWYgKCFwbXUtPmJhc2UuZXZlbnRfaW5pdCkKLQkJcmV0dXJuOworCXZhbCA9IGludGVsX3Jj
Nl9yZXNpZGVuY3lfbnMoaTkxNSwKKwkJCQkgICAgIElTX1ZBTExFWVZJRVcoaTkxNSkgPworCQkJ
CSAgICAgVkxWX0dUX1JFTkRFUl9SQzYgOgorCQkJCSAgICAgR0VONl9HVF9HRlhfUkM2KTsKIAot
CXNwaW5fbG9ja19pcnEoJnBtdS0+bG9jayk7Ci0JLyoKLQkgKiBTaWduYWwgc2FtcGxpbmcgdGlt
ZXIgdG8gc3RvcCBpZiBvbmx5IGVuZ2luZSBldmVudHMgYXJlIGVuYWJsZWQgYW5kCi0JICogR1BV
IHdlbnQgaWRsZS4KLQkgKi8KLQlwbXUtPnRpbWVyX2VuYWJsZWQgPSBwbXVfbmVlZHNfdGltZXIo
cG11LCBmYWxzZSk7Ci0Jc3Bpbl91bmxvY2tfaXJxKCZwbXUtPmxvY2spOworCWlmIChIQVNfUkM2
cChpOTE1KSkKKwkJdmFsICs9IGludGVsX3JjNl9yZXNpZGVuY3lfbnMoaTkxNSwgR0VONl9HVF9H
RlhfUkM2cCk7CisKKwlpZiAoSEFTX1JDNnBwKGk5MTUpKQorCQl2YWwgKz0gaW50ZWxfcmM2X3Jl
c2lkZW5jeV9ucyhpOTE1LCBHRU42X0dUX0dGWF9SQzZwcCk7CisKKwlyZXR1cm4gdmFsOwogfQog
CiBzdGF0aWMgdm9pZCBfX2k5MTVfcG11X21heWJlX3N0YXJ0X3RpbWVyKHN0cnVjdCBpOTE1X3Bt
dSAqcG11KQpAQCAtMTQzLDYgKzE0Niw0MiBAQCBzdGF0aWMgdm9pZCBfX2k5MTVfcG11X21heWJl
X3N0YXJ0X3RpbWVyKHN0cnVjdCBpOTE1X3BtdSAqcG11KQogCX0KIH0KIAorI2lmIElTX0VOQUJM
RUQoQ09ORklHX1BNKQorCitzdGF0aWMgaW5saW5lIHM2NCBrdGltZV9zaW5jZShjb25zdCBrdGlt
ZV90IGt0KQoreworCXJldHVybiBrdGltZV90b19ucyhrdGltZV9zdWIoa3RpbWVfZ2V0KCksIGt0
KSk7Cit9CisKK3ZvaWQgaTkxNV9wbXVfZ3RfcGFya2VkKHN0cnVjdCBkcm1faTkxNV9wcml2YXRl
ICppOTE1KQoreworCXN0cnVjdCBpOTE1X3BtdSAqcG11ID0gJmk5MTUtPnBtdTsKKwl1NjQgdmFs
OworCisJaWYgKCFwbXUtPmJhc2UuZXZlbnRfaW5pdCkKKwkJcmV0dXJuOworCisJc3Bpbl9sb2Nr
X2lycSgmcG11LT5sb2NrKTsKKworCXZhbCA9IDA7CisJaWYgKHBtdS0+c2FtcGxlW19fSTkxNV9T
QU1QTEVfUkM2XS5jdXIpCisJCXZhbCA9IF9fZ2V0X3JjNigmaTkxNS0+Z3QpOworCisJaWYgKHZh
bCA+PSBwbXUtPnNhbXBsZVtfX0k5MTVfU0FNUExFX1JDNl9FU1RJTUFURURdLmN1cikgeworCQlw
bXUtPnNhbXBsZVtfX0k5MTVfU0FNUExFX1JDNl9FU1RJTUFURURdLmN1ciA9IDA7CisJCXBtdS0+
c2FtcGxlW19fSTkxNV9TQU1QTEVfUkM2XS5jdXIgPSB2YWw7CisJfQorCXBtdS0+c2xlZXBfbGFz
dCA9IGt0aW1lX2dldCgpOworCisJLyoKKwkgKiBTaWduYWwgc2FtcGxpbmcgdGltZXIgdG8gc3Rv
cCBpZiBvbmx5IGVuZ2luZSBldmVudHMgYXJlIGVuYWJsZWQgYW5kCisJICogR1BVIHdlbnQgaWRs
ZS4KKwkgKi8KKwlwbXUtPnRpbWVyX2VuYWJsZWQgPSBwbXVfbmVlZHNfdGltZXIocG11LCBmYWxz
ZSk7CisKKwlzcGluX3VubG9ja19pcnEoJnBtdS0+bG9jayk7Cit9CisKIHZvaWQgaTkxNV9wbXVf
Z3RfdW5wYXJrZWQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCiB7CiAJc3RydWN0IGk5
MTVfcG11ICpwbXUgPSAmaTkxNS0+cG11OwpAQCAtMTUxLDEzICsxOTAsNzkgQEAgdm9pZCBpOTE1
X3BtdV9ndF91bnBhcmtlZChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSkKIAkJcmV0dXJu
OwogCiAJc3Bpbl9sb2NrX2lycSgmcG11LT5sb2NrKTsKKwogCS8qCiAJICogUmUtZW5hYmxlIHNh
bXBsaW5nIHRpbWVyIHdoZW4gR1BVIGdvZXMgYWN0aXZlLgogCSAqLwogCV9faTkxNV9wbXVfbWF5
YmVfc3RhcnRfdGltZXIocG11KTsKKworCS8qIEVzdGltYXRlIGhvdyBsb25nIHdlIHNsZXB0IGFu
ZCBhY2N1bXVsYXRlIHRoYXQgaW50byByYzYgY291bnRlcnMgKi8KKwlpZiAocG11LT5zYW1wbGVb
X19JOTE1X1NBTVBMRV9SQzZdLmN1cikgeworCQl1NjQgdmFsOworCisJCXZhbCA9IGt0aW1lX3Np
bmNlKHBtdS0+c2xlZXBfbGFzdCk7CisJCXZhbCArPSBwbXUtPnNhbXBsZVtfX0k5MTVfU0FNUExF
X1JDNl0uY3VyOworCisJCXBtdS0+c2FtcGxlW19fSTkxNV9TQU1QTEVfUkM2X0VTVElNQVRFRF0u
Y3VyID0gdmFsOworCX0KKwogCXNwaW5fdW5sb2NrX2lycSgmcG11LT5sb2NrKTsKIH0KIAorc3Rh
dGljIHU2NCBnZXRfcmM2KHN0cnVjdCBpbnRlbF9ndCAqZ3QpCit7CisJc3RydWN0IGRybV9pOTE1
X3ByaXZhdGUgKmk5MTUgPSBndC0+aTkxNTsKKwlzdHJ1Y3QgaTkxNV9wbXUgKnBtdSA9ICZpOTE1
LT5wbXU7CisJdW5zaWduZWQgbG9uZyBmbGFnczsKKwl1NjQgdmFsOworCisJc3Bpbl9sb2NrX2ly
cXNhdmUoJnBtdS0+bG9jaywgZmxhZ3MpOworCisJaWYgKGludGVsX2d0X3BtX2dldF9pZl9hd2Fr
ZShndCkpIHsKKwkJdmFsID0gX19nZXRfcmM2KGd0KTsKKwkJaW50ZWxfZ3RfcG1fcHV0KGd0KTsK
KworCQkvKgorCQkgKiBJZiB3ZSBhcmUgY29taW5nIGJhY2sgZnJvbSBiZWluZyBydW50aW1lIHN1
c3BlbmRlZCB3ZSBtdXN0CisJCSAqIGJlIGNhcmVmdWwgbm90IHRvIHJlcG9ydCBhIGxhcmdlciB2
YWx1ZSB0aGFuIHJldHVybmVkCisJCSAqIHByZXZpb3VzbHkuCisJCSAqLworCisJCWlmICh2YWwg
Pj0gcG11LT5zYW1wbGVbX19JOTE1X1NBTVBMRV9SQzZfRVNUSU1BVEVEXS5jdXIpIHsKKwkJCXBt
dS0+c2FtcGxlW19fSTkxNV9TQU1QTEVfUkM2X0VTVElNQVRFRF0uY3VyID0gMDsKKwkJCXBtdS0+
c2FtcGxlW19fSTkxNV9TQU1QTEVfUkM2XS5jdXIgPSB2YWw7CisJCX0gZWxzZSB7CisJCQl2YWwg
PSBwbXUtPnNhbXBsZVtfX0k5MTVfU0FNUExFX1JDNl9FU1RJTUFURURdLmN1cjsKKwkJfQorCX0g
ZWxzZSB7CisJCS8qCisJCSAqIFdlIGFyZSBydW50aW1lIHN1c3BlbmRlZC4KKwkJICoKKwkJICog
UmVwb3J0IHRoZSBkZWx0YSBmcm9tIHdoZW4gdGhlIGRldmljZSB3YXMgc3VzcGVuZGVkIHRvIG5v
dywKKwkJICogb24gdG9wIG9mIHRoZSBsYXN0IGtub3duIHJlYWwgdmFsdWUsIGFzIHRoZSBhcHBy
b3hpbWF0ZWQgUkM2CisJCSAqIGNvdW50ZXIgdmFsdWUuCisJCSAqLworCisJCXZhbCA9IGt0aW1l
X3NpbmNlKHBtdS0+c2xlZXBfbGFzdCk7CisJCXZhbCArPSBwbXUtPnNhbXBsZVtfX0k5MTVfU0FN
UExFX1JDNl0uY3VyOworCisJCXBtdS0+c2FtcGxlW19fSTkxNV9TQU1QTEVfUkM2X0VTVElNQVRF
RF0uY3VyID0gdmFsOworCX0KKworCXNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJnBtdS0+bG9jaywg
ZmxhZ3MpOworCisJcmV0dXJuIHZhbDsKK30KKworI2Vsc2UKKworc3RhdGljIHU2NCBnZXRfcmM2
KHN0cnVjdCBpbnRlbF9ndCAqZ3QpCit7CisJcmV0dXJuIF9fZ2V0X3JjNihndCk7Cit9CisKKyNl
bmRpZgorCiBzdGF0aWMgdm9pZAogYWRkX3NhbXBsZShzdHJ1Y3QgaTkxNV9wbXVfc2FtcGxlICpz
YW1wbGUsIHUzMiB2YWwpCiB7CkBAIC00MjYsMTA0ICs1MzEsNiBAQCBzdGF0aWMgaW50IGk5MTVf
cG11X2V2ZW50X2luaXQoc3RydWN0IHBlcmZfZXZlbnQgKmV2ZW50KQogCXJldHVybiAwOwogfQog
Ci1zdGF0aWMgdTY0IF9fZ2V0X3JjNihzdHJ1Y3QgaW50ZWxfZ3QgKmd0KQotewotCXN0cnVjdCBk
cm1faTkxNV9wcml2YXRlICppOTE1ID0gZ3QtPmk5MTU7Ci0JdTY0IHZhbDsKLQotCXZhbCA9IGlu
dGVsX3JjNl9yZXNpZGVuY3lfbnMoaTkxNSwKLQkJCQkgICAgIElTX1ZBTExFWVZJRVcoaTkxNSkg
PwotCQkJCSAgICAgVkxWX0dUX1JFTkRFUl9SQzYgOgotCQkJCSAgICAgR0VONl9HVF9HRlhfUkM2
KTsKLQotCWlmIChIQVNfUkM2cChpOTE1KSkKLQkJdmFsICs9IGludGVsX3JjNl9yZXNpZGVuY3lf
bnMoaTkxNSwgR0VONl9HVF9HRlhfUkM2cCk7Ci0KLQlpZiAoSEFTX1JDNnBwKGk5MTUpKQotCQl2
YWwgKz0gaW50ZWxfcmM2X3Jlc2lkZW5jeV9ucyhpOTE1LCBHRU42X0dUX0dGWF9SQzZwcCk7Ci0K
LQlyZXR1cm4gdmFsOwotfQotCi1zdGF0aWMgdTY0IGdldF9yYzYoc3RydWN0IGludGVsX2d0ICpn
dCkKLXsKLSNpZiBJU19FTkFCTEVEKENPTkZJR19QTSkKLQlzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0
ZSAqaTkxNSA9IGd0LT5pOTE1OwotCXN0cnVjdCBpbnRlbF9ydW50aW1lX3BtICpycG0gPSAmaTkx
NS0+cnVudGltZV9wbTsKLQlzdHJ1Y3QgaTkxNV9wbXUgKnBtdSA9ICZpOTE1LT5wbXU7Ci0JaW50
ZWxfd2FrZXJlZl90IHdha2VyZWY7Ci0JdW5zaWduZWQgbG9uZyBmbGFnczsKLQl1NjQgdmFsOwot
Ci0Jd2FrZXJlZiA9IGludGVsX3J1bnRpbWVfcG1fZ2V0X2lmX2luX3VzZShycG0pOwotCWlmICh3
YWtlcmVmKSB7Ci0JCXZhbCA9IF9fZ2V0X3JjNihndCk7Ci0JCWludGVsX3J1bnRpbWVfcG1fcHV0
KHJwbSwgd2FrZXJlZik7Ci0KLQkJLyoKLQkJICogSWYgd2UgYXJlIGNvbWluZyBiYWNrIGZyb20g
YmVpbmcgcnVudGltZSBzdXNwZW5kZWQgd2UgbXVzdAotCQkgKiBiZSBjYXJlZnVsIG5vdCB0byBy
ZXBvcnQgYSBsYXJnZXIgdmFsdWUgdGhhbiByZXR1cm5lZAotCQkgKiBwcmV2aW91c2x5LgotCQkg
Ki8KLQotCQlzcGluX2xvY2tfaXJxc2F2ZSgmcG11LT5sb2NrLCBmbGFncyk7Ci0KLQkJaWYgKHZh
bCA+PSBwbXUtPnNhbXBsZVtfX0k5MTVfU0FNUExFX1JDNl9FU1RJTUFURURdLmN1cikgewotCQkJ
cG11LT5zYW1wbGVbX19JOTE1X1NBTVBMRV9SQzZfRVNUSU1BVEVEXS5jdXIgPSAwOwotCQkJcG11
LT5zYW1wbGVbX19JOTE1X1NBTVBMRV9SQzZdLmN1ciA9IHZhbDsKLQkJfSBlbHNlIHsKLQkJCXZh
bCA9IHBtdS0+c2FtcGxlW19fSTkxNV9TQU1QTEVfUkM2X0VTVElNQVRFRF0uY3VyOwotCQl9Ci0K
LQkJc3Bpbl91bmxvY2tfaXJxcmVzdG9yZSgmcG11LT5sb2NrLCBmbGFncyk7Ci0JfSBlbHNlIHsK
LQkJc3RydWN0IGRldmljZSAqa2RldiA9IHJwbS0+a2RldjsKLQotCQkvKgotCQkgKiBXZSBhcmUg
cnVudGltZSBzdXNwZW5kZWQuCi0JCSAqCi0JCSAqIFJlcG9ydCB0aGUgZGVsdGEgZnJvbSB3aGVu
IHRoZSBkZXZpY2Ugd2FzIHN1c3BlbmRlZCB0byBub3csCi0JCSAqIG9uIHRvcCBvZiB0aGUgbGFz
dCBrbm93biByZWFsIHZhbHVlLCBhcyB0aGUgYXBwcm94aW1hdGVkIFJDNgotCQkgKiBjb3VudGVy
IHZhbHVlLgotCQkgKi8KLQkJc3Bpbl9sb2NrX2lycXNhdmUoJnBtdS0+bG9jaywgZmxhZ3MpOwot
Ci0JCS8qCi0JCSAqIEFmdGVyIHRoZSBhYm92ZSBicmFuY2ggaW50ZWxfcnVudGltZV9wbV9nZXRf
aWZfaW5fdXNlIGZhaWxlZAotCQkgKiB0byBnZXQgdGhlIHJ1bnRpbWUgUE0gcmVmZXJlbmNlIHdl
IGNhbm5vdCBhc3N1bWUgd2UgYXJlIGluCi0JCSAqIHJ1bnRpbWUgc3VzcGVuZCBzaW5jZSB3ZSBj
YW4gZWl0aGVyOiBhKSByYWNlIHdpdGggY29taW5nIG91dAotCQkgKiBvZiBpdCBiZWZvcmUgd2Ug
dG9vayB0aGUgcG93ZXIubG9jaywgb3IgYikgdGhlcmUgYXJlIG90aGVyCi0JCSAqIHN0YXRlcyB0
aGFuIHN1c3BlbmRlZCB3aGljaCBjYW4gYnJpbmcgdXMgaGVyZS4KLQkJICoKLQkJICogV2UgbmVl
ZCB0byBkb3VibGUtY2hlY2sgdGhhdCB3ZSBhcmUgaW5kZWVkIGN1cnJlbnRseSBydW50aW1lCi0J
CSAqIHN1c3BlbmRlZCBhbmQgaWYgbm90IHdlIGNhbm5vdCBkbyBiZXR0ZXIgdGhhbiByZXBvcnQg
dGhlIGxhc3QKLQkJICoga25vd24gUkM2IHZhbHVlLgotCQkgKi8KLQkJaWYgKHBtX3J1bnRpbWVf
c3RhdHVzX3N1c3BlbmRlZChrZGV2KSkgewotCQkJdmFsID0gcG1fcnVudGltZV9zdXNwZW5kZWRf
dGltZShrZGV2KTsKLQotCQkJaWYgKCFwbXUtPnNhbXBsZVtfX0k5MTVfU0FNUExFX1JDNl9FU1RJ
TUFURURdLmN1cikKLQkJCQlwbXUtPnN1c3BlbmRlZF90aW1lX2xhc3QgPSB2YWw7Ci0KLQkJCXZh
bCAtPSBwbXUtPnN1c3BlbmRlZF90aW1lX2xhc3Q7Ci0JCQl2YWwgKz0gcG11LT5zYW1wbGVbX19J
OTE1X1NBTVBMRV9SQzZdLmN1cjsKLQotCQkJcG11LT5zYW1wbGVbX19JOTE1X1NBTVBMRV9SQzZf
RVNUSU1BVEVEXS5jdXIgPSB2YWw7Ci0JCX0gZWxzZSBpZiAocG11LT5zYW1wbGVbX19JOTE1X1NB
TVBMRV9SQzZfRVNUSU1BVEVEXS5jdXIpIHsKLQkJCXZhbCA9IHBtdS0+c2FtcGxlW19fSTkxNV9T
QU1QTEVfUkM2X0VTVElNQVRFRF0uY3VyOwotCQl9IGVsc2UgewotCQkJdmFsID0gcG11LT5zYW1w
bGVbX19JOTE1X1NBTVBMRV9SQzZdLmN1cjsKLQkJfQotCi0JCXNwaW5fdW5sb2NrX2lycXJlc3Rv
cmUoJnBtdS0+bG9jaywgZmxhZ3MpOwotCX0KLQotCXJldHVybiB2YWw7Ci0jZWxzZQotCXJldHVy
biBfX2dldF9yYzYoZ3QpOwotI2VuZGlmCi19Ci0KIHN0YXRpYyB1NjQgX19pOTE1X3BtdV9ldmVu
dF9yZWFkKHN0cnVjdCBwZXJmX2V2ZW50ICpldmVudCkKIHsKIAlzdHJ1Y3QgZHJtX2k5MTVfcHJp
dmF0ZSAqaTkxNSA9CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3BtdS5o
IGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wbXUuaAppbmRleCA0ZmM0ZjI0NzgzMDEuLmNh
NDQ3NThlZjE5OCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9wbXUuaAor
KysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3BtdS5oCkBAIC05Nyw5ICs5Nyw5IEBAIHN0
cnVjdCBpOTE1X3BtdSB7CiAJICovCiAJc3RydWN0IGk5MTVfcG11X3NhbXBsZSBzYW1wbGVbX19J
OTE1X05VTV9QTVVfU0FNUExFUlNdOwogCS8qKgotCSAqIEBzdXNwZW5kZWRfdGltZV9sYXN0OiBD
YWNoZWQgc3VzcGVuZCB0aW1lIGZyb20gUE0gY29yZS4KKwkgKiBAc2xlZXBfbGFzdDogTGFzdCB0
aW1lIEdUIHBhcmtlZCBmb3IgUkM2IGVzdGltYXRpb24uCiAJICovCi0JdTY0IHN1c3BlbmRlZF90
aW1lX2xhc3Q7CisJa3RpbWVfdCBzbGVlcF9sYXN0OwogCS8qKgogCSAqIEBpOTE1X2F0dHI6IE1l
bW9yeSBibG9jayBob2xkaW5nIGRldmljZSBhdHRyaWJ1dGVzLgogCSAqLwpAQCAtMTEwLDE0ICsx
MTAsMTggQEAgc3RydWN0IGk5MTVfcG11IHsKIAl2b2lkICpwbXVfYXR0cjsKIH07CiAKLSNpZmRl
ZiBDT05GSUdfUEVSRl9FVkVOVFMKKyNpZiBJU19FTkFCTEVEKENPTkZJR19QRVJGX0VWRU5UUykK
IHZvaWQgaTkxNV9wbXVfcmVnaXN0ZXIoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpOwog
dm9pZCBpOTE1X3BtdV91bnJlZ2lzdGVyKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KTsK
LXZvaWQgaTkxNV9wbXVfZ3RfcGFya2VkKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KTsK
LXZvaWQgaTkxNV9wbXVfZ3RfdW5wYXJrZWQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUp
OwogI2Vsc2UKIHN0YXRpYyBpbmxpbmUgdm9pZCBpOTE1X3BtdV9yZWdpc3RlcihzdHJ1Y3QgZHJt
X2k5MTVfcHJpdmF0ZSAqaTkxNSkge30KIHN0YXRpYyBpbmxpbmUgdm9pZCBpOTE1X3BtdV91bnJl
Z2lzdGVyKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KSB7fQorI2VuZGlmCisKKyNpZiBJ
U19FTkFCTEVEKENPTkZJR19QRVJGX0VWRU5UUykgJiYgSVNfRU5BQkxFRChDT05GSUdfUE0pCit2
b2lkIGk5MTVfcG11X2d0X3BhcmtlZChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAqaTkxNSk7Cit2
b2lkIGk5MTVfcG11X2d0X3VucGFya2VkKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KTsK
KyNlbHNlCiBzdGF0aWMgaW5saW5lIHZvaWQgaTkxNV9wbXVfZ3RfcGFya2VkKHN0cnVjdCBkcm1f
aTkxNV9wcml2YXRlICppOTE1KSB7fQogc3RhdGljIGlubGluZSB2b2lkIGk5MTVfcG11X2d0X3Vu
cGFya2VkKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KSB7fQogI2VuZGlmCi0tIAoyLjIz
LjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCkludGVs
LWdmeCBtYWlsaW5nIGxpc3QKSW50ZWwtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczov
L2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWdmeA==

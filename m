Return-Path: <intel-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gfx@lfdr.de
Delivered-To: lists+intel-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 22DE261791
	for <lists+intel-gfx@lfdr.de>; Sun,  7 Jul 2019 23:02:23 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 71C6E89AB5;
	Sun,  7 Jul 2019 21:02:21 +0000 (UTC)
X-Original-To: intel-gfx@lists.freedesktop.org
Delivered-To: intel-gfx@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 323EA89AB5
 for <intel-gfx@lists.freedesktop.org>; Sun,  7 Jul 2019 21:02:20 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17163712-1500050 
 for multiple; Sun, 07 Jul 2019 22:00:28 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Date: Sun,  7 Jul 2019 22:00:21 +0100
Message-Id: <20190707210024.26192-9-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190707210024.26192-1-chris@chris-wilson.co.uk>
References: <20190707210024.26192-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
Subject: [Intel-gfx] [PATCH 08/11] drm/i915/gtt: Recursive cleanup for gen8
X-BeenThere: intel-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Intel graphics driver community testing & development
 <intel-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gfx>
List-Post: <mailto:intel-gfx@lists.freedesktop.org>
List-Help: <mailto:intel-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gfx>,
 <mailto:intel-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gfx-bounces@lists.freedesktop.org
Sender: "Intel-gfx" <intel-gfx-bounces@lists.freedesktop.org>

V2l0aCBhbiBleHBsaWNpdCBsZXZlbCwgd2UgY2FuIHJlZmFjdG9yIHRoZSBzZXBhcmF0ZSBjbGVh
bnVwIGZ1bmN0aW9ucwphcyBhIHNpbXBsZSByZWN1cnNpdmUgZnVuY3Rpb24uIFdlIHRha2UgdGhl
IG9wcG9ydHVuaXR5IHRvIHBhc3MgZG93biB0aGUKc2l6ZSBvZiBlYWNoIGxldmVsIHNvIHRoYXQg
d2UgY2FuIGRlYWwgd2l0aCB0aGUgZGlmZmVyZW50IHNpemVzIG9mCnRvcC1sZXZlbCBhbmQgYXZv
aWQgb3ZlciBhbGxvY2F0aW5nIGZvciAzMi8zNi1iaXQgdm0uCgpTaWduZWQtb2ZmLWJ5OiBDaHJp
cyBXaWxzb24gPGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KLS0tCiBkcml2ZXJzL2dwdS9kcm0v
aTkxNS9pOTE1X2dlbV9ndHQuYyB8IDkzICsrKysrKysrKystLS0tLS0tLS0tLS0tLS0tLS0tCiBk
cml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuaCB8ICAyICstCiAyIGZpbGVzIGNoYW5n
ZWQsIDMzIGluc2VydGlvbnMoKyksIDYyIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtX2d0dC5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkx
NV9nZW1fZ3R0LmMKaW5kZXggYTk5Yjg5NTAyYTkwLi4wNjI1YjA3YTExMzIgMTAwNjQ0Ci0tLSBh
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZ2VtX2d0dC5jCisrKyBiL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2k5MTVfZ2VtX2d0dC5jCkBAIC03MTMsMTEgKzcxMywxMSBAQCBzdGF0aWMgc3RydWN0
IGk5MTVfcGFnZV90YWJsZSAqYWxsb2NfcHQoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0p
CiAJcmV0dXJuIHB0OwogfQogCi1zdGF0aWMgc3RydWN0IGk5MTVfcGFnZV9kaXJlY3RvcnkgKl9f
YWxsb2NfcGQodm9pZCkKK3N0YXRpYyBzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeSAqX19hbGxv
Y19wZChzaXplX3Qgc3opCiB7CiAJc3RydWN0IGk5MTVfcGFnZV9kaXJlY3RvcnkgKnBkOwogCi0J
cGQgPSBremFsbG9jKHNpemVvZigqcGQpLCBJOTE1X0dGUF9BTExPV19GQUlMKTsKKwlwZCA9IGt6
YWxsb2Moc3osIEk5MTVfR0ZQX0FMTE9XX0ZBSUwpOwogCWlmICh1bmxpa2VseSghcGQpKQogCQly
ZXR1cm4gTlVMTDsKIApAQCAtNzI5LDcgKzcyOSw3IEBAIHN0YXRpYyBzdHJ1Y3QgaTkxNV9wYWdl
X2RpcmVjdG9yeSAqYWxsb2NfcGQoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0pCiB7CiAJ
c3RydWN0IGk5MTVfcGFnZV9kaXJlY3RvcnkgKnBkOwogCi0JcGQgPSBfX2FsbG9jX3BkKCk7CisJ
cGQgPSBfX2FsbG9jX3BkKHNpemVvZigqcGQpKTsKIAlpZiAodW5saWtlbHkoIXBkKSkKIAkJcmV0
dXJuIEVSUl9QVFIoLUVOT01FTSk7CiAKQEAgLTc2Niw3ICs3NjYsNyBAQCBfX3NldF9wZF9lbnRy
eShzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeSAqIGNvbnN0IHBkLAogCSAgICAgICBzdHJ1Y3Qg
aTkxNV9wYWdlX2RtYSAqIGNvbnN0IHRvLAogCSAgICAgICB1NjQgKCplbmNvZGUpKGNvbnN0IGRt
YV9hZGRyX3QsIGNvbnN0IGVudW0gaTkxNV9jYWNoZV9sZXZlbCkpCiB7Ci0JR0VNX0JVR19PTihh
dG9taWNfcmVhZChweF91c2VkKHBkKSkgPiA1MTIpOworCUdFTV9CVUdfT04oYXRvbWljX3JlYWQo
cHhfdXNlZChwZCkpID4gQVJSQVlfU0laRShwZC0+ZW50cnkpKTsKIAogCWF0b21pY19pbmMocHhf
dXNlZChwZCkpOwogCXBkLT5lbnRyeVtpZHhdID0gdG87CkBAIC04OTMsNjQgKzg5MywzNCBAQCBz
dGF0aWMgaW5saW5lIHVuc2lnbmVkIGludCBnZW44X3B0X2NvdW50KHU2NCBhZGRyLCB1NjQgZW5k
KQogCQlyZXR1cm4gZW5kIC0gYWRkcjsKIH0KIAotc3RhdGljIHZvaWQgZ2VuOF9mcmVlX3BhZ2Vf
dGFibGVzKHN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtLAotCQkJCSAgc3RydWN0IGk5MTVf
cGFnZV9kaXJlY3RvcnkgKnBkKQorc3RhdGljIHZvaWQgX19nZW44X3BwZ3R0X2NsZWFudXAoc3Ry
dWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCisJCQkJIHN0cnVjdCBpOTE1X3BhZ2VfZGlyZWN0
b3J5ICpwZCwKKwkJCQkgaW50IGNvdW50LCBpbnQgbHZsKQogewotCWludCBpOwotCi0JZm9yIChp
ID0gMDsgaSA8IEk5MTVfUERFUzsgaSsrKSB7Ci0JCWlmIChwZC0+ZW50cnlbaV0pCi0JCQlmcmVl
X3BkKHZtLCBwZC0+ZW50cnlbaV0pOwotCX0KLX0KLQotc3RhdGljIHZvaWQgZ2VuOF9wcGd0dF9j
bGVhbnVwXzNsdmwoc3RydWN0IGk5MTVfYWRkcmVzc19zcGFjZSAqdm0sCi0JCQkJICAgIHN0cnVj
dCBpOTE1X3BhZ2VfZGlyZWN0b3J5ICpwZHApCi17Ci0JY29uc3QgdW5zaWduZWQgaW50IHBkcGVz
ID0gaTkxNV9wZHBlc19wZXJfcGRwKHZtKTsKLQlpbnQgaTsKLQotCWZvciAoaSA9IDA7IGkgPCBw
ZHBlczsgaSsrKSB7Ci0JCWlmICghcGRwLT5lbnRyeVtpXSkKLQkJCWNvbnRpbnVlOwotCi0JCWdl
bjhfZnJlZV9wYWdlX3RhYmxlcyh2bSwgcGRwLT5lbnRyeVtpXSk7Ci0JCWZyZWVfcGQodm0sIHBk
cC0+ZW50cnlbaV0pOwotCX0KLQotCWZyZWVfcHgodm0sIHBkcCk7Ci19Ci0KLXN0YXRpYyB2b2lk
IGdlbjhfcHBndHRfY2xlYW51cF80bHZsKHN0cnVjdCBpOTE1X3BwZ3R0ICpwcGd0dCkKLXsKLQlz
dHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeSAqIGNvbnN0IHBtbDQgPSBwcGd0dC0+cGQ7Ci0JaW50
IGk7Ci0KLQlmb3IgKGkgPSAwOyBpIDwgR0VOOF9QTUw0RVNfUEVSX1BNTDQ7IGkrKykgewotCQlz
dHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeSAqcGRwID0gaTkxNV9wZHBfZW50cnkocG1sNCwgaSk7
CisJaWYgKGx2bCkgeworCQl2b2lkICoqcGRlID0gcGQtPmVudHJ5OwogCi0JCWlmICghcGRwKQot
CQkJY29udGludWU7CisJCWRvIHsKKwkJCWlmICghKnBkZSkKKwkJCQljb250aW51ZTsKIAotCQln
ZW44X3BwZ3R0X2NsZWFudXBfM2x2bCgmcHBndHQtPnZtLCBwZHApOworCQkJX19nZW44X3BwZ3R0
X2NsZWFudXAodm0sICpwZGUsIEk5MTVfUERFUywgbHZsIC0gMSk7CisJCX0gd2hpbGUgKHBkZSsr
LCAtLWNvdW50KTsKIAl9CiAKLQlmcmVlX3B4KCZwcGd0dC0+dm0sIHBtbDQpOworCWZyZWVfcHgo
dm0sIHBkKTsKIH0KIAogc3RhdGljIHZvaWQgZ2VuOF9wcGd0dF9jbGVhbnVwKHN0cnVjdCBpOTE1
X2FkZHJlc3Nfc3BhY2UgKnZtKQogewotCXN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1ID0g
dm0tPmk5MTU7CiAJc3RydWN0IGk5MTVfcHBndHQgKnBwZ3R0ID0gaTkxNV92bV90b19wcGd0dCh2
bSk7CiAKLQlpZiAoaW50ZWxfdmdwdV9hY3RpdmUoaTkxNSkpCisJaWYgKGludGVsX3ZncHVfYWN0
aXZlKHZtLT5pOTE1KSkKIAkJZ2VuOF9wcGd0dF9ub3RpZnlfdmd0KHBwZ3R0LCBmYWxzZSk7CiAK
LQlpZiAoaTkxNV92bV9pc180bHZsKHZtKSkKLQkJZ2VuOF9wcGd0dF9jbGVhbnVwXzRsdmwocHBn
dHQpOwotCWVsc2UKLQkJZ2VuOF9wcGd0dF9jbGVhbnVwXzNsdmwoJnBwZ3R0LT52bSwgcHBndHQt
PnBkKTsKLQorCV9fZ2VuOF9wcGd0dF9jbGVhbnVwKHZtLCBwcGd0dC0+cGQsCisJCQkgICAgIHZt
LT50b3RhbCA+PiBfX2dlbjhfcHRlX3NoaWZ0KHZtLT50b3ApLAorCQkJICAgICB2bS0+dG9wKTsK
IAlmcmVlX3NjcmF0Y2godm0pOwogfQogCkBAIC0xNTAyLDI0ICsxNDcyLDE4IEBAIHN0YXRpYyBp
bnQgZ2VuOF9wcmVhbGxvY2F0ZV90b3BfbGV2ZWxfcGRwKHN0cnVjdCBpOTE1X3BwZ3R0ICpwcGd0
dCkKIAlzdHJ1Y3QgaTkxNV9wYWdlX2RpcmVjdG9yeSAqcGRwID0gcHBndHQtPnBkOwogCXN0cnVj
dCBpOTE1X3BhZ2VfZGlyZWN0b3J5ICpwZDsKIAl1NjQgc3RhcnQgPSAwLCBsZW5ndGggPSBwcGd0
dC0+dm0udG90YWw7Ci0JdTY0IGZyb20gPSBzdGFydDsKIAl1bnNpZ25lZCBpbnQgcGRwZTsKIAog
CWdlbjhfZm9yX2VhY2hfcGRwZShwZCwgcGRwLCBzdGFydCwgbGVuZ3RoLCBwZHBlKSB7CiAJCXBk
ID0gYWxsb2NfcGQodm0pOwogCQlpZiAoSVNfRVJSKHBkKSkKLQkJCWdvdG8gdW53aW5kOworCQkJ
cmV0dXJuIFBUUl9FUlIocGQpOwogCiAJCWZpbGxfcHgocGQsIHZtLT5zY3JhdGNoWzFdLmVuY29k
ZSk7CiAJCXNldF9wZF9lbnRyeShwZHAsIHBkcGUsIHBkKTsKIAl9CiAKIAlyZXR1cm4gMDsKLQot
dW53aW5kOgotCWdlbjhfcHBndHRfY2xlYXJfcGRwKHZtLCBwZHAsIGZyb20sIHN0YXJ0IC0gZnJv
bSk7Ci0JYXRvbWljX3NldChweF91c2VkKHBkcCksIDApOwotCXJldHVybiAtRU5PTUVNOwogfQog
CiBzdGF0aWMgdm9pZCBwcGd0dF9pbml0KHN0cnVjdCBpOTE1X3BwZ3R0ICpwcGd0dCwgc3RydWN0
IGludGVsX2d0ICpndCkKQEAgLTE1NDksOSArMTUxMywxNCBAQCBnZW44X2FsbG9jX3RvcF9wZChz
dHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSkKIAogCUdFTV9CVUdfT04oY291bnQgPiBBUlJB
WV9TSVpFKHBkLT5lbnRyeSkpOwogCi0JcGQgPSBhbGxvY19wZCh2bSk7Ci0JaWYgKElTX0VSUihw
ZCkpCi0JCXJldHVybiBwZDsKKwlwZCA9IF9fYWxsb2NfcGQob2Zmc2V0b2YodHlwZW9mKCpwZCks
IGVudHJ5W2NvdW50XSkpOworCWlmICh1bmxpa2VseSghcGQpKQorCQlyZXR1cm4gRVJSX1BUUigt
RU5PTUVNKTsKKworCWlmICh1bmxpa2VseShzZXR1cF9wYWdlX2RtYSh2bSwgcHhfYmFzZShwZCkp
KSkgeworCQlrZnJlZShwZCk7CisJCXJldHVybiBFUlJfUFRSKC1FTk9NRU0pOworCX0KIAogCWZp
bGxfcGFnZV9kbWEocHhfYmFzZShwZCksIHZtLT5zY3JhdGNoW3ZtLT50b3BdLmVuY29kZSwgY291
bnQpOwogCXJldHVybiBwZDsKQEAgLTE2MjMsNyArMTU5Miw5IEBAIHN0YXRpYyBzdHJ1Y3QgaTkx
NV9wcGd0dCAqZ2VuOF9wcGd0dF9jcmVhdGUoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUp
CiAJcmV0dXJuIHBwZ3R0OwogCiBlcnJfZnJlZV9wZDoKLQlmcmVlX3B4KCZwcGd0dC0+dm0sIHBw
Z3R0LT5wZCk7CisJX19nZW44X3BwZ3R0X2NsZWFudXAoJnBwZ3R0LT52bSwgcHBndHQtPnBkLAor
CQkJICAgICBwcGd0dC0+dm0udG90YWwgPj4gX19nZW44X3B0ZV9zaGlmdChwcGd0dC0+dm0udG9w
KSwKKwkJCSAgICAgcHBndHQtPnZtLnRvcCk7CiBlcnJfZnJlZV9zY3JhdGNoOgogCWZyZWVfc2Ny
YXRjaCgmcHBndHQtPnZtKTsKIGVycl9mcmVlOgpAQCAtMjA2OSw3ICsyMDQwLDcgQEAgc3RhdGlj
IHN0cnVjdCBpOTE1X3BwZ3R0ICpnZW42X3BwZ3R0X2NyZWF0ZShzdHJ1Y3QgZHJtX2k5MTVfcHJp
dmF0ZSAqaTkxNSkKIAogCXBwZ3R0LT5iYXNlLnZtLnB0ZV9lbmNvZGUgPSBnZ3R0LT52bS5wdGVf
ZW5jb2RlOwogCi0JcHBndHQtPmJhc2UucGQgPSBfX2FsbG9jX3BkKCk7CisJcHBndHQtPmJhc2Uu
cGQgPSBfX2FsbG9jX3BkKHNpemVvZigqcHBndHQtPmJhc2UucGQpKTsKIAlpZiAoIXBwZ3R0LT5i
YXNlLnBkKSB7CiAJCWVyciA9IC1FTk9NRU07CiAJCWdvdG8gZXJyX2ZyZWU7CmRpZmYgLS1naXQg
YS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuaCBiL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2k5MTVfZ2VtX2d0dC5oCmluZGV4IDIzNDE5NDRiOWIxNy4uZDAxMjhmNTIxODRiIDEwMDY0
NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuaAorKysgYi9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9pOTE1X2dlbV9ndHQuaApAQCAtMjUzLDcgKzI1Myw3IEBAIHN0cnVjdCBp
OTE1X3BhZ2VfdGFibGUgewogc3RydWN0IGk5MTVfcGFnZV9kaXJlY3RvcnkgewogCXN0cnVjdCBp
OTE1X3BhZ2VfdGFibGUgcHQ7CiAJc3BpbmxvY2tfdCBsb2NrOwotCXZvaWQgKmVudHJ5WzUxMl07
CisJdm9pZCAqZW50cnlbSTkxNV9QREVTXTsKIH07CiAKICNkZWZpbmUgX19weF9jaG9vc2VfZXhw
cih4LCB0eXBlLCBleHByLCBvdGhlcikgXAotLSAKMi4yMC4xCgpfX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fXwpJbnRlbC1nZnggbWFpbGluZyBsaXN0CkludGVs
LWdmeEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcv
bWFpbG1hbi9saXN0aW5mby9pbnRlbC1nZng=
